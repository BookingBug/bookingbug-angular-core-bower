"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function __range__(left,right,inclusive){for(var range=[],ascending=left<right,end=inclusive?ascending?right+1:right-1:right,i=left;ascending?i<end:i>end;ascending?i++:i--)range.push(i);return range}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function __initClass__(c){return c.initClass(),c}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function __range__(left,right,inclusive){for(var range=[],ascending=left<right,end=inclusive?ascending?right+1:right-1:right,i=left;ascending?i<end:i>end;ascending?i++:i--)range.push(i);return range}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}
function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function bbLoggedUser($compile,LoginService){return{transclude:!0,scope:{},terminal:!0,restrict:"A",priority:1e4,compile:function(element,attrs){return element.removeAttr("add-condition"),element.removeAttr("data-add-condition"),element.removeAttr("bb-logged-user"),{post:function(scope,iElement,iAttrs,controller,transcluded){transcluded(scope,function(clone){iElement[0].setAttribute("ng-if","$root.member"),LoginService.checkLogin(),iElement[0].innerHTML=clone.map(function(index,c){return c.outerHTML||null}).get().join(""),$compile(iElement)(scope)})}}}}}function bbLanguagePickerLink(scope,element,attrs){scope.vm.availableLanguages.length<=1&&angular.element(element).addClass("hidden")}function bbLanguagePickerController($rootScope,$scope,bbLocale,tmhDynamicLocale,bbi18nOptions){"ngInject";function setAvailableLanguages(){var _this2=this;languages.forEach(function(languageKey){_this2.availableLanguages.push(createLanguage(languageKey))})}function setCurrentLanguage(){var _this3=this;tmhDynamicLocale.set(bbLocale.getLocale()).then(function(){_this3.language={selected:createLanguage(bbLocale.getLocale())}})}function createLanguage(languageKey){return{identifier:languageKey,label:"COMMON.LANGUAGE."+languageKey.toUpperCase()}}function setLanguage(lang){this.language.selected=lang,this.pickLanguage(lang.identifier)}function pickLanguage(languageKey){tmhDynamicLocale.set(languageKey).then(function(){bbLocale.setLocale(languageKey,"bbLanguagePicker.pickLanguage"),$rootScope.$broadcast("BBLanguagePicker:languageChanged")})}var _this=this,languages=bbi18nOptions.available_languages;this.language=null,this.availableLanguages=[],this.enableSearch=!0,this.setAvailableLanguages=setAvailableLanguages,this.setCurrentLanguage=setCurrentLanguage,this.setLanguage=setLanguage,function(){_this.setAvailableLanguages(),_this.setCurrentLanguage(),$scope.$on("BBLanguagePicker:refresh",setCurrentLanguage),_this.pickLanguage=pickLanguage}()}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function bbTimeRangeStackedController($scope,$element,$attrs,$rootScope,$q,TimeService,AlertService,BBModel,FormDataStoreService,PersonService,PurchaseService,DateTimeUtilitiesService,LoadingService,TimeSlotPermutationService){var loader=void 0;this.$onInit=function(){FormDataStoreService.init("TimeRangeListStacked",$scope,["selected_slot","original_start_date","start_at_week_start"]),loader=LoadingService.$loader($scope).notLoaded(),$rootScope.connection_started.then(function(){initScopeVariables(),initTimeRange(),$scope.loadData()})};var initScopeVariables=function(){$scope.available_times=0;var selected_day=void 0;$scope.options=$scope.$eval($attrs.bbTimeRangeStacked)||{},$scope.options.ignore_min_advance_datetime=!!$scope.options.ignore_min_advance_datetime,$scope.time_range_length||(null!=$attrs.bbTimeRangeLength?$scope.time_range_length=$scope.$eval($attrs.bbTimeRangeLength):$scope.options&&$scope.options.time_range_length?$scope.time_range_length=$scope.options.time_range_length:$scope.time_range_length=7),(null!=$attrs.bbDayOfWeek||$scope.options&&$scope.options.day_of_week)&&($scope.day_of_week=null!=$attrs.bbDayOfWeek?$scope.$eval($attrs.bbDayOfWeek):$scope.options.day_of_week),(null!=$attrs.bbSelectedDay||$scope.options&&$scope.options.selected_day)&&(selected_day=null!=$attrs.bbSelectedDay?moment($scope.$eval($attrs.bbSelectedDay)):moment($scope.options.selected_day),moment.isMoment(selected_day)&&($scope.selected_day=selected_day))},initTimeRange=function(){if(!$scope.start_date&&$scope.last_selected_date)if($scope.original_start_date){var diff=$scope.last_selected_date.diff($scope.original_start_date,"days");diff%=$scope.time_range_length,diff=0===diff?diff:diff+1;var start_date=$scope.last_selected_date.clone().subtract(diff,"days");setTimeRange($scope.last_selected_date,start_date)}else setTimeRange($scope.last_selected_date);else $scope.bb.stacked_items[0].date?setTimeRange($scope.bb.stacked_items[0].date.date):$scope.selected_day?($scope.original_start_date=$scope.original_start_date||moment($scope.selected_day),setTimeRange($scope.selected_day)):($scope.start_at_week_start=!0,setTimeRange(moment()))},setTimeRange=function(selected_date,start_date){start_date?$scope.start_date=start_date:$scope.day_of_week?$scope.start_date=selected_date.clone().day($scope.day_of_week):$scope.start_at_week_start?$scope.start_date=selected_date.clone().startOf("week"):$scope.start_date=selected_date.clone(),$scope.selected_day=selected_date,$scope.selected_date=$scope.selected_day.toDate(),isSubtractValid(),isAddValid()};$scope.add=function(amount,type){switch($scope.selected_day=moment($scope.selected_date),type){case"days":setTimeRange($scope.selected_day.add(amount,"days"));break;case"weeks":$scope.start_date.add(amount,"weeks"),setTimeRange($scope.start_date)}return $scope.loadData()},$scope.subtract=function(amount,type){return $scope.add(-amount,type)};var isSubtractValid=function(){$scope.is_subtract_valid=!0;var diff=Math.ceil($scope.selected_day.diff(moment(),"day",!0));return $scope.subtract_length=diff<$scope.time_range_length?diff:$scope.time_range_length,diff<=0&&($scope.is_subtract_valid=!1),$scope.subtract_length>1?$scope.subtract_string="Prev "+$scope.subtract_length+" days":1===$scope.subtract_length?$scope.subtract_string="Prev day":$scope.subtract_string="Prev"},isAddValid=function(){if($scope.is_add_valid=!0,!$scope.isAdmin()&&!$scope.options.ignore_max_advance_datetime&&$scope.max_date){var max_date=$scope.max_date.clone(),selected_day=$scope.selected_day.clone();if(max_date.startOf("day").diff(selected_day.startOf("day"),"days",!0)-$scope.time_range_length<0)return $scope.is_add_valid=!1}};$scope.selectedDateChanged=function(){return setTimeRange(moment($scope.selected_date)),$scope.selected_slot=null,$scope.loadData()};var updateHideStatus=function(){return function(){var result=[];for(var key in $scope.days){var day=$scope.days[key];result.push($scope.days[key].hide=!day.date.isSame($scope.selected_day,"day"))}return result}()};$scope.isPast=function(){return!$scope.start_date||moment().isAfter($scope.start_date)},$scope.status=function(day,slot){if(slot){return slot.status()}},$scope.highlightSlot=function(slot,day){if(day&&slot&&slot.availability()>0){for($scope.bb.clearStackedItemsDateTime(),$scope.selected_slot&&($scope.selected_slot.selected=!1),$scope.setLastSelectedDate(day.date),$scope.selected_slot=angular.copy(slot),$scope.selected_day=day.date,$scope.selected_date=day.date.toDate(),$scope.$broadcast("slotChanged",day,slot);slot;)for(var itemIndex in $scope.bb.stacked_items){var item=$scope.bb.stacked_items[itemIndex];if(item.service.self===slot.service.self&&!item.date&&!item.time){item.setDate(day),item.setTime(slot),slot=slot.next;break}}return updateHideStatus(),$rootScope.$broadcast("time:selected")}},$scope.loadData=function(){loader.notLoaded(),$scope.start_date=moment($scope.start_date);var edate=moment($scope.start_date).add($scope.time_range_length,"days");$scope.end_date=moment(edate).add(-1,"days");var selectedItems=$scope.bb.stacked_items;selectedItems&&selectedItems.length||(selectedItems=[$scope.bb.current_item]);var people_promise=$scope.bb.company.$getPeople(),time_data_promise=TimeService.queryItems({company:$scope.bb.company,items:selectedItems,client:$scope.client,start_date:$scope.start_date,end_date:$scope.end_date});return $q.all([people_promise,time_data_promise]).then(function(res){var people=res[0],timeData=res[1];$scope.days=TimeSlotPermutationService.findValidSlots(selectedItems,timeData,0),$scope.$broadcast("bbTimeRangeStacked-loadData:finished",$scope.days,people),$scope.setLoaded($scope)},function(err){$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},$scope.pretty_month_title=function(month_format,year_format,seperator){var start_date=void 0;if(null==seperator&&(seperator="-"),$scope.start_date){var month_year_format=month_format+" "+year_format;return $scope.start_date&&$scope.end_date&&$scope.end_date.isAfter($scope.start_date,"month")?(start_date=$scope.start_date.format(month_format),11===$scope.start_date.month()&&(start_date=$scope.start_date.format(month_year_format)),start_date+" "+seperator+" "+$scope.end_date.format(month_year_format)):$scope.start_date.format(month_year_format)}},$scope.confirm=function(route,options){var booking=void 0;null==options&&(options={});var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.bb.stacked_items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;if(!item.time)return AlertService.add("danger",{msg:"Select a time to continue your booking"}),!1}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}if(null!=$scope.bb.moving_booking&&null!=$scope.bb.moving_booking.bookings){var different=!1,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.bb.moving_booking.bookings)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){booking=_step2.value;var found=!1,_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.bb.stacked_items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0)item=_step3.value,booking.getDateString()===item.date.string_date&&booking.getTimeInMins()===item.time.time&&booking.category_name===item.category_name&&(found=!0)}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}if(!found){different=!0;break}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}if(!different)return AlertService.add("danger",{msg:"Your treatments are already booked for this time."}),!1}if($scope.bb.basket.clear(),$scope.bb.pushStackToBasket(),$scope.bb.moving_booking){loader.notLoaded();return void PurchaseService.update({purchase:$scope.bb.moving_booking,bookings:$scope.bb.basket.items}).then(function(purchase){return purchase.$getBookings().then(function(bookings){return function(){var result=[],_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){booking=_step4.value;var item1=void 0;$scope.bookings&&(item1=function(){for(var result1=[],_i=0;_i<$scope.bookings.length;_i++){var oldb=$scope.bookings[_i],item2=void 0;oldb.id===booking.id&&(item2=$scope.bookings[_i]=booking),result1.push(item2)}return result1}()),result.push(item1)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return result}()}),loader.setLoaded(),$scope.bb.current_item.move_done=!0,$scope.decideNextPage()},function(err){return loader.setLoaded(),AlertService.add("danger",{msg:"Failed to move booking"})})}return loader.notLoaded(),options.do_not_route?$scope.updateBasket():$scope.updateBasket().then(function(){return loader.setLoaded(),$scope.decideNextPage(route)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.setReady=function(){return $scope.confirm("",{do_not_route:!0})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function TimeListCtrl($attrs,$scope,$rootScope,TimeService,AlertService,BBModel,DateTimeUtilitiesService,LoadingService,ErrorService,$translate,bbWidgetPage){"ngInject";var loader=LoadingService.$loader($scope).notLoaded();$scope.data_source||($scope.data_source=$scope.bb.current_item),$scope.options=$scope.$eval($attrs.bbTimes)||{};var currentSlot=null;$rootScope.connection_started.then(function(){return $scope.bb.current_item.defaults.date&&!$scope.bb.current_item.date?$scope.setDate($scope.bb.current_item.defaults.date):$scope.bb.current_item.date?$scope.setDate($scope.bb.current_item.date.date):$scope.setDate(moment()),$scope.loadDay()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.setDate=function(date){var day=new BBModel.Day({date:date,spaces:1});return $scope.selected_day=day,$scope.selected_date=day.date},$scope.setDataSource=function(source){return $scope.data_source=source},$scope.setItemLinkSource=function(source){return $scope.item_link_source=source},$scope.$on("dateChanged",function(event,newdate){return $scope.setDate(newdate),$scope.loadDay()}),$scope.$on("currentItemUpdate",function(event){return $scope.loadDay({check_requested_slot:!1})}),$scope.selectSlot=function(slot,day,route){if(slot&&slot.availability()>0){if(currentSlot=slot,$scope.item_link_source&&$scope.data_source.setItem($scope.item_link_source),slot.datetime?($scope.setLastSelectedDate(slot.datetime),$scope.data_source.setDate({date:slot.datetime})):day&&($scope.setLastSelectedDate(day.date),$scope.data_source.setDate(day)),$scope.data_source.setTime(slot),$scope.data_source.reserve_ready)return $scope.addItemToBasket().then(function(){if(bbWidgetPage.canAutoDecideNextPage("bb-times"))return $scope.decideNextPage(route)});if(bbWidgetPage.canAutoDecideNextPage("bb-times"))return $scope.decideNextPage(route)}},$scope.highlightSlot=function(slot,day){if(day&&slot&&slot.availability()>0)return slot.datetime?($scope.setLastSelectedDate(slot.datetime),$scope.data_source.setDate({date:slot.datetime})):day&&($scope.setLastSelectedDate(day.date),$scope.data_source.setDate(day)),$scope.data_source.setTime(slot),$scope.$broadcast("slotChanged",slot)},$scope.status=function(slot){if(slot){return slot.status()}},$scope.add=function(type,amount){delete $scope.bb.current_item.time;var new_date=moment($scope.selected_day.date).add(amount,type);return $scope.setDate(new_date),$scope.loadDay()},$scope.subtract=function(type,amount){return $scope.add(type,-amount)},$scope.loadDay=function(options){if(options||(options={check_requested_slot:!0}),$scope.data_source&&($scope.data_source.days_link||$scope.item_link_source)&&$scope.selected_day){$scope.notLoaded($scope);var pslots=TimeService.query({company:$scope.bb.company,cItem:$scope.data_source,item_link:$scope.item_link_source,date:$scope.selected_day.date,client:$scope.client,available:1});return pslots.finally(function(){return loader.setLoaded()}),pslots.then(function(time_slots){if($scope.slots=time_slots,$scope.$broadcast("slotsUpdated",$scope.data_source,time_slots),$scope.add_padding&&time_slots.length>0){var dtimes={},_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(time_slots)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){dtimes[_step.value.time]=1}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}for(var v=0;v<$scope.add_padding.length;v++){var pad=$scope.add_padding[v];dtimes[pad]||time_slots.splice(v,0,new BBModel.TimeSlot({time:pad,avail:0},time_slots[0].service))}}if(!0===options.check_requested_slot)return checkRequestedSlots(time_slots)},function(err){return 404===err.status&&err.data&&err.data.error&&"No bookable events found"===err.data.error?$scope.data_source&&$scope.data_source.person?(AlertService.warning(ErrorService.getError("NOT_BOOKABLE_PERSON")),$scope.setLoaded($scope)):$scope.data_source&&$scope.data_source.resource?(AlertService.warning(ErrorService.getError("NOT_BOOKABLE_RESOURCE")),$scope.setLoaded($scope)):$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong"):$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}return loader.setLoaded()};var checkRequestedSlots=function(time_slots){if($scope.bb.item_defaults&&$scope.bb.item_defaults.time){var requested_slot=DateTimeUtilitiesService.checkDefaultTime($scope.selected_date,time_slots,$scope.data_source,$scope.bb.item_defaults);return null===requested_slot.slot||null===requested_slot.match?$scope.availability_conflict=!0:requested_slot.slot&&"full"===requested_slot.match?($scope.skipThisStep(),$scope.selectSlot(requested_slot.slot,$scope.selected_day)):requested_slot.slot&&"partial"===requested_slot.match?$scope.highlightSlot(requested_slot.slot,$scope.selected_day):void 0}};return $scope.isCurrentTimeSlot=function(slot){return currentSlot&&slot.time==currentSlot.time},$scope.padTimes=function(times){return $scope.add_padding=times},$scope.setReady=function(){return $scope.data_source.time?!$scope.data_source.reserve_ready||$scope.addItemToBasket():(AlertService.clear(),AlertService.add("danger",{msg:$translate.instant("PUBLIC_BOOKING.TIME.TIME_NOT_SELECTED_ALERT")}),!1)}}angular.module("BB",["ngStorage","ngMessages","ngSanitize","ngFileUpload","ngCookies","ngAnimate","angularMoment","angular-carousel","angular-hal","angular-data.DSCacheFactory","angular.filter","pascalprecht.translate","schemaForm","ui.bootstrap","ui.map","ui.router.util","ui.select","ui-rangeSlider","uiGmapgoogle-maps","vcRecaptcha","BB.Controllers","BB.Filters","BB.Models","BB.Services","BB.Directives","BB.analytics","BB.i18n","BB.uib","BB.uiSelect"]),angular.module("BB.Services",["ngResource","ngSanitize","pascalprecht.translate"]),angular.module("BB.Controllers",["ngSanitize"]),angular.module("BB.Directives",[]),angular.module("BB.Filters",[]),angular.module("BB.Models",[]),angular.module("BB.analytics",["angulartics","angulartics.piwik"]),angular.module("BB.i18n",["tmh.dynamicLocale"]),angular.module("BB.uiSelect",[]),angular.module("BB.uib",["ui.bootstrap"]),angular.module("BB").value("AppConfig",{appId:"f6b16c23",appKey:"f0bc4f65f4fbfe7b4b3b7264b655f5eb"}),angular.module("BB").value("AirbrakeConfig",{projectId:"122836",projectKey:"e6d6710b2cf00be965e8452d6a384d37",environment:"localhost"===window.location.hostname?"development":"production"}),window.use_no_conflict?(window.bbjq=$.noConflict(),angular.module("BB").value("$bbug",jQuery.noConflict(!0))):angular.module("BB").value("$bbug",jQuery),angular.module("BB").constant("UriTemplate",window.UriTemplate),angular.module("BB").config(function($locationProvider,$httpProvider,$provide,uiGmapGoogleMapApiProvider,$analyticsProvider){"ngInject";uiGmapGoogleMapApiProvider.configure({v:"3.20",libraries:"weather,geometry,visualization"}),$httpProvider.defaults.headers.common={"App-Id":"f6b16c23","App-Key":"f0bc4f65f4fbfe7b4b3b7264b655f5eb"}}),window.bookingbug={logout:function(options){options||(options={}),!1!==options.reload&&(options.reload=!0);var logout_opts={app_id:"f6b16c23",app_key:"f0bc4f65f4fbfe7b4b3b7264b655f5eb"};if(options.root&&(logout_opts.root=options.root),angular.injector(["BB.Services","BB.Models","ng"]).get("LoginService").logout(logout_opts),options.reload)return window.location.reload()}},window.getURIparam=function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+name+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(window.location.href);return null==results?"":results[1]},angular.module("BB").run(function($bbug,FormDataStoreService,$log,$rootScope,$sessionStorage){"ngInject";$rootScope.$setIfUndefined=FormDataStoreService.setIfUndefined,$rootScope.bb||($rootScope.bb={}),$rootScope.bb.api_url=$sessionStorage.getItem("host"),!1===$bbug.support.opacity&&(document.createElement("header"),document.createElement("nav"),document.createElement("section"),document.createElement("footer"))}),angular.module("schemaForm").config(function(schemaFormProvider,schemaFormDecoratorsProvider,sfPathProvider){var timepicker=function(name,schema,options){if("string"===schema.type&&"time"===schema.format){var f=schemaFormProvider.stdFormObj(name,schema,options);return f.key=options.path,f.type="timepicker",options.lookup[sfPathProvider.stringify(options.path)]=f,f}};schemaFormProvider.defaults.string.unshift(timepicker);var datetimepicker=function(name,schema,options){if("string"===schema.type&&"datetime"===schema.format){var f=schemaFormProvider.stdFormObj(name,schema,options);return f.key=options.path,f.type="datetime",options.lookup[sfPathProvider.stringify(options.path)]=f,f}};schemaFormProvider.defaults.string.unshift(datetimepicker);var phonenumber=function(name,schema,options){if("string"===schema.type&&"tel"===schema.format){var f=schemaFormProvider.stdFormObj(name,schema,options);return f.key=options.path,f.type="phonenumber",options.lookup[sfPathProvider.stringify(options.path)]=f,f}};return schemaFormProvider.defaults.string.unshift(phonenumber),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","time","bootstrap_ui_time_form.html"),schemaFormDecoratorsProvider.createDirective("time","bootstrap_ui_time_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","datetime","bootstrap_ui_datetime_form.html"),schemaFormDecoratorsProvider.createDirective("datetime","bootstrap_ui_datetime_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","phonenumber","bootstrap_ui_phonenumber_form.html"),schemaFormDecoratorsProvider.createDirective("phonenumber","bootstrap_ui_phonenumber.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","price","price_form.html"),schemaFormDecoratorsProvider.createDirective("price","price_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","date","date_form.html"),schemaFormDecoratorsProvider.createDirective("date","date_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","radios","radios.html"),schemaFormDecoratorsProvider.createDirective("radios","radios.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","radios-inline","radios-inline.html"),schemaFormDecoratorsProvider.createDirective("radios-inline","radios-inline.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","radiobuttons","radio-buttons.html"),schemaFormDecoratorsProvider.createDirective("radiobuttons","radio-buttons.html")}),window.Collection=function Collection(){_classCallCheck(this,Collection)},window.Collection.Base=function(){function Base(res,items,params){_classCallCheck(this,Base),this.res=res,this.items=items,this.params=params,this.callbacks=[];var clean_params={};for(var key in params){var val=params[key];null!=val&&(null!=val.id?clean_params[key+"_id"]=val.id:clean_params[key]=val)}if(this.jparams=JSON.stringify(clean_params),res)for(var n in res){var m=res[n];this[n]=m}}return Base.prototype.checkItem=function(item){var _this=this,call=void 0;if(!this.matchesParams(item))return this.deleteItem(item),!0;for(var index=0;index<this.items.length;index++){var existingItem=this.items[index];if(item.self===existingItem.self){this.items[index]=item;var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(this.callbacks)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)call=_step.value,call[1](item,"update")}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return!0}}return this.items.push(item),function(){var result=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{
for(var _step2,_iterator2=Array.from(_this.callbacks)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)call=_step2.value,result.push(call[1](item,"add"))}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result}()},Base.prototype.deleteItem=function(item){var len=this.items.length;if(this.items=this.items.filter(function(x){return x.self!==item.self}),this.items.length!==len)return Array.from(this.callbacks).map(function(call){return call[1](item,"delete")})},Base.prototype.getItems=function(){return this.items},Base.prototype.addCallback=function(obj,fn){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(this.callbacks)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){if(_step3.value[0]===obj)return}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return this.callbacks.push([obj,fn])},Base.prototype.matchesParams=function(item){return!0},Base}(),window.BaseCollections=function(){function BaseCollections(){_classCallCheck(this,BaseCollections),this.collections=[]}return BaseCollections.prototype.count=function(){return this.collections.length},BaseCollections.prototype.add=function(col){return this.collections.push(col)},BaseCollections.prototype.checkItems=function(item){return Array.from(this.collections).map(function(col){return col.checkItem(item)})},BaseCollections.prototype.deleteItems=function(item){return Array.from(this.collections).map(function(col){return col.deleteItem(item)})},BaseCollections.prototype.find=function(prms){var clean_params={};for(var key in prms){var val=prms[key];null!=val&&(null!=val.id?clean_params[key+"_id"]=val.id:clean_params[key]=val)}var jprms=JSON.stringify(clean_params),_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(this.collections)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var col=_step4.value;if(jprms===col.jparams)return col}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}},BaseCollections.prototype.delete=function(col){return this.collections=_.without(this.collections,col)},BaseCollections}(),window.Collection.Day=function(_window$Collection$Ba){function Day(){return _classCallCheck(this,Day),_possibleConstructorReturn(this,_window$Collection$Ba.apply(this,arguments))}return _inherits(Day,_window$Collection$Ba),Day.prototype.checkItem=function(item){var _window$Collection$Ba2;return(_window$Collection$Ba2=_window$Collection$Ba.prototype.checkItem).call.apply(_window$Collection$Ba2,[this].concat(Array.prototype.slice.call(arguments)))},Day}(window.Collection.Base),angular.module("BB.Services").provider("DayCollections",function(){return{$get:function(){return new window.BaseCollections}}}),window.Collection.Space=function(_window$Collection$Ba){function Space(){return _classCallCheck(this,Space),_possibleConstructorReturn(this,_window$Collection$Ba.apply(this,arguments))}return _inherits(Space,_window$Collection$Ba),Space.prototype.checkItem=function(item){var _window$Collection$Ba2;return(_window$Collection$Ba2=_window$Collection$Ba.prototype.checkItem).call.apply(_window$Collection$Ba2,[this].concat(Array.prototype.slice.call(arguments)))},Space}(window.Collection.Base),angular.module("BB.Services").provider("SpaceCollections",function(){return{$get:function(){return new window.BaseCollections}}}),angular.module("angular-hal",[]).provider("data_cache",function(){this.$get=function(){var data=[];return{set:function(key,val){return data[key]=val,val},get:function(key){return data[key]},del:function(key){delete data[key]},has:function(key){return key in data},delMatching:function(str){for(var k in data)-1!=k.indexOf(str)&&delete data[k]}}}}).provider("shared_header",function(){this.$get=function(){var data={};return{set:function(key,val,store){return store.setItem(key,val),data[key]=val,val},get:function(key){return data[key]},del:function(key){delete data[key]},has:function(key){return key in data}}}}).factory("halClient",["$http","$q","data_cache","shared_header","UriTemplate","$cookies","$sessionStorage","$localStorage",function($http,$q,data_cache,shared_header,UriTemplate,$cookies,$sessionStorage,$localStorage){function BaseResource(href,options,data,extra){function defineHiddenProperty(target,name,value){target[name]=value}function embedResource(resource){if(angular.isArray(resource))return resource.map(function(resource){return embedResource(resource)});var href=resource.$href("self");embedded.set(href,$q.when(resource))}function hrefLink(link,params){return link.templated?new UriTemplate(link.href).fillFromObject(params||{}):link.href}function callLink(method,link,params,data){if(null==params&&(params={}),angular.isArray(link))return $q.all(link.map(function(link){if("GET"!==method)throw"method is not supported for arrays";return callLink(method,link,params,data)}));var linkHref=hrefLink(link,params);return"GET"===method?embedded.has(linkHref)&&!params.no_cache?embedded.get(linkHref):embedded.set(linkHref,callService(method,linkHref,options,data)):callService(method,linkHref,options,data)}function flushLink(link,params){if(angular.isArray(link))return link.map(function(link){return flushLink(link,params)});var linkHref=hrefLink(link,params);embedded.has(linkHref)&&embedded.del(linkHref)}options||(options={}),extra||(extra={});var links={},embedded=data_cache;data.hasOwnProperty("auth_token")&&(options.auth_token=data.auth_token),href=getSelfLink(href,data).href,defineHiddenProperty(this,"$href",function(rel,params){return rel in links?hrefLink(links[rel],params):null}),defineHiddenProperty(this,"$has",function(rel){return rel in links}),defineHiddenProperty(this,"$flush",function(rel,params){return flushLink(links[rel],params)}),defineHiddenProperty(this,"$get",function(rel,params){return callLink("GET",links[rel],params)}),defineHiddenProperty(this,"$post",function(rel,params,data){return callLink("POST",links[rel],params,data)}),defineHiddenProperty(this,"$put",function(rel,params,data){return callLink("PUT",links[rel],params,data)}),defineHiddenProperty(this,"$patch",function(rel,params,data){return callLink("PATCH",links[rel],params,data)}),defineHiddenProperty(this,"$del",function(rel,params,data){return callLink("DELETE",links[rel],params,data)}),defineHiddenProperty(this,"$links",function(){return links}),defineHiddenProperty(this,"$toStore",function(){return JSON.stringify({data:this,links:links,options:options})}),defineHiddenProperty(this,"setOption",function(key,value){options[key]=value}),defineHiddenProperty(this,"getOption",function(key){return options[key]}),defineHiddenProperty(this,"$link",function(rel){return links[rel]}),Object.keys(data).filter(function(key){return!~["_","$"].indexOf(key[0])}).forEach(function(key){this[key]=data[key]},this),data._links&&Object.keys(data._links).forEach(function(rel){var link=data._links[rel];link=normalizeLink(href,link),links[rel]=link},this),data._embedded&&Object.keys(data._embedded).forEach(function(rel){var embedded=data._embedded[rel],link=getSelfLink(href,embedded);links[rel]=link,embedResource(createResource(href,options,embedded))},this),extra.is_new&&(this.is_new=!0)}function createResource(href,options,data,extra){return angular.isArray(data)?data.map(function(data){return createResource(href,options,data,extra)}):new BaseResource(href,options,data,extra)}function normalizeLink(baseHref,link){return angular.isArray(link)?link.map(function(link){return normalizeLink(baseHref,link)}):(link?("string"==typeof link&&(link={href:link}),link.href=resolveUrl(baseHref,link.href)):link={href:baseHref},link)}function getSelfLink(baseHref,resource){return angular.isArray(resource)?resource.map(function(resource){return getSelfLink(baseHref,resource)}):normalizeLink(baseHref,resource&&resource._links&&resource._links.self)}function callService(method,href,options,data){options||(options={});var headers={"Content-Type":"application/json",Accept:"application/hal+json,application/json"};return options.authorization&&(headers.Authorization=options.authorization),options.app_id&&shared_header.set("app_id",options.app_id,$sessionStorage),options.app_key&&shared_header.set("app_key",options.app_key,$sessionStorage),options.auth_token&&($sessionStorage.setItem("auth_token",options.auth_token),shared_header.set("auth_token",options.auth_token,$sessionStorage)),shared_header.has("app_id")&&(headers["App-Id"]=shared_header.get("app_id")),shared_header.has("app_key")&&(headers["App-Key"]=shared_header.get("app_key")),shared_header.has("auth_token")&&(headers["Auth-Token"]=shared_header.get("auth_token")),options.bypass_auth&&(headers["Bypass-Auth"]=options.bypass_auth),$http({method:method,url:options.transformUrl?options.transformUrl(href):href,headers:headers,data:data}).then(function(res){switch(res.headers("auth-token")&&201==res.status&&(options.auth_token=res.headers("Auth-Token"),shared_header.set("auth_token",res.headers("Auth-Token"),$sessionStorage),$localStorage.getItem("auth_token")&&$localStorage.setItem("auth_token",res.headers("Auth-Token"))),res.status){case 200:return res.data&&'"null"'!==res.data?createResource(href,options,res.data):null;case 201:var extra={is_new:!0};return res.data?createResource(href,options,res.data,extra):res.headers("Content-Location")?res.headers("Content-Location"):null;case 204:return null;default:return $q.reject(res)}},function(res){return $q.reject(res)})}function parseHal(data){return createResource(data._links.self.href,null,data)}function resolveUrl(baseHref,href){for(var resultHref="",reFullUrl=/^((?:\w+\:)?)((?:\/\/)?)([^\/]*)((?:\/.*)?)$/,baseHrefMatch=reFullUrl.exec(baseHref),hrefMatch=reFullUrl.exec(href),partIndex=1;partIndex<5;partIndex++)hrefMatch[partIndex]?resultHref+=hrefMatch[partIndex]:resultHref+=baseHrefMatch[partIndex];return resultHref}return $sessionStorage.getItem("auth_token")?shared_header.set("auth_token",$sessionStorage.getItem("auth_token"),$sessionStorage):$cookies.get("Auth-Token")&&!shared_header.has("auth_token")&&shared_header.set("auth_token",$cookies.get("Auth-Token"),$sessionStorage),{setCache:function(cache){data_cache=cache},clearCache:function(str){data_cache.delMatching(str)},createResource:function(store){"string"==typeof store&&(store=JSON.parse(store));var resource=store.data;return resource._links=store.links,new BaseResource(store.links.self.href,store.options,resource)},$get:function(href,options){return!data_cache.has(href)||options&&options.no_cache?data_cache.set(href,callService("GET",href,options)):data_cache.get(href)},$post:function(href,options,data){return callService("POST",href,options,data)},$put:function(href,options,data){return callService("PUT",href,options,data)},$patch:function(href,options,data){return callService("PATCH",href,options,data)},$del:function(href,options,data){return callService("DELETE",href,options,data)},$parse:function(data){return parseHal(data)}}}]),angular.module("ngStorage",[]).factory("$fakeStorage",["$cookies",function($cookies){function FakeStorage(){}return FakeStorage.prototype.setItem=function(key,value){$cookies.put(key,value)},FakeStorage.prototype.getItem=function(key){return void 0===$cookies.get(key)?null:$cookies.get(key)},FakeStorage.prototype.removeItem=function(key){$cookies.get(key)&&$cookies.remove(key)},FakeStorage.prototype.clear=function(){for(var key in $cookies.getAll())$cookies.remove(key)},FakeStorage.prototype.key=function(index){return Object.keys($cookies.getAll())[index]},new FakeStorage}]).factory("$localStorage",["$window","$fakeStorage",function($window,$fakeStorage){var storage=function(storageName){var storage=$window[storageName];try{return storage.setItem("test","1"),storage.removeItem("test"),!0}catch(error){return!1}}("localStorage")?$window.localStorage:$fakeStorage;return{setItem:function(key,value){storage.setItem(key,value)},getItem:function(key,defaultValue){return storage.getItem(key)||defaultValue},setObject:function(key,value){storage.setItem(key,JSON.stringify(value))},getObject:function(key){return JSON.parse(storage.getItem(key)||"{}")},removeItem:function(key){storage.removeItem(key)},clear:function(){storage.clear()},key:function(index){storage.key(index)}}}]).factory("$sessionStorage",["$window","$fakeStorage",function($window,$fakeStorage){var storage=function(storageName){var storage=$window[storageName];try{return storage.setItem("test","1"),storage.removeItem("test"),!0}catch(error){return!1}}("sessionStorage")?$window.sessionStorage:$fakeStorage;return{setItem:function(key,value){storage.setItem(key,value)},getItem:function(key,defaultValue){return storage.getItem(key)||defaultValue},setObject:function(key,value){storage.setItem(key,JSON.stringify(value))},getObject:function(key){return JSON.parse(storage.getItem(key)||"{}")},removeItem:function(key){storage.removeItem(key)},clear:function(){storage.clear()},key:function(index){storage.key(index)}}}]),angular.module("ngLocalData",["angular-hal"]).factory("$localCache",["halClient","$q","$sessionStorage",function(halClient,$q,$sessionStorage){return data={},jsonData=function(data){return data&&JSON.parse(data)},storage=function(){return $sessionStorage},localSave=function(key,item){storage().setItem(key,item.$toStore())},localLoad=function(key){return res=jsonData(storage().getItem(key)),res?(r=halClient.createResource(res),def=$q.defer(),def.resolve(r),def.promise):null},localDelete=function(key){storage().removeItem(key)},{set:function(key,val){return data[key]=val,val.then(function(item){localSave(key,item)}),val},get:function(key){return localLoad(key),data[key]||(data[key]=localLoad(key)),data[key]},del:function(key){localDelete(key),delete data[key]},has:function(key){return data[key]||(res=localLoad(key),res&&(data[key]=res)),key in data}}}]).factory("$localData",["$http","$rootScope","$sessionStorage",function($http,$rootScope,$sessionStorage){function LocalDataFactory(name){function LocalData(value){this.setStore(value)}return LocalData.prototype.jsonData=function(data){return data&&JSON.parse(data)},LocalData.prototype.storage=function(){return $sessionStorage},LocalData.prototype.localSave=function(item){this.storage().setItem(this.store_name+item.id,JSON.stringify(item))},LocalData.prototype.localSaveIndex=function(ids){this.storage().setItem(this.store_name,ids.join(",")),this.ids=ids},LocalData.prototype.localLoadIndex=function(){return store=this.storage().getItem(this.store_name),records=store&&store.split(",")||[],records},LocalData.prototype.localLoad=function(id){return this.jsonData(this.storage().getItem(this.store_name+id))},LocalData.prototype.count=function(){return this.ids.length},LocalData.prototype.setStore=function(name){for(this.store_name=name,this.data_store=[],this.ids=this.localLoadIndex(),a=0;a<this.ids.length;a++)this.data_store.push(this.localLoad(this.ids[a]))},LocalData.prototype.update=function(data){ids=[];for(x in data)data[x].id&&(ids.push(data[x].id),this.localSave(data[x]));this.localSaveIndex(ids)},new LocalData(name)}return LocalDataFactory}]),moment.fn.toISODate||(moment.fn.toISODate=function(){return this.clone().locale("en").format("YYYY-MM-DD")}),String.prototype.includes||(String.prototype.includes=function(search,start){return"number"!=typeof start&&(start=0),!(start+search.length>this.length)&&-1!==this.indexOf(search,start)}),String.prototype.parameterise=function(seperator){return null==seperator&&(seperator="-"),this.trim().replace(/\s/g,seperator).toLowerCase()},angular.module("BB").constant("routeStates",{Company:0,Category:1,Service:2,Person:3,Resource:4,Duration:5,Date:6,Time:7,Client:8,Summary:9,Basket:10,Checkout:11,Slot:12,Event:13,Login:14,Questions:15,Confirmation:16}),angular.module("BB.Directives").directive("bbWalletRemainder",function(){return{restrict:"A",scope:{totalPrice:"=",walletAmount:"="},controllerAs:"vm",bindToController:!0,template:'<span translate="PUBLIC_BOOKING.BASKET.WALLET.REMAINDER" translate-values="{remainder: vm.amountRemaining}"></span>',controller:function(){return this.amountRemaining=this.walletAmount-this.totalPrice}}}),angular.module("BB.Filters").filter("stripPostcode",function(){return function(address){var match=address.toLowerCase().match(/[a-z]+\d/);return match&&(address=address.substr(0,match.index)),address=$.trim(address),/,$/.test(address)&&(address=address.slice(0,-1)),address}}),angular.module("BB.Filters").filter("labelNumber",function(){return function(input,labels){var response=input;return labels[input]&&(response=labels[input]),response}}),angular.module("BB.Filters").filter("interpolate",["version",function(version){return function(text){return String(text).replace(/\%VERSION\%/gm,version)}}]),angular.module("BB.Filters").filter("rag",function(){return function(value,v1,v2){return value<=v1?"red":value<=v2?"amber":"green"}}),angular.module("BB.Filters").filter("time",function($window){return function(v){return $window.sprintf("%02d:%02d",Math.floor(v/60),v%60)}}),angular.module("BB.Filters").filter("address_single_line",function(){return function(address){if(address&&address.address1){var addr="";return addr+=address.address1,address.address2&&address.address2.length>0&&(addr+=", ",addr+=address.address2),address.address3&&address.address3.length>0&&(addr+=", ",addr+=address.address3),address.address4&&address.address4.length>0&&(addr+=", ",addr+=address.address4),address.address5&&address.address5.length>0&&(addr+=", ",addr+=address.address5),address.postcode&&address.postcode.length>0&&(addr+=", ",addr+=address.postcode),addr}}}),angular.module("BB.Filters").filter("address_multi_line",function(){return function(address){if(address&&address.address1){var str="";return address.address1&&(str+=address.address1),address.address2&&str.length>0&&(str+="<br/>"),address.address2&&(str+=address.address2),address.address3&&str.length>0&&(str+="<br/>"),address.address3&&(str+=address.address3),address.address4&&str.length>0&&(str+="<br/>"),address.address4&&(str+=address.address4),address.address5&&str.length>0&&(str+="<br/>"),address.address5&&(str+=address.address5),address.postcode&&str.length>0&&(str+="<br/>"),address.postcode&&(str+=address.postcode),str}}}),angular.module("BB.Filters").filter("map_lat_long",function(){return function(address){if(address&&address.map_url){return/([-+]*\d{1,3}[\.]\d*)[, ]([-+]*\d{1,3}[\.]\d*)/.exec(address.map_url)[0]}}}),angular.module("BB.Filters").filter("distance",function($translate,bbLocale){return function(distance_in_km,round_by){if(!distance_in_km)return"";var distance=distance_in_km,use_miles=bbLocale.getLocale().match(/^(en|en-gb|en-us)$/gi);return use_miles&&(distance*=.621371192),round_by&&(distance=Math.round(distance*Math.pow(10,round_by))/Math.pow(10,round_by)),distance=distance+" "+(use_miles?$translate.instant("CORE.FILTERS.DISTANCE.MILES"):$translate.instant("CORE.FILTERS.DISTANCE.KILOMETRES"))}}),angular.module("BB.Filters").filter("currency",function($window,$rootScope,CompanyStoreService,$translate){return function(amount,currency_code,pretty_price){if(null==pretty_price&&(pretty_price=!1),angular.isNumber(amount)){var currency_codes={USD:"$",GBP:"£",AUD:"$",EUR:"€",CAD:"$",MIXED:"~",RUB:"₽"};currency_code||(currency_code=CompanyStoreService.currency_code);var format=$translate.instant(["CORE.FILTERS.CURRENCY.THOUSANDS_SEPARATOR","CORE.FILTERS.CURRENCY.DECIMAL_SEPARATOR","CORE.FILTERS.CURRENCY.CURRENCY_FORMAT"]),hide_decimal=pretty_price&&amount%100==0,decimal_places=hide_decimal?0:2;return $window.accounting.formatMoney(amount/100,currency_codes[currency_code],decimal_places,format.THOUSANDS_SEPARATOR,format.DECIMAL_SEPARATORS,format.CURRENCY_FORMAT)}}}),angular.module("BB.Filters").filter("icurrency",function($filter){return function(number,currency_code){return $filter("currency")(number,currency_code)}}),angular.module("BB.Filters").filter("raw_currency",function(){return function(number){return number/100}}),angular.module("BB.Filters").filter("pretty_price",function($translate,$filter){return function(price,currency_code){return 0===parseFloat(price)?$translate.instant("CORE.FILTERS.PRETTY_PRICE.FREE"):$filter("currency")(price,currency_code,!0)}}),angular.module("BB.Filters").filter("ipretty_price",function($filter){return function(number,currencyCode){return $filter("pretty_price")(number,currencyCode)}}),angular.module("BB.Filters").filter("time_period",function($translate){return function(v){if(angular.isNumber(v)){var minutes=parseInt(v),hours=Math.floor(minutes/60);minutes%=60;var show_seperator=hours>0&&minutes>0;return $translate.instant("CORE.FILTERS.TIME_PERIOD.TIME_PERIOD",{hours:hours,minutes:minutes,show_seperator:+show_seperator},"messageformat")}}}),angular.module("BB.Filters").filter("time_period_from_seconds",function($translate,$filter){return function(v,precision){if(angular.isNumber(v)){var seconds=parseInt(v),time_period="";return"minutes"==precision?moment.duration(seconds/60,"minutes").humanize():(seconds>=60&&(time_period+=$filter("time_period")(seconds/60),seconds%60>0&&(time_period+=$translate.instant("CORE.FILTERS.TIME_PERIOD.TIME_PERIOD"))),seconds%60>0&&(time_period+=moment.duration(seconds%60,"seconds").humanize()),time_period)}}}),angular.module("BB.Filters").filter("twelve_hour_time",function($window){return function(time,options){if(angular.isNumber(time)){var omit_mins_on_hour=options&&options.omit_mins_on_hour||!1,separator=options&&options.separator?options.separator:":",t=time,h=Math.floor(t/60),m=t%60,suffix="am";return h>=12&&(suffix="pm"),h>12&&(h-=12),time=0===m&&omit_mins_on_hour?""+h:""+h+separator+$window.sprintf("%02d",m),time+=suffix}}}),angular.module("BB.Filters").filter("round_up",function(){return function(number,interval){var result=number/interval;return result=parseInt(result),result*=interval,number%interval>0&&(result+=interval),result}}),angular.module("BB.Filters").filter("exclude_days",function(){return function(days,excluded){return _.filter(days,function(day){return-1===excluded.indexOf(day.date.format("dddd"))})}}),angular.module("BB.Filters").filter("local_phone_number",function(CompanyStoreService,ValidatorService){return function(phone_number,country_code){if(phone_number)switch(country_code||(country_code=CompanyStoreService.country_code),country_code){case"gb":return phone_number.replace(/^(\+44 \(0\)|\S{0})/,"0");case"us":return phone_number.replace(ValidatorService.us_phone_number,"($1) $2 $3");default:return phone_number}}}),angular.module("BB.Filters").filter("datetime",function($translate,bbTimeZone){return function(date,format,show_time_zone){var timeZone="";if(null==format&&(format="LLL"),null==show_time_zone&&(show_time_zone=!1),date&&(!date||moment(date).isValid())){var new_date=moment(date);return new_date.tz(bbTimeZone.getDisplay()),show_time_zone&&(timeZone="("+$translate.instant("I18N.TIMEZONE_LOCATIONS.CODES."+new_date.format("zz"))+")"),new_date.format(format)+" "+timeZone}}}),angular.module("BB.Filters").filter("range",function(){return function(input,min,max){return __range__(parseInt(min),parseInt(max),!0).map(function(i){return input.push(i)}),input}}),angular.module("BB.Filters").filter("international_number",function(){return function(number,prefix){return number&&prefix?prefix+" "+number:number?""+number:""}}),angular.module("BB.Filters").filter("startFrom",function(){return function(input,start){return void 0===input?input:input.slice(+start)}}),angular.module("BB.Filters").filter("add",function(){return function(item,value){if(item&&value)return(item=parseInt(item))+value}}),angular.module("BB.Filters").filter("spaces_remaining",function(){return function(spaces){return spaces<1?0:spaces}}),angular.module("BB.Filters").filter("key_translate",function(){return function(input){return angular.uppercase(input).replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\ /g,"_")}}),angular.module("BB.Filters").filter("nl2br",function(){return function(str){if(str)return str.replace(/\n/g,"<br/>")}}),angular.module("BB.Filters").filter("clearTimezone",function(){return function(val,offset){return null!==val&&val.length>19?val.substring(0,19):val}}),angular.module("BB.Filters").filter("format_answer",function(){return function(answer){return"boolean"==typeof answer?answer=!0===answer?"Yes":"No":moment(answer,"YYYY-MM-DD",!0).isValid()&&(answer=moment(answer).format("D MMMM YYYY")),answer}}),angular.module("BB.Filters").filter("snakeCase",function(){return function(string){return string.trim().replace(/\s/g,"_").toLowerCase()}}),angular.module("BB.Filters").filter("wordCharactersAndSpaces",function(){return function(string){return string.replace(/[^a-zA-Z0-9\_\s]+/,"")}}),angular.module("BB.Filters").filter("props",function($translate){"ngInject";return function(items,props){var out=[];if(angular.isArray(items)){var keys=Object.keys(props);items.forEach(function(item){for(var itemMatches=!1,i=0;i<keys.length;){var prop=keys[i],text=props[prop].toLowerCase();if(null!=item[prop]&&-1!==$translate.instant(item[prop]).toString().toLowerCase().indexOf(text)){itemMatches=!0;break}i++}itemMatches&&out.push(item)})}else out=items;return out}}),angular.module("BB.i18n").config(function(bbi18nOptionsProvider,tmhDynamicLocaleProvider,$translateProvider){"ngInject";$translateProvider.useSanitizeValueStrategy("escape"),$translateProvider.useLocalStorage(),$translateProvider.addInterpolation("$translateMessageFormatInterpolation"),$translateProvider.fallbackLanguage(bbi18nOptionsProvider.getOption("available_languages")),tmhDynamicLocaleProvider.localeLocationPattern("angular-i18n/angular-locale_{{locale}}.js"),tmhDynamicLocaleProvider.useCookieStorage()}),angular.module("BB.i18n").run(function($localStorage,bbi18nOptions,bbLocale,RuntimeTranslate,bbTimeZone,bbTimeZoneOptions){"ngInject";RuntimeTranslate.registerAvailableLanguageKeys(bbi18nOptions.available_languages,bbi18nOptions.available_language_associations),bbLocale.determineLocale(),bbTimeZone.determine()}),angular.module("BB.Models").factory("AddressModel",function($q,BBModel,BaseModel,AddressListService){return function(_BaseModel){function Address(data){_classCallCheck(this,Address);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.map_url&&""!==_this.map_url||_this.lat&&_this.long&&(_this.map_url="https://www.google.com/maps/@"+_this.lat+","+_this.long+",17z"),_this}return _inherits(Address,_BaseModel),Address.prototype.addressSingleLine=function(){var str="";return this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+=", "),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+=", "),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+=", "),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+=", "),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+=", "),this.postcode&&(str+=this.postcode),str},Address.prototype.hasAddress=function(){return this.address1||this.address2||this.postcode},Address.prototype.addressCsvLine=function(){var str="";return this.address1&&(str+=this.address1),str+=", ",this.address2&&(str+=this.address2),str+=", ",this.address3&&(str+=this.address3),str+=", ",this.address4&&(str+=this.address4),str+=", ",this.address5&&(str+=this.address5),str+=", ",this.postcode&&(str+=this.postcode),str+=", ",this.country&&(str+=this.country),str},Address.prototype.addressMultiLine=function(){var str="";return this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+="<br/>"),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+="<br/>"),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+="<br/>"),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+="<br/>"),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+="<br/>"),this.postcode&&(str+=this.postcode),str},Address.$query=function(prms){return AddressListService.query(prms)},Address.$getAddress=function(prms){return AddressListService.getAddress(prms)},Address}(BaseModel)}),angular.module("BB.Models").factory("AffiliateModel",function($q,BBModel,BaseModel,halClient,$rootScope){return function(_BaseModel){function Affiliate(data){_classCallCheck(this,Affiliate);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.test=1,_this}return _inherits(Affiliate,_BaseModel),Affiliate.prototype.getCompanyByRef=function(ref){var prms={id:this.cookie,reference:ref},href=$rootScope.bb.api_url+"/api/v1/affiliates/{id}/companies/{reference}",uri=new UriTemplate(href).fillFromObject(prms||{}),defer=$q.defer();return halClient.$get(uri,{}).then(function(company){return company?defer.resolve(new BBModel.Company(company)):defer.reject("No company for ref "+ref)},function(err){return console.log("err ",err),defer.reject(err)}),defer.promise},Affiliate}(BaseModel)}),angular.module("BB.Models").factory("AnswerModel",function($q,BBModel,BaseModel,$bbug){return function(_BaseModel){function Answer(data){return _classCallCheck(this,Answer),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(Answer,_BaseModel),Answer.prototype.getQuestion=function(){var _this2=this,defer=$q.defer();return this.question&&defer.resolve(this.question),this._data.$has("question")?this._data.$get("question").then(function(question){return _this2.question=question,defer.resolve(_this2.question)}):defer.resolve([]),defer.promise},Answer}(BaseModel)}),angular.module("BB.Models").service("BBModel",function($q,$injector){}),angular.module("BB.Models").run(function($q,$injector,BBModel){var models=["Address","Answer","Affiliate","Basket","BasketItem","BookableItem","Category","Client","ClientDetails","Company","CompanySettings","Day","Event","EventChain","EventGroup","EventTicket","EventSequence","Item","Items","ItemDetails","PaymentCallbacks","Person","PurchaseItem","PurchaseTotal","Question","Resource","Service","Slot","Space","Clinic","SurveyQuestion","TimeSlot","BusinessQuestion","Image","Deal","PrePaidBooking","MembershipLevel","Product","BBCollection","ExternalPurchase","PackageItem","BulkPurchase","Pagination","Reason","Login"],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(models)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var model=_step.value;BBModel[model]=$injector.get(model+"Model")}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}var purchase_models=["Booking","Total","CourseBooking"],pfuncs={},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(purchase_models)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)model=_step2.value,pfuncs[model]=$injector.get("Purchase."+model+"Model")}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return BBModel.Purchase=pfuncs}),angular.module("BB.Models").service("BaseModel",function($q,$injector,$rootScope,$timeout){return function(){function Base(data){_classCallCheck(this,Base),this.deleted=!1,
this.updateModel(data)}return Base.prototype.updateModel=function(data){var _this=this;if(data&&(this._data=data),data)for(var n in data){var m=data[n];"function"!=typeof m&&(this[n]=m)}if(this._data&&this._data.$href){this.self=this._data.$href("self");var links=this.$links();return this.__linkedData={},this.__linkedPromises={},function(){var result=[];for(var link in links){var name=(links[link],_this._snakeToCamel("get_"+link));result.push(function(link,obj,name){if(_this[name]||(_this[name]=function(options){return this.$buildOject(link,options)}),!_this["$"+name])return _this["$"+name]=function(options){return this.$buildOjectPromise(link,options)}}(link,0,name))}return result}()}},Base.prototype._snakeToCamel=function(s){return s.replace(/(\_\w)/g,function(m){return m[1].toUpperCase()})},Base.prototype.$buildOject=function(link,options){var _this2=this,linkId=link+(JSON.stringify(options)||"");return this.__linkedData[linkId]?this.__linkedData[linkId]:(this.$buildOjectPromise(link,options).then(function(ans){return _this2.__linkedData[linkId]=ans,$timeout(function(){return _this2.__linkedData[linkId]=ans})}),null)},Base.prototype.$buildOjectPromise=function(link,options){var linkId=link+(JSON.stringify(options)||"");if(this.__linkedPromises[linkId])return this.__linkedPromises[linkId];var prom=$q.defer();return this.__linkedPromises[linkId]=prom.promise,this.$get(link,options).then(function(res){var inj=$injector.get("BB.Service."+link);return inj?inj.promise?inj.unwrap(res).then(function(ans){return prom.resolve(ans)},function(err){return prom.reject(err)}):prom.resolve(inj.unwrap(res)):prom.resolve(res)},function(err){return prom.reject(err)}),this.__linkedPromises[linkId]},Base.prototype.get=function(ikey){return this._data?this._data[ikey]:null},Base.prototype.set=function(ikey,value){return this._data?this._data[ikey]=value:null},Base.prototype.getOption=function(ikey){return this._data?this._data.getOption(ikey):null},Base.prototype.setOption=function(ikey,value){return this._data?this._data.setOption(ikey,value):null},Base.prototype.$href=function(rel,params){if(this._data)return this._data.$href(rel,params)},Base.prototype.$has=function(rel){if(this._data)return this._data.$has(rel)},Base.prototype.$flush=function(rel,params){if(this._data)return this._data.$flush(rel,params)},Base.prototype.$get=function(rel,params){if(this._data)return this._data.$get(rel,params)},Base.prototype.$post=function(rel,params,dat){if(this._data)return this._data.$post(rel,params,dat)},Base.prototype.$put=function(rel,params,dat){if(this._data)return this._data.$put(rel,params,dat)},Base.prototype.$patch=function(rel,params,dat){if(this._data)return this._data.$patch(rel,params,dat)},Base.prototype.$del=function(rel,params,dat){if(this._data)return this._data.$del(rel,params,dat)},Base.prototype.$links=function(){if(this._data)return this._data.$links()},Base.prototype.$link=function(rel){if(this._data)return this._data.$link(rel)},Base.prototype.$toStore=function(){if(this._data)return this._data.$toStore()},Base}()}),angular.module("BB.Models").factory("BasketModel",function($q,BBModel,BaseModel,BasketService){return function(_BaseModel){function Basket(data,scope){_classCallCheck(this,Basket);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return scope&&scope.isAdmin?_this.is_admin=scope.isAdmin:_this.is_admin=!1,null!=scope&&scope.parent_client&&(_this.parent_client_id=scope.parent_client.id),_this.items=[],_this.reviewed=!1,_this}return _inherits(Basket,_BaseModel),Basket.prototype.addItem=function(item){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;if(i===item)return;if(i.id&&item.id&&i.id===item.id)return}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return this.items.push(item)},Basket.prototype.clear=function(){return this.items=[]},Basket.prototype.clearItem=function(item){return this.items=this.items.filter(function(i){return i!==item})},Basket.prototype.itemsReady=function(){if(this.items.length>0){var ready=!0,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){_step2.value.checkReady()||(ready=!1)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return ready}return!1},Basket.prototype.readyToCheckout=function(){if(this.items.length>0&&this.reviewed){var ready=!0,_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){_step3.value.checkReady()||(ready=!1)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return ready}return!1},Basket.prototype.timeItems=function(){var titems=[],_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var i=_step4.value;i.isTimeItem()&&titems.push(i)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return titems},Basket.prototype.hasTimeItems=function(){var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){if(_step5.value.isTimeItem())return!0}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return!1},Basket.prototype.basketItems=function(){var bitems=[],_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var i=_step6.value;i.is_coupon||bitems.push(i)}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}return bitems},Basket.prototype.externalPurchaseItems=function(){var eitems=[],_iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _step7,_iterator7=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var i=_step7.value;i.isExternalPurchase()&&eitems.push(i)}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}return eitems},Basket.prototype.couponItems=function(){var citems=[],_iteratorNormalCompletion8=!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var _step8,_iterator8=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=!0){var i=_step8.value;i.is_coupon&&citems.push(i)}}catch(err){_didIteratorError8=!0,_iteratorError8=err}finally{try{!_iteratorNormalCompletion8&&_iterator8.return&&_iterator8.return()}finally{if(_didIteratorError8)throw _iteratorError8}}return citems},Basket.prototype.removeCoupons=function(){return this.items=_.reject(this.items,function(x){return x.is_coupon})},Basket.prototype.setSettings=function(set){if(set)return this.settings||(this.settings={}),$.extend(this.settings,set)},Basket.prototype.setClient=function(client){return this.client=client},Basket.prototype.setClientDetails=function(client_details){return this.client_details=new BBModel.PurchaseItem(client_details)},Basket.prototype.getPostData=function(){var post={client:this.client.getPostData(),settings:this.settings,reference:this.reference};post.is_admin=this.is_admin,post.parent_client_id=this.parent_client_id,post.take_from_wallet=this.take_from_wallet,post.items=[];var _iteratorNormalCompletion9=!0,_didIteratorError9=!1,_iteratorError9=void 0;try{for(var _step9,_iterator9=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=!0){var item=_step9.value;post.items.push(item.getPostData())}}catch(err){_didIteratorError9=!0,_iteratorError9=err}finally{try{!_iteratorNormalCompletion9&&_iterator9.return&&_iterator9.return()}finally{if(_didIteratorError9)throw _iteratorError9}}return post},Basket.prototype.dueTotal=function(){var total=this.totalPrice(),_iteratorNormalCompletion10=!0,_didIteratorError10=!1,_iteratorError10=void 0;try{for(var _step10,_iterator10=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=!0){var item=_step10.value;item.isWaitlist()&&(total-=item.price)}}catch(err){_didIteratorError10=!0,_iteratorError10=err}finally{try{!_iteratorNormalCompletion10&&_iterator10.return&&_iterator10.return()}finally{if(_didIteratorError10)throw _iteratorError10}}return total<0&&(total=0),total},Basket.prototype.length=function(){return this.items.length},Basket.prototype.questionPrice=function(options){var unready=options&&options.unready,price=0,_iteratorNormalCompletion11=!0,_didIteratorError11=!1,_iteratorError11=void 0;try{for(var _step11,_iterator11=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done);_iteratorNormalCompletion11=!0){var item=_step11.value;(!item.ready&&unready||!unready)&&(price+=item.questionPrice())}}catch(err){_didIteratorError11=!0,_iteratorError11=err}finally{try{!_iteratorNormalCompletion11&&_iterator11.return&&_iterator11.return()}finally{if(_didIteratorError11)throw _iteratorError11}}return price},Basket.prototype.totalPrice=function(options){var unready=options&&options.unready,price=0,_iteratorNormalCompletion12=!0,_didIteratorError12=!1,_iteratorError12=void 0;try{for(var _step12,_iterator12=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion12=(_step12=_iterator12.next()).done);_iteratorNormalCompletion12=!0){var item=_step12.value;(!item.ready&&unready||!unready)&&(price+=item.totalPrice())}}catch(err){_didIteratorError12=!0,_iteratorError12=err}finally{try{!_iteratorNormalCompletion12&&_iterator12.return&&_iterator12.return()}finally{if(_didIteratorError12)throw _iteratorError12}}return price},Basket.prototype.updateTotalPrice=function(options){return this.total_price=this.totalPrice(options)},Basket.prototype.fullPrice=function(){var price=0,_iteratorNormalCompletion13=!0,_didIteratorError13=!1,_iteratorError13=void 0;try{for(var _step13,_iterator13=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion13=(_step13=_iterator13.next()).done);_iteratorNormalCompletion13=!0){price+=_step13.value.fullPrice()}}catch(err){_didIteratorError13=!0,_iteratorError13=err}finally{try{!_iteratorNormalCompletion13&&_iterator13.return&&_iterator13.return()}finally{if(_didIteratorError13)throw _iteratorError13}}return price},Basket.prototype.hasCoupon=function(){var _iteratorNormalCompletion14=!0,_didIteratorError14=!1,_iteratorError14=void 0;try{for(var _step14,_iterator14=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion14=(_step14=_iterator14.next()).done);_iteratorNormalCompletion14=!0){if(_step14.value.is_coupon)return!0}}catch(err){_didIteratorError14=!0,_iteratorError14=err}finally{try{!_iteratorNormalCompletion14&&_iterator14.return&&_iterator14.return()}finally{if(_didIteratorError14)throw _iteratorError14}}return!1},Basket.prototype.totalCoupons=function(){return this.fullPrice()-this.totalPrice()-this.totalDealPaid()},Basket.prototype.totalDuration=function(){var duration=0,_iteratorNormalCompletion15=!0,_didIteratorError15=!1,_iteratorError15=void 0;try{for(var _step15,_iterator15=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion15=(_step15=_iterator15.next()).done);_iteratorNormalCompletion15=!0){var item=_step15.value;item.service&&item.service.listed_duration&&(duration+=item.service.listed_duration)}}catch(err){_didIteratorError15=!0,_iteratorError15=err}finally{try{!_iteratorNormalCompletion15&&_iterator15.return&&_iterator15.return()}finally{if(_didIteratorError15)throw _iteratorError15}}return duration},Basket.prototype.containsDeal=function(){var _iteratorNormalCompletion16=!0,_didIteratorError16=!1,_iteratorError16=void 0;try{for(var _step16,_iterator16=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion16=(_step16=_iterator16.next()).done);_iteratorNormalCompletion16=!0){if(_step16.value.deal_id)return!0}}catch(err){_didIteratorError16=!0,_iteratorError16=err}finally{try{!_iteratorNormalCompletion16&&_iterator16.return&&_iterator16.return()}finally{if(_didIteratorError16)throw _iteratorError16}}return!1},Basket.prototype.hasDeal=function(){var _iteratorNormalCompletion17=!0,_didIteratorError17=!1,_iteratorError17=void 0;try{for(var _step17,_iterator17=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion17=(_step17=_iterator17.next()).done);_iteratorNormalCompletion17=!0){var item=_step17.value;if(item.deal_codes&&item.deal_codes.length>0)return!0}}catch(err){_didIteratorError17=!0,_iteratorError17=err}finally{try{!_iteratorNormalCompletion17&&_iterator17.return&&_iterator17.return()}finally{if(_didIteratorError17)throw _iteratorError17}}return!1},Basket.prototype.getDealCodes=function(){return this.deals=this.items[0]&&this.items[0].deal_codes?this.items[0].deal_codes:[],this.deals},Basket.prototype.totalDeals=function(){var value=0,_iteratorNormalCompletion18=!0,_didIteratorError18=!1,_iteratorError18=void 0;try{for(var _step18,_iterator18=Array.from(this.getDealCodes())[Symbol.iterator]();!(_iteratorNormalCompletion18=(_step18=_iterator18.next()).done);_iteratorNormalCompletion18=!0){value+=_step18.value.value}}catch(err){_didIteratorError18=!0,_iteratorError18=err}finally{try{!_iteratorNormalCompletion18&&_iterator18.return&&_iterator18.return()}finally{if(_didIteratorError18)throw _iteratorError18}}return value},Basket.prototype.totalDealPaid=function(){var total_cert_paid=0,_iteratorNormalCompletion19=!0,_didIteratorError19=!1,_iteratorError19=void 0;try{for(var _step19,_iterator19=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion19=(_step19=_iterator19.next()).done);_iteratorNormalCompletion19=!0){var item=_step19.value;item.certificate_paid&&(total_cert_paid+=item.certificate_paid)}}catch(err){_didIteratorError19=!0,_iteratorError19=err}finally{try{!_iteratorNormalCompletion19&&_iterator19.return&&_iterator19.return()}finally{if(_didIteratorError19)throw _iteratorError19}}return total_cert_paid},Basket.prototype.remainingDealBalance=function(){return this.totalDeals()-this.totalDealPaid()},Basket.prototype.hasWaitlistItem=function(){var _iteratorNormalCompletion20=!0,_didIteratorError20=!1,_iteratorError20=void 0;try{for(var _step20,_iterator20=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion20=(_step20=_iterator20.next()).done);_iteratorNormalCompletion20=!0){if(_step20.value.isWaitlist())return!0}}catch(err){_didIteratorError20=!0,_iteratorError20=err}finally{try{!_iteratorNormalCompletion20&&_iterator20.return&&_iterator20.return()}finally{if(_didIteratorError20)throw _iteratorError20}}return!1},Basket.prototype.hasExternalPurchase=function(){var _iteratorNormalCompletion21=!0,_didIteratorError21=!1,_iteratorError21=void 0;try{for(var _step21,_iterator21=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion21=(_step21=_iterator21.next()).done);_iteratorNormalCompletion21=!0){if(_step21.value.isExternalPurchase())return!0}}catch(err){_didIteratorError21=!0,_iteratorError21=err}finally{try{!_iteratorNormalCompletion21&&_iterator21.return&&_iterator21.return()}finally{if(_didIteratorError21)throw _iteratorError21}}return!1},Basket.prototype.useWallet=function(value,client){return client&&client.$has("wallet")&&value?(this.take_from_wallet=!0,!0):(this.take_from_wallet=!1,!1)},Basket.$applyCoupon=function(company,params){return BasketService.applyCoupon(company,params)},Basket.$updateBasket=function(company,params){return BasketService.updateBasket(company,params)},Basket.$deleteItem=function(item,company,params){return BasketService.deleteItem(item,company,params)},Basket.$checkout=function(company,basket,params){return BasketService.checkout(company,basket,params)},Basket.$empty=function(bb){return BasketService.empty(bb)},Basket.$applyDeal=function(company,params){return BasketService.applyDeal(company,params)},Basket.$removeDeal=function(company,params){return BasketService.removeDeal(company,params)},Basket.prototype.voucherRemainder=function(){var amount=0,_iteratorNormalCompletion22=!0,_didIteratorError22=!1,_iteratorError22=void 0;try{for(var _step22,_iterator22=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion22=(_step22=_iterator22.next()).done);_iteratorNormalCompletion22=!0){var item=_step22.value;item.voucher_remainder&&(amount+=item.voucher_remainder)}}catch(err){_didIteratorError22=!0,_iteratorError22=err}finally{try{!_iteratorNormalCompletion22&&_iterator22.return&&_iterator22.return()}finally{if(_didIteratorError22)throw _iteratorError22}}return amount},Basket}(BaseModel)}),angular.module("BB.Models").factory("BasketItemModel",function($q,$window,BBModel,BookableItemModel,BaseModel,$bbug,DateTimeUtilitiesService,$translate){return function(_BaseModel){function BasketItem(data,bb){_classCallCheck(this,BasketItem);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));if(_this.ready=!1,_this.days_link=null,_this.book_link=null,_this.parts_links={},_this.settings||(_this.settings={}),_this.has_questions=!1,_this.ref||(_this.ref=Math.ceil(moment().unix()*Math.random())),_this.date&&(_this.date=new BBModel.Day({date:_this.date,spaces:1})),_.isNumber(_this.time)&&(_this.time=new BBModel.TimeSlot({time:_this.time,date:_this.date?_this.date.date:null,event_id:_this.event_id,selected:!0,avail:1,price:_this.price})),_this.datetime){_this.date=new BBModel.Day({date:_this.datetime.toISODate(),spaces:1});var t=60*_this.datetime.hour()+_this.datetime.minute();_this.time=new BBModel.TimeSlot({time:t,date:_this.date?_this.date.date:null,event_id:_this.event_id,selected:!0,avail:1,price:_this.price})}if(_this.id&&(_this.reserve_ready=!0,_this.held={time:_this.time,date:_this.date,event_id:_this.event_id,id:_this.id}),_this.promises=[],data){var prom=void 0,serv=void 0;if(data.$has("answers")&&data.$get("answers").then(function(answers){return data.questions=[],Array.from(answers).map(function(a){return data.questions.push({id:a.question_id,answer:a.value})})}),data.$has("company")){var comp=data.$get("company");_this.promises.push(comp),comp.then(function(comp){var c=new BBModel.Company(comp);return _this.promises.push(c.getSettings()),_this.setCompany(c)})}if(data.$has("service")&&(serv=data.$get("service"),_this.promises.push(serv),serv.then(function(serv){if(serv.$has("category")&&(prom=serv.$get("category"),_this.promises.push(prom),prom.then(function(cat){return _this.setCategory(new BBModel.Category(cat))})),_this.setService(new BBModel.Service(serv),data.questions),_this.duration&&_this.setDuration(_this.duration),_this.checkReady(),_this.time)return _this.time.service=_this.service})),data.$has("event_group")&&(serv=data.$get("event_group"),_this.promises.push(serv),serv.then(function(serv){if(serv.$has("category")&&(prom=serv.$get("category"),_this.promises.push(prom),prom.then(function(cat){return _this.setCategory(new BBModel.Category(cat))})),_this.setEventGroup(new BBModel.EventGroup(serv)),_this.time)return _this.time.service=_this.event_group})),data.$has("event_chain")){var chain=data.$get("event_chain");_this.promises.push(chain),data.$has("event")||chain.then(function(serv){return _this.setEventChain(new BBModel.EventChain(serv),data.questions)})}if(data.$has("resource")){var res=data.$get("resource");_this.promises.push(res),res.then(function(res){return _this.setResource(new BBModel.Resource(res),!1)})}if(data.$has("person")){var per=data.$get("person");_this.promises.push(per),per.then(function(per){return _this.setPerson(new BBModel.Person(per),!1)})}data.$has("event")&&data.$get("event").then(function(event){return _this.setEvent(new BBModel.Event(event))}),data.settings&&(_this.settings=$bbug.extend(!0,{},data.settings)),data.attachment_id&&(_this.attachment_id=data.attachment_id),data.person_group_id&&_this.setPersonGroupId(data.person_group_id),data.$has("product")&&data.$get("product").then(function(product){return _this.setProduct(new BBModel.Product(product))}),data.$has("package_item")&&data.$get("package_item").then(function(package_item){return _this.setPackageItem(new BBModel.PackageItem(package_item))}),data.$has("bulk_purchase")&&data.$get("bulk_purchase").then(function(bulk_purchase){return _this.setBulkPurchase(new BBModel.BulkPurchase(bulk_purchase))}),data.$has("deal")&&data.$get("deal").then(function(deal){return _this.setDeal(new BBModel.Deal(deal))}),data.$has("pre_paid_booking")&&data.$get("pre_paid_booking").then(function(pre_paid_booking){return _this.setPrepaidBooking(new BBModel.PrePaidBooking(pre_paid_booking))}),data.clinic_id&&(_this.clinic_id=data.clinic_id)}return _this}return _inherits(BasketItem,_BaseModel),BasketItem.prototype.setDefaults=function(defaults){if(defaults.settings&&(this.settings=defaults.settings),defaults.company&&this.setCompany(defaults.company),defaults.merge_resources&&this.setResource(null),defaults.merge_people&&this.setPerson(null),defaults.resource&&this.setResource(defaults.resource),defaults.person&&this.setPerson(defaults.person),defaults.service&&this.setService(defaults.service),defaults.category&&this.setCategory(defaults.category),defaults.date&&(defaults.date=moment(defaults.date)),defaults.time){var time=defaults.time?parseInt(defaults.time):0;defaults.datetime=DateTimeUtilitiesService.convertTimeToMoment(defaults.date,time)}return defaults.service_ref&&(this.service_ref=defaults.service_ref),defaults.group&&(this.group=defaults.group),defaults.clinic&&(this.clinic=defaults.clinic,this.clinic_id=defaults.clinic.id),defaults.private_note&&(this.private_note=defaults.private_note),defaults.event_group&&this.setEventGroup(defaults.event_group),defaults.event&&this.setEvent(defaults.event),this.defaults=defaults},BasketItem.prototype.storeDefaults=function(defaults){return this.defaults=defaults},BasketItem.prototype.canLoadItem=function(item){return!(!this.service||"service"===this.item)||(!(!this.resource||this.anyResource()||"resource"===item)||!(!this.person||this.anyPerson()||"person"===item))},BasketItem.prototype.defaultService=function(){return this.defaults&&this.defaults.service?this.defaults.service:this.defaults&&this.defaults.event_group?this.defaults.event_group:null},BasketItem.prototype.setSlot=function(slot){this.date=new BBModel.Day({date:slot.datetime.toISODate(),spaces:1});var t=60*slot.datetime.hour()+slot.datetime.minute();return this.time=new BBModel.TimeSlot({time:t,avail:1,price:this.price}),this.available_slot=slot.id},BasketItem.prototype.setCompany=function(company){if(this.company=company,this.parts_links.company=this.company.$href("self"),this.item_details)return this.item_details.currency_code=this.company.currency_code},BasketItem.prototype.clearExistingItem=function(){if(this.$has("self")&&this.event_id){var prom=this.$del("self");this.promises.push(prom),prom.then(function(){})}return delete this.earliest_time,delete this.event_id},BasketItem.prototype.setItem=function(item){if(item)return"person"===item.type?this.setPerson(item):"service"===item.type?this.setService(item):"resource"===item.type?this.setResource(item):void 0},BasketItem.prototype.setService=function(serv,default_questions){var _this2=this,prom=void 0;if(null==default_questions&&(default_questions=null),this.service){if(this.service.self&&serv.self&&this.service.self===serv.self)return this.service.$has("book")&&(this.book_link=this.service),serv.$has("days")&&(this.days_link=serv),void(serv.$has("book")&&(this.book_link=serv));this.item_details=null,this.clearExistingItem()}if(this.service&&serv&&this.service.self&&serv.self&&this.service.self!==serv.self&&serv.durations&&serv.durations.length>1&&(this.duration=null,this.listed_duration=null),this.service=serv,serv&&serv instanceof BookableItemModel&&(this.service=serv.item),this.parts_links.service=this.service.$href("self"),this.service.$has("book")&&(this.book_link=this.service),serv.$has("days")&&(this.days_link=serv),serv.$has("book")&&(this.book_link=serv),this.service.$has("questions")?(this.has_questions=!0,prom=this.service.$get("questions"),this.promises.push(prom),prom.then(function(details){if(_this2.company&&(details.currency_code=_this2.company.currency_code),_this2.item_details=new BBModel.ItemDetails(details),_this2.has_questions=_this2.item_details.hasQuestions,default_questions)return _this2.item_details.setAnswers(default_questions),_this2.setAskedQuestions()},function(err){return _this2.has_questions=!1})):this.has_questions=!1,this.service&&this.service.durations&&1===this.service.durations.length&&(this.setDuration(this.service.durations[0]),this.listed_duration=this.service.durations[0]),this.service&&this.service.listed_durations&&1===this.service.listed_durations.length&&(this.listed_duration=this.service.listed_durations[0]),this.service.$has("category")&&(prom=this.service.$getCategory()))return this.promises.push(prom)},BasketItem.prototype.setEventGroup=function(event_group){if(!(this.event_group&&this.event_group.self&&event_group.self&&this.event_group.self===event_group.self)&&(this.event_group=event_group,this.parts_links.event_group=this.event_group.$href("self").replace("event_group","service"),this.event_group.$has("category"))){var prom=this.event_group.$getCategory();if(prom)return this.promises.push(prom)}},BasketItem.prototype.setEventChain=function(event_chain,default_questions){var _this3=this;if(null==default_questions&&(default_questions=null),!(this.event_chain&&this.event_chain.self&&event_chain.self&&this.event_chain.self===event_chain.self)){if(this.event_chain=event_chain,this.base_price=parseFloat(event_chain.price),null!=this.price&&this.price!==this.base_price?this.setPrice(this.price):this.setPrice(this.base_price),this.event_chain.isSingleBooking()&&(this.tickets={name:$translate.instant("COMMON.TERMINOLOGY.ADMITTANCE"),max:1,type:"normal",price:this.base_price},this.tickets.pre_paid_booking_id=this.pre_paid_booking_id,this.num_book&&(this.tickets.qty=this.num_book)),this.event_chain.$has("questions")){this.has_questions=!0;var prom=this.event_chain.$get("questions");return this.promises.push(prom),prom.then(function(details){if(_this3.item_details=new BBModel.ItemDetails(details),_this3.has_questions=_this3.item_details.hasQuestions,_this3.questions){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(_this3.item_details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var q=_step.value,a=_.find(_this3.questions,function(c){return c.id===q.id});(a&&void 0===q.answer||a!==q.answer)&&(q.answer=a.answer)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}_this3.setAskedQuestions()}if(default_questions)return _this3.item_details.setAnswers(default_questions),_this3.setAskedQuestions()},function(err){return _this3.has_questions=!1})}return this.has_questions=!1}},BasketItem.prototype.setEvent=function(event,default_questions){var _this4=this;null==default_questions&&(default_questions=null),this.event&&this.event.unselect(),this.event=event,this.event.select(),this.event_chain_id=event.event_chain_id,this.setDate({date:event.date}),this.setTime(event.time),this.setDuration(event.duration),event.$has("book")&&(this.book_link=event),event.qty&&(this.num_book=event.qty);var prom=this.event.getChain();if(this.promises.push(prom),prom.then(function(chain){return _this4.setEventChain(chain,default_questions)}),prom=this.event.getGroup(),this.promises.push(prom),prom.then(function(group){return _this4.setEventGroup(group)}),this.event.getSpacesLeft()<=0&&!this.company.settings){if(this.company.getSettings().has_waitlists)return this.status=8}else if(this.event.getSpacesLeft()<=0&&this.company.settings&&this.company.settings.has_waitlists)return this.status=8},BasketItem.prototype.setCategory=function(cat){return this.category=cat},BasketItem.prototype.setPerson=function(per,set_selected){if(null==set_selected&&(set_selected=!0),set_selected&&this.earliest_time&&delete this.earliest_time,per){if(this.person=per,set_selected&&(this.settings.person=this.person.id),this.parts_links.person=this.person.$href("self"),per.$has("days")&&(this.days_link=per),per.$has("book")&&(this.book_link=per),this.event_id&&this.$has("person")&&this.$href("person")!==this.person.self&&(delete this.event_id,this.resource&&this.defaults&&this.defaults.merge_resources))return this.setResource(null)}else if(this.person=!0,set_selected&&(this.settings.person=-1),this.parts_links.person=null,this.service&&this.setService(this.service),this.resource&&!this.anyResource()&&this.setResource(this.resource,!1),this.event_id&&(delete this.event_id,this.resource&&this.defaults&&this.defaults.merge_resources))return this.setResource(null)},BasketItem.prototype.setPersonGroupId=function(id){return this.person_group_id=id},BasketItem.prototype.setResource=function(res,set_selected){if(null==set_selected&&(set_selected=!0),set_selected&&this.earliest_time&&delete this.earliest_time,res){if(this.resource=res,set_selected&&(this.settings.resource=this.resource.id),this.parts_links.resource=this.resource.$href("self"),res.$has("days")&&(this.days_link=res),res.$has("book")&&(this.book_link=res),this.event_id&&this.$has("resource")&&this.$href("resource")!==this.resource.self&&(delete this.event_id,this.person&&this.defaults&&this.defaults.merge_people))return this.setPerson(null)}else if(this.resource=!0,set_selected&&(this.settings.resource=-1),this.parts_links.resource=null,this.service&&this.setService(this.service),this.person&&!this.anyPerson()&&this.setPerson(this.person,!1),this.event_id&&(delete this.event_id,this.person&&this.defaults&&this.defaults.merge_people))return this.setPerson(null)},BasketItem.prototype.setDuration=function(dur){return this.duration=dur,this.service?this.base_price=this.service.getPriceByDuration(dur):this.time&&this.time.price?this.base_price=this.time.price:this.price&&(this.base_price=this.price),this.setPrice(this.base_price)},BasketItem.prototype.print_time=function(){if(this.time)return this.time.print_time()},BasketItem.prototype.print_end_time=function(){if(this.time)return this.time.print_end_time(this.duration)},BasketItem.prototype.print_time12=function(show_suffix){
if(null==show_suffix&&(show_suffix=!0),this.time)return this.time.print_time12(show_suffix)},BasketItem.prototype.print_end_time12=function(show_suffix){if(null==show_suffix&&(show_suffix=!0),this.time)return this.time.print_end_time12(show_suffix,this.duration)},BasketItem.prototype.setTime=function(time){return this.time&&this.time.unselect(),this.time=time,this.time&&(this.time.select(),this.datetime&&(this.datetime=DateTimeUtilitiesService.convertTimeToMoment(this.date.date,this.time.time)),this.price&&this.time.price&&this.price!==this.time.price?this.setPrice(this.time.price):this.price&&!this.time.price?this.setPrice(this.price):this.time.price&&!this.price?this.setPrice(this.time.price):this.price&&this.time.price?this.setPrice(this.price):this.setPrice(null)),this.checkReady()},BasketItem.prototype.setDate=function(date){return this.date=date,this.date&&(this.date.date=moment(this.date.date),this.datetime&&(this.datetime.date(this.date.date.date()),this.datetime.month(this.date.date.month()),this.datetime.year(this.date.date.year()))),this.checkReady()},BasketItem.prototype.clearDateTime=function(){return delete this.date,delete this.time,delete this.datetime,this.ready=!1,this.reserve_ready=!1},BasketItem.prototype.clearTime=function(){return delete this.time,this.ready=!1,this.reserve_ready=!1},BasketItem.prototype.setGroup=function(group){return this.group=group},BasketItem.prototype.setAskedQuestions=function(){return this.asked_questions=!0,this.checkReady()},BasketItem.prototype.checkReady=function(){return this.ready=!1,!this.checkReserveReady()||!this.asked_questions&&this.has_questions||(this.ready=!0),this.ready},BasketItem.prototype.checkReserveReady=function(){return this.reserve_ready=!1,(this.date&&this.time&&this.service||this.event||this.product||this.package_item||this.bulk_purchase||this.external_purchase||this.deal||this.is_coupon||this.date&&this.service&&"day"===this.service.duration_unit)&&(this.reserve_ready=!0),this.reserve_ready},BasketItem.prototype.getPostData=function(){if(this.cloneAnswersItem){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this.cloneAnswersItem.item_details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var o_question=_step2.value,_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(this.item_details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var m_question=_step3.value;m_question.id===o_question.id&&(m_question.answer=o_question.answer,this.setAskedQuestions())}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}var data={};return this.date&&(data.date=this.date.date.toISODate()),this.time?(data.time=this.time.time,this.time.event_id?data.event_id=this.time.event_id:this.time.event_ids&&(data.event_ids=this.time.event_ids)):this.date&&this.date.event_id&&(data.event_id=this.date.event_id),data.price=this.price,data.paid=this.paid,this.book_link&&(data.book=this.book_link.$href("book")),data.id=this.id,data.duration=this.duration,data.settings=this.settings,data.child_client_ids=this.child_client_ids,data.settings||(data.settings={}),this.earliest_time&&(data.settings.earliest_time=this.earliest_time),this.item_details&&this.asked_questions&&(data.questions=this.item_details.getPostData()),this.move_item_id&&(data.move_item_id=this.move_item_id),this.srcBooking&&(data.move_item_id=this.srcBooking.id),this.service&&(data.service_id=this.service.id),this.resource&&(data.resource_id=this.resource.id),this.person&&(data.person_id=this.person.id),this.person_group_id&&(data.person_group_id=this.person_group_id),data.length=this.length,this.event&&(data.event_id=this.event.id,null!=this.event.pre_paid_booking_id?data.pre_paid_booking_id=this.event.pre_paid_booking_id:this.tickets&&null!=this.tickets.pre_paid_booking_id&&(data.pre_paid_booking_id=this.tickets.pre_paid_booking_id),data.tickets=this.tickets),null!=this.pre_paid_booking_id&&(data.pre_paid_booking_id=this.pre_paid_booking_id),data.event_chain_id=this.event_chain_id,data.event_group_id=this.event_group_id,data.qty=this.qty,this.status&&(data.status=this.status),null!=this.num_resources&&(data.num_resources=parseInt(this.num_resources)),this.package_item&&(data.package_id=this.package_item.id),this.bulk_purchase&&(data.bulk_purchase_id=this.bulk_purchase.id),data.external_purchase=this.external_purchase,this.deal&&(data.deal=this.deal),this.deal&&this.recipient&&(data.recipient=this.recipient),this.deal&&this.recipient&&this.recipient_mail&&(data.recipient_mail=this.recipient_mail),data.coupon_id=this.coupon_id,data.is_coupon=this.is_coupon,this.attachment_id&&(data.attachment_id=this.attachment_id),this.deal_codes&&(data.vouchers=this.deal_codes),this.product&&(data.product_id=this.product.id),data.ref=this.ref,this.move_reason&&(data.move_reason=this.move_reason),this.email&&(data.email=this.email),this.first_name&&(data.first_name=this.first_name),this.last_name&&(data.last_name=this.last_name),null!=this.email&&(data.email=this.email),null!=this.email_admin&&(data.email_admin=this.email_admin),this.private_note&&(data.private_note=this.private_note),this.available_slot&&(data.available_slot=this.available_slot),this.clinic_id&&(data.clinic_id=this.clinic_id),data},BasketItem.prototype.setPrice=function(nprice){var printed_price=void 0;return null==nprice?(this.price=null,this.printed_price=null,this.printed_vat_cal=null,this.printed_vat=null,this.printed_vat_inc=null):(this.price=parseFloat(nprice),printed_price=this.price/100,this.printed_price=printed_price%1==0?"£"+parseInt(printed_price):$window.sprintf("£%.2f",printed_price),this.company&&this.company.settings&&(this.printed_vat_cal=this.company.settings.payment_tax),this.printed_vat_cal&&(this.printed_vat=this.printed_vat_cal/100*printed_price),this.printed_vat_cal?this.printed_vat_inc=this.printed_vat_cal/100*printed_price+printed_price:void 0)},BasketItem.prototype.getStep=function(){var temp={};return temp.service=this.service,temp.category=this.category,temp.person=this.person,temp.resource=this.resource,temp.duration=this.duration,temp.event=this.event,temp.event_group=this.event_group,temp.event_chain=this.event_chain,temp.time=this.time,temp.date=this.date,temp.days_link=this.days_link,temp.book_link=this.book_link,temp.ready=this.ready,temp.num_book=this.num_book,temp.tickets=this.tickets,temp},BasketItem.prototype.loadStep=function(step){return this.service=step.service,this.category=step.category,this.person=step.person,this.resource=step.resource,this.duration=step.duration,this.event=step.event,this.event_chain=step.event_chain,this.event_group=step.event_group,this.time=step.time,this.date=step.date,this.days_link=step.days_link,this.book_link=step.book_link,this.ready=step.ready,this.num_book=step.num_book,this.tickets=step.tickets},BasketItem.prototype.describe=function(){var title="-";return this.service&&(title=this.service.name),this.event_group&&this.event&&"-"===title&&(title=this.event_group.name+" - "+this.event.description),this.product&&(title=this.product.name),this.external_purchase&&(title=this.external_purchase.name),this.deal&&(title=this.deal.name),this.package_item&&(title=this.package_item.name),this.bulk_purchase&&(title=this.bulk_purchase.name),title},BasketItem.prototype.booking_date=function(format){return this.date&&this.date.date?this.date.date.format(format):null},BasketItem.prototype.booking_time=function(seperator){if(null==seperator&&(seperator="-"),!this.time)return null;var duration=this.listed_duration?this.listed_duration:this.duration;return this.time.print_time()+" "+seperator+" "+this.time.print_end_time(duration)},BasketItem.prototype.duePrice=function(){return this.isWaitlist()?0:this.price},BasketItem.prototype.isWaitlist=function(){return this.status&&8===this.status},BasketItem.prototype.start_datetime=function(){return this.date&&this.time?DateTimeUtilitiesService.convertTimeToMoment(this.date.date,this.time.time):null},BasketItem.prototype.startDatetime=function(){return this.start_datetime()},BasketItem.prototype.end_datetime=function(){if(!this.date||!this.time||!this.listed_duration&&!this.duration)return null;var duration=this.listed_duration?this.listed_duration:this.duration,time=this.time.time+duration;return DateTimeUtilitiesService.convertTimeToMoment(this.date.date,time)},BasketItem.prototype.endDatetime=function(){return this.end_datetime()},BasketItem.prototype.setSrcBooking=function(booking){return this.srcBooking=booking,this.duration=booking.duration},BasketItem.prototype.anyPerson=function(){return this.person&&"boolean"==typeof this.person},BasketItem.prototype.anyResource=function(){return this.resource&&"boolean"==typeof this.resource},BasketItem.prototype.isMovingBooking=function(){return this.srcBooking||this.move_item_id},BasketItem.prototype.setCloneAnswers=function(otherItem){return this.cloneAnswersItem=otherItem},BasketItem.prototype.questionPrice=function(){return this.item_details?this.item_details.questionPrice(this.getQty()):0},BasketItem.prototype.getQty=function(){return this.qty?this.qty:this.tickets?this.tickets.qty:1},BasketItem.prototype.totalPrice=function(){if(this.tickets&&this.tickets.pre_paid_booking_id)return 0;if(this.pre_paid_booking_id)return 0;if(null!=this.discount_price)return this.discount_price+this.questionPrice();var pr=this.total_price;return angular.isNumber(pr)||(pr=this.price),angular.isNumber(pr)||(pr=0),pr+this.questionPrice()},BasketItem.prototype.fullPrice=function(){var pr=this.base_price;return pr||(pr=this.total_price),pr||(pr=this.price),pr||(pr=0),pr+this.questionPrice()},BasketItem.prototype.setProduct=function(product){if(this.product=product,this.product.$has("book")&&(this.book_link=this.product),product.price)return this.setPrice(product.price)},BasketItem.prototype.setPackageItem=function(package_item){if(this.package_item=package_item,this.package_item.$has("book")&&(this.book_link=this.package_item),package_item.price)return this.setPrice(package_item.price)},BasketItem.prototype.setBulkPurchase=function(bulk_purchase){if(this.bulk_purchase=bulk_purchase,this.bulk_purchase.$has("book")&&(this.book_link=this.bulk_purchase),bulk_purchase.price)return this.setPrice(bulk_purchase.price)},BasketItem.prototype.setExternalPurchase=function(external_purchase){if(this.external_purchase=external_purchase,this.book_link=this.company,external_purchase.price)return this.setPrice(external_purchase.price)},BasketItem.prototype.setDeal=function(deal){if(this.deal=deal,this.deal.$has("book")&&(this.book_link=this.deal),deal.price)return this.setPrice(deal.price)},BasketItem.prototype.hasPrice=function(){return null!=this.price},BasketItem.prototype.getAttachment=function(){var _this5=this;return this.attachment?this.attachment:this.$has("attachment")&&this.attachment_id?this._data.$get("attachment").then(function(att){return _this5.attachment=att,_this5.attachment}):void 0},BasketItem.prototype.deleteAttachment=function(){if(this.attachment_id)return this._data.$del("del_attachment",{}),this.attachment_id=null},BasketItem.prototype.setPrepaidBooking=function(pre_paid_booking){return this.pre_paid_booking=pre_paid_booking,this.pre_paid_booking_id=pre_paid_booking.id},BasketItem.prototype.hasPrepaidBooking=function(){return null!=this.pre_paid_booking_id},BasketItem.prototype.getEventId=function(){return this.time&&this.time.event_id?this.time.event_id:this.date&&this.date.event_id?this.date.event_id:this.event?this.event.id:void 0},BasketItem.prototype.isExternalPurchase=function(){return null!=this.external_purchase},BasketItem.prototype.getName=function(){return this.session_name?this.session_name:this.service_name},BasketItem.prototype.getAttendeeName=function(client){return this.first_name?this.first_name+" "+this.last_name:client?client.getName():void 0},BasketItem.prototype.isTimeItem=function(){return this.service||this.event},BasketItem}(BaseModel)}),angular.module("BB.Models").factory("BookableItemModel",function($q,BBModel,BaseModel,ItemService){return __initClass__(function(_BaseModel){function BookableItem(data){_classCallCheck(this,BookableItem);var _this=_possibleConstructorReturn(this,_BaseModel.apply(this,arguments));return _this.name="-Waiting-",_this.ready=$q.defer(),_this.promise=_this._data.$get("item"),_this.promise.then(function(val){var m=void 0,n=void 0;if("person"===val.type){if(_this.item=new BBModel.Person(val),_this.item){for(n in _this.item._data)m=_this.item._data[n],_this.item._data.hasOwnProperty(n)&&"function"!=typeof m&&(_this[n]=m);return _this.ready.resolve()}return _this.ready.resolve()}if("resource"===val.type){if(_this.item=new BBModel.Resource(val),_this.item){for(n in _this.item._data)m=_this.item._data[n],_this.item._data.hasOwnProperty(n)&&"function"!=typeof m&&(_this[n]=m);return _this.ready.resolve()}return _this.ready.resolve()}if("service"===val.type){if(_this.item=new BBModel.Service(val),_this.item){for(n in _this.item._data)m=_this.item._data[n],_this.item._data.hasOwnProperty(n)&&"function"!=typeof m&&(_this[n]=m);return _this.ready.resolve()}return _this.ready.resolve()}}),_this}return _inherits(BookableItem,_BaseModel),BookableItem.initClass=function(){this.prototype.item=null,this.prototype.promise=null},BookableItem.$query=function(params){return ItemService.query(params)},BookableItem}(BaseModel))}),angular.module("BB.Models").factory("BulkPurchaseModel",function($q,BBModel,BaseModel,BulkPurchaseService){return function(_BaseModel){function BulkPurchase(){return _classCallCheck(this,BulkPurchase),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(BulkPurchase,_BaseModel),BulkPurchase.$query=function(company){return BulkPurchaseService.query(company)},BulkPurchase}(BaseModel)}),angular.module("BB.Models").factory("BusinessQuestionModel",function($q,$filter,BBModel,BaseModel){return function(_BaseModel){function BusinessQuestion(data){return _classCallCheck(this,BusinessQuestion),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(BusinessQuestion,_BaseModel),BusinessQuestion}(BaseModel)}),angular.module("BB.Models").factory("CategoryModel",function($q,BBModel,BaseModel,CategoryService){return function(_BaseModel){function Category(){return _classCallCheck(this,Category),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(Category,_BaseModel),Category.$query=function(company){return CategoryService.query(company)},Category}(BaseModel)}),angular.module("BB.Models").factory("ClientModel",function($q,BBModel,BaseModel,ClientService){return function(_BaseModel){function Client(data){_classCallCheck(this,Client);var _this=_possibleConstructorReturn(this,_BaseModel.apply(this,arguments));return _this.name=_this.getName(),data&&data.answers&&data.$has("questions")&&(_this.waitingQuestions=$q.defer(),_this.gotQuestions=_this.waitingQuestions.promise,data.$get("questions").then(function(details){return _this.client_details=new BBModel.ClientDetails(details),_this.client_details.setAnswers(data.answers),_this.questions=_this.client_details.questions,_this.setAskedQuestions(),_this.waitingQuestions.resolve()})),_this}return _inherits(Client,_BaseModel),Client.prototype.setClientDetails=function(details){return this.client_details=details,this.questions=this.client_details.questions},Client.prototype.setTimeZone=function(time_zone){null!=time_zone&&(this.time_zone=time_zone)},Client.prototype.setDefaults=function(values){if(values.name&&(this.name=values.name),values.first_name&&(this.first_name=values.first_name),values.last_name&&(this.last_name=values.last_name),values.phone&&(this.phone=values.phone),values.mobile&&(this.mobile=values.mobile),values.email&&(this.email=values.email),values.id&&(this.id=values.id),values.ref&&(this.comp_ref=values.ref),values.comp_ref&&(this.comp_ref=values.comp_ref),values.address1&&(this.address1=values.address1),values.address2&&(this.address2=values.address2),values.address3&&(this.address3=values.address3),values.address4&&(this.address4=values.address4),values.address5&&(this.address5=values.address5),values.postcode&&(this.postcode=values.postcode),values.country&&(this.country=values.country),values.answers&&(this.default_answers=values.answers),values.time_zone)return this.time_zone=values.time_zone},Client.prototype.pre_fill_answers=function(details){var _this2=this;if(this.default_answers)return function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var q=_step.value,item=void 0;_this2.default_answers[q.name]&&(item=q.answer=_this2.default_answers[q.name]),result.push(item)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}()},Client.prototype.getName=function(){var str="";return this.first_name&&(str+=this.first_name),str.length>0&&this.last_name&&(str+=" "),this.last_name&&(str+=this.last_name),str},Client.prototype.addressSingleLine=function(){var str="";return this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+=", "),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+=", "),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+=", "),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+=", "),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+=", "),this.postcode&&(str+=this.postcode),str},Client.prototype.hasAddress=function(){return this.address1||this.address2||this.postcode},Client.prototype.addressCsvLine=function(){var str="";return this.address1&&(str+=this.address1),str+=", ",this.address2&&(str+=this.address2),str+=", ",this.address3&&(str+=this.address3),str+=", ",this.address4&&(str+=this.address4),str+=", ",this.address5&&(str+=this.address5),str+=", ",this.postcode&&(str+=this.postcode),str+=", ",this.country&&(str+=this.country),str},Client.prototype.addressMultiLine=function(){var str="";return this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+="<br/>"),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+="<br/>"),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+="<br/>"),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+="<br/>"),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+="<br/>"),this.postcode&&(str+=this.postcode),str},Client.prototype.getPostData=function(){var x={};if(x.first_name=this.first_name,x.last_name=this.last_name,this.house_number?x.address1=this.house_number+" "+this.address1:x.address1=this.address1,x.address2=this.address2,x.address3=this.address3,x.address4=this.address4,x.address5=this.address5,x.postcode=this.postcode,x.country=this.country,x.email=this.email,x.id=this.id,x.comp_ref=this.comp_ref,x.parent_client_id=this.parent_client_id,x.password=this.password,x.notifications=this.notifications,this.member_level_id&&(x.member_level_id=this.member_level_id),this.send_welcome_email&&(x.send_welcome_email=this.send_welcome_email),this.default_company_id&&(x.default_company_id=this.default_company_id),this.time_zone&&(x.time_zone=this.time_zone),this.phone&&(x.phone=this.phone,this.phone_prefix&&(x.phone_prefix=this.phone_prefix)),this.mobile&&(this.remove_prefix(),x.mobile=this.mobile,x.mobile_prefix=this.mobile_prefix),this.questions){x.questions=[];var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this.questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var q=_step2.value;x.questions.push(q.getPostData())}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}return x},Client.prototype.valid=function(){return this.isValid?this.isValid:!(!this.email&&!this.hasServerId())},Client.prototype.setValid=function(val){return this.isValid=val},Client.prototype.hasServerId=function(){return this.id},Client.prototype.setAskedQuestions=function(){return this.asked_questions=!0},Client.prototype.fullMobile=function(){if(this.mobile)return this.mobile_prefix?"+"+this.mobile_prefix+("0"===this.mobile.substr(0,1)?this.mobile.substr(1):this.mobile):this.mobile},Client.prototype.remove_prefix=function(){var pref_arr=this.mobile.match(/^(\+|00)(999|998|997|996|995|994|993|992|991|990|979|978|977|976|975|974|973|972|971|970|969|968|967|966|965|964|963|962|961|960|899|898|897|896|895|894|893|892|891|890|889|888|887|886|885|884|883|882|881|880|879|878|877|876|875|874|873|872|871|870|859|858|857|856|855|854|853|852|851|850|839|838|837|836|835|834|833|832|831|830|809|808|807|806|805|804|803|802|801|800|699|698|697|696|695|694|693|692|691|690|689|688|687|686|685|684|683|682|681|680|679|678|677|676|675|674|673|672|671|670|599|598|597|596|595|594|593|592|591|590|509|508|507|506|505|504|503|502|501|500|429|428|427|426|425|424|423|422|421|420|389|388|387|386|385|384|383|382|381|380|379|378|377|376|375|374|373|372|371|370|359|358|357|356|355|354|353|352|351|350|299|298|297|296|295|294|293|292|291|290|289|288|287|286|285|284|283|282|281|280|269|268|267|266|265|264|263|262|261|260|259|258|257|256|255|254|253|252|251|250|249|248|247|246|245|244|243|242|241|240|239|238|237|236|235|234|233|232|231|230|229|228|227|226|225|224|223|222|221|220|219|218|217|216|215|214|213|212|211|210|98|95|94|93|92|91|90|86|84|82|81|66|65|64|63|62|61|60|58|57|56|55|54|53|52|51|49|48|47|46|45|44|43|41|40|39|36|34|33|32|31|30|27|20|7|1)/);if(pref_arr)return this.mobile.replace(pref_arr[0],""),this.mobile_prefix=pref_arr[0]},Client.prototype.$getPrePaidBookings=function(params){var defer=$q.defer();return this.$has("pre_paid_bookings")?this.$get("pre_paid_bookings",params).then(function(collection){return collection.$get("pre_paid_bookings").then(function(prepaids){return defer.resolve(Array.from(prepaids).map(function(prepaid){return new BBModel.PrePaidBooking(prepaid)}))},function(err){return defer.reject(err)})},function(err){return defer.resolve([])}):defer.resolve([]),defer.promise},Client.$create_or_update=function(company,client){return ClientService.create_or_update(company,client)},Client.$query_by_email=function(company,email){return ClientService.query_by_email(company,email)},Client}(BaseModel)}),angular.module("BB.Models").factory("ClientDetailsModel",function($q,BBModel,BaseModel,ClientDetailsService){return function(_BaseModel){function ClientDetails(data){_classCallCheck(this,ClientDetails);var _this=_possibleConstructorReturn(this,_BaseModel.apply(this,arguments));if(_this.questions=[],_this._data){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(data.questions)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var q=_step.value;_this.questions.push(new BBModel.Question(q))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return _this.hasQuestions=_this.questions.length>0,_this}return _inherits(ClientDetails,_BaseModel),ClientDetails.prototype.getPostData=function(questions){var data=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var q=_step2.value;data.push({answer:q.answer,id:q.id,price:q.price})}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return data},ClientDetails.prototype.setAnswers=function(answers){var _this2=this,ahash={},_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(answers)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var a=_step3.value;ahash[a.question_id]=a}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return function(){var result=[],_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(_this2.questions)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var q=_step4.value,item=void 0;ahash[q.id]&&(item=q.answer=ahash[q.id].answer),result.push(item)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return result}()},ClientDetails.$query=function(company){return ClientDetailsService.query(company)},ClientDetails}(BaseModel)}),angular.module("BB.Models").factory("ClinicModel",function($q,BBModel,BaseModel){return function(_BaseModel){function Clinic(data){_classCallCheck(this,Clinic);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.setTimes(),_this.setResourcesAndPeople(),_this.settings||(_this.settings={}),_this}return _inherits(Clinic,_BaseModel),Clinic.prototype.setResourcesAndPeople=function(){return this.resources=_.reduce(this.resource_ids,function(h,id){return h[id]=!0,h},{}),this.people=_.reduce(this.person_ids,function(h,id){return h[id]=!0,h},{}),this.services=_.reduce(this.service_ids,function(h,id){return h[id]=!0,h},{}),this.uncovered=!this.person_ids||0===this.person_ids.length,this.uncovered?this.className="clinic_uncovered":this.className="clinic_covered"},Clinic.prototype.setTimes=function(){return this.start_time&&(this.start_time=moment(this.start_time),this.start=this.start_time),this.end_time&&(this.end_time=moment(this.end_time),this.end=this.end_time),this.title=this.name},Clinic}(BaseModel)}),angular.module("BB.Models").factory("BBCollectionModel",function($q,BBModel,BaseModel){return function(_BaseModel){function BBCollection(){return _classCallCheck(this,BBCollection),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(BBCollection,_BaseModel),BBCollection.prototype.getNextPage=function(params){var deferred=$q.defer();return this.$get("next",params).then(function(collection){return deferred.resolve(new BBModel.BBCollection(collection))},function(){return deferred.reject()}),deferred.promise},BBCollection}(BaseModel)}),angular.module("BB.Models").factory("CompanyModel",function($q,BBModel,BaseModel,halClient,AppConfig,$sessionStorage,CompanyService){return function(_BaseModel){function Company(data){_classCallCheck(this,Company);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));if(_this.companies){var all_companies=[];_this.child_companies=[];var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(_this.companies)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var comp=_step.value,c=new BBModel.Company(halClient.$parse(comp));if(_this.child_companies.push(c),c.companies){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(c.companies)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var child=_step2.value;all_companies.push(child)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}else all_companies.push(c)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}_this.companies=all_companies}return _this}return _inherits(Company,_BaseModel),Company.prototype.getCompanyByRef=function(ref){var defer=$q.defer();return this.$get("companies").then(function(companies){var company=_.find(companies,function(c){return c.reference===ref});return company?defer.resolve(company):defer.reject("No company for ref "+ref)},function(err){return console.log("err ",err),defer.reject(err)}),defer.promise},Company.prototype.findChildCompany=function(id){if(!this.companies)return null;var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(this.companies)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var c=_step3.value;if(c.id===parseInt(id))return c;if(c.ref&&c.ref===String(id))return c}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}if("string"==typeof id){var name=id.replace(/[\s\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,"").toLowerCase(),_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(this.companies)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){c=_step4.value;if(name===c.name.replace(/[\s\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,"").toLowerCase())return c}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}return null},Company.prototype.getSettings=function(){var _this2=this,def=$q.defer();return this.settings?def.resolve(this.settings):this.$has("settings")?this.$get("settings").then(function(set){return _this2.settings=new BBModel.CompanySettings(set),def.resolve(_this2.settings)}):def.reject("Company has no settings"),def.promise},Company.prototype.pusherSubscribe=function(callback,options){if(null==options&&(options={}),"undefined"!=typeof Pusher&&null!==Pusher&&null==this.pusher){if(!this.$has("pusher"))return;this.pusher=new Pusher("c8d8cea659cc46060608",{encrypted:!options.hasOwnProperty("encrypted")||options.encrypted,authEndpoint:this.$link("pusher").href,auth:{headers:{"App-Id":AppConfig.appId,"App-Key":AppConfig.appKey,"Auth-Token":$sessionStorage.getItem("auth_token")}}})}var channelName="private-c"+this.id+"-w"+this.numeric_widget_id;return null!=this.pusher.channel(channelName)&&this.pusher.unsubscribe(channelName),this.pusher_channel=this.pusher.subscribe(channelName),this.pusher_channel.bind("booking",callback),this.pusher_channel.bind("cancellation",callback),this.pusher_channel.bind("updating",callback)},Company.prototype.getPusherChannel=function(model,options){if(null==options&&(options={}),!this.pusher){if(!this.$has("pusher"))return;this.pusher=new Pusher("c8d8cea659cc46060608",{
encrypted:!options.hasOwnProperty("encrypted")||options.encrypted,authEndpoint:this.$link("pusher").href,auth:{headers:{"App-Id":AppConfig.appId,"App-Key":AppConfig.appKey,"Auth-Token":$sessionStorage.getItem("auth_token")}}})}if(this.$has(model)){var channelName=this.$href(model);return channelName=channelName.replace(/https?:\/\//,"").replace(/\//g,"-").replace(/:/g,"_"),this.pusher.channel(channelName)?this.pusher.channel(channelName):(this.pusher.subscribe(channelName),this.pusher.channel(channelName))}},Company.$query=function(company_id,options){return CompanyService.query(company_id,options)},Company}(BaseModel)}),angular.module("BB.Models").factory("CompanySettingsModel",function($q,BBModel,BaseModel){return function(_BaseModel){function CompanySettings(){return _classCallCheck(this,CompanySettings),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(CompanySettings,_BaseModel),CompanySettings}(BaseModel)}),angular.module("BB.Models").factory("DayModel",function($q,BBModel,BaseModel,DayService){return function(_BaseModel){function Day(data){_classCallCheck(this,Day);var _this=_possibleConstructorReturn(this,_BaseModel.apply(this,arguments));return _this.string_date=_this.date,_this.date=moment(_this.date),_this}return _inherits(Day,_BaseModel),Day.prototype.day=function(){return this.date.date()},Day.prototype.off=function(month){return this.date.month()!==month},Day.prototype.class=function(month){var str="";return this.date.month()<month&&(str+="off off-prev"),this.date.month()>month&&(str+="off off-next"),0===this.spaces&&(str+=" not-avail"),str},Day.$query=function(prms){return DayService.query(prms)},Day}(BaseModel)}),angular.module("BB.Models").factory("DealModel",function($q,BBModel,BaseModel,DealService){return function(_BaseModel){function Deal(){return _classCallCheck(this,Deal),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(Deal,_BaseModel),Deal.$query=function(company){return DealService.query(company)},Deal}(BaseModel)}),angular.module("BB.Models").factory("EventModel",function($q,BBModel,BaseModel,DateTimeUtilitiesService,EventService,$translate){return function(_BaseModel){function Event(data){_classCallCheck(this,Event);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.date=moment.parseZone(_this.datetime),_this.time=new BBModel.TimeSlot({time:DateTimeUtilitiesService.convertMomentToTime(_this.date)}),_this.duration&&(_this.end_datetime=_this.date.clone().add(_this.duration,"minutes")),_this.date_unix=_this.date.unix(),_this}return _inherits(Event,_BaseModel),Event.prototype.getGroup=function(){var _this2=this,defer=$q.defer();if(this.group)defer.resolve(this.group);else if(this.$has("event_groups")||this.$has("event_group")){var event_group="event_group";this.$has("event_groups")&&(event_group="event_groups"),this.$get(event_group).then(function(group){return _this2.group=new BBModel.EventGroup(group),defer.resolve(_this2.group)},function(err){return defer.reject(err)})}else defer.reject("No event group");return defer.promise},Event.prototype.getChain=function(params){var _this3=this,defer=$q.defer();if(this.chain)defer.resolve(this.chain);else if(this.$has("event_chains")||this.$has("event_chain")){var event_chain="event_chain";this.$has("event_chains")&&(event_chain="event_chains"),this.$get(event_chain,params).then(function(chain){return _this3.chain=new BBModel.EventChain(chain),defer.resolve(_this3.chain)})}else defer.reject("No event chain");return defer.promise},Event.prototype.getDuration=function(){var _this4=this,defer=new $q.defer;return this.duration?defer.resolve(this.duration):this.getChain().then(function(chain){return _this4.duration=chain.duration,defer.resolve(_this4.duration)}),defer.promise},Event.prototype.getDescription=function(){return this.getChain().description},Event.prototype.getColour=function(){return this.getGroup()?this.getGroup().colour:"#FFFFFF"},Event.prototype.getPounds=function(){if(this.chain)return Math.floor(this.getPrice()).toFixed(0)},Event.prototype.getPrice=function(){return 0},Event.prototype.getPence=function(){if(this.chain)return(this.getPrice()%1).toFixed(2).slice(-2)},Event.prototype.getNumBooked=function(){return this.spaces_blocked+this.spaces_booked+this.spaces_reserved+this.spaces_held},Event.prototype.getSpacesLeft=function(pool){if(null==pool&&(pool=null),pool&&this.ticket_spaces&&this.ticket_spaces[pool])return this.ticket_spaces[pool].left;var x=this.num_spaces-this.getNumBooked();return x<0?0:x},Event.prototype.getWaitSpacesLeft=function(){var wait=this.chain.waitlength;return wait||(wait=0),wait-=this.spaces_wait,wait<=0?0:wait},Event.prototype.hasSpace=function(){return this.getSpacesLeft()>0},Event.prototype.hasWaitlistSpace=function(){return this.getSpacesLeft()<=0&&this.getChain().waitlength>this.spaces_wait},Event.prototype.getRemainingDescription=function(){var left=this.getSpacesLeft();return left>0&&left<3?$translate.instant("CORE.EVENT.SPACES_LEFT",{N:left},"messageformat"):this.hasWaitlistSpace()?$translate.instant("CORE.EVENT.JOIN_WAITLIST"):""},Event.prototype.select=function(){return this.selected=!0},Event.prototype.unselect=function(){if(this.selected)return delete this.selected},Event.prototype.prepEvent=function(params){var _this5=this,def=$q.defer();return this.getChain(params).then(function(){return _this5.chain.$has("address")&&_this5.chain.$getAddress().then(function(address){return _this5.chain.address=address}),_this5.chain.getTickets().then(function(tickets){if(_this5.tickets=tickets,_this5.price_range={},tickets&&tickets.length>0){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(_this5.tickets)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var ticket=_step.value;(!_this5.price_range.from||_this5.price_range.from&&ticket.price<_this5.price_range.from)&&(_this5.price_range.from=ticket.price),(!_this5.price_range.to||_this5.price_range.to&&ticket.price>_this5.price_range.to)&&(_this5.price_range.to=ticket.price),ticket.old_price=ticket.price}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}else _this5.price_range.from=_this5.price,_this5.price_range.to=_this5.price;return _this5.ticket_prices=_.indexBy(tickets,"name"),def.resolve(_this5)})}),def.promise},Event.prototype.updatePrice=function(){return Array.from(this.tickets).map(function(ticket){return ticket.pre_paid_booking_id?ticket.price=0:ticket.price=ticket.old_price})},Event.$query=function(company,params){return EventService.query(company,params)},Event.$summary=function(company,params){return EventService.summary(company,params)},Event.prototype.numTicketsSelected=function(){var num=0,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this.tickets)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){num+=_step2.value.qty}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return num},Event}(BaseModel)}),angular.module("BB.Models").factory("EventChainModel",function($q,BBModel,BaseModel,EventChainService,$translate){return function(_BaseModel){function EventChain(data){_classCallCheck(this,EventChain);var _this=_possibleConstructorReturn(this,_BaseModel.apply(this,arguments));return _this.capacity_view=_this.setCapacityView(_this.capacity_view),_this.start_date&&(_this.start_date=moment(_this.start_date)),_this.end_date&&(_this.end_date=moment(_this.end_date)),_this}return _inherits(EventChain,_BaseModel),EventChain.prototype.setCapacityView=function(capacity_view){var capacity_view_str=void 0;switch(capacity_view){case 0:capacity_view_str="DO_NOT_DISPLAY";break;case 1:capacity_view_str="NUM_SPACES";break;case 2:capacity_view_str="NUM_SPACES_LEFT";break;case 3:capacity_view_str="NUM_SPACES_AND_SPACES_LEFT";break;default:capacity_view_str="NUM_SPACES_AND_SPACES_LEFT"}return capacity_view_str},EventChain.prototype.name=function(){return this._data.name},EventChain.prototype.isSingleBooking=function(){return 1===this.max_num_bookings&&!this.$has("ticket_sets")},EventChain.prototype.hasTickets=function(){return this.$has("ticket_sets")},EventChain.prototype.getTickets=function(){var _this2=this,def=$q.defer();return this.tickets?def.resolve(this.tickets):this.$has("ticket_sets")?this.$get("ticket_sets").then(function(tickets){_this2.tickets=[];var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(tickets)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var ticket=_step.value;ticket.ticket_set=!0,_this2.tickets.push(new BBModel.EventTicket(ticket))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return _this2.adjustTicketsForRemaining(),def.resolve(_this2.tickets)}):(this.tickets=[new BBModel.EventTicket({name:$translate.instant("COMMON.TERMINOLOGY.ADMITTANCE"),min_num_bookings:1,max_num_bookings:this.max_num_bookings,type:"normal",price:this.price})],this.adjustTicketsForRemaining(),def.resolve(this.tickets)),def.promise},EventChain.prototype.adjustTicketsForRemaining=function(){var _this3=this;if(this.tickets)return function(){var result=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(_this3.tickets)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)_this3.ticket=_step2.value,result.push(_this3.ticket.max_spaces=_this3.spaces)}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result}()},EventChain.$query=function(prms){return EventChainService.query(prms)},EventChain}(BaseModel)}),angular.module("BB.Models").factory("EventGroupModel",function($q,BBModel,BaseModel){return function(_BaseModel){function EventGroup(){return _classCallCheck(this,EventGroup),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(EventGroup,_BaseModel),EventGroup.prototype.name=function(){return this._data.name},EventGroup.prototype.colour=function(){return this._data.colour},EventGroup}(BaseModel)}),angular.module("BB.Models").factory("EventSequenceModel",function($q,BBModel,BaseModel){return function(_BaseModel){function EventSequence(){return _classCallCheck(this,EventSequence),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(EventSequence,_BaseModel),EventSequence.prototype.name=function(){return this._data.name},EventSequence}(BaseModel)}),angular.module("BB.Models").factory("EventTicketModel",function($q,BBModel,BaseModel){return function(_BaseModel){function EventTicket(data){_classCallCheck(this,EventTicket);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));if(_this.max=_this.max_num_bookings,_this.max_spaces){var ms=_this.max_spaces;_this.counts_as&&(ms=_this.max_spaces/_this.counts_as),ms<max&&(_this.max=ms)}return _this}return _inherits(EventTicket,_BaseModel),EventTicket.prototype.fullName=function(){return this.pool_name?this.pool_name+" - "+this.name:this.name},EventTicket.prototype.getRange=function(event,cap){if(event){var pool=null;this.ticket_set&&(pool=this.pool_id);var max=this.getMax(event,pool,cap),min=max<=this.min_num_bookings?max:this.min_num_bookings;return[].concat(__range__(min,max,!0))}},EventTicket.prototype.getMax=function(ev,pool,cap){var spaces_left=void 0,wait_spaces=void 0;null==pool&&(pool=null),null==cap&&(cap=null);if(!ev)return 0;!function(event){return _.each(event.ticket_spaces,function(ts){if(ts.left<=0)return!1}),!0}(ev)||ev.getSpacesLeft()<=0?(spaces_left=ev.getWaitSpacesLeft(),wait_spaces=!0):spaces_left=ev.getSpacesLeft(pool);var live_max=spaces_left<=this.max?spaces_left:this.max,used=0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(ev.tickets)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var ticket=_step.value;(ticket.pool_id===this.pool_id||wait_spaces)&&(used+=ticket.totalQty())}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}this.qty&&(used-=this.totalQty()),this.counts_as&&(used=Math.ceil(used/this.counts_as)),(live_max-=used)<0&&(live_max=0);var left=left-used;if(left<0&&(left=0),this.cap&&(cap=this.cap),(!cap||cap>left)&&(cap=left),cap){var c=cap;if(this.counts_as&&(c=cap/this.counts_as),c<live_max)return c}return live_max},EventTicket.prototype.totalQty=function(){return this.qty?this.counts_as?this.qty*this.counts_as:this.qty:0},EventTicket.prototype.add=function(value){if(this.qty||(this.qty=0),this.qty=parseInt(this.qty),!(angular.isNumber(this.qty)&&this.qty>=this.max&&value>0||0===this.qty&&value<0))return this.qty+=value},EventTicket.prototype.subtract=function(value){return this.add(-value)},EventTicket}(BaseModel)}),angular.module("BB.Models").factory("ExternalPurchaseModel",function($q,BBModel,BaseModel){return function(_BaseModel){function ExternalPurchase(){return _classCallCheck(this,ExternalPurchase),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(ExternalPurchase,_BaseModel),ExternalPurchase}(BaseModel)}),angular.module("BB.Models").factory("ImageModel",function($q,$filter,BBModel,BaseModel){return function(_BaseModel){function Image(data){return _classCallCheck(this,Image),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(Image,_BaseModel),Image}(BaseModel)}),angular.module("BB.Models").factory("ItemModel",function($q,$filter,BBModel,BaseModel){return function(_BaseModel){function Item(data){return _classCallCheck(this,Item),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(Item,_BaseModel),Item}(BaseModel)}),angular.module("BB.Models").factory("ItemDetailsModel",function($q,$bbug,ItemDetailsService,BBModel,BaseModel){return function(_BaseModel){function ItemDetails(data){_classCallCheck(this,ItemDetails);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));if(_this._data=data,_this._data&&(_this.self=_this._data.$href("self")),_this.questions=[],_this.survey_questions=[],data){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(data.questions)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var q=_step.value;!1===q.outcome?(data.currency_code&&(q.currency_code=data.currency_code),_this.questions.push(new BBModel.Question(q))):_this.survey_questions.push(new BBModel.SurveyQuestion(q))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return _this.hasQuestions=_this.questions.length>0,_this.hasSurveyQuestions=_this.survey_questions.length>0,_this}return _inherits(ItemDetails,_BaseModel),ItemDetails.prototype.questionPrice=function(qty){qty||(qty=1),this.checkConditionalQuestions();var price=0,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this.questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){price+=_step2.value.selectedPriceQty(qty)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return price},ItemDetails.prototype.checkConditionalQuestions=function(){return BBModel.Question.$checkConditionalQuestions(this.questions)},ItemDetails.prototype.getPostData=function(){var data=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(this.questions)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var q=_step3.value;q.currentlyShown&&data.push(q.getPostData())}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return data},ItemDetails.prototype.setAnswers=function(answers){var ahash={},_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(answers)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var a=_step4.value;ahash[a.id]=a}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(this.questions)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var q=_step5.value;ahash[q.id]&&(q.answer=ahash[q.id].answer)}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return this.checkConditionalQuestions()},ItemDetails.prototype.getQuestion=function(id){return _.findWhere(this.questions,{id:id})},ItemDetails.$query=function(prms){return ItemDetailsService.query(prms)},ItemDetails}(BaseModel)}),angular.module("BB.Models").factory("ItemsModel",function($q,$filter,BBModel,BaseModel){return function(_BaseModel){function Items(data){return _classCallCheck(this,Items),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(Items,_BaseModel),Items}(BaseModel)}),angular.module("BB.Models").factory("LoginModel",function($q,LoginService,BBModel,BaseModel){return function(_BaseModel){function Login(data){return _classCallCheck(this,Login),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(Login,_BaseModel),Login.$companyLogin=function(company,params,form){return LoginService.companyLogin(company,params,form)},Login.$login=function(form,options){return LoginService.login(form,options)},Login.$FBLogin=function(company,params){return LoginService.FBLogin(company,params)},Login.$companyQuery=function(id){return LoginService.companyQuery(id)},Login.$memberQuery=function(params){return LoginService.memberQuery(params)},Login.$ssoLogin=function(options,data){return LoginService.ssoLogin(options,data)},Login.$isLoggedIn=function(){return LoginService.isLoggedIn()},Login.$setLogin=function(member,persist){return LoginService.setLogin(member,persist)},Login.$member=function(){return LoginService.member()},Login.$checkLogin=function(){return LoginService.checkLogin()},Login.$logout=function(){return LoginService.logout()},Login.$FBLogout=function(options){return LoginService.FBLogout(options)},Login.$sendPasswordReset=function(company,params){return LoginService.sendPasswordReset(company,params)},Login.$updatePassword=function(member,params){return LoginService.updatePassword(member,params)},Login}(BaseModel)}),angular.module("BB.Models").factory("MembershipLevelModel",function($q,BBModel,BaseModel,MembershipLevelsService){return function(_BaseModel){function MembershipLevel(){return _classCallCheck(this,MembershipLevel),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(MembershipLevel,_BaseModel),MembershipLevel.prototype.$getMembershipLevels=function(company){return MembershipLevelsService.getMembershipLevels(company)},MembershipLevel}(BaseModel)}),angular.module("BB.Models").factory("PackageItemModel",function($q,PackageItemService,BBModel,BaseModel){return function(_BaseModel){function PackageItem(){return _classCallCheck(this,PackageItem),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(PackageItem,_BaseModel),PackageItem.$query=function(company){return PackageItemService.query(company)},PackageItem.$getPackageServices=function(package_item){return PackageItemService.getPackageServices(package_item)},PackageItem}(BaseModel)}),angular.module("BB.Models").factory("PaginationModel",function($translate){return function(){function Pagination(options){_classCallCheck(this,Pagination),this.current_page=1,this.page_size=options.page_size||10,this.request_page_size=options.request_page_size||this.page_size,this.max_size=options.max_size||5,this.num_pages=null,this.num_items=null,this.items=[]}return Pagination.prototype.initialise=function(items,total_items){return this.current_page=1,this.items=items||[],this.num_items=total_items||0,this.update()},Pagination.prototype.update=function(){var start=(this.current_page-1)*this.page_size+1,end=this.current_page*this.page_size;end=this.num_items<end?this.num_items:end;var total=end>=100?"100+":end;this.summary=$translate.instant("CORE.PAGINATION.SUMMARY",{start:start,end:end,total:total});var page_to_load=Math.ceil(this.current_page*this.page_size/this.request_page_size);return[null!=this.items[start-1],page_to_load]},Pagination.prototype.add=function(request_page,new_items){var _this=this,start=(request_page-1)*this.request_page_size;return Array.from(new_items).map(function(item,index){return _this.items[start+index]=item})},Pagination}()}),angular.module("BB.Models").factory("PaymentCallbacksModel",function($q,$filter,BBModel,BaseModel){return function(_BaseModel){function PaymentCallbacks(data){return _classCallCheck(this,PaymentCallbacks),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(PaymentCallbacks,_BaseModel),PaymentCallbacks}(BaseModel)}),angular.module("BB.Models").factory("PersonModel",function($q,BBModel,BaseModel,PersonService){return function(_BaseModel){function Person(){return _classCallCheck(this,Person),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(Person,_BaseModel),Person.$query=function(company){return PersonService.query(company)},Person}(BaseModel)}),angular.module("BB.Models").factory("PrePaidBookingModel",function($q,BBModel,BaseModel){return function(_BaseModel){function PrePaidBooking(data){_classCallCheck(this,PrePaidBooking);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.book_by&&(_this.book_by=moment(_this.book_by)),_this.use_by&&(_this.use_by=moment(_this.use_by)),_this.use_from&&(_this.use_from=moment(_this.use_from)),_this.expired=_this.book_by&&moment().isAfter(_this.book_by,"day")||_this.use_by&&moment().isAfter(_this.use_by,"day")||!1,_this}return _inherits(PrePaidBooking,_BaseModel),PrePaidBooking.prototype.checkValidity=function(item){return(!this.service_id||!item.service_id||this.service_id===item.service_id)&&((!this.resource_id||!item.resource_id||this.resource_id===item.resource_id)&&(!this.person_id||!item.person_id||this.person_id===item.person_id))},PrePaidBooking}(BaseModel)}),angular.module("BB.Models").factory("ProductModel",function($q,BBModel,BaseModel){return function(_BaseModel){function Product(){return _classCallCheck(this,Product),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(Product,_BaseModel),Product}(BaseModel)}),angular.module("BB.Models").factory("PurchaseItemModel",function($q,BBModel,BaseModel){return function(_BaseModel){function PurchaseItem(data){_classCallCheck(this,PurchaseItem);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.parts_links={},data&&(data.$has("service")&&(_this.parts_links.service=data.$href("service")),data.$has("resource")&&(_this.parts_links.resource=data.$href("resource")),data.$has("person")&&(_this.parts_links.person=data.$href("person")),data.$has("company")&&(_this.parts_links.company=data.$href("company"))),_this}return _inherits(PurchaseItem,_BaseModel),PurchaseItem.prototype.describe=function(){return this.get("describe")},PurchaseItem.prototype.full_describe=function(){return this.get("full_describe")},PurchaseItem.prototype.hasPrice=function(){return this.price&&this.price>0},PurchaseItem}(BaseModel)}),angular.module("BB.Models").factory("PurchaseTotalModel",function($q,BBModel,BaseModel,PurchaseService){return function(_BaseModel){function PurchaseTotal(data){_classCallCheck(this,PurchaseTotal);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));if(_this.promise=_this._data.$get("purchase_items"),_this.purchase_items=[],_this.promise.then(function(items){return Array.from(items).map(function(item){return _this.purchase_items.push(new BBModel.PurchaseItem(item))})}),_this._data.$has("client")){data.$get("client").then(function(client){return _this.client=new BBModel.Client(client)})}return _this.created_at=moment.parseZone(_this.created_at),_this.time_zone&&_this.created_at.tz(_this.time_zone),_this}return _inherits(PurchaseTotal,_BaseModel),PurchaseTotal.prototype.icalLink=function(){return this._data.$href("ical")},PurchaseTotal.prototype.webcalLink=function(){return this._data.$href("ical")},PurchaseTotal.prototype.gcalLink=function(){return this._data.$href("gcal")},PurchaseTotal.prototype.id=function(){return this.get("id")},PurchaseTotal.$query=function(params){return PurchaseService.query(params)},PurchaseTotal.$bookingRefQuery=function(params){return PurchaseService.query(params)},PurchaseTotal}(BaseModel)}),angular.module("BB.Models").factory("QuestionModel",function($q,$filter,BBModel,BaseModel,QuestionService){return function(_BaseModel){function Question(data){_classCallCheck(this,Question);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));if(_this.price&&(_this.price=parseFloat(_this.price)),_this._data.default&&(_this.answer=_this._data.default),_this._data.options){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(_this._data.options)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var option=_step.value;if(option.is_default&&(_this.answer=option.name),_this.hasPrice()){option.price=parseFloat(option.price);var currency=data.currency_code?data.currency_code:"GBP";option.display_name=option.name+" ("+$filter("currency")(option.price,currency)+")"}else option.display_name=option.name}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return"check"!==_this._data.detail_type&&"check-price"!==_this._data.detail_type||(_this.answer=_this._data.default&&"1"===_this._data.default),_this.currentlyShown=!0,_this}return _inherits(Question,_BaseModel),Question.prototype.hasPrice=function(){return"check-price"===this.detail_type||"select-price"===this.detail_type||"radio-price"===this.detail_type},Question.prototype.selectedPrice=function(){if(!this.hasPrice())return 0;if("check-price"===this.detail_type)return this.answer?this.price:0;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this._data.options)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var option=_step2.value;if(this.answer===option.name)return option.price}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return 0},Question.prototype.selectedPriceQty=function(qty){qty||(qty=1);var p=this.selectedPrice();return this.price_per_booking&&(p*=qty),p},Question.prototype.getAnswerId=function(){if(!this.answer||!this.options||0===this.options.length)return null;var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(this.options)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var o=_step3.value;if(this.answer===o.name)return o.id}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return null},Question.prototype.showElement=function(){return this.currentlyShown=!0},Question.prototype.hideElement=function(){return this.currentlyShown=!1},Question.prototype.getPostData=function(){var x={};x.id=this.id,x.answer=this.answer,"date"===this.detail_type&&this.answer&&(x.answer=moment(this.answer).toISODate());var p=this.selectedPrice();return p&&(x.price=p),x},Question.$addAnswersByName=function(obj,keys){return QuestionService.addAnswersByName(obj,keys)},Question.$addDynamicAnswersByName=function(questions){return QuestionService.addDynamicAnswersByName(questions)},Question.$addAnswersFromDefaults=function(questions,answers){return QuestionService.addAnswersFromDefaults(questions,answers)},Question.$checkConditionalQuestions=function(questions){return QuestionService.checkConditionalQuestions(questions)},Question}(BaseModel)}),angular.module("BB.Models").factory("ReasonModel",function($q,BBModel,BaseModel){return function(_BaseModel){function Reason(){return _classCallCheck(this,Reason),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(Reason,_BaseModel),Reason}(BaseModel)}),angular.module("BB.Models").factory("ResourceModel",function($q,BBModel,BaseModel,ResourceService){return function(_BaseModel){function Resource(){return _classCallCheck(this,Resource),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(Resource,_BaseModel),Resource.$query=function(company){return ResourceService.query(company)},Resource}(BaseModel)}),angular.module("BB.Models").factory("ServiceModel",function($q,BBModel,BaseModel,ServiceService){return function(_BaseModel){function Service(data){_classCallCheck(this,Service);var _this=_possibleConstructorReturn(this,_BaseModel.apply(this,arguments));return _this.prices&&_this.prices.length>0&&(_this.price=_this.prices[0]),_this.durations&&_this.durations.length>0&&(_this.duration=_this.durations[0]),_this.listed_durations||(_this.listed_durations=_this.durations),_this.listed_durations&&_this.listed_durations.length>0&&(_this.listed_duration=_this.listed_durations[0]),_this.min_advance_datetime=moment().add(_this.min_advance_period,"seconds"),_this.max_advance_datetime=moment().add(_this.max_advance_period,"seconds"),_this}return _inherits(Service,_BaseModel),Service.prototype.getPriceByDuration=function(dur){for(var i=0;i<this.durations.length;i++){if(this.durations[i]===dur)return this.prices[i]}},Service.prototype.$getCategory=function(){var _this2=this;if(!this.$has("category"))return null;var prom=this.$get("category");return prom.then(function(cat){return _this2.category=new BBModel.Category(cat)}),prom},Service.prototype.days_array=function(){for(var arr=[],x=this.min_bookings,end=this.max_bookings,asc=this.min_bookings<=end;asc?x<=end:x>=end;asc?x++:x--){var str=x+" day";x>1&&(str+="s"),arr.push({name:str,val:x})}return arr},Service.$query=function(company){return ServiceService.query(company)},Service}(BaseModel)}),
angular.module("BB.Models").factory("SlotModel",function($q,BBModel,BaseModel,SlotService){return function(_BaseModel){function Slot(data){_classCallCheck(this,Slot);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.datetime=moment(data.datetime),_this}return _inherits(Slot,_BaseModel),Slot.$query=function(company,params){return SlotService.query(company,params)},Slot}(BaseModel)}),angular.module("BB.Models").factory("SpaceModel",function($q,BBModel,BaseModel,SpaceService){return function(_BaseModel){function Space(){return _classCallCheck(this,Space),_possibleConstructorReturn(this,_BaseModel.apply(this,arguments))}return _inherits(Space,_BaseModel),Space.prototype.$query=function(company){return SpaceService.query(company)},Space}(BaseModel)}),angular.module("BB.Models").factory("SurveyQuestionModel",function($q,$window,BBModel,BaseModel,QuestionModel){return function(_QuestionModel){function SurveyQuestion(){return _classCallCheck(this,SurveyQuestion),_possibleConstructorReturn(this,_QuestionModel.apply(this,arguments))}return _inherits(SurveyQuestion,_QuestionModel),SurveyQuestion}(QuestionModel)}),angular.module("BB.Models").factory("TimeSlotModel",function($q,$window,BBModel,BaseModel,TimeService,DateTimeUtilitiesService){return function(_BaseModel){function TimeSlot(data,service){_classCallCheck(this,TimeSlot);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.service=service,!_this.datetime&&data.time&&moment.isMoment(data.date)?_this.datetime=DateTimeUtilitiesService.convertTimeToMoment(data.date,data.time):_this.datetime=moment.parseZone(_this.datetime),_this}return _inherits(TimeSlot,_BaseModel),TimeSlot.prototype.endDateTime=function(dur){var duration=void 0;return dur||(duration=this.service.listed_durations[0]),this.datetime.clone().add(duration,"minutes")},TimeSlot.prototype.availability=function(){return this.avail},TimeSlot.prototype.select=function(){return this.selected=!0},TimeSlot.prototype.unselect=function(){if(this.selected)return delete this.selected},TimeSlot.prototype.disable=function(reason){return this.disabled=!0,this.disabled_reason=reason},TimeSlot.prototype.enable=function(){if(this.disabled&&delete this.disabled,this.disabled_reason)return delete this.disabled_reason},TimeSlot.prototype.status=function(){return this.selected?"selected":this.disabled?"disabled":this.availability()>0?"enabled":"disabled"},TimeSlot.$query=function(params){return TimeService.query(params)},TimeSlot}(BaseModel)}),angular.module("BB.Services").factory("AddressListService",function($q,$window,halClient,UriTemplate){return{query:function(prms){var deferred=$q.defer(),uri=new UriTemplate("/api/v1/company/{company_id}/addresses/{post_code}").fillFromObject({company_id:prms.company.id,post_code:prms.post_code});return halClient.$get(uri,{}).then(function(addressList){return deferred.resolve(addressList)},function(err){return deferred.reject(err)}),deferred.promise},getAddress:function(prms){var deferred=$q.defer(),uri=new UriTemplate("/api/v1/company/{company_id}/addresses/address/{id}").fillFromObject({company_id:prms.company.id,id:prms.id});return halClient.$get(uri,{}).then(function(customerAddress){return deferred.resolve(customerAddress)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BB.Services").factory("$exceptionHandler",function($log,AirbrakeConfig){var airbrake=new airbrakeJs.Client({projectId:AirbrakeConfig.projectId,projectKey:AirbrakeConfig.projectKey});return airbrake.addFilter(function(notice){return!("development"===AirbrakeConfig.environment||!notice.params.from_sdk)&&(notice.context.environment="production",notice)}),function(exception,cause,sdkError){$log.error(exception),airbrake.notify({error:exception,params:{angular_cause:cause,from_sdk:sdkError}})}}),angular.module("BB.Services").factory("AlertService",function($rootScope,ErrorService,$timeout,$translate){var alertService=void 0;$rootScope.alerts=[];var titleLookup=function(type,title){if(title)return title;switch(type){case"error":case"danger":title=$translate.instant("CORE.ERROR_HEADING");break;default:title=null}return title};return alertService={add:function(type,_ref){var title=_ref.title,msg=_ref.msg,persist=_ref.persist;null==persist&&(persist=!0),$rootScope.alerts=[];var alert={type:type,title:titleLookup(type,title),msg:msg,close:function(){return alertService.closeAlert(this)}};return $rootScope.alerts.push(alert),persist||$timeout(function(){return $rootScope.alerts.splice($rootScope.alerts.indexOf(alert),1)},3e3),$rootScope.$broadcast("alert:raised")},closeAlert:function(alert){return this.closeAlertIdx($rootScope.alerts.indexOf(alert))},closeAlertIdx:function(index){return $rootScope.alerts.splice(index,1)},clear:function(){return $rootScope.alerts=[]},error:function(alert){if(alert)return this.add("error",{title:alert.title,msg:alert.msg,persist:alert.persist})},danger:function(alert){if(alert)return this.add("danger",{title:alert.title,msg:alert.msg,persist:alert.persist})},info:function(alert){if(alert)return this.add("info",{title:alert.title,msg:alert.msg,persist:alert.persist})},warning:function(alert){if(alert)return this.add("warning",{title:alert.title,msg:alert.msg,persist:alert.persist})},success:function(alert){if(alert)return this.add("success",{title:alert.title,msg:alert.msg,persist:alert.persist})},raise:function(key){if(key){var alert=ErrorService.getAlert(key);return alert?this.add(alert.type,{title:alert.title,msg:alert.msg,persist:alert.persist}):void 0}}}}),angular.module("BB.Services").factory("AppService",function($uibModalStack){return{isModalOpen:function(){return!!$uibModalStack.getTop()}}}),angular.module("BB.Services").factory("BasketService",function($q,$rootScope,BBModel,MutexService){return{addItem:function(company,params){var deferred=$q.defer(),lnk=params.item.book_link,data=params.item.getPostData();return lnk?MutexService.getLock().then(function(mutex){return lnk.$post("book",params,data).then(function(basket){MutexService.unlock(mutex),company.$flush("basket");var mbasket=new BBModel.Basket(basket,params.bb);return basket.$get("items").then(function(items){var promises=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value,item=new BBModel.BasketItem(i,params.bb);mbasket.addItem(item),promises=promises.concat(item.promises)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return promises.length>0?$q.all(promises).then(function(){return deferred.resolve(mbasket)}):deferred.resolve(mbasket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}):deferred.reject("rel book not found for event"),deferred.promise},applyCoupon:function(company,params){var deferred=$q.defer();return MutexService.getLock().then(function(mutex){return company.$post("coupon",{},{coupon:params.coupon}).then(function(basket){MutexService.unlock(mutex),company.$flush("basket");var mbasket=new BBModel.Basket(basket,params.bb);return basket.$get("items").then(function(items){var promises=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var i=_step2.value,item=new BBModel.BasketItem(i,params.bb);mbasket.addItem(item),promises=promises.concat(item.promises)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return promises.length>0?$q.all(promises).then(function(){return deferred.resolve(mbasket)}):deferred.resolve(mbasket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise},updateBasket:function(company,params){var lnk=void 0,deferred=$q.defer(),data={entire_basket:!0,items:[]},_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(params.items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var item=_step3.value;item.book_link&&(lnk=item.book_link);var xdata=item.getPostData();data.items.push(xdata)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return lnk?(MutexService.getLock().then(function(mutex){return lnk.$post("book",params,data).then(function(basket){MutexService.unlock(mutex),company.$flush("basket");var mbasket=new BBModel.Basket(basket,params.bb);return basket.$get("items").then(function(items){var promises=[],_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var i=_step4.value;item=new BBModel.BasketItem(i,params.bb),mbasket.addItem(item),promises=promises.concat(item.promises)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return promises.length>0?$q.all(promises).then(function(){return $rootScope.$broadcast("basket:updated",mbasket),deferred.resolve(mbasket)}):($rootScope.$broadcast("basket:updated",mbasket),deferred.resolve(mbasket))},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise):(deferred.reject("rel book not found for event"),deferred.promise)},checkPrePaid:function(item,pre_paid_bookings){var valid_pre_paid=null,_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(pre_paid_bookings)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var booking=_step5.value;if(booking.checkValidity(item)){valid_pre_paid=booking;break}}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return valid_pre_paid},query:function(company,params){var deferred=$q.defer();return company.$has("basket")?company.$get("basket").then(function(basket){return basket=new BBModel.Basket(basket,params.bb),basket.$has("items")&&basket.$get("items").then(function(items){return Array.from(items).map(function(item){return basket.addItem(new BBModel.BasketItem(item,params.bb))})}),deferred.resolve(basket)},function(err){return deferred.reject(err)}):deferred.reject("rel basket not found for company"),deferred.promise},deleteItem:function(item,company,params){params||(params={}),params.basket&&params.basket.clearItem(item);var deferred=$q.defer();return item.$has("self")?MutexService.getLock().then(function(mutex){return item.$del("self",params).then(function(basket){return MutexService.unlock(mutex),company.$flush("basket"),basket=new BBModel.Basket(basket,params.bb),basket.$has("items")&&basket.$get("items").then(function(items){return function(){var result=[],_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0)item=_step6.value,result.push(basket.addItem(new BBModel.BasketItem(item,params.bb)))}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}return result}()}),deferred.resolve(basket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)}):deferred.reject("rel self not found for item"),deferred.promise},checkout:function(company,basket,params){var deferred=$q.defer();if(basket.$has("checkout")){var data=basket.getPostData();params.bb.qudini_booking_id&&(data.qudini_booking_id=params.bb.qudini_booking_id),params.bb.booking_settings&&(data.booking_settings=params.bb.booking_settings),params.bb.no_notifications&&(data.no_notifications=params.bb.no_notifications),params.bb.email_config&&(data.email_config=params.bb.email_config),data.affiliate_id=$rootScope.affiliate_id||params.affiliate_id,basket.waiting_for_checkout=!0,MutexService.getLock().then(function(mutex){return basket.$post("checkout",params,data).then(function(total){MutexService.unlock(mutex),$rootScope.$broadcast("updateBookings");var tot=new BBModel.Purchase.Total(total);return $rootScope.$broadcast("newCheckout",tot),basket.clear(),basket.waiting_for_checkout=!1,deferred.resolve(tot)},function(err){return basket.waiting_for_checkout=!1,deferred.reject(err)})},function(err){return basket.waiting_for_checkout=!1,MutexService.unlock(mutex),deferred.reject(err)})}else deferred.reject("rel checkout not found for basket");return deferred.promise},empty:function(bb){var deferred=$q.defer();return MutexService.getLock().then(function(mutex){return bb.company.$del("basket").then(function(basket){return MutexService.unlock(mutex),bb.company.$flush("basket"),deferred.resolve(new BBModel.Basket(basket,bb))},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)}),deferred.promise},memberCheckout:function(basket,params){var deferred=$q.defer();if(basket.$has("checkout"))if(null===$rootScope.member)deferred.reject("member not set");else{basket._data.setOption("auth_token",$rootScope.member._data.getOption("auth_token"));var data={items:Array.from(basket.items).map(function(item){return item._data})};basket.$post("checkout",params,data).then(function(total){return total.$has("member")&&total.$get("member").then(function(member){return $rootScope.member.flushBookings(),$rootScope.member=new BBModel.Member.Member(member)}),deferred.resolve(total)},function(err){return deferred.reject(err)})}else deferred.reject("rel checkout not found for basket");return deferred.promise},applyDeal:function(company,params){var deferred=$q.defer();return MutexService.getLock().then(function(mutex){return params.bb.basket.$post("deal",{},{deal_code:params.deal_code}).then(function(basket){MutexService.unlock(mutex),company.$flush("basket");var mbasket=new BBModel.Basket(basket,params.bb);return basket.$get("items").then(function(items){var promises=[],_iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _step7,_iterator7=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var i=_step7.value,item=new BBModel.BasketItem(i,params.bb);mbasket.addItem(item),promises=promises.concat(item.promises)}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}return promises.length>0?$q.all(promises).then(function(){return deferred.resolve(mbasket)}):deferred.resolve(mbasket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise},removeDeal:function(company,params){params||(params={});var deferred=$q.defer();return params.bb.basket.$has("deal")?(MutexService.getLock().then(function(mutex){return params.bb.basket.$put("deal",{},{deal_code_id:params.deal_code_id.toString()}).then(function(basket){if(MutexService.unlock(mutex),company.$flush("basket"),basket=new BBModel.Basket(basket,params.bb),basket.$has("items"))return basket.$get("items").then(function(items){var _iteratorNormalCompletion8=!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var _step8,_iterator8=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=!0){var item=_step8.value;basket.addItem(new BBModel.BasketItem(item,params.bb))}}catch(err){_didIteratorError8=!0,_iteratorError8=err}finally{try{!_iteratorNormalCompletion8&&_iterator8.return&&_iterator8.return()}finally{if(_didIteratorError8)throw _iteratorError8}}return deferred.resolve(basket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise):deferred.reject("No Remove Deal link found")}}}),angular.module("BB.Services").factory("BreadcrumbService",function(){var current_step=1;return{setCurrentStep:function(step){return current_step=step},getCurrentStep:function(){return current_step}}}),angular.module("BB.Services").factory("BulkPurchaseService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("bulk_purchases")?company.$get("bulk_purchases").then(function(resource){return resource.$get("bulk_purchases").then(function(bulk_purchases){return deferred.resolve(Array.from(bulk_purchases).map(function(i){return new BBModel.BulkPurchase(i)}))})},function(err){return deferred.reject(err)}):deferred.reject("No bulk purchases found"),deferred.promise}}}),angular.module("BB.Services").factory("CategoryService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("categories")?company.$get("named_categories").then(function(resource){return resource.$get("categories").then(function(items){for(var categories=[],_i=0;_i<items.length;_i++){var i=items[_i],cat=new BBModel.Category(i);cat.order||(cat.order=_i),categories.push(cat)}return deferred.resolve(categories)})},function(err){return deferred.reject(err)}):deferred.reject("No categories found"),deferred.promise}}}),angular.module("BB.Services").factory("ClientService",function($q,BBModel,MutexService){var setDefaultCompanyId=function(company,client){client.default_company_id=company.id};return{create:function(company,client){var deferred=$q.defer();return company.$has("client")?MutexService.getLock().then(function(mutex){return setDefaultCompanyId(company,client),company.$post("client",{},client.getPostData()).then(function(cl){return deferred.resolve(new BBModel.Client(cl)),MutexService.unlock(mutex)},function(err){return deferred.reject(err),MutexService.unlock(mutex)})}):deferred.reject("Cannot create new people for this company"),deferred.promise},update:function(company,client){var deferred=$q.defer();return MutexService.getLock().then(function(mutex){return setDefaultCompanyId(company,client),client.$put("self",{},client.getPostData()).then(function(cl){return deferred.resolve(new BBModel.Client(cl)),MutexService.unlock(mutex)},function(err){return deferred.reject(err),MutexService.unlock(mutex)})}),deferred.promise},create_or_update:function(company,client){return client.$has("self")?this.update(company,client):this.create(company,client)},query_by_email:function(company,email){var deferred=$q.defer();return null!=company&&null!=email?company.$get("client_by_email",{email:email}).then(function(client){return null!=client?deferred.resolve(new BBModel.Client(client)):deferred.resolve({})},function(err){return deferred.reject(err)}):deferred.reject("No company or email defined"),deferred.promise}}}),angular.module("BB.Services").factory("ClientDetailsService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("client_details")?company.$get("client_details").then(function(details){return deferred.resolve(new BBModel.ClientDetails(details))},function(err){return deferred.reject(err)}):deferred.reject("No client_details found"),deferred.promise}}}),angular.module("BB.Services").factory("ClinicService",function($q,BBModel,$window){return{query:function(params){var company=params.company,defer=$q.defer();return params.id?company.$get("clinics",params).then(function(clinic){return clinic=new BBModel.Clinic(clinic),defer.resolve(clinic)},function(err){return defer.reject(err)}):company.$get("clinics",params).then(function(collection){return collection.$get("clinics").then(function(clinics){return clinics=Array.from(clinics).map(function(s){return new BBModel.Clinic(s)}),defer.resolve(clinics)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise}}}),angular.module("BB.Services").factory("CompanyService",function($q,halClient,BBModel){return{query:function(company_id,options){options.root||(options.root="");var url=options.root+"/api/v1/company/"+company_id,deferred=$q.defer();return halClient.$get(url,options).then(function(company){return deferred.resolve(company)},function(err){return deferred.reject(err)}),deferred.promise},queryChildren:function(company){var deferred=$q.defer();return company.$has("companies")?company.$get("companies").then(function(resource){return resource.$get("companies").then(function(items){var companies=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;companies.push(new BBModel.Company(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(companies)})},function(err){return deferred.reject(err)}):deferred.reject("No child companies found"),deferred.promise}}}),angular.module("BB.Services").factory("CompanyStoreService",function(){return{country_code:null,currency_code:null,time_zone:null,settings:null}}),angular.module("BB.Services").factory("CustomTextService",function($q,BBModel){return{BookingText:function(company,basketItem){var deferred=$q.defer();return company.$get("booking_text").then(function(emb){return emb.$get("booking_text").then(function(details){var msgs=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(details)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var detail=_step.value;if("Booking"===detail.message_type)for(var name in basketItem.parts_links){var link=basketItem.parts_links[name];detail.$href("item")===link&&-1===msgs.indexOf(detail.message)&&msgs.push(detail.message)}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(msgs)})},function(err){return deferred.reject(err)}),deferred.promise},confirmationText:function(company,total){var deferred=$q.defer();return company.$get("booking_text").then(function(emb){return emb.$get("booking_text").then(function(details){return total.getMessages(details,"Confirm").then(function(msgs){return deferred.resolve(msgs)})})},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BB.Services").factory("DateTimeUtilitiesService",function(GeneralOptions,CompanyStoreService,bbTimeZone){var checkPerson=function(basket_item,item_defaults){return basket_item.defaults.person&&basket_item.defaults.person.self===basket_item.person.self||_.isBoolean(basket_item.person)||item_defaults.merge_people},checkResource=function(basket_item,item_defaults){return basket_item.defaults.resource&&basket_item.defaults.resource.self===basket_item.resource.self||_.isBoolean(basket_item.resource)||item_defaults.merge_resources};return{convertTimeToMoment:function(date,time){if(date&&moment.isMoment(date)&&angular.isNumber(time)){var datetime=moment();datetime=bbTimeZone.convertToCompany(datetime);var val=parseInt(time),hours=parseInt(val/60),mins=val%60;return datetime.hour(hours),datetime.minutes(mins),datetime.seconds(0),datetime.date(date.date()),datetime.month(date.month()),datetime.year(date.year()),datetime}},convertMomentToTime:function(datetime){return datetime.minutes()+60*datetime.hours()},checkDefaultTime:function(date,time_slots,basket_item,item_defaults){var match=void 0,slot=void 0;match=basket_item.defaults.time?checkPerson(basket_item,item_defaults)&&checkResource(basket_item,item_defaults)?"full":"partial":null;var found_time_slot=null;if(basket_item.defaults.time&&(basket_item.defaults.date&&date.isSame(basket_item.defaults.date,"day")||!basket_item.defaults.date)){var time=basket_item.time?basket_item.time.time:basket_item.defaults.time,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(time_slots)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)if(slot=_step.value,time&&time===slot.time&&1===slot.avail){found_time_slot=slot;break}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return{match:match,slot:found_time_slot}}}}),angular.module("BB.Services").factory("DayService",function($q,BBModel){return{query:function(prms){var deferred=$q.defer();if(prms.cItem.days_link){var extra={};extra.month=prms.month,extra.date=prms.date,extra.edate=prms.edate,prms.people_ids&&(extra.people_ids=prms.people_ids),prms.resource_ids&&(extra.resource_ids=prms.resource_ids),prms.person_group_id&&(extra.person_group_id=prms.person_group_id),prms.cItem.days_link.$get("days",extra).then(function(found){var afound=found.days,days=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(afound)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;i.type===prms.item&&days.push(new BBModel.Day(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(days)},function(err){return deferred.reject(err)})}else deferred.reject("No Days Link found");return deferred.promise}}}),angular.module("BB.Services").factory("DealService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("deals")?company.$get("deals").then(function(resource){return resource.$get("deals").then(function(deals){return deals=Array.from(deals).map(function(deal){return new BBModel.Deal(deal)}),deferred.resolve(deals)})},function(err){return deferred.reject(err)}):deferred.reject("No Deals found"),deferred.promise}}}),angular.module("BB").config(function($logProvider,$injector){return $logProvider.debugEnabled(!0)}),angular.module("BB.Services").factory("DebugUtilsService",function($rootScope,$location,$window,$log,BBModel,$bbug){var logObjectKeys=function(obj,showValue){for(var key in obj){var value=obj[key];!obj.hasOwnProperty(key)||_.isFunction(value)||/^\$\$/.test(key)||(console.log(key),showValue&&console.log("\t",value,"\n"))}},showScopeChain=function(){var $root=$("[ng-app]"),data=$root.data();if(data&&data.$scope){!function f(scope){return console.log(scope.$id),console.log(scope),scope.$$nextSibling?f(scope.$$nextSibling):scope.$$childHead?f(scope.$$childHead):void 0}(data.$scope)}};return function(){if(("localhost"===$location.host()||"127.0.0.1"===$location.host())&&3e3===$location.port())window.setTimeout(function(){for(var scope=$rootScope;scope&&"BBCtrl"!==scope.cid;)scope=scope.$$childHead;return $bbug($window).on("dblclick",function(e){var controllerName=void 0;scope=angular.element(e.target).scope();var controller=scope.hasOwnProperty("controller"),pscope=scope;for(controller&&(controllerName=scope.controller);!controller;)pscope=pscope.$parent,controllerName=pscope.controller,controller=pscope.hasOwnProperty("controller");return $window.bbScope=scope,$log.log(e.target),$log.log($window.bbScope),$log.log("Controller ->",controllerName)}),$window.bbBBCtrlScopeKeyNames=function(prop){return logObjectKeys(scope,prop)},$window.bbBBCtrlScope=function(){return scope},$window.bbCurrentItem=function(){return scope.bb.current_item},$window.bbShowScopeChain=showScopeChain},10)}(),{logObjectKeys:logObjectKeys}}),angular.module("BB.Services").factory("Dialog",function($uibModal,$log,$document){var controller=function($scope,$uibModalInstance,model,title,success,fail,body){return $scope.body=body,$scope.title=title,$scope.ok=function(){return $uibModalInstance.close(model)},$scope.cancel=function(){return event.preventDefault(),event.stopPropagation(),$uibModalInstance.dismiss("cancel")},$uibModalInstance.result.then(function(){if(success)return success(model)},function(){if(fail)return fail()})};return{confirm:function(config){var templateUrl=void 0;return config.templateUrl&&(templateUrl=config.templateUrl),templateUrl||(templateUrl="dialog.html"),$uibModal.open({templateUrl:templateUrl,controller:controller,size:config.size||"sm",resolve:{model:function(){return config.model},title:function(){return config.title},success:function(){return config.success},fail:function(){return config.fail},body:function(){return config.body}}})}}}),angular.module("BB.Services").factory("ErrorService",function($translate){var alerts=[{key:"GENERIC",type:"error",persist:!0},{key:"LOCATION_NOT_FOUND",type:"warning",persist:!0},{key:"MISSING_LOCATION",type:"warning",persist:!0},{key:"MISSING_POSTCODE",type:"warning",persist:!0},{key:"POSTCODE_INVALID",type:"warning",persist:!0},{key:"ITEM_NO_LONGER_AVAILABLE",type:"error",persist:!0},{key:"NO_WAITLIST_SPACES_LEFT",type:"error",persist:!0},{key:"FORM_INVALID",type:"warning",persist:!0},{key:"GEOLOCATION_ERROR",type:"error",persist:!0},{key:"EMPTY_BASKET_FOR_CHECKOUT",type:"warning",persist:!0},{key:"MAXIMUM_TICKETS",type:"warning",persist:!0},{key:"GIFT_CERTIFICATE_REQUIRED",type:"warning",persist:!0},{key:"TIME_SLOT_NOT_SELECTED",type:"warning",persist:!0},{key:"STORE_NOT_SELECTED",type:"warning",persist:!0},{key:"APPT_AT_SAME_TIME",type:"warning",persist:!0},{key:"REQ_TIME_NOT_AVAIL",type:"warning",persist:!0},{key:"TOPUP_SUCCESS",type:"success",persist:!0},{key:"TOPUP_FAILED",type:"warning",persist:!0},{key:"UPDATE_SUCCESS",type:"success",persist:!0},{key:"UPDATE_FAILED",type:"warning",persist:!0},{key:"ALREADY_REGISTERED",type:"warning",persist:!0},{key:"LOGIN_FAILED",type:"warning",persist:!0},{key:"SSO_LOGIN_FAILED",type:"warning",persist:!0},{key:"PASSWORD_INVALID",type:"warning",persist:!0},{key:"PASSWORD_RESET_REQ_SUCCESS",type:"success",persist:!0},{key:"PASSWORD_RESET_REQ_FAILED",type:"warning",persist:!0},{key:"PASSWORD_RESET_SUCESS",type:"success",persist:!0},{key:"PASSWORD_RESET_FAILED",type:"warning",persist:!0},{key:"PASSWORD_MISMATCH",type:"warning",persist:!0},{key:"ATTENDEES_CHANGED",type:"info",persist:!0},{key:"PAYMENT_FAILED",type:"danger",persist:!0},{key:"ACCOUNT_DISABLED",type:"warning",persist:!0},{key:"FB_LOGIN_NOT_A_MEMBER",type:"warning",persist:!0},{key:"PHONE_NUMBER_IN_USE",type:"warning",persist:!0},{key:"EMAIL_IN_USE",type:"warning",persist:!0},{key:"WAITLIST_ACCEPTED",type:"success",persist:!1},{key:"BOOKING_CANCELLED",type:"success",persist:!1},{key:"NOT_BOOKABLE_PERSON",type:"warning",persist:!1},{key:"NOT_BOOKABLE_RESOURCE",type:"warning",persist:!1},{key:"COUPON_APPLY_FAILED",type:"warning",title:"",persist:!0},{key:"DEAL_APPLY_FAILED",type:"warning",title:"",persist:!0},{key:"DEAL_REMOVE_FAILED",type:"warning",title:"",persist:!0
}],createCustomError=function(msg){return{msg:msg}},getError=function(key){var error=getAlert(key);return error||(error=getAlert("GENERIC")),error.persist=!0,error},getAlert=function(key){var alert=_.findWhere(alerts,{key:key});return alert?(alert.msg=$translate.instant("CORE.ALERTS."+key),alert):null};return{createCustomError:createCustomError,getAlert:getAlert,getError:getError}}),angular.module("BB.Services").factory("EventService",function($q,BBModel){return{query:function(company,params){var deferred=$q.defer();return company.$has("events")?(params.item&&(params.item.event_group&&(params.event_group_id=params.item.event_group.id),params.item.event_chain&&(params.event_chain_id=params.item.event_chain.id),params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),params.no_cache=!0,company.$get("events",params).then(function(resource){return params.no_cache=!1,resource.$get("events",params).then(function(events){return events=Array.from(events).map(function(event){return new BBModel.Event(event)}),deferred.resolve(events)})},function(err){return deferred.reject(err)})):deferred.resolve([]),deferred.promise},summary:function(company,params){var deferred=$q.defer();return company.$has("events")?(params.item&&(params.item.event_group&&(params.event_group_id=params.item.event_group.id),params.item.event_chain&&(params.event_chain_id=params.item.event_chain.id),params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),params.summary=!0,company.$get("events",params).then(function(resource){return deferred.resolve(resource.events)},function(err){return deferred.reject(err)})):deferred.resolve([]),deferred.promise},queryEventCollection:function(company,params){var deferred=$q.defer();return company.$has("events")?(params.item&&(params.item.event_group&&(params.event_group_id=params.item.event_group.id),params.item.event_chain&&(params.event_chain_id=params.item.event_chain.id),params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),company.$get("events",params).then(function(resource){var collection=new BBModel.BBCollection(resource);return deferred.resolve(collection)},function(err){return deferred.reject(err)})):deferred.resolve([]),deferred.promise}}}),angular.module("BB.Services").factory("EventChainService",function($q,BBModel){return{query:function(company,params){var deferred=$q.defer();return company.$has("event_chains")?company.$get("event_chains",params).then(function(resource){return resource.$get("event_chains",params).then(function(event_chains){return event_chains=Array.from(event_chains).map(function(event_chain){return new BBModel.EventChain(event_chain)}),deferred.resolve(event_chains)})},function(err){return deferred.reject(err)}):deferred.reject("company does not have event_chains"),deferred.promise},queryEventChainCollection:function(company,params){var deferred=$q.defer();return company.$has("event_chains")?company.$get("event_chains",params).then(function(resource){var collection=new BBModel.BBCollection(resource);return deferred.resolve(collection)},function(err){return deferred.reject(err)}):deferred.resolve([]),deferred.promise}}}),angular.module("BB.Services").factory("EventGroupService",function($q,BBModel){return{query:function(company,params){var deferred=$q.defer();return company.$has("event_groups")?company.$get("event_groups",params).then(function(resource){return resource.$get("event_groups",params).then(function(event_groups){return event_groups=Array.from(event_groups).map(function(event_group){return new BBModel.EventGroup(event_group)}),deferred.resolve(event_groups)})},function(err){return deferred.reject(err)}):deferred.reject("company does not have event_groups"),deferred.promise}}}),angular.module("BB.Services").factory("EventSequenceService",function($q,BBModel){return{query:function(company,params){var deferred=$q.defer();return company.$has("event_sequences")?company.$get("event_sequences",params).then(function(resource){return resource.$get("event_sequences",params).then(function(event_sequences){return event_sequences=Array.from(event_sequences).map(function(event_sequence){return new BBModel.EventSequence(event_sequence)}),deferred.resolve(event_sequences)})},function(err){return deferred.reject(err)}):deferred.reject("company does not have event_sequences"),deferred.promise}}}),angular.module("BB.Services").factory("FormDataStoreService",function($rootScope,$window,$log,$parse){var registeredWidgetArr=[],dataStore={},toId=0,showInfo=function(){},setIfUndefined=function(keyName,val){var scope=this,getter=$parse(keyName);if(void 0===getter(scope))return getter.assign(scope,val)},resetValuesOnScope=function(scope,props){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(props)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var prop=_step.value;prop=$parse(prop);(0,prop.assign)(scope,null)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}},clear=function(scope,keepScopeValues){var data=void 0;if(!scope)throw new Error("Missing scope object. Cannot clear form data without scope");if(_.isString(scope))return data=dataStore[scope],keepScopeValues||resetValuesOnScope(data[0],data[1]),void delete dataStore[scope];if((scope=getParentScope(scope))&&scope.bb){var widgetId=scope.bb.uid;removeWidget(scope);for(var key in dataStore)data=dataStore[key],-1!==key.indexOf(widgetId)&&(data[3]&&_.each(data[3],function(func){if(_.isFunction(func))return func()}),keepScopeValues||resetValuesOnScope(data[0],data[1]),delete dataStore[key])}},storeFormData=function(){for(var key in dataStore){var step=dataStore[key],scope=step[0],props=step[1],ndata=step[2];ndata||(ndata=step[2]={});var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(props)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var prop=_step2.value,val=ndata[prop];"data:destroyed"===val?ndata[prop]=null:(val=angular.copy(scope.$eval(prop)),ndata[prop]=val)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}},setValuesOnScope=function(currentPage,scope){var cpage=dataStore[currentPage],storedValues=cpage[2];_.isObject(storedValues)&&_.each(_.keys(storedValues),function(keyName){if(void 0!==storedValues[keyName]&&"data:destroyed"!==storedValues[keyName]){return $parse(keyName).assign(scope,storedValues[keyName])}}),cpage[0]=scope},getParentScope=function(scope){for(;scope;){if(scope.hasOwnProperty("cid")&&"BBCtrl"===scope.cid)return scope;scope=scope.$parent}},checkRegisteredWidgets=function(scope){var isRegistered=!1;scope=getParentScope(scope);var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(registeredWidgetArr)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){_step3.value===scope&&(isRegistered=!0)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return isRegistered},checkForListeners=function(propsArr){var watchArr=[];return _.each(propsArr,function(propName,index){var split=propName.split("->");if(2===split.length)return watchArr.push(split),propsArr[index]=split[0]}),watchArr},setListeners=function(scope,listenerArr,currentPage){if(listenerArr.length){var cpage=dataStore[currentPage],listenersArr=cpage[3]||[];return _.each(listenerArr,function(item,index){var func=$rootScope.$on(item[1],function(){try{return cpage[2][item[0]]="data:destroyed"}catch(e){return}});return listenersArr.push(func)}),cpage[3]=listenersArr}},init=function(uid,scope,propsArr){if(checkRegisteredWidgets(scope)){var currentPage=scope.bb.uid+"___"+scope.bb.current_page+"___"+uid;currentPage=currentPage.toLowerCase();var watchArr=checkForListeners(propsArr);if(scope.clearStoredData=function(currentPage){return function(){clear(currentPage)}}(currentPage),!currentPage)throw new Error("Missing current step");return dataStore[currentPage]?void setValuesOnScope(currentPage,scope):(dataStore[currentPage]=[scope,propsArr],void setListeners(0,watchArr,currentPage))}},removeWidget=function(scope){registeredWidgetArr=_.without(registeredWidgetArr,scope)},register=function(scope){var registered=!1;for(scope&&scope.$$childHead&&(scope=scope.$$childHead);!_.has(scope,"cid");)scope=scope.$parent;if(scope){if("BBCtrl"!==scope.cid)throw new Error("This directive can only be used with the BBCtrl");return _.each(registeredWidgetArr,function(stored){if(scope===stored)return registered=!0}),registered?void 0:(scope.$on("destroy",removeWidget),registeredWidgetArr.push(scope))}};return $rootScope.$watch(function(){$window.clearTimeout(toId),toId=setTimeout(storeFormData,300)}),$rootScope.$on("save:formData",storeFormData),$rootScope.$on("clear:formData",clear),{init:init,destroy:function(scope){return clear(scope,!0)},showInfo:showInfo,register:register,setIfUndefined:setIfUndefined}}),angular.module("BB.Services").provider("FormTransform",function(){var options={new:{},edit:{}};this.getTransform=function(type,model){return options[type][model]},this.setTransform=function(type,model,fn){return options[type][model]=fn},this.$get=function(){return options}}),angular.module("BB.Services").provider("GeneralOptions",function(){var options={twelve_hour_format:!1,calendar_minute_step:5,calendar_slot_duration:5,update_document_title:!1,scroll_offset:0,map_marker_icon:null,mapActiveMarkerIcon:null,map_layout:"default",companyHasExternalBookings:!1,mapMarkerHasLabel:!0,maxAdvanceDatetimeDays:null};this.setOption=function(option,value){options.hasOwnProperty(option)&&(options[option]=value)},this.$get=function(){return options}}),angular.module("BB.Services").factory("GeolocationService",function($q){return{haversine:function(position1,position2){var pi=Math.PI,lat1=position1.lat,lon1=position1.long,lat2=position2.lat,lon2=position2.long,chLat=lat2-lat1,chLon=lon2-lon1,dLat=chLat*(pi/180),dLon=chLon*(pi/180),rLat1=lat1*(pi/180),rLat2=lat2*(pi/180),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(rLat1)*Math.cos(rLat2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371},geocode:function(address,prms){null==prms&&(prms={});var deferred=$q.defer(),request={address:address};if(prms.region&&(request.region=prms.region),prms.componentRestrictions&&(request.componentRestrictions=prms.componentRestrictions),prms.bounds){var sw=new google.maps.LatLng(prms.bounds.sw.x,prms.bounds.sw.y),ne=new google.maps.LatLng(prms.bounds.ne.x,prms.bounds.ne.y);request.bounds=new google.maps.LatLngBounds(sw,ne)}return(new google.maps.Geocoder).geocode(request,function(results,status){return results&&"OK"===status?deferred.resolve({results:results,status:status}):deferred.reject(status)}),deferred.promise}}}),angular.module("BB.Services").factory("ItemService",function($q,BBModel){return{query:function(prms){var _this=this,deferred=$q.defer();return prms.cItem.service&&"service"!==prms.item?prms.cItem.service.$has("items")?this.build_items(prms.cItem.service.$get("items"),prms,deferred):prms.cItem.service.$get("item").then(function(base_item){return _this.build_items(base_item.$get("items"),prms,deferred)}):prms.cItem.resource&&!prms.cItem.anyResource()&&"resource"!==prms.item?prms.cItem.resource.$has("items")?this.build_items(prms.cItem.resource.$get("items"),prms,deferred):prms.cItem.resource.$get("item").then(function(base_item){return _this.build_items(base_item.$get("items"),prms,deferred)}):prms.cItem.person&&!prms.cItem.anyPerson()&&"person"!==prms.item?prms.cItem.person.$has("items")?this.build_items(prms.cItem.person.$get("items"),prms,deferred):prms.cItem.person.$get("item").then(function(base_item){return _this.build_items(base_item.$get("items"),prms,deferred)}):deferred.reject("No service link found"),deferred.promise},build_items:function(base_items,prms,deferred){var wait_items=[base_items];return prms.wait&&wait_items.push(prms.wait),$q.all(wait_items).then(function(resources){return resources[0].$get("items").then(function(found){var matching=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(found)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var v=_step.value;v.type===prms.item&&matching.push(new BBModel.BookableItem(v))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $q.all(Array.from(matching).map(function(m){return m.ready.promise})).then(function(){return deferred.resolve(matching)})})})}}}),angular.module("BB.Services").factory("ItemDetailsService",function($q,BBModel){return{query:function(prms){var deferred=$q.defer();return prms.cItem.service?prms.cItem.service.$has("questions")?prms.cItem.service.$get("questions").then(function(details){return deferred.resolve(new BBModel.ItemDetails(details))},function(err){return deferred.reject(err)}):deferred.resolve(new BBModel.ItemDetails):prms.cItem.event_chain?prms.cItem.event_chain.$has("questions")?prms.cItem.event_chain.$get("questions").then(function(details){return deferred.resolve(new BBModel.ItemDetails(details))},function(err){return deferred.reject(err)}):deferred.resolve(new BBModel.ItemDetails):prms.cItem.deal?prms.cItem.deal.$has("questions")?prms.cItem.deal.$get("questions").then(function(details){return deferred.resolve(new BBModel.ItemDetails(details))},function(err){return deferred.reject(err)}):deferred.resolve(new BBModel.ItemDetails):deferred.resolve(),deferred.promise}}}),angular.module("BB.Services").factory("LoadingService",function($q,$window,$log,$rootScope,AlertService,ErrorService){return{$loader:function(scope){var lservice=this;return{scope:scope,setLoaded:function(){return lservice.setLoaded(scope)},setLoadedAndShowError:function(err,error_string){return lservice.setLoadedAndShowError(scope,err,error_string)},notLoaded:function(){return lservice.notLoaded(scope),this}}},setLoaded:function(cscope){cscope.$emit("hide:loader",cscope),cscope.isLoaded=!0;for(var loadingFinished=!0;cscope;)cscope.hasOwnProperty("scopeLoaded")&&(this.areScopesLoaded(cscope)?cscope.scopeLoaded=!0:loadingFinished=!1),cscope=cscope.$parent;loadingFinished&&$rootScope.$broadcast("loading:finished")},setLoadedAndShowError:function(scope,err,error_string){return $log.warn(err,error_string),scope.setLoaded(scope),err&&409===err.status?AlertService.danger(ErrorService.getError("ITEM_NO_LONGER_AVAILABLE")):err.data&&"Number of Bookings exceeds the maximum"===err.data.error?AlertService.danger(ErrorService.getError("MAXIMUM_TICKETS")):404===err.status?AlertService.danger(err.data.error?{msg:err.data.error}:ErrorService.getError("GENERIC")):AlertService.danger(ErrorService.getError("GENERIC"))},areScopesLoaded:function(cscope){if(cscope.hasOwnProperty("isLoaded")&&!cscope.isLoaded)return!1;for(var child=cscope.$$childHead;child;){if(!this.areScopesLoaded(child))return!1;child=child.$$nextSibling}return!0},notLoaded:function(cscope){for(cscope.$emit("show:loader",cscope),cscope.isLoaded=!1;cscope;)cscope.hasOwnProperty("scopeLoaded")&&(cscope.scopeLoaded=!1),cscope=cscope.$parent}}}),angular.module("BB.Services").factory("LoginService",function($q,halClient,$rootScope,BBModel,$sessionStorage,$localStorage){return{companyLogin:function(company,params,form){var _this=this,deferred=$q.defer();return company.$post("login",params,form).then(function(login){return login.$get("member").then(function(member){return _this.setLogin(member),deferred.resolve(member)},function(err){return deferred.reject(err)})},function(err){return deferred.reject(err)}),deferred.promise},login:function(form,options){var _this2=this,deferred=$q.defer();options.root||(options.root="");var url=options.root+"/api/v1/login";return halClient.$post(url,options,form).then(function(login){return login.$get("member").then(function(member){return _this2.setLogin(member),deferred.resolve(member)})},function(err){return deferred.reject(err)}),deferred.promise},FBLogin:function(company,prms){var _this3=this,deferred=$q.defer();return company.$post("facebook_login",{},prms).then(function(login){return login.$get("member").then(function(member){return member=new BBModel.Member.Member(member),$sessionStorage.setItem("fb_user",!0),_this3.setLogin(member),deferred.resolve(member)},function(err){return deferred.reject(err)})},function(err){return deferred.reject(err)}),deferred.promise},companyQuery:function(id){if(id){return halClient.$get(location.protocol+"//"+location.host+"/api/v1/company/"+id).then(function(company){return company=new BBModel.Company(company)})}},memberQuery:function(params){if(params.member_id&&params.company_id){return halClient.$get(location.protocol+"//"+location.host+"/api/v1/"+params.company_id+"/members/"+params.member_id).then(function(member){return member=new BBModel.Member.Member(member)})}},ssoLogin:function(options,data){var _this4=this,deferred=$q.defer();options.root||(options.root="");var url=options.root+"/api/v1/login/sso/"+options.company_id;return halClient.$post(url,{},data).then(function(login){return login.$get("member").then(function(member){return member=new BBModel.Member.Member(member),_this4.setLogin(member,!0),deferred.resolve(member)})},function(err){return deferred.reject(err)}),deferred.promise},isLoggedIn:function(){return this.checkLogin(),$rootScope.member&&(!$rootScope.user||void 0===$rootScope.user)},setLogin:function(member,persist){var auth_token=member.getOption("auth_token");return member=new BBModel.Member.Member(member),$sessionStorage.setItem("login",member.$toStore()),$sessionStorage.setItem("auth_token",auth_token),$rootScope.member=member,persist&&($localStorage.setItem("auth_token",auth_token),$localStorage.setItem("login",member.$toStore())),member},member:function(){return this.checkLogin(),$rootScope.member},checkLogin:function(){if($rootScope.member)return!0;var member=$localStorage.getItem("login")||$sessionStorage.getItem("login");return!!member&&(member=halClient.createResource(member),$rootScope.member=new BBModel.Member.Member(member),!0)},logout:function(options){$rootScope.member=null;var deferred=$q.defer();options||(options={}),options.root||(options.root="");var url=options.root+"/api/v1/logout";return $sessionStorage.clear(),$localStorage.clear(),halClient.$del(url,options,{}).then(function(logout){return $sessionStorage.clear(),$localStorage.clear(),deferred.resolve(!0)},function(err){return deferred.reject(err)}),deferred.promise},FBLogout:function(options){return $sessionStorage.removeItem("fb_user"),this.logout(options)},sendPasswordReset:function(company,params){var deferred=$q.defer();return company.$post("email_password_reset",{},params).then(function(){return deferred.resolve(!0)},function(err){return deferred.reject(err)}),deferred.promise},updatePassword:function(member,params){var _this5=this;if(params.auth_token=member.getOption("auth_token"),member&&params.new_password&&params.confirm_new_password){var deferred=$q.defer();return member.$post("update_password",{},params).then(function(login){return login.$get("member").then(function(member){return _this5.setLogin(member,params.persist_login),deferred.resolve(member)},function(err){return deferred.reject(err)})},function(err){return deferred.reject(err)}),deferred.promise}}}}),angular.module("BB.Services").factory("MembershipLevelsService",function($q,BBModel){return{getMembershipLevels:function(company){var deferred=$q.defer();return company.$get("member_levels").then(function(resource){return resource.$get("membership_levels").then(function(membership_levels){var levels=Array.from(membership_levels).map(function(level){return new BBModel.MembershipLevel(level)});return deferred.resolve(levels)})},function(err){return deferred.reject(err)}),deferred.promise}}}),function(){var newFormCtrl=function($scope,$uibModalInstance,company,title,new_rel,post_rel,successFn,failFn,$document,$log){return $scope.loading=!0,$scope.title=title,$scope.company=company,$scope.company.$has(new_rel)?$scope.company.$get(new_rel).then(function(schema){return $scope.form=_.reject(schema.form,function(x){return"submit"===x.type}),$scope.schema=checkSchema(schema.schema),$scope.form_model={},$scope.loading=!1}):$log.warn("company does not have '"+new_rel+"' rel"),$scope.submit=function(form){return $scope.$broadcast("schemaFormValidate"),$scope.loading=!0,$scope.company.$post(post_rel,{},$scope.form_model).then(function(model){if($scope.loading=!1,$uibModalInstance.close(model),successFn)return successFn(model)},function(err){if($scope.loading=!1,$uibModalInstance.close(err),$log.error("Failed to create"),failFn)return failFn(err)})},$scope.cancel=function(event){return event.preventDefault(),event.stopPropagation(),$uibModalInstance.dismiss("cancel")}},checkSchema=function(schema){for(var k in schema.properties){var v=schema.properties[k],vals=k.split(".");"questions"===vals[0]&&vals.length>1&&(schema.properties.questions||(schema.properties.questions={type:"object",properties:{}}),schema.properties.questions.properties[vals[1]]||(schema.properties.questions.properties[vals[1]]={type:"object",properties:{answer:v}})),"client"===vals[0]&&vals.length>2&&(schema.properties.client||(schema.properties.client={type:"object",properties:{q:{type:"object",properties:{}}}}),schema.properties.client.properties&&(schema.properties.client.properties.q.properties[vals[2]]||(schema.properties.client.properties.q.properties[vals[2]]={type:"object",properties:{answer:v}})))}return schema},editFormCtrl=function($scope,$uibModal,$uibModalInstance,model,title,successFn,failFn,params,$document,$log,Dialog,FormTransform,$translate,bbTimeZone,CompanyStoreService){$scope.loading=!0,$scope.title=title,$scope.model=model,params||(params={}),$scope.model.$has("edit")?$scope.model.$get("edit",params).then(function(schema){$scope.form=_.reject(schema.form,function(x){return"submit"===x.type});var model_type=functionName(model.constructor);return"Object"===model_type&&model.type&&(model_type=model.type),FormTransform.edit[model_type]&&($scope.form=FormTransform.edit[model_type]($scope.form,schema.schema,$scope.model)),$scope.schema=checkSchema(schema.schema),$scope.form_model=$scope.model,$scope.loading=!1}):$log.warn("model does not have 'edit' rel");var functionName=function(func){var result=/^function\s+([\w\$]+)\s*\(/.exec(func.toString());return result?result[1]:""};return $scope.submit=function(form){if($scope.$broadcast("schemaFormValidate"),$scope.loading=!0,!$scope.model.$update)return $scope.model.$put("self",{},$scope.form_model).then(function(model){if($scope.loading=!1,$uibModalInstance.close(model),successFn)return successFn(model)},function(err){if($scope.loading=!1,$uibModalInstance.close(err),$log.error("Failed to create"),failFn)return failFn()});$scope.form_model.datetime=bbTimeZone.convertToCompany($scope.form_model.datetime),$scope.model.$update($scope.form_model).then(function(){if($scope.loading=!1,$uibModalInstance.close($scope.model),successFn)return successFn($scope.model)},function(err){if($scope.loading=!1,$uibModalInstance.close(err),$log.error("Failed to create"),failFn)return failFn()})},$scope.cancel=function(event){return event.preventDefault(),event.stopPropagation(),$uibModalInstance.dismiss("cancel")},$scope.success=function(response){if(event.preventDefault(),event.stopPropagation(),$uibModalInstance.close(),successFn)return successFn(response)},$scope.cancelEvent=function(event,type){if(null==type&&(type="booking"),event.preventDefault(),event.stopPropagation(),$uibModalInstance.close(),"booking"===type){return $uibModal.open({templateUrl:"cancel_booking_modal_form.html",controller:function($scope,booking){return $scope.booking=booking,$scope.model={notify:!1,cancel_reason:null}},resolve:{booking:function(){return model}}}).result.then(function(params){return model.$post("cancel",params).then(function(booking){if(successFn)return successFn(booking)})})}var question=null;return question=$translate.instant("CORE.MODAL.CANCEL_BOOKING.QUESTION",{type:type}),Dialog.confirm({model:model,title:$translate.instant("CORE.MODAL.CANCEL_BOOKING.HEADER"),body:question,success:function(model){return model.$del("self").then(function(response){if(successFn)return successFn(response)})}})}},bookFormCtrl=function($scope,$uibModalInstance,model,company,title,successFn,$document,$log){return $scope.loading=!0,$scope.title=title,$scope.model=model,$scope.company=company,$scope.model.$has("new_booking")?$scope.model.$get("new_booking").then(function(schema){return $scope.form=_.reject(schema.form,function(x){return"submit"===x.type}),$scope.schema=checkSchema(schema.schema),$scope.form_model={},$scope.loading=!1}):$log.warn("model does not have 'new_booking' rel"),$scope.submit=function(form){return $scope.$broadcast("schemaFormValidate"),form.$valid?($scope.loading=!0,$scope.company.$post("bookings",{},$scope.form_model).then(function(booking){if($scope.loading=!1,$uibModalInstance.close(booking),successFn)return successFn(booking)},function(err){if($scope.loading=!1,$uibModalInstance.close(err),$log.error("Failed to create"),fail)return fail()})):$log.warn("Invalid form")},$scope.cancel=function(event){return event.preventDefault(),event.stopPropagation(),$uibModalInstance.dismiss("cancel")}};angular.module("BB.Services").factory("ModalForm",function($uibModal){return{new:function(config){var templateUrl=void 0;return config.templateUrl&&(templateUrl=config.templateUrl),templateUrl||(templateUrl="modal_form.html"),$uibModal.open({templateUrl:templateUrl,controller:newFormCtrl,size:config.size,resolve:{company:function(){return config.company},title:function(){return config.title},new_rel:function(){return config.new_rel},post_rel:function(){return config.post_rel},successFn:function(){return config.success},failFn:function(){return config.fail}}})},edit:function(config){var templateUrl=void 0;return config.templateUrl&&(templateUrl=config.templateUrl),templateUrl||(templateUrl="modal_form.html"),$uibModal.open({templateUrl:templateUrl,controller:editFormCtrl,size:config.size,resolve:{model:function(){return config.model},title:function(){return config.title},successFn:function(){return config.success},failFn:function(){return config.fail},params:function(){return config.params||{}}}})},book:function(config){var templateUrl=void 0;return config.templateUrl&&(templateUrl=config.templateUrl),templateUrl||(templateUrl="modal_form.html"),$uibModal.open({templateUrl:templateUrl,controller:bookFormCtrl,size:config.size,resolve:{model:function(){return config.model},company:function(){return config.company},title:function(){return config.title},successFn:function(){return config.success},failFn:function(){return config.fail}}})}}})}(),angular.module("BB.Services").factory("MutexService",function($q,$window,$rootScope){return{getLock:function(prms){var mprom=$q.defer(),iprom=$q.defer();return mprom.promise.then(function(){if($rootScope.mutexes.shift(),$rootScope.mutexes.length>0){var next_mux=$rootScope.mutexes[0];return next_mux.iprom.resolve(next_mux.mprom)}}),$rootScope.mutexes&&0!==$rootScope.mutexes.length?($rootScope.mutexes.push({mprom:mprom,iprom:iprom}),iprom.promise):($rootScope.mutexes=[{mprom:mprom,iprom:iprom}],iprom.resolve(mprom),iprom.promise)},unlock:function(mutex){return mutex.resolve()}}});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};!function(angular){angular.module("BB.Services").provider("bbOptions",function(){"ngInject";function isObjectProperty(prop){return"object"===(void 0===prop?"undefined":_typeof(prop))&&!Array.isArray(prop)&&null!==prop}function setOption(options,option,value){if(guardNonExistingProperty(options,option),void 0===value)return Object.assign({},options);if(!isObjectProperty(options[option]))return guardNonObjectProps(options,option,value),angular.merge({},options,_defineProperty({},option,value));guardNonObjectValue(options,value);var guardedVal=Object.assign({},options[option]),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Object.entries(value)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _step$value=_slicedToArray(_step.value,1),key=_step$value[0];guardedVal=setOption(guardedVal,key,value[key])}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return angular.merge({},options,_defineProperty({},option,guardedVal))}function guardNonExistingProperty(options,option){if(!options.hasOwnProperty(option))throw new Error("no option named:"+option)}function guardNonObjectProps(options,option,value){if(_typeof(options[option])!==(void 0===value?"undefined":_typeof(value))||Array.isArray(options[option])!==Array.isArray(value))throw new Error('option "'+option+'" required type is "'+(Array.isArray(options[option])?"array":_typeof(options[option]))+'"')}function guardNonObjectValue(option,value){if(!isObjectProperty(value))throw new Error('option "'+option+'" must be an object')}this.setOption=setOption,this.$get=function(){return{setOption:setOption}}})}(angular),angular.module("BB.Services").factory("PackageItemService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("packages")?company.$get("packages").then(function(resource){return resource.$get("packages").then(function(package_items){return deferred.resolve(Array.from(package_items).map(function(i){return new BBModel.PackageItem(i)}))})},function(err){return deferred.reject(err)}):deferred.reject("No packages found"),deferred.promise},getPackageServices:function(package_item){var deferred=$q.defer();return package_item.$has("services")?package_item.$get("services").then(function(services){return deferred.resolve(Array.from(services).map(function(s){return new BBModel.Service(s)}))},function(err){return deferred.reject(err)}):deferred.reject("No services found"),deferred.promise}}}),angular.module("BB.Services").factory("PaginationService",function($translate){return{initialise:function(options){if(options){return{current_page:1,page_size:options.page_size,num_pages:null,max_size:options.max_size,num_items:null}}},update:function(paginator,length){if(paginator&&null!=length){paginator.num_items=length
;var start=(paginator.page_size-1)*paginator.current_page-(paginator.page_size-1-paginator.current_page),end=paginator.current_page*paginator.page_size,total=end<paginator.page_size?end:length;return end=end>total?total:end,paginator.summary=$translate.instant("CORE.PAGINATION.SUMMARY",{start:start,end:end,total:total})}},checkItems:function(paginator,items_loaded){var items_traversed=paginator.page_size*(paginator.current_page-1),remaining_items=paginator.num_items-items_loaded;return items_loaded<items_traversed+paginator.page_size&&remaining_items>0}}}),angular.module("BB.Services").factory("PathHelper",function($urlMatcherFactory,$location){return{matchRouteToPath:function(route_format,param){if(!$location.path()||!route_format)return!1;for(var parts=route_format.split("/"),match=null;parts.length>0&&!match;){var match_test=parts.join("/");match=$urlMatcherFactory.compile(match_test).exec($location.path()),parts.pop()}return match[param]?match[param]:match}}});var service=function($sce,AppConfig){"ngInject";return{directivePartial:function(fileName){if(AppConfig.partial_url){var partialUrl=AppConfig.partial_url;return $sce.trustAsResourceUrl(partialUrl+"/"+fileName+".html")}return $sce.trustAsResourceUrl(fileName+".html")}}};angular.module("BB.Services").service("PathSvc",service),angular.module("BB.Services").factory("PersonService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("people")?company.$get("people").then(function(resource){return resource.$get("people").then(function(items){var people=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;people.push(new BBModel.Person(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(people)})},function(err){return deferred.reject(err)}):deferred.reject("No people found"),deferred.promise}}}),angular.module("BB.Services").factory("ProductService",function($q,$window,halClient,UriTemplate,BBModel,$log,$rootScope){return{getProduct:function(prms){var href=void 0,uri=void 0,deferred=$q.defer();return prms.id?(href=$rootScope.bb.api_url+"/api/v1/{company_id}/products/{id}",uri=new UriTemplate(href).fillFromObject({company_id:prms.company_id,id:prms.product_id})):prms.sku?(href=$rootScope.bb.api_url+"/api/v1/{company_id}/products/find_by_sku/{sku}",uri=new UriTemplate(href).fillFromObject({company_id:prms.company_id,sku:prms.sku})):($log.warn("id or sku is required"),deferred.reject()),halClient.$get(uri,{}).then(function(product){return deferred.resolve(new BBModel.Product(product))},function(err){return deferred.reject(err)}),deferred.promise},query:function(company){var deferred=$q.defer();return company.$has("products")?company.$get("products").then(function(resource){return resource.$get("products").then(function(items){var resources=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;resources.push(new BBModel.Product(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(resources)})},function(err){return deferred.reject(err)}):deferred.reject("No products found"),deferred.promise}}}),angular.module("BB.Services").factory("PurchaseTotalService",function($q,BBModel){return{query:function(prms){var deferred=$q.defer();return prms.company.$has("total")?prms.company.$get("total",{total_id:prms.total_id}).then(function(total){return deferred.resolve(new BBModel.PurchaseTotal(total))},function(err){return deferred.reject(err)}):deferred.reject("No Total link found"),deferred.promise}}}),angular.module("BB.Services").factory("QueryStringService",function($window){return function(keyName){var varObj={},href=$window.location.href;if(!(href.indexOf("?")<0)){var hashes=href.slice(href.indexOf("?")+1).split(/[#&]/),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(hashes)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var hash=_step.value;hash=hash.split("=");var val=hash[1];val=function(num){if(null!=num&&"0"!==num.substr(0,1)&&!/[a-zA-Z\-\_\+\.\#\%\*\,]/.test(num)&&!window.isNaN(window.parseInt(num,10)))return!0}(val)?window.parseInt(val,10):"true"===val||"false"!==val&&window.decodeURIComponent(val),varObj[hash[0]]=val}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return keyName?varObj[keyName]:varObj}}}),angular.module("BB.Services").factory("QuestionService",function($window,QueryStringService,$bbug){var defaults=QueryStringService()||{};$window.bb_setup&&(!function(obj){_.each(obj,function(val,key){var date=$window.moment(obj[key]);if(_.isString(obj[key])&&date.isValid())return obj[key]=date})}($window.bb_setup),angular.extend(defaults,$window.bb_setup));var addAnswersById=function(questions){if(questions)return angular.isArray(questions)?_.each(questions,function(question){var id=question.id+"";if(!question.answer&&defaults[id])return question.answer=defaults[id]}):defaults[questions.id+""]?questions.answer=defaults[questions.id+""]:void 0},convertToSnakeCase=function(str){return str=str.toLowerCase(),str=$.trim(str),str=str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,""),str=str.replace(/\s{2,}/g," "),str=str.replace(/\s/g,"_")},addDynamicAnswersByName=function(questions){if(angular.isArray(questions)){var keys=_.keys(defaults);return _.each(questions,function(question){var name=convertToSnakeCase(question.name);return _.each(keys,function(key){(name.indexOf("_"+key)>=0||name.indexOf("_"+key+"_")>=0||name.indexOf(key+"_")>=0)&&defaults[key]&&!question.answer&&(question.answer=defaults[key],delete defaults[key])})})}},addAnswersByName=function(obj,keys){if("Object"===Object.prototype.toString.call(obj).slice(8,-1)&&angular.isArray(keys)){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(keys)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var key=_step.value;defaults[key]&&!obj[key]&&(obj[key]=defaults[key],delete defaults[key])}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}},addAnswersFromDefaults=function(questions,answers){return function(){var result=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var question=_step2.value,item=void 0,name=question.help_text;answers[name]&&(question.answer=answers[name]),answers[question.id+""]&&(item=question.answer=answers[question.id+""]),result.push(item)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result}()},storeDefaults=function(obj){return angular.extend(defaults,obj.bb_setup||{})},checkConditionalQuestions=function(questions){return function(){var result=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(questions)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var q=_step3.value,item=void 0;if(q.settings&&q.settings.conditional_question){var cond=findByQuestionId(questions,parseInt(q.settings.conditional_question));if(cond){var ans=cond.getAnswerId(),found=!1;$bbug.isEmptyObject(q.settings.conditional_answers)&&"check"===cond.detail_type&&!cond.answer&&(found=!0);for(var a in q.settings.conditional_answers){var v=q.settings.conditional_answers[a];"c"===a[0]&&1===parseInt(v)&&cond.answer?found=!0:parseInt(a)===ans&&1===parseInt(v)&&(found=!0)}item=found?q.showElement():q.hideElement()}}result.push(item)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return result}()},findByQuestionId=function(questions,qid){var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(questions)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var q=_step4.value;if(q.id===qid)return q}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return null};return{getStoredData:function(){return defaults},storeDefaults:storeDefaults,addAnswersById:addAnswersById,addAnswersByName:addAnswersByName,addDynamicAnswersByName:addDynamicAnswersByName,addAnswersFromDefaults:addAnswersFromDefaults,convertToSnakeCase:convertToSnakeCase,checkConditionalQuestions:checkConditionalQuestions}}),angular.module("BB.Services").factory("ReasonService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("reasons")?company.$get("reasons").then(function(resource){return resource.$get("reasons").then(function(items){var reasons=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value,reason=new BBModel.Reason(i);reasons.push(reason)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(reasons)})},function(err){return deferred.reject(err)}):deferred.reject("Reasons not turned on for this Company."),deferred.promise}}}),angular.module("BB.Services").factory("RecaptchaService",function($q,halClient,UriTemplate){return{validateResponse:function(params){var deferred=$q.defer(),href=params.api_url+"/api/v1/recaptcha",uri=new UriTemplate(href),prms={};return prms.response=params.response,halClient.$post(uri,{},prms).then(function(response){return deferred.resolve(response)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BB.Services").factory("ResourceService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("resources")?company.$get("resources").then(function(resource){return resource.$get("resources").then(function(items){var resources=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;resources.push(new BBModel.Resource(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(resources)})},function(err){return deferred.reject(err)}):deferred.reject("No resource found"),deferred.promise}}}),angular.module("BB.Services").factory("scrollIntercepter",function($bbug,$window,GeneralOptions,AppService,$timeout){var currentlyScrolling=!1;return{scrollToElement:function(element,transitionTime,type){"alert:raised"===type&&(currentlyScrolling=!1),currentlyScrolling||(currentlyScrolling=!0,AppService.isModalOpen()?$bbug("[uib-modal-window]").animate({scrollTop:element.offset().top-GeneralOptions.scroll_offset},transitionTime):"parentIFrame"in $window?parentIFrame.scrollToOffset(0,element.offset().top-GeneralOptions.scroll_offset):$bbug("html, body").animate({scrollTop:element.offset().top-GeneralOptions.scroll_offset},transitionTime),$timeout(function(){return currentlyScrolling=!1},transitionTime))}}}),angular.module("BB.Services").factory("ServiceService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("services")?company.$get("services").then(function(resource){return resource.$get("services").then(function(items){var services=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;services.push(new BBModel.Service(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(services)})},function(err){return deferred.reject(err)}):deferred.reject("No services found"),deferred.promise}}}),angular.module("BB.Services").factory("SlotService",function($q,BBModel){return{query:function(company,params){var deferred=$q.defer();return company.$has("slots")?(params.item&&(params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),company.$get("slots",params).then(function(resource){return resource.$get("slots",params).then(function(slots){return slots=Array.from(slots).map(function(slot){return new BBModel.Slot(slot)}),deferred.resolve(slots)})},function(err){return deferred.reject(err)})):deferred.resolve([]),deferred.promise}}}),angular.module("BB.Services").factory("SlotDates",function($q,DayService){var cached={firstSlotDate:null,timesQueried:0};return{getFirstDayWithSlots:function getFirstDayWithSlots(cItem,selected_day){var deferred=$q.defer();if(null!=cached.firstSlotDate)return deferred.resolve(cached.firstSlotDate),deferred.promise;var endDate=selected_day.clone().add(3,"month");return DayService.query({cItem:cItem,date:selected_day.format("YYYY-MM-DD"),edate:endDate.format("YYYY-MM-DD")}).then(function(days){cached.timesQueried++;var firstAvailableSlots=_.find(days,function(day){return day.spaces>0});return firstAvailableSlots?(cached.firstSlotDate=firstAvailableSlots.date,deferred.resolve(cached.firstSlotDate)):cached.timesQueried<=4?getFirstDayWithSlots(cItem,endDate).then(function(day){return deferred.resolve(cached.firstSlotDate)},function(err){return deferred.reject(err)}):deferred.reject(new Error("ERROR.NO_SLOT_AVAILABLE"))},function(err){return deferred.reject(new Error("ERROR.COULDNT_GET_AVAILABLE_DATES"))}),deferred.promise}}}),angular.module("BB.Services").config(function($provide){return $provide.decorator("$sniffer",function($delegate){var regexp=/Safari\/([\d.]+)/,result=regexp.exec(navigator.userAgent),webkit_version=result?parseFloat(result[1]):null;return _.extend($delegate,{webkit:webkit_version}),$delegate})}),angular.module("BB.Services").factory("SpaceService",function($q,BBModel){return{query:function(company){var deferred=$q.defer();return company.$has("spaces")?company.$get("spaces").then(function(resource){return resource.$get("spaces").then(function(items){var spaces=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;spaces.push(new BBModel.Space(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(spaces)})},function(err){return deferred.reject(err)}):deferred.reject("No spaces found"),deferred.promise}}}),angular.module("BB.Services").factory("SSOService",function($q,$rootScope,halClient,LoginService){return{memberLogin:function(options){var deferred=$q.defer();options.root||(options.root="");var url=options.root+"/api/v1/login/sso/"+options.company_id,data={token:options.member_sso};return halClient.$post(url,{},data).then(function(login){return login.$get("member").then(function(member){return member=LoginService.setLogin(member),deferred.resolve(member)})},function(err){return deferred.reject(err)}),deferred.promise},adminLogin:function(options){var deferred=$q.defer();options.root||(options.root="");var url=options.root+"/api/v1/login/admin_sso/"+options.company_id,data={token:options.admin_sso};return halClient.$post(url,{},data).then(function(login){return login.$get("administrator").then(function(admin){return deferred.resolve(admin)})},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BB.Services").factory("TemplateSvc",function($q,$http,$templateCache,BBModel){return{get:function(path){var deferred=$q.defer(),cacheTmpl=$templateCache.get(path);return cacheTmpl?deferred.resolve(angular.element(cacheTmpl)):$http({method:"GET",url:path}).success(function(tmpl,status){return $templateCache.put(path,tmpl),deferred.resolve(angular.element(tmpl))}).error(function(data,status){return deferred.reject(data)}),deferred.promise}}}),angular.module("BB.Services").factory("TimeService",function($q,BBModel,halClient,bbi18nOptions,CompanyStoreService,DateTimeUtilitiesService,bbTimeZone){return{query:function(prms){var _this=this,deferred=$q.defer(),start_date=null,end_date=null;if(prms.date)prms.start_date=prms.date;else{if(!prms.cItem.date)return deferred.reject("No date set"),deferred.promise;prms.start_date=prms.cItem.date.date}start_date=prms.start_date,prms.end_date&&(end_date=prms.end_date),null!=bbTimeZone.getDisplay()&&bbTimeZone.getDisplay()!==CompanyStoreService.time_zone&&(bbTimeZone.getCompanyUTCOffset()<bbTimeZone.getDisplayUTCOffset()&&!prms.cItem.defaults.datetime?start_date=prms.start_date.clone().subtract(1,"day"):bbTimeZone.getCompanyUTCOffset()>bbTimeZone.getDisplayUTCOffset()&&prms.end_date&&(end_date=prms.end_date.clone().add(1,"day")),prms.time_zone=bbTimeZone.getDisplay()),null==prms.duration&&prms.cItem&&prms.cItem.duration&&(prms.duration=prms.cItem.duration);var item_link=prms.item_link;if(prms.cItem&&prms.cItem.days_link&&!item_link&&(item_link=prms.cItem.days_link),item_link){var extra={};extra.date=start_date.toISODate(),prms.location&&(extra.location=prms.location),prms.cItem.event_id&&(extra.event_id=prms.cItem.event_id),!prms.cItem.person||prms.cItem.anyPerson()||item_link.event_id||extra.event_id||(extra.person_id=prms.cItem.person.id),!prms.cItem.resource||prms.cItem.anyResource()||item_link.event_id||extra.event_id||(extra.resource_id=prms.cItem.resource.id),end_date&&(extra.end_date=end_date.toISODate()),extra.duration=prms.duration,extra.person_group_id=prms.cItem.person_group_id,extra.num_resources=prms.num_resources,prms.time_zone&&(extra.time_zone=prms.time_zone),prms.cItem.id&&(extra.ignore_booking=prms.cItem.id),prms.people_ids&&(extra.people_ids=prms.people_ids),prms.resource_ids&&(extra.resource_ids=prms.resource_ids),extra.event_id&&(item_link=prms.company),item_link.$get("times",extra).then(function(results){var times=void 0;return results.$has("date_links")?results.$get("date_links").then(function(all_days){var all_days_def=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(all_days)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var day=_step.value;!function(day){day.elink=$q.defer(),all_days_def.push(day.elink.promise),day.$has("event_links")?day.$get("event_links").then(function(all_events){return times=_this.merge_times(all_events,prms.cItem.service,prms.cItem,day.date),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),day.elink.resolve(times)}):day.times&&(times=_this.merge_times([day],prms.cItem.service,prms.cItem,day.date),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),day.elink.resolve(times))}(day)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $q.all(all_days_def).then(function(times){var date_times={};date_times=_.chain(times).flatten().sortBy(function(slot){return slot.datetime.unix()}).groupBy(function(slot){return slot.datetime.toISODate()}).value();for(var newDateTimes={},startDateClone=prms.start_date.clone();startDateClone<=prms.end_date;){var dateISO=startDateClone.toISODate();newDateTimes[dateISO]=date_times[dateISO]?date_times[dateISO]:[],startDateClone=startDateClone.clone().add(1,"day")}return deferred.resolve(newDateTimes)})}):results.$has("event_links")?results.$get("event_links").then(function(all_events){return times=_this.merge_times(all_events,prms.cItem.service,prms.cItem,prms.start_date),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),deferred.resolve(times)}):results.times?(times=_this.merge_times([results],prms.cItem.service,prms.cItem,prms.start_date),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),deferred.resolve(times)):void 0},function(err){return deferred.reject(err)})}else deferred.reject("No day data");return deferred.promise},queryItems:function(prms){var defer=$q.defer(),pslots=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(prms.items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var item=_step2.value;pslots.push(this.query({company:prms.company,cItem:item,date:prms.start_date,end_date:prms.end_date,client:prms.client,available:1}))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return $q.all(pslots).then(function(res){return defer.resolve(res)},function(err){return defer.reject()}),defer.promise},merge_times:function(all_events,service,item,date){var i=void 0;if(!all_events||0===all_events.length)return[];all_events=_.shuffle(all_events);var sorted_times=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(all_events)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var ev=_step3.value;if(ev.times){var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(ev.times)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0)i=_step5.value,(!sorted_times[i.time]||0===sorted_times[i.time].avail||0===Math.floor(Math.random()*all_events.length)&&i.avail>0)&&(i.event_id=ev.event_id,sorted_times[i.time]=i)}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}item.held&&this.checkCurrentItem(item.held,sorted_times,ev),this.checkCurrentItem(item,sorted_times,ev)}}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}var times=[],_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(sorted_times)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)(i=_step4.value)&&(i.datetime||(i.datetime=DateTimeUtilitiesService.convertTimeToMoment(moment(date),i.time)),times.push(new BBModel.TimeSlot(i,service)))}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return times},checkCurrentItem:function(item,sorted_times,ev){return item&&item.id&&item.event_id===ev.event_id&&item.time&&!sorted_times[item.time.time]&&item.date&&item.date.date.toISODate()===ev.date?(item.time.datetime=DateTimeUtilitiesService.convertTimeToMoment(item.date.date,item.time.time),sorted_times[item.time.time]=item.time,halClient.clearCache(ev.$href("self"))):item&&item.id&&item.event_id===ev.event_id&&item.time&&sorted_times[item.time.time]&&item.date&&item.date.date.toISODate()===ev.date?sorted_times[item.time.time].avail=1:void 0}}}),angular.module("BB.Services").factory("TimeSlotService",function($q,BBModel){return{query:function(params){var defer=$q.defer();return params.company.$get("slots",params).then(function(collection){return collection.$get("slots").then(function(slots){return slots=Array.from(slots).map(function(s){return new BBModel.TimeSlot(s)}),defer.resolve(slots)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise}}}),angular.module("BB.Services").factory("UnwrapService",function($q,BBModel){return{unwrapCollection:function(model,key,resource){var models=void 0,deferred=$q.defer();return angular.isArray(resource)?(models=Array.from(resource).map(function(service){return new model(service)}),deferred.resolve(models)):resource.$has(key)?resource.$get(key).then(function(items){models=[];var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;models.push(new model(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(models)},function(err){return deferred.reject(err)}):deferred.reject(),deferred.promise},unwrapResource:function(model,resource){return new model(resource)}}}),angular.module("BB.Services").factory("BB.Service.address",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Address,resource)}}}),angular.module("BB.Services").factory("BB.Service.addresses",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Address,"addresses",resource)}}}),angular.module("BB.Services").factory("BB.Service.person",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Person,resource)}}}),angular.module("BB.Services").factory("BB.Service.people",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Person,"people",resource)}}}),angular.module("BB.Services").factory("BB.Service.resource",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Resource,resource)}}}),angular.module("BB.Services").factory("BB.Service.resources",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Resource,"resources",resource)}}}),angular.module("BB.Services").factory("BB.Service.service",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Service,resource)}}}),angular.module("BB.Services").factory("BB.Service.services",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Service,"services",resource)}}}),angular.module("BB.Services").factory("BB.Service.package_item",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.PackageItem,resource)}}}),angular.module("BB.Services").factory("BB.Service.package_items",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.PackageItem,"package_items",resource)}}}),angular.module("BB.Services").factory("BB.Service.bulk_purchase",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.BulkPurchase,resource)}}}),angular.module("BB.Services").factory("BB.Service.bulk_purchases",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.BulkPurchase,"bulk_purchases",resource)}}}),angular.module("BB.Services").factory("BB.Service.event_group",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.EventGroup,resource)}}}),angular.module("BB.Services").factory("BB.Service.event_groups",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.EventGroup,"event_groups",resource)}}}),angular.module("BB.Services").factory("BB.Service.event_chain",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.EventChain,resource)}}}),angular.module("BB.Services").factory("BB.Service.event_chains",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.EventChain,resource)}}}),angular.module("BB.Services").factory("BB.Service.category",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Category,resource)}}}),angular.module("BB.Services").factory("BB.Service.categories",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Category,"categories",resource)}}}),angular.module("BB.Services").factory("BB.Service.client",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Client,resource)}}}),angular.module("BB.Services").factory("BB.Service.child_clients",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Client,"clients",resource)}}}),angular.module("BB.Services").factory("BB.Service.clients",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Client,"clients",resource)}}}),angular.module("BB.Services").factory("BB.Service.questions",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Question,"questions",resource)}}}),angular.module("BB.Services").factory("BB.Service.question",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Question,resource)}}}),angular.module("BB.Services").factory("BB.Service.answers",function($q,BBModel,UnwrapService){return{promise:!1,unwrap:function(items){var models=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var i=_step2.value;models.push(new BBModel.Answer(i))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{
!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return{answers:models,getAnswer:function(question){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(this.answers)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var a=_step3.value;if(a.question_text===question||a.question_id===question)return a.value}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}}}}}),angular.module("BB.Services").factory("BB.Service.administrators",function($q,BBModel,UnwrapService){return{unwrap:function(items){return Array.from(items).map(function(i){return new BBModel.Admin.User(i)})}}}),angular.module("BB.Services").factory("BB.Service.company",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Company,resource)}}}),angular.module("BB.Services").factory("BB.Service.parent",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Company,resource)}}}),angular.module("BB.Services").factory("BB.Service.company_questions",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.BusinessQuestion,"company_questions",resource)}}}),angular.module("BB.Services").factory("BB.Service.company_question",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.BusinessQuestion,resource)}}}),angular.module("BB.Services").factory("BB.Service.images",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Image,"images",resource)}}}),angular.module("BB.Services").factory("BB.Service.bookings",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Member.Booking,"bookings",resource)}}}),angular.module("BB.Services").factory("BB.Service.wallet",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Member.Wallet,resource)}}}),angular.module("BB.Services").factory("BB.Service.product",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Product,resource)}}}),angular.module("BB.Services").factory("BB.Service.products",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){var deferred=$q.defer();return resource.$get("products").then(function(items){for(var models=[],index=0;index<items.length;index++){var i=items[index],cat=new BBModel.Product(i);cat.order||(cat.order=index),models.push(cat)}return deferred.resolve(models)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.pre_paid_booking",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.PrePaidBooking,resource)}}}),angular.module("BB.Services").factory("BB.Service.pre_paid_bookings",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.PrePaidBooking,"pre_paid_bookings",resource)}}}),angular.module("BB.Services").factory("BB.Service.external_purchase",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.ExternalPurchase,resource)}}}),angular.module("BB.Services").factory("BB.Service.external_purchases",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.ExternalPurchase,"external_purchases",resource)}}}),angular.module("BB.Services").factory("BB.Service.purchase_item",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.PurchaseItem,resource)}}}),angular.module("BB.Services").factory("BB.Service.purchase_items",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.PurchaseItem,"purchase_items",resource)}}}),angular.module("BB.Services").factory("BB.Service.payment_callbacks",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.PaymentCallbacks,"payment_callbacks",resource)}}}),angular.module("BB.Services").factory("BB.Service.events",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Event,"events",resource)}}}),angular.module("BB.Services").factory("BB.Service.all_children",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Service,"services",resource)}}}),angular.module("BB.Services").factory("BB.Service.child_services",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Service,"child_services",resource)}}}),angular.module("BB.Services").factory("BB.Service.items",function($q,BBModel,UnwrapService){return{promise:!0,unwrap:function(resource){return UnwrapService.unwrapCollection(BBModel.Items,"items",resource)}}}),angular.module("BB.Services").factory("BB.Service.item",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Item,resource)}}}),angular.module("BB.Services").factory("ValidatorService",function($rootScope,AlertService,CompanyStoreService,BBModel,$q,$bbug){var us_postcode_regex=/^\d{5}(?:[-\s]\d{4})?$/,uk_postcode_regex_lenient=/^[A-Z]{1,2}[0-9][0-9A-Z]?\s*[0-9][A-Z]{2}$/i,number_only_regex=/^\d+$/,uk_mobile_regex_strict=/^((\+44|0)\s*7\s*([45789](\s*\d){2}|6\s*2\s*4)(\s*\d){6})$/,mobile_regex_lenient=/^(0|\+)([\d \(\)]{9,19})$/,uk_landline_regex_strict=/^(\+44|0)\s*[1-9]\s*\d{1,4}\s*\d{3,4}\s*\d{2,4}$/,uk_landline_regex_lenient=/^(0|\+)([\d \(\)]{9,19})$/,international_number=/^(\+)([\d \(\)]{9,19})$/,email_regex=/^$|^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/i,standard_password=/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/,alphanumeric=/^[a-zA-Z0-9]*$/,geocode_result=null;return{alpha:/^[a-zA-Z\s-]*$/,us_phone_number:/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/,getEmailPattern:function(){return email_regex},getStandardPassword:function(){return standard_password},getUKPostcodePattern:function(){return uk_postcode_regex_lenient},getMailingPattern:function(){switch(CompanyStoreService.country_code){case"us":return us_postcode_regex;case"gb":return uk_postcode_regex_lenient;default:return null}},getNumberOnlyPattern:function(){return number_only_regex},getAlphaNumbericPattern:function(){return alphanumeric},getUKMobilePattern:function(strict){return null==strict&&(strict=!1),strict?uk_mobile_regex_strict:mobile_regex_lenient},getMobilePattern:function(){return mobile_regex_lenient},getUKLandlinePattern:function(strict){return null==strict&&(strict=!1),strict?uk_landline_regex_strict:uk_landline_regex_lenient},getIntPhonePattern:function(){return international_number},getGeocodeResult:function(){if(geocode_result)return geocode_result},validatePostcode:function(form,prms){if(AlertService.clear(),!form||!form.postcode)return!1;if(form.$error.required)return AlertService.raise("MISSING_POSTCODE"),!1;if(form.$error.pattern)return AlertService.raise("POSTCODE_INVALID"),!1;var deferred=$q.defer(),postcode=form.postcode.$viewValue,req={address:postcode};if(prms.region&&(req.region=prms.region),req.componentRestrictions={postalCode:req.address},prms.bounds){var sw=new google.maps.LatLng(prms.bounds.sw.x,prms.bounds.sw.y),ne=new google.maps.LatLng(prms.bounds.ne.x,prms.bounds.ne.y);req.bounds=new google.maps.LatLngBounds(sw,ne)}return(new google.maps.Geocoder).geocode(req,function(results,status){return 1===results.length&&"OK"===status?(geocode_result=results[0],deferred.resolve(!0)):(AlertService.raise("POSTCODE_INVALID"),$rootScope.$apply(),deferred.reject(!1))}),deferred.promise},validateForm:function(form){return!!form&&(form.submitted=!0,$rootScope.$broadcast("form:validated",form),form.$invalid&&form.raise_alerts&&form.alert?(AlertService.danger(form.alert),!1):form.$invalid&&form.raise_alerts?(AlertService.danger(ErrorService.getError("FORM_INVALID")),!1):!form.$invalid)},resetForm:function(form){if(form)return form.submitted=!1,form.$setPristine()},resetForms:function(forms){if(forms&&$bbug.isArray(forms))return Array.from(forms).map(function(form){return form.submitted=!1,form.$setPristine()})}}}),angular.module("BB.Services").service("viewportSize",function($window,$document,$rootScope){var viewportSize=null,isInitialised=!1,state={isXS:!1,isSM:!1,isMD:!1,isLG:!1},getSupportedSizes=function(){return["xs","sm","md","lg"]},getElementId=function(size){return"viewport_size_"+size},getViewportElementsToAppend=function(){var viewportElementStrings='<div id="viewport_size">',_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(getSupportedSizes())[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var size=_step.value;viewportElementStrings+=' <span id="'+getElementId(size)+'"  class="visible-'+size+'">&nbsp;</span>'}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return viewportElementStrings+="</div>"},appendViewportElementsToBBElement=function(){var viewportElements=getViewportElementsToAppend();$document.find("#bb").append(viewportElements)},getViewportElementsFromDocument=function(){var viewportElements=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(getSupportedSizes())[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var size=_step2.value,viewportElementId=getElementId(size),viewportElement=$document[0].querySelector("#"+viewportElementId);viewportElements.push(viewportElement)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return viewportElements},isElementVisible=function(element){return"none"!==angular.element(element).css("display")},getSizeFromElement=function(element){return element.className.match("(visible-[a-zA-Z]*)\\b")[0].replace("visible-","").trim()},findVisibleElement=function(){var viewportElements=getViewportElementsFromDocument(),_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(viewportElements)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var viewportElement=_step3.value,elementSize=getSizeFromElement(viewportElement);isElementVisible(viewportElement)?(viewportSize=elementSize,state["is"+elementSize.toUpperCase()]=!0):state["is"+elementSize.toUpperCase()]=!1}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}},listenForResize=function(){angular.element($window).resize(function(){var viewportSizeOld=viewportSize;findVisibleElement(),viewportSizeOld!==viewportSize&&$rootScope.$broadcast("viewportSize:changed")})};return{init:function(){isInitialised||(appendViewportElementsToBBElement(),findVisibleElement(),listenForResize(),isInitialised=!0)},getViewportSize:function(){return viewportSize},isXS:function(){return state.isXS},isSM:function(){return state.isSM},isMD:function(){return state.isMD},isLG:function(){return state.isLG}}}),angular.module("BB.Services").config(function($translateProvider){"ngInject";var translations={CORE:{ALERTS:{ERROR_HEADING:"Error",ACCOUNT_DISABLED:"Your account appears to be disabled. Please contact the business you're booking with if the problem persists.",ALREADY_REGISTERED:"You have already registered with this email address. Please login or reset your password.",APPT_AT_SAME_TIME:"Your appointment is already booked for this time",ATTENDEES_CHANGED:"Your booking has been successfully updated",EMAIL_IN_USE:"There's already an account registered with this email. Use the search field to find the customer's account.",EMPTY_BASKET_FOR_CHECKOUT:"You need to add some items to the basket before you can checkout.",FB_LOGIN_NOT_A_MEMBER:"Sorry, we couldn't find a login associated with this Facebook account. You will need to sign up using Facebook first",FORM_INVALID:"Please complete all required fields",GENERIC:"Sorry, it appears that something went wrong. Please try again or call the business you're booking with if the problem persists.",GEOLOCATION_ERROR:"Sorry, we could not determine your location. Please try searching instead.",GIFT_CERTIFICATE_REQUIRED:"A valid Gift Certificate is required to proceed with this booking",POSTCODE_INVALID:"@:COMMON.TERMINOLOGY.POSTCODE_INVALID",ITEM_NO_LONGER_AVAILABLE:"Sorry. The item you were trying to book is no longer available. Please try again.",NO_WAITLIST_SPACES_LEFT:"Sorry, the space has now been taken, you are still in the waitlist and we will notify you if more spaces become available",LOCATION_NOT_FOUND:"Sorry, we don't recognise that location",LOGIN_FAILED:"Sorry, your email or password was not recognised. Please try again or reset your password.",SSO_LOGIN_FAILED:"Something went wrong when trying to log you in. Please try again.",MAXIMUM_TICKETS:"Sorry, the maximum number of tickets per person has been reached.",MISSING_LOCATION:"Please enter your location",MISSING_POSTCODE:"Please enter a postcode",PASSWORD_INVALID:"Sorry, your password is invalid",PASSWORD_MISMATCH:"Your passwords don't match",PASSWORD_RESET_FAILED:"Sorry, we couldn't update your password. Please try again.",PASSWORD_RESET_REQ_FAILED:"Sorry, we didn't find an account registered with that email.",PASSWORD_RESET_REQ_SUCCESS:"We have sent you an email with instructions on how to reset your password.",PASSWORD_RESET_SUCESS:"Your password has been updated.",PAYMENT_FAILED:"We were unable to take payment. Please contact your card issuer or try again using a different card",PHONE_NUMBER_IN_USE:"There's already an account registered with this phone number. Use the search field to find the customer's account.",REQ_TIME_NOT_AVAIL:"The requested time slot is not available. Please choose a different time.",TIME_SLOT_NOT_SELECTED:"You need to select a time slot",STORE_NOT_SELECTED:"You need to select a store",TOPUP_FAILED:"Sorry, your topup failed. Please try again.",TOPUP_SUCCESS:"Your wallet has been topped up",UPDATE_FAILED:"Update failed. Please try again",UPDATE_SUCCESS:"Updated",WAITLIST_ACCEPTED:"Your booking is now confirmed!",BOOKING_CANCELLED:"Your booking has been cancelled.",NOT_BOOKABLE_PERSON:"Sorry, this person does not offer this service, please select another",NOT_BOOKABLE_RESOURCE:"Sorry, resource does not offer this service, pelase select another",SPEND_AT_LEAST:"You need to spend at least {{min_spend | pretty_price}} to make a booking.",COUPON_APPLY_FAILED:"Sorry, your coupon could not be applied. Please try again.",DEAL_APPLY_FAILED:"Sorry, your deal code could not be applied. Please try again.",DEAL_REMOVE_FAILED:"Sorry, we were unable to remove that deal. Please try again."},PAGINATION:{SUMMARY:"{{start}} - {{end}} of {{total}}"},MODAL:{CANCEL_BOOKING:{HEADER:"Cancel",QUESTION:"Are you sure you want to cancel this {{type}}?"},SCHEMA_FORM:{OK_BTN:"@:COMMON.BTN.OK",CANCEL_BTN:"@:COMMON.BTN.CANCEL"},CANCEL_BLOCK:"Cancel Block",SAVE_BLOCK:"Save Block",EDIT_BLOCK:"Edit Block",EDIT_BOOKING:"Edit Booking"},FILTERS:{DISTANCE:{MILES:"miles",KILOMETRES:"km"},CURRENCY:{THOUSANDS_SEPARATOR:",",DECIMAL_SEPARATOR:".",CURRENCY_FORMAT:"%s%v"},PRETTY_PRICE:{FREE:"@:COMMON.TERMINOLOGY.PRICE_FREE"},TIME_PERIOD:{TIME_PERIOD:"{hours, plural, =0{} one{1 hour} other{# hours}}{show_seperator, plural, =0{} =1{, } other{}}{minutes, plural, =0{} one{1 minute} other{# minutes}}"}},EVENT:{SPACES_LEFT:"Only {N, plural, one{one space}, other{# spaces}} left",JOIN_WAITLIST:"Join waitlist"}},COMMON:{TERMINOLOGY:{CATEGORY:"Category",DURATION:"Duration",RESOURCE:"Resource",PERSON:"Person",SERVICE:"Service",WALLET:"Wallet",SESSION:"Session",EVENT:"Event",EVENTS:"Events",COURSE:"Course",COURSES:"Courses",DATE:"Date",TIME:"Time",DATE_TIME:"Date/Time",WHEN:"When",GIFT_CERTIFICATE:"Gift Certificate",GIFT_CERTIFICATES:"Gift Certificates",ITEM:"Item",FILTER:"Filter",ANY:"Any",RESET:"Reset",TOTAL:"Total",TOTAL_DUE_NOW:"Total Due Now",BOOKING_FEE:"Booking Fee",PRICE:"Price",PRICE_FREE:"Free",PRINT:"Print",AND:"and",APPOINTMENT:"Appointment",TICKETS:"Tickets",TYPE:"Type",EXPORT:"Export",RECIPIENT:"Recipient",BOOKING_REF:"Booking Reference",MORNING:"Morning",AFTERNOON:"Afternoon",EVENING:"Evening",AVAILABLE:"Available",UNAVAILABLE:"Unavailable",CALENDAR:"Calendar",QUESTIONS:"Questions",BOOKING:"Booking",ADMITTANCE:"Admittance",EDIT:"Edit",CONFIRMATION:"Confirmation",NAME:"Name",FIRST_NAME:"First Name",LAST_NAME:"Last Name",ADDRESS1:"Address",ADDRESS3:"Town",ADDRESS4:"County",POSTCODE:"Postcode",PHONE:"Phone",MOBILE:"Mobile",EMAIL:"Email",SCHEDULE:"Schedule",SEARCH:"Search",STAFF:"Staff",RESOURCES:"Resources"},FORM:{FIRST_NAME_REQUIRED:"Please enter your first name",LAST_NAME_REQUIRED:"Please enter your last name",ADDRESS_REQUIRED:"Please enter your address",POSTCODE_INVALID:"Please enter a valid postcode",PHONE_INVALID:"Please enter a valid phone number",MOBILE_INVALID:"Please enter a valid mobile number",EMAIL_REQUIRED:"Please enter your email",EMAIL_INVALID:"Please enter a valid email address",FIELD_REQUIRED:"This field is required",PASSWORD:"Password",PASSWORD_REQUIRED:"Please enter your password",CONFIRM_PASSWORD:"Confirm password",PASSWORD_MISMATCH:"Please ensure your passwords match",PASSWORD_LENGTH:"Password must be at least 7 characters",REQUIRED:"*Required",INVALID:"Invalid",TERMS_AND_CONDITIONS:"I agree to the terms and conditions",TERMS_AND_CONDITIONS_REQUIRED:"Please accept the terms and conditions"},BTN:{CANCEL:"Cancel",CLOSE:"Close",NO:"No",OK:"Ok",YES:"Yes",BACK:"Back",NEXT:"Continue",LOGIN:"Login",CONFIRM:"Confirm",SAVE:"Save",SELECT:"Select",BOOK:"Book",BOOK_EVENT:"Book Event",CANCEL_BOOKING:"Cancel Booking",MOVE_BOOKING:"Move Booking",SAVE_BOOKING:"Save Booking",EDIT_BOOKING:"Edit Booking",DO_NOT_CANCEL_BOOKING:"Do not cancel",APPLY:"Apply",CLEAR:"Clear",PAY:"Pay",CHECKOUT:"Checkout",TOP_UP:"Top Up",ADD:"Add",SUBMIT:"Submit",DETAILS:"Details",MORE:"More",LESS:"Less",DELETE:"Delete",BUY:"Buy",EDIT_CLIENT:"Edit Client"},LANGUAGE:{EN:"English",DE:"Deutsch",ES:"Español",FR:"Français"}}};$translateProvider.translations("en",translations)}),function(){function uiSelectChoicesLazyLoadDirective($timeout,$parse,$compile,$document,$filter){return function(scope,elm,attr){var raw,refreshCallBack,scrollCompleted;if(scope.$on("UISelect:closeSelect",function(){return scope.$select.close()}),raw=elm[0],scrollCompleted=!0,!attr.allChoices)throw new Error("ief:ui-select: Attribute all-choices is required in ui-select-choices so that we can handle pagination.");scope.pagingOptions={allOptions:scope.$eval(attr.allChoices)},attr.refresh="addMoreItems()",refreshCallBack=$parse(attr.refresh),elm.bind("scroll",function(event){var callback,percent,remainingHeight,scrollTop;remainingHeight=raw.offsetHeight-raw.scrollHeight,scrollTop=raw.scrollTop,(percent=Math.abs(scrollTop/remainingHeight*100))>=80&&scrollCompleted&&(scrollCompleted=!1,event.preventDefault(),event.stopPropagation(),callback=function(){scope.addingMore=!0,refreshCallBack(scope,{$event:event}),scrollCompleted=!0},$timeout(callback,100))}),scope.addMoreItems=function(doneCalBack){var $select,allItems,i,itemsThreshold,k,moreItems,pagingOptions,ref,search,searchDidNotChange;for($select=scope.$select,allItems=scope.pagingOptions.allOptions,moreItems=[],itemsThreshold=100,search=$select.search,pagingOptions=$select.pagingOptions=$select.pagingOptions||{page:0,pageSize:20,items:$select.items},0===pagingOptions.page&&(pagingOptions.items.length=0),pagingOptions.originalAllItems||(pagingOptions.originalAllItems=scope.pagingOptions.allOptions),searchDidNotChange=search&&pagingOptions.prevSearch&&search===pagingOptions.prevSearch,pagingOptions.filteredItems&&searchDidNotChange&&(allItems=pagingOptions.filteredItems),pagingOptions.prevSearch=search,search&&search.length>0&&pagingOptions.items.length<allItems.length&&!searchDidNotChange&&(pagingOptions.filteredItems=null,moreItems=$filter("filter")(pagingOptions.originalAllItems,search),moreItems.length>itemsThreshold?(pagingOptions.filteredItems||(pagingOptions.page=0,pagingOptions.items.length=0),pagingOptions.page=0,pagingOptions.items.length=0,allItems=pagingOptions.filteredItems=moreItems):(allItems=moreItems,pagingOptions.items.length=0,pagingOptions.filteredItems=null)),pagingOptions.page++,moreItems=pagingOptions.page*pagingOptions.pageSize<allItems.length?allItems.slice(pagingOptions.items.length,pagingOptions.page*pagingOptions.pageSize):allItems,k=i=0,ref=moreItems.length;0<=ref?i<ref:i>ref;k=0<=ref?++i:--i)-1===pagingOptions.items.indexOf(moreItems[k])&&pagingOptions.items.push(moreItems[k]);if(scope.calculateDropdownPos(),scope.$broadcast("uis:refresh"),doneCalBack)return doneCalBack()},scope.$on("$destroy",function(){elm.off("scroll")}),scope.$watch(attr.allChoices,function(newValue,oldValue){newValue.length!==oldValue.length&&(scope.pagingOptions.allOptions=newValue,scope.addMoreItems())})}}angular.module("BB.uiSelect").directive("uiSelectChoicesLazyload",uiSelectChoicesLazyLoadDirective)}(),function(){function uiSelectChoicesListenerDirective(){return function(scope,elm,attr){scope.$on("UISelect:closeSelect",function(){return scope.$select.close()})}}angular.module("BB.uiSelect").directive("uiSelectChoicesListener",uiSelectChoicesListenerDirective)}(),angular.module("BB.uib").run(function($document,runtimeUibModal){"ngInject";var setUibModalDefaults=function(){runtimeUibModal.options.appendTo=angular.element($document[0].getElementById("bb"))};!function(){setUibModalDefaults()}()}),function(angular){function BBAnalyticsPiwikProvider($analyticsProvider,$windowProvider){"ngInject";var _this=this,options={firstPageView:!1,virtualPageViews:!1,enableLinkTracking:!0,trackPageView:!1,siteId:1,trackerUrl:"https://analytics.bookingbug.com/piwik.php",scriptUrl:"https://analytics.bookingbug.com/piwik.js"},$window=$windowProvider.$get(),enabled=!1;this.isEnabled=function(){return enabled},this.push=function(data){if(this.isEnabled()){var _paq=[];$window._paq?_paq=$window._paq:$window._paq=_paq,_paq.push(data)}},this.setOption=function(option,value){options.hasOwnProperty(option)&&(options[option]=value)},this.getOption=function(option){return options.hasOwnProperty(option)?options[option]:null},this.enable=function(){enabled=!0,$analyticsProvider.virtualPageviews(options.virtualPageViews),$analyticsProvider.firstPageview(options.firstPageView),options.trackPageView&&_this.push(["trackPageView"]),options.enableLinkTracking&&_this.push(["enableLinkTracking"]),_this.push(["setTrackerUrl",options.trackerUrl]),_this.push(["setSiteId",options.siteId]);var piwikScript=$window.document.createElement("script");piwikScript.type="text/javascript",piwikScript.async=!0,piwikScript.defer=!0,piwikScript.src=options.scriptUrl;var firstScript=$window.document.getElementsByTagName("script")[0];firstScript.parentNode.insertBefore(piwikScript,firstScript)},this.$get=function(){return{getOption:_this.getOption,isEnabled:_this.isEnabled,push:_this.push}}}angular.module("BB.analytics").provider("bbAnalyticsPiwik",BBAnalyticsPiwikProvider)}(angular),function(){angular.module("BB.Directives").directive("appVersion",function(version){return function(scope,elm,attrs){elm.text(version)}})}(),angular.module("BB.Directives").directive("autofocus",function($timeout){return{restrict:"A",link:function(scope,element,attr){return $timeout(function(){if(""===attr.autofocus||scope.$eval(attr.autofocus))return element[0].focus()})}}}),angular.module("BB.Directives").directive("bbAccordionGroup",function(){return{require:"^accordion",restrict:"EA",transclude:!0,replace:!1,templateUrl:"accordion-group.html",scope:{heading:"@",isOpen:"=?",isDisabled:"=?"},controller:function(){this.setHeading=function(element){this.heading=element}},link:function(scope,element,attrs,accordionCtrl){accordionCtrl.addGroup(scope),scope.$watch("isOpen",function(value){value&&accordionCtrl.closeOthers(scope)}),scope.toggleOpen=function(){scope.isDisabled||(scope.isOpen=!scope.isOpen)}}}}).directive("bbAccordionHeading",function(){return{restrict:"EA",transclude:!0,template:"",replace:!0,require:"^bbAccordionGroup",link:function(scope,element,attr,accordionGroupCtrl,transclude){accordionGroupCtrl.setHeading(transclude(scope,function(){}))}}}).directive("bbAccordionTransclude",function(){return{require:"^bbAccordionGroup",link:function(scope,element,attr,controller){scope.$watch(function(){return controller[attr.bbAccordionTransclude]},function(heading){heading&&(element.html(""),element.append(heading))})}}}),function(){function accordionRangeGroupController($scope,$rootScope,DateTimeUtilitiesService,$translate,CompanyStoreService,bbTimeZone){"ngInject";$scope.$watch("slots",function(){return setData()}),$rootScope.connection_started.then(function(){return $scope.init()}),$scope.init=function(){return $scope.start_time=$scope.options.range[0],$scope.end_time=$scope.options.range[1],$scope.options.collapse_when_time_selected=!_.isBoolean($scope.options.collapse_when_time_selected)||$scope.options.collapse_when_time_selected,$scope.options.hide_availability_summary=!!_.isBoolean($scope.options.hide_availability_summary)&&$scope.options.hide_availability_summary,$scope.heading=$translate.instant($scope.options.heading),setData()};var setData=function(){if($scope.accordion_slots=[],$scope.is_open=$scope.is_open||!1,$scope.has_availability=$scope.has_availability||!1,$scope.is_selected=$scope.is_selected||!1,$scope.slots)return angular.forEach($scope.slots,function(slot){var slot_time=void 0,displayTimeZone=bbTimeZone.getDisplay();if(null!=displayTimeZone&&displayTimeZone!==CompanyStoreService.time_zone){var datetime=moment(slot.datetime).tz(displayTimeZone);slot_time=DateTimeUtilitiesService.convertMomentToTime(datetime)}else slot_time=slot.time;if(slot_time>=$scope.start_time&&slot_time<$scope.end_time&&1===slot.avail)return $scope.accordion_slots.push(slot)}),updateAvailability()},updateAvailability=function(day,slot){if($scope.selected_slot=null,$scope.accordion_slots&&($scope.has_availability=hasAvailability()),$scope.disabled_slot&&$scope.disabled_slot.time&&$scope.disabled_slot.date===$scope.day.date.toISODate()){var relevent_slot=void 0;if(Array.isArray($scope.disabled_slot.time)){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.disabled_slot.time)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var times=_step.value;relevent_slot=_.findWhere($scope.slots,{time:times}),relevent_slot&&(relevent_slot.disabled=!0)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}else(relevent_slot=_.findWhere($scope.slots,{time:$scope.disabled_slot.time}))&&(relevent_slot.disabled=!0)}if(day&&slot){var slot_time=void 0,displayTimeZone=bbTimeZone.getDisplay();if(null!=displayTimeZone&&displayTimeZone!==CompanyStoreService.time_zone){var datetime=moment(slot.datetime).tz(displayTimeZone);slot_time=DateTimeUtilitiesService.convertMomentToTime(datetime)}else slot_time=slot.time;day.date.isSame($scope.day.date,"day")&&slot_time>=$scope.start_time&&slot_time<$scope.end_time&&($scope.selected_slot=slot)}else{var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.accordion_slots)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)if(slot=_step2.value,slot.selected){$scope.selected_slot=slot;break}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}if($scope.selected_slot){if($scope.hideHeading=!0,$scope.is_selected=!0,$scope.options.collapse_when_time_selected)return $scope.is_open=!1}else if($scope.is_selected=!1,$scope.options.collapse_when_time_selected)return $scope.is_open=!1},hasAvailability=function(){if(!$scope.accordion_slots)return!1;var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.accordion_slots)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){if(_step3.value.availability()>0)return!0}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return!1};return $scope.$on("slotChanged",function(event,day,slot){return day&&slot?updateAvailability(day,slot):updateAvailability()})}angular.module("BB.Controllers").controller("AccordionRangeGroup",accordionRangeGroupController)}(),angular.module("BB.Directives").directive("bbAccordionRangeGroup",function(PathSvc){return{restrict:"AE",replace:!1,scope:{day:"=",slots:"=",selectSlot:"=",disabled_slot:"=disabledSlot"},controller:"AccordionRangeGroup",link:function(scope,elem,attrs){return scope.options=scope.$eval(attrs.bbAccordionRangeGroup)||{}},templateUrl:function(elem,attrs){return PathSvc.directivePartial("_accordion_range_group")}}}),angular.module("BB.Controllers").controller("AddressList",function($scope,$rootScope,$filter,$sniffer,FormDataStoreService,LoadingService,BBModel){$scope.manual_postcode_entry=!1;var loader=LoadingService.$loader($scope);return FormDataStoreService.init("AddressList",$scope,["show_complete_address"]),$rootScope.connection_started.then(function(){if($scope.client.postcode&&!$scope.bb.postcode&&($scope.bb.postcode=$scope.client.postcode),$scope.client.postcode&&$scope.bb.postcode&&$scope.client.postcode===$scope.bb.postcode&&!$scope.bb.address1&&($scope.bb.address1=$scope.client.address1,$scope.bb.address2=$scope.client.address2,$scope.bb.address3=$scope.client.address3,$scope.bb.address4=$scope.client.address4,$scope.bb.address5=$scope.client.address5),$scope.manual_postcode_entry=!$scope.bb.postcode,$scope.show_complete_address=!!$scope.bb.address1,!$scope.postcode_submitted)return $scope.findByPostcode(),$scope.postcode_submitted=!1},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.findByPostcode=function(){if($scope.postcode_submitted=!0,$scope.bb.postcode)return loader.notLoaded(),BBModel.Address.$query({company:$scope.bb.company,post_code:$scope.bb.postcode}).then(function(response){var addressArr=void 0;if(addressArr=angular.isArray(response)?_.map(response,function(item,i){return{address:item.partialAddress,moniker:item.moniker}}):[{address:response.partialAddress,moniker:response.moniker}],1===addressArr.length&&$sniffer.msie){var newaddr=[];newaddr.push(addressArr[0]),newaddr.push({address:""}),addressArr=newaddr}$scope.addresses=addressArr,$scope.bb.address=addressArr[0],
$scope.client.address=addressArr[0],loader.setLoaded()},function(err){return $scope.show_complete_address=!0,$scope.postcode_submitted=!0,loader.setLoaded()})},$scope.showCompleteAddress=function(){if($scope.show_complete_address=!0,$scope.postcode_submitted=!1,$scope.bb.address&&$scope.bb.address.moniker)return loader.notLoaded(),BBModel.Address.$getAddress({company:$scope.bb.company,id:$scope.bb.address.moniker}).then(function(response){var address2=void 0,address3=void 0,addressLine2=void 0,streetName=void 0,address=response,house_number="";if("string"==typeof address.buildingNumber?house_number=address.buildingNumber:null==address.buildingNumber&&(house_number=address.buildingName),"string"==typeof address.streetName?(streetName=address.streetName?address.streetName:"",$scope.bb.address1=house_number+" "+streetName):(addressLine2=address.addressLine2?address.addressLine2:"",$scope.bb.address1=house_number+" "+addressLine2),address.buildingName&&null==address.buildingNumber&&($scope.bb.address1=house_number,$scope.bb.address2=address.streetName,null!=address.county&&($scope.bb.address4=address.county)),"string"==typeof address.buildingNumber&&"string"==typeof address.buildingName&&"string"==typeof address.streetName&&(streetName=address.streetName?address.streetName:"",$scope.bb.address1=address.buildingName,$scope.bb.address2=address.buildingNumber+" "+streetName),null!=address.buildingName&&address.buildingName.match(/(^[^0-9]+$)/)){var building_number=address.buildingNumber?address.buildingNumber:"";$scope.bb.address1=address.buildingName+" "+building_number,$scope.bb.address2=address.streetName}null==address.buildingNumber&&null==address.streetName&&($scope.bb.address1=address.buildingName,$scope.bb.address2=address.addressLine3,$scope.bb.address4=address.town),null!=address.companyName&&($scope.bb.address1=address.companyName,null==address.buildingNumber&&null==address.streetName?$scope.bb.address2=address.addressLine3:null==address.buildingNumber?(address2=address.buildingName?address.buildingName+", "+address.streetName:address.streetName,$scope.bb.address2=address2):null==address.buildingName&&null==address.addressLine2?$scope.bb.address2=address.buildingNumber+", "+address.streetName:$scope.bb.address2=address.buildingName,$scope.bb.address3=address.buildingName,address3=address.addressLine3&&null!=address.buildingNumber?address.addressLine3:null==address.addressLine2&&null!=address.buildingNumber?address.buildingNumber+" "+address.streetName:null==address.addressLine2&&null==address.buildingNumber&&null!=address.buildingName?address.addressLine3:"",$scope.bb.address3=address3,$scope.bb.address4=address.town,$scope.bb.address5="",$scope.bb.postcode=address.postCode),null==address.buildingName&&null==address.companyName&&null==address.county?(address2=null==address.addressLine2&&null==address.companyName?address.addressLine3:address.addressLine2,$scope.bb.address2=address2):null==address.buildingName&&null==address.companyName&&($scope.bb.address2=address.addressLine3),null!=address.buildingName&&null!=address.streetName&&null==address.companyName&&null!=address.addressLine3?null==address.addressLine3?$scope.bb.address3=address.buildingName:$scope.bb.address3=address.addressLine3:null==address.buildingName&&null==address.companyName&&null!=address.addressLine2?$scope.bb.address3=address.addressLine3:null==address.buildingName&&null!=address.streetName&&null==address.addressLine3&&($scope.bb.address3=address.addressLine3),$scope.bb.address4=address.town,null!=address.county&&($scope.bb.address5=address.county),loader.setLoaded()},function(err){return $scope.show_complete_address=!0,$scope.postcode_submitted=!1,loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.setManualPostcodeEntry=function(value){return $scope.manual_postcode_entry=value},$scope.$on("client_details:reset_search",function(event){return $scope.bb.address1=null,$scope.bb.address2=null,$scope.bb.address3=null,$scope.bb.address4=null,$scope.bb.address5=null,$scope.show_complete_address=!1,$scope.postcode_submitted=!1,$scope.bb.address=$scope.addresses[0]})}),angular.module("BB.Directives").directive("bbAddresses",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"AddressList"}}),angular.module("BB.Directives").directive("bbAttendees",function(){return{restrict:"AE",replace:!0,scope:!0,controller:function($scope,$rootScope,$q,PurchaseService,AlertService,ValidatorService,LoadingService,BBModel){var loader=LoadingService.$loader($scope);$rootScope.connection_started.then(function(){return initialise()});var initialise=function(){return $scope.items=$scope.bb.basket.timeItems()},updateBooking=function(){var deferred=$q.defer(),params={purchase:$scope.bb.moving_purchase,bookings:$scope.bb.basket.items,notify:!0};return PurchaseService.update(params).then(function(purchase){return $scope.bb.purchase=purchase,loader.setLoaded(),$scope.bb.current_item.move_done=!0,$rootScope.$broadcast("booking:updated"),deferred.resolve()},function(err){return deferred.reject()}),deferred.promise};return $scope.markItemAsChanged=function(item){return item.attendee_changed=!0},$scope.changeAttendees=function(){if(!$scope.bb.current_item.ready||!$scope.bb.moving_purchase)return!1;var deferred=$q.defer();loader.notLoaded();var client_promises=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;if(item.attendee_changed){var client=new BBModel.Client;client.first_name=item.first_name,client.last_name=item.last_name,client_promises.push(BBModel.Client.$create_or_update($scope.bb.company,client))}else client_promises.push($q.when([]))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $q.all(client_promises).then(function(result){for(var index=0;index<$scope.items.length;index++)item=$scope.items[index],result[index]&&result[index].id&&(item.client_id=result[index].id);return updateBooking().then(function(){return $scope.$parent.$has_page_control?deferred.resolve():($scope.decideNextPage("purchase"),AlertService.raise("ATTENDEES_CHANGED"),deferred.resolve())},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})}),deferred.promise},$scope.setReady=function(){return $scope.changeAttendees()}}}}),angular.module("BB.Controllers").controller("Breadcrumbs",function($scope){var loadStep=$scope.loadStep;$scope.steps=$scope.bb.steps,$scope.allSteps=$scope.bb.allSteps,$scope.loadStep=function(number){if(!lastStep()&&!currentStep(number)&&!atDisablePoint())return loadStep(number)};var lastStep=function(){return $scope.bb.current_step===$scope.bb.allSteps.length},currentStep=function(step){return step===$scope.bb.current_step},atDisablePoint=function(){return!!angular.isDefined($scope.bb.disableGoingBackAtStep)&&$scope.bb.current_step>=$scope.bb.disableGoingBackAtStep};return $scope.isDisabledStep=function(step){return!(!lastStep()&&!currentStep(step.number)&&step.passed&&!atDisablePoint())}}),angular.module("BB.Directives").directive("bbBreadcrumbs",function(PathSvc){return{restrict:"A",replace:!0,scope:!0,controller:"Breadcrumbs",templateUrl:function(element,attrs){return _.has(attrs,"complex")?PathSvc.directivePartial("_breadcrumb_complex"):PathSvc.directivePartial("_breadcrumb")},link:function(scope){}}}),angular.module("BB.Directives").directive("bbContentNew",function(PathSvc){return{restrict:"A",replace:!0,scope:!0,templateUrl:PathSvc.directivePartial("content_main"),controller:function($scope){$scope.initPage=function(){return $scope.$eval("setPageLoaded()")}}}}),angular.module("BB.Controllers").controller("CustomBookingText",function($scope,$rootScope,$q,CustomTextService,LoadingService){var loader=LoadingService.$loader($scope).notLoaded();return $rootScope.connection_started.then(function(){return CustomTextService.BookingText($scope.bb.company,$scope.bb.current_item).then(function(msgs){return $scope.messages=msgs,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})}),angular.module("BB.Directives").directive("bbCustomBookingText",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CustomBookingText"}}),angular.module("BB.Controllers").controller("CustomConfirmationText",function($scope,$rootScope,CustomTextService,$q,LoadingService){var loader=LoadingService.$loader($scope).notLoaded();return $rootScope.connection_started.then(function(){return $scope.loadData()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.loadData=function(){return $scope.total?CustomTextService.confirmationText($scope.bb.company,$scope.total).then(function(msgs){return $scope.messages=msgs,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):$scope.loadingTotal?$scope.loadingTotal.then(function(total){return CustomTextService.confirmationText($scope.bb.company,total).then(function(msgs){return $scope.messages=msgs,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):loader.setLoaded()}}),angular.module("BB.Directives").directive("bbCustomConfirmationText",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CustomConfirmationText"}}),function(){function bbDateTimePickerDirective(){return{scope:{date:"=",showMeridian:"=?",minuteStep:"=?",minDate:"=?",maxDate:"=?",format:"=?",dateOnly:"=?",bbDisabled:"=?"},restrict:"A",templateUrl:"bb_date_time_picker.html",controller:function($scope,GeneralOptions){null==$scope.format&&($scope.format="dd/MM/yyyy"),null==$scope.bbDisabled&&($scope.bbDisabled=!1),$scope.minuteStep&&void 0!==$scope.minuteStep||($scope.minuteStep=GeneralOptions.calendar_minute_step),$scope.showMeridian&&void 0!==$scope.showMeridian||($scope.showMeridian=GeneralOptions.twelve_hour_format),$scope.$watch("datetimeWithNoTz",function(newValue,oldValue){if(null!=newValue&&moment(newValue).isValid()&&newValue.getTime()!==oldValue.getTime()){var assembledDate=moment();return assembledDate.set({year:parseInt(newValue.getFullYear()),month:parseInt(newValue.getMonth()),date:parseInt(newValue.getDate()),hour:parseInt(newValue.getHours()),minute:parseInt(newValue.getMinutes()),second:0,milliseconds:0}),$scope.date=assembledDate}});var clearTimezone=function(date){if(null!=date&&moment(date).isValid()){date=moment(date);var newDate=new Date;return newDate.setFullYear(date.year()),newDate.setMonth(date.month()),newDate.setDate(date.date()),newDate.setHours(date.hours()),newDate.setMinutes(date.minutes()),newDate.setSeconds(0),newDate.setMilliseconds(0),newDate}};return $scope.datetimeWithNoTz=clearTimezone($scope.date),$scope.$watch("date",function(newValue,oldValue){if(newValue!==oldValue&&clearTimezone(newValue)!==oldValue)return $scope.datetimeWithNoTz=clearTimezone(newValue)}),$scope.$watch("minDate",function(newValue,oldValue){if(newValue!==oldValue)return $scope.minDateClean=clearTimezone(newValue)}),$scope.$watch("maxDate",function(newValue,oldValue){if(newValue!==oldValue)return $scope.maxDateClean=clearTimezone(newValue)}),$scope.minDateClean=clearTimezone($scope.minDate),$scope.maxDateClean=clearTimezone($scope.maxDate)}}}angular.module("BB.Directives").directive("bbDateTimePicker",bbDateTimePickerDirective)}(),angular.module("BB.Directives").directive("bbDatepickerPopup",function($parse,$document,$timeout,$bbug,CompanyStoreService,viewportSize){var ie8orLess=!1;try{ie8orLess=window.parseInt(/MSIE\s*(\d)/.exec(window.navigator.userAgent)[1])}catch(e){ie8orLess=!1}return{restrict:"A",priority:-1,require:"ngModel",link:function(scope,element,attrs,ngModel){var format=void 0,replacementDateParser=void 0,origDateParser=null,data=element.controller("ngModel");null!=attrs.uibDatepickerPopup&&(format={date_us:"MM/dd/yyyy",date_uk:"dd/MM/yyyy"},"us"===CompanyStoreService.country_code?attrs.uibDatepickerPopup=format.date_us:attrs.uibDatepickerPopup=format.date_uk);var dateFormat=attrs.bbDatepickerPopup?attrs.bbDatepickerPopup:"DD/MM/YYYY",yearNow=moment(new Date).year(),getter=$parse(attrs.ngModel),timeRangeScope=scope;!function getTimeRangeScope(scope){if(scope)return scope.controller&&scope.controller.indexOf("TimeRangeList")>0?timeRangeScope=scope:getTimeRangeScope(scope.$parent)}(scope),ie8orLess&&$bbug(element).on("keydown keyup keypress",function(ev){return ev.preventDefault(),ev.stopPropagation()}),(ie8orLess||viewportSize.isXS())&&$bbug(element).attr("readonly","true"),$bbug(element).on("keydown",function(e){if(13===e.keyCode)return replacementDateParser($bbug(e.target).val(),!0),$document.trigger("click"),$bbug(element).blur()}),$bbug(element).on("click",function(e){return e.preventDefault(),e.stopPropagation(),$timeout(function(){return scope.opened=!0})}),$bbug(element).on("focus",function(){if($(this).attr("readonly"))return this.blur()});var callDateHandler=function(date){var watch=scope.$watch(getter,function(newVal,oldVal){if(!newVal)return getter.assign(timeRangeScope,date)});$timeout(watch,0);var selectedMoment=new moment(date,dateFormat),selectedDate=new Date(selectedMoment.format("MM/DD/YYYY")),isDate=_.isDate(selectedDate);return isDate&&(getter.assign(timeRangeScope,selectedDate),ngModel.$setValidity("date",!0),scope.$eval(attrs.onDateChange)),isDate};replacementDateParser=function(viewValue,returnKey){if(callDateHandler(viewValue))return viewValue;if(ie8orLess)return viewValue;var mDate=moment(viewValue,dateFormat);return mDate.isValid()||(mDate=moment(new Date)),/\/YY$/.test(dateFormat)&&(dateFormat+="YY"),0===mDate.year()&&mDate.year(yearNow),viewValue=mDate.format("MM/DD/YYYY"),viewValue=viewValue.replace(/\/00/,"/20"),/\/02\d{2}$/.test(viewValue)?void 0:returnKey?(2===mDate.year().toString().length&&mDate.year(mDate.year()+2e3),callDateHandler(mDate._d)):origDateParser.call(this,viewValue)};!function f(){if(_.isFunction(data.$parsers[0]))return origDateParser=data.$parsers[0],void(data.$parsers[0]=replacementDateParser);setTimeout(f,10)}()}}}),angular.module("BB.Directives").directive("bbFbLogin",function(LoginService,$rootScope,AlertService,$window){return{restrict:"A",scope:!0,link:function(scope,element,attrs){var options=scope.$eval(attrs.bbFbLogin)||{};$rootScope.connection_started.then(function(){return checkLoginState()});var statusChangeCallback=function(response){if("connected"===response.status){var params={};params.access_token=response.authResponse.accessToken,options.login_only&&(params.login_only=options.login_only),loginToBBWithFBUser(params)}else response.status,scope.loginFB()},checkLoginState=function(){FB.getLoginStatus(function(response){statusChangeCallback(response)})},loginToBBWithFBUser=function(params){return LoginService.FBLogin(scope.bb.company,params).then(function(member){return $rootScope.member=member,scope.setClient($rootScope.member),scope.bb.destination?scope.redirectTo(scope.bb.destination):(scope.setLoaded(scope),scope.decideNextPage())},function(err){return"FACEBOOK-LOGIN-MEMBER-NOT-FOUND"===err.data.error?AlertService.raise("FB_LOGIN_NOT_A_MEMBER"):AlertService.raise("LOGIN_FAILED")})};return scope.loginFB=function(){return FB.login(function(response){if("connected"===response.status){var params={};params.access_token=response.authResponse.accessToken,options.login_only&&(params.login_only=options.login_only),loginToBBWithFBUser(params)}else response.status,AlertService.raise("LOGIN_FAILED")},{scope:"public_profile,email"})}}}}),angular.module("BB.Controllers").controller("FileUpload",function($scope,Upload){return $scope.uploadFile=function(item,file,err_files,existing){$scope.err_file=err_files&&err_files[0],$scope.show_error=!1,$scope.file_type_error=!1,$scope.my_file=file;var accepted_files=$scope.accept.replace(/\'/g,"").split(","),file_is_valid=file&&(0<=accepted_files.indexOf(file.type)||0<=file.type.indexOf("image"));if(file_is_valid){var att_id=void 0;att_id=existing||null;var method="POST";att_id&&(method="PUT");var url=item.$href("add_attachment"),onSuccess=function(response){return file.result=response.data,item.attachment=response.data,item.attachment_id=response.data.id,file.progress=100},onError=function(response){return $scope.show_error=!0,file.progress=100},onProgress=function(evt){return file.progress=Math.min(100,parseInt(99*evt.loaded/evt.total))};return Upload.rename(file,file.name.replace(/[^\x00-\x7F]/g,"")),file.upload=Upload.upload({url:url,method:method,data:{attachment_id:att_id},file:file}),file.upload.then(onSuccess,onError,onProgress)}if(!1===file_is_valid)return $scope.file_type_error=!0}}),angular.module("BB.Directives").directive("bbFileUpload",function(){return{restrict:"A",replace:!1,scope:{accept:"@",prettyAccept:"@",maxSize:"@",item:"="},controller:"FileUpload",templateUrl:"file_upload.html"}}),angular.module("BB.Directives").directive("bbFormDataStore",function(FormDataStoreService){return{require:"?bbWidget",link:function(scope){return FormDataStoreService.register(scope)}}}),angular.module("BB.Controllers").controller("GetAvailability",function($scope,$element,$attrs,$rootScope,$q,TimeService,AlertService,BBModel,halClient){return $scope.loadAvailability=function(prms){return halClient.$get($scope.bb.api_url+"/api/v1/"+prms.company_id+"/services/"+prms.service).then(function(serv){$scope.earliest_day=null;var sday=moment(),eday=moment().add(30,"days");return serv.$get("days",{date:sday.toISOString(),edate:eday.toISOString()}).then(function(res){return function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(res.days)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var day=_step.value,item=void 0;day.spaces>0&&!$scope.earliest_day&&($scope.earliest_day=moment(day.date),day.first&&(item=$scope.earliest_day.add(day.first,"minutes"))),result.push(item)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}()})})}}),angular.module("BB.Directives").directive("bbGetAvailability",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"GetAvailability",link:function(scope,element,attrs){attrs.bbGetAvailability&&scope.loadAvailability(scope.$eval(attrs.bbGetAvailability))}}}),angular.module("BB.Directives").directive("bbIntTelNumber",function($bbug,$parse,$rootScope){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var options=scope.$eval(attrs.bbIntTelNumber);element.intlTelInput(options);var isValid=function(value){return!value||element.intlTelInput("isValidNumber")};attrs.prefix&&$bbug(element).on("countrychange",function(e,countryData){scope.$eval(attrs.prefix+' = "'+countryData.dialCode+'"'),format(ctrl.$viewValue),ctrl.$render()}),ctrl.$render=function(){ctrl.$setViewValue(ctrl.$modelValue)};var format=function(value){var str="";return attrs.prefix?null!=scope.$eval(attrs.prefix)&&(str+="+"+scope.$eval(attrs.prefix)+" "):null!=scope.$eval(attrs.ngModel+"_prefix")&&(str+="+"+scope.$eval(attrs.ngModel+"_prefix")+" "),null!=scope.$eval(attrs.ngModel)&&(str+=scope.$eval(attrs.ngModel)),"+"===str[0]&&(attrs.prefix?null!=scope.$eval(attrs.ngModel)&&element.intlTelInput("setNumber","+"+scope.$eval(attrs.prefix)+" "+scope.$eval(attrs.ngModel)):element.intlTelInput("setNumber","+"+scope.$eval(attrs.ngModel+"_prefix")+" "+scope.$eval(attrs.ngModel)),ctrl.$setValidity(attrs.ngModel,isValid(value))),str},parse=function(value){var prefix=element.intlTelInput("getSelectedCountryData").dialCode,getter=void 0;return getter=$parse(attrs.prefix?attrs.prefix:attrs.ngModel+"_prefix"),getter.assign(scope,prefix),ctrl.$setValidity(attrs.ngModel,isValid(value)),value};ctrl.$formatters.push(format),ctrl.$parsers.push(parse)}}}),angular.module("BB.Directives").directive("bbLoader",function($rootScope,$compile,PathSvc,TemplateSvc){return{restrict:"A",replace:!1,scope:{},controllerAs:"LoaderCtrl",controller:function($scope){var parentScopeId=$scope.$parent.$id,scopeIdArr=[],addScopeId=function(id){scopeIdArr.push(id),scopeIdArr=_.uniq(scopeIdArr)},removeScopeId=function(id){return scopeIdArr=_.without(scopeIdArr,id),scopeIdArr.length},showLoader=function(e,cscope){for(var sid=cscope.$id;cscope;){if(cscope.$id===parentScopeId){addScopeId(sid),$scope.scopeLoaded=!1;break}cscope=cscope.$parent}},hideLoader=function(e,cscope){if(!removeScopeId(cscope.$id))return void($scope.scopeLoaded=!0)};$rootScope.$on("show:loader",showLoader),$rootScope.$on("hide:loader",hideLoader),$scope.scopeLoaded=!1},link:function(scope,element,attrs){TemplateSvc.get(PathSvc.directivePartial("loader")).then(function(html){if(_.isString(attrs.bbLoader)){var str=attrs.bbLoader.slice(1);/^#/.test(attrs.bbLoader)?html.attr("id",str):/^\./.test(attrs.bbLoader)&&html.addClass(str)}element.prepend(html),$compile(html)(scope)})}}}),angular.module("BB.Directives").directive("bbLoadingSpinner",function($compile){return{transclude:!0,link:function(scope,element,attrs,controller,transclude){var loadingScopes={};return scope.isLoading=!1,scope.$on("isLoading",function(event,isLoading){return event.stopPropagation(),loadingScopes[event.targetScope.$id]=isLoading,scope.isLoading=_.every(_.values(loadingScopes))})},template:'            <div ng-show="isLoading" class="loader-wrapper">\n                <div class="loader"></div>\n            </div>\n            <div ng-transclude></div>            '}}),bbLoggedUser.$inject=["$compile","LoginService"],angular.module("BB.Directives").directive("bbLoggedUser",bbLoggedUser),angular.module("BB.Directives").directive("bbMonthPicker",function(PathSvc,$timeout){return{restrict:"AE",replace:!0,scope:!0,require:["^?bbEvents","^?bbMultiCompanyEvents"],templateUrl:function(element,attrs){return PathSvc.directivePartial("_month_picker")},link:function(scope,el,attrs){return scope.picker_settings=scope.$eval(attrs.bbMonthPicker)||{},scope.picker_settings.months_to_show=scope.picker_settings.months_to_show||3,$(window).resize(function(){return $timeout(function(){var width=el.width();return scope.rebuildSlideToWidth(width)},500)}),scope.$watch(attrs.dayData,function(dayData){if(dayData){dayData.length||(scope.months=null),dayData.length&&scope.processDates(dayData);var width=el.width();return scope.rebuildSlideToWidth(width)}})},controller:function($scope){return $scope.processDates=function(dates){var first_carousel_month=void 0;dates.length||(dates=null);var datehash={},_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(dates)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var date=_step.value;datehash[date.date.format("DDMMYY")]=date,!$scope.first_available_day&&date.spaces>0&&($scope.first_available_day=date.date)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}first_carousel_month=$scope.picker_settings.start_at_first_available_day?$scope.first_available_day.clone().startOf("month"):moment().startOf("month");var last_date=_.last(dates),diff=last_date.date.diff(first_carousel_month,"months");return diff=diff>0?diff+1:1,$scope.num_months=$scope.picker_settings&&$scope.picker_settings.months?$scope.picker_settings.months:diff,$scope.months=$scope.getMonths($scope.num_months,first_carousel_month,datehash)},$scope.$on("event_list_filter_date:changed",function(event,date){var newDay=$scope.getDay(date);if($scope.selected_day){if($scope.selected_day.date.isSame(date))return $scope.selected_day.selected=!$scope.selected_day.selected;if($scope.selected_day.selected=!1,newDay)return $scope.selected_day=newDay,$scope.selected_day.selected=!0}else if(newDay)return $scope.selected_day=newDay,$scope.selected_day.selected=!0}),$scope.$on("event_list_filter_date:cleared",function(){if($scope.selected_day)return $scope.selected_day.selected=!1}),$scope.toggleDay=function(day){if(day&&(!day.data||0!==day.data.spaces&&!day.disabled&&day.available)&&(day.data||day._d))return $scope.selected_day&&$scope.selected_day.date.isSame(day.date)&&($scope.selected_day.selected=!$scope.selected_day.selected),$scope.selected_day&&!$scope.selected_day.date.isSame(day.date)&&($scope.selected_day.selected=!1,$scope.selected_day=day,$scope.selected_day.selected=!0),$scope.selected_day||($scope.selected_day=day,$scope.selected_day.selected=!0),$scope.showDay(day.date)},$scope.rebuildSlide=function(n){var months=void 0,last_carousel_month=moment().startOf("month"),num_empty_months_to_add=0;if($scope.months&&$scope.months.length){months=[];var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.months)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var month=_step2.value;month&&!month.filler&&months.push(month)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}months.length&&($scope.months=months),last_carousel_month=angular.copy($scope.months[$scope.months.length-1].start_date),last_carousel_month.add(1,"month"),num_empty_months_to_add=n-$scope.months.length%n,num_empty_months_to_add===n&&(num_empty_months_to_add=0)}else num_empty_months_to_add=n,last_carousel_month=moment().startOf("month");var monthCollection=[],slide=[];$scope.months||($scope.months=[]);var fillerMonths=$scope.getMonths(num_empty_months_to_add,last_carousel_month);$scope.months=$scope.months.concat(fillerMonths);var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.months)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var value=_step3.value;slide.length===n&&(monthCollection.push(slide),slide=[]),slide.push(value)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return monthCollection.push(slide),$scope.monthCollection=monthCollection},$scope.getMonths=function(months_to_display,start_month,datehash){for(var months=[],m=0,end=months_to_display,asc=0<=end;asc?m<end:m>end;asc?m++:m--){var date=start_month.clone().startOf("week"),month={weeks:[]};month.index=m-1;for(var w=1;w<=6;w++){for(var week={days:[]},d=1;d<=7;d++){var day_data;date.isSame(date.clone().startOf("month"),"day")&&!month.start_date&&(month.start_date=date.clone()),datehash&&(day_data=datehash[date.format("DDMMYY")]);var day={date:date.clone(),data:datehash?day_data:null,available:!!datehash&&(day_data&&day_data.spaces&&day_data.spaces>0),today:moment().isSame(date,"day"),past:date.isBefore(moment(),"day"),disabled:!month.start_date||!date.isSame(month.start_date,"month")};week.days.push(day),$scope.selected_date&&day.date.isSame($scope.selected_date,"day")&&(day.selected=!0,$scope.selected_day=day),date.add(1,"day")}datehash||(month.filler=!0),month.weeks.push(week)}months.push(month),start_month.add(1,"month")}return months},$scope.rebuildSlideToWidth=function(width){var num_slides_to_display=void 0;return width>750?(num_slides_to_display=3,$scope.rebuildSlide(num_slides_to_display)):width>550?(num_slides_to_display=2,$scope.rebuildSlide(num_slides_to_display)):(num_slides_to_display=1,$scope.rebuildSlide(num_slides_to_display))},$scope.getDay=function(date){var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from($scope.months)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var month=_step4.value,_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(month.weeks)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var week=_step5.value,_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(week.days)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var day=_step6.value;if(day.date.isSame(date)&&!day.disabled)return day}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}}}}),angular.module("BB.Directives").directive("bbMonthPickerListener",function(PathSvc,$timeout){return{restrict:"A",scope:!0,link:function(scope,el,attrs){return $(window).resize(function(){return $timeout(function(){return scope.carouselIndex=0})}),scope.$on("event_list_filter:changed",function(){return $timeout(function(){return scope.carouselIndex=0})})}}}),function(){function BBPageCtrl($scope,$q,ValidatorService,LoadingService){"ngInject";function isScopeReady(childScope){for(var readyList=[],children=[],child=childScope.$$childHead;child;)children.push(child),child=child.$$nextSibling;children.sort(sortChildrenScopes);for(var i=0;i<children.length;i++)areChildrenScopesReady(children[i],readyList);return childScope.hasOwnProperty("setReady")&&readyList.push(childScope.setReady()),readyList}function areChildrenScopesReady(child,readyList){var ready=isScopeReady(child);angular.isArray(ready)?Array.prototype.push.apply(readyList,ready):readyList.push(ready)}function sortChildrenScopes(a,b){return(a.ready_order||0)>=(b.ready_order||0)?1:-1}function checkReady(){var readyList=isScopeReady($scope),checkReadyDefer=$q.defer();if($scope.$checkingReady=checkReadyDefer.promise,!(readyList=readyList.filter(filterOutTrueValues))&&0===readyList.length)return checkReadyDefer.resolve(),!0;angular.forEach(readyList,function(readyValue){if("boolean"==typeof readyValue&&!readyValue)return checkReadyDefer.reject(),!1});var loader=LoadingService.$loader($scope).notLoaded();return $q.all(readyList).then(function(){loader.setLoaded(),checkReadyDefer.resolve()},function(err){loader.setLoaded()}),!0}function filterOutTrueValues(v){return!("boolean"==typeof v&&v)}function routeReady(route){return $scope.$checkingReady?$scope.$checkingReady.then(function(){return $scope.decideNextPage(route)}):$scope.decideNextPage(route)}this.$scope=$scope,function(){$scope.$has_page_control=!0,console.warn("Deprecation warning: validator.validateForm() will be removed from bbPage in an upcoming major release, please update your template to use bbForm and submitForm() instead. See https://github.com/bookingbug/bookingbug-angular/issues/638"),$scope.validator=ValidatorService,$scope.checkReady=checkReady,$scope.routeReady=routeReady}()}angular.module("BB").controller("BBPageCtrl",BBPageCtrl)}(),function(){angular.module("BB").directive("bbPage",function(){"ngInject";return{restrict:"AE",replace:!0,
scope:!0,controller:"BBPageCtrl",controllerAs:"$bbPageCtrl"}})}(),angular.module("BB.Controllers").controller("PayForm",function($scope,$location){var payment_form=void 0;$scope.setTotal=function(total){return $scope.total=total},$scope.setCard=function(card){return $scope.card=card};var sendSubmittingEvent=function(){var referrer=$location.protocol()+"://"+$location.host();$location.port()&&(referrer+=":"+$location.port());var target_origin=$scope.referrer,payload=JSON.stringify({type:"submitting",message:referrer});return parent.postMessage(payload,target_origin)},submitPaymentForm=function(){return payment_form=angular.element.find("form"),payment_form[0].submit()};return $scope.submitAndSendMessage=function(event){return event.preventDefault(),event.stopPropagation(),payment_form=$scope.$eval("payment_form"),payment_form.$invalid?(payment_form.submitted=!0,!1):(sendSubmittingEvent(),submitPaymentForm())}}),angular.module("BB.Directives").directive("bbPayForm",function($window,$timeout,$sce,$http,$compile,$document,$location,GeneralOptions){var applyCustomPartials=function(custom_partial_url,scope,element){if(null!=custom_partial_url)return $document.domain="bookingbug.com",$http.get(custom_partial_url).then(function(custom_templates){return $compile(custom_templates.data)(scope,function(custom,scope){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(custom)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var e=_step.value;"STYLE"===e.tagName&&element.after(e.outerHTML)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}var custom_form=function(){var result=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(custom)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)e=_step2.value,"payment_form"===e.id&&result.push(e)}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result}();if(custom_form&&custom_form[0])return $compile(custom_form[0].innerHTML)(scope,function(compiled_form,scope){var form=element.find("form")[0],action=form.action;return compiled_form.attr("action",action),$(form).replaceWith(compiled_form)})})})},applyCustomStylesheet=function(href){if(!document.getElementById("custom_css")){var head=document.getElementsByTagName("head")[0],link=document.createElement("link");return link.id="custom_css",link.rel="stylesheet",link.type="text/css",link.href=href,link.media="all",head.appendChild(link),link.onload=function(){if("parentIFrame"in $window)return parentIFrame.size()}}};return{restrict:"AE",replace:!0,scope:!0,controller:"PayForm",link:function(scope,element,attributes){return $window.addEventListener("message",function(event){var data=void 0;if(angular.isObject(event.data)?data=event.data:angular.isString(event.data)&&!event.data.match(/iFrameSizer/)&&(data=JSON.parse(event.data)),data)switch(data.type){case"load":return scope.$apply(function(){if(scope.referrer=data.message,data.custom_partial_url&&applyCustomPartials(event.data.custom_partial_url,scope,element),data.custom_stylesheet&&applyCustomStylesheet(data.custom_stylesheet),data.scroll_offset)return GeneralOptions.scroll_offset=data.scroll_offset})}},!1)}}}),angular.module("BB.Directives").directive("bbPaymentButton",function($compile,$sce,$http,$templateCache,$q,$log,TemplateSvc,$translate){return{restrict:"EA",replace:!0,scope:{total:"=",bb:"=",decideNextPage:"=",notLoaded:"=",setLoaded:"="},link:function(scope,element,attributes){var getTemplate=function(type,scope){switch(type){case"button_form":return getButtonFormTemplate(scope);case"page":return TemplateSvc.get("payment.html");case"location":return"<a href='{{payment_link}}'>{{label}}</a>";default:return""}},getButtonFormTemplate=function(scope){var src=$sce.parseAsResourceUrl("'"+scope.payment_link+"'")();return $http.get(src,{}).then(function(response){return response.data})},setClassAndValue=function(scope,element,attributes){var main_tag=void 0;switch(scope.link_type){case"button_form":var inputs=element.find("input");main_tag=Array.from(inputs).filter(function(i){return"submit"===$(i).attr("type")}).map(function(i){return i})[0],attributes.value&&$(main_tag).attr("value",$translate.instant(attributes.value));break;case"page":case"location":main_tag=element.find("a")[0]}if(attributes.class)return Array.from(attributes.class.split(" ")).map(function(c){return $(main_tag).addClass(c),$(element).removeClass(c)})},killWatch=scope.$watch("total",function(total){return total&&total.$has("new_payment")?(killWatch(),scope.bb.payment_status="pending",scope.bb.total=scope.total,scope.link_type=scope.total.$link("new_payment").type,scope.label=attributes.value||"Make Payment",scope.payment_link=scope.total.$href("new_payment"),scope.total.$href("new_payment"),$q.when(getTemplate(scope.link_type,scope)).then(function(template){return element.html(template).show(),$compile(element.contents())(scope),setClassAndValue(scope,element,attributes)},function(err){return $log.warn(err.data),element.remove()})):(element.hide(),console.warn("new_payment link missing: payment configuration maybe incorrect"))})}}}),angular.module("BB.Directives").directive("bbPaypalExpressButton",function($compile,$sce,$http,$templateCache,$q,$log,$window,UriTemplate){return{restrict:"EA",replace:!0,template:'<a ng-href="{{href}}" ng-click="showLoader()">Pay</a>',scope:{total:"=",bb:"=",decideNextPage:"=",paypalOptions:"=bbPaypalExpressButton",notLoaded:"="},link:function(scope,element,attributes){var total=scope.total,paypalOptions=scope.paypalOptions;return scope.href=new UriTemplate(total.$link("paypal_express").href).fillFromObject(paypalOptions),scope.showLoader=function(){if(scope.notLoaded)return scope.notLoaded(scope)}}}}),angular.module("BB.Controllers").controller("PostcodeLookup",function($scope,$rootScope,$q,ValidatorService,AlertService,LoadingService,$attrs){angular.extend(this,new CompanyListBase($scope,$rootScope,$q,$attrs));var loader=LoadingService.$loader($scope);return $scope.searchPostcode=function(form,prms){loader.notLoaded();var promise=ValidatorService.validatePostcode(form,prms);return promise?promise.then(function(){$scope.bb.postcode=ValidatorService.getGeocodeResult().address_components[0].short_name,$scope.postcode=$scope.bb.postcode;var loc=ValidatorService.getGeocodeResult().geometry.location;return $scope.selectItem($scope.getNearestCompany({center:loc}))},function(err){return loader.setLoaded()}):loader.setLoaded()},$scope.getNearestCompany=function(_ref){var centre=_ref.centre,distances=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var company=_step.value;if(company.address.lat&&company.address.long&&company.live){var map_centre={lat:center.lat(),long:centre.lng()},company_position={lat:company.address.lat,long:company.address.long};company.distance=GeolocationService.haversine(map_centre,company_position),distances.push(company)}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return distances.sort(function(a,b){return a.distance-b.distance}),distances[0]}}),angular.module("BB.Directives").directive("bbPostcodeLookup",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PostcodeLookup"}}),angular.module("BB.Controllers").controller("PurchaseTotal",function($scope,$rootScope,$window,BBModel,$q){return angular.extend(this,new $window.PageController($scope,$q)),$scope.load=function(total_id){return $rootScope.connection_started.then(function(){return $scope.loadingTotal=BBModel.PurchaseTotal.$query({company:$scope.bb.company,total_id:total_id}),$scope.loadingTotal.then(function(total){return $scope.total=total})})}}),angular.module("BB.Directives").directive("bbPurchaseTotal",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PurchaseTotal"}}),angular.module("BB.Directives").directive("bbSkipDecideNextPage",function(bbWidgetPage){return{restrict:"AE",replace:!0,scope:!0,link:function(scope,element,attrs){attrs.bbSkipDecideNextPage?bbWidgetPage.setAutoDecideNextPage(attrs.bbSkipDecideNextPage,!1):console.warn('Warning: you forgot to use the bb-skip-decide-next-page="directive-name" notation')}}}),angular.module("BB.Directives").directive("bbToggleEdit",function($compile,$window,$document){return{restrict:"AE",link:function(scope,element,attr){return scope.editing=!1,element.on("dblclick",function(event){return scope.$apply(function(){return scope.editing=!0})}),$document.on("click",function(){if(!element.is(":hover"))return scope.$apply(function(){return scope.editing=!1})}),!0}}}),function(){function BBCtrl(routeStates,$scope,$rootScope,QueryStringService,LoadingService,viewportSize,bbWidgetBasket,bbWidgetPage,bbWidgetStep,bbWidgetInit,bbWidgetUtilities){bbWidgetBasket.setScope($scope),bbWidgetPage.setScope($scope),bbWidgetStep.setScope($scope),bbWidgetInit.setScope($scope),bbWidgetUtilities.setScope($scope),this.$scope=$scope,$scope.cid="BBCtrl",$scope.qs=QueryStringService,$scope.company_api_path="/api/v1/company/{company_id}{?embed,category_id}",$scope.company_admin_api_path="/api/v1/admin/{company_id}/company{?embed,category_id}",$rootScope.Route=$scope.Route=routeStates,this.$onInit=function(){bbWidgetInit.initializeBBWidget(),$scope.initWidget=bbWidgetInit.initWidget,$scope.checkStepTitle=bbWidgetStep.checkStepTitle,$scope.getCurrentStepTitle=bbWidgetStep.getCurrentStepTitle,$scope.loadPreviousStep=bbWidgetStep.loadPreviousStep,$scope.loadStep=bbWidgetStep.loadStep,$scope.loadStepByPageName=bbWidgetStep.loadStepByPageName,$scope.reset=bbWidgetStep.reset,$scope.restart=bbWidgetStep.restart,$scope.setLastSelectedDate=bbWidgetStep.setLastSelectedDate,$scope.setStepTitle=bbWidgetStep.setStepTitle,$scope.skipThisStep=bbWidgetStep.skipThisStep,$scope.clearPage=bbWidgetPage.clearPage,$scope.decideNextPage=bbWidgetPage.decideNextPage,$scope.hidePage=bbWidgetPage.hidePage,$scope.isLoadingPage=bbWidgetPage.isLoadingPage,$scope.jumpToPage=bbWidgetPage.jumpToPage,$scope.setLoadingPage=bbWidgetPage.setLoadingPage,$scope.setPageLoaded=bbWidgetPage.setPageLoaded,$scope.setPageRoute=bbWidgetPage.setPageRoute,$scope.showPage=bbWidgetPage.showPage,$scope.addItemToBasket=bbWidgetBasket.addItemToBasket,$scope.clearBasketItem=bbWidgetBasket.clearBasketItem,$scope.deleteBasketItem=bbWidgetBasket.deleteBasketItem,$scope.deleteBasketItems=bbWidgetBasket.deleteBasketItems,$scope.emptyBasket=bbWidgetBasket.emptyBasket,$scope.moveToBasket=bbWidgetBasket.moveToBasket,$scope.quickEmptybasket=bbWidgetBasket.quickEmptybasket,$scope.setBasket=bbWidgetBasket.setBasket,$scope.setBasketItem=bbWidgetBasket.setBasketItem,$scope.updateBasket=bbWidgetBasket.updateBasket,$scope.setUsingBasket=bbWidgetBasket.setUsingBasket,$scope.setClient=bbWidgetInit.setClient,$scope.clearClient=bbWidgetInit.clearClient,$scope.setCompany=bbWidgetInit.setCompany,$scope.setAffiliate=bbWidgetInit.setAffiliate,$scope.isAdmin=bbWidgetUtilities.isAdmin,$scope.isAdminIFrame=bbWidgetUtilities.isAdminIFrame,$scope.base64encode=bbWidgetUtilities.base64encode,$scope.$debounce=bbWidgetUtilities.$debounce,$scope.parseDate=moment,$scope.supportsTouch=bbWidgetUtilities.supportsTouch,$scope.scrollTo=bbWidgetUtilities.scrollTo,$scope.redirectTo=bbWidgetUtilities.redirectTo,$scope.areScopesLoaded=LoadingService.areScopesLoaded,$scope.broadcastItemUpdate=bbWidgetUtilities.broadcastItemUpdate,$scope.getPartial=bbWidgetUtilities.getPartial,$scope.getUrlParam=bbWidgetUtilities.getUrlParam,$scope.setLoaded=LoadingService.setLoaded,$scope.setLoadedAndShowError=LoadingService.setLoadedAndShowError,$scope.isMemberLoggedIn=bbWidgetUtilities.isMemberLoggedIn,$scope.logout=bbWidgetUtilities.logout,$scope.notLoaded=LoadingService.notLoaded,$scope.reloadDashboard=bbWidgetUtilities.reloadDashboard,$scope.setReadyToCheckout=bbWidgetBasket.setReadyToCheckout,$scope.setRoute=bbWidgetUtilities.setRoute,$scope.showCheckout=bbWidgetBasket.showCheckout,$rootScope.$on("show:loader",bbWidgetUtilities.showLoaderHandler),$rootScope.$on("hide:loader",bbWidgetUtilities.hideLoaderHandler),$scope.$on("$locationChangeStart",bbWidgetUtilities.locationChangeStartHandler)},this.$postLink=function(){viewportSize.init()}}angular.module("BB.Controllers").controller("BBCtrl",BBCtrl)}(),function(){function BBWidget($http,$templateCache,$compile,$q,AppConfig,$timeout,$bbug,$rootScope,AppService,bbConfig){var getTemplate=function(template){var partial=template||"main";return $templateCache.get(partial+".html")},updatePartials=function(scope,element,prms){var i,j,len,ref;for(ref=element.children(),j=0,len=ref.length;j<len;j++)i=ref[j],$bbug(i).hasClass("custom_partial")&&$bbug(i).remove();return appendCustomPartials(scope,element,prms).then(function(){return scope.$broadcast("refreshPage")})},setupPusher=function(scope,element,prms){return $timeout(function(){return scope.pusher=new Pusher("c8d8cea659cc46060608"),scope.pusher_channel=scope.pusher.subscribe("widget_"+prms.design_id),scope.pusher_channel.bind("update",function(data){return updatePartials(scope,element,prms)})})},appendCustomPartials=function(scope,element,prms){var defer;return defer=$q.defer(),$http.get(prms.custom_partial_url).then(function(custom_templates){return $compile(custom_templates.data)(scope,function(custom,scope){var non_style,style,tag;return custom.addClass("custom_partial"),style=function(){var j,len,results;for(results=[],j=0,len=custom.length;j<len;j++)tag=custom[j],"STYLE"===tag.tagName&&results.push(tag);return results}(),non_style=function(){var j,len,results;for(results=[],j=0,len=custom.length;j<len;j++)tag=custom[j],"STYLE"!==tag.tagName&&results.push(tag);return results}(),$bbug("#widget_"+prms.design_id).html(non_style),element.append(style),scope.bb.path_setup=!0,defer.resolve(style)})}),defer.promise},renderTemplate=function(scope,element,design_mode,template){return $q.when(getTemplate(template)).then(function(template){return element.html(template).show(),design_mode&&element.append("<style widget_css scoped></style>"),$compile(element.contents())(scope)})};return{restrict:"A",scope:{client:"=?",apiUrl:"@?",useParent:"="},transclude:!0,controller:"BBCtrl",controllerAs:"$bbCtrl",link:function(scope,element,attrs,controller,transclude){var evaluator,init_params,_notInModal;if(null!=attrs.member&&(scope.client=attrs.member),evaluator=scope,scope.useParent&&null!=scope.$parent&&(evaluator=scope.$parent),init_params=evaluator.$eval(attrs.bbWidget),scope.initWidget(init_params),bbConfig&&bbConfig.ROUTES)for(var template in bbConfig.ROUTES)if(init_params.template===template.toLowerCase()){var _ret=function(){var routes=[];return bbConfig.ROUTES[template].forEach(function(pageConfig){var config={};for(var attr in pageConfig)config[attr.toLowerCase()]=pageConfig[attr];routes.push(config)}),scope.setRoute(routes),"break"}();if("break"===_ret)break}$rootScope.widget_started.then(function(_this){return function(){var prms;return prms=scope.bb,prms.custom_partial_url&&(prms.design_id=prms.custom_partial_url.match(/^.*\/(.*?)$/)[1],$bbug("[ng-app='BB']").append("<div id='widget_"+prms.design_id+"'></div>")),scope.bb.partial_url&&(init_params.partial_url?AppConfig.partial_url=init_params.partial_url:AppConfig.partial_url=scope.bb.partial_url),transclude(scope,function(clone){return scope.has_content=clone.length>1||1===clone.length&&(!clone[0].wholeText||/\S/.test(clone[0].wholeText)),scope.has_content?prms.custom_partial_url?(appendCustomPartials(scope,element,prms),prms.update_design&&setupPusher(scope,element,prms),scope.$on("refreshPage",function(){return scope.showPage(scope.bb.current_page)})):(element.html(clone).show(),prms.design_mode?element.append("<style widget_css scoped></style>"):void 0):(prms.custom_partial_url?appendCustomPartials(scope,element,prms).then(function(style){return $q.when(getTemplate()).then(function(template){if(element.html(template).show(),$compile(element.contents())(scope),element.append(style),prms.update_design)return setupPusher(scope,element,prms)})}):prms.template?renderTemplate(scope,element,prms.design_mode,prms.template):renderTemplate(scope,element,prms.design_mode),scope.$on("refreshPage",function(){return renderTemplate(scope,element,prms.design_mode,prms.template)}))})}}()),_notInModal=function(p){return 0===p.length||void 0===p[0].attributes||void 0===p[0].attributes["uib-modal-window"]&&(0===p.parent().length||_notInModal(p.parent()))},scope.$watch(function(){return AppService.isModalOpen()},function(modalOpen){return scope.coveredByModal=modalOpen&&_notInModal(element.parent())})}}}angular.module("BB.Directives").directive("bbWidget",BBWidget)}(),function(){function BBWidget($q,BBModel,$urlMatcherFactory,$location,BreadcrumbService,PathHelper,GeneralOptions,$translate){function Widget(){this.uid=_.uniqueId("bbwidget_"),this.page_suffix="",this.steps=[],this.allSteps=[],this.item_defaults={},this.usingBasket=!1,this.confirmCheckout=!1,this.isAdmin=!1,this.payment_status=null}return Widget.prototype.pageURL=function(route){return route+".html"},Widget.prototype.updateRoute=function(page){var company,date,event,event_group,pattern,prms,service_name,time,url;if(this.routeFormat)return page||(page=this.current_page),pattern=$urlMatcherFactory.compile(this.routeFormat),service_name="-",event_group="-",event="-",this.current_item&&(this.current_item.service&&(service_name=this.convertToDashSnakeCase(this.current_item.service.name)),this.current_item.event_group&&(event_group=this.convertToDashSnakeCase(this.current_item.event_group.name)),this.current_item.event&&(event=this.current_item.event.id),this.current_item.date&&(date=this.current_item.date.date),date&&moment.isMoment(date)&&(date=date.toISODate()),this.current_item.time&&(time=this.current_item.time.time),this.current_item.company?company=this.convertToDashSnakeCase(this.current_item.company.name):console.log("%c bb_warning: Make sure you are using a valid company_id","background: #c0392b; color: #fff")),this.route_values&&(prms=angular.copy(this.route_values)),prms||(prms={}),angular.extend(prms,{page:page,company:company,service:service_name,event_group:event_group,date:date,time:time,event:event}),url=pattern.format(prms),url=url.replace(/\/+$/,""),$location.path(url),this.routing=!0,url},Widget.prototype.setRouteFormat=function(route){var match;if(this.routeFormat=route,this.routeFormat)return this.routing=!0,match=PathHelper.matchRouteToPath(this.routeFormat),match?(match.company&&(this.item_defaults.company=decodeURIComponent(match.company)),match.service&&"-"!==match.service&&(this.item_defaults.service=decodeURIComponent(match.service)),match.event_group&&"-"!==match.event_group&&(this.item_defaults.event_group=match.event_group),match.event&&"-"!==match.event&&(this.item_defaults.event=decodeURIComponent(match.event)),match.person&&(this.item_defaults.person=decodeURIComponent(match.person)),match.resource&&(this.item_defaults.resource=decodeURIComponent(match.resource)),match.resources&&(this.item_defaults.resources=decodeURIComponent(match.resoures)),match.date&&(this.item_defaults.date=match.date),match.time&&(this.item_defaults.time=parseInt(match.time)),this.route_matches=match):void 0},Widget.prototype.matchURLToStep=function(){var page,step;return page=PathHelper.matchRouteToPath(this.routeFormat,"page"),step=_.findWhere(this.allSteps,{page:page}),step?step.number:null},Widget.prototype.convertToDashSnakeCase=function(str){return str=str.toLowerCase(),str=$.trim(str),str=str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,""),str=str.replace(/\s{2,}/g," "),str=str.replace(/\s/g,"-")},Widget.prototype.recordCurrentPage=function(){var j,k,l,len,len1,len2,match,ref,ref1,ref2,setDocumentTitle,step,title;if(setDocumentTitle=function(title){if(GeneralOptions.update_document_title&&title)return document.title=$translate.instant(title)},this.current_step||(this.current_step=0),match=!1,this.allSteps)for(ref=this.allSteps,j=0,len=ref.length;j<len;j++)step=ref[j],step.page===this.current_page&&(this.current_step=step.number,setDocumentTitle(step.title),match=!0);if(!match)for(ref1=this.steps,k=0,len1=ref1.length;k<len1;k++)(step=ref1[k])&&step.page===this.current_page&&(this.current_step=step.number,setDocumentTitle(step.title),match=!0);if(match||(this.current_step+=1),title="",this.allSteps){for(ref2=this.allSteps,l=0,len2=ref2.length;l<len2;l++)step=ref2[l],step.active=!1,step.passed=step.number<this.current_step;this.allSteps[this.current_step-1]&&(this.allSteps[this.current_step-1].active=!0,title=this.allSteps[this.current_step-1].title)}return this.recordStep(this.current_step,title)},Widget.prototype.recordStep=function(step_number,title){var j,len,ref,step;for(this.steps[step_number-1]={url:this.updateRoute(this.current_page),current_item:this.current_item.getStep(),page:this.current_page,number:step_number,title:title,stacked_length:this.stacked_items.length},BreadcrumbService.setCurrentStep(step_number),ref=this.steps,j=0,len=ref.length;j<len;j++)step=ref[j],step&&(step.passed=step.number<this.current_step,step.active=step.number===this.current_step),step&&step.number===step_number&&this.calculatePercentageComplete(step.number);return this.allSteps&&this.allSteps.length===step_number||"checkout"===this.current_page?this.last_step_reached=!0:this.last_step_reached=!1},Widget.prototype.calculatePercentageComplete=function(step_number){return this.percentage_complete=step_number&&this.allSteps?step_number/this.allSteps.length*100:0},Widget.prototype.setRoute=function(rdata){var i,j,k,len,len1,ref,route,step;for(this.allSteps.length=0,this.nextSteps={},void 0!==rdata&&null!==rdata&&void 0!==rdata[0]&&(this.firstStep=rdata[0].page),i=j=0,len=rdata.length;j<len;i=++j)if(step=rdata[i],step.disable_breadcrumbs&&(this.disableGoingBackAtStep=i+1),rdata[i+1]&&(this.nextSteps[step.page]=rdata[i+1].page),this.allSteps.push({number:i+1,title:step.title,page:step.page}),step.when)for(this.routeSteps||(this.routeSteps={}),ref=step.when,k=0,len1=ref.length;k<len1;k++)route=ref[k],this.routeSteps[route]=step.page;if(this.$wait_for_routing)return this.$wait_for_routing.resolve()},Widget.prototype.waitForRoutes=function(){if(!this.$wait_for_routing)return this.$wait_for_routing=$q.defer()},Widget.prototype.stackItem=function(item){if(this.stacked_items.push(item),this.sortStackedItems(),1===this.stacked_items.length)return this.current_item=item},Widget.prototype.setStackedItems=function(items){return this.stacked_items=items,this.sortStackedItems()},Widget.prototype.sortStackedItems=function(){var arr,item,j,len,ref;for(arr=[],ref=this.stacked_items,j=0,len=ref.length;j<len;j++)item=ref[j],arr=arr.concat(item.promises);return $q.all(arr).finally(function(_this){return function(){return _this.stacked_items=_this.stacked_items.sort(function(a,b){var ref1,ref2;return a.time&&b.time?null!=(ref1=a.time.time>b.time.time)?ref1:{1:-1}:a.service.category&&!b.service.category?1:b.service.category&&!a.service.category?-1:b.service.category||a.service.category?null!=(ref2=a.service.category.order>b.service.category.order)?ref2:{1:-1}:1})}}(this))},Widget.prototype.deleteStackedItem=function(item){return item&&item.id&&BBModel.Basket.$deleteItem(item,this.company,{bb:this}),this.stacked_items=this.stacked_items.filter(function(i){return i!==item})},Widget.prototype.removeItemFromStack=function(item){return this.stacked_items=this.stacked_items.filter(function(i){return i!==item})},Widget.prototype.deleteStackedItemByService=function(item){var i,j,len,ref;for(ref=this.stacked_items,j=0,len=ref.length;j<len;j++)(i=ref[j])&&i.service&&i.service.self===item.self&&i.id&&BBModel.Basket.$deleteItem(i,this.company,{bb:this});return this.stacked_items=this.stacked_items.filter(function(i){return i&&i.service&&i.service.self!==item.self})},Widget.prototype.emptyStackedItems=function(){return this.stacked_items=[]},Widget.prototype.pushStackToBasket=function(){var i,j,len,ref;for(this.basket||(this.basket=new BBModel.Basket(null,this)),ref=this.stacked_items,j=0,len=ref.length;j<len;j++)i=ref[j],this.basket.addItem(i);return this.emptyStackedItems()},Widget.prototype.totalStackedItemsDuration=function(){var duration,item,j,len,ref;for(duration=0,ref=this.stacked_items,j=0,len=ref.length;j<len;j++)item=ref[j],item.service&&item.service.listed_duration&&(duration+=item.service.listed_duration);return duration},Widget.prototype.clearStackedItemsDateTime=function(){var item,j,len,ref,results;for(ref=this.stacked_items,results=[],j=0,len=ref.length;j<len;j++)item=ref[j],results.push(item.clearDateTime());return results},Widget.prototype.clearAddress=function(){return delete this.address1,delete this.address2,delete this.address3,delete this.address4,delete this.address5},Widget}angular.module("BB.Models").service("BBWidget",BBWidget)}(),function(){function BBWidgetBasket($q,halClient,BBModel,$localStorage,$sessionStorage,bbWidgetPage,bbWidgetStep,$uibModal,bbWidgetUtilities,ErrorService,LoginService){var $scope=null,setScope=function($s){$scope=$s},guardScope=function(){if(null===$scope)throw new Error("please provide scope")},deleteBasketItems=function(items){guardScope();var item,j,len,results;for(results=[],j=0,len=items.length;j<len;j++)item=items[j],results.push(BBModel.Basket.$deleteItem(item,$scope.bb.company,{bb:$scope.bb}).then(function(basket){return setBasket(basket)}));return results},setBasketItem=function(item){return guardScope(),$scope.bb.current_item=item},clearBasketItem=function(){guardScope();var def;return def=$q.defer(),$scope.bb.current_item=new BBModel.BasketItem(null,$scope.bb),$scope.bb.default_setup_promises?$q.all($scope.bb.default_setup_promises).finally(function(){return $scope.bb.current_item.setDefaults($scope.bb.item_defaults),$q.all($scope.bb.current_item.promises).finally(function(){return def.resolve()})}):($scope.bb.current_item.setDefaults({}),def.resolve()),def.promise},setBasket=function(basket){if(guardScope(),$scope.bb.basket=basket,$scope.basket=basket,$scope.bb.basket.company_id=$scope.bb.company_id,$scope.bb.stacked_items)return $scope.bb.setStackedItems(basket.timeItems())},updateBasket=function(){guardScope();var add_defer,current_item_ref,params;return current_item_ref=$scope.bb.current_item.ref,add_defer=$q.defer(),params={member_id:$scope.client.id,member:$scope.client,items:$scope.bb.basket.items,bb:$scope.bb},BBModel.Basket.$updateBasket($scope.bb.company,params).then(function(basket){var current_item,item,j,len,ref;for(ref=basket.items,j=0,len=ref.length;j<len;j++)item=ref[j],item.storeDefaults($scope.bb.item_defaults);return halClient.clearCache("time_data"),halClient.clearCache("events"),basket.setSettings($scope.bb.basket.settings),setBasket(basket),current_item=_.find(basket.items,function(item){return item.ref===current_item_ref}),current_item||(current_item=_.last(basket.items)),$scope.bb.current_item=current_item,$scope.bb.current_item?add_defer.resolve(basket):clearBasketItem().then(function(){return add_defer.resolve(basket)})},function(err){var error_modal;if(add_defer.reject(err),409===err.status)return halClient.clearCache("time_data"),halClient.clearCache("events"),$scope.bb.current_item.person=null,error_modal=$uibModal.open({templateUrl:bbWidgetUtilities.getPartial("_error_modal"),controller:function($scope,$uibModalInstance){return $scope.message=ErrorService.getError("ITEM_NO_LONGER_AVAILABLE").msg,$scope.ok=function(){return $uibModalInstance.close()}}}),error_modal.result.finally(function(){return $scope.bb.on_conflict?$scope.$eval($scope.bb.on_conflict):$scope.bb.nextSteps?bbWidgetPage.setPageRoute($rootScope.Route.Date)||bbWidgetPage.setPageRoute($rootScope.Route.Event)?void 0:bbWidgetStep.loadPreviousStep():bbWidgetPage.decideNextPage()})}),add_defer.promise},deleteBasketItem=function(item){return guardScope(),BBModel.Basket.$deleteItem(item,$scope.bb.company,{bb:$scope.bb}).then(function(basket){return setBasket(basket)})},emptyBasket=function(){guardScope();var defer;return defer=$q.defer(),!$scope.bb.basket.items||$scope.bb.basket.items&&0===$scope.bb.basket.items.length?defer.resolve():BBModel.Basket.$empty($scope.bb).then(function(basket){return $scope.bb.current_item.id&&delete $scope.bb.current_item.id,setBasket(basket),defer.resolve()},function(err){return defer.reject()}),defer.promise},addItemToBasket=function(){guardScope();var add_defer;if(add_defer=$q.defer(),$scope.bb.current_item.submitted||$scope.bb.moving_booking){if($scope.bb.current_item.submitted)return $scope.bb.current_item.submitted;add_defer.resolve()}else moveToBasket(),$scope.bb.current_item.submitted=updateBasket(),$scope.bb.current_item.submitted.then(function(basket){return add_defer.resolve(basket)},function(err){return 409===err.status&&($scope.bb.current_item.person=null,$scope.bb.current_item.resource=null,$scope.bb.current_item.setTime(null),$scope.bb.current_item.service&&$scope.bb.current_item.setService($scope.bb.current_item.service)),$scope.bb.current_item.submitted=null,add_defer.reject(err)});return add_defer.promise},moveToBasket=function(){return guardScope(),$scope.bb.basket.addItem($scope.bb.current_item)},quickEmptybasket=function(options){guardScope();var def,preserve_stacked_items;return preserve_stacked_items=!(!options||!options.preserve_stacked_items),preserve_stacked_items?($scope.bb.basket=new BBModel.Basket(null,$scope.bb),$scope.basket=$scope.bb.basket,$scope.bb.basket.company_id=$scope.bb.company_id,def=$q.defer(),def.resolve(),def.promise):($scope.bb.stacked_items=[],setBasket(new BBModel.Basket(null,$scope.bb)),clearBasketItem())};return{setScope:setScope,deleteBasketItems:deleteBasketItems,setBasketItem:setBasketItem,clearBasketItem:clearBasketItem,setBasket:setBasket,updateBasket:updateBasket,deleteBasketItem:deleteBasketItem,emptyBasket:emptyBasket,addItemToBasket:addItemToBasket,moveToBasket:moveToBasket,quickEmptybasket:quickEmptybasket,restoreBasket:function(){guardScope();var restore_basket_defer;return restore_basket_defer=$q.defer(),quickEmptybasket().then(function(){var auth_token,href,params,status,uri;return auth_token=$localStorage.getItem("auth_token")||$sessionStorage.getItem("auth_token"),href=$scope.bb.api_url+"/api/v1/status{?company_id,affiliate_id,clear_baskets,clear_member}",params={company_id:$scope.bb.company_id,affiliate_id:$scope.bb.affiliate_id,clear_baskets:$scope.bb.clear_basket?"1":null,clear_member:$scope.bb.clear_member?"1":null},uri=new UriTemplate(href).fillFromObject(params),status=halClient.$get(uri,{auth_token:auth_token,no_cache:!0}),status.then(function(_this){return function(res){return res.$has("client")&&res.$get("client").then(function(client){if(!$scope.client||$scope.client&&!$scope.client.valid())return $scope.client=new BBModel.Client(client)}),res.$has("member")&&res.$get("member").then(function(member){if("Contact"!==member.client_type)return member=LoginService.setLogin(member),$scope.setClient(member)}),$scope.bb.clear_basket?restore_basket_defer.resolve():res.$has("baskets")?res.$get("baskets").then(function(baskets){var basket;return basket=_.find(baskets,function(b){return parseInt(b.company_id)===$scope.bb.company_id}),basket?(basket=new BBModel.Basket(basket,$scope.bb),basket.$get("items").then(function(items){var i,j,len,promises;for(items=function(){var j,len,results;for(results=[],j=0,
len=items.length;j<len;j++)i=items[j],results.push(new BBModel.BasketItem(i));return results}(),j=0,len=items.length;j<len;j++)i=items[j],basket.addItem(i);return setBasket(basket),promises=[].concat.apply([],function(){var l,len1,results;for(results=[],l=0,len1=items.length;l<len1;l++)i=items[l],results.push(i.promises);return results}()),$q.all(promises).then(function(){return basket.items.length>0&&($scope.bb.current_item=basket.items[0]),restore_basket_defer.resolve()})})):restore_basket_defer.resolve()}):restore_basket_defer.resolve()}}(),function(err){return restore_basket_defer.resolve()})}),restore_basket_defer.promise},setUsingBasket:function(usingBasket){return $scope.bb.usingBasket=usingBasket},showCheckout:function(){return guardScope(),$scope.bb.current_item.ready},setReadyToCheckout:function(ready){return guardScope(),$scope.bb.confirmCheckout=ready}}}angular.module("BB.Services").service("bbWidgetBasket",BBWidgetBasket)}(),function(){function BBWidgetInit($rootScope,$sessionStorage,$q,$sniffer,QueryStringService,halClient,BBModel,UriTemplate,PurchaseService,$window,SSOService,bbWidgetBasket,CompanyStoreService,$bbug,bbWidgetPage,LoadingService,BBWidget,AppConfig,$location,bbTimeZone){var connectionStarted,isFirstCall,widgetStarted,$scope=null,setScope=function($s){$scope=$s,reinitialise()},reinitialise=function(){isFirstCall=!0,widgetStarted=$q.defer(),$rootScope.widget_started=widgetStarted.promise},guardScope=function(){if(null===$scope)throw new Error("please provide scope")},initWidget=function(prms){guardScope();var url;if(null==prms&&(prms={}),this.$init_prms=prms,connectionStarted=$q.defer(),$rootScope.connection_started=connectionStarted.promise,($sniffer.webkit&&$sniffer.webkit<537||$sniffer.msie&&$sniffer.msie<=9)&&isFirstCall){if($scope.bb.api_url&&(url=document.createElement("a"),url.href=$scope.bb.api_url,""===url.host||url.host===$location.host()||url.host===$location.host()+":"+$location.port()))return void initWidget2();$rootScope.iframe_proxy_ready?initWidget2():$scope.$on("iframe_proxy_ready",function(event,args){if(args.iframe_proxy_ready)return initWidget2()})}else initWidget2()}.bind(this),initWidget2=function(){guardScope();var aff_promise,comp_category_id,comp_def,comp_promise,comp_url,company_id,embed_params,get_total,k,match,options,params,prms,ref,setup_promises,setup_promises2,sso_admin_login,sso_member_login,total_id,v;if($scope.init_widget_started=!0,prms=this.$init_prms,prms.query){ref=prms.query;for(k in ref)v=ref[k],prms[k]=QueryStringService(v)}return prms.custom_partial_url?($scope.bb.custom_partial_url=prms.custom_partial_url,$scope.bb.partial_id=prms.custom_partial_url.substring(prms.custom_partial_url.lastIndexOf("/")+1),prms.update_design&&($scope.bb.update_design=prms.update_design)):prms.design_mode&&($scope.bb.design_mode=prms.design_mode),company_id=$scope.bb.company_id,prms.company_id&&(company_id=prms.company_id),prms.affiliate_id&&($scope.bb.affiliate_id=prms.affiliate_id,$rootScope.affiliate_id=prms.affiliate_id),prms.api_url&&($scope.bb.api_url=prms.api_url),prms.partial_url&&($scope.bb.partial_url=prms.partial_url),prms.page_suffix&&($scope.bb.page_suffix=prms.page_suffix),prms.admin&&($scope.bb.isAdmin=prms.admin),prms.auth_token&&$sessionStorage.setItem("auth_token",prms.auth_token),$scope.bb.app_id=1,$scope.bb.app_key=1,$scope.bb.clear_basket=!0,prms.basket&&($scope.bb.clear_basket=!1),!1===prms.clear_basket&&($scope.bb.clear_basket=!1),($window.bb_setup||prms.client)&&(prms.clear_member||(prms.clear_member=!0)),$scope.bb.client_defaults=prms.client||{},prms.client_defaults&&prms.client_defaults.membership_ref&&($scope.bb.client_defaults.membership_ref=prms.client_defaults.membership_ref),$scope.bb.client_defaults&&$scope.bb.client_defaults.name&&(match=$scope.bb.client_defaults.name.match(/^(\S+)(?:\s(\S+))?/))&&($scope.bb.client_defaults.first_name=match[1],null!=match[2]&&($scope.bb.client_defaults.last_name=match[2])),prms.clear_member&&($scope.bb.clear_member=prms.clear_member,$sessionStorage.removeItem("login")),prms.app_id&&($scope.bb.app_id=prms.app_id),prms.app_key&&($scope.bb.app_key=prms.app_key),prms.on_conflict&&($scope.bb.on_conflict=prms.on_conflict),prms.item_defaults?($scope.bb.original_item_defaults=prms.item_defaults,$scope.bb.item_defaults=angular.copy($scope.bb.original_item_defaults)):$scope.bb.original_item_defaults&&($scope.bb.item_defaults=angular.copy($scope.bb.original_item_defaults)),$scope.bb.selected_service&&$scope.bb.selected_service.company_id===company_id&&($scope.bb.item_defaults.service=$scope.bb.selected_service.id),prms.route_format&&($scope.bb.setRouteFormat(prms.route_format),$scope.bb_route_init&&$scope.bb_route_init()),!0===prms.hide?$scope.hide_page=!0:$scope.hide_page=!1,prms.from_datetime&&($scope.bb.from_datetime=prms.from_datetime),prms.to_datetime&&($scope.bb.to_datetime=prms.to_datetime),prms.min_date&&($scope.bb.min_date=prms.min_date),prms.max_date&&($scope.bb.max_date=prms.max_date),prms.hide_block&&($scope.bb.hide_block=prms.hide_block),prms.custom_partial_url||($scope.bb.path_setup=!0),prms.extra_setup&&($scope.bb.extra_setup=prms.extra_setup,prms.extra_setup.step&&($scope.bb.starting_step_number=parseInt(prms.extra_setup.step)),prms.extra_setup.return_url&&($scope.bb.return_url=prms.extra_setup.return_url),prms.extra_setup.destination&&($scope.bb.destination=prms.extra_setup.destination)),prms.booking_settings&&($scope.bb.booking_settings=prms.booking_settings),prms.template&&($scope.bb.template=prms.template),prms.login_required&&($scope.bb.login_required=!0),prms.private_note&&($scope.bb.private_note=prms.private_note),prms.qudini_booking_id&&($scope.bb.qudini_booking_id=prms.qudini_booking_id),this.waiting_for_conn_started_def=$q.defer(),$scope.waiting_for_conn_started=this.waiting_for_conn_started_def.promise,company_id||$scope.bb.affiliate_id?$scope.waiting_for_conn_started=$rootScope.connection_started:this.waiting_for_conn_started_def.resolve(),widgetStarted.resolve(),setup_promises2=[],setup_promises=[],$scope.bb.affiliate_id&&(aff_promise=halClient.$get($scope.bb.api_url+"/api/v1/affiliates/"+$scope.bb.affiliate_id),setup_promises.push(aff_promise),aff_promise.then(function(affiliate){var comp_p,comp_promise;if($scope.bb.$wait_for_routing&&setup_promises2.push($scope.bb.$wait_for_routing.promise),setAffiliate(new BBModel.Affiliate(affiliate)),$scope.bb.item_defaults.affiliate=$scope.affiliate,prms.company_ref)return comp_p=$q.defer(),comp_promise=$scope.affiliate.getCompanyByRef(prms.company_ref),setup_promises2.push(comp_p.promise),comp_promise.then(function(company){return setCompany(company,prms.keep_basket).then(function(val){return comp_p.resolve(val)},function(err){return comp_p.reject(err)})},function(err){return comp_p.reject(err)})})),company_id&&(prms.embed&&(embed_params=prms.embed),embed_params||(embed_params=null),comp_category_id=null,null!=$scope.bb.item_defaults.category&&(comp_category_id=null!=$scope.bb.item_defaults.category.id?$scope.bb.item_defaults.category.id:$scope.bb.item_defaults.category),comp_def=$q.defer(),comp_promise=comp_def.promise,options={},$sessionStorage.getItem("auth_token")&&(options.auth_token=$sessionStorage.getItem("auth_token")),$scope.bb.isAdmin?(comp_url=new UriTemplate($scope.bb.api_url+$scope.company_admin_api_path).fillFromObject({company_id:company_id,category_id:comp_category_id,embed:embed_params}),halClient.$get(comp_url,options).then(function(company){return comp_def.resolve(company)},function(err){return comp_url=new UriTemplate($scope.bb.api_url+$scope.company_api_path).fillFromObject({company_id:company_id,category_id:comp_category_id,embed:embed_params}),halClient.$get(comp_url,options).then(function(company){return comp_def.resolve(company)},function(err){return comp_def.reject(err)})})):(comp_url=new UriTemplate($scope.bb.api_url+$scope.company_api_path).fillFromObject({company_id:company_id,category_id:comp_category_id,embed:embed_params}),halClient.$get(comp_url,options).then(function(company){return company?comp_def.resolve(company):comp_def.reject("Invalid company ID "+company_id)},function(err){return comp_def.reject(err)})),setup_promises.push(comp_promise),comp_promise.then(function(company){var child,comp,cprom,parent_company;return $scope.bb.$wait_for_routing&&setup_promises2.push($scope.bb.$wait_for_routing.promise),comp=new BBModel.Company(company),cprom=$q.defer(),setup_promises2.push(cprom.promise),child=null,comp.companies&&$scope.bb.item_defaults.company&&(child=comp.findChildCompany($scope.bb.item_defaults.company)),child?(parent_company=comp,halClient.$get($scope.bb.api_url+"/api/v1/company/"+child.id).then(function(company){return comp=new BBModel.Company(company),setupDefaults(comp.id),$scope.bb.parent_company=parent_company,setCompany(comp,prms.keep_basket).then(function(){return cprom.resolve()},function(err){return cprom.reject()})},function(err){return cprom.reject()})):(setupDefaults(comp.id),setCompany(comp,prms.keep_basket).then(function(){return cprom.resolve()},function(err){return cprom.reject()}))}),prms.member_sso&&(params={company_id:company_id,root:$scope.bb.api_url,member_sso:prms.member_sso},sso_member_login=SSOService.memberLogin(params).then(function(client){return setClient(client)}),setup_promises.push(sso_member_login)),prms.admin_sso&&(params={company_id:prms.parent_company_id?prms.parent_company_id:company_id,root:$scope.bb.api_url,admin_sso:prms.admin_sso},sso_admin_login=SSOService.adminLogin(params).then(function(admin){return $scope.bb.admin=admin}),setup_promises.push(sso_admin_login)),(total_id=$scope.bb.item_defaults&&$scope.bb.item_defaults.purchase_total_long_id?$scope.bb.item_defaults.purchase_total_long_id:QueryStringService("total_id"))&&(params={purchase_id:total_id,url_root:$scope.bb.api_url},get_total=PurchaseService.query(params).then(function(total){if($scope.bb.total=total,total.paid>0)return $scope.bb.payment_status="complete"}),setup_promises.push(get_total))),$scope.isLoaded=!1,$q.all(setup_promises).then(function(){return $q.all(setup_promises2).then(function(){var base,clear_prom,def_clear;return $scope.bb.basket||(base=$scope.bb).basket||(base.basket=new BBModel.Basket(null,$scope.bb)),$scope.client||clearClient(),def_clear=$q.defer(),clear_prom=def_clear.promise,$scope.bb.current_item?def_clear.resolve():clear_prom=bbWidgetBasket.clearBasketItem(),clear_prom.then(function(){var page;if($scope.client_details||($scope.client_details=new BBModel.ClientDetails),$scope.bb.stacked_items||($scope.bb.stacked_items=[]),($scope.bb.company||$scope.bb.affiliate)&&(bbTimeZone.determine(),connectionStarted.resolve(),$scope.done_starting=!0,!prms.no_route))return page=null,isFirstCall&&$bbug.isEmptyObject($scope.bb.routeSteps)&&(page=$scope.bb.firstStep),prms.first_page&&(page=prms.first_page),isFirstCall=!1,bbWidgetPage.decideNextPage(page);$scope.isLoaded=!0})},function(err){return connectionStarted.reject("Failed to start widget"),LoadingService.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},function(err){return connectionStarted.reject("Failed to start widget"),LoadingService.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}.bind(this),setupDefaults=function(company_id){guardScope();var category,clinic,def,event,event_chain,event_group,k,person,ref,resource,service,v;if(def=$q.defer(),isFirstCall||$scope.bb.orginal_company_id&&$scope.bb.orginal_company_id!==company_id){if($scope.bb.orginal_company_id=company_id,$scope.bb.default_setup_promises=[],$scope.bb.item_defaults.query){ref=$scope.bb.item_defaults.query;for(k in ref)v=ref[k],$scope.bb.item_defaults[k]=QueryStringService(v)}$scope.bb.item_defaults.resource&&(resource=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/resources/"+$scope.bb.item_defaults.resource):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/resources/"+$scope.bb.item_defaults.resource),$scope.bb.default_setup_promises.push(resource),resource.then(function(res){return $scope.bb.item_defaults.resource=new BBModel.Resource(res)})),$scope.bb.item_defaults.person&&(person=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/people/"+$scope.bb.item_defaults.person):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/people/"+$scope.bb.item_defaults.person),$scope.bb.default_setup_promises.push(person),person.then(function(res){return $scope.bb.item_defaults.person=new BBModel.Person(res)})),$scope.bb.item_defaults.person_ref&&(person=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/people/find_by_ref/"+$scope.bb.item_defaults.person_ref):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/people/find_by_ref/"+$scope.bb.item_defaults.person_ref),$scope.bb.default_setup_promises.push(person),person.then(function(res){return $scope.bb.item_defaults.person=new BBModel.Person(res)})),$scope.bb.item_defaults.service&&(service=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/services/"+$scope.bb.item_defaults.service):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/services/"+$scope.bb.item_defaults.service),$scope.bb.default_setup_promises.push(service),service.then(function(res){return $scope.bb.item_defaults.service=new BBModel.Service(res)})),$scope.bb.item_defaults.service_ref&&(service=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/services?api_ref="+$scope.bb.item_defaults.service_ref):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/services?api_ref="+$scope.bb.item_defaults.service_ref),$scope.bb.default_setup_promises.push(service),service.then(function(res){return $scope.bb.item_defaults.service=new BBModel.Service(res)})),$scope.bb.item_defaults.event_group&&(event_group=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/event_groups/"+$scope.bb.item_defaults.event_group):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/event_groups/"+$scope.bb.item_defaults.event_group),$scope.bb.default_setup_promises.push(event_group),event_group.then(function(res){return $scope.bb.item_defaults.event_group=new BBModel.EventGroup(res)})),$scope.bb.item_defaults.event&&(event=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/event_chains/"+$scope.bb.item_defaults.event_chain+"/events/"+$scope.bb.item_defaults.event):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/events/"+$scope.bb.item_defaults.event),$scope.bb.default_setup_promises.push(event),event.then(function(res){return $scope.bb.item_defaults.event=new BBModel.Event(res)})),$scope.bb.item_defaults.event_chain&&(event_chain=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/event_chains/"+$scope.bb.item_defaults.event_chain):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/event_chains/"+$scope.bb.item_defaults.event_chain),$scope.bb.default_setup_promises.push(event_chain),event_chain.then(function(res){return $scope.bb.item_defaults.event_chain=new BBModel.EventChain(res)})),$scope.bb.item_defaults.category&&(category=halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/categories/"+$scope.bb.item_defaults.category),$scope.bb.default_setup_promises.push(category),category.then(function(res){return $scope.bb.item_defaults.category=new BBModel.Category(res)})),$scope.bb.item_defaults.clinic&&(clinic=halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/clinics/"+$scope.bb.item_defaults.clinic),$scope.bb.default_setup_promises.push(clinic),clinic.then(function(res){return $scope.bb.item_defaults.clinic=new BBModel.Clinic(res)})),$scope.bb.item_defaults.duration&&($scope.bb.item_defaults.duration=parseInt($scope.bb.item_defaults.duration)),$q.all($scope.bb.default_setup_promises).finally(function(){return def.resolve()})}else def.resolve();return def.promise},setAffiliate=function(affiliate){return guardScope(),$scope.bb.affiliate_id=affiliate.id,$scope.bb.affiliate=affiliate,$scope.affiliate=affiliate,$scope.affiliate_id=affiliate.id},setCompany=function(company,keep_basket){guardScope();var defer;return defer=$q.defer(),$scope.bb.company_id=company.id,$scope.bb.company=company,$scope.bb.item_defaults.company=$scope.bb.company,company.$has("settings")?company.getSettings().then(function(settings){return $scope.bb.company_settings=settings,setActiveCompany(company,settings),$scope.bb.company_settings.merge_resources&&($scope.bb.item_defaults.merge_resources=!0),$scope.bb.company_settings.merge_people&&($scope.bb.item_defaults.merge_people=!0),$rootScope.bb_currency=$scope.bb.company_settings.currency,$scope.bb.currency=$scope.bb.company_settings.currency,$scope.bb.has_prices=$scope.bb.company_settings.has_prices,!$scope.bb.basket||$scope.bb.basket.company_id!==$scope.bb.company_id&&!keep_basket?bbWidgetBasket.restoreBasket().then(function(){return defer.resolve(),$scope.$emit("company:setup")}):(defer.resolve(),$scope.$emit("company:setup"))}):(!$scope.bb.basket||$scope.bb.basket.company_id!==$scope.bb.company_id&&!keep_basket?bbWidgetBasket.restoreBasket().then(function(){return defer.resolve(),$scope.$emit("company:setup")}):(defer.resolve(),$scope.$emit("company:setup")),setActiveCompany(company)),defer.promise},setClient=function(client){if(guardScope(),$scope.client=client,client.postcode&&!$scope.bb.postcode)return $scope.bb.postcode=client.postcode},clearClient=function(){if(guardScope(),$scope.client=new BBModel.Client,$window.bb_setup&&$scope.client.setDefaults($window.bb_setup),$scope.bb.client_defaults)return $scope.client.setDefaults($scope.bb.client_defaults)},setActiveCompany=function(company,settings){return guardScope(),CompanyStoreService.currency_code=settings?settings.currency:company.currency_code,CompanyStoreService.time_zone=company.timezone,CompanyStoreService.country_code=company.country_code,CompanyStoreService.settings=settings},initializeBBWidget=function(){guardScope(),$scope.bb=new BBWidget,AppConfig.uid=$scope.bb.uid,$scope.bb.stacked_items=[],$scope.bb.company_set=null!=$scope.bb.company_id,$scope.recordStep=$scope.bb.recordStep,determineBBApiUrl()},determineBBApiUrl=function(){guardScope();var base,base1;$scope.apiUrl&&($scope.bb||($scope.bb={}),$scope.bb.api_url=$scope.apiUrl),$rootScope.bb&&$rootScope.bb.api_url&&($scope.bb.api_url=$rootScope.bb.api_url,$rootScope.bb.partial_url?$scope.bb.partial_url=$rootScope.bb.partial_url:$scope.bb.partial_url=""),80!==$location.port()&&443!==$location.port()?(base=$scope.bb).api_url||(base.api_url=$location.protocol()+"://"+$location.host()+":"+$location.port()):(base1=$scope.bb).api_url||(base1.api_url=$location.protocol()+"://"+$location.host())};return{clearClient:clearClient,initWidget:initWidget,setAffiliate:setAffiliate,setActiveCompany:setActiveCompany,setCompany:setCompany,setClient:setClient,setScope:setScope,initializeBBWidget:initializeBBWidget,determineBBApiUrl:determineBBApiUrl}}angular.module("BB.Services").service("bbWidgetInit",BBWidgetInit)}(),function(){function BBWidgetPage(AlertService,BBModel,LoadingService,LoginService,$rootScope,$sce,$analytics){var $scope=null,automaticDNP={},setScope=function($s){$scope=$s},guardScope=function(){if(null===$scope)throw new Error("please set scope")},clearPage=function(){return guardScope(),$scope.bb_main=""},hidePage=function(){return guardScope(),$scope.hide_page=!0},jumpToPage=function(route){return guardScope(),$scope.current_page=route,$scope.jumped=!0,$scope.bb_main=$sce.trustAsResourceUrl($scope.partial_url+route+$scope.page_suffix)},setLoadingPage=function(val){return guardScope(),$scope.loading_page=val},isLoadingPage=function(){return guardScope(),$scope.loading_page},setPageRoute=function(route){return guardScope(),$scope.bb.current_page_route=route,!(!$scope.bb.routeSteps||!$scope.bb.routeSteps[route])&&(showPage($scope.bb.routeSteps[route]),!0)},showPage=function(route,dont_record_page){if(guardScope(),$scope.bb.updateRoute(route),$scope.jumped=!1,!isLoadingPage())return setLoadingPage(!0),$scope.bb.current_page===route?($scope.bb_main="",setTimeout(function(){return $scope.bb_main=$sce.trustAsResourceUrl($scope.bb.pageURL(route)),$scope.$apply()},0)):(AlertService.clear(),$scope.bb.current_page=route,dont_record_page||$scope.bb.recordCurrentPage(),LoadingService.notLoaded($scope),$scope.bb_main=$sce.trustAsResourceUrl($scope.bb.pageURL(route))),automaticDNP={},$analytics.pageTrack($scope.bb.current_page),$rootScope.$broadcast("page:loaded")},setPageLoaded=function(){return LoadingService.setLoaded($scope)};return{clearPage:clearPage,decideNextPage:function(route){if(guardScope(),route){if("none"===route)return;if($scope.bb.total&&"complete"===$scope.bb.payment_status){if(setPageRoute($rootScope.Route.Confirmation))return;return showPage("confirmation")}return showPage(route)}if($scope.bb.nextSteps&&$scope.bb.current_page&&$scope.bb.nextSteps[$scope.bb.current_page]&&!$scope.bb.routeSteps)return showPage($scope.bb.nextSteps[$scope.bb.current_page]);if(!$scope.client.valid()&&LoginService.isLoggedIn()&&($scope.client=new BBModel.Client(LoginService.member()._data)),$scope.bb.company&&$scope.bb.company.companies||!$scope.bb.company&&$scope.affiliate){if(setPageRoute($rootScope.Route.Company))return;return showPage("company_list")}if($scope.bb.total&&"complete"===$scope.bb.payment_status){if(setPageRoute($rootScope.Route.Confirmation))return;return showPage("confirmation")}if($scope.bb.total&&"pending"===$scope.bb.payment_status)return showPage("payment");if($scope.bb.company.$has("event_groups")&&!$scope.bb.current_item.event_group&&!$scope.bb.current_item.service&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal||$scope.bb.company.$has("events")&&$scope.bb.current_item.event_group&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if(setPageRoute($rootScope.Route.Event))return;return showPage("event_list")}if(!(!$scope.bb.company.$has("events")||!$scope.bb.current_item.event||$scope.bb.current_item.num_book||$scope.bb.current_item.tickets&&$scope.bb.current_item.tickets.qty||$scope.bb.current_item.product||$scope.bb.current_item.deal))return showPage("event");if($scope.bb.company.$has("services")&&!$scope.bb.current_item.service&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if(setPageRoute($rootScope.Route.Service))return;return showPage("service_list")}if($scope.bb.company.$has("resources")&&!$scope.bb.current_item.resource&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if(setPageRoute($rootScope.Route.Resource))return;return showPage("resource_list")}if($scope.bb.company.$has("people")&&!$scope.bb.current_item.person&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if(setPageRoute($rootScope.Route.Person))return;return showPage("person_list")}if(!($scope.bb.current_item.duration||null!=$scope.bb.current_item.event||$scope.bb.current_item.product||$scope.bb.current_item.deal)){if(setPageRoute($rootScope.Route.Duration))return;return showPage("duration_list")}if($scope.bb.current_item.days_link&&!$scope.bb.current_item.date&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.deal){if($scope.bb.company.$has("availability_slots")){if(setPageRoute($rootScope.Route.Slot))return;return showPage("slot_list")}if(setPageRoute($rootScope.Route.Date))return;return showPage("calendar")}if(!(!$scope.bb.current_item.days_link||$scope.bb.current_item.time||null!=$scope.bb.current_item.event||$scope.bb.current_item.service&&"day"===$scope.bb.current_item.service.duration_unit||$scope.bb.current_item.deal)){if(setPageRoute($rootScope.Route.Time))return;return showPage("time")}if(!(!$scope.bb.moving_booking||$scope.bb.current_item.ready&&$scope.bb.current_item.move_done))return showPage("check_move");if(!$scope.client.valid()){if(setPageRoute($rootScope.Route.Client))return;return showPage("client")}if($scope.bb.current_item.item_details&&$scope.bb.current_item.item_details.hasQuestions&&!$scope.bb.current_item.asked_questions){if(setPageRoute($rootScope.Route.Questions))return;return showPage("check_items")}if($scope.bb.moving_booking&&$scope.bb.basket.itemsReady())return showPage("purchase");if(!$scope.bb.basket.readyToCheckout()){if(setPageRoute($rootScope.Route.Summary))return;return showPage("basket_summary")}if($scope.bb.usingBasket&&(!$scope.bb.confirmCheckout||$scope.bb.company_settings.has_vouchers||$scope.bb.company.$has("coupon"))){if(setPageRoute($rootScope.Route.Basket))return;return showPage("basket")}if($scope.bb.basket.readyToCheckout()&&null===$scope.bb.payment_status&&!$scope.bb.basket.waiting_for_checkout){if(setPageRoute($rootScope.Route.Checkout))return;return showPage("checkout")}if("complete"===$scope.bb.payment_status){if(setPageRoute($rootScope.Route.Confirmation))return;return showPage("confirmation")}},hidePage:hidePage,isLoadingPage:isLoadingPage,jumpToPage:jumpToPage,setLoadingPage:setLoadingPage,setPageLoaded:setPageLoaded,setPageRoute:setPageRoute,setScope:setScope,showPage:showPage,canAutoDecideNextPage:function(widget){return!automaticDNP.hasOwnProperty(widget)||automaticDNP[widget]},setAutoDecideNextPage:function(widget){var state=arguments.length>1&&void 0!==arguments[1]&&arguments[1];automaticDNP[widget]=state}}}angular.module("BB").service("bbWidgetPage",BBWidgetPage)}(),function(){function BBWidgetStep(BBModel,LoginService,$rootScope,bbWidgetPage,$window,bbAnalyticsPiwik){function setPiwik(){var category=$scope.bb.current_page;bbAnalyticsPiwik.push(["trackEvent",[category],"Load Previous Step"])}var $scope=null,setScope=function($s){$scope=$s},guardScope=function(){if(null===$scope)throw new Error("please set scope")},setStepTitle=function(title){return guardScope(),$scope.bb.steps[$scope.bb.current_step-1].title=title},checkStepTitle=function(title){if(guardScope(),$scope.bb.steps[$scope.bb.current_step-1]&&!$scope.bb.steps[$scope.bb.current_step-1].title)return setStepTitle(title)},getCurrentStepTitle=function(){var steps;if(guardScope(),steps=$scope.bb.steps,(!_.compact(steps).length||1===steps.length&&steps[0].number!==$scope.bb.current_step)&&(steps=$scope.bb.allSteps),$scope.bb.current_step)return steps[$scope.bb.current_step-1].title},loadStep=function(stepClickedNumber){if(guardScope(),stepClickedNumber!==$scope.bb.current_step){$scope.bb.calculatePercentageComplete(stepClickedNumber);var stepClickedPlusOne=$scope.bb.steps[stepClickedNumber],stepClicked=$scope.bb.steps[stepClickedNumber-1];return stepClickedPlusOne&&!stepClicked&&(stepClicked=stepClickedPlusOne),stepClickedPlusOne||(stepClickedPlusOne=stepClicked),stepClickedPlusOne&&!$scope.bb.last_step_reached&&(stepClickedPlusOne.stacked_length&&0!==stepClickedPlusOne.stacked_length||($scope.bb.stacked_items=[]),$scope.bb.current_item.loadStep(stepClickedPlusOne.current_item),$scope.bb.steps.length>1&&$scope.bb.steps.splice(stepClickedNumber,$scope.bb.steps.length-stepClickedNumber),$scope.bb.current_step=stepClickedNumber,bbWidgetPage.showPage(stepClicked.page,!0)),$scope.bb.allSteps&&($scope.bb.allSteps.map(function(step){step.active=!1,step.passed=step.number<$scope.bb.current_step}),$scope.bb.allSteps[$scope.bb.current_step-1])?$scope.bb.allSteps[$scope.bb.current_step-1].active=!0:void 0}},loadPreviousStep=function(caller){bbAnalyticsPiwik.isEnabled()&&setPiwik();var last_step,pages_to_remove_from_history,past_steps,step_to_load;for(guardScope(),past_steps=_.reject($scope.bb.steps,function(s){return s.number>=$scope.bb.current_step}),step_to_load=0;past_steps[0]&&(last_step=past_steps.pop());)if(!last_step.skipped){step_to_load=last_step.number;break}if($scope.bb.routeFormat&&(pages_to_remove_from_history=0===step_to_load?$scope.bb.current_step+1:$scope.bb.current_step-step_to_load,"locationChangeStart"===caller&&pages_to_remove_from_history--,pages_to_remove_from_history>0&&window.history.go(-1*pages_to_remove_from_history)),step_to_load>0)return loadStep(step_to_load)},loadStepByPageName=function(page_name){var i,len,ref,step;for(guardScope(),ref=$scope.bb.allSteps,i=0,len=ref.length;i<len;i++)if(step=ref[i],step.page===page_name)return loadStep(step.number);return loadStep(1)},reset=function(){return guardScope(),$rootScope.$broadcast("clear:formData"),$rootScope.$broadcast("widget:restart"),setLastSelectedDate(null),LoginService.isLoggedIn()||($scope.client=new BBModel.Client),$scope.bb.last_step_reached=!1,$scope.bb.steps.splice(1)},restart=function(){return guardScope(),reset(),loadStep(1)},setLastSelectedDate=function(date){return guardScope(),$scope.last_selected_date=date};return{checkStepTitle:checkStepTitle,getCurrentStepTitle:getCurrentStepTitle,loadPreviousStep:loadPreviousStep,loadStep:loadStep,loadStepByPageName:loadStepByPageName,reset:reset,restart:restart,setLastSelectedDate:setLastSelectedDate,setScope:setScope,setStepTitle:setStepTitle,skipThisStep:function(){if($scope.bb.steps[$scope.bb.steps.length-1])return $scope.bb.steps[$scope.bb.steps.length-1].skipped=!0}}}angular.module("BB").service("bbWidgetStep",BBWidgetStep)}(),function(){function BBWidgetUtilities($window,BBModel,bbWidgetPage,bbWidgetStep,AppService,$timeout,LoginService){var $scope=null;return{setScope:function($s){$scope=$s},isAdmin:function(){return $scope.bb.isAdmin},showLoaderHandler:function(){$scope.loading=!0},hideLoaderHandler:function(){$scope.loading=!1},locationChangeStartHandler:function(angular_event,new_url,old_url){var step_number;$scope.bb.routeFormat&&($scope.bb.routing&&!AppService.isModalOpen()||(step_number=$scope.bb.matchURLToStep(),step_number>$scope.bb.current_step?bbWidgetStep.loadStep(step_number):step_number<$scope.bb.current_step&&bbWidgetStep.loadPreviousStep("locationChangeStart")),$scope.bb.routing=!1)},getPartial:function(file){return $scope.bb.pageURL(file)},logout:function(route){return $scope.client&&$scope.client.valid()?LoginService.logout({root:$scope.bb.api_url}).then(function(){return $scope.client=new BBModel.Client,bbWidgetPage.decideNextPage(route)}):$scope.member?LoginService.logout({root:$scope.bb.api_url}).then(function(){return $scope.member=new BBModel.Member.Member,bbWidgetPage.decideNextPage(route)}):void 0},setRoute:function(rdata){return $scope.bb.setRoute(rdata)},getUrlParam:function(param){return $window.getURIparam(param)},base64encode:function(param){return $window.btoa(param)},broadcastItemUpdate:function(){var state=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return $scope.$broadcast("currentItemUpdate",$scope.bb.current_item,state)},isAdminIFrame:function(){if(!$scope.bb.isAdmin)return!1;try{return!(!$window.parent.location.href||!$window.parent.reload_dashboard)}catch(_error){return!1}},reloadDashboard:function(){return $window.parent.reload_dashboard()},$debounce:function(tim){return!$scope._debouncing&&(tim||(tim=100),$scope._debouncing=!0,$timeout(function(){return $scope._debouncing=!1},tim))},supportsTouch:function(){return Modernizr.touch},isMemberLoggedIn:function(){return LoginService.isLoggedIn()},scrollTo:function(id){return $location.hash(id),$anchorScroll()},redirectTo:function(url){return $window.location.href=url}}}angular.module("BB.Services").service("bbWidgetUtilities",BBWidgetUtilities)}(),angular.module("BB.Directives").directive("bbApiUrl",function($rootScope,$compile,$sniffer,$timeout,$window,$location){return{restrict:"A",scope:{apiUrl:"@bbApiUrl"},compile:function(tElem,tAttrs){return{pre:function(scope,element,attrs){$rootScope.bb||($rootScope.bb={}),$rootScope.bb.api_url=scope.apiUrl;var url=document.createElement("a");if(url.href=scope.apiUrl,($sniffer.msie&&$sniffer.msie<=9||$sniffer.webkit&&$sniffer.webkit<537)&&""!==url.host&&url.host!==$location.host()&&url.host!==$location.host()+":"+$location.port()){var src=void 0
;return src=":"===url.protocol[url.protocol.length-1]?url.protocol+"//"+url.host+"/ClientProxy.html":url.protocol+"://"+url.host+"/ClientProxy.html",$rootScope.iframe_proxy_ready=!1,$compile("<iframe id='ieapiframefix' name='"+url.hostname+"' src='"+src+"' style='visibility:false;display:none;'></iframe>")(scope,function(cloned,scope){return cloned.bind("load",function(){return $rootScope.iframe_proxy_ready=!0,$rootScope.$broadcast("iframe_proxy_ready",{iframe_proxy_ready:!0})}),element.append(cloned)})}}}}}}),angular.module("BB.Directives").directive("bbBlurOnReturn",function($timeout){return{restrict:"A",require:"ngModel",link:function(scope,el,attrs){return el.keydown(function(e){var key=e.which||e.keyCode;if(13===key||"13"===key)return $timeout(function(){if(e.target)return e.target.blur()},10)})}}}),angular.module("BB.Directives").directive("bbBookingExport",function(){return{restrict:"AE",scope:{booking:"=bbBookingExport"},templateUrl:"_popout_export_booking.html",link:function(scope,el,attrs){var setHTML=void 0;return scope.$watch("booking",function(new_val,old_val){if(new_val)return setHTML()}),setHTML=function(){return scope.content="<div class='text-center'><a href='"+scope.booking.webcalLink()+"'><img src='images/outlook.png' alt='outlook calendar icon' height='30' width='30' /><div class='clearfix'></div><span>Outlook</span></a></div><p></p><div class='text-center'><a href='"+scope.booking.gcalLink()+"'><img src='images/google.png' alt='google calendar icon' height='30' width='30' /><div class='clearfix'></div><span>Google</span></a></div><p></p><div class='text-center'><a href='"+scope.booking.icalLink()+"'><img src='images/ical.png' alt='ical calendar icon' height='30' width='30' /><div class='clearfix'></div><span>iCal</span></a></div>"}}}}),angular.module("BB.Directives").directive("bbCapitaliseFirstLetter",function(){return{restrict:"A",require:["ngModel"],link:function(scope,element,attrs,ctrls){var ngModel=ctrls[0];return scope.$watch(attrs.ngModel,function(newval,oldval){if(newval){var string=scope.$eval(attrs.ngModel);return string=string.charAt(0).toUpperCase()+string.slice(1),ngModel.$setViewValue(string),void ngModel.$render()}})}}}),angular.module("BB.Directives").directive("bbCommPref",function(){return{restrict:"A",require:["ngModel"],link:function(scope,element,attrs,ctrls){var ng_model_ctrl=ctrls[0],comm_pref=scope.$eval(attrs.bbCommPref)||!1;null!=scope.bb.current_item.settings.send_email_followup&&null!=scope.bb.current_item.settings.send_sms_followup?comm_pref=scope.bb.current_item.settings.send_email_followup:(scope.bb.current_item.settings.send_email_followup=comm_pref,scope.bb.current_item.settings.send_sms_followup=comm_pref),ng_model_ctrl.$setViewValue(comm_pref);var parser=function(value){return scope.bb.current_item.settings.send_email_followup=value,scope.bb.current_item.settings.send_sms_followup=value,value};return ng_model_ctrl.$parsers.push(parser)}}}),angular.module("BB.Directives").directive("bbCountTicketTypes",function($rootScope){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var countTicketTypes=void 0;return $rootScope.connection_started.then(function(){return countTicketTypes()}),scope.$on("basket:updated",function(event,basket){return countTicketTypes()}),countTicketTypes=function(items){items=scope.bb.basket.timeItems();var counts=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;item.tickets&&(counts[item.tickets.name]?counts[item.tickets.name]+=item.tickets.qty:counts[item.tickets.name]=item.tickets.qty,item.number=counts[item.tickets.name])}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return scope.counts=counts}}}}),angular.module("BB.Directives").directive("bbDate",function(){return{restrict:"AE",scope:!0,link:function(scope,element,attrs){var date=void 0,track_service=null!=attrs.bbTrackService;return date=attrs.bbDate?moment(scope.$eval(attrs.bbDate)):scope.bb&&scope.bb.current_item&&scope.bb.current_item.date?scope.bb.current_item.date.date:moment(),track_service&&scope.bb.current_item&&scope.bb.current_item.service&&(scope.min_date=scope.bb.current_item.service.min_advance_datetime,scope.max_date=scope.bb.current_item.service.max_advance_datetime),scope.$broadcast("dateChanged",moment(date)),scope.bb_date={date:date,js_date:date.toDate(),addDays:function(type,amount){return this.date=moment(this.date).add(amount,type),this.js_date=this.date.toDate(),scope.$broadcast("dateChanged",moment(this.date))},subtractDays:function(type,amount){return this.addDays(type,-amount)},setDate:function(date){return this.date=date,this.js_date=date.toDate(),scope.$broadcast("dateChanged",moment(this.date))}},scope.$on("currentItemUpdate",function(event){if(scope.bb.current_item.service&&track_service&&(scope.min_date=scope.bb.current_item.service.min_advance_datetime,scope.max_date=scope.bb.current_item.service.max_advance_datetime,scope.bb_date.date.isBefore(scope.min_date,"day")&&scope.bb_date.setDate(scope.min_date.clone()),scope.bb_date.date.isAfter(scope.max_date,"day")))return scope.bb_date.setDate(scope.max_date.clone())}),scope.$watch("bb_date.js_date",function(newval,oldval){var ndate=moment(newval);if(!scope.bb_date.date.isSame(ndate)&&(scope.bb_date.date=ndate,moment(ndate).isValid()))return scope.$broadcast("dateChanged",moment(ndate))})}}}),angular.module("BB.Directives").directive("bbDateSplit",function($parse){return{restrict:"A",require:["ngModel"],link:function(scope,element,attrs,ctrls){var ngModel=ctrls[0],question=scope.$eval(attrs.bbDateSplit);if(question.date={day:null,month:null,year:null,date:null,joinDate:function(){if(this.day&&this.month&&this.year){var date_string=this.day+"/"+this.month+"/"+this.year;return this.date=moment(date_string,"DD/MM/YYYY"),date_string=this.date.toISODate(),ngModel.$setViewValue(date_string),ngModel.$render()}},splitDate:function(date){if(date&&date.isValid())return this.day=date.date(),this.month=date.month()+1,this.year=date.year(),this.date=date}},question.answer&&question.date.splitDate(moment(question.answer)),ngModel.$viewValue)return question.date.splitDate(moment(ngModel.$viewValue))}}}),angular.module("BB.Directives").directive("bbDebounce",function($timeout){return{restrict:"A",link:function(scope,element,attrs){var delay=400;return attrs.bbDebounce&&(delay=attrs.bbDebounce),element.bind("click",function(){return $timeout(function(){return element.attr("disabled",!0)},0),$timeout(function(){return element.attr("disabled",!1)},delay)})}}}),angular.module("BB.Directives").directive("bbDynamicFooter",function($timeout,$bbug){return function(scope,el,attrs){return scope.$on("page:loaded",function(){return $bbug(".content").css("height","auto")}),scope.$watch(function(){return $bbug(".content")[0].scrollHeight},function(new_val,old_val){if(new_val!==old_val)return scope.setContentHeight()}),scope.setContentHeight=function(){$bbug(".content").css("height","auto");var content_height=$bbug(".content")[0].scrollHeight,min_content_height=$bbug(window).innerHeight()-$bbug(".content").offset().top-$bbug(".footer").height();if(content_height<min_content_height)return $bbug(".content").css("height",min_content_height+"px")},$bbug(window).on("resize",function(){return scope.setContentHeight()})}}),angular.module("BB.Directives").directive("bbFormResettable",function($parse){return{restrict:"A",controller:function($scope,$element,$attrs){return $scope.inputs=[],$scope.resetForm=function(options){return options&&options.clear_submitted&&($scope[$attrs.name].submitted=!1),Array.from($scope.inputs).map(function(input){return input.getter.assign($scope,null),input.controller.$setPristine()})},{registerInput:function(input,ctrl){var getter=$parse(input);return $scope.inputs.push({getter:getter,controller:ctrl})}}}}}),angular.module("BB.Directives").directive("bbHeader",function($compile){return{link:function(scope,element,attr){return scope.bb.waitForRoutes(),scope.$watch("bb.path_setup",function(newval,oldval){if(newval)return element.attr("ng-include","'"+scope.getPartial(attr.bbHeader)+"'"),element.attr("bb-header",null),$compile(element)(scope)})}}}),angular.module("BB.Directives").directive("bbInclude",function($compile,$rootScope,$analytics){return{link:function(scope,element,attr){var track_page=null!=attr.bbTrackPage;return scope.$watch("bb.path_setup",function(newval,oldval){newval&&(element.attr("ng-include","'"+scope.getPartial(attr.bbInclude)+"'"),element.attr("bb-include",null),$compile(element)(scope),track_page&&$analytics.pageTrack(attr.bbInclude))})}}}),angular.module("BB.Directives").directive("bbLocalNumber",function($filter){return{restrict:"A",scope:{},require:"ngModel",link:function(scope,element,attrs,ctrl){scope.userinput_mobile=null;var storeNumber=function(value){return value&&(scope.userinput_mobile=value),value},prettyifyNumber=function(value){return scope.userinput_mobile?value=scope.userinput_mobile:$filter("local_phone_number")(value)};return ctrl.$parsers.push(storeNumber),ctrl.$formatters.push(prettyifyNumber)}}}),angular.module("BB.Directives").directive("bbPadWithZeros",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var options=scope.$eval(attrs.bbPadWithZeros)||{},how_many=options.how_many||2,padNumber=function(value){if((value=String(value))&&value.length<how_many){for(var padding="",index=1,end=how_many-value.length,asc=1<=end;asc?index<=end:index>=end;asc?index++:index--)padding+="0";value=padding.concat(value)}return value};return ctrl.$formatters.push(padNumber)}}}),angular.module("BB.Directives").directive("bbPriceFilter",function(PathSvc){return{restrict:"AE",replace:!0,scope:!1,require:"^?bbServices",templateUrl:function(element,attrs){return PathSvc.directivePartial("_price_filter")},controller:function($scope,$attrs){$scope.$watch("items",function(new_val,old_val){if(new_val)return setPricefilter(new_val)});var setPricefilter=function(items){return $scope.price_array=_.uniq(_.map(items,function(item){return item.price/100||0})),$scope.price_array.sort(function(a,b){return a-b}),suitable_max()},suitable_max=function(){var top_number=_.last($scope.price_array),max_number=function(){switch(!1){case top_number>=1:return 0;case top_number>=11:return 10;case top_number>=51:return 50;case top_number>=101:return 100;case top_number>=1e3:return 100*Math.ceil(top_number/100)}}();return $scope.price_options={min:0,max:max_number},$scope.filters.price={min:0,max:max_number}};return $scope.$watch("filters.price.min",function(new_val,old_val){if(new_val!==old_val)return $scope.filterChanged()}),$scope.$watch("filters.price.max",function(new_val,old_val){if(new_val!==old_val)return $scope.filterChanged()})}}}),angular.module("BB.Directives").directive("bbPrintPage",function($window,$timeout){return{restrict:"A",link:function(scope,element,attr){if(attr.bbPrintPage)return scope.$watch(attr.bbPrintPage,function(newVal,oldVal){return $timeout(function(){return $window.print()},3e3)})}}}),angular.module("BB.Directives").directive("bbRaiseAlertWhenInvalid",function($compile){return{require:"^form",link:function(scope,element,attr,ctrl){ctrl.raise_alerts=!0;var options=scope.$eval(attr.bbRaiseAlertWhenInvalid);if(options&&options.alert)return ctrl.alert=options.alert}}}),angular.module("BB.Directives").directive("bbResettable",function(){return{restrict:"A",require:["ngModel","^bbFormResettable"],link:function(scope,element,attrs,ctrls){var ngModelCtrl=ctrls[0];return ctrls[1].registerInput(attrs.ngModel,ngModelCtrl)}}}),angular.module("BB.Directives").directive("ngConfirmClick",function(){return{link:function(scope,element,attr){var msg=attr.ngConfirmClick||"Are you sure?",clickAction=attr.ngConfirmedClick;return element.bind("click",function(event){if(window.confirm(msg))return scope.$eval(clickAction)})}}}),angular.module("BB.Directives").directive("ngDelayed",function($compile){return{link:function(scope,element,attr){return scope[attr.ngDelayedWatch].then(function(logged){if(element.attr(attr.ngDelayed,attr.ngDelayedValue),element.attr("ng-delayed-value",null),element.attr("ng-delayed-watch",null),element.attr("ng-delayed",null),$compile(element)(scope),attr.ngDelayedReady)return scope[attr.ngDelayedReady].resolve(!0)})}}}),angular.module("BB.Directives").directive("ngInitial",function(){return{restrict:"A",controller:["$scope","$element","$attrs","$parse",function($scope,$element,$attrs,$parse){var val=$attrs.ngInitial||$attrs.value,getter=$parse($attrs.ngModel),setter=getter.assign;return"true"===val?val=!0:"false"===val&&(val=!1),setter($scope,val)}]}}),angular.module("BB.Directives").directive("ngValidInclude",function($compile){return{link:function(scope,element,attr){return scope[attr.watchValue].then(function(logged){return element.attr("ng-include",attr.ngValidInclude),element.attr("ng-valid-include",null),$compile(element)(scope)})}}}),angular.module("BB.Directives").directive("bbCurrencyField",function($filter){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var convertToCurrency=function(value){return value/100},convertToInteger=function(value){return 100*value};return ctrl.$formatters.push(convertToCurrency),ctrl.$parsers.push(convertToInteger)}}}),angular.module("BB.Directives").directive("bbFocus",[function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){return ctrl.$focused=!1,element.bind("focus",function(evt){return element.addClass("bb-focused"),scope.$apply(function(){return ctrl.$focused=!0})}).bind("blur",function(evt){return element.removeClass("bb-focused"),scope.$apply(function(){return ctrl.$focused=!1})})}}}]);var bbFormDirective=function($bbug,$window,ValidatorService,$timeout,GeneralOptions,scrollIntercepter){"ngInject";return{restrict:"A",require:["^form","?^^bbPage"],scope:"true",link:function(scope,elem,attrs,ctrls){var $bbPageCtrl=null,$formCtrl=null,setSubmitted=function setSubmitted(form){form.$setSubmitted(),form.submitted=!0,angular.forEach(form,function(item){item&&item.$$parentForm===form&&item.$setSubmitted&&setSubmitted(item)})},submitForm=function(){setSubmitted($formCtrl),$timeout(scrollAndFocusOnInvalid,100);var isValid=ValidatorService.validateForm($formCtrl);return isValid&&null!=$bbPageCtrl&&null==attrs.noRoute&&serveBBPage(),isValid},serveBBPage=function(){var route=attrs.bbFormRoute;$bbPageCtrl.$scope.checkReady(),null!=route&&route.length>0?$bbPageCtrl.$scope.routeReady(route):$bbPageCtrl.$scope.routeReady()},scrollAndFocusOnInvalid=function(){var invalidFormGroup=elem.find(".has-error:first");if(invalidFormGroup&&invalidFormGroup.length>0&&!$formCtrl.raise_alerts){scrollIntercepter.scrollToElement(invalidFormGroup,1e3,"form:invalid");invalidFormGroup.find(".ng-invalid").focus()}};!function(){$formCtrl=ctrls[0],$bbPageCtrl=ctrls[1],scope.submitForm=submitForm,null==attrs.disableAutoSubmit&&elem.on("submit",submitForm)}()}}};angular.module("BB.Directives").directive("bbForm",bbFormDirective),angular.module("BB.Directives").directive("bbInputGroup",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ngModel){if(!(scope.input_manger.inputs.indexOf(ngModel.$name)>=0))return scope.input_manger.registerInput(ngModel,attrs.bbInputGroup),scope.$watch(attrs.ngModel,function(newval,oldval){if(newval===!oldval)return scope.input_manger.validateInputGroup(attrs.bbInputGroup)})}}}),angular.module("BB.Directives").directive("bbInputGroupManager",function(ValidatorService){return{restrict:"A",controller:function($scope,$element,$attrs){return $scope.input_manger={input_groups:{},inputs:[],registerInput:function(input,name){if(!(this.inputs.indexOf(input.$name)>=0))return this.inputs.push(input.$name),this.input_groups[name]||(this.input_groups[name]={inputs:[],valid:!1}),this.input_groups[name].inputs.push(input)},validateInputGroup:function(name){var is_valid=!1,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(this.input_groups[name].inputs)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var input=_step.value;if(is_valid=input.$modelValue)break}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}if(is_valid===!this.input_groups[name].valid){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this.input_groups[name].inputs)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)input=_step2.value,input.$setValidity(input.$name,is_valid)}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return this.input_groups[name].valid=is_valid}}},$element.on("submit",function(){return function(){var result=[];for(var input_group in $scope.input_manger.input_groups)result.push($scope.input_manger.validateInputGroup(input_group));return result}()})}}}),angular.module("BB.Directives").directive("bbMatchInput",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl,ngModel){scope.$watch(attrs.bbMatchInput,function(){return scope.val_1=scope.$eval(attrs.bbMatchInput),compare(ctrl.$viewValue)});var compare=function(value){return ctrl.$setValidity("match",scope.val_1===value),value};return ctrl.$parsers.push(compare)}}}),angular.module("BB.Directives").directive("bbQuestionLabel",function($compile){return{transclude:!1,restrict:"A",scope:!1,link:function(scope,element,attrs){return scope.$watch(attrs.bbQuestionLabel,function(question){if(question&&("check"===question.detail_type||"check-price"===question.detail_type))return element.html("")})}}}),angular.module("BB.Directives").directive("bbQuestionLine",function($compile){return{transclude:!1,restrict:"A",link:function(scope,element,attrs){if("heading"===scope.question.detail_type){var elm="";scope.question.name.length>0&&(elm+="<div class='bb-question-heading'>"+scope.question.name+"</div>"),scope.question.help_text&&scope.question.help_text.length>0&&(elm+="<div class='bb-question-help-text'>"+scope.question.help_text+"</div>"),element.html(elm)}if(scope.idmaps&&(scope.idmaps[scope.question.detail_type]&&scope.idmaps[scope.question.detail_type].block||scope.idmaps[scope.question.id]&&scope.idmaps[scope.question.id].block)){var index=scope.idmaps[scope.question.id]?scope.question.id:scope.question.detail_type,html=scope.$parent.idmaps[index].html;return $compile(html)(scope,function(cloned,scope){return element.replaceWith(cloned)})}}}}),angular.module("BB.Directives").directive("bbQuestionLink",function($compile){return{transclude:!1,restrict:"A",scope:!0,link:function(scope,element,attrs){var id=parseInt(attrs.bbQuestionLink);return scope.$watch("question_set",function(newval,oldval){if(newval)return function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(scope.question_set)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var q=_step.value,item=void 0;q.id===id&&(scope.question=q,element.attr("ng-model","question.answer"),element.attr("bb-question-link",null),item=$compile(element)(scope)),result.push(item)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}()})}}}),angular.module("BB.Directives").directive("bbQuestionSet",function($compile){return{transclude:!1,restrict:"A",scope:!0,link:function(scope,element,attrs){var set=attrs.bbQuestionSet;return element.addClass("ng-hide"),scope.$watch(set,function(newval,oldval){if(newval)return scope.question_set=newval,element.removeClass("ng-hide")})}}}),angular.module("BB.Directives").directive("bbQuestionSetup",function(){return{restrict:"A",terminal:!0,priority:1e3,link:function(scope,element,attrs){for(var idmaps={},iterable=element.children(),index=0;index<iterable.length;index++){var child=iterable[index],id=$(child).attr("bb-question-id"),block=!1;$(child).attr("bb-replace-block")&&(block=!0),child.innerHTML=child.innerHTML.replace(/question_form/g,"question_form_"+index),idmaps[id]={id:id,html:child.innerHTML,block:block}}return scope.idmaps=idmaps,element.replaceWith("")}}}),angular.module("BB.Directives").directive("cardSecurityCode",function(){return{restrict:"AC",link:function(scope,element,attributes){return scope.$watch("cardType",function(newValue){return"american_express"===newValue?(element.attr("maxlength",4),element.attr("placeholder","••••")):(element.attr("maxlength",3),element.attr("placeholder","•••"))})},scope:{cardType:"="}}}),angular.module("BB.Directives").directive("creditCardNumber",function(){var getCardType=function(ccnumber){return ccnumber?(ccnumber=ccnumber.toString().replace(/\s+/g,""),/^(34)|^(37)/.test(ccnumber)?"american_express":/^(62)|^(88)/.test(ccnumber)?"china_unionpay":/^30[0-5]/.test(ccnumber)?"diners_club_carte_blanche":/^(2014)|^(2149)/.test(ccnumber)?"diners_club_enroute":/^36/.test(ccnumber)?"diners_club_international":/^(6011)|^(622(1(2[6-9]|[3-9][0-9])|[2-8][0-9]{2}|9([01][0-9]|2[0-5])))|^(64[4-9])|^65/.test(ccnumber)?"discover":/^35(2[89]|[3-8][0-9])/.test(ccnumber)?"jcb":/^(6304)|^(6706)|^(6771)|^(6709)/.test(ccnumber)?"laser":/^(5018)|^(5020)|^(5038)|^(5893)|^(6304)|^(6759)|^(6761)|^(6762)|^(6763)|^(0604)/.test(ccnumber)?"maestro":/^5[1-5]/.test(ccnumber)?"master":/^4/.test(ccnumber)?"visa":/^(4026)|^(417500)|^(4405)|^(4508)|^(4844)|^(4913)|^(4917)/.test(ccnumber)?"visa_electron":void 0):""},isValid=function(ccnumber){if(!ccnumber)return!1;ccnumber=ccnumber.toString().replace(/\s+/g,"");for(var len=ccnumber.length,mul=0,prodArr=[[0,1,2,3,4,5,6,7,8,9],[0,2,4,6,8,1,3,5,7,9]],sum=0;len--;)sum+=prodArr[mul][parseInt(ccnumber.charAt(len),10)],mul^=1;return sum%10==0&&sum>0};return{restrict:"C",require:"ngModel",link:function(scope,element,attributes,ngModel){return scope.$watch(function(){return ngModel.$modelValue},function(newValue){return ngModel.$setValidity("card_number",isValid(newValue)),scope.cardType=getCardType(newValue),null!=newValue&&16===newValue.length?ngModel.$invalid?(element.parent().addClass("has-error"),element.parent().removeClass("has-success")):(element.parent().removeClass("has-error"),element.parent().addClass("has-success")):element.parent().removeClass("has-success")})},scope:{cardType:"="}}}),angular.module("BB.Directives").directive("ngMax",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){var maxValidator=function(value){var max=scope.$eval(attr.ngMax);return ctrl.$setValidity("ngMax",angular.isUndefined(value)||""===value||null===value||value!==value||value<=max),value};ctrl.$parsers.push(maxValidator),ctrl.$formatters.push(maxValidator)}}}),angular.module("BB.Directives").directive("ngMin",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){var minValidator=function(value){var min=scope.$eval(attr.ngMin)||0;return ctrl.$setValidity("ngMin",angular.isUndefined(value)||""===value||null===value||value!==value||value>=min),value};ctrl.$parsers.push(minValidator),ctrl.$formatters.push(minValidator)}}}),angular.module("BB.Directives").directive("bbAddressMap",function($document){return{restrict:"A",scope:!0,replace:!0,controller:function($scope,$element,$attrs,uiGmapGoogleMapApi){return $scope.isDraggable=$document.width()>480,uiGmapGoogleMapApi.then(function(maps){return maps.visualRefresh=!0,$scope.$watch($attrs.bbAddressMap,function(new_val,old_val){if(new_val){var map_item=new_val;return $scope.map={center:{latitude:map_item.lat,longitude:map_item.long},zoom:15},$scope.options={scrollwheel:!1,draggable:$scope.isDraggable},$scope.marker={id:0,coords:{latitude:map_item.lat,longitude:map_item.long}}}})})}}}),angular.module("BB.Directives").directive("bbBackgroundImage",function(){return{restrict:"A",scope:!0,link:function(scope,el,attrs){var killWatch=void 0;if(attrs.bbBackgroundImage&&""!==attrs.bbBackgroundImage)return killWatch=scope.$watch(attrs.bbBackgroundImage,function(new_val,old_val){if(new_val)return killWatch(),el.css("background-image",'url("'+new_val+'")')})}}}),angular.module("BB.Directives").directive("bbCapacityView",function(){return{restrict:"A",template:"{{capacity_view_description}}",link:function(scope,el,attrs){var killWatch=void 0,ticket_type=attrs.ticketTypeSingular||"ticket";return killWatch=scope.$watch(attrs.bbCapacityView,function(item){if(item){killWatch();var num_spaces_plural=item.num_spaces>1?"s":"",spaces_left_plural=item.spaces_left>1?"s":"";switch(item.chain.capacity_view){case"NUM_SPACES":return scope.capacity_view_description=scope.ticket_spaces=item.num_spaces+" "+ticket_type+num_spaces_plural;case"NUM_SPACES_LEFT":return scope.capacity_view_description=scope.ticket_spaces=item.spaces_left+" "+ticket_type+spaces_left_plural+" available";case"NUM_SPACES_AND_SPACES_LEFT":return scope.capacity_view_description=scope.ticket_spaces=item.spaces_left+" of "+item.num_spaces+" "+ticket_type+num_spaces_plural+" available"}}})}}}),angular.module("BB.Directives").directive("bbContent",function($compile){return{transclude:!1,restrict:"A",link:function(scope,element,attrs){return element.attr("ng-include","bb_main"),element.attr("onLoad","initPage()"),element.attr("bb-content",null),element.attr("ng-hide","hide_page"),scope.initPage=function(){return scope.setPageLoaded(),scope.setLoadingPage(!1)},$compile(element)(scope)}}}),angular.module("BB.Directives").directive("bbLoading",function($compile,$timeout,$bbug,LoadingService){return{link:function(scope,element,attrs){scope.scopeLoaded=LoadingService.areScopesLoaded(scope),element.attr("ng-hide","scopeLoaded"),element.attr("bb-loading",null);var positionLoadingIcon=function(){var loading_icon=$bbug(".bb-loader").find("#loading_icon"),wait_graphic=$bbug(".bb-loader").find("#wait_graphic");if($bbug("[ng-app]").find("#bb").hasClass("modal-open"))return $timeout(function(){var center=$bbug("[ng-app]").find(".modal-dialog").height()||$bbug("[ng-app]").find(".modal-content").height()||$bbug("[ng-app]").find(".modal").height();return center=center/2-wait_graphic.height()/2,loading_icon.css("padding-top",center+"px")},50);var center=$(window).innerHeight()/2-wait_graphic.height()/2;return loading_icon.css("padding-top",center+"px")};positionLoadingIcon(),$bbug(window).on("resize",function(){return positionLoadingIcon()}),scope.$on("page:loaded",function(){return positionLoadingIcon()}),$compile(element)(scope)}}}),angular.module("BB.Directives").directive("bbMergeDuplicateQuestions",function(){return{restrict:"A",scope:!0,controller:function($scope,$rootScope){return $scope.questions={},$rootScope.$on("item_details:loaded",function(){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.bb.stacked_items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;if(item.item_details&&item.item_details.questions){item.item_details.hide_questions=!1;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(item.item_details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var question=_step2.value;if($scope.questions[question.id]){item.setCloneAnswers($scope.questions[question.id].item),item.item_details.hide_questions=!0;break}$scope.questions[question.id]={question:question,item:item}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $scope.has_questions=_.pluck($scope.questions,"question").length>0})}}}),angular.module("BB.Directives").directive("bbModal",function($window,$bbug,$timeout){return{restrict:"A",scope:!0,link:function(scope,elem,attrs){var deregisterWatcher=void 0;return $timeout(function(){return elem.parent().parent().parent().css("z-index",999999)},deregisterWatcher=scope.$watch(function(){var modal_padding=void 0,height=elem.height();if(modal_padding=$bbug(window).width()>=769?200:20,height>$bbug(window).height()){var new_height=$bbug(window).height()-modal_padding;return elem.css({height:new_height+"px","overflow-y":"scroll"}),deregisterWatcher()}}))}}}),angular.module("BB.Directives").directive("bbScrollTo",function($rootScope,AppConfig,BreadcrumbService,$bbug,$window,GeneralOptions,viewportSize,scrollIntercepter){return{transclude:!1,restrict:"A",link:function(scope,element,attrs){var scrollToCallback=void 0,evnts=attrs.bbScrollTo.split(","),always_scroll=null!=attrs.bbAlwaysScroll||!1,bb_transition_time=null!=attrs.bbTransitionTime?parseInt(attrs.bbTransitionTime,10):500;angular.isArray(evnts)?angular.forEach(evnts,function(evnt){return scope.$on(evnt,function(e){return scrollToCallback(evnt)})}):scope.$on(evnts,function(e){return scrollToCallback(evnts)});var isElementInView=function(el){return el.offset().top>$bbug("body").scrollTop()&&el.offset().top<$bbug("body").scrollTop()+$bbug(window).height()};return scrollToCallback=function(evnt){var scroll_to_element=void 0;scroll_to_element=$bbug("page:loaded"===evnt&&viewportSize.isXS()&&$bbug('[data-scroll-id="'+AppConfig.uid+'"]').length?'[data-scroll-id="'+AppConfig.uid+'"]':element);var current_step=BreadcrumbService.getCurrentStep();scroll_to_element&&("page:loaded"===evnt&&current_step>1||always_scroll||"widget:restart"===evnt||!isElementInView(scroll_to_element)&&0!==scroll_to_element.offset().top)&&scrollIntercepter.scrollToElement(scroll_to_element,bb_transition_time,evnt)}}}}),angular.module("BB.Directives").directive("bbSlotGrouper",function(){return{restrict:"A",scope:!0,link:function(scope,element,attrs){var slots=scope.$eval(attrs.slots);if(slots){scope.grouped_slots=[];var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(slots)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var slot=_step.value;slot.time>=scope.$eval(attrs.startTime)&&slot.time<scope.$eval(attrs.endTime)&&scope.grouped_slots.push(slot)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return scope.has_slots=scope.grouped_slots.length>0}}}}),function(){function bbTimeZoneDirective(){return{restrict:"A",controllerAs:"$tzCtrl",templateUrl:"_time_zone.html",controller:function(CompanyStoreService,bbTimeZone,bbi18nOptions){var company_time_zone=CompanyStoreService.time_zone;if(this.time_zone_name=moment().tz(bbTimeZone.getDisplay()).format("zz"),!bbi18nOptions.timeZone.useBrowser&&bbTimeZone.getDisplay()!==company_time_zone)return this.is_time_zone_diff=!0}}}angular.module("BB.Directives").directive("bbTimeZone",bbTimeZoneDirective)}(),angular.module("BB.Directives").directive("bbWaitFor",function($compile){return{transclude:!1,restrict:"A",priority:800,
link:function(scope,element,attrs){var name=attrs.bbWaitVar;name||(name="allDone"),scope[name]=!1;var prom=scope.$eval(attrs.bbWaitFor);prom?prom.then(function(){return scope[name]=!0}):scope[name]=!0}}}),angular.module("BB.Directives").directive("ngOptions",function($sniffer,$rootScope){return{restrict:"A",link:function(scope,el,attrs){var size=parseInt(attrs.size,10);if(!isNaN(size)&&size>1&&$sniffer.msie)return $rootScope.$on("loading:finished",function(){return el.focus(),$("body").focus()})}}}),angular.module("BB.Directives").directive("bbPaypal",function(PathSvc){return{restrict:"A",replace:!0,scope:{ppDetails:"=bbPaypal"},templateUrl:PathSvc.directivePartial("paypal_button"),link:function(scope,element,attrs){if(scope.inputs=[],scope.ppDetails){var keys=_.keys(scope.ppDetails);return _.each(keys,function(keyName){var obj={name:keyName,value:scope.ppDetails[keyName]};return scope.inputs.push(obj)})}}}}),angular.module("BB.Directives").directive("bbPaypalExpressButton",function($compile,$sce,$http,$templateCache,$q,$log,$window,UriTemplate){return{restrict:"EA",replace:!0,template:'<a ng-href="{{href}}" ng-click="showLoader()">Pay</a>',scope:{total:"=",bb:"=",decideNextPage:"=",paypalOptions:"=bbPaypalExpressButton",notLoaded:"="},link:function(scope,element,attributes){var total=scope.total,paypalOptions=scope.paypalOptions;return scope.href=new UriTemplate(total.$link("paypal_express").href).fillFromObject(paypalOptions),scope.showLoader=function(){if(scope.notLoaded)return scope.notLoaded(scope)}}}}),angular.module("BB.Directives").directive("popover",function(){var openElement=null,openScope=null;return $('div[ng-controller="BBCtrl"]').off(".bbtooltip").on("click.bbtooltip",function(e){return!$(e.target).closest("[popover]")[0]&&openElement&&openScope&&($(openElement).next(".popover").remove(),openScope.tt_isOpen=!1),!0}),{restrict:"EA",priority:-1e3,link:function(scope,element){return element.on("click.bbtooltip",function(e){return openElement===$(e.target).closest("[popover]")[0]?void e.preventDefault():(openElement&&openScope&&($(openElement).next(".popover").remove(),openScope.tt_isOpen=!1),openElement=element[0],openScope=scope)}),scope.$on("$destroy",function(){return $(element).off(".bbtooltip")})}}}),angular.module("BB.Directives").directive("pricepicker",function(){var controller=function($scope){return $scope.$watch("price",function(price){if(null!=price)return $scope.updateModel(price)})};return{require:"ngModel",link:function(scope,element,attrs,ngModel){return ngModel.$render=function(){if(ngModel.$viewValue)return scope.price=ngModel.$viewValue},scope.updateModel=function(value){return ngModel.$setViewValue(value)}},controller:controller,scope:{currency:"@"},template:'<span>{{0 | currency: currency | limitTo: 1}}</span>\n  <input type="number" ng-model="price" class="form-control" step="0.01">'}}),angular.module("BB.Directives").directive("scoped",function($document,$timeout){var _this=this;this.compat=function(){var DOMStyle=void 0,check=document.createElement("style");DOMStyle=void 0!==check.sheet?"sheet":void 0!==check.getSheet?"getSheet":"styleSheet";var scopeSupported=void 0!==check.scoped;document.body.appendChild(check);var testSheet=check[DOMStyle];testSheet.addRule?testSheet.addRule("c","blink"):testSheet.insertRule("c{}",0);var DOMRules=testSheet.rules?"rules":"cssRules",testStyle=testSheet[DOMRules][0];try{testStyle.selectorText="d"}catch(e){}var changeSelectorTextAllowed="d"===testStyle.selectorText.toLowerCase();return check.parentNode.removeChild(check),{scopeSupported:scopeSupported,rules:DOMRules,sheet:DOMStyle,changeSelectorTextAllowed:changeSelectorTextAllowed}}();var scopeIt=function(element){var styleNode=element[0],sheet=styleNode[_this.compat.sheet];if(sheet){for(var allRules=sheet[_this.compat.rules],par=styleNode.parentNode,glue="",index=allRules.length||0;par;)par.id&&(glue="#"+par.id+" "+glue),par=par.parentNode;return function(){for(var result=[];index--;){var item=void 0,rule=allRules[index];if(rule.selectorText&&!rule.selectorText.match(new RegExp(glue))){var selector=glue+" "+rule.selectorText.split(",").join(", "+glue);if(selector=selector.replace(/[\ ]+:root/gi,""),_this.compat.changeSelectorTextAllowed)item=rule.selectorText=selector;else if(!rule.type||1===rule.type){var styleRule=rule.style.cssText;styleRule&&(sheet.removeRule?sheet.removeRule(index):sheet.deleteRule(index),item=sheet.addRule?sheet.addRule(selector,styleRule):sheet.insertRule(selector+"{"+styleRule+"}",index))}}result.push(item)}return result}()}};return{restrict:"A",link:function(scope,element,attrs){if(scope.scopeSupported=this.compat.scopeSupported,!this.compat.scopeSupported)return $timeout(function(){return scopeIt(element)})},controller:function($scope,$element,$timeout){$scope.scopeSupported||(this.updateCss=function(){return $timeout(function(){return scopeIt($element)})})}}}),angular.module("BB.Directives").directive("script",function($compile,halClient){return{transclude:!1,restrict:"E",link:function(scope,element,attrs){if("text/hal-object"===attrs.type){var body=element[0].innerText,json=$bbug.parseJSON(body);return halClient.$parse(json)}}}}),angular.module("BB.i18n").directive("bbLanguagePicker",function(){return{controller:bbLanguagePickerController,controllerAs:"vm",restrict:"A",scope:!0,link:bbLanguagePickerLink,templateUrl:"i18n/language_picker.html"}}),function(){function TimeZoneSelectCtrl($rootScope,$scope,$localStorage,bbi18nOptions,bbTimeZone,bbTimeZoneOptions,bbTimeZoneUtils){"ngInject";var _this=this,companyTimeZone=void 0,displayTimeZone=void 0,browserTimeZone=void 0;this.timeZones=[],this.isAutomaticTimeZone=!1,this.selectedTimeZone=null,this.isLongList=!1,this.$onInit=function(){_this.timeZones=bbTimeZoneOptions.composeTimeZoneList(_this.format,bbTimeZone.getDisplay()),_this.isLongList=_this.timeZones.length>100,_this.setTimeZone=setTimeZone,_this.automaticTimeZoneToggle=automaticTimeZoneToggle,$rootScope.connection_started?$rootScope.connection_started.then(determineDefaults):determineDefaults()};var determineDefaults=function(){var localStorage=$localStorage.getObject("bbTimeZone"),getEqualTzInList=function(timeZone){return bbTimeZoneUtils.getEqualInList(timeZone,_this.timeZones)};companyTimeZone=getEqualTzInList(bbTimeZone.getCompany()),displayTimeZone=getEqualTzInList(bbTimeZone.getDisplay()),browserTimeZone=getEqualTzInList(moment.tz.guess()),_this.isAutomaticTimeZone=localStorage.useBrowserTimeZone||bbi18nOptions.timeZone.useBrowser&&!localStorage.displayTimeZone,_this.selectedTimeZone=_this.timeZones.find(function(tz){return tz.value===displayTimeZone})},automaticTimeZoneToggle=function(){displayTimeZone=_this.isAutomaticTimeZone?browserTimeZone:companyTimeZone,_this.timeZones=bbTimeZoneOptions.addMissingTimeZones(_this.timeZones,_this.format,displayTimeZone),setTimeZone(displayTimeZone,_this.isAutomaticTimeZone),$scope.$broadcast("UISelect:closeSelect"),bbTimeZone.setLocalStorage({useBrowserTimeZone:_this.isAutomaticTimeZone})},setTimeZone=function(timeZone){var isAutomaticTimeZone=arguments.length>1&&void 0!==arguments[1]&&arguments[1];displayTimeZone=timeZone,bbTimeZone.setDisplay(timeZone),_this.selectedTimeZone=_this.timeZones.find(function(tz){return tz.value===timeZone}),$rootScope.$broadcast("BBTimeZoneOptions:timeZoneChanged",timeZone),isAutomaticTimeZone||bbTimeZone.setLocalStorage({displayTimeZone:timeZone})},languageChangedHandler=function(){_this.timeZones=bbTimeZoneOptions.composeTimeZoneList(_this.format,displayTimeZone),_this.selectedTimeZone=_this.timeZones.find(function(tz){return tz.value===displayTimeZone})};$scope.$on("BBLanguagePicker:languageChanged",languageChangedHandler)}angular.module("BB.i18n").component("bbTimeZoneSelect",{templateUrl:"i18n/_bb_timezone_select.html",bindings:{hideToggle:"<",format:"<"},controller:TimeZoneSelectCtrl,controllerAs:"$bbTimeZoneSelectCtrl"})}(),function(){angular.module("BB.i18n").constant("bbCustomTimeZones",{GROUPED_TIME_ZONES:{"Africa/Cairo":"Cairo","Africa/Casablanca":"Monrovia","Africa/Harare":"Harare, Pretoria","Africa/Lagos":"West Central Africa","Africa/Nairobi":"Nairobi","America/Bogota":"Bogota, Lima, Quito","America/Buenos_Aires":"Buenos Aires, Georgetown","America/Caracas":"Caracas, La Paz","America/Chicago":"Central Time (US and Canada)","America/Chihuahua":"Chihuahua, Mazatlan","America/Denver":"Mountain Time (US and Canada)","America/El_Salvador":"Central America","America/Halifax":"Atlantic Time (Canada)","America/Indiana/Knox":"Indiana (East)","America/Los_Angeles":"Pacific Time (US and Canada); Tijuana","America/Mexico_City":"Guadalajara, Mexico City, Monterrey","America/New_York":"Eastern Time (US and Canada)","America/Phoenix":"Arizona","America/Santiago":"Santiago","America/Sao_Paulo":"Brasilia","America/Thule":"Greenland","Asia/Almaty":"Almaty, Novosibirsk","Asia/Baghdad":"Baghdad","Asia/Bangkok":"Bangkok, Hanoi, Jakarta","Asia/Colombo":"Sri Jayawardenepura","Asia/Dhaka":"Astana, Dhaka","Asia/Dubai":"Abu Dhabi, Muscat","Asia/Hong_Kong":"Beijing, Chongqing, Hong Kong SAR, Urumqi","Asia/Irkutsk":"Irkutsk, Ulaanbaatar","Asia/Jerusalem":"Jerusalem","Asia/Kabul":"Kabul","Asia/Karachi":"Islamabad, Karachi, Tashkent","Asia/Kathmandu":"Kathmandu","Asia/Kolkata":"Chennai, Kolkata, Mumbai, New Delhi","Asia/Krasnoyarsk":"Krasnoyarsk","Asia/Kuwait":"Kuwait, Riyadh","Asia/Magadan":"Magadan, Solomon Islands, New Caledonia","Asia/Rangoon":"Yangon Rangoon","Asia/Seoul":"Seoul","Asia/Singapore":"Kuala Lumpur, Singapore","Asia/Taipei":"Taipei","Asia/Tehran":"Tehran","Asia/Tokyo":"Osaka, Sapporo, Tokyo","Asia/Vladivostok":"Vladivostok","Asia/Yakutsk":"Yakutsk","Asia/Yekaterinburg":"Ekaterinburg","Asia/Yerevan":"Baku, Tbilisi, Yerevan","Atlantic/Azores":"Azores","Atlantic/Cape_Verde":"Cape Verde Islands","Australia/Adelaide":"Adelaide","Australia/Brisbane":"Brisbane","Australia/Canberra":"Canberra, Melbourne, Sydney","Australia/Darwin":"Darwin","Australia/Perth":"Perth","Australia/Tasmania":"Hobart","Canada/Newfoundland":"Newfoundland and Labrador","Canada/Saskatchewan":"Saskatchewan","Etc/GMT+12":"International Date Line West","Europe/Amsterdam":"Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna","Europe/Athens":"Athens, Minsk","Europe/Belgrade":"Belgrade, Bratislava, Budapest, Ljubljana, Prague","Europe/Bucharest":"Bucharest","Europe/Helsinki":"Helsinki, Kiev, Riga, Sofia, Tallinn, Vilnius","Europe/Istanbul":"Istanbul","Europe/London":"Edinburgh, Lisbon, London","Europe/Moscow":"Moscow, St. Petersburg, Volgograd","Europe/Paris":"Brussels, Copenhagen, Madrid, Paris","Europe/Sarajevo":"Sarajevo, Skopje, Warsaw, Zagreb","Pacific/Auckland":"Auckland, Wellington","Pacific/Fiji":"Fiji Islands, Kamchatka, Marshall Islands","Pacific/Guam":"Guam, Port Moresby","Pacific/Honolulu":"Hawaii","Pacific/Pago_Pago":"Midway Island, Samoa","Pacific/Tongatapu":"Nuku'alofa","US/Alaska":"Alaska"}})}(),angular.module("BB.i18n").provider("bbi18nOptions",function(bbOptionsProvider){"ngInject";var options={default_language:"en",use_browser_language:!0,available_languages:["en"],available_language_associations:{"en_*":"en","fr_*":"fr"},timeZone:{default:"Europe/London",useBrowser:!1,useCompany:!0,useCustomList:!0,replaceBrowser:{replace:"",replaceWith:""},filters:{limitTo:[],limitDaylightSaving:[],limitStandard:[],exclude:[]}}};this.setOption=function(option,value){options=bbOptionsProvider.setOption(options,option,value)},this.getOption=function(option){return options[option]},this.$get=function(){return options}}),angular.module("BB.i18n").service("bbLocale",function(bbi18nOptions,$log,$translate,$window){"ngInject";var _localeCompanyUsed=!1,determineLocale=function(){if("undefined"!==$translate.use()&&angular.isDefined($translate.use())&&isAvailable($translate.use()))setLocale($translate.use(),"$translate.use() locale");else{var browserLocale=$translate.negotiateLocale($translate.resolveClientLocale()),defaultLocale=bbi18nOptions.default_language,URIParamLocale=$window.getURIparam("locale");URIParamLocale&&isAvailable(URIParamLocale)?setLocale(URIParamLocale,"URIParam locale"):bbi18nOptions.use_browser_language&&isAvailable(browserLocale)?setLocale(browserLocale,"browser locale"):setLocale(defaultLocale,"default locale")}$translate.preferredLanguage(getLocale())},setLocale=function(locale,setWith){null==setWith&&(setWith=""),isAvailable(locale)&&(moment.locale(locale),$translate.use(locale),locale===moment.locale()&&locale===$translate.use()||console.error("moment locale not available, preferred locale = "+locale+", moment.locale() = ",moment.locale(),"$translate.use() = ",$translate.use()))},isAvailable=function(locale){return-1!==bbi18nOptions.available_languages.indexOf(locale)},getLocale=function(){return $translate.use()};return{determineLocale:determineLocale,getLocale:getLocale,setLocale:setLocale,setLocaleUsingCountryCode:function(countryCode){if(!_localeCompanyUsed&&(_localeCompanyUsed=!0,countryCode&&countryCode.match(/^(gb|au)$/))){setLocale("en-"+countryCode,"countryCode")}}}}),function(){function bbTimeZoneService($localStorage,$log,moment,bbi18nOptions,CompanyStoreService,bbCustomTimeZones,bbTimeZoneUtils){"ngInject";function convertToCompany(dateTime){return convertDateTime(dateTime,CompanyStoreService.time_zone)}function convertToDisplay(dateTime){return convertDateTime(dateTime,displayTimeZone)}function convertDateTime(dateTime,timeZone){return moment(dateTime).isValid()||$log.error("not valid dateTime",dateTime),moment.tz(dateTime,timeZone)}function getDisplay(){return displayTimeZone}function getDisplayUTCOffset(){return moment().tz(displayTimeZone).utcOffset()}function getCompany(){return CompanyStoreService.time_zone}function getCompanyUTCOffset(){return moment().tz(CompanyStoreService.time_zone).utcOffset()}function determine(){var _bbi18nOptions$timeZo=bbi18nOptions.timeZone,useBrowser=_bbi18nOptions$timeZo.useBrowser,useCustomList=_bbi18nOptions$timeZo.useCustomList,useCompany=_bbi18nOptions$timeZo.useCompany,localStorage=$localStorage.getObject("bbTimeZone");if(localStorage.displayTimeZone)return void setDisplay(localStorage.displayTimeZone);if(useBrowser||localStorage.useBrowserTimeZone){return void setDisplay(bbTimeZoneUtils.getKeyInCustomList(moment.tz.guess(),useCustomList))}if(useCompany&&CompanyStoreService.time_zone){setDisplay(bbTimeZoneUtils.getKeyInCustomList(CompanyStoreService.time_zone,useCustomList))}}function setDisplay(timeZone){moment.tz.setDefault(timeZone),displayTimeZone=timeZone}function setLocalStorage(localStorageObj){$localStorage.setObject("bbTimeZone",localStorageObj)}var displayTimeZone=bbTimeZoneUtils.getKeyInCustomList(bbi18nOptions.timeZone.default,bbi18nOptions.timeZone.useCustomList);return{getDisplay:getDisplay,getDisplayUTCOffset:getDisplayUTCOffset,getCompany:getCompany,getCompanyUTCOffset:getCompanyUTCOffset,convertToCompany:convertToCompany,convertToDisplay:convertToDisplay,determine:determine,setDisplay:setDisplay,setLocalStorage:setLocalStorage}}angular.module("BB.i18n").service("bbTimeZone",bbTimeZoneService)}(),function(){function timeZoneOptionsService(bbi18nOptions,bbTimeZoneUtils){"ngInject";function composeTimeZoneList(displayFormat,timeZone){var options=initOptions(void 0,displayFormat,timeZone);return compose(bbTimeZoneUtils.loadKeys,bbTimeZoneUtils.findFilterKeysInCustomList,bbTimeZoneUtils.filter,bbTimeZoneUtils.reject,bbTimeZoneUtils.filterDayLightOrStandard,bbTimeZoneUtils.ensureExists,bbTimeZoneUtils.mapModel,bbTimeZoneUtils.removeDuplicates,bbTimeZoneUtils.order)(options).timeZones}function addMissingTimeZones(timeZones,displayFormat,timeZone){var options=initOptions(timeZones,displayFormat,timeZone),composeTimeZones=compose(bbTimeZoneUtils.ensureExists,bbTimeZoneUtils.mapModel,bbTimeZoneUtils.removeDuplicates,bbTimeZoneUtils.order);return options.filters.limitTo.length?composeTimeZones(options).timeZones:timeZones}var compose=function(){for(var _len=arguments.length,funcs=Array(_len),_key=0;_key<_len;_key++)funcs[_key]=arguments[_key];return function(value){return funcs.reduce(function(v,fn){return fn(v)},value)}},initOptions=function(){var timeZones=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],displayFormat=arguments[1];return{timeZone:arguments[2],timeZones:timeZones,displayFormat:displayFormat,useCustomList:bbi18nOptions.timeZone.useCustomList,filters:bbi18nOptions.timeZone.filters,isDST:moment().isDST()}};return{composeTimeZoneList:composeTimeZoneList,addMissingTimeZones:addMissingTimeZones}}angular.module("BB.i18n").factory("bbTimeZoneOptions",timeZoneOptionsService)}();var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};!function(){function bbTimeZoneUtils($translate,$log,moment,orderByFilter,bbi18nOptions,bbCustomTimeZones){"ngInject";function loadKeys(options){return Object.assign({},options,{timeZones:options.useCustomList?Object.keys(bbCustomTimeZones.GROUPED_TIME_ZONES):loadMomentNames()})}function loadMomentNames(){var timeZones=moment.tz.names(),isUpperCase=function(timeZone){return timeZone.match(/[^\/]*$/)[0]===timeZone.match(/[^\/]*$/)[0].toUpperCase()};return _.chain(timeZones).reject(function(timeZone){return function(strings){return _.any(strings,function(string){return-1!==timeZone.indexOf(string)})}}(["GMT","Etc"])).reject(isUpperCase).value()}function findFilterKeysInCustomList(options){var getKey=function(timeZoneKey){return getKeyInCustomList(timeZoneKey,options.useCustomList)},mapFilters=function(listOfFilters,typeOfFilter,filters){return filters[typeOfFilter]=_.map(listOfFilters,getKey)};return Object.assign({},options,{filters:_.mapObject(options.filters,mapFilters)})}function filter(options){return Object.assign({},options,{timeZones:filterTimeZoneList(options.timeZones,options.filters.limitTo)})}function reject(options){return Object.assign({},options,{timeZones:filterTimeZoneList(options.timeZones,options.filters.exclude,!0)})}function filterDayLightOrStandard(options){var _options$filters=options.filters,limitDaylightSaving=_options$filters.limitDaylightSaving,limitStandard=_options$filters.limitStandard;return Object.assign({},options,{timeZones:filterTimeZoneList(options.timeZones,options.isDST?limitDaylightSaving:limitStandard)})}function filterTimeZoneList(timeZones,timeZonesToFilter){var exclude=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!angular.isArray(timeZonesToFilter))return $log.error("must be an Array:",timeZonesToFilter+":"+(void 0===timeZonesToFilter?"undefined":_typeof(timeZonesToFilter))),timeZones;if(!timeZonesToFilter.length)return timeZones;var contains=function(filters){return function(timeZone){return _.any(filters,function(filter){return-1!==timeZone.indexOf(filter)})}};return exclude?_.reject(timeZones,contains(timeZonesToFilter)):_.filter(timeZones,contains(timeZonesToFilter))}function ensureExists(options){return Object.assign({},options,{timeZones:addMissingTimeZone(options.timeZones,options.timeZone)})}function addMissingTimeZone(timeZones,timeZone){var mappedTimeZone=getEqualInList(timeZone,timeZones),allTimeZones=[].concat(_toConsumableArray(timeZones));return allTimeZones.find(function(tz){return(tz.value||tz)===mappedTimeZone})||allTimeZones.push(mappedTimeZone),allTimeZones}function mapModel(options){var mapTimeZone=function(timeZone,index){return timeZone.value?timeZone:mapTimeZoneItem(options,timeZone,index)};return Object.assign({},options,{timeZones:_.map(options.timeZones,mapTimeZone)})}function mapTimeZoneItem(options,timeZoneKey,index){var city=timeZoneKey.match(/[^\/]*$/)[0].replace(/-/g,"_"),momentTz=moment.tz(timeZoneKey);return{id:index,display:formatDisplayValue(options,city,momentTz),value:timeZoneKey,order:[parseInt(momentTz.format("Z")),momentTz.format("zz"),city]}}function formatDisplayValue(options,city,momentTz){var format=angular.copy(options.displayFormat),formatMap={"tz-code":$translate.instant("I18N.TIMEZONE_LOCATIONS.CODES."+momentTz.format("zz")),"offset-hours":momentTz.format("Z"),location:$translate.instant("I18N.TIMEZONE_LOCATIONS."+(options.useCustomList?"CUSTOM":"MOMENT")+"."+city.toUpperCase())};if(!format)return"(GMT"+formatMap["offset-hours"]+") "+formatMap.location;for(var formatKey in formatMap)format=format.replace(formatKey,formatMap[formatKey]);return format}function removeDuplicates(options){return Object.assign({},options,{timeZones:_.uniq(options.timeZones,function(timeZone){return timeZone.display})})}function order(options){return Object.assign({},options,{timeZones:orderByFilter(options.timeZones,["order[0]","order[1]","order[2]"],!1)})}function getKeyInCustomList(timeZone){var useCustomList=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],selectedTimeZone=void 0;if(!useCustomList)return timeZone;if(bbCustomTimeZones.GROUPED_TIME_ZONES[timeZone])return timeZone;var city=timeZone.match(/[^\/]*$/)[0].replace(/ /g,"_"),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Object.entries(bbCustomTimeZones.GROUPED_TIME_ZONES)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _step$value=_slicedToArray(_step.value,2),groupName=_step$value[0],groupCities=_step$value[1];if(groupName.match(/[^\/]*$/)[0]===city){selectedTimeZone=groupName;break}groupCities=groupCities.split(/\s*,\s*/).map(function(tz){return tz.replace(/ /g,"_")}).join(", ").split(/\s*,\s*/);if(-1!==groupCities.findIndex(function(groupCity){return groupCity===city})){selectedTimeZone=groupName;break}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return selectedTimeZone||timeZone}function getEqualInList(timeZone,timeZones){var selectedTimeZone=void 0,overwrite=bbi18nOptions.timeZone.replaceBrowser;if(overwrite.replace&&overwrite.replaceWith&&overwrite.replace===timeZone)return selectedTimeZone=overwrite.replaceWith;var formatTz=function(timeZone,format){return moment.tz(timeZone).format(format)},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=timeZones[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var tz=_step2.value;if(formatTz(tz.value||tz,"zz")===formatTz(timeZone,"zz")&&formatTz(tz.value||tz,"ZZ")===formatTz(timeZone,"ZZ")){selectedTimeZone=tz.value||tz;break}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return selectedTimeZone||timeZone}return{loadKeys:loadKeys,filter:filter,reject:reject,findFilterKeysInCustomList:findFilterKeysInCustomList,filterDayLightOrStandard:filterDayLightOrStandard,ensureExists:ensureExists,mapModel:mapModel,removeDuplicates:removeDuplicates,order:order,getKeyInCustomList:getKeyInCustomList,getEqualInList:getEqualInList}}angular.module("BB.i18n").factory("bbTimeZoneUtils",bbTimeZoneUtils)}(),angular.module("BB.i18n").provider("RuntimeTranslate",function($translateProvider){"ngInject";var translateProvider=$translateProvider;this.setProvider=function(provider){return translateProvider=provider},this.$get=function(){return translateProvider}}),angular.module("BB.i18n").config(function($translateProvider){"ngInject";var translations={I18N:{LANGUAGE_PICKER:{SELECT_LANG_PLACEHOLDER:"Select..."},TIMEZONE:{PREFERENCES:"Preferences",TIMEZONE_INFO:"All times are shown in {{time_zone_name}}.",SET_TIMEZONE_AUTOMATICALLY_LABEL:"Set timezone automatically",SET_TIMEZONE_AUTOMATICALLY_ON_LABEL:"On",SET_TIMEZONE_AUTOMATICALLY_OFF_LABEL:"Off",TIMEZONE_LABEL:"Timezone"},TIMEZONE_LOCATIONS:{CODES:{"+00":"+00","+01":"+01","+02":"+02","+03":"+03","+04":"+04","+05":"+05","+0530":"+0530","+06":"+06","+07":"+07","+08":"+08","+09":"+09","+10":"+10","+11":"+11","+12":"+12","+13":"+13","+14":"+14","-01":"-01","-02":"-02","-03":"-03","-04":"-04","-05":"-05","-06":"-06","-07":"-07","-08":"-08","-09":"-09","-10":"-10","-11":"-11","-12":"-12",ACDT:"ACDT",ACST:"ACST",ACT:"ACT",ACWST:"ACWST",ADT:"ADT",AEDT:"AEDT",AEST:"AEST",AFT:"AFT",AKDT:"AKDT",AKST:"AKST",AMST:"AMST",AMT:"AMT",ART:"ART",AST:"AST",AWST:"AWST",AZOST:"AZOST",AZOT:"AZOT",BDT:"BDT",BNT:"BNT",BOT:"BOT",BRST:"BRST",BRT:"BRT",BST:"BST",BTT:"BTT",CAT:"CAT",CCT:"CCT",CDT:"CDT",CEST:"CEST",CET:"CET",CHADT:"CHADT",CHAST:"CHAST",CHOST:"CHOST",CHOT:"CHOT",CHUT:"CHUT",CKT:"CKT",CLST:"CLST",COT:"COT",CST:"CST",CVT:"CVT",CXT:"CXT",ChST:"ChST",EASST:"EASST",EAT:"EAT",ECT:"ECT",EDT:"EDT",EEST:"EEST",EET:"EET",EGST:"EGST",EGT:"EGT",EST:"EST",FJST:"FJST",FJT:"FJT",FKST:"FKST",FNT:"FNT",GALT:"GALT",GAMT:"GAMT",GFT:"GFT",GILT:"GILT",GMT:"GMT",GST:"GST",GYT:"GYT",HDT:"HDT",HKT:"HKT",HOVST:"HOVST",HOVT:"HOVT",HST:"HST",ICT:"ICT",IDT:"IDT",IOT:"IOT",IRDT:"IRDT",IRST:"IRST",IST:"IST",JST:"JST",KOST:"KOST",KST:"KST",LHDT:"LHDT",LHST:"LHST",LINT:"LINT",MART:"MART",MDT:"MDT",MEST:"MEST",MET:"MET",MHT:"MHT",MIST:"MIST",MMT:"MMT",MSK:"MSK",MST:"MST",MUT:"MUT",MVT:"MVT",MYT:"MYT",NCT:"NCT",NDT:"NDT",NFT:"NFT",NPT:"NPT",NRT:"NRT",NST:"NST",NUT:"NUT",NZDT:"NZDT",NZST:"NZST",PDT:"PDT",PET:"PET",PGT:"PGT",PHOT:"PHOT",PHT:"PHT",PKT:"PKT",PMDT:"PMDT",PMST:"PMST",PONT:"PONT",PST:"PST",PWT:"PWT",PYST:"PYST",PYT:"PYT",RET:"RET",SAST:"SAST",SBT:"SBT",SCT:"SCT",SGT:"SGT",SRT:"SRT",SST:"SST",TAHT:"TAHT",TKT:"TKT",TLT:"TLT",TVT:"TVT",UCT:"UCT",ULAST:"ULAST",ULAT:"ULAT",UTC:"UTC",UYT:"UYT",VET:"VET",VUT:"VUT",WAKT:"WAKT",WAST:"WAST",WAT:"WAT",WEST:"WEST",WET:"WET",WFT:"WFT",WGST:"WGST",WGT:"WGT",WIB:"WIB",WIT:"WIT",WITA:"WITA",WSDT:"WSDT",WSST:"WSST",XJT:"XJT"},CUSTOM:{ADELAIDE:"Adelaide",ALASKA:"Alaska",ALMATY:"Almaty, Novosibirsk",AMSTERDAM:"Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna",ATHENS:"Athens, Minsk",AUCKLAND:"Auckland, Wellington",AZORES:"Azores",BAGHDAD:"Baghdad",BANGKOK:"Bangkok, Hanoi, Jakarta",BELGRADE:"Belgrade, Bratislava, Budapest, Ljubljana, Prague",BOGOTA:"Bogota, Lima, Quito",BRISBANE:"Brisbane",BUCHAREST:"Bucharest",BUENOS_AIRES:"Buenos Aires, Georgetown",CAIRO:"Cairo",CANBERRA:"Canberra, Melbourne, Sydney",CAPE_VERDE:"Cape Verde Islands",CARACAS:"Caracas, La Paz",CASABLANCA:"Casablanca, Monrovia",CHICAGO:"Central Time (US and Canada)",CHIHUAHUA:"Chihuahua, La Paz, Mazatlan",COLOMBO:"Sri Jayawardenepura",DARWIN:"Darwin",DENVER:"Mountain Time (US and Canada)",DHAKA:"Astana, Dhaka",DUBAI:"Abu Dhabi, Muscat",EL_SALVADOR:"Central America",FIJI:"Fiji Islands, Kamchatka, Marshall Islands","GMT+12":"International Date Line West",GUAM:"Guam, Port Moresby",HALIFAX:"Atlantic Time (Canada)",HARARE:"Harare, Pretoria",HELSINKI:"Helsinki, Kiev, Riga, Sofia, Tallinn, Vilnius",HONG_KONG:"Beijing, Chongqing, Hong Kong SAR, Urumqi",HONOLULU:"Hawaii",IRKUTSK:"Irkutsk, Ulaanbaatar",ISTANBUL:"Istanbul",JERUSALEM:"Jerusalem",KABUL:"Kabul",KARACHI:"Islamabad, Karachi, Tashkent",KATHMANDU:"Kathmandu",KNOX:"Indiana (East)",KOLKATA:"Chennai, Kolkata, Mumbai, New Delhi",KRASNOYARSK:"Krasnoyarsk",KUWAIT:"Kuwait, Riyadh",LAGOS:"West Central Africa",LONDON:"Dublin, Edinburgh, Lisbon, London",LOS_ANGELES:"Pacific Time (US and Canada), Tijuana",MAGADAN:"Magadan, Solomon Islands, New Caledonia",MEXICO_CITY:"Guadalajara, Mexico City, Monterrey",MOSCOW:"Moscow, St. Petersburg, Volgograd",NAIROBI:"Nairobi",NEWFOUNDLAND:"Newfoundland and Labrador",NEW_YORK:"Eastern Time (US and Canada)",PAGO_PAGO:"Midway Island, Samoa",PARIS:"Brussels, Copenhagen, Madrid, Paris",PERTH:"Perth",PHOENIX:"Arizona",RANGOON:"Yangon Rangoon",SANTIAGO:"Santiago",SAO_PAULO:"Brasilia",SARAJEVO:"Sarajevo, Skopje, Warsaw, Zagreb",SASKATCHEWAN:"Saskatchewan",SEOUL:"Seoul",SINGAPORE:"Kuala Lumpur, Singapore",TAIPEI:"Taipei",TASMANIA:"Hobart",TEHRAN:"Tehran",THULE:"Greenland",TOKYO:"Osaka, Sapporo, Tokyo",TONGATAPU:"Nuku'alofa",VLADIVOSTOK:"Vladivostok",YAKUTSK:"Yakutsk",YEKATERINBURG:"Ekaterinburg",YEREVAN:"Baku, Tbilisi, Yerevan"},MOMENT:{ABIDJAN:"Abidjan",ACCRA:"Accra",ACRE:"Acre",ADAK:"Adak",ADDIS_ABABA:"Addis Ababa",ADELAIDE:"Adelaide",ADEN:"Aden",ALASKA:"Alaska",ALEUTIAN:"Aleutian",ALGIERS:"Algiers",ALMATY:"Almaty",AMMAN:"Amman",AMSTERDAM:"Amsterdam",ANADYR:"Anadyr",ANCHORAGE:"Anchorage",ANDORRA:"Andorra",ANGUILLA:"Anguilla",ANTANANARIVO:"Antananarivo",ANTIGUA:"Antigua",APIA:"Apia",AQTAU:"Aqtau",AQTOBE:"Aqtobe",ARAGUAINA:"Araguaina",ARIZONA:"Arizona",ARUBA:"Aruba",ASHGABAT:"Ashgabat",ASHKHABAD:"Ashkhabad",ASMARA:"Asmara",ASMERA:"Asmera",ASTRAKHAN:"Astrakhan",ASUNCION:"Asuncion",ATHENS:"Athens",ATIKOKAN:"Atikokan",ATKA:"Atka",ATLANTIC:"Atlantic",ATYRAU:"Atyrau",AUCKLAND:"Auckland",AZORES:"Azores",BAGHDAD:"Baghdad",BAHIA:"Bahia",BAHIA_BANDERAS:"Bahia Banderas",BAHRAIN:"Bahrain",BAJANORTE:"BajaNorte",BAJASUR:"BajaSur",BAKU:"Baku",BAMAKO:"Bamako",BANGKOK:"Bangkok",BANGUI:"Bangui",BANJUL:"Banjul",BARBADOS:"Barbados",BARNAUL:"Barnaul",BEIRUT:"Beirut",BELEM:"Belem",BELFAST:"Belfast",BELGRADE:"Belgrade",BELIZE:"Belize",BERLIN:"Berlin",BERMUDA:"Bermuda",BEULAH:"Beulah",BISHKEK:"Bishkek",BISSAU:"Bissau",BLANC_SABLON:"Blanc-Sablon",BLANTYRE:"Blantyre",BOA_VISTA:"Boa Vista",BOGOTA:"Bogota",BOISE:"Boise",BOUGAINVILLE:"Bougainville",BRATISLAVA:"Bratislava",BRAZZAVILLE:"Brazzaville",BRISBANE:"Brisbane",BROKEN_HILL:"Broken Hill",BRUNEI:"Brunei",BRUSSELS:"Brussels",BUCHAREST:"Bucharest",BUDAPEST:"Budapest",BUENOS_AIRES:"Buenos Aires",BUJUMBURA:"Bujumbura",BUSINGEN:"Busingen",CAIRO:"Cairo",CALCUTTA:"Calcutta",CAMBRIDGE_BAY:"Cambridge Bay",CAMPO_GRANDE:"Campo Grande",CANARY:"Canary",CANBERRA:"Canberra",CANCUN:"Cancun",CAPE_VERDE:"Cape Verde",CARACAS:"Caracas",CASABLANCA:"Casablanca",CASEY:"Casey",CATAMARCA:"Catamarca",CAYENNE:"Cayenne",CAYMAN:"Cayman",CENTER:"Center",CENTRAL:"Central",CEUTA:"Ceuta",CHAGOS:"Chagos",CHATHAM:"Chatham",CHICAGO:"Chicago",CHIHUAHUA:"Chihuahua",CHISINAU:"Chisinau",CHITA:"Chita",CHOIBALSAN:"Choibalsan",CHONGQING:"Chongqing",CHRISTMAS:"Christmas",CHUNGKING:"Chungking",CHUUK:"Chuuk",COCOS:"Cocos",COLOMBO:"Colombo",COMODRIVADAVIA:"ComodRivadavia",COMORO:"Comoro",CONAKRY:"Conakry",CONTINENTAL:"Continental",COPENHAGEN:"Copenhagen",CORAL_HARBOUR:"Coral Harbour",CORDOBA:"Cordoba",COSTA_RICA:"Costa Rica",CRESTON:"Creston",CUBA:"Cuba",CUIABA:"Cuiaba",CURACAO:"Curacao",CURRIE:"Currie",DACCA:"Dacca",DAKAR:"Dakar",DAMASCUS:"Damascus",DANMARKSHAVN:"Danmarkshavn",DARWIN:"Darwin",DAR_ES_SALAAM:"Dar es Salaam",DAVIS:"Davis",DAWSON:"Dawson",DAWSON_CREEK:"Dawson Creek",DENORONHA:"DeNoronha",DENVER:"Denver",DETROIT:"Detroit",DHAKA:"Dhaka",DILI:"Dili",DJIBOUTI:"Djibouti",DOMINICA:"Dominica",DOUALA:"Douala",DUBAI:"Dubai",DUBLIN:"Dublin",DUMONTDURVILLE:"DumontDUrville",DUSHANBE:"Dushanbe",EAST:"East",EASTER:"Easter",EASTERISLAND:"EasterIsland",EASTERN:"Eastern",EAST_INDIANA:"East-Indiana",EAST_SASKATCHEWAN:"East-Saskatchewan",EDMONTON:"Edmonton",EFATE:"Efate",EGYPT:"Egypt",EIRE:"Eire",EIRUNEPE:"Eirunepe",EL_AAIUN:"El Aaiun",EL_SALVADOR:"El Salvador",ENDERBURY:"Enderbury",ENSENADA:"Ensenada",EUCLA:"Eucla",FAEROE:"Faeroe",FAKAOFO:"Fakaofo",FAMAGUSTA:"Famagusta",FAROE:"Faroe",FIJI:"Fiji",FORTALEZA:"Fortaleza",FORT_NELSON:"Fort Nelson",FORT_WAYNE:"Fort Wayne",FREETOWN:"Freetown",FUNAFUTI:"Funafuti",GABORONE:"Gaborone",GALAPAGOS:"Galapagos",GAMBIER:"Gambier",GAZA:"Gaza",GB_EIRE:"GB-Eire",GENERAL:"General",GIBRALTAR:"Gibraltar",GLACE_BAY:"Glace Bay",GODTHAB:"Godthab",
GOOSE_BAY:"Goose Bay",GRAND_TURK:"Grand Turk",GREENWICH:"Greenwich",GRENADA:"Grenada",GUADALCANAL:"Guadalcanal",GUADELOUPE:"Guadeloupe",GUAM:"Guam",GUATEMALA:"Guatemala",GUAYAQUIL:"Guayaquil",GUERNSEY:"Guernsey",GUYANA:"Guyana",HALIFAX:"Halifax",HARARE:"Harare",HARBIN:"Harbin",HAVANA:"Havana",HAWAII:"Hawaii",HEBRON:"Hebron",HELSINKI:"Helsinki",HERMOSILLO:"Hermosillo",HOBART:"Hobart",HONGKONG:"Hongkong",HONG_KONG:"Hong Kong",HONOLULU:"Honolulu",HOVD:"Hovd",HO_CHI_MINH:"Ho Chi Minh",ICELAND:"Iceland",INDIANAPOLIS:"Indianapolis",INDIANA_STARKE:"Indiana-Starke",INUVIK:"Inuvik",IQALUIT:"Iqaluit",IRAN:"Iran",IRKUTSK:"Irkutsk",ISLE_OF_MAN:"Isle of Man",ISRAEL:"Israel",ISTANBUL:"Istanbul",JAKARTA:"Jakarta",JAMAICA:"Jamaica",JAN_MAYEN:"Jan Mayen",JAPAN:"Japan",JAYAPURA:"Jayapura",JERSEY:"Jersey",JERUSALEM:"Jerusalem",JOHANNESBURG:"Johannesburg",JOHNSTON:"Johnston",JUBA:"Juba",JUJUY:"Jujuy",JUNEAU:"Juneau",KABUL:"Kabul",KALININGRAD:"Kaliningrad",KAMCHATKA:"Kamchatka",KAMPALA:"Kampala",KARACHI:"Karachi",KASHGAR:"Kashgar",KATHMANDU:"Kathmandu",KATMANDU:"Katmandu",KERGUELEN:"Kerguelen",KHANDYGA:"Khandyga",KHARTOUM:"Khartoum",KIEV:"Kiev",KIGALI:"Kigali",KINSHASA:"Kinshasa",KIRITIMATI:"Kiritimati",KIROV:"Kirov",KNOX:"Knox",KNOX_IN:"Knox IN",KOLKATA:"Kolkata",KOSRAE:"Kosrae",KRALENDIJK:"Kralendijk",KRASNOYARSK:"Krasnoyarsk",KUALA_LUMPUR:"Kuala Lumpur",KUCHING:"Kuching",KUWAIT:"Kuwait",KWAJALEIN:"Kwajalein",LAGOS:"Lagos",LA_PAZ:"La Paz",LA_RIOJA:"La Rioja",LIBREVILLE:"Libreville",LIBYA:"Libya",LIMA:"Lima",LINDEMAN:"Lindeman",LISBON:"Lisbon",LJUBLJANA:"Ljubljana",LOME:"Lome",LONDON:"London",LONGYEARBYEN:"Longyearbyen",LORD_HOWE:"Lord Howe",LOS_ANGELES:"Los Angeles",LOUISVILLE:"Louisville",LOWER_PRINCES:"Lower Princes",LUANDA:"Luanda",LUBUMBASHI:"Lubumbashi",LUSAKA:"Lusaka",LUXEMBOURG:"Luxembourg",MACAO:"Macao",MACAU:"Macau",MACEIO:"Maceio",MACQUARIE:"Macquarie",MADEIRA:"Madeira",MADRID:"Madrid",MAGADAN:"Magadan",MAHE:"Mahe",MAJURO:"Majuro",MAKASSAR:"Makassar",MALABO:"Malabo",MALDIVES:"Maldives",MALTA:"Malta",MANAGUA:"Managua",MANAUS:"Manaus",MANILA:"Manila",MAPUTO:"Maputo",MARENGO:"Marengo",MARIEHAMN:"Mariehamn",MARIGOT:"Marigot",MARQUESAS:"Marquesas",MARTINIQUE:"Martinique",MASERU:"Maseru",MATAMOROS:"Matamoros",MAURITIUS:"Mauritius",MAWSON:"Mawson",MAYOTTE:"Mayotte",MAZATLAN:"Mazatlan",MBABANE:"Mbabane",MCMURDO:"McMurdo",MELBOURNE:"Melbourne",MENDOZA:"Mendoza",MENOMINEE:"Menominee",MERIDA:"Merida",METLAKATLA:"Metlakatla",MEXICO_CITY:"Mexico City",MICHIGAN:"Michigan",MIDWAY:"Midway",MINSK:"Minsk",MIQUELON:"Miquelon",MOGADISHU:"Mogadishu",MONACO:"Monaco",MONCTON:"Moncton",MONROVIA:"Monrovia",MONTERREY:"Monterrey",MONTEVIDEO:"Montevideo",MONTICELLO:"Monticello",MONTREAL:"Montreal",MONTSERRAT:"Montserrat",MOSCOW:"Moscow",MOUNTAIN:"Mountain",MUSCAT:"Muscat",NAIROBI:"Nairobi",NASSAU:"Nassau",NAURU:"Nauru",NAVAJO:"Navajo",NDJAMENA:"Ndjamena",NEWFOUNDLAND:"Newfoundland",NEW_SALEM:"New Salem",NEW_YORK:"New York",NIAMEY:"Niamey",NICOSIA:"Nicosia",NIPIGON:"Nipigon",NIUE:"Niue",NOME:"Nome",NORFOLK:"Norfolk",NORONHA:"Noronha",NORTH:"North",NOUAKCHOTT:"Nouakchott",NOUMEA:"Noumea",NOVOKUZNETSK:"Novokuznetsk",NOVOSIBIRSK:"Novosibirsk",OJINAGA:"Ojinaga",OMSK:"Omsk",ORAL:"Oral",OSLO:"Oslo",OUAGADOUGOU:"Ouagadougou",PACIFIC:"Pacific",PACIFIC_NEW:"Pacific-New",PAGO_PAGO:"Pago Pago",PALAU:"Palau",PALMER:"Palmer",PANAMA:"Panama",PANGNIRTUNG:"Pangnirtung",PARAMARIBO:"Paramaribo",PARIS:"Paris",PERTH:"Perth",PETERSBURG:"Petersburg",PHNOM_PENH:"Phnom Penh",PHOENIX:"Phoenix",PITCAIRN:"Pitcairn",PODGORICA:"Podgorica",POHNPEI:"Pohnpei",POLAND:"Poland",PONAPE:"Ponape",PONTIANAK:"Pontianak",PORTO_ACRE:"Porto Acre",PORTO_NOVO:"Porto-Novo",PORTO_VELHO:"Porto Velho",PORTUGAL:"Portugal",PORT_AU_PRINCE:"Port-au-Prince",PORT_MORESBY:"Port Moresby",PORT_OF_SPAIN:"Port of Spain",PRAGUE:"Prague",PUERTO_RICO:"Puerto Rico",PUNTA_ARENAS:"Punta Arenas",PYONGYANG:"Pyongyang",QATAR:"Qatar",QUEENSLAND:"Queensland",QYZYLORDA:"Qyzylorda",RAINY_RIVER:"Rainy River",RANGOON:"Rangoon",RANKIN_INLET:"Rankin Inlet",RAROTONGA:"Rarotonga",RECIFE:"Recife",REGINA:"Regina",RESOLUTE:"Resolute",REUNION:"Reunion",REYKJAVIK:"Reykjavik",RIGA:"Riga",RIO_BRANCO:"Rio Branco",RIO_GALLEGOS:"Rio Gallegos",RIYADH:"Riyadh",ROME:"Rome",ROSARIO:"Rosario",ROTHERA:"Rothera",SAIGON:"Saigon",SAIPAN:"Saipan",SAKHALIN:"Sakhalin",SALTA:"Salta",SAMARA:"Samara",SAMARKAND:"Samarkand",SAMOA:"Samoa",SANTAREM:"Santarem",SANTA_ISABEL:"Santa Isabel",SANTIAGO:"Santiago",SANTO_DOMINGO:"Santo Domingo",SAN_JUAN:"San Juan",SAN_LUIS:"San Luis",SAN_MARINO:"San Marino",SAO_PAULO:"Sao Paulo",SAO_TOME:"Sao Tome",SARAJEVO:"Sarajevo",SARATOV:"Saratov",SASKATCHEWAN:"Saskatchewan",SCORESBYSUND:"Scoresbysund",SEOUL:"Seoul",SHANGHAI:"Shanghai",SHIPROCK:"Shiprock",SIMFEROPOL:"Simferopol",SINGAPORE:"Singapore",SITKA:"Sitka",SKOPJE:"Skopje",SOFIA:"Sofia",SOUTH:"South",SOUTH_GEORGIA:"South Georgia",SOUTH_POLE:"South Pole",SREDNEKOLYMSK:"Srednekolymsk",STANLEY:"Stanley",STOCKHOLM:"Stockholm",ST_BARTHELEMY:"St Barthelemy",ST_HELENA:"St Helena",ST_JOHNS:"St Johns",ST_KITTS:"St Kitts",ST_LUCIA:"St Lucia",ST_THOMAS:"St Thomas",ST_VINCENT:"St Vincent",SWIFT_CURRENT:"Swift Current",SYDNEY:"Sydney",SYOWA:"Syowa",TAHITI:"Tahiti",TAIPEI:"Taipei",TALLINN:"Tallinn",TARAWA:"Tarawa",TASHKENT:"Tashkent",TASMANIA:"Tasmania",TBILISI:"Tbilisi",TEGUCIGALPA:"Tegucigalpa",TEHRAN:"Tehran",TELL_CITY:"Tell City",TEL_AVIV:"Tel Aviv",THIMBU:"Thimbu",THIMPHU:"Thimphu",THULE:"Thule",THUNDER_BAY:"Thunder Bay",TIJUANA:"Tijuana",TIMBUKTU:"Timbuktu",TIRANE:"Tirane",TIRASPOL:"Tiraspol",TOKYO:"Tokyo",TOMSK:"Tomsk",TONGATAPU:"Tongatapu",TORONTO:"Toronto",TORTOLA:"Tortola",TRIPOLI:"Tripoli",TROLL:"Troll",TRUK:"Truk",TUCUMAN:"Tucuman",TUNIS:"Tunis",TURKEY:"Turkey",UJUNG_PANDANG:"Ujung Pandang",ULAANBAATAR:"Ulaanbaatar",ULAN_BATOR:"Ulan Bator",ULYANOVSK:"Ulyanovsk",UNIVERSAL:"Universal",URUMQI:"Urumqi",USHUAIA:"Ushuaia",UST_NERA:"Ust-Nera",UZHGOROD:"Uzhgorod",VADUZ:"Vaduz",VANCOUVER:"Vancouver",VATICAN:"Vatican",VEVAY:"Vevay",VICTORIA:"Victoria",VIENNA:"Vienna",VIENTIANE:"Vientiane",VILNIUS:"Vilnius",VINCENNES:"Vincennes",VIRGIN:"Virgin",VLADIVOSTOK:"Vladivostok",VOLGOGRAD:"Volgograd",VOSTOK:"Vostok",WAKE:"Wake",WALLIS:"Wallis",WARSAW:"Warsaw",WEST:"West",WHITEHORSE:"Whitehorse",WINAMAC:"Winamac",WINDHOEK:"Windhoek",WINNIPEG:"Winnipeg",YAKUTAT:"Yakutat",YAKUTSK:"Yakutsk",YANCOWINNA:"Yancowinna",YANGON:"Yangon",YAP:"Yap",YEKATERINBURG:"Yekaterinburg",YELLOWKNIFE:"Yellowknife",YEREVAN:"Yerevan",YUKON:"Yukon",ZAGREB:"Zagreb",ZAPOROZHYE:"Zaporozhye",ZULU:"Zulu",ZURICH:"Zurich"}}}};$translateProvider.translations("en",translations)}),angular.module("BB.Directives").directive("bbPurchase",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Purchase",link:function(scope,element,attrs){scope.init(scope.$eval(attrs.bbPurchase))}}}),angular.module("BB.Controllers").controller("Purchase",function($scope,$rootScope,PurchaseService,$uibModal,$location,$timeout,BBModel,$q,QueryStringService,SSOService,AlertService,LoginService,$window,$sessionStorage,LoadingService,$translate,ReasonService,$document,bbAnalyticsPiwik){function setPiwik(category,title){bbAnalyticsPiwik.push(["trackEvent",[category],title])}var setCancelReasonsToBB=void 0;$scope.is_waitlist=!1,$scope.make_payment=!1;var loader=LoadingService.$loader($scope),setPurchaseCompany=function(company){if($scope.bb.company_id=company.id,$scope.bb.company=new BBModel.Company(company),$scope.company=$scope.bb.company,$scope.bb.item_defaults.company=$scope.bb.company,company.settings&&(company.settings.merge_resources&&($scope.bb.item_defaults.merge_resources=!0),company.settings.merge_people))return $scope.bb.item_defaults.merge_people=!0},failMsg=function(){return $scope.fail_msg?AlertService.danger({msg:$scope.fail_msg}):AlertService.add("danger",{msg:$translate.instant("CORE.ALERTS.GENERIC")})};$scope.init=function(options){return options||(options={}),loader.notLoaded(),options.move_route&&($scope.move_route=options.move_route),options.move_all&&($scope.move_all=options.move_all),options.fail_msg&&($scope.fail_msg=options.fail_msg),$scope.bb.total?$scope.load($scope.bb.total.long_id):$scope.bb.purchase?($scope.purchase=$scope.bb.purchase,$scope.bookings=$scope.bb.purchase.bookings,$scope.purchase.confirm_messages&&($scope.messages=$scope.purchase.confirm_messages),$scope.cancel_reasons||($scope.cancel_reasons=$scope.bb.cancel_reasons),$scope.move_reasons||($scope.move_reasons=$scope.bb.move_reasons),loader.setLoaded()):options.member_sso?SSOService.memberLogin(options).then(function(login){return $scope.load()},function(err){return loader.setLoaded(),failMsg()}):$scope.load()};var getPurchase=function(params){var deferred=$q.defer();return PurchaseService.query(params).then(function(purchase){return deferred.resolve(purchase),purchase.$get("company").then(function(company){return setPurchaseCompany(company)}),$scope.purchase=purchase,$scope.bb.purchase=purchase,$scope.price=!(0===$scope.purchase.price)},function(err){return loader.setLoaded(),err&&401===err.status?LoginService.isLoggedIn()?failMsg():loginRequired():failMsg()}),deferred.promise},getBookings=function(purchase){return $scope.purchase.$getBookings().then(function(bookings){return $scope.bookings=bookings,bookings[0]&&bookings[0].$getCompany().then(function(company){return $scope.purchase.bookings[0].company=company,company.$has("reasons")&&getReasons(company).then(function(reasons){return setCancelReasons(),setMoveReasons(),setMoveReasonsToBB(),setCancelReasonsToBB()}),company.$getAddress().then(function(address){return $scope.purchase.bookings[0].company.address=address})}),loader.setLoaded(),checkIfMoveBooking(bookings),checkIfWaitlistBookings(bookings),Array.from($scope.bookings).map(function(booking){return booking.$getAnswers().then(function(answers){return booking.answers=answers})})},function(err){return loader.setLoaded(),failMsg()}),purchase.$has("client")&&purchase.$get("client").then(function(client){return $scope.setClient(new BBModel.Client(client))}),$scope.purchase.getConfirmMessages().then(function(messages){return $scope.purchase.confirm_messages=messages,$scope.messages=messages})};$scope.load=function(id){return loader.notLoaded(),id||(id=getPurchaseID()),!$scope.loaded&&id?$rootScope.widget_started.then(function(){return $scope.waiting_for_conn_started.then(function(){var company_id=getCompanyID();if(company_id){var options={root:$scope.bb.api_url};BBModel.Company.$query(company_id,options).then(function(company){return setPurchaseCompany(company)})}var params={purchase_id:id,url_root:$scope.bb.api_url},auth_token=$sessionStorage.getItem("auth_token");return auth_token&&(params.auth_token=auth_token),getPurchase(params).then(function(purchase){return getBookings(purchase)})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):loader.setLoaded(),$scope.loaded=!0};var checkIfMoveBooking=function(bookings){var id=void 0,matches=/^.*(?:\?|&)move_booking=(.*?)(?:&|$)/.exec($location.absUrl());if(matches&&(id=parseInt(matches[1])),id){var move_booking=Array.from(bookings).filter(function(b){return b.id===id}).map(function(b){return b});if(move_booking.length>0&&$scope.isMovable(bookings[0]))return $scope.move(move_booking[0])}},checkIfWaitlistBookings=function(bookings){return $scope.waitlist_bookings=Array.from(bookings).filter(function(booking){return booking.on_waitlist&&1===booking.settings.sent_waitlist}).map(function(booking){return booking})},loginRequired=function(){if(!$scope.bb.login_required)return window.location=window.location.href+"&login=true"},getCompanyID=function(){var company_id=void 0,matches=/^.*(?:\?|&)company_id=(.*?)(?:&|$)/.exec($location.absUrl());return matches&&(company_id=matches[1]),company_id},getPurchaseID=function(){var id=void 0,matches=/^.*(?:\?|&)id=(.*?)(?:&|$)/.exec($location.absUrl());return matches||(matches=/^.*print_purchase\/(.*?)(?:\?|$)/.exec($location.absUrl())),matches||(matches=/^.*print_purchase_jl\/(.*?)(?:\?|$)/.exec($location.absUrl())),matches?id=matches[1]:QueryStringService("ref")&&(id=QueryStringService("ref")),QueryStringService("booking_id")&&(id=QueryStringService("booking_id")),id};$scope.move=function(booking,route,options){return bbAnalyticsPiwik.isEnabled()&&setPiwik("View Booking","Move Booking"),null==options&&(options={}),route||(route=$scope.move_route),$scope.move_all?$scope.moveAll(route,options):(loader.notLoaded(),$scope.initWidget({company_id:booking.company_id,no_route:!0}),$timeout(function(){return $rootScope.connection_started.then(function(){var proms=[];$scope.bb.moving_booking=booking,$scope.quickEmptybasket();var new_item=new BBModel.BasketItem(booking,$scope.bb);return new_item.setSrcBooking(booking,$scope.bb),new_item.ready=!1,Array.prototype.push.apply(proms,new_item.promises),$scope.bb.basket.addItem(new_item),$scope.setBasketItem(new_item),$q.all(proms).then(function(){return loader.setLoaded(),$rootScope.$broadcast("booking:move"),$scope.decideNextPage(route)},function(err){return loader.setLoaded(),failMsg()})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})}))},$scope.moveAll=function(route,options){return null==options&&(options={}),route||(route=$scope.move_route),loader.notLoaded(),$scope.initWidget({company_id:$scope.bookings[0].company_id,no_route:!0}),$timeout(function(){return $rootScope.connection_started.then(function(){var proms=[];1===$scope.bookings.length?$scope.bb.moving_booking=$scope.bookings[0]:$scope.bb.moving_booking=$scope.purchase,_.every(_.map($scope.bookings,function(b){return b.event_id}),function(event_id){return event_id===$scope.bookings[0].event_id})&&($scope.bb.moving_purchase=$scope.purchase),$scope.quickEmptybasket();var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.bookings)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var booking=_step.value,new_item=new BBModel.BasketItem(booking,$scope.bb);new_item.setSrcBooking(booking),new_item.ready=!1,new_item.move_done=!1,Array.prototype.push.apply(proms,new_item.promises),$scope.bb.basket.addItem(new_item)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $scope.bb.sortStackedItems(),$scope.setBasketItem($scope.bb.basket.items[0]),$q.all(proms).then(function(){return loader.setLoaded(),$scope.decideNextPage(route)},function(err){return loader.setLoaded(),failMsg()})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})})},$scope.bookWaitlistItem=function(booking){loader.notLoaded();var params={purchase:$scope.purchase,booking:booking};return PurchaseService.bookWaitlistItem(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.bb.purchase=purchase,$scope.purchase.$getBookings().then(function(bookings){return $scope.bookings=bookings,$scope.waitlist_bookings=function(){var result=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.bookings)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)booking=_step2.value,booking.on_waitlist&&1===booking.settings.sent_waitlist&&result.push(booking)}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result}(),$scope.purchase.$has("new_payment")&&$scope.purchase.due_now>0&&($scope.make_payment=!0),loader.setLoaded()},function(err){return loader.setLoaded(),failMsg()})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.delete=function(_booking){return bbAnalyticsPiwik.isEnabled()&&setPiwik("View Booking","Cancel Booking"),$uibModal.open({templateUrl:$scope.getPartial("_cancel_modal"),controller:ModalDelete,resolve:{booking:function(){return _booking},cancel_reasons:function(){return $scope.cancel_reasons}}}).result.then(function(booking){var cancel_reason=null;booking.cancel_reason&&(cancel_reason=booking.cancel_reason);var data={cancel_reason:cancel_reason};return booking.$del("self",{},data).then(function(service){return $scope.bookings=_.without($scope.bookings,booking),$rootScope.$broadcast("booking:cancelled")})})},$scope.deleteAll=function(){return $uibModal.open({templateUrl:$scope.getPartial("_cancel_modal"),controller:ModalDeleteAll,resolve:{purchase:function(){return $scope.purchase}}}).result.then(function(purchase){return PurchaseService.deleteAll(purchase).then(function(purchase){return $scope.purchase=purchase,$scope.bookings=[],$rootScope.$broadcast("booking:cancelled")})})},$scope.isMovable=function(booking){return booking.min_cancellation_time?moment().isBefore(booking.min_cancellation_time):booking.datetime.isAfter(moment())},$scope.createBasketItem=function(booking){var item=new BBModel.BasketItem(booking,$scope.bb);return item.setSrcBooking(booking),item},$scope.checkAnswer=function(answer){return"boolean"==typeof answer.value||"string"==typeof answer.value||"number"==typeof answer.value},$scope.changeAttendees=function(route){return $scope.moveAll(route)};var getReasons=function(company){return ReasonService.query(company).then(function(reasons){return $scope.company_reasons=reasons,$scope.company_reasons},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong retrieving reasons")})},setCancelReasons=function(){return $scope.cancel_reasons=_.filter($scope.company_reasons,function(r){return 3===r.reason_type}),$scope.cancel_reasons},setMoveReasons=function(){return $scope.move_reasons=_.filter($scope.company_reasons,function(r){return 5===r.reason_type}),$scope.move_reasons},setMoveReasonsToBB=function(){if($scope.move_reasons)return $scope.bb.move_reasons=$scope.move_reasons};return setCancelReasonsToBB=function(){if($scope.cancel_reasons)return $scope.bb.cancel_reasons=$scope.cancel_reasons}});var ModalDelete=function($scope,$rootScope,$uibModalInstance,booking,AlertService,cancel_reasons){return $scope.booking=booking,$scope.cancel_reasons=cancel_reasons,$scope.confirmDelete=function(){return AlertService.clear(),$uibModalInstance.close(booking)},$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}},ModalDeleteAll=function($scope,$rootScope,$uibModalInstance,purchase){return $scope.purchase=purchase,$scope.confirmDelete=function(){return $uibModalInstance.close(purchase)},$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}};angular.module("BB.Models").factory("Purchase.BookingModel",function($q,$window,BBModel,BaseModel,$bbug){return function(_BaseModel){function Purchase_Booking(data){_classCallCheck(this,Purchase_Booking);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.ready=!1,_this.datetime=moment.parseZone(_this.datetime),_this.time_zone&&_this.datetime.tz(_this.time_zone),_this.original_datetime=moment(_this.datetime),_this.end_datetime=moment.parseZone(_this.end_datetime),_this.time_zone&&_this.end_datetime.tz(_this.time_zone),_this.min_cancellation_time=moment(_this.min_cancellation_time),_this.min_cancellation_hours=_this.datetime.diff(_this.min_cancellation_time,"hours"),_this}return _inherits(Purchase_Booking,_BaseModel),Purchase_Booking.prototype.getGroup=function(){var _this2=this;return this.group?this.group:this._data.$has("event_groups")?this._data.$get("event_groups").then(function(group){return _this2.group=group,_this2.group}):void 0},Purchase_Booking.prototype.getColour=function(){return this.getGroup()?this.getGroup().colour:"#FFFFFF"},Purchase_Booking.prototype.getCompany=function(){var _this3=this;return this.company?this.company:this.$has("company")?this._data.$get("company").then(function(company){return _this3.company=new BBModel.Company(company),_this3.company}):void 0},Purchase_Booking.prototype.$getAnswers=function(){var _this4=this,defer=$q.defer();return null!=this.answers?defer.resolve(this.answers):(this.answers=[],this._data.$has("answers")?this._data.$get("answers").then(function(answers){return _this4.answers=Array.from(answers).map(function(a){return new BBModel.Answer(a)}),defer.resolve(_this4.answers)}):defer.resolve([])),defer.promise},Purchase_Booking.prototype.$getSurveyAnswers=function(){var _this5=this,defer=$q.defer();return this.survey_answers&&defer.resolve(this.survey_answers),this._data.$has("survey_answers")?this._data.$get("survey_answers").then(function(survey_answers){return _this5.survey_answers=Array.from(survey_answers).map(function(a){return new BBModel.Answer(a)}),defer.resolve(_this5.survey_answers)}):defer.resolve([]),defer.promise},Purchase_Booking.prototype.answer=function(q){if(null!=this.answers){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(this.answers)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var a=_step.value;if(a.name&&a.name===q)return a.answer;if(a.question_text&&a.question_text===q)return a.value}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}else this.$getAnswers();return null},Purchase_Booking.prototype.getPostData=function(){var data={};data.attended=this.attended,data.client_id=this.client_id,data.company_id=this.company_id,data.time=60*this.datetime.hour()+this.datetime.minute(),data.date=this.datetime.toISODate(),data.deleted=this.deleted,data.describe=this.describe,data.duration=this.duration,data.end_datetime=this.end_datetime,this.time&&this.time.event_id&&!this.isEvent()?data.event_id=this.time.event_id:this.event?data.event_id=this.event.id:data.event_id=this.slot_id,data.full_describe=this.full_describe,data.id=this.id,data.min_cancellation_time=this.min_cancellation_time,data.on_waitlist=this.on_waitlist,data.paid=this.paid,data.person_name=this.person_name,data.price=this.price,data.purchase_id=this.purchase_id,data.purchase_ref=this.purchase_ref,data.quantity=this.quantity,data.self=this.self,this.move_item_id&&(data.move_item_id=this.move_item_id),this.srcBooking&&(data.move_item_id=this.srcBooking.id),this.person&&(data.person_id=this.person.id),this.service&&(data.service_id=this.service.id),this.resource&&(data.resource_id=this.resource.id),this.item_details&&(data.questions=this.item_details.getPostData()),this.move_reason&&(data.move_reason=this.move_reason),data.service_name=this.service_name,data.settings=this.settings,this.status&&(data.status=this.status),null!=this.email&&(data.email=this.email),null!=this.email_admin&&(data.email_admin=this.email_admin),this.first_name&&(data.first_name=this.first_name),this.last_name&&(data.last_name=this.last_name);var formatted_survey_answers=[];if(this.survey_questions){data.survey_questions=this.survey_questions;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(this.survey_questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var q=_step2.value;formatted_survey_answers.push({value:q.answer,outcome:q.outcome,detail_type_id:q.id,price:q.price})}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}data.survey_answers=formatted_survey_answers}return data},Purchase_Booking.prototype.checkReady=function(){if(this.datetime&&this.id&&this.purchase_ref)return this.ready=!0},Purchase_Booking.prototype.printed_price=function(){return parseFloat(this.price)%1==0?"£"+parseInt(this.price):$window.sprintf("£%.2f",parseFloat(this.price))},Purchase_Booking.prototype.getDateString=function(){return this.datetime.toISODate()},Purchase_Booking.prototype.getTimeInMins=function(){return 60*this.datetime.hour()+this.datetime.minute()},Purchase_Booking.prototype.getAttachments=function(){var _this6=this;return this.attachments?this.attachments:this.$has("attachments")?this._data.$get("attachments").then(function(atts){return _this6.attachments=atts.attachments,_this6.attachments}):void 0},Purchase_Booking.prototype.canCancel=function(){return moment(this.min_cancellation_time).isAfter(moment())},Purchase_Booking.prototype.canMove=function(){return this.canCancel()},Purchase_Booking.prototype.getAttendeeName=function(){return this.first_name+" "+this.last_name},Purchase_Booking.prototype.isEvent=function(){return null!=this.event_chain},Purchase_Booking.$addSurveyAnswersToBooking=function(booking){return PurchaseBookingService.addSurveyAnswersToBooking(booking)},Purchase_Booking}(BaseModel)}),angular.module("BB.Models").factory("Purchase.CourseBookingModel",function($q,BBModel,BaseModel){return function(_BaseModel){function Purchase_Course_Booking(data){return _classCallCheck(this,Purchase_Course_Booking),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(Purchase_Course_Booking,_BaseModel),Purchase_Course_Booking.prototype.getBookings=function(){var _this2=this,defer=$q.defer();return this.bookings&&defer.resolve(this.bookings),this._data.$has("bookings")?this._data.$get("bookings").then(function(bookings){return _this2.bookings=function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var b=_step.value;result.push(new BBModel.Purchase.Booking(b))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}(),_this2.bookings.sort(function(a,b){return a.datetime.unix()-b.datetime.unix()}),defer.resolve(_this2.bookings)}):(this.bookings=[],defer.resolve(this.bookings)),defer.promise},Purchase_Course_Booking}(BaseModel)}),angular.module("BB.Models").factory("Purchase.TotalModel",function($q,$window,BBModel,BaseModel,$sce){return function(_BaseModel){function Purchase_Total(data){_classCallCheck(this,Purchase_Total);var _this=_possibleConstructorReturn(this,_BaseModel.call(this,data));return _this.getItems().then(function(items){return _this.items=items}),_this.getClient().then(function(client){return _this.client=client}),_this.getMember().then(function(member){return _this.member=member}),_this}return _inherits(Purchase_Total,_BaseModel),Purchase_Total.prototype.id=function(){return this.get("id")},Purchase_Total.prototype.icalLink=function(){return this._data.$href("ical")},Purchase_Total.prototype.webcalLink=function(){return this._data.$href("ical")},Purchase_Total.prototype.gcalLink=function(){return this._data.$href("gcal")},Purchase_Total.prototype.getItems=function(){var defer=$q.defer();return this.items&&defer.resolve(this.items),$q.all([this.$getBookings(),this.$getCourseBookings(),this.getPackages(),this.getProducts(),this.getDeals()]).then(function(result){var items=_.flatten(result);return defer.resolve(items)}),defer.promise},Purchase_Total.prototype.$getBookings=function(){var _this2=this,defer=$q.defer();return this.bookings&&defer.resolve(this.bookings),this._data.$has("bookings")?this._data.$get("bookings").then(function(bookings){return _this2.bookings=function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var b=_step.value;result.push(new BBModel.Purchase.Booking(b))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}(),_this2.bookings.sort(function(a,b){return a.datetime.unix()-b.datetime.unix()}),defer.resolve(_this2.bookings)}):defer.resolve([]),defer.promise},Purchase_Total.prototype.$getCourseBookings=function(){var _this3=this,defer=$q.defer();return this.course_bookings&&defer.resolve(this.course_bookings),this._data.$has("course_bookings")?this._data.$get("course_bookings").then(function(bookings){return _this3.course_bookings=function(){var result=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var b=_step2.value;result.push(new BBModel.Purchase.CourseBooking(b))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result}(),$q.all(_.map(_this3.course_bookings,function(b){return b.getBookings()})).then(function(){return defer.resolve(_this3.course_bookings)})}):defer.resolve([]),defer.promise},Purchase_Total.prototype.getPackages=function(){var _this4=this,defer=$q.defer();return this.packages&&defer.resolve(this.packages),this._data.$has("packages")?this._data.$get("packages").then(function(packages){return _this4.packages=packages,defer.resolve(_this4.packages)}):defer.resolve([]),defer.promise},Purchase_Total.prototype.getProducts=function(){var _this5=this,defer=$q.defer();return this.products&&defer.resolve(this.products),this._data.$has("products")?this._data.$get("products").then(function(products){return _this5.products=products,defer.resolve(_this5.products)}):defer.resolve([]),defer.promise},Purchase_Total.prototype.getDeals=function(){var _this6=this,defer=$q.defer();return this.deals&&defer.resolve(this.deals),this._data.$has("deals")?this._data.$get("deals").then(function(deals){return _this6.deals=deals,defer.resolve(_this6.deals)}):defer.resolve([]),defer.promise},Purchase_Total.prototype.getMessages=function(booking_texts,msg_type){var defer=$q.defer();return booking_texts=Array.from(booking_texts).filter(function(bt){return bt.message_type===msg_type}).map(function(bt){return bt}),0===booking_texts.length?defer.resolve([]):this.getItems().then(function(items){var msgs=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(booking_texts)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var booking_text=_step3.value,_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)for(var item=_step4.value,_arr=["company","person","resource","service"],_i=0;_i<_arr.length;_i++){var type=_arr[_i];item.$has(type)&&item.$href(type)===booking_text.$href("item")&&-1===msgs.indexOf(booking_text.message)&&msgs.push(booking_text.message)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return defer.resolve(msgs)}),defer.promise},Purchase_Total.prototype.getClient=function(){var _this7=this,defer=$q.defer()
;return this._data.$has("client")?this._data.$get("client").then(function(client){return _this7.client=new BBModel.Client(client),defer.resolve(_this7.client)}):defer.reject("No client"),defer.promise},Purchase_Total.prototype.getMember=function(){var _this8=this,defer=$q.defer();return this._data.$has("member")?this._data.$get("member").then(function(member){return _this8.member=new BBModel.Client(member),defer.resolve(_this8.member)}):defer.reject("No member"),defer.promise},Purchase_Total.prototype.getConfirmMessages=function(){var _this9=this,defer=$q.defer();return this._data.$has("confirm_messages")?this._data.$get("confirm_messages").then(function(msgs){return _this9.getMessages(msgs,"Confirm").then(function(filtered_msgs){return defer.resolve(filtered_msgs)})}):defer.reject("no messages"),defer.promise},Purchase_Total.prototype.printed_total_price=function(){return parseFloat(this.total_price)%1==0?"£"+parseInt(this.total_price):$window.sprintf("£%.2f",parseFloat(this.total_price))},Purchase_Total.prototype.newPaymentUrl=function(){if(this._data.$has("new_payment"))return $sce.trustAsResourceUrl(this._data.$href("new_payment"))},Purchase_Total.prototype.totalDuration=function(){var duration=0,_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var item=_step5.value;item.duration&&(duration+=item.duration)}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return duration},Purchase_Total.prototype.containsWaitlistItems=function(){var waitlist=[],_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(this.items)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var item=_step6.value;!0===item.on_waitlist&&waitlist.push(item)}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}return waitlist.length>0},Purchase_Total}(BaseModel)}),angular.module("BB.Services").factory("PurchaseBookingService",function($q,halClient,BBModel){return{update:function(booking){var deferred=$q.defer(),data=booking.getPostData();return booking.srcBooking.$put("self",{},data).then(function(booking){return deferred.resolve(new BBModel.Purchase.Booking(booking))},function(err){return deferred.reject(err,new BBModel.Purchase.Booking(booking))}),deferred.promise},addSurveyAnswersToBooking:function(booking){var deferred=$q.defer(),data=booking.getPostData();return data.notify=!1,data.notify_admin=!1,booking.$put("self",{},data).then(function(booking){return deferred.resolve(new BBModel.Purchase.Booking(booking))},function(err){return deferred.reject(err,new BBModel.Purchase.Booking(booking))}),deferred.promise}}}),angular.module("BB.Services").factory("PurchaseService",function($q,halClient,BBModel,$window,UriTemplate){return{query:function(params){var defer=$q.defer(),uri=params.url_root+"/api/v1/purchases/"+params.purchase_id;return halClient.$get(uri,params).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise},bookingRefQuery:function(params){var defer=$q.defer(),uri=new UriTemplate(params.url_root+"/api/v1/purchases/booking_ref/{booking_ref}{?raw}").fillFromObject(params);return halClient.$get(uri,params).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise},update:function(params){var booking=void 0,defer=$q.defer();if(!params.purchase)return defer.reject("No purchase present"),defer.promise;var data={};if(params.bookings){var bdata=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(params.bookings)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)booking=_step.value,bdata.push(booking.getPostData())}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}data.bookings=bdata}if(params.move_reason){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(data.bookings)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)booking=_step2.value,booking.move_reason=params.move_reason}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}return params.purchase.$put("self",{},data).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise},bookWaitlistItem:function(params){var defer=$q.defer();params.purchase||params.purchase_id||defer.reject("No purchase or purchase_id present");var data={};if(data.booking_id=params.booking.id,params.purchase)params.purchase.$put("book_waitlist_item",{},data).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)});else if(params.purchase_id&&params.url_root){var uri=params.url_root+"/api/v1/purchases/"+params.purchase_id+"/book_waitlist_item";halClient.$put(uri,{},data).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)})}return defer.promise},deleteAll:function(purchase){var defer=$q.defer();return purchase?(purchase.$del("self").then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise):(defer.reject("No purchase present"),defer.promise)},deleteItem:function(params){var defer=$q.defer(),uri=params.api_url+"/api/v1/purchases/"+params.long_id+"/purchase_item/"+params.purchase_item_id;return halClient.$del(uri,{}).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise}}}),angular.module("BB.Services").service("TimeSlotPermutationService",function(DateTimeUtilitiesService){var service=this;service.permute=function(inputArray){var permutations=[],usedInput=[];return function main(){for(var input=void 0,loopIndex=0;loopIndex<inputArray.length;)input=inputArray.splice(loopIndex,1)[0],usedInput.push(input),0===inputArray.length&&permutations.push(usedInput.slice()),main(),inputArray.splice(loopIndex,0,input),usedInput.pop(),loopIndex++;return permutations}()},service.addExistingDateTimes=function(stackedItems,slots){for(var itemIndex in stackedItems){var item=stackedItems[itemIndex];if(slots.length&&(item.datetime||item.date&&item.time)){var timeSlot=void 0,datetime=item.datetime||DateTimeUtilitiesService.convertTimeToMoment(item.date.date,item.time.time),item_slots=slots[itemIndex],daySlotsForItem=item_slots[datetime.toISODate()];daySlotsForItem&&((timeSlot=_.findWhere(daySlotsForItem,{time:item.time.time}))||(timeSlot=item.time,daySlotsForItem.splice(0,0,timeSlot))),item.self===stackedItems[0].self&&(timeSlot.selected=!0)}}},service.isItemSlotsValid=function(items,itemsSlots){var isSlotsValid=!1;for(var itemIndex in items){for(var itemSlotIndex in itemsSlots[itemIndex])itemsSlots[itemIndex][itemSlotIndex]&&0!==itemsSlots[itemIndex][itemSlotIndex].length&&(isSlotsValid=!0);if(isSlotsValid){items[itemIndex].slots={};for(var slotIndex in itemsSlots[itemIndex])items[itemIndex].slots[slotIndex]=_.indexBy(itemsSlots[itemIndex][slotIndex],"time")}}return isSlotsValid},service.isItemsSlotPermutationValid=function(items,slot,daySlot,permutation){var maxGapBetweenSlots=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,isValid=!1;if(items.length&&permutation.length&&items[permutation[0]])for(var time=slot.time,durationOfFirst=items[permutation[0]].service.duration,next=time+durationOfFirst,i=1;i<permutation.length;i++)for(var daySlotIndex in items[permutation[i]].slots[daySlot])daySlotIndex>=next&&daySlotIndex<=next+maxGapBetweenSlots&&!_.isEmpty(items[permutation[i]].slots[daySlot])&&items[permutation[i]].slots[daySlot][daySlotIndex]&&(isValid=!0,slot.next=angular.copy(items[permutation[i]].slots[daySlot][daySlotIndex]),slot=slot.next,next=daySlotIndex+items[permutation[i]].service.duration);return isValid},service.findValidSlots=function(items,itemsSlots){var maxGapBetweenSlots=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,daysBySlots={};if(service.addExistingDateTimes(items,itemsSlots),service.isItemSlotsValid(items,itemsSlots)){for(var slotIndex in items[0].slots)daysBySlots[slotIndex]={date:moment(slotIndex)};var range=_.range(0,items.length),permutations=service.permute(range);for(var daySlotIndex in daysBySlots)if(daysBySlots[daySlotIndex].slots={},items.length>1)for(var permutationIndex in permutations){var permutation=permutations[permutationIndex];if(_.isEmpty(items[permutation[0]].slots[daySlotIndex]))break;for(var timeIndex in items[permutation[0]].slots[daySlotIndex]){var slot=angular.copy(items[permutation[0]].slots[daySlotIndex][timeIndex]);service.isItemsSlotPermutationValid(items,slot,daySlotIndex,permutation,maxGapBetweenSlots)&&(daysBySlots[daySlotIndex].slots[slot.time]=slot)}}else for(var _timeIndex in items[0].slots[daySlotIndex]){var _slot=items[0].slots[daySlotIndex][_timeIndex];daysBySlots[daySlotIndex].slots[_slot.time]=_slot}}return daysBySlots}}),angular.module("BB.uib").provider("runtimeUibModal",function($uibModalProvider){"ngInject";var uibModalProvider=$uibModalProvider;this.setProvider=function(provider){return uibModalProvider=provider},this.$get=function(){return uibModalProvider}}),angular.module("BB.Directives").directive("bbBasket",function(PathSvc){return{restrict:"A",replace:!0,scope:!0,templateUrl:function(element,attrs){return _.has(attrs,"mini")?PathSvc.directivePartial("_basket_mini"):PathSvc.directivePartial("basket")},controllerAs:"BasketCtrl",controller:function($scope,$uibModal,$translate,$document,BasketService){$scope.setUsingBasket(!0),this.empty=function(){return $scope.$eval("emptyBasket()")},this.view=function(){return $scope.$eval("viewBasket()")},$scope.showBasketDetails=function(){return"basket"!==$scope.bb.current_page&&"checkout"!==$scope.bb.current_page&&$uibModal.open({templateUrl:$scope.getPartial("_basket_details"),scope:$scope,controller:BasketInstanceCtrl,resolve:{basket:function(){return $scope.bb.basket}}})};var BasketInstanceCtrl=function($scope,$rootScope,$uibModalInstance,basket){return $scope.basket=basket,$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}};$scope.$watch(function(){var len=void 0;$scope.basketItemCount=len=$scope.bb.basket?$scope.bb.basket.length():0,$scope.basketStatus=$translate.instant("PUBLIC_BOOKING.BASKET_DETAILS.BASKET_STATUS",{N:len},"messageformat")})},link:function(scope,element,attrs){return element.bind("click",function(e){return e.preventDefault()})}}}),angular.module("BB.Directives").directive("bbMiniBasket",function(){return{restrict:"AE",replace:!0,scope:!0,controller:function($scope,$rootScope,BasketService,$q){return $scope.setUsingBasket(!0),$rootScope.connection_started.then(function(){}),$scope.basketDescribe=function(nothing,single,plural){return $scope.bb.basket&&0!==$scope.bb.basket.length()?1===$scope.bb.basket.length()?single:plural.replace("$0",$scope.bb.basket.length()):nothing}}}}),angular.module("BB.Directives").directive("bbMinSpend",function(){return{restrict:"A",scope:!0,controller:function($scope,$element,$attrs,AlertService,$translate){var checkMinSpend=void 0,options=$scope.$eval($attrs.bbMinSpend||{});return $scope.min_spend=options.min_spend||0,$scope.setReady=function(){return checkMinSpend()},checkMinSpend=function(){var price=0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.bb.stacked_items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){price+=_step.value.service.price}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return price>=$scope.min_spend?(AlertService.clear(),!0):(AlertService.clear(),AlertService.add("warning",{msg:$translate.instant("CORE.ALERTS.SPEND_AT_LEAST",{min_spend:$scope.min_spend})}),!1)}}}}),function(){function BBQuestionController($scope,$compile,$element){var _this=this;this.$onInit=function(){this.isTemplate=!0,setDateFormats(),this.question&&determineTemplate()},this.recalc=function(){if(angular.isDefined($scope.recalc_price)&&(_this.question.outcome||$scope.recalc_price()),angular.isDefined($scope.recalc_question))return $scope.recalc_question()};var setDateFormats=function(){_this.date_format="DD/MM/YYYY",_this.date_format_2="dd/MM/yyyy","US"===_this.dateFormatLocale&&(_this.date_format="MM/DD/YYYY",_this.date_format_2="MM/dd/yyyy")},determineTemplate=function(){_this.name=null,_this.placeholder="";var html="";if(_this.defaultPlaceholder&&("text_area"!==_this.question.detail_type&&"text_field"!==_this.question.detail_type||(_this.question.default&&(_this.placeholder=_this.question.default),_this.question.answer===_this.question.default&&(_this.question.answer=""))),$scope.idmaps&&($scope.idmaps[_this.question.detail_type]||$scope.idmaps[_this.question.id])){var index=$scope.idmaps[_this.question.id]?_this.question.id:_this.question.detail_type;html=$scope.idmaps[index].html}else"select"===_this.question.detail_type||"select-price"===_this.question.detail_type?_this.templateUrl="bb-question/_question_select.html":"text_area"===_this.question.detail_type?_this.templateUrl="bb-question/_question_text_area.html":"radio"===_this.question.detail_type?_this.templateUrl="bb-question/_question_radio.html":"check"===_this.question.detail_type?(_this.name=_this.question.name,_this.templateUrl="bb-question/_question_check.html"):"check-price"===_this.question.detail_type?_this.templateUrl="bb-question/_question_check_price.html":"radio-price"===_this.question.detail_type?_this.templateUrl="bb-question/_question_radio_price.html":"date"===_this.question.detail_type?_this.templateUrl="bb-question/_question_date.html":_this.templateUrl="bb-question/_question_default.html";compileTemplate(html)},compileTemplate=function(html){html&&(_this.isTemplate=!1,$compile(html)($scope,function(cloned,$scope){$element.replaceWith(cloned)}))}}angular.module("BB.Controllers").controller("BBQuestionController",BBQuestionController)}(angular),angular.module("BB.Directives").directive("bbQuestion",function($compile,$timeout,$templateRequest,$templateCache){return{replace:!0,transclude:!0,restrict:"A",bindToController:{question:"=bbQuestion",adminRequired:"=bbAdminRequired",dateFormatLocale:"=bbDateFormat",defaultPlaceholder:"="},template:'<div ng-if="$bbQuestionCtrl.isTemplate"><div ng-include="$bbQuestionCtrl.templateUrl"></div></div>',controller:"BBQuestionController",controllerAs:"$bbQuestionCtrl"}}),angular.module("BB.Controllers").controller("BasketList",function($scope,$rootScope,$element,$attrs,$q,AlertService,FormDataStoreService,LoginService,LoadingService,BBModel){var params=void 0;$scope.setUsingBasket(!0);var loader=LoadingService.$loader($scope);$scope.show_wallet=$scope.bb.company_settings.hasOwnProperty("has_wallets")&&$scope.bb.company_settings.has_wallets&&$scope.client.valid()&&LoginService.isLoggedIn()&&LoginService.member().id===$scope.client.id&&$scope.client.has_active_wallet,$scope.bb.basket.setSettings($scope.$eval($attrs.bbBasketList)||{}),$rootScope.connection_started.then(function(){if($scope.client&&$scope.bb.basket.setClient($scope.client),$scope.client.$has("pre_paid_bookings")&&$scope.bb.basket.timeItems().length>0){loader.notLoaded();var promises=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.bb.basket.timeItems())[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var basket_item=_step.value,_params={event_id:basket_item.getEventId()};promises.push($scope.client.$getPrePaidBookings(_params))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $q.all(promises).then(function(result){var prepaid_booking=void 0,booking_left={},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(result)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){basket_item=_step2.value;var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(basket_item)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0)prepaid_booking=_step3.value,booking_left[prepaid_booking.id]=prepaid_booking.number_of_bookings_remaining}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}for(var iterable=$scope.bb.basket.timeItems(),index=0;index<iterable.length;index++){basket_item=iterable[index];var prepaid_bookings=result[index];if($scope.bb.basket.settings&&$scope.bb.basket.settings.auto_use_prepaid_bookings&&prepaid_bookings.length>0&&basket_item.price>0)for(index=0;index<prepaid_bookings.length;index++)if(prepaid_booking=prepaid_bookings[index],booking_left[prepaid_booking.id]>0){basket_item.setPrepaidBooking(prepaid_booking),booking_left[prepaid_booking.id]-=1;break}}return $scope.bb.basket.settings.auto_use_prepaid_bookings?$scope.updateBasket().then(function(){return groupBasketItems($scope.bb.basket.timeItems())},function(err){return loader.setLoaded()}):groupBasketItems($scope.bb.basket.timeItems())})}return groupBasketItems($scope.bb.basket.timeItems())}),$scope.deleteGroupItem=function(items){return $scope.deleteBasketItems(items),$scope.multi_basket_grouping=_.without($scope.multi_basket_grouping,items)},$scope.editGroupItem=function(items,route){return $scope.bb.current_item=items[0],$scope.decideNextPage(route)},$scope.groupPrice=function(items){var group_price=0,_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){group_price+=_step4.value.total_price}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return group_price},$scope.groupTicketQty=function(items){var group_ticket_qty=0,_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){group_ticket_qty+=_step5.value.tickets.qty}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return group_ticket_qty};var groupBasketItems=function(items){return $scope.multi_basket_grouping=_.groupBy($scope.bb.basket.timeItems(),"event_id"),$scope.multi_basket_grouping=_.values($scope.multi_basket_grouping),loader.setLoaded()},updateLocalBasket=function(basket){var _iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(basket.items)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){_step6.value.storeDefaults($scope.bb.item_defaults)}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}return basket.setSettings($scope.bb.basket.settings),$scope.setBasket(basket)};return $scope.addAnother=function(route){return $scope.clearBasketItem(),$scope.bb.emptyStackedItems(),$scope.decideNextPage(route)},$scope.checkout=function(route){return $scope.bb.basket.settings&&$scope.bb.basket.settings.requires_deal&&!$scope.bb.basket.hasDeal()?(AlertService.raise("GIFT_CERTIFICATE_REQUIRED"),!1):$scope.bb.basket.items.length>0?($scope.setReadyToCheckout(!0),!!$scope.$parent.$has_page_control||$scope.decideNextPage(route)):(AlertService.raise("EMPTY_BASKET_FOR_CHECKOUT"),!1)},$scope.setReady=function(){return $scope.checkout()},$scope.applyCoupon=function(coupon){return AlertService.clear(),loader.notLoaded(),params={bb:$scope.bb,coupon:coupon},BBModel.Basket.$updateBasket($scope.bb.company,params.bb.basket).then(function(){return BBModel.Basket.$applyCoupon($scope.bb.company,params).then(function(basket){return updateLocalBasket(basket),loader.setLoaded()},function(err){return err&&err.data&&err.data.error&&(AlertService.clear(),AlertService.raise("COUPON_APPLY_FAILED")),loader.setLoaded()})})},$scope.applyDeal=function(deal_code){return AlertService.clear(),params=$scope.client?{bb:$scope.bb,deal_code:deal_code,member_id:$scope.client.id}:{bb:$scope.bb,deal_code:deal_code,member_id:null},BBModel.Basket.$updateBasket($scope.bb.company,params.bb.basket).then(function(){return BBModel.Basket.$applyDeal($scope.bb.company,params).then(function(basket){return updateLocalBasket(basket),$scope.items=$scope.bb.basket.items,$scope.deal_code=null},function(err){if(err&&err.data&&err.data.error)return AlertService.clear(),AlertService.raise("DEAL_APPLY_FAILED")})})},$scope.removeDeal=function(deal_code){return params={bb:$scope.bb,deal_code_id:deal_code.id},BBModel.Basket.$updateBasket($scope.bb.company,params.bb.basket).then(function(){return BBModel.Basket.$removeDeal($scope.bb.company,params).then(function(basket){return updateLocalBasket(basket),$scope.items=$scope.bb.basket.items},function(err){if(err&&err.data&&err.data.error)return AlertService.clear(),AlertService.raise("DEAL_REMOVE_FAILED")})})},$scope.topUpWallet=function(){return $scope.decideNextPage("basket_wallet")}}),angular.module("BB.Directives").directive("bbBasketList",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"BasketList"}}),angular.module("BB.Controllers").controller("BasketSummary",function($scope){return $scope.basket_items=$scope.bb.basket.items,$scope.confirm=function(){return $scope.bb.basket.reviewed=!0,$scope.decideNextPage()}}),angular.module("BB.Directives").directive("bbBasketSummary",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"BasketSummary"}}),angular.module("BB.Controllers").controller("BulkPurchase",function($scope,$rootScope,BBModel){return $rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)}),$scope.init=function(company){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),BBModel.BulkPurchase.$query(company).then(function(bulk_purchases){return $scope.bulk_purchases=bulk_purchases})},$scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope.bulk_purchase=item,!1):($scope.booking_item.setBulkPurchase(item),$scope.decideNextPage(route),!0)},$scope.setReady=function(){return!!$scope.bulk_purchase&&($scope.booking_item.setBulkPurchase($scope.bulk_purchase),!0)}}),angular.module("BB.Directives").directive("bbBulkPurchases",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"BulkPurchase"}}),angular.module("BB.Controllers").controller("CategoryList",function($scope,$rootScope,$q,LoadingService,BBModel){var loader=LoadingService.$loader($scope).notLoaded();return $rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.init=function(comp){return BBModel.Category.$query(comp).then(function(items){return $scope.items=items,1===items.length&&($scope.skipThisStep(),$rootScope.categories=items,$scope.selectItem(items[0],$scope.nextRoute)),loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.selectItem=function(item,route){return $scope.bb.current_item.setCategory(item),$scope.decideNextPage(route)}}),angular.module("BB.Directives").directive("bbCategories",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CategoryList"}}),angular.module("BB.Controllers").controller("Checkout",function($scope,$rootScope,$attrs,$q,$location,$window,$timeout,$bbug,FormDataStoreService,LoadingService,BBModel){var loader=LoadingService.$loader($scope).notLoaded();return $scope.options=$scope.$eval($attrs.bbCheckout)||{},FormDataStoreService.destroy($scope),$rootScope.connection_started.then(function(){return $scope.checkout()}),$scope.checkout=function(){return $scope.bb.basket.setClient($scope.client),$scope.options.no_notifications&&($scope.bb.no_notifications=$scope.options.no_notifications),$scope.loadingTotal=BBModel.Basket.$checkout($scope.bb.company,$scope.bb.basket,{bb:$scope.bb}),$scope.loadingTotal.then(function(total){return $scope.total=total,total.$has("new_payment")||($scope.$emit("checkout:success",total),$scope.bb.total=$scope.total,$scope.bb.payment_status="complete",$scope.options.disable_confirmation?$scope.reset():($scope.skipThisStep(),$scope.decideNextPage())),$scope.checkoutSuccess=!0,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong"),$scope.checkoutFailed=!0,$scope.$emit("checkout:fail",err)})},$scope.print=function(){return $window.open($scope.bb.partial_url+"print_purchase.html?id="+$scope.total.long_id,"_blank","width=700,height=500,toolbar=0,menubar=0,location=0,status=1,scrollbars=1,resizable=1,left=0,top=0"),!0},$scope.printElement=function(id,stylesheet){var data=$bbug("#"+id).html(),mywindow=$window.open("","","height=600,width=800");return $timeout(function(){return mywindow.document.write("<html><head><title>Booking Confirmation</title>"),stylesheet&&mywindow.document.write('<link rel="stylesheet" href="'+stylesheet+'" type="text/css" />'),mywindow.document.write("</head><body>"),mywindow.document.write(data),mywindow.document.write("</body></html>"),$timeout(function(){return mywindow.document.close(),mywindow.focus(),mywindow.print(),mywindow.close()},100)},2e3)}}),angular.module("BB.Directives").directive("bbCheckout",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Checkout"}}),angular.module("BB.Controllers").controller("ClientDetails",function($scope,$attrs,$rootScope,LoginService,ValidatorService,AlertService,LoadingService,BBModel){var handleError=void 0,loader=LoadingService.$loader($scope).notLoaded();console.warn("Deprecation warning: validator.validateForm() will be removed from bbClientDetails in an upcoming major release, please update your template to use bbForm and submitForm() instead. See https://github.com/bookingbug/bookingbug-angular/issues/638"),$scope.validator=ValidatorService,$scope.existing_member=!1,$scope.login_error=!1;var options=$scope.$eval($attrs.bbClientDetails)||{};return $scope.suppress_client_create=null!=$attrs.bbSuppressCreate||options.suppress_client_create,$rootScope.connection_started.then(function(){return $scope.initClientDetails()},function(err){return loader.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$rootScope.$watch("member",function(oldmem,newmem){if(!$scope.client.valid()&&LoginService.isLoggedIn())return $scope.setClient(new BBModel.Client(LoginService.member()._data))}),$scope.initClientDetails=function(){return!$scope.client.valid()&&LoginService.isLoggedIn()&&$scope.setClient(new BBModel.Client(LoginService.member()._data)),LoginService.isLoggedIn()&&LoginService.member().$has("child_clients")&&LoginService.member()&&LoginService.member().$getChildClients().then(function(children){return $scope.bb.parent_client=new BBModel.Client(LoginService.member()._data),$scope.bb.child_clients=children,$scope.bb.basket.parent_client_id=$scope.bb.parent_client.id}),$scope.client.client_details?($scope.client_details=$scope.client.client_details,$scope.client_details.questions&&BBModel.Question.$checkConditionalQuestions($scope.client_details.questions),loader.setLoaded()):BBModel.ClientDetails.$query($scope.bb.company).then(function(details){return $scope.client_details=details,$scope.client&&$scope.client.pre_fill_answers($scope.client_details),$scope.client_details.questions&&BBModel.Question.$checkConditionalQuestions($scope.client_details.questions),loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.validateClient=function(route){return loader.notLoaded(),$scope.existing_member=!1,$scope.bb&&$scope.bb.parent_client&&($scope.client.parent_client_id=$scope.bb.parent_client.id),$scope.client.setClientDetails($scope.client_details),BBModel.Client.$create_or_update($scope.bb.company,$scope.client).then(function(client){return loader.setLoaded(),$scope.setClient(client),$scope.bb.isAdmin&&$scope.client.setValid(!0),$scope.existing_member=!1,$scope.decideNextPage(route)},function(err){return handleError(err)})},$scope.clientLogin=function(){if($scope.login_error=!1,$scope.login)return LoginService.companyLogin($scope.bb.company,{},{email:$scope.login.email,password:$scope.login.password}).then(function(client){return $scope.setClient(new BBModel.Client(client)),$scope.login_error=!1,$scope.decideNextPage()},function(err){return $scope.login_error=!0,loader.setLoaded(),AlertService.raise("LOGIN_FAILED")})},$scope.setReady=function(){if($scope.client.setClientDetails($scope.client_details),$scope.suppress_client_create)return!0;var prom=BBModel.Client.$create_or_update($scope.bb.company,$scope.client);return prom.then(function(client){if(loader.setLoaded(),$scope.setClient(client),LoginService.setLogin(client),client.waitingQuestions)return client.gotQuestions.then(function(){return $scope.client_details=client.client_details})},function(err){return handleError(err)}),prom},$scope.clientSearch=function(){return null!=$scope.client&&null!=$scope.client.email&&""!==$scope.client.email?(loader.notLoaded(),BBModel.Client.$query_by_email($scope.bb.company,$scope.client.email).then(function(client){return null!=client&&($scope.setClient(client),$scope.client=client),loader.setLoaded()},function(err){return loader.setLoaded()})):($scope.setClient({}),$scope.client={})},$scope.switchNumber=function(to){return $scope.no_mobile=!$scope.no_mobile,"mobile"===to?($scope.bb.basket.setSettings({send_sms_reminder:!0}),$scope.client.phone=null):($scope.bb.basket.setSettings({send_sms_reminder:!1}),$scope.client.mobile=null)},$scope.getQuestion=function(id){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{
for(var _step,_iterator=Array.from($scope.client_details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var question=_step.value;if(question.id===id)return question}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return null},$scope.useClient=function(client){return $scope.setClient(client)},$scope.recalc_question=function(){if($scope.client_details.questions)return BBModel.Question.$checkConditionalQuestions($scope.client_details.questions)},handleError=function(error){return"Please Login"===error.data.error?($scope.existing_member=!0,AlertService.raise("ALREADY_REGISTERED")):"Invalid Password"===error.data.error&&AlertService.raise("PASSWORD_INVALID"),loader.setLoaded()}}),angular.module("BB.Directives").directive("bbClientDetails",function($q,$templateCache,$compile){return{restrict:"AE",replace:!0,scope:!0,transclude:!0,controller:"ClientDetails",link:function(scope,element,attrs,controller,transclude){return transclude(scope,function(clone){return clone.length>1||1===clone.length&&(!clone[0].wholeText||/\S/.test(clone[0].wholeText))?element.html(clone).show():$q.when($templateCache.get("_client_details.html")).then(function(template){return element.html(template).show(),$compile(element.contents())(scope)})})}}});var CompanyListBase=function($scope,$rootScope,$q,$attrs,LoadingService){var loader=LoadingService.$loader($scope).notLoaded(),options=$scope.$eval($attrs.bbCompanies);return $rootScope.connection_started.then(function(){return $scope.bb.company.companies?($scope.init($scope.bb.company),$rootScope.parent_id=$scope.bb.company.id):$rootScope.parent_id?void $scope.initWidget({company_id:$rootScope.parent_id,first_page:$scope.bb.current_page}):$scope.init($scope.bb.company)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.init=function(comp){return $scope.companies=$scope.bb.company.companies,$scope.companies&&0!==$scope.companies.length||($scope.companies=[$scope.bb.company]),1===$scope.companies.length?($scope.skipThisStep(),$scope.selectItem($scope.companies[0])):options&&options.hide_not_live_stores?$scope.items=$scope.companies.filter(function(c){return c.live}):$scope.items=$scope.companies,loader.setLoaded()},$scope.selectItem=function(item,route){var company_id=void 0;company_id=angular.isNumber(item)?item:item.id,loader.notLoaded();var prms={company_id:company_id};return $scope.initWidget(prms)},$scope.splitString=function(company){var arr=company.name.split(" ");return arr[2]?arr[2]:""}};angular.module("BB.Controllers").controller("CompanyList",CompanyListBase),angular.module("BB.Directives").directive("bbCompanies",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CompanyList"}}),function(){function dayListController($scope,$rootScope,DayService,bbAnalyticsPiwik){"ngInject";function setPiwik(amount){var title="Load Next Week";amount<0&&(title="Load Previous Week"),bbAnalyticsPiwik.push(["trackEvent",["Calendar"],title])}$rootScope.connection_started.then(function(){return $scope.moment=moment,!$scope.current_date&&$scope.last_selected_date?($scope.selected_date=$scope.last_selected_date.clone(),setCurrentDate($scope.last_selected_date.clone().startOf("week"))):$scope.current_date||setCurrentDate(moment().startOf("week")),$scope.loadData()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.$on("BBTimeZoneOptions:timeZoneChanged",function(){$scope.bb.current_item.date&&$scope.selectDay($scope.bb.current_item.date)}),$scope.selectDay=function(day){if(day.spaces&&(!day.spaces||0!==day.spaces))return $scope.setLastSelectedDate(day.date),$scope.selected_date=day.date,$scope.bb.current_item.setDate(day),$scope.$broadcast("dateChanged",day.date)};var setCurrentDate=function(date){return $scope.current_date=date,$scope.current_date_js=$scope.current_date.toDate()};return $scope.add=function(type,amount){return bbAnalyticsPiwik.isEnabled()&&setPiwik(amount),setCurrentDate($scope.current_date.add(amount,type)),$scope.loadData()},$scope.subtract=function(type,amount){return $scope.add(type,-amount)},$scope.currentDateChanged=function(){var date=moment($scope.current_date_js).startOf("week");return setCurrentDate(date),$scope.loadData()},$scope.isDateDisabled=function(date,mode){return date=moment(date),"day"===mode&&(1!==date.day()||date.isBefore(moment(),"day"))},$scope.isPast=function(){return!$scope.current_date||moment().isAfter($scope.current_date)},$scope.loadData=function(){return $scope.day_data={},$scope.notLoaded($scope),$scope.end_date=moment($scope.current_date).add(5,"weeks"),DayService.query({company:$scope.bb.company,cItem:$scope.bb.current_item,date:$scope.current_date.toISODate(),edate:$scope.end_date.toISODate(),client:$scope.client}).then(function(days){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(days)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var day=_step.value;$scope.day_data[day.string_date]={spaces:day.spaces,date:day.date}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $scope.weeks=_.groupBy($scope.day_data,function(day){return day.date.week()}),$scope.weeks=_.toArray($scope.weeks),$scope.$emit("bbDayList:loaded"),$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}angular.module("BB.Controllers").controller("DayList",dayListController)}(),angular.module("BB.Directives").directive("bbDayList",function(){return{restrict:"A",replace:!0,scope:!0,controller:"DayList"}}),angular.module("BB.Controllers").controller("DealList",function($scope,$rootScope,$uibModal,$document,AlertService,FormDataStoreService,ValidatorService,LoadingService,BBModel,$translate){FormDataStoreService.init("DealList",$scope,["deals"]);var loader=LoadingService.$loader($scope).notLoaded();console.warn("Deprecation warning: validator.validateForm() will be removed from bbDealList in an upcoming major release, please update your template to use bbForm and submitForm() instead. See https://github.com/bookingbug/bookingbug-angular/issues/638"),$scope.validator=ValidatorService,$rootScope.connection_started.then(function(){return init()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")});var init=function(){if(loader.notLoaded(),!$scope.deals){return BBModel.Deal.$query($scope.bb.company).then(function(deals){return $scope.deals=deals,loader.setLoaded()})}};$scope.selectDeal=function(deal){var iitem=new BBModel.BasketItem(null,$scope.bb);return iitem.setDefaults($scope.bb.item_defaults),iitem.setDeal(deal),$scope.bb.company_settings.no_recipient?(loader.notLoaded(),$scope.setBasketItem(iitem),$scope.addItemToBasket().then(function(){return loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})):$uibModal.open({templateUrl:$scope.getPartial("_add_recipient"),scope:$scope,controller:ModalInstanceCtrl,resolve:{item:function(){return iitem}}}).result.then(function(item){return loader.notLoaded(),$scope.setBasketItem(item),$scope.addItemToBasket().then(function(){return loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})})};var ModalInstanceCtrl=function($scope,$uibModalInstance,item,ValidatorService){return $scope.item=item,$scope.recipient=!1,$scope.addToBasket=function(form){if(ValidatorService.validateForm(form))return $uibModalInstance.close($scope.item)},$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}};return $scope.purchaseDeals=function(){return $scope.bb.basket.items&&$scope.bb.basket.items.length>0?$scope.decideNextPage():AlertService.add("danger",{msg:$translate.instant("PUBLIC_BOOKING.DEAL_LIST.CERT_NOT_SELECTED_ALERT")})},$scope.setReady=function(){return!!($scope.bb.basket.items&&$scope.bb.basket.items.length>0)||AlertService.add("danger",{msg:$translate.instant("PUBLIC_BOOKING.DEAL_LIST.CERT_NOT_SELECTED_ALERT")})}}),angular.module("BB.Directives").directive("bbDeals",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"DealList"}}),angular.module("BB.Controllers").controller("DurationList",function($scope,$attrs,$rootScope,$q,$filter,AlertService,ValidatorService,LoadingService,$translate,routeStates){function reloadIfDurationChanged(event,currentItem,payload){null!==payload&&payload===routeStates.Duration||$scope.loadData()}var duration=void 0,loader=LoadingService.$loader($scope).notLoaded(),options=$scope.$eval($attrs.bbDurations)||{};$rootScope.connection_started.then(function(){return $scope.loadData()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.loadData=function(){var service=$scope.bb.current_item.service;if(service){$scope.durations=Array.from(_.zip(service.durations,service.prices)).map(function(d){return{value:d[0],price:d[1]}});var initial_duration=$scope.$eval($attrs.bbInitialDuration),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.durations)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)duration=_step.value,$scope.bb.current_item.duration&&duration.value===$scope.bb.current_item.duration?$scope.duration=duration:initial_duration&&initial_duration===duration.value&&($scope.duration=duration,$scope.bb.current_item.setDuration(duration.value)),duration.pretty=$filter("time_period")(duration.value),options.show_prices&&(duration.pretty+=" ("+$filter("currency")(duration.price)+")")}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}$scope.duration||($scope.duration=$scope.durations[0]),1===$scope.durations.length&&($scope.skipThisStep(),$scope.selectDuration($scope.durations[0],$scope.nextRoute))}return loader.setLoaded()},$scope.selectDuration=function(dur,route){return $scope.$parent.$has_page_control?void($scope.duration=dur):($scope.bb.current_item.setDuration(dur.value),$scope.decideNextPage(route),!0)},$scope.durationChanged=function(){$scope.bb.current_item.setDuration($scope.duration.value),$scope.broadcastItemUpdate(routeStates.Duration)},$scope.setReady=function(){return $scope.duration?($scope.bb.current_item.setDuration($scope.duration.value),!0):(AlertService.clear(),AlertService.add("danger",{msg:$translate.instant("PUBLIC_BOOKING.DURATION_LIST.DURATON_NOT_SELECTED_ALERT")}),!1)},$scope.$on("currentItemUpdate",reloadIfDurationChanged)}),angular.module("BB.Directives").directive("bbDurations",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"DurationList"}}),angular.module("BB.Controllers").controller("Event",function($scope,$attrs,$rootScope,EventService,$q,BBModel,ValidatorService,FormDataStoreService,LoadingService){var initTickets=void 0,loader=LoadingService.$loader($scope).notLoaded();console.warn("Deprecation warning: validator.validateForm() will be removed from bbEvent in an upcoming major release, please update your template to use bbForm and submitForm() instead. See https://github.com/bookingbug/bookingbug-angular/issues/638"),$scope.validator=ValidatorService,$scope.event_options=$scope.$eval($attrs.bbEvent)||{};var ticket_refs=[];FormDataStoreService.init("Event",$scope,["selected_tickets","event_options"]),$rootScope.connection_started.then(function(){if($scope.bb.company)return init($scope.bb.company)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")});var init=function(comp){$scope.bb.stacked_items&&0===$scope.bb.stacked_items.length&&delete $scope.selected_tickets,$scope.event=$scope.bb.current_item.event,$scope.event_options.use_my_details=null==$scope.event_options.use_my_details||$scope.event_options.use_my_details;var promises=[$scope.bb.current_item.event_group.$getImages(),$scope.event.prepEvent()];return $scope.client&&promises.push($scope.getPrePaidsForEvent($scope.client,$scope.event)),$q.all(promises).then(function(result){var images=void 0;result[0]&&result[0].length>0&&(images=result[0]);var event=result[1];return result[2]&&result[2].length,$scope.event=event,images&&initImage(images),$scope.bb.current_item.tickets&&$scope.bb.current_item.tickets.qty>0?($scope.edit_mode=!0,loader.setLoaded(),$scope.selected_tickets=!0,$scope.current_ticket_items=_.filter($scope.bb.basket.timeItems(),function(item){return item.event_id===$scope.event.id}),$scope.tickets=function(){var result1=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.current_ticket_items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;result1.push(item.tickets)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result1}(),void $scope.$watch("current_ticket_items",function(items,olditems){return $scope.bb.basket.total_price=$scope.bb.basket.totalPrice()},!0)):(initTickets(),$scope.$broadcast("bbEvent:initialised"),loader.setLoaded())},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})};$scope.selectTickets=function(){var item=void 0,ref=void 0;loader.notLoaded(),$scope.bb.emptyStackedItems();var base_item=$scope.bb.current_item,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.event.tickets)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var ticket=_step2.value;if(ticket.qty)switch($scope.event.chain.ticket_type){case"single_space":for(var c=1,end=ticket.qty,asc=1<=end;asc?c<=end:c>=end;asc?c++:c--){item=new BBModel.BasketItem;ref=item.ref,angular.extend(item,base_item),item.ref=ref,ticket_refs.push(item.ref),delete item.id,item.tickets=angular.copy(ticket),item.tickets.qty=1,$scope.bb.stackItem(item)}break;case"multi_space":item=new BBModel.BasketItem;ref=item.ref,angular.extend(item,base_item),item.ref=ref,ticket_refs.push(item.ref),item.tickets=angular.copy(ticket),delete item.id,item.tickets.qty=ticket.qty,$scope.bb.stackItem(item)}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return 0===$scope.bb.stacked_items.length?void loader.setLoaded():($scope.bb.pushStackToBasket(),$scope.updateBasket().then(function(){return loader.setLoaded(),$scope.selected_tickets=!0,$scope.stopTicketWatch(),$scope.current_ticket_items=_.filter($scope.bb.basket.timeItems(),function(item){return _.contains(ticket_refs,item.ref)}),$scope.tickets=function(){var result=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.current_ticket_items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0)item=_step3.value,result.push(item.tickets)}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return result}(),$scope.$watch("current_ticket_items",function(items,olditems){return $scope.bb.basket.total_price=$scope.bb.basket.totalPrice()},!0)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}))},$scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope.event=item,!1):($scope.bb.current_item.setEvent(item),$scope.bb.current_item.ready=!1,$scope.decideNextPage(route),!0)},$scope.setReady=function(){var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from($scope.current_ticket_items)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){_step4.value.setEvent($scope.event)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return $scope.bb.event_details={name:$scope.event.chain.name,image:$scope.event.image,address:$scope.event.chain.address,datetime:$scope.event.date,end_datetime:$scope.event.end_datetime,duration:$scope.event.duration,tickets:$scope.event.tickets},!!$scope.event_options.suppress_basket_update||$scope.updateBasket()},$scope.getPrePaidsForEvent=function(client,event){var defer=$q.defer(),params={event_id:event.id};return client.$getPrePaidBookings(params).then(function(prepaids){return $scope.pre_paid_bookings=prepaids,defer.resolve(prepaids)},function(err){return defer.reject(err)}),defer.promise};var initImage=function(images){var image=images[0];if(image)return image.background_css={"background-image":"url("+image.url+")"},$scope.event.image=image};return initTickets=function(){if(!$scope.selected_tickets){if($scope.event.tickets[0].qty=$scope.event_options.default_num_tickets?$scope.event_options.default_num_tickets:0,$scope.event.tickets.length>1){var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from($scope.event.tickets.slice(1))[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){_step5.value.qty=0}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}}return $scope.event_options.default_num_tickets&&$scope.event_options.auto_select_tickets&&1===$scope.event.tickets.length&&1===$scope.event.tickets[0].max_num_bookings&&$scope.selectTickets(),$scope.tickets=$scope.event.tickets,$scope.bb.basket.total_price=$scope.bb.basket.totalPrice(),$scope.stopTicketWatch=$scope.$watch("tickets",function(tickets,oldtickets){return $scope.bb.basket.total_price=$scope.bb.basket.totalPrice(),$scope.event.updatePrice()},!0)}}}),angular.module("BB.Directives").directive("bbEvent",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Event"}}),angular.module("BB.Controllers").controller("EventGroupList",function($scope,$rootScope,$q,$attrs,ItemService,FormDataStoreService,ValidatorService,LoadingService){FormDataStoreService.init("EventGroupList",$scope,["event_group"]);var loader=LoadingService.$loader($scope).notLoaded();$rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.init=function(comp){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),comp.getEventGroups().then(function(items){var item=void 0;"false"!==$attrs.filterServices&&($scope.booking_item.service_ref&&!$scope.show_all?items=items.filter(function(x){return x.api_ref===$scope.booking_item.service_ref}):$scope.booking_item.category&&!$scope.show_all&&(items=items.filter(function(x){return x.$has("category")&&x.$href("category")===$scope.booking_item.category.self}))),1!==items.length||$scope.allowSinglePick?setEventGroupItem(items):$scope.selectItem(items[0],$scope.nextRoute)?$scope.skipThisStep():setEventGroupItem(items);var default_event_group=$scope.booking_item.defaultService();if(default_event_group){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)item=_step.value,item.self===default_event_group.self&&$scope.selectItem(item,$scope.nextRoute)}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}if($scope.booking_item.event_group){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)item=_step2.value,item.selected=!1,item.self===$scope.booking_item.event_group.self&&($scope.event_group=item,item.selected=!0,$scope.booking_item.setEventGroup($scope.event_group))}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}if(loader.setLoaded(),$scope.booking_item.event_group||!$scope.booking_item.person&&!$scope.booking_item.resource)return $scope.bookable_services=$scope.items},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})};var setEventGroupItem=function(items){if($scope.items=items,$scope.event_group)return _.each(items,function(item){if(item.id===$scope.event_group.id)return $scope.event_group=item})};return $scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope.event_group=item,!1):($scope.booking_item.setEventGroup(item),$scope.decideNextPage(route),!0)},$scope.$watch("event_group",function(newval,oldval){if($scope.event_group&&(!$scope.booking_item.event_group||$scope.booking_item.event_group.self!==$scope.event_group.self))return $scope.booking_item.setEventGroup($scope.event_group),$scope.broadcastItemUpdate()}),$scope.setReady=function(){return!!$scope.event_group&&($scope.booking_item.setEventGroup($scope.event_group),!0)}}),angular.module("BB.Directives").directive("bbEventGroups",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"EventGroupList",link:function(scope,element,attrs){attrs.bbItem&&(scope.booking_item=scope.$eval(attrs.bbItem)),attrs.bbShowAll&&(scope.show_all=!0)}}}),angular.module("BB.Controllers").controller("EventList",function($scope,$rootScope,EventService,EventChainService,EventGroupService,$q,FormDataStoreService,$filter,PaginationService,$timeout,ValidatorService,LoadingService,BBModel){var i=void 0,loader=LoadingService.$loader($scope).notLoaded();$scope.pick={},$scope.start_date=moment(),$scope.end_date=moment().add(1,"year"),$scope.filters={hide_fully_booked_events:!1},$scope.pagination=PaginationService.initialise({page_size:10,max_size:5}),$scope.events={},$scope.fully_booked=!1,$scope.event_data_loaded=!1,FormDataStoreService.init("EventList",$scope,["selected_date","event_group_id","event_group_manually_set"]),$rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.bb.item_defaults&&$scope.bb.item_defaults.event||$scope.bb.current_item.defaults&&$scope.bb.current_item.defaults.event?($scope.skipThisStep(),void $scope.decideNextPage()):$scope.bb.company.$has("parent")&&!$scope.bb.company.$has("company_questions")?$scope.bb.company.$getParent().then(function(parent){return $scope.company_parent=parent,$scope.initialise()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):$scope.initialise()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.initialise=function(){var event_group=void 0;loader.notLoaded(),0!==$scope.mode&&delete $scope.selected_date,$scope.event_group_manually_set||null!=$scope.bb.current_item.event_group||($scope.event_group_manually_set=null==$scope.event_group_manually_set&&null!=$scope.bb.current_item.event_group),$scope.bb.current_item.event&&(event_group=$scope.bb.current_item.event_group,$scope.clearBasketItem(),$scope.emptyBasket(),$scope.event_group_manually_set&&$scope.bb.current_item.setEventGroup(event_group));var promises=[];return $scope.bb.company.$has("company_questions")?promises.push($scope.bb.company.$getCompanyQuestions()):null!=$scope.company_parent&&$scope.company_parent.$has("company_questions")?promises.push($scope.company_parent.$getCompanyQuestions()):(promises.push($q.when([])),$scope.has_company_questions=!1),$scope.bb.item_defaults&&$scope.bb.item_defaults.event_group?$scope.bb.current_item.setEventGroup($scope.bb.item_defaults.event_group):!$scope.bb.current_item.event_group&&$scope.bb.company.$has("event_groups")?promises.push(EventGroupService.query($scope.bb.company,{per_page:500})):promises.push($q.when([])),0===$scope.mode||2===$scope.mode?promises.push($scope.loadEventSummary()):promises.push($q.when([])),1===$scope.mode||2===$scope.mode?promises.push($scope.loadEventData()):promises.push($q.when([])),$q.all(promises).then(function(result){var company_questions=result[0],event_groups=result[1];$scope.has_company_questions=null!=company_questions&&company_questions.length>0,company_questions&&buildDynamicFilters(company_questions),$scope.event_groups=event_groups;var event_groups_collection=_.indexBy(event_groups,"id");if($scope.items){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;item.group=event_groups_collection[item.service_id]}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.loadEventSummary=function(){var deferred=$q.defer();$scope.bb.current_item&&($scope.bb.current_item.event_chain_id||$scope.bb.current_item.event_chain)&&(delete $scope.bb.current_item.event_chain,delete $scope.bb.current_item.event_chain_id);var comp=$scope.bb.company,params={item:$scope.bb.current_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate()};return $scope.bb.item_defaults.event_chain&&(params.event_chain_id=$scope.bb.item_defaults.event_chain.id),BBModel.Event.$summary(comp,params).then(function(items){var item_dates=void 0;if(items&&items.length>0){item_dates=[];var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var item=_step2.value,d=moment(item);item_dates.push({date:d,idate:parseInt(d.format("YYYYDDDD")),count:1,spaces:1})}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}$scope.item_dates=item_dates.sort(function(a,b){return a.idate-b.idate}),0===$scope.mode&&($scope.selected_date&&($scope.selected_date.isAfter($scope.item_dates[0].date)||$scope.selected_date.isSame($scope.item_dates[0].date))&&($scope.selected_date.isBefore($scope.item_dates[$scope.item_dates.length-1].date)||$scope.selected_date.isSame($scope.item_dates[$scope.item_dates.length-1].date))?$scope.showDay($scope.selected_date):$scope.showDay($scope.item_dates[0].date))}return deferred.resolve($scope.item_dates)},function(err){return deferred.reject()}),deferred.promise},$scope.loadEventChainData=function(comp){var deferred=$q.defer();if($scope.bb.item_defaults.event_chain)deferred.resolve([]);else{loader.notLoaded(),comp||(comp=$scope.bb.company);var params={item:$scope.bb.current_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate()};$scope.events_options.embed&&(params.embed=$scope.events_options.embed),$scope.client&&(params.member_level_id=$scope.client.member_level_id),BBModel.EventChain.$query(comp,params).then(function(event_chains){return loader.setLoaded(),deferred.resolve(event_chains)},function(err){return deferred.reject()})}return deferred.promise},$scope.loadEventData=function(comp){loader.notLoaded(),$scope.event_data_loaded=!1,0===$scope.mode&&delete $scope.items;var deferred=$q.defer(),current_event=$scope.bb.current_item.event;comp||(comp=$scope.bb.company),$scope.bb.current_item&&($scope.bb.current_item.event_chain_id||$scope.bb.current_item.event_chain)&&(delete $scope.bb.current_item.event_chain,delete $scope.bb.current_item.event_chain_id);var params={item:$scope.bb.current_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate(),include_non_bookable:!0};$scope.events_options.event_data_embed&&(params.embed=$scope.events_options.event_data_embed),$scope.bb.item_defaults.event_chain&&(params.event_chain_id=$scope.bb.item_defaults.event_chain.id),$scope.per_page&&(params.per_page=$scope.per_page);var chains=$scope.loadEventChainData(comp);return $scope.events={},BBModel.Event.$query(comp,params).then(function(events){$scope.items=_.flatten(events);var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var item=_step3.value;item.spaces_left=item.getSpacesLeft()}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return $scope.bb.company.$has("address")&&$scope.bb.company.$getAddress().then(function(address){return function(){var result=[],_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)item=_step4.value,result.push(item.address=address)}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return result}()}),chains.then(function(){var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0)item=_step5.value,params={embed:$scope.events_options.embed},$scope.client&&(params.member_level_id=$scope.client.member_level_id),item.prepEvent(params),0===$scope.mode&&current_event&&current_event.self===item.self&&(item.select(),$scope.event=item)}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}if(1===$scope.mode){var idate=void 0,item_dates={};if(items.length>0){var _iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0)item=_step6.value,item.getDuration(),idate=parseInt(item.date.format("YYYYDDDD")),item.idate=idate,item_dates[idate]||(item_dates[idate]={date:item.date,idate:idate,count:0,spaces:0}),item_dates[idate].count+=1,item_dates[idate].spaces+=item.num_spaces}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}$scope.item_dates=[];for(var x in item_dates){
var y=item_dates[x];$scope.item_dates.push(y)}$scope.item_dates=$scope.item_dates.sort(function(a,b){return a.idate-b.idate})}else idate=parseInt($scope.start_date.format("YYYYDDDD")),$scope.item_dates=[{date:$scope.start_date,idate:idate,count:0,spaces:0}]}return $scope.isFullyBooked(),$scope.filtered_items=$scope.items,$scope.filterChanged(),PaginationService.update($scope.pagination,$scope.filtered_items.length),loader.setLoaded(),$scope.event_data_loaded=!0,deferred.resolve($scope.items)},function(err){return deferred.reject()})},function(err){return deferred.reject()}),deferred.promise},$scope.isFullyBooked=function(){var full_events=[],_iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _step7,_iterator7=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var item=_step7.value;item.num_spaces===item.spaces_booked&&full_events.push(item)}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}if(full_events.length===$scope.items.length)return $scope.fully_booked=!0},$scope.showDay=function(date){var new_date=void 0;if(moment.isMoment(date))return 0===$scope.mode?($scope.event&&!$scope.selected_date.isSame(date,"day")&&delete $scope.event,new_date=date,$scope.start_date=moment(date),$scope.end_date=moment(date),$scope.loadEventData()):$scope.selected_date&&date.isSame($scope.selected_date,"day")||(new_date=date),new_date?($scope.selected_date=new_date,$scope.filters.date=new_date.toDate()):(delete $scope.selected_date,delete $scope.filters.date),$scope.filterChanged()},$scope.$watch("pick.date",function(new_val,old_val){if(new_val)return $scope.start_date=moment(new_val),$scope.end_date=moment(new_val),$scope.loadEventData()}),$scope.selectItem=function(item,route){if((item.getSpacesLeft()>0||!$scope.bb.company.settings.has_waitlists)&&!item.hasSpace())return!1;if(loader.notLoaded(),$scope.$parent.$has_page_control)return $scope.event&&$scope.event.unselect(),$scope.event=item,$scope.event.select(),loader.setLoaded(),!1;if($scope.bb.moving_purchase){var _iteratorNormalCompletion8=!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var _step8,_iterator8=Array.from($scope.bb.basket.items)[Symbol.iterator]();!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=!0)i=_step8.value,i.setEvent(item)}catch(err){_didIteratorError8=!0,_iteratorError8=err}finally{try{!_iteratorNormalCompletion8&&_iterator8.return&&_iterator8.return()}finally{if(_didIteratorError8)throw _iteratorError8}}}return $scope.bb.current_item.setEvent(item),$scope.bb.current_item.ready=!1,$q.all($scope.bb.current_item.promises).then(function(){return $scope.decideNextPage(route)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),!0},$scope.setReady=function(){return!!$scope.event&&($scope.bb.current_item.setEvent($scope.event),!0)},$scope.filterEvents=function(item){return item.bookable&&(moment($scope.filters.date).isSame(item.date,"day")||null==$scope.filters.date)&&($scope.filters.event_group&&item.service_id===$scope.filters.event_group.id||null==$scope.filters.event_group)&&(null!=$scope.filters.price&&item.price_range.from<=$scope.filters.price||null==$scope.filters.price)&&($scope.filters.hide_fully_booked_events&&item.getSpacesLeft()>0||!$scope.filters.hide_fully_booked_events)&&$scope.filterEventsWithDynamicFilters(item)},$scope.filterEventsWithDynamicFilters=function(item){if(!$scope.has_company_questions||!$scope.dynamic_filters)return!0;var result=!0,_iteratorNormalCompletion9=!0,_didIteratorError9=!1,_iteratorError9=void 0;try{for(var _step9,_iterator9=Array.from($scope.dynamic_filters.question_types)[Symbol.iterator]();!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=!0){var dynamic_filter,filter,name,type=_step9.value;if("check"===type){var _iteratorNormalCompletion10=!0,_didIteratorError10=!1,_iteratorError10=void 0;try{for(var _step10,_iterator10=Array.from($scope.dynamic_filters.check)[Symbol.iterator]();!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=!0){if(dynamic_filter=_step10.value,name=dynamic_filter.name.parameterise("_"),filter=!1,item.chain&&item.chain.extra[name]){var _iteratorNormalCompletion11=!0,_didIteratorError11=!1,_iteratorError11=void 0;try{for(var _step11,_iterator11=Array.from(item.chain.extra[name])[Symbol.iterator]();!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done)&&(i=_step11.value,!(filter=$scope.dynamic_filters.values[dynamic_filter.name]&&i===$scope.dynamic_filters.values[dynamic_filter.name].name||null==$scope.dynamic_filters.values[dynamic_filter.name]));_iteratorNormalCompletion11=!0);}catch(err){_didIteratorError11=!0,_iteratorError11=err}finally{try{!_iteratorNormalCompletion11&&_iterator11.return&&_iterator11.return()}finally{if(_didIteratorError11)throw _iteratorError11}}}else void 0!==item.chain.extra[name]||!_.isEmpty($scope.dynamic_filters.values)&&null!=$scope.dynamic_filters.values[dynamic_filter.name]||(filter=!0);result=result&&filter}}catch(err){_didIteratorError10=!0,_iteratorError10=err}finally{try{!_iteratorNormalCompletion10&&_iterator10.return&&_iterator10.return()}finally{if(_didIteratorError10)throw _iteratorError10}}}else{var _iteratorNormalCompletion12=!0,_didIteratorError12=!1,_iteratorError12=void 0;try{for(var _step12,_iterator12=Array.from($scope.dynamic_filters[type])[Symbol.iterator]();!(_iteratorNormalCompletion12=(_step12=_iterator12.next()).done);_iteratorNormalCompletion12=!0)dynamic_filter=_step12.value,name=dynamic_filter.name.parameterise("_"),filter=$scope.dynamic_filters.values[dynamic_filter.name]&&item.chain.extra[name]===$scope.dynamic_filters.values[dynamic_filter.name].name||null==$scope.dynamic_filters.values[dynamic_filter.name],result=result&&filter}catch(err){_didIteratorError12=!0,_iteratorError12=err}finally{try{!_iteratorNormalCompletion12&&_iterator12.return&&_iterator12.return()}finally{if(_didIteratorError12)throw _iteratorError12}}}}}catch(err){_didIteratorError9=!0,_iteratorError9=err}finally{try{!_iteratorNormalCompletion9&&_iterator9.return&&_iterator9.return()}finally{if(_didIteratorError9)throw _iteratorError9}}return result},$scope.filterDateChanged=function(options){if(null==options&&(options={reset:!1}),$scope.filters.date){var date=moment($scope.filters.date);if($scope.$broadcast("event_list_filter_date:changed",date),$scope.showDay(date),!0===options.reset||null==$scope.selected_date)return $timeout(function(){return delete $scope.filters.date},250)}},$scope.resetFilters=function(){return $scope.filters={},$scope.has_company_questions&&($scope.dynamic_filters.values={}),$scope.filterChanged(),delete $scope.selected_date,$rootScope.$broadcast("event_list_filter_date:cleared")};var buildDynamicFilters=function(questions){return questions=_.each(questions,function(question){return question.name=$filter("wordCharactersAndSpaces")(question.name)}),$scope.dynamic_filters=_.groupBy(questions,"question_type"),$scope.dynamic_filters.question_types=_.uniq(_.pluck(questions,"question_type")),$scope.dynamic_filters.values={}};return $scope.filterChanged=function(){if($scope.items)return $scope.filtered_items=$filter("filter")($scope.items,$scope.filterEvents),$scope.pagination.num_items=$scope.filtered_items.length,$scope.filter_active=$scope.filtered_items.length!==$scope.items.length,PaginationService.update($scope.pagination,$scope.filtered_items.length)},$scope.pageChanged=function(){return PaginationService.update($scope.pagination,$scope.filtered_items.length),$rootScope.$broadcast("page:changed")}}),angular.module("BB.Directives").directive("bbEvents",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"EventList",link:function(scope,element,attrs){scope.summary=null!=attrs.summary,scope.events_options=scope.$eval(attrs.bbEvents)||{},scope.mode=scope.events_options&&scope.events_options.mode?scope.events_options.mode:0,scope.summary&&(scope.mode=0),scope.events_options&&scope.events_options.per_page&&(scope.per_page=scope.events_options.per_page)}}}),function(){function itemDetailsController($scope,$attrs,$rootScope,PurchaseBookingService,AlertService,BBModel,FormDataStoreService,ValidatorService,$uibModal,$document,$translate,$filter,GeneralOptions,PurchaseService,LoadingService,bbTimeZone){"ngInject";var loader=LoadingService.$loader($scope);$scope.suppress_basket_update=null!=$attrs.bbSuppressBasketUpdate,$scope.item_details_id=$scope.$eval($attrs.bbSuppressBasketUpdate),$scope.suppress_basket_update?FormDataStoreService.init("ItemDetails"+$scope.item_details_id,$scope,["item_details"]):FormDataStoreService.init("ItemDetails",$scope,["item_details"]),BBModel.Question.$addAnswersByName($scope.client,["first_name","last_name","email","mobile"]),console.warn("Deprecation warning: validator.validateForm() will be removed from bbItemDetails in an upcoming major release, please update your template to use bbForm and submitForm() instead. See https://github.com/bookingbug/bookingbug-angular/issues/638"),$scope.validator=ValidatorService;var confirming=!1;$rootScope.connection_started.then(function(){if(!confirming)return $scope.loadItem($scope.bb.current_item)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.loadItem=function(item){if(loader.notLoaded(),confirming=!0,$scope.item=item,$scope.bb.private_note&&($scope.item.private_note=$scope.bb.private_note),$scope.product=item.product,$scope.item.item_details)return setItemDetails($scope.item.item_details),BBModel.Question.$addDynamicAnswersByName($scope.item_details.questions),$scope.bb.item_defaults.answers&&BBModel.Question.$addAnswersFromDefaults($scope.item_details.questions,$scope.bb.item_defaults.answers),$scope.recalc_price(),loader.setLoaded(),$scope.$emit("item_details:loaded",$scope.item_details);var params={company:$scope.bb.company,cItem:$scope.item};return BBModel.ItemDetails.$query(params).then(function(details){return details&&(setItemDetails(details),$scope.item.item_details=$scope.item_details,BBModel.Question.$addDynamicAnswersByName($scope.item_details.questions),$scope.bb.item_defaults.answers&&BBModel.Question.$addAnswersFromDefaults($scope.item_details.questions,$scope.bb.item_defaults.answers),$scope.recalc_price(),$scope.$emit("item_details:loaded",$scope.item_details)),loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})};var setItemDetails=function(details){if($scope.item&&$scope.item.defaults&&_.each(details.questions,function(item){var n="q_"+item.name;if($scope.item.defaults[n])return item.answer=$scope.item.defaults[n]}),$scope.hasOwnProperty("item_details")){var oldQuestions=$scope.item_details.questions;_.each(details.questions,function(item){var search=_.findWhere(oldQuestions,{name:item.name});if(search)return item.answer=search.answer})}return $scope.item_details=details};return $scope.$on("currentItemUpdate",function(event){return $scope.item_from_param?$scope.loadItem($scope.item_from_param):$scope.loadItem($scope.bb.current_item)}),$scope.recalc_price=function(){var qprice=$scope.item_details.questionPrice($scope.item.getQty()),bprice=$scope.item.base_price;return bprice||(bprice=$scope.item.price),$scope.item.setPrice(qprice+bprice),$scope.item.setAskedQuestions()},$scope.confirm=function(form,route){if(ValidatorService.validateForm(form))return $scope.bb.moving_booking?$scope.confirm_move(form,route):($scope.item.setAskedQuestions(),!!$scope.$parent.$has_page_control||($scope.item.ready?(loader.notLoaded(),$scope.addItemToBasket().then(function(){return loader.setLoaded(),$scope.decideNextPage(route)},function(err){return loader.setLoaded()})):$scope.decideNextPage(route)))},$scope.setReady=function(){return $scope.item.setAskedQuestions(),!($scope.item.ready&&!$scope.suppress_basket_update)||$scope.addItemToBasket()},$scope.confirm_move=function(route){if(confirming=!0,$scope.item||($scope.item=$scope.bb.current_item),$scope.item.moved_booking=!1,$scope.item.setAskedQuestions(),$scope.item.ready){if(loader.notLoaded(),$scope.bb.moving_purchase){var params={purchase:$scope.bb.moving_purchase,bookings:$scope.bb.basket.items};return $scope.bb.current_item.move_reason&&(params.move_reason=$scope.bb.current_item.move_reason),PurchaseService.update(params).then(function(purchase){return $scope.bb.purchase=purchase,$scope.bb.purchase.$getBookings().then(function(bookings){return $scope.purchase=purchase,loader.setLoaded(),$scope.item.move_done=!0,$scope.item.moved_booking=!0,$rootScope.$broadcast("booking:moved"),$scope.decideNextPage(route),$scope.showMoveMessage(bookings[0].datetime)})},function(err){return loader.setLoaded(),AlertService.add("danger",{msg:$translate.instant("PUBLIC_BOOKING.ITEM_DETAILS.MOVE_BOOKING_FAIL_ALERT")})})}return $scope.bb.current_item.move_reason&&($scope.item.move_reason=$scope.bb.current_item.move_reason),PurchaseBookingService.update($scope.item).then(function(booking){var b=new BBModel.Purchase.Booking(booking);if($scope.bb.purchase)for(var _i=0;_i<$scope.bb.purchase.bookings.length;_i++){var oldb=$scope.bb.purchase.bookings[_i];oldb.id===b.id&&($scope.bb.purchase.bookings[_i]=b)}return loader.setLoaded(),$scope.bb.moved_booking=booking,$scope.item.move_done=!0,$rootScope.$broadcast("booking:moved"),$scope.decideNextPage(route),$scope.showMoveMessage(b.datetime)},function(err){return loader.setLoaded(),AlertService.add("danger",{msg:$translate.instant("PUBLIC_BOOKING.ITEM_DETAILS.MOVE_BOOKING_FAIL_ALERT")})})}return $scope.decideNextPage(route)},$scope.showMoveMessage=function(datetime){datetime=bbTimeZone.convertToDisplay(datetime),AlertService.add("info",{msg:$translate.instant("PUBLIC_BOOKING.ITEM_DETAILS.MOVE_BOOKING_SUCCESS_ALERT",{datetime:datetime})})},$scope.openTermsAndConditions=function(){return $uibModal.open({templateUrl:$scope.getPartial("terms_and_conditions"),scope:$scope})},$scope.getQuestion=function(id){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.item_details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var question=_step.value;if(question.id===id)return question}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return null},$scope.updateItem=function(){if($scope.item.setAskedQuestions(),$scope.item.ready)return loader.notLoaded(),PurchaseBookingService.update($scope.item).then(function(booking){var b=new BBModel.Purchase.Booking(booking);if($scope.bookings)for(var _i=0;_i<$scope.bookings.length;_i++){var oldb=$scope.bookings[_i];oldb.id===b.id&&($scope.bookings[_i]=b)}return $scope.purchase.bookings=$scope.bookings,$scope.item_details_updated=!0,loader.setLoaded()},function(err){return loader.setLoaded()})},$scope.editItem=function(){return $scope.item_details_updated=!1}}angular.module("BB.Controllers").controller("ItemDetails",itemDetailsController)}(),angular.module("BB.Directives").directive("bbItemDetails",function($q,$templateCache,$compile){return{restrict:"AE",replace:!0,scope:!0,transclude:!0,controller:"ItemDetails",link:function(scope,element,attrs,controller,transclude){if(attrs.bbItemDetails){var item=scope.$eval(attrs.bbItemDetails);scope.item_from_param=item,scope.item_details&&delete scope.item_details,item&&scope.loadItem(item)}return transclude(scope,function(clone){return clone.length>1||1===clone.length&&(!clone[0].wholeText||/\S/.test(clone[0].wholeText))?element.html(clone).show():$q.when($templateCache.get("_item_details.html")).then(function(template){return element.html(template).show(),$compile(element.contents())(scope)})})}}}),angular.module("BB.Controllers").controller("Login",function($scope,$rootScope,$q,$location,LoginService,ValidatorService,AlertService,LoadingService,BBModel){console.warn("Deprecation warning: validator.validateForm() will be removed from bbLogin in an upcoming major release, please update your template to use bbForm and submitForm() instead. See https://github.com/bookingbug/bookingbug-angular/issues/638"),$scope.validator=ValidatorService,$scope.login_form={};var loader=LoadingService.$loader($scope);return $scope.login_sso=function(token,route){return $rootScope.connection_started.then(function(){return LoginService.ssoLogin({company_id:$scope.bb.company.id,root:$scope.bb.api_url},{token:token}).then(function(member){if(route)return $scope.showPage(route)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.login_with_password=function(email,password){return LoginService.companyLogin($scope.bb.company,{},{email:email,password:password}).then(function(member){return $scope.member=new BBModel.Member.Member(member)},function(err){return AlertService.raise("LOGIN_FAILED")})},$scope.showEmailPasswordReset=function(){return $scope.showPage("email_reset_password")},$scope.isLoggedIn=function(){return LoginService.isLoggedIn()},$scope.sendPasswordReset=function(email){return LoginService.sendPasswordReset($scope.bb.company,{email:email,custom:!0}).then(function(){return AlertService.raise("PASSWORD_RESET_REQ_SUCCESS")},function(err){return AlertService.raise("PASSWORD_RESET_REQ_FAILED")})},$scope.updatePassword=function(new_password,confirm_new_password){return AlertService.clear(),$rootScope.member&&new_password&&confirm_new_password&&new_password===confirm_new_password?LoginService.updatePassword($rootScope.member,{new_password:new_password,confirm_new_password:confirm_new_password,persist_login:$scope.login_form.persist_login}).then(function(member){if(member)return $scope.setClient(member),$scope.password_updated=!0,AlertService.raise("PASSWORD_RESET_SUCESS")},function(err){return $scope.error=err,AlertService.raise("PASSWORD_RESET_FAILED")}):AlertService.raise("PASSWORD_MISMATCH")}}),angular.module("BB.Directives").directive("bbLogin",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Login"}}),function(angular){function MapCtrl($scope,$attrs,$rootScope,AlertService,FormDataStoreService,LoadingService,$q,$window,$timeout,ErrorService,$log,GeolocationService,GeneralOptions,bbAnalyticsPiwik,bbWidgetInit){function setPiwik(title){bbAnalyticsPiwik.push(["trackEvent",["Map"],title])}$scope.layout={};var layout="default"===GeneralOptions.map_layout?"default":GeneralOptions.map_layout;$scope.layout[layout]=!0;var isSecureContext=window.isSecureContext;if(void 0===isSecureContext){isSecureContext=/^https:\/\//.test(window.location!==window.parent.location?document.referrer:document.location.href)}$scope.geolocation_enabled=isSecureContext,FormDataStoreService.init("MapCtrl",$scope,["address","selectedStore","search_prms"]),$scope.options=$scope.$eval($attrs.bbMap)||{},$scope.no_route=$scope.options.no_route||!1,$scope.num_search_results=$scope.options.num_search_results||6,$scope.range_limit=$scope.options.range_limit||1/0,$scope.hide_not_live_stores=$scope.options.hide_not_live_stores||!1,$scope.can_filter_by_service=$scope.options.filter_by_service||!1,$scope.filter_by_service=$scope.options.filter_by_service||!1,$scope.default_zoom=$scope.options.default_zoom||6;var defaultPin=GeneralOptions.map_marker_icon,activePin=GeneralOptions.mapActiveMarkerIcon,pinHasLabel=GeneralOptions.mapMarkerHasLabel;$scope.loadMapOnGeolocate=!0;var map_ready_def=$q.defer();$scope.mapLoaded=$q.defer(),$scope.mapReady=map_ready_def.promise,$scope.map_init=$scope.mapLoaded.promise,$scope.showAllMarkers=!1,$scope.mapMarkers=[],$scope.shownMarkers=$scope.shownMarkers||[],$scope.numberedPin||($scope.numberedPin=null),!$scope.address&&$attrs.bbAddress&&($scope.address=$scope.$eval($attrs.bbAddress));var loader=LoadingService.$loader($scope);webshim.setOptions({waitReady:!1,loadStyles:!1}),webshim.polyfill("geolocation"),$rootScope.connection_started.then(function(){return $scope.initialise()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.initialise=function(){if($scope.mapMarkers=[],$scope.shownMarkers=$scope.shownMarkers||[],$scope.selectedStore||loader.setLoaded(),!$scope.bb.company.companies)return $rootScope.parent_id?void bbWidgetInit.initWidget({company_id:$rootScope.parent_id,first_page:$scope.bb.current_page,keep_basket:!0,item_defaults:$scope.bb.item_defaults?$scope.bb.item_defaults:{}}):void bbWidgetInit.initWidget({company_id:$scope.bb.company.id,first_page:null});$rootScope.parent_id=$scope.bb.company.id,$scope.companies=$scope.bb.company.companies,$scope.companies&&0!==$scope.companies.length||($scope.companies=[$scope.bb.company]),$scope.bb.current_item.service&&$scope.options&&$scope.options.filter_by_service?(loader.notLoaded($scope),$scope.filterByServicePromise().then(function(){return $scope.map_init.then(function(){return mapInit()})})):$scope.map_init.then(function(){return mapInit()}),$scope.mapBounds=new google.maps.LatLngBounds;var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.companies)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var comp=_step.value;if(comp.address&&comp.address.lat&&comp.address.long){var latlong=new google.maps.LatLng(comp.address.lat,comp.address.long);$scope.mapBounds.extend(latlong)}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}if($scope.mapOptions={center:$scope.mapBounds.getCenter(),zoom:$scope.default_zoom,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,mapTypeControlOptions:{style:window.google.maps.MapTypeControlStyle.DROPDOWN_MENU}},$scope.options&&$scope.options.map_options)for(var key in $scope.options.map_options){var value=$scope.options.map_options[key];$scope.mapOptions[key]=value}return map_ready_def.resolve(!0)},$scope.filterByServicePromise=function(){var deferred=$q.defer();return $scope.bb.selected_service.$has("all_children")?$scope.bb.selected_service.$get("all_children").then(function(resource){return resource.$get("services").then(function(services){var service=void 0,company_ids=_.map(services,function(service){return service.company_id});return Array.from($scope.companies).map(function(company){return company.has_service=_.contains(company_ids,company.id),service=_.find(services,function(service){return service.company_id===company.id}),company.service=service,deferred.resolve()})})}):deferred.resolve(),deferred.promise},$scope.filterByService=function(){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.shownMarkers)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){_step2.value.setMap(null)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return $scope.options&&$scope.filter_by_service?$scope.shownMarkers=$scope.shown_markers_with_services:$scope.shownMarkers=$scope.shown_markers,$timeout(function(){return setMarkers()})};var mapInit=function(){return Array.from($scope.companies).map(function(comp,index){if(comp.address&&comp.address.lat&&comp.address.long){var latlong=new google.maps.LatLng(comp.address.lat,comp.address.long),marker=new google.maps.Marker({map:$scope.myMap,position:latlong,visible:$scope.showAllMarkers,icon:defaultPin});pinHasLabel&&marker.setLabel((index+1).toString()),marker.company=comp,$scope.hide_not_live_stores&&!comp.live||$scope.mapMarkers.push(marker)}}),$timeout(function(){if($scope.myMap.fitBounds($scope.mapBounds),$scope.options.default_zoom&&$scope.myMap.setZoom($scope.default_zoom),$scope.bb.current_item.service&&$scope.options&&$scope.filter_by_service)return loader.setLoaded()}),checkDataStore()},loadMap=function(){$scope.myMap.setCenter($scope.loc),$scope.options.default_zoom&&$scope.myMap.setZoom($scope.default_zoom),$scope.showClosestMarkers($scope.loc)},checkDataStore=function(){if($scope.selectedStore)return loader.notLoaded(),$scope.search_prms?$scope.searchAddress($scope.search_prms):$scope.geolocate(),google.maps.event.addListenerOnce($scope.myMap,"idle",function(){return _.each($scope.mapMarkers,function(marker){if($scope.selectedStore.id===marker.company.id)return google.maps.event.trigger(marker,"click")})})};$scope.title=function(){var ci=$scope.bb.current_item;return(ci.category&&ci.category.description?ci.category.description:$scope.bb.company.extra.department)+" - "+$scope.$eval("getCurrentStepTitle()")},$scope.searchAddress=function(){var prms=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return bbAnalyticsPiwik.isEnabled()&&setPiwik("Search"),(!$scope.loadMapOnGeolocate||!$scope.reverse_geocode_address||$scope.reverse_geocode_address!==$scope.address)&&(angular.isDefined(prms.address)&&($scope.address=prms.address),$scope.loadMapOnGeolocate&&(!$scope.address||angular.isString($scope.address)&&!$scope.address.trim())?(AlertService.clear(),AlertService.raise("MISSING_LOCATION"),!1):(void 0===$scope.address||""!==$scope.address.trim())&&(loader.notLoaded(),$scope.loadMapOnGeolocate=!0,delete $scope.geocoder_result,$scope.search_prms=prms,void $scope.map_init.then(function(){var address=$scope.address;if(prms.address&&(address=prms.address),address){var req={address:address};if(prms.region&&(req.region=prms.region),prms.componentRestrictions&&(req.componentRestrictions=prms.componentRestrictions),prms.bounds){var sw=new google.maps.LatLng(prms.bounds.sw.x,prms.bounds.sw.y),ne=new google.maps.LatLng(prms.bounds.ne.x,prms.bounds.ne.y);req.bounds=new google.maps.LatLngBounds(sw,ne)}return(new google.maps.Geocoder).geocode(req,function(results,status){results.length>0&&"OK"===status&&($scope.geocoder_result=results[0]),!$scope.geocoder_result||$scope.geocoder_result&&$scope.geocoder_result.partial_match?searchPlaces(req):$scope.geocoder_result?searchSuccess($scope.geocoder_result):searchFailed(),loader.setLoaded()})}})))};var searchPlaces=function(prms){var req={query:prms.address,types:["shopping_mall","store","embassy"]};return prms.bounds&&(req.bounds=prms.bounds),new google.maps.places.PlacesService($scope.myMap).textSearch(req,function(results,status){results.length>0&&"OK"===status?searchSuccess(results[0]):$scope.geocoder_result?searchSuccess($scope.geocoder_result):searchFailed()})},searchSuccess=function(result){return AlertService.clear(),$scope.search_failed=!1,$scope.loc=result.geometry.location,$scope.formatted_address=result.formatted_address,$scope.loadMapOnGeolocate&&loadMap(),$rootScope.$broadcast("map:search_success")},searchFailed=function(){return $scope.search_failed=!0,AlertService.raise("LOCATION_NOT_FOUND"),$rootScope.$apply()};$scope.validateAddress=function(form){return!!form&&(!form.$error.required||(AlertService.clear(),AlertService.raise("MISSING_LOCATION"),!1))},$scope.showClosestMarkers=function(centre){var distances=[],distances_with_services=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.mapMarkers)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var marker=_step3.value,map_centre={lat:centre.lat(),long:centre.lng()},marker_position={lat:marker.position.lat(),long:marker.position.lng()};marker.distance=GeolocationService.haversine(map_centre,marker_position),$scope.showAllMarkers||marker.setVisible(!1),marker.distance<$scope.range_limit&&(distances.push(marker),marker.company.has_service&&distances_with_services.push(marker))}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}distances.sort(function(a,b){return a.distance-b.distance}),distances_with_services.sort(function(a,b){return a.distance-b.distance}),$scope.setShownMarkers(distances,distances_with_services),0!=$scope.shownMarkers.length&&$timeout(function(){return setMarkers()})},$scope.setShownMarkers=function(distances,distances_with_services){$scope.shown_markers=distances.slice(0,$scope.num_search_results),$scope.shown_markers_with_services=distances_with_services.slice(0,$scope.num_search_results),$scope.options&&$scope.filter_by_service&&0!=$scope.shown_markers_with_services.length?$scope.shownMarkers=$scope.shown_markers_with_services:$scope.shownMarkers=$scope.shown_markers};var setMarkers=function(){var latlong=$scope.loc,localBounds=new google.maps.LatLngBounds;localBounds.extend(latlong);var index=1,_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from($scope.shownMarkers)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var marker=_step4.value;if($scope.numberedPin){var iconPath=$window.sprintf($scope.numberedPin,index);marker.setIcon(iconPath)}marker.setVisible(!0),marker.setMap($scope.myMap),localBounds.extend(marker.position),index+=1}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return $scope.$emit("map:shown_markers_updated",$scope.shownMarkers),google.maps.event.trigger($scope.myMap,"resize"),$scope.myMap.fitBounds(localBounds),openDefaultMarker()},openDefaultMarker=function(){if(!$scope.options||!$scope.options.no_default_location_details){var open_marker_index=0;return _.find($scope.shownMarkers,function(obj){return open_marker_index++,obj.company.id===$scope.bb.current_item.company.id})?open_marker_index--:open_marker_index=0,$scope.shownMarkers[open_marker_index].is_open=!0,$scope.openMarkerInfo($scope.shownMarkers[open_marker_index])}};$scope.openMarkerInfo=function(marker){return $timeout(function(){$scope.currentMarker=marker,$scope.myMap.setCenter(marker.position),$scope.myInfoWindow.open($scope.myMap,marker);var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from($scope.shownMarkers)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var shown_marker=_step5.value;shown_marker.setIcon(defaultPin),shown_marker.company.id===marker.company.id&&(activePin&&shown_marker.setIcon(activePin),shown_marker.is_open=!0)}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return $scope.shownMarkers},250)},$scope.selectItem=function(){var company=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$scope.currentMarker.company,route=arguments[1];if($scope.$debounce(1e3)){if(!company)return void AlertService.warning(ErrorService.getError("STORE_NOT_SELECTED"));if(!company.id)return AlertService.warning(ErrorService.getError("STORE_NOT_SELECTED")),void $log.warn("valid company object not found");loader.notLoaded(),$scope.selectedStore&&$scope.selectedStore.id!==company.id&&$scope.$emit("change:storeLocation"),$scope.selectedStore=company,$scope.bb.current_item.item_details&&$scope.bb.current_item.item_details.questions&&setAnswers(),company.service&&($scope.bb.item_defaults.service=company.service.id)
;var init_obj={company_id:company.id,item_defaults:$scope.bb.item_defaults,no_route:$scope.options.no_route};return route&&(init_obj.first_page=route),loader.setLoaded(),$scope.initWidget(init_obj)}};var setAnswers=function(){var answers={},_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from($scope.bb.current_item.item_details.questions)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var q=_step6.value;answers["q_"+q.name]=q.answer}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}if(!_.isEmpty(answers))return $scope.bb.item_defaults.answers=answers};$scope.roundNumberUp=function(num,places){return Math.round(num*Math.pow(10,places))/Math.pow(10,places)},$scope.geolocate=function(){var loadMapOnGeolocate=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return bbAnalyticsPiwik.isEnabled()&&setPiwik("Geolocate"),!(!navigator.geolocation||$scope.reverse_geocode_address&&$scope.reverse_geocode_address===$scope.address)&&($scope.loadMapOnGeolocate=loadMapOnGeolocate,loader.notLoaded(),webshim.ready("geolocation",function(){var options={timeout:5e3,maximumAge:36e5};return navigator.geolocation.getCurrentPosition(reverseGeocode,geolocateFail,options)}))};var geolocateFail=function(error){switch(error.code){case 2:case 3:loader.setLoaded(),AlertService.raise("GEOLOCATION_ERROR");break;default:loader.setLoaded()}return $scope.$apply()},reverseGeocode=function(position){var lat=parseFloat(position.coords.latitude),long=parseFloat(position.coords.longitude),latlng=new google.maps.LatLng(lat,long);return(new google.maps.Geocoder).geocode({latLng:latlng},function(results,status){if(results.length>0&&"OK"===status){$scope.geocoder_result=results[0];var _iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _step7,_iterator7=Array.from($scope.geocoder_result.address_components)[Symbol.iterator]();!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var ac=_step7.value;ac.types.indexOf("route")>=0&&($scope.reverse_geocode_address=ac.long_name),ac.types.indexOf("locality")>=0&&($scope.reverse_geocode_address+=", "+ac.long_name),$scope.address=$scope.reverse_geocode_address}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}searchSuccess($scope.geocoder_result)}return $timeout(function(){return loader.setLoaded()})})};return $scope.increaseRange=function(){return $scope.range_limit=1/0,$scope.searchAddress($scope.search_prms)},$scope.$watch("display.xs",function(new_value,old_value){if(new_value!==old_value&&$scope.loc)return $scope.myInfoWindow.close(),void loadMap()}),$rootScope.$on("widget:restart",function(){return $scope.loc=null,$scope.reverse_geocode_address=null,$scope.address=null})}angular.module("BB.Controllers").controller("MapCtrl",MapCtrl)}(angular),angular.module("BB.Directives").directive("bbMap",function(){return{restrict:"A",replace:!0,scope:!0,controller:"MapCtrl"}}),angular.module("BB.Controllers").controller("MemberLogin",function($scope,$log,$rootScope,$templateCache,$q,halClient,BBModel,$sessionStorage,$window,AlertService,ValidatorService,LoadingService){$scope.login={},console.warn("Deprecation warning: validator.validateForm() will be removed from bbMemberLogin in an upcoming major release, please update your template to use bbForm and submitForm() instead. See https://github.com/bookingbug/bookingbug-angular/issues/638"),$scope.validator=ValidatorService;var loader=LoadingService.$loader($scope).notLoaded();return $rootScope.connection_started.then(function(){return BBModel.Login.$checkLogin()?($scope.setClient($rootScope.member),$scope.bb.destination?$scope.redirectTo($scope.bb.destination):(loader.setLoaded(),$scope.skipThisStep(),$scope.decideNextPage())):halClient.$get($scope.bb.api_url+"/api/v1").then(function(root){return root.$get("new_login").then(function(new_login){return $scope.form=new_login.form,$scope.schema=new_login.schema,loader.setLoaded()},function(err){return console.log("err ",err)})},function(err){return console.log("err ",err)})}),$scope.submit=function(){return $scope.login.role="member",$scope.bb.company.$post("login",{},$scope.login).then(function(login){return login.$has("members")?login.$get("members").then(function(members){return $scope.handleLogin(members[0])}):login.$has("member")?login.$get("member").then(function(member){return $scope.handleLogin(member)}):void 0},function(err){return"Account has been disabled"===err.data.error?AlertService.raise("ACCOUNT_DISABLED"):AlertService.raise("LOGIN_FAILED")})},$scope.handleLogin=function(member){return member=BBModel.Login.$setLogin(member,$scope.login.persist_login),$scope.setClient(member),$scope.bb.destination?$scope.redirectTo($scope.bb.destination):($scope.skipThisStep(),$scope.decideNextPage())}}),angular.module("BB").directive("bbMemberLogin",function(PathSvc){return{restrict:"A",controller:"MemberLogin",templateUrl:function(elem,attrs){return null!=attrs.bbCustomLoginForm?PathSvc.directivePartial("_member_login_form"):PathSvc.directivePartial("_member_login_schema_form")}}}),angular.module("BB.Directives").directive("bbMembershipLevels",function($rootScope,BBModel){return{restrict:"AE",replace:!0,scope:!0,controller:function($scope,$element,$attrs,LoadingService){var loader=LoadingService.$loader($scope);return $rootScope.connection_started.then(function(){return $scope.initialise()}),$scope.initialise=function(){if($scope.bb.company&&$scope.bb.company.$has("member_levels"))return loader.notLoaded(),BBModel.MembershipLevels.$getMembershipLevels($scope.bb.company).then(function(member_levels){return loader.setLoaded(),$scope.membership_levels=member_levels},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.selectMemberLevel=function(level){if(level&&$scope.client)return $scope.client.member_level_id=level.id,$scope.$parent.$has_page_control?void 0:$scope.decideNextPage()},$scope.setReady=function(){return!!$scope.client.member_level_id},$scope.getMembershipLevel=function(member_level_id){return _.find($scope.membership_levels,function(level){return level.id===member_level_id})}}}}),angular.module("BB.Controllers").controller("DayListMa",function($scope,$rootScope,$q,AlertService,LoadingService,BBModel){var date=void 0,day=void 0,edate=void 0,loader=LoadingService.$loader($scope).notLoaded();return $scope.WeekHeaders=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],$scope.day_data={},$scope.type||($scope.type="month"),$scope.data_source||($scope.data_source=$scope.bb.current_item),$rootScope.connection_started.then(function(){return!$scope.current_date&&$scope.last_selected_date?$scope.current_date=$scope.last_selected_date.startOf($scope.type):$scope.current_date||($scope.current_date=moment().startOf($scope.type)),$scope.loadData()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.$on("currentItemUpdate",function(event){return $scope.loadData()}),$scope.setCalType=function(type){return $scope.type=type},$scope.setDataSource=function(source){return $scope.data_source=source},$scope.format_date=function(fmt){if($scope.current_date)return $scope.current_date.format(fmt)},$scope.format_start_date=function(fmt){return $scope.format_date(fmt)},$scope.format_end_date=function(fmt){if($scope.end_date)return $scope.end_date.format(fmt)},$scope.selectDay=function(day,route,force){return!(0===day.spaces&&!force)&&($scope.setLastSelectedDate(day.date),$scope.bb.current_item.setDate(day),$scope.$parent.$has_page_control?void 0:$scope.decideNextPage(route))},$scope.setMonth=function(month,year){return $scope.current_date=moment().startOf("month").year(year).month(month-1),$scope.current_date.year(),$scope.type="month"},$scope.setWeek=function(week,year){return $scope.current_date=moment().year(year).isoWeek(week).startOf("week"),$scope.current_date.year(),$scope.type="week"},$scope.add=function(type,amount){return $scope.current_date.add(amount,type),$scope.loadData()},$scope.subtract=function(type,amount){return $scope.add(type,-amount)},$scope.isPast=function(){return!$scope.current_date||moment().isAfter($scope.current_date)},$scope.loadData=function(){return"week"===$scope.type?$scope.loadWeek():$scope.loadMonth()},$scope.loadMonth=function(){return date=$scope.current_date,$scope.month=date.month(),loader.notLoaded(),edate=moment(date).add(1,"months"),$scope.end_date=moment(edate).add(-1,"days"),$scope.data_source?BBModel.Day.$query({company:$scope.bb.company,cItem:$scope.data_source,month:date.format("MMYY"),client:$scope.client}).then(function(days){$scope.days=days;var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(days)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)day=_step.value,$scope.day_data[day.string_date]=day}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}for(var weeks=[],w=0;w<=5;w++){for(var week=[],d=0;d<=6;d++)week.push(days[7*w+d]);weeks.push(week)}return $scope.weeks=weeks,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):loader.setLoaded()},$scope.loadWeek=function(){return date=$scope.current_date,loader.notLoaded(),edate=moment(date).add(7,"days"),$scope.end_date=moment(edate).add(-1,"days"),$scope.data_source?BBModel.Day.$query({company:$scope.bb.company,cItem:$scope.data_source,date:date.toISODate(),edate:edate.toISODate(),client:$scope.client}).then(function(days){$scope.days=days;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(days)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)day=_step2.value,$scope.day_data[day.string_date]=day}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):loader.setLoaded()},$scope.setReady=function(){return!!$scope.bb.current_item.date||(AlertService.clear(),AlertService.add("danger",{msg:"You need to select a date"}),!1)}}),angular.module("BB.Directives").directive("bbMonthAvailability",function(){return{restrict:"A",replace:!0,scope:!0,controller:"DayListMa"}}),angular.module("BB.Controllers").controller("MonthCalendar",function($scope,$rootScope,$q,AlertService,LoadingService,BBModel,$translate){var date=void 0,day=void 0,edate=void 0,loader=LoadingService.$loader($scope).notLoaded();return $scope.WeekHeaders=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],$scope.day_data={},$scope.type||($scope.type="month"),$scope.data_source||($scope.data_source=$scope.bb.current_item),$rootScope.connection_started.then(function(){return!$scope.current_date&&$scope.last_selected_date?$scope.current_date=$scope.last_selected_date.startOf($scope.type):$scope.current_date||($scope.current_date=moment().startOf($scope.type)),$scope.loadData()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.$on("currentItemUpdate",function(event){return $scope.loadData()}),$scope.setCalType=function(type){return $scope.type=type},$scope.setDataSource=function(source){return $scope.data_source=source},$scope.format_date=function(fmt){if($scope.current_date)return $scope.current_date.format(fmt)},$scope.format_start_date=function(fmt){return $scope.format_date(fmt)},$scope.format_end_date=function(fmt){if($scope.end_date)return $scope.end_date.format(fmt)},$scope.selectDay=function(day,route,force){return!(0===day.spaces&&!force)&&($scope.setLastSelectedDate(day.date),$scope.bb.current_item.setDate(day),$scope.$parent.$has_page_control?void 0:$scope.decideNextPage(route))},$scope.setMonth=function(month,year){return $scope.current_date=moment().startOf("month").year(year).month(month-1),$scope.current_date.year(),$scope.type="month"},$scope.setWeek=function(week,year){return $scope.current_date=moment().year(year).isoWeek(week).startOf("week"),$scope.current_date.year(),$scope.type="week"},$scope.add=function(type,amount){return $scope.current_date.add(amount,type),$scope.loadData()},$scope.subtract=function(type,amount){return $scope.add(type,-amount)},$scope.isPast=function(){return!$scope.current_date||moment().isAfter($scope.current_date)},$scope.loadData=function(){return"week"===$scope.type?$scope.loadWeek():$scope.loadMonth()},$scope.loadMonth=function(){return date=$scope.current_date,$scope.month=date.month(),loader.notLoaded(),edate=moment(date).add(1,"months"),$scope.end_date=moment(edate).add(-1,"days"),$scope.data_source?BBModel.Day.$query({company:$scope.bb.company,cItem:$scope.data_source,month:date.format("MMYY"),client:$scope.client}).then(function(days){$scope.days=days;var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(days)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)day=_step.value,$scope.day_data[day.string_date]=day}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}for(var weeks=[],w=0;w<=5;w++){for(var week=[],d=0;d<=6;d++)week.push(days[7*w+d]);weeks.push(week)}return $scope.weeks=weeks,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):loader.setLoaded()},$scope.loadWeek=function(){return date=$scope.current_date,loader.notLoaded(),edate=moment(date).add(7,"days"),$scope.end_date=moment(edate).add(-1,"days"),$scope.data_source?BBModel.Day.$query({company:$scope.bb.company,cItem:$scope.data_source,date:date.toISODate(),edate:edate.toISODate(),client:$scope.client}).then(function(days){$scope.days=days;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(days)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)day=_step2.value,$scope.day_data[day.string_date]=day}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}):loader.setLoaded()},$scope.setReady=function(){return!!$scope.bb.current_item.date||(AlertService.clear(),AlertService.add("danger",{msg:$translate.instant("PUBLIC_BOOKING.DAY.DATE_NOT_SELECTED")}),!1)}}),angular.module("BB.Directives").directive("bbMonthCalendar",function(){return{restrict:"A",replace:!0,scope:!0,controller:"MonthCalendar"}}),angular.module("BB.Controllers").controller("MultiServiceSelect",function($scope,$rootScope,$q,$attrs,BBModel,$uibModal,$document,AlertService,FormDataStoreService,LoadingService){FormDataStoreService.init("MultiServiceSelect",$scope,["selected_category_name"]),$scope.options=$scope.$eval($attrs.bbMultiServiceSelect)||{},$scope.options.max_services=$scope.options.max_services||1/0,$scope.options.ordered_categories=$scope.options.ordered_categories||!1,$scope.options.services=$scope.options.services||"items";var loader=LoadingService.$loader($scope);$rootScope.connection_started.then(function(){return $scope.bb.company.$has("parent")&&!$scope.bb.company.$has("company_questions")?$scope.bb.company.$getParent().then(function(parent){return $scope.company=parent,initialise()}):$scope.company=$scope.bb.company,$scope.$watch($scope.options.services,function(newval,oldval){if(newval&&angular.isArray(newval))return $scope.items=newval,initialise()})});var initialise=function(){if($scope.items&&$scope.company){$scope.initialised=!0;var promises=[];return promises.push(BBModel.Category.$query($scope.bb.company)),$scope.company.$has("company_questions")&&promises.push($scope.company.$getCompanyQuestions()),$q.all(promises).then(function(result){if($scope.company_questions=result[1],initialiseCategories(result[0]),$scope.bb.stacked_items&&$scope.bb.stacked_items.length>0){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.bb.stacked_items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var stacked_item=_step.value,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var item=_step2.value;if(item.self===stacked_item.service.self){stacked_item.service=item,stacked_item.service.selected=!0;break}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}else checkItemDefaults();return $scope.bb.moving_booking&&$scope.nextStep(),$scope.$broadcast("multi_service_select:loaded"),loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})}},checkItemDefaults=function(){if($scope.bb.item_defaults.service){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var service=_step3.value;if(service.self===$scope.bb.item_defaults.service.self)return void $scope.addItem(service)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}},initialiseCategories=function(categories){var category=void 0;if($scope.options.ordered_categories){var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(categories)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)category=_step4.value,category.order=parseInt(category.name.slice(0,2)),category.name=category.name.slice(3)}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}$scope.all_categories=_.indexBy(categories,"id");var all_categories=_.groupBy($scope.items,function(item){return item.category_id}),sub_categories=_.findWhere($scope.company_questions,{name:"Extra Category"});sub_categories&&(sub_categories=_.map(sub_categories.question_items,function(sub_category){return sub_category.name})),categories={};var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Object.keys(all_categories||{})[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var key=_step5.value,value=all_categories[key];value.length>0&&(categories[key]=value)}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return $scope.categories=[],function(){var result=[];for(var category_id in categories){var category_details,services=categories[category_id],item=void 0;category={};var grouped_sub_categories=[];if(sub_categories){var _iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(sub_categories)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var sub_category=_step6.value,grouped_sub_category={name:sub_category,services:_.filter(services,function(service){return service.extra.extra_category===sub_category})};grouped_sub_category.services.length>0&&grouped_sub_categories.push(grouped_sub_category)}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}category.sub_categories=grouped_sub_categories}else category.services=services;$scope.all_categories[category_id]&&(category_details={name:$scope.all_categories[category_id].name,description:$scope.all_categories[category_id].description}),category.name=category_details.name,category.description=category_details.description,$scope.options.ordered_categories&&$scope.all_categories[category_id]&&(category.order=$scope.all_categories[category_id].order),$scope.categories.push(category),$scope.selected_category_name&&$scope.selected_category_name===category_details.name?item=$scope.selected_category=$scope.categories[$scope.categories.length-1]:$scope.bb.item_defaults.category&&$scope.bb.item_defaults.category.name===category_details.name&&!$scope.selected_category&&($scope.selected_category=$scope.categories[$scope.categories.length-1],item=$scope.selected_category_name=$scope.selected_category.name),result.push(item)}return result}()};return $scope.changeCategory=function(category_name,services){if(category_name&&services)return $scope.selected_category={name:category_name,sub_categories:services},$scope.selected_category_name=$scope.selected_category.name,$rootScope.$broadcast("multi_service_select:category_changed")},$scope.changeCategoryName=function(){return $scope.selected_category_name=$scope.selected_category.name,$rootScope.$broadcast("multi_service_select:category_changed")},$scope.addItem=function(item,duration){if(!($scope.bb.stacked_items.length<$scope.options.max_services))return Array.from($scope.items).map(function(i){return i.popover="Sorry, you can only book a maximum of "+$scope.options.max_services+" treatments",i.popoverText=i.popover});$scope.bb.clearStackedItemsDateTime(),item.selected=!0;var iitem=new BBModel.BasketItem(null,$scope.bb);return iitem.setDefaults($scope.bb.item_defaults),iitem.setService(item),duration&&iitem.setDuration(duration),iitem.setGroup(item.group),$scope.bb.stackItem(iitem),$rootScope.$broadcast("multi_service_select:item_added"),$scope.options.raise_alerts?AlertService.info({msg:item.name+" added to your treatment selection",persist:!1}):void 0},$scope.removeItem=function(item,options){return item.selected=!1,options&&"BasketItem"===options.type?$scope.bb.deleteStackedItem(item):$scope.bb.deleteStackedItemByService(item),$scope.bb.clearStackedItemsDateTime(),$rootScope.$broadcast("multi_service_select:item_removed"),function(){var result=[],_iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _step7,_iterator7=Array.from($scope.items)[Symbol.iterator]();!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var i=_step7.value;if(i.self===item.self){i.selected=!1;break}result.push(void 0)}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}return result}()},$scope.removeStackedItem=function(item){return $scope.removeItem(item,{type:"BasketItem"})},$scope.nextStep=function(){return $scope.bb.stacked_items.length>1?$scope.decideNextPage():1===$scope.bb.stacked_items.length?($scope.bb.basket&&$scope.bb.basket.items.length>0&&$scope.quickEmptybasket({preserve_stacked_items:!0}),$scope.setBasketItem($scope.bb.stacked_items[0]),$scope.decideNextPage()):(AlertService.clear(),AlertService.add("danger",{msg:"You need to select at least one treatment to continue"}))},$scope.addService=function(){return $rootScope.$broadcast("multi_service_select:add_item")},$scope.setReady=function(){return $scope.bb.stacked_items.length>1||(1===$scope.bb.stacked_items.length?($scope.bb.basket&&$scope.bb.basket.items.length>0&&$scope.quickEmptybasket({preserve_stacked_items:!0}),$scope.setBasketItem($scope.bb.stacked_items[0]),!0):(AlertService.clear(),AlertService.add("danger",{msg:"You need to select at least one treatment to continue"}),!1))},$scope.selectDuration=function(_service){return 1===_service.durations.length?$scope.addItem(_service):$uibModal.open({templateUrl:$scope.getPartial("_select_duration_modal"),scope:$scope,controller:function($scope,$uibModalInstance,service){return $scope.durations=service.durations,$scope.duration=$scope.durations[0],$scope.service=service,$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")},$scope.setDuration=function(){return $uibModalInstance.close({service:$scope.service,duration:$scope.duration})}},resolve:{service:function(){return _service}}}).result.then(function(result){return $scope.addItem(result.service,result.duration)})}}),angular.module("BB.Directives").directive("bbMultiServiceSelect",function(){return{restrict:"AE",scope:!0,controller:"MultiServiceSelect"}}),angular.module("BB.Controllers").controller("PackageItem",function($scope,$rootScope,BBModel){return $rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)}),$scope.init=function(company){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),BBModel.PackageItem.$query(company).then(function(package_items){return $scope.packages=package_items})},$scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope.package=item,!1):($scope.booking_item.setPackageItem(item),$scope.decideNextPage(route),!0)},$scope.setReady=function(){return!!$scope.package&&($scope.booking_item.setPackageItem($scope.package),!0)},$scope.getPackageServices=function(item){if(item&&!item.service_list){item.service_list=[];return BBModel.PackageItem.$getPackageServices(item).then(function(services){return item.service_list=services}),!0}return!1}}),angular.module("BB.Directives").directive("bbPackageItems",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PackageItem"}}),angular.module("BB.Controllers").controller("PackagePicker",function($scope,$rootScope,$q,TimeService,LoadingService,BBModel){var item=void 0,latest=void 0,slot=void 0,time=void 0;$scope.sel_date=moment().add(1,"days"),$scope.selected_date=$scope.sel_date.toDate(),$scope.picked_time=!1;var loader=LoadingService.$loader($scope);return $scope.$watch("selected_date",function(newv,oldv){return $scope.sel_date=moment(newv),$scope.loadDay()}),$scope.loadDay=function(){$scope.timeSlots=[],loader.notLoaded();var pslots=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.stackedItems)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)item=_step.value,pslots.push(TimeService.query({company:$scope.bb.company,cItem:item,date:$scope.sel_date,client:$scope.client}))}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $q.all(pslots).then(function(res){loader.setLoaded(),$scope.data_valid=!0,$scope.timeSlots=[];for(var _i=0;_i<$scope.stackedItems.length;_i++)item=$scope.stackedItems[_i],item.slots=res[_i],item.slots&&0!==item.slots.length||($scope.data_valid=!1),item.order=_i;if($scope.data_valid){$scope.timeSlots=res;var earliest=null,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from($scope.stackedItems)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){item=_step2.value;var next_earliest=null,_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=Array.from(item.slots)[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0)slot=_step5.value,earliest&&slot.time<earliest?slot.disable():next_earliest||(next_earliest=slot.time+item.service.duration)}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}earliest=next_earliest}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return latest=null,function(){var result=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.bb.stacked_items.slice(0).reverse())[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){item=_step3.value;var next_latest=null,_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(item.slots)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)slot=_step4.value,latest&&slot.time>latest?slot.disable():next_latest=slot.time-item.service.duration}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}result.push(latest=next_latest)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return result}()}},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.selectSlot=function(sel_item,slot){for(var count=0;count<$scope.stackedItems.length;count++){var next;if(item=$scope.stackedItems[count],count===sel_item.order){item.setDate(new BBModel.Day({date:$scope.sel_date.format(),spaces:1})),item.setTime(slot),next=slot.time+item.service.duration;if(time=slot.time,slot=null,count>0)for(var current=count-1;current>=0;){if(item=$scope.bb.stacked_items[current],latest=time-item.service.duration,!item.time||item.time.time>latest){item.setDate(new BBModel.Day({date:$scope.sel_date.format(),spaces:1})),item.setTime(null);var _iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=Array.from(item.slots)[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0)slot=_step6.value,slot.time<latest&&item.setTime(slot)}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}}time=item.time.time,current-=1}}else if(count>sel_item.order){var _item=item,slots=_item.slots;if(item.setDate(new BBModel.Day({date:$scope.sel_date.format(),spaces:1})),slots){item.setTime(null);var _iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{
for(var _step7,_iterator7=Array.from(slots)[Symbol.iterator]();!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=!0)slot=_step7.value,slot.time>=next&&!item.time&&(item.setTime(slot),next=slot.time+item.service.duration)}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}}}}return $scope.picked_time=!0},$scope.hasAvailability=function(slots,start_time,end_time){if(!slots)return!1;if(start_time&&end_time){var _iteratorNormalCompletion8=!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var _step8,_iterator8=Array.from(slots)[Symbol.iterator]();!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=!0)if(slot=_step8.value,slot.time>=start_time&&slot.time<end_time&&slot.availability()>0)return!0}catch(err){_didIteratorError8=!0,_iteratorError8=err}finally{try{!_iteratorNormalCompletion8&&_iterator8.return&&_iterator8.return()}finally{if(_didIteratorError8)throw _iteratorError8}}}else if(end_time){var _iteratorNormalCompletion9=!0,_didIteratorError9=!1,_iteratorError9=void 0;try{for(var _step9,_iterator9=Array.from(slots)[Symbol.iterator]();!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=!0)if(slot=_step9.value,slot.time<end_time&&slot.availability()>0)return!0}catch(err){_didIteratorError9=!0,_iteratorError9=err}finally{try{!_iteratorNormalCompletion9&&_iterator9.return&&_iterator9.return()}finally{if(_didIteratorError9)throw _iteratorError9}}}else if(start_time){var _iteratorNormalCompletion10=!0,_didIteratorError10=!1,_iteratorError10=void 0;try{for(var _step10,_iterator10=Array.from(slots)[Symbol.iterator]();!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=!0)if(slot=_step10.value,slot.time>=start_time&&slot.availability()>0)return!0}catch(err){_didIteratorError10=!0,_iteratorError10=err}finally{try{!_iteratorNormalCompletion10&&_iterator10.return&&_iterator10.return()}finally{if(_didIteratorError10)throw _iteratorError10}}}else{var _iteratorNormalCompletion11=!0,_didIteratorError11=!1,_iteratorError11=void 0;try{for(var _step11,_iterator11=Array.from(slots)[Symbol.iterator]();!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done);_iteratorNormalCompletion11=!0)if(slot=_step11.value,slot.availability()>0)return!0}catch(err){_didIteratorError11=!0,_iteratorError11=err}finally{try{!_iteratorNormalCompletion11&&_iterator11.return&&_iterator11.return()}finally{if(_didIteratorError11)throw _iteratorError11}}}},$scope.confirm=function(){}}),angular.module("BB.Directives").directive("bbPackagePicker",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PackagePicker"}}),angular.module("BB.Controllers").controller("Payment",function($scope,$rootScope,$q,$location,$window,$sce,$log,$timeout,LoadingService){var loader=LoadingService.$loader($scope).notLoaded();return $scope.purchase&&($scope.bb.total=$scope.purchase),$rootScope.connection_started.then(function(){if($scope.total&&($scope.bb.total=$scope.total),$scope.bb&&$scope.bb.total&&$scope.bb.total.$href("new_payment"))return $scope.url=$sce.trustAsResourceUrl($scope.bb.total.$href("new_payment"))}),$scope.callNotLoaded=function(){return loader.notLoaded()},$scope.callSetLoaded=function(){return loader.setLoaded()},$scope.paymentDone=function(){if($scope.bb.payment_status="complete",$scope.$emit("payment:complete"),$scope.route_to_next_page)return $scope.decideNextPage()},$scope.error=function(message){return $log.warn("Payment Failure: "+message)}}),angular.module("BB.Directives").directive("bbPayment",function($window,$location,$sce,GeneralOptions,AlertService){return{restrict:"AE",replace:!0,scope:!0,controller:"Payment",link:function(scope,element,attributes){var getHost=function(url){var a=document.createElement("a");return a.href=url,a.protocol+"//"+a.host},sendLoadEvent=function(element,origin,scope){var custom_stylesheet=void 0,referrer=$location.protocol()+"://"+$location.host();$location.port()&&(referrer+=":"+$location.port()),scope.payment_options.custom_stylesheet&&(custom_stylesheet=scope.payment_options.custom_stylesheet.match(/http/)?scope.payment_options.custom_stylesheet:$location.absUrl().match(/.+(?=#)/)+scope.payment_options.custom_stylesheet);var payload=JSON.stringify({type:"load",message:referrer,custom_partial_url:scope.bb.custom_partial_url,custom_stylesheet:custom_stylesheet,scroll_offset:GeneralOptions.scroll_offset});return element.find("iframe")[0].contentWindow.postMessage(payload,origin)};return scope.payment_options=scope.$eval(attributes.bbPayment)||{},scope.route_to_next_page=null==scope.payment_options.route_to_next_page||scope.payment_options.route_to_next_page,element.find("iframe").bind("load",function(event){var url=void 0;scope.bb&&scope.bb.total&&scope.bb.total.$href("new_payment")&&(url=scope.bb.total.$href("new_payment"));var origin=getHost(url);return sendLoadEvent(element,origin,scope),scope.$apply(function(){return scope.callSetLoaded()})}),$window.addEventListener("message",function(event){var data=void 0;return angular.isObject(event.data)?data=event.data:event.data.match(/iFrameSizer/)||(data=JSON.parse(event.data)),scope.$apply(function(){if(data)switch(data.type){case"submitting":return scope.callNotLoaded();case"error":return scope.$emit("payment:failed"),scope.callNotLoaded(),AlertService.raise("PAYMENT_FAILED"),document.getElementsByTagName("iframe")[0].src+="";case"payment_complete":return scope.callSetLoaded(),scope.paymentDone()}})},!1)}}});var BBPeopleCtrl=function($scope,$rootScope,$q,BBModel,PersonModel,FormDataStoreService,ValidatorService,LoadingService){"ngInject";var new_person=void 0;this.$scope=$scope;var chosenService=null,loader=null,connectionStartedSuccess=function(){return loadData()},connectionStartedFailure=function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")},currentItemUpdateHandler=function(event){return loadData()},loadData=function(){var bi=$scope.booking_item;if(!bi.service||bi.service===chosenService)return void(bi.service||loader.setLoaded());loader.notLoaded(),chosenService=bi.service;var ppromise=BBModel.Person.$query($scope.bb.company);return ppromise.then(function(people){return bi.group&&(people=people.filter(function(x){return!x.group_id||x.group_id===bi.group})),$scope.all_people=people}),BBModel.BookableItem.$query({company:$scope.bb.company,cItem:bi,wait:ppromise,item:"person"}).then(function(items){bi.group&&(items=items.filter(function(x){return!x.group_id||x.group_id===bi.group}));var promises=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;promises.push(i.promise)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $q.all(promises).then(function(res){var person=void 0,people=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)i=_step2.value,people.push(i.item),bi&&bi.person&&bi.person.id===i.item.id&&(-1!==$scope.bb.current_item.settings.person&&($scope.person=i.item),$scope.selected_bookable_items=[i])}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return 1===items.length&&$scope.bb.company.settings&&$scope.bb.company.settings.merge_people&&(person=items[0]),$scope.bb.current_item.defaults.person&&(person=$scope.bb.current_item.defaults.person),person&&!$scope.selectItem(person,$scope.nextRoute,{skip_step:!0})?(setPerson(people),$scope.bookable_items=items,$scope.selected_bookable_items=items):(setPerson(people),$scope.bookable_items=items,$scope.selected_bookable_items||($scope.selected_bookable_items=items)),loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),ppromise.finally(function(){return loader.setLoaded()})})},setPerson=function(people){if($scope.bookable_people=people,$scope.person)return _.each(people,function(person){if(person.id===$scope.person.id)return $scope.person=person})},getItemFromPerson=function(person){if(person instanceof PersonModel&&$scope.bookable_items){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.bookable_items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var item=_step3.value;if(item.item.self===person.self)return item}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}return person},selectItem=function(item,route,options){return null==options&&(options={}),$scope.$parent.$has_page_control?($scope.person=item,!1):(new_person=getItemFromPerson(item),_.each($scope.booking_items,function(bi){return bi.setPerson(new_person)}),options.skip_step&&$scope.skipThisStep(),$scope.decideNextPage(route),!0)},selectAndRoute=function(item,route){return new_person=getItemFromPerson(item),_.each($scope.booking_items,function(bi){return bi.setPerson(new_person)}),$scope.decideNextPage(route),!0},personListener=function(newval,oldval){$scope.person&&$scope.booking_item?$scope.booking_item.person&&$scope.booking_item.person.self===$scope.person.self||(new_person=getItemFromPerson($scope.person),_.each($scope.booking_items,function(item){return item.setPerson(new_person)}),$scope.broadcastItemUpdate()):newval!==oldval&&(_.each($scope.booking_items,function(item){return item.setPerson(null)}),$scope.broadcastItemUpdate()),$scope.bb.current_item.defaults.person=$scope.person},setReady=function(){return $scope.person?(new_person=getItemFromPerson($scope.person),_.each($scope.booking_items,function(item){return item.setPerson(new_person)}),!0):(_.each($scope.booking_items,function(item){return item.setPerson(null)}),!0)};!function(){$scope.selectItem=selectItem,$scope.selectAndRoute=selectAndRoute,$scope.setReady=setReady,loader=LoadingService.$loader($scope).notLoaded(),$rootScope.connection_started.then(connectionStartedSuccess,connectionStartedFailure),$scope.$watch("person",personListener),$scope.$on("currentItemUpdate",currentItemUpdateHandler)}()};angular.module("BB.Controllers").controller("BBPeopleCtrl",BBPeopleCtrl),angular.module("BB.Directives").directive("bbPeople",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"BBPeopleCtrl",controllerAs:"$bbPeopleCtrl",link:function(scope,element,attrs){return attrs.bbItems?(scope.booking_items=scope.$eval(attrs.bbItems)||[],scope.booking_item=scope.booking_items[0]):(scope.booking_item=scope.$eval(attrs.bbItem)||scope.bb.current_item,scope.booking_items=[scope.booking_item])}}}),angular.module("BB.Controllers").controller("ProductList",function($scope,$rootScope,$q,$attrs,ItemService,FormDataStoreService,ValidatorService,LoadingService){var loader=LoadingService.$loader($scope).notLoaded();return $rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.init=function(company){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),company.$get("products").then(function(products){return products.$get("products").then(function(products){return $scope.products=products,loader.setLoaded()})})},$scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope.product=item,!1):($scope.booking_item.setProduct(item),$scope.decideNextPage(route),!0)}}),angular.module("BB.Directives").directive("bbProductList",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"ProductList",link:function(scope,element,attrs){attrs.bbItem&&(scope.booking_item=scope.$eval(attrs.bbItem)),attrs.bbShowAll&&(scope.show_all=!0)}}});var BBResourcesCtrl=function($scope,$rootScope,$attrs,$q,BBModel,ResourceModel,ValidatorService,LoadingService){"ngInject";var new_resource=void 0,resource=void 0;this.$scope=$scope;var loader=null,connectionStartedSuccess=function(){return loadData()},connectionStartedFailure=function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")},currentItemUpdateHandler=function(event){return loadData()},loadData=function(){if($scope.booking_item||($scope.booking_item=$scope.bb.current_item),!($scope.bb.steps&&"resource_list"===$scope.bb.steps[0].page||$scope.options.resource_first||$scope.booking_item.service&&$scope.booking_item.service!==$scope.change_watch_item))return void($scope.booking_item.service||loader.setLoaded());$scope.change_watch_item=$scope.booking_item.service,loader.setLoaded();var rpromise=BBModel.Resource.$query($scope.bb.company);rpromise.then(function(resources){return $scope.booking_item.group&&(resources=resources.filter(function(x){return!x.group_id||x.group_id===$scope.booking_item.group})),$scope.all_resources=resources});var params={company:$scope.bb.company,cItem:$scope.booking_item,wait:rpromise,item:"resource"};return BBModel.BookableItem.$query(params).then(function(items){var promises=[];$scope.booking_item.group&&(items=items.filter(function(x){return!x.group_id||x.group_id===$scope.booking_item.group}));var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;promises.push(i.promise)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $q.all(promises).then(function(res){var resources=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)i=_step2.value,resources.push(i.item),$scope.booking_item&&$scope.booking_item.resource&&$scope.booking_item.resource.id===i.item.id&&-1!==$scope.bb.current_item.settings.resource&&($scope.resource=i.item)}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return 1===resources.length&&(resource=items[0]),$scope.bb.item_defaults.resource&&(resource=$scope.bb.item_defaults.resource),resource&&$scope.selectItem(resource.item,$scope.nextRoute,{skip_step:!0}),$scope.bookable_resources=resources,$scope.bookable_items=items,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},function(err){return"No service link found"===err&&($scope.bb.steps&&"resource_list"===$scope.bb.steps[0].page||$scope.options.resource_first)?loader.setLoaded():loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},getItemFromResource=function(resource){if(resource instanceof ResourceModel&&$scope.bookable_items){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from($scope.bookable_items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var item=_step3.value;if(item.item.self===resource.self)return item}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}return resource},selectItem=function(item,route,options){return null==options&&(options={}),$scope.$parent.$has_page_control?($scope.resource=item,!1):(new_resource=getItemFromResource(item),_.each($scope.booking_items,function(item){return item.setResource(new_resource)}),options.skip_step&&$scope.skipThisStep(),$scope.decideNextPage(route),!0)},resourceListener=function(newval,oldval){if($scope.resource&&$scope.booking_item){if(!$scope.booking_item.resource||$scope.booking_item.resource.self!==$scope.resource.self)return new_resource=getItemFromResource($scope.resource),_.each($scope.booking_items,function(item){return item.setResource(new_resource)}),$scope.broadcastItemUpdate()}else if(newval!==oldval)return _.each($scope.booking_items,function(item){return item.setResource(null)}),$scope.broadcastItemUpdate()},setReady=function(){return $scope.resource?(new_resource=getItemFromResource($scope.resource),_.each($scope.booking_items,function(item){return item.setResource(new_resource)}),!0):(_.each($scope.booking_items,function(item){return item.setResource(null)}),!0)};!function(){$scope.setReady=setReady.bind(this),$scope.selectItem=selectItem.bind(this),loader=LoadingService.$loader($scope).notLoaded(),$rootScope.connection_started.then(connectionStartedSuccess.bind(this),connectionStartedFailure.bind(this)),$scope.$watch("resource",resourceListener.bind(this)),$scope.$on("currentItemUpdate",currentItemUpdateHandler.bind(this))}()};angular.module("BB.Controllers").controller("BBResourcesCtrl",BBResourcesCtrl),angular.module("BB.Directives").directive("bbResources",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"BBResourcesCtrl",controllerAs:"$bbResourcesCtrl",link:function(scope,element,attrs){return scope.options=scope.$eval(attrs.bbResources)||{},attrs.bbItems?(scope.booking_items=scope.$eval(attrs.bbItems)||[],scope.booking_item=scope.booking_items[0]):(scope.booking_item=scope.$eval(attrs.bbItem)||scope.bb.current_item,scope.booking_items=[scope.booking_item])}}});var BBServicesCtrl=function($scope,$rootScope,$q,$attrs,$uibModal,$document,BBModel,FormDataStoreService,ValidatorService,ErrorService,$filter,LoadingService){"ngInject";this.$scope=$scope,FormDataStoreService.init("ServiceList",$scope,["service"]);var loader=LoadingService.$loader($scope).notLoaded();$scope.filters={category_name:null,service_name:null,price:{min:0,max:100},custom_array_value:null},$scope.show_custom_array=!1,$scope.options=$scope.$eval($attrs.bbServices)||{},$attrs.bbItem&&($scope.booking_item=$scope.$eval($attrs.bbItem)),($attrs.bbShowAll||$scope.options.show_all)&&($scope.show_all=!0),$scope.options.allow_single_pick&&($scope.allowSinglePick=!0),$scope.options.hide_disabled&&($scope.hide_disabled=!0),$scope.price_options={min:0,max:100},$rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)},function(err){return loader.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(comp){var item=void 0;$scope.booking_item||($scope.booking_item=$scope.bb.current_item),$scope.bb.company.$has("named_categories")?BBModel.Category.$query($scope.bb.company).then(function(items){return $scope.all_categories=items},function(err){return $scope.all_categories=[]}):$scope.all_categories=[],$scope.service&&$scope.service.company_id!==$scope.bb.company.id&&($scope.service=null);var ppromise=comp.$getServices(),all_loaded=[ppromise];if(ppromise.then(function(items){if($scope.options.hide_disabled&&(items=items.filter(function(x){return!x.disabled&&!x.deleted})),"false"!==$attrs.filterServices&&($scope.booking_item.service_ref&&!$scope.options.show_all?items=items.filter(function(x){return x.api_ref===$scope.booking_item.service_ref}):$scope.booking_item.category&&!$scope.options.show_all&&(items=items.filter(function(x){return x.$has("category")&&x.$href("category")===$scope.booking_item.category.self}))),$scope.options.show_event_groups||(items=items.filter(function(x){return!x.is_event_group})),1!==items.length||$scope.options.allow_single_pick?setServiceItem(items):$scope.selectItem(items[0],$scope.nextRoute,{skip_step:!0})||setServiceItem(items),$scope.booking_item.defaultService()){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)item=_step.value,(item.self===$scope.booking_item.defaultService().self||item.name===$scope.booking_item.defaultService().name&&!item.deleted)&&$scope.selectItem(item,$scope.nextRoute,{skip_step:!0})}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}if($scope.booking_item.service){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)item=_step2.value,item.selected=!1,item.self===$scope.booking_item.service.self&&($scope.service=item,item.selected=!0,$scope.booking_item.setService($scope.service))}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}if($scope.booking_item.service||!($scope.booking_item.person&&!$scope.booking_item.anyPerson()||$scope.booking_item.resource&&!$scope.booking_item.anyResource()))return items=setServicesDisplayName(items),$scope.bookable_services=items},function(err){return loader.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.booking_item.person&&!$scope.booking_item.anyPerson()||$scope.booking_item.resource&&!$scope.booking_item.anyResource()){var ispromise=BBModel.BookableItem.$query({company:$scope.bb.company,cItem:$scope.booking_item,wait:ppromise,item:"service"});all_loaded.push(ispromise),ispromise.then(function(items){$scope.booking_item.service_ref&&(items=items.filter(function(x){return x.api_ref===$scope.booking_item.service_ref})),$scope.booking_item.group&&(items=items.filter(function(x){return!x.group_id||x.group_id===$scope.booking_item.group})),$scope.options.hide_disabled&&(items=items.filter(function(x){return null==x.item||!x.item.disabled&&!x.item.deleted}));var services=Array.from(items).filter(function(i){return null!=i.item}).map(function(i){return i.item});return services=setServicesDisplayName(services),$scope.bookable_services=services,$scope.bookable_items=items,1!==services.length||$scope.options.allow_single_pick?setServiceItem(services):$scope.selectItem(services[0],$scope.nextRoute,{skip_step:!0})?void 0:setServiceItem(services)},function(err){return loader.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}return $q.all(all_loaded).then(function(){return loader.setLoaded()})};var setServicesDisplayName=function(items){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var item=_step3.value;item.listed_durations&&1===item.listed_durations.length?item.display_name=item.name+" - "+$filter("time_period")(item.duration):item.display_name=item.name}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return items},setServiceItem=function(items){if($scope.items=items,$scope.filtered_items=$scope.items,$scope.service)return _.each(items,function(item){if(item.id===$scope.service.id)return $scope.service=item})};$scope.selectItem=function(item,route,options){return null==options&&(options={}),!!$scope.routed||($scope.$parent.$has_page_control?($scope.service=item,!1):item.is_event_group?($scope.booking_item.setEventGroup(item),options.skip_step&&$scope.skipThisStep(),$scope.decideNextPage(route),$scope.routed=!0):($scope.booking_item.setService(item),$scope.booking_item.service.child_level_service||($scope.bb.selected_service=$scope.booking_item.service),options.skip_step&&$scope.skipThisStep(),$scope.decideNextPage(route),$scope.routed=!0,!0))},$scope.$watch("service",function(newval,oldval){if($scope.service&&$scope.booking_item&&(!$scope.booking_item.service||$scope.booking_item.service.self!==$scope.service.self))return $scope.booking_item.setService($scope.service),$scope.broadcastItemUpdate(),void($scope.service.child_level_service||($scope.bb.selected_service=$scope.service))}),$scope.setReady=function(){return $scope.service?($scope.booking_item.setService($scope.service),!0):!!($scope.bb.stacked_items&&$scope.bb.stacked_items.length>0)},$scope.errorModal=function(){return $uibModal.open({templateUrl:$scope.getPartial("_error_modal"),controller:function($scope,$uibModalInstance){return $scope.message=ErrorService.getError("GENERIC").msg,$scope.ok=function(){return $uibModalInstance.close()}}})},$scope.filterFunction=function(service){return!!service&&($scope.service_array=[],$scope.custom_array=function(match){if(!match)return!1;if($scope.options.custom_filter){match=match.toLowerCase();var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=Array.from(service.extra[$scope.options.custom_filter])[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var item=_step4.value;if((item=item.toLowerCase())===match)return $scope.show_custom_array=!0,!0}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return!1}},$scope.service_name_include=function(match){if(!match)return!1;if(match){match=match.toLowerCase();return!!service.name.toLowerCase().includes(match)}},(!$scope.filters.category_name||service.category_id===$scope.filters.category_name.id)&&(!$scope.filters.service_name||$scope.service_name_include($scope.filters.service_name))&&(!$scope.filters.custom_array_value||$scope.custom_array($scope.filters.custom_array_value))&&(!service.price||service.price>=100*$scope.filters.price.min&&service.price<=100*$scope.filters.price.max))},$scope.resetFilters=function(){return $scope.options.clear_results&&($scope.show_custom_array=!1),$scope.filters.category_name=null,$scope.filters.service_name=null,$scope.filters.price.min=0,$scope.filters.price.max=100,$scope.filters.custom_array_value=null,$scope.filterChanged()},$scope.filterChanged=function(){return $scope.filtered_items=$filter("filter")($scope.items,$scope.filterFunction)}};angular.module("BB.Controllers").controller("BBServicesCtrl",BBServicesCtrl),angular.module("BB.Directives").directive("bbServices",function($q,$compile,$templateCache){return{restrict:"AE",replace:!0,scope:!0,transclude:!0,controller:"BBServicesCtrl",controllerAs:"$bbServicesCtrl",link:function(scope,element,attrs,ctrls,transclude){return scope.directives="public.ServiceList",transclude(scope,function(clone){return clone.length>1||1===clone.length&&(!clone[0].wholeText||/\S/.test(clone[0].wholeText))?element.html(clone).show():$q.when($templateCache.get("_services.html")).then(function(template){return element.html(template).show(),$compile(element.contents())(scope)})})}}}),angular.module("BB.Controllers").controller("SpaceList",function($scope,$rootScope,$q,ServiceService,LoadingService,BBModel){var loader=LoadingService.$loader($scope);return $rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.init=function(comp){return BBModel.Space.$query(comp).then(function(items){return $scope.currentItem.category&&(items=items.filter(function(x){return x.$has("category")&&x.$href("category")===$scope.currentItem.category.self})),$scope.items=items,1!==items.length||$scope.allowSinglePick?$scope.listLoaded=!0:($scope.skipThisStep(),$rootScope.services=items,$scope.selectItem(items[0],$scope.nextRoute))},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.selectItem=function(item,route){return $scope.currentItem.setService(item),$scope.decide_next_page(route)}}),angular.module("BB.Directives").directive("bbSpaces",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"SpaceList"}}),angular.module("BB.Controllers").controller("Summary",function($scope,$rootScope,LoadingService,BBModel,$q){return $rootScope.connection_started.then(function(){return $scope.item=$scope.bb.current_item,$scope.items=$scope.bb.basket.timeItems()}),$scope.confirm=function(){var loader=LoadingService.$loader($scope).notLoaded(),promises=[BBModel.Client.$create_or_update($scope.bb.company,$scope.client)];return $scope.bb.current_item.service&&promises.push($scope.addItemToBasket()),$q.all(promises).then(function(result){var client=result[0];return $scope.setClient(client),client.waitingQuestions&&client.gotQuestions.then(function(){return $scope.client_details=client.client_details}),loader.setLoaded(),$scope.decideNextPage()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})}}),angular.module("BB.Directives").directive("bbSummary",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Summary"}}),angular.module("BB.Controllers").controller("SurveyQuestions",function($scope,$rootScope,$location,BBModel,ValidatorService,$sessionStorage){var auth_token=void 0,getBookingAndSurvey=void 0,params=void 0;$scope.completed=!1,$scope.login={email:"",password:""},$scope.login_error=!1,$scope.booking_ref="";var loader=LoadingService.$loader($scope).notLoaded();$rootScope.connection_started.then(function(){return init()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")});var init=function(){if($scope.company)return $scope.company.settings.requires_login?($scope.checkIfLoggedIn(),$rootScope.member?getBookingAndSurvey():void 0):getBookingAndSurvey()};$scope.checkIfLoggedIn=function(){return BBModel.Login.$checkLogin()},$scope.loadSurvey=function(purchase){return $scope.company||$scope.purchase.$get("company").then(function(company){return setPurchaseCompany(company)}),$scope.purchase.$has("client")&&$scope.purchase.$get("client").then(function(client){return $scope.setClient(new BBModel.Client(client))}),$scope.purchase.$getBookings().then(function(bookings){return params={},$scope.bookings=bookings,function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from($scope.bookings)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var booking=_step.value;if(booking.datetime&&(booking.pretty_date=moment(booking.datetime).format("dddd, MMMM Do YYYY")),booking.address){var address=new BBModel.Address(booking.address),pretty_address=address.addressSingleLine();booking.pretty_address=pretty_address}$rootScope.user&&(params.admin_only=!0),result.push(booking.$get("survey_questions",params).then(function(details){var item_details=new BBModel.ItemDetails(details);return booking.survey_questions=item_details.survey_questions,booking.$getSurveyAnswers().then(function(answers){booking.survey_answers=answers;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{
for(var _step2,_iterator2=Array.from(booking.survey_questions)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var question=_step2.value;if(booking.survey_answers){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(booking.survey_answers)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var answer=_step3.value;answer.question_text===question.name&&answer.value&&(question.answer=answer.value)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return loader.setLoaded()})}))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}()},function(err){return loader.setLoaded(),failMsg()})},$scope.submitSurveyLogin=function(form){if(ValidatorService.validateForm(form))return params={email:$scope.login.email,password:$scope.login.password,id:$scope.company_id},BBModel.Login.$companyLogin($scope.company,{},params).then(function(member){return BBModel.Login.$setLogin(member),getBookingAndSurvey()},function(err){return showLoginError(),loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.loadSurveyFromPurchaseID=function(id){return params={purchase_id:id,url_root:$scope.bb.api_url},auth_token=$sessionStorage.getItem("auth_token"),auth_token&&(params.auth_token=auth_token),BBModel.Purchase.Total.$query(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.loadSurvey($scope.purchase)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.loadSurveyFromBookingRef=function(id){return params={booking_ref:id,url_root:$scope.bb.api_url,raw:!0},auth_token=$sessionStorage.getItem("auth_token"),auth_token&&(params.auth_token=auth_token),BBModel.Purchase.Total.$bookingRefQuery(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.loadSurvey($scope.purchase)},function(err){return showLoginError(),loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.submitSurvey=function(form){if(ValidatorService.validateForm(form))return Array.from($scope.bookings).map(function(booking){return booking.checkReady(),booking.ready?(loader.notLoaded(),booking.client_id=$scope.client.id,params=booking,BBModel.Purchase.Booking.$addSurveyAnswersToBooking(params).then(function(booking){return loader.setLoaded(),$scope.completed=!0},function(err){return loader.setLoaded()})):$scope.decideNextPage(route)})},$scope.submitBookingRef=function(form){if(ValidatorService.validateForm(form))return loader.notLoaded(),params={booking_ref:$scope.booking_ref,url_root:$scope.bb.api_url,raw:!0},auth_token=$sessionStorage.getItem("auth_token"),auth_token&&(params.auth_token=auth_token),BBModel.Purchase.Total.$bookingRefQuery(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.loadSurvey($scope.purchase)},function(err){return showLoginError(),loader.setLoadedAndShowError(err,"Sorry, something went wrong")})},$scope.storeBookingCookie=function(){return document.cookie="bookingrefsc="+$scope.booking_ref};var showLoginError=function(){return $scope.login_error=!0},setPurchaseCompany=function(company){if($scope.bb.company_id=company.id,$scope.bb.company=new BBModel.Company(company),$scope.company=$scope.bb.company,$scope.bb.item_defaults.company=$scope.bb.company,company.settings&&(company.settings.merge_resources&&($scope.bb.item_defaults.merge_resources=!0),company.settings.merge_people))return $scope.bb.item_defaults.merge_people=!0},getBookingRef=function(){var booking_ref=void 0,matches=/^.*(?:\?|&)booking_ref=(.*?)(?:&|$)/.exec($location.absUrl());return matches&&(booking_ref=matches[1]),booking_ref},getPurchaseID=function(){var purchase_id=void 0,matches=/^.*(?:\?|&)id=(.*?)(?:&|$)/.exec($location.absUrl());return matches&&(purchase_id=matches[1]),purchase_id};return getBookingAndSurvey=function(){var id=getBookingRef();return id?$scope.loadSurveyFromBookingRef(id):(id=getPurchaseID(),id?$scope.loadSurveyFromPurchaseID(id):$scope.bb.total?$scope.loadSurveyFromPurchaseID($scope.bb.total.long_id):void 0)}}),angular.module("BB.Directives").directive("bbSurveyQuestions",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"SurveyQuestions"}}),angular.module("BB.Controllers").controller("bbTimeRangeStackedController",bbTimeRangeStackedController),angular.module("BB.Directives").directive("bbTimeRangeStacked",function(){return{controller:"bbTimeRangeStackedController",controllerAs:"$bbTimeRangeStackedCtrl"}}),function(){angular.module("BB.Directives").directive("bbAccessibleGrid",function(){return{restrict:"A",link:function(scope,element){var navigator=void 0;element.bind("focus",function(){navigator=navigator||new GridNavigator(scope,element),navigator.cells=element.find("tr td div h4").parent(),navigator.columns=element.find("tr td"),navigator.focus()})}}});var GridNavigator=function(){function GridNavigator(scope,elem){_classCallCheck(this,GridNavigator),this.scope=scope,this.elem=elem,this.cells,this.columns,this.activeCellIndex=0,this.event,this.activeKeyCode,this.activeCell,this.accordion,this.accordionSlots,this.accordionSlotIndex=0,this.inAccordion=!1,this.prevCell,this.listen()}return GridNavigator.prototype.listen=function(){var _this=this;this.elem.on("keydown",function(e){_this.event=e,_this.activeKeyCode=e.keyCode,_this.prevCell=_this.cells.eq(_this.activeCellIndex),_this.inAccordion?_this.accordionNav():_this.gridNav(),e.preventDefault(),e.stopPropagation()})},GridNavigator.prototype.gridNav=function(){var columns=this.columns.length,endCellIndex=3*columns-1;switch(this.activeKeyCode){case 39:this.activeCellIndex+=3,this.activeCellIndex=this.activeCellIndex>endCellIndex?this.activeCellIndex-3:this.activeCellIndex,this.focus();break;case 37:this.activeCellIndex-=3,this.activeCellIndex=this.activeCellIndex<0?this.activeCellIndex+3:this.activeCellIndex,this.focus();break;case 40:this.activeCellIndex+=1,this.activeCellIndex=this.activeCellIndex>this.cells.length?this.activeCellIndex-1:this.activeCellIndex,this.focus();break;case 38:this.activeCellIndex-=1,this.activeCellIndex=this.activeCellIndex<0?this.activeCellIndex+1:this.activeCellIndex,this.focus();break;case 9:case 27:this.escape();break;case 13:case 32:this.accordionFocus()}},GridNavigator.prototype.accordionNav=function(){switch(this.activeKeyCode){case 38:this.accordionSlotIndex-=1,this.accordionSlotIndex=this.accordionSlotIndex<0?this.accordionSlots.length-1:this.accordionSlotIndex,this.accordionFocus();break;case 40:this.accordionSlotIndex+=1,this.accordionSlotIndex=this.accordionSlotIndex>=this.accordionSlots.length?0:this.accordionSlotIndex,this.accordionFocus();break;case 27:this.accordionBlur();break;case 9:this.event.shiftKey&&this.accordionBlur();break;case 13:case 32:this.inAccordion&&(this.accordionSlots.eq(this.accordionSlotIndex).click(),this.accordion.click(),this.accordionBlur())}},GridNavigator.prototype.focus=function(){this.activeCell=this.cells.eq(this.activeCellIndex),this.prevCell&&this.prevCell.attr("tabindex","-1"),this.activeCell.attr("tabindex","0").focus()},GridNavigator.prototype.accordionFocus=function(){this.accordion=this.activeCell.find("h4>div"),this.inAccordion||this.event.shiftKey||(this.activeCell=this.cells.eq(this.activeCellIndex),this.activeCell.attr("tabindex","-1"),this.activeCell.blur(),this.inAccordion=!0,this.accordion.click()),this.accordionSlots=this.cells.eq(this.activeCellIndex).parent().parent().find("#time-slots li"),this.accordionSlots.eq(this.accordionSlotIndex).attr("tabindex","0").focus()},GridNavigator.prototype.accordionBlur=function(){this.accordionSlots.eq(this.accordionSlotIndex).attr("tabindex","-1").blur(),this.activeCell.attr("tabindex","0"),this.accordion.click(),this.inAccordion=!1,this.accordionSlotIndex=0,this.focus()},GridNavigator.prototype.escape=function(){if(this.activeCell.attr("tabindex","-1"),this.activeCell.blur(),this.event.shiftKey){var prev=this.elem.parent().prev().find("button");prev.attr("disabled")&&(prev=$(".month-header h2")),prev.focus()}else this.elem.parent().next().find("button").focus()},GridNavigator}()}(),function(){function TimeRangeListController($scope,$element,$attrs,$rootScope,AlertService,LoadingService,BBModel,FormDataStoreService,DateTimeUtilitiesService,SlotDates,viewportSize,ErrorService,bbAnalyticsPiwik,GeneralOptions){"ngInject";function setPiwik(amount){var title="Load Next Week";amount<0&&(title="Load Previous Week"),bbAnalyticsPiwik.push(["trackEvent",["Calendar"],title])}var currentPostcode=$scope.bb.postcode;FormDataStoreService.init("TimeRangeList",$scope,["selected_slot","postcode","original_start_date","start_at_week_start"]),$scope.$on("BBTimeZoneOptions:timeZoneChanged",function(){$scope.initialise()}),currentPostcode!==$scope.postcode&&($scope.selected_slot=null,$scope.selected_date=null),$scope.postcode=$scope.bb.postcode;var loader=LoadingService.$loader($scope).notLoaded();$scope.data_source||($scope.data_source=$scope.bb.current_item),$rootScope.connection_started.then(function(){return $scope.initialise()}),$scope.initialise=function(){var selected_day=void 0;if(null!=$attrs.bbTimeRangeLength)$scope.time_range_length=$scope.$eval($attrs.bbTimeRangeLength);else if($scope.options&&$scope.options.time_range_length)$scope.time_range_length=$scope.options.time_range_length;else{$scope.time_range_length=function(){var cal_days={lg:7,md:5,sm:3,xs:1},timeRange=7;for(var size in cal_days){var days=cal_days[size];size===viewportSize.getViewportSize()&&(timeRange=days)}return timeRange}(),$scope.$on("viewportSize:changed",function(){$scope.time_range_length=null,$scope.initialise()})}if((null!=$attrs.bbDayOfWeek||$scope.options&&$scope.options.day_of_week)&&($scope.day_of_week=null!=$attrs.bbDayOfWeek?$scope.$eval($attrs.bbDayOfWeek):$scope.options.day_of_week),(null!=$attrs.bbSelectedDay||$scope.options&&$scope.options.selected_day)&&(selected_day=null!=$attrs.bbSelectedDay?moment($scope.$eval($attrs.bbSelectedDay)):moment($scope.options.selected_day),moment.isMoment(selected_day)&&($scope.selected_day=selected_day)),$scope.options.ignore_min_advance_datetime=!!$scope.options.ignore_min_advance_datetime,setMinMaxDate(),!$scope.start_date&&$scope.last_selected_date)if($scope.original_start_date){var diff=$scope.last_selected_date.diff($scope.original_start_date,"days");diff%=$scope.time_range_length,$scope.last_selected_date.hour()<=moment().hour()&&(diff+=1),diff=diff===$scope.time_range_length?0:diff;var start_date=$scope.last_selected_date.clone().subtract(diff,"days");setTimeRange($scope.last_selected_date,start_date)}else setTimeRange($scope.last_selected_date);else if($scope.bb.current_item.date||$scope.bb.current_item.defaults.date){var date=$scope.bb.current_item.date?$scope.bb.current_item.date.date:$scope.bb.current_item.defaults.date;setTimeRange(date)}else $scope.selected_day?($scope.original_start_date=$scope.original_start_date||moment($scope.selected_day),setTimeRange($scope.selected_day)):($scope.start_at_week_start=!0,setTimeRange(moment()));return $scope.loadData()};var markSelectedSlot=function(time_slots){var selected_slot=_.find(time_slots,function(slot){return $scope.bb.current_item.date&&$scope.bb.current_item.date.date.isSame(slot.datetime,"day")&&$scope.bb.current_item.time&&$scope.bb.current_item.time.time===slot.time});if(selected_slot)return selected_slot.selected=!0},setTimeRange=function(selected_date,start_date){start_date?$scope.start_date=start_date:$scope.day_of_week?$scope.start_date=selected_date.clone().day($scope.day_of_week):$scope.start_at_week_start?$scope.start_date=selected_date.clone().startOf("week"):$scope.start_date=selected_date.clone(),$scope.selected_day=selected_date,$scope.selected_date=$scope.selected_day.toDate(),isSubtractValid(),isAddValid()},setMinMaxDate=function(){var current_item=$scope.bb.current_item;if(current_item.service&&!$scope.options.ignore_min_advance_datetime){if($scope.min_date=current_item.service.min_advance_datetime,$scope.max_date=current_item.service.max_advance_datetime,GeneralOptions.maxAdvanceDatetimeDays&&($scope.max_date=moment().add(GeneralOptions.maxAdvanceDatetimeDays,"days")),$scope.minDateJs=$scope.min_date.toDate(),$scope.maxDateJs=$scope.max_date.toDate(),!$scope.maxDateDuration){var maxDate=$scope.max_date.clone(),today=moment().clone(),difference=maxDate.startOf("day").diff(today.startOf("day"),"days",!0),maxDateDuration=moment.duration(difference,"days").humanize();$scope.maxDateDurationObj={maxDateDuration:maxDateDuration}}$scope.selected_day&&$scope.selected_day.isBefore(current_item.service.min_advance_datetime,"day")&&!$scope.isAdmin()&&setTimeRange(current_item.service.min_advance_datetime)}};$scope.moment=function(date){return moment(date)},$scope.setDataSource=function(source){return $scope.data_source=source},$scope.$on("currentItemUpdate",function(event){return $scope.loadData()}),$scope.add=function(type,amount){switch(bbAnalyticsPiwik.isEnabled()&&setPiwik(amount),amount>0&&($element.removeClass("subtract"),$element.addClass("add")),type){case"days":setTimeRange($scope.start_date.add(amount,"days"));break;case"weeks":$scope.start_date.add(amount,type),setTimeRange($scope.start_date);break;case"months":$scope.start_date.add(amount,type).startOf("month"),setTimeRange($scope.start_date)}return $scope.loadData()},$scope.subtract=function(type,amount){return $element.removeClass("add"),$element.addClass("subtract"),$scope.add(type,-amount)};var isSubtractValid=function(){$scope.is_subtract_valid=!0;var diff=Math.ceil($scope.selected_day.diff($scope.min_date,"days",!0));return $scope.subtract_length=diff<$scope.time_range_length?diff:$scope.time_range_length,diff<=0&&($scope.is_subtract_valid=!1),$scope.subtract_length>1?$scope.subtract_string="Prev "+$scope.subtract_length+" days":1===$scope.subtract_length?$scope.subtract_string="Prev day":$scope.subtract_string="Prev"},isAddValid=function(){if($scope.is_add_valid=!0,!$scope.isAdmin()&&!$scope.options.ignore_max_advance_datetime&&$scope.max_date){var max_date=$scope.max_date.clone(),selected_day=$scope.selected_day.clone();if(max_date.startOf("day").diff(selected_day.startOf("day"),"days",!0)-$scope.time_range_length<0)return $scope.is_add_valid=!1}};return $scope.selectedDateChanged=function(){return setTimeRange(moment($scope.selected_date)),$scope.selected_slot=null,$scope.loadData()},$scope.isPast=function(){return!$scope.start_date||moment().isAfter($scope.start_date)},$scope.status=function(day,slot){if(slot){return slot.status()}},$scope.selectSlot=function(slot,day,route){slot&&slot.availability()>0&&($scope.bb.current_item.setTime(slot),slot.datetime?($scope.setLastSelectedDate(slot.datetime),$scope.bb.current_item.setDate({date:slot.datetime})):day&&($scope.setLastSelectedDate(day.date),$scope.bb.current_item.setDate(day)),$scope.bb.current_item.reserve_ready?(loader.notLoaded(),$scope.addItemToBasket().then(function(){loader.setLoaded(),$scope.decideNextPage(route)},function(err){loader.setLoadedAndShowError(err,"Sorry, something went wrong")})):$scope.decideNextPage(route))},$scope.highlightSlot=function(slot,day){var current_item=$scope.bb.current_item;if(slot&&slot.availability()>0&&!slot.disabled)return slot.datetime?($scope.setLastSelectedDate(slot.datetime),current_item.setDate({date:slot.datetime.clone().tz($scope.bb.company.timezone)})):day&&($scope.setLastSelectedDate(day.date),current_item.setDate(day)),current_item.setTime(slot),$scope.selected_slot=slot,$scope.selected_day=day.date,$scope.selected_date=day.date.toDate(),!$scope.bb.current_item.earliest_time_slot||!$scope.bb.current_item.earliest_time_slot.selected||$scope.bb.current_item.earliest_time_slot.date.isSame(day.date,"day")&&$scope.bb.current_item.earliest_time_slot.time===slot.time||($scope.bb.current_item.earliest_time_slot.selected=!1),$rootScope.$broadcast("time:selected"),$scope.$broadcast("slotChanged",day,slot)},$scope.loadData=function(){setMinMaxDate();var date=$scope.start_date,edate=moment(date).add($scope.time_range_length,"days");$scope.end_date=moment(edate).add(-1,"days"),AlertService.clear();var duration=$scope.bb.current_item.duration;if($scope.bb.current_item.min_duration&&(duration=$scope.bb.current_item.min_duration),$scope.data_source&&$scope.data_source.days_link){$scope.notLoaded($scope);var loc=null;$scope.bb.postcode&&(loc=",,,,"+$scope.bb.postcode+",");var promise=BBModel.TimeSlot.$query({company:$scope.bb.company,resource_ids:$scope.bb.item_defaults.resources,cItem:$scope.data_source,date:date,client:$scope.client,end_date:$scope.end_date,duration:duration,location:loc,num_resources:$scope.bb.current_item.num_resources,available:1});return promise.finally(function(){return loader.setLoaded()}),promise.then(function(datetime_arr){var time_slots=void 0;$scope.days=[],_.every(_.values(datetime_arr),_.isEmpty)?$scope.no_slots_in_week=!0:$scope.no_slots_in_week=!1;var utc=moment().utc(),utcHours=utc.format("H"),utcMinutes=utc.format("m"),utcSeconds=utc.format("s"),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(_.sortBy(_.pairs(datetime_arr),function(pair){return pair[0]}))[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var slot,pair=_step.value,d=pair[0];time_slots=pair[1],markSelectedSlot(time_slots);var day={date:moment(d).add(utcHours,"hours").add(utcMinutes,"minutes").add(utcSeconds,"seconds"),slots:time_slots};if($scope.days.push(day),time_slots.length>0&&($scope.bb.current_item.earliest_time&&!$scope.bb.current_item.earliest_time.isAfter(d)||($scope.bb.current_item.earliest_time=moment(d).add(time_slots[0].time,"minutes")),$scope.bb.current_item.earliest_time_slot&&!$scope.bb.current_item.earliest_time_slot.date.isAfter(d)||($scope.bb.current_item.earliest_time_slot={date:moment(d).add(time_slots[0].time,"minutes"),time:time_slots[0].time})),$scope.add_padding&&time_slots.length>0){var dtimes={},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(time_slots)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)slot=_step2.value,dtimes[slot.time]=1,slot.date=day.date.format("DD-MM-YY")}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}for(var v=0;v<$scope.add_padding.length;v++){var pad=$scope.add_padding[v];dtimes[pad]||time_slots.splice(v,0,new BBModel.TimeSlot({time:pad,avail:0},time_slots[0].service))}}var requested_slot=DateTimeUtilitiesService.checkDefaultTime(day.date,day.slots,$scope.bb.current_item,$scope.bb.item_defaults);requested_slot.slot&&"full"===requested_slot.match?($scope.skipThisStep(),$scope.selectSlot(requested_slot.slot,day)):requested_slot.slot&&$scope.highlightSlot(requested_slot.slot,day)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return $scope.$broadcast("time_slots:loaded",time_slots)},function(err){return 404===err.status&&err.data&&err.data.error&&"No bookable events found"===err.data.error?($scope.data_source&&$scope.data_source.person?(AlertService.warning(ErrorService.getError("NOT_BOOKABLE_PERSON")),$scope.setLoaded($scope)):$scope.data_source&&$scope.data_source.resource&&(AlertService.warning(ErrorService.getError("NOT_BOOKABLE_RESOURCE")),$scope.setLoaded($scope)),$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")):$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}return loader.setLoaded()},$scope.showFirstAvailableDay=function(){return SlotDates.getFirstDayWithSlots($scope.data_source,$scope.selected_day).then(function(day){return $scope.no_slots_in_week=!1,setTimeRange(day),$scope.loadData()},function(err){return loader.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},$scope.padTimes=function(times){return $scope.add_padding=times},$scope.setReady=function(){return $scope.bb.current_item.time?$scope.bb.moving_booking&&$scope.bb.current_item.start_datetime().isSame($scope.bb.current_item.original_datetime)&&$scope.bb.current_item.person_name===$scope.bb.current_item.person.name?(AlertService.raise("APPT_AT_SAME_TIME"),!1):$scope.bb.moving_booking?($scope.bb.company.$has("resources")&&!$scope.bb.current_item.resource&&($scope.bb.current_item.resource=!0),$scope.bb.company.$has("people")&&!$scope.bb.current_item.person&&($scope.bb.current_item.person=!0),!0):!$scope.bb.current_item.reserve_ready||$scope.addItemToBasket():(AlertService.raise("TIME_SLOT_NOT_SELECTED"),!1)},$scope.pretty_month_title=function(month_format,year_format,seperator){var start_date=void 0;if(null==seperator&&(seperator="-"),$scope.start_date&&$scope.end_date){var month_year_format=month_format+" "+year_format;return $scope.start_date&&$scope.end_date&&$scope.end_date.isAfter($scope.start_date,"month")?(start_date=$scope.start_date.format(month_format),11===$scope.start_date.month()&&(start_date=$scope.start_date.format(month_year_format)),start_date+" "+seperator+" "+$scope.end_date.format(month_year_format)):$scope.start_date.format(month_year_format)}},$scope.selectEarliestTimeSlot=function(){var day=_.find($scope.days,function(day){return day.date.isSame($scope.bb.current_item.earliest_time_slot.date,"day")}),slot=_.find(day.slots,function(slot){return slot.time===$scope.bb.current_item.earliest_time_slot.time});if(day&&slot)return $scope.bb.current_item.earliest_time_slot.selected=!0,$scope.highlightSlot(day,slot)}}angular.module("BB.Controllers").controller("TimeRangeList",TimeRangeListController)}(),function(){function bbTimeRangesDirective($q,$templateCache,$compile,$timeout,scrollIntercepter){return{restrict:"AE",replace:!0,scope:!0,priority:1,transclude:!0,controller:"TimeRangeList",link:function(scope,element,attrs,controller,transclude){return scope.$on("time:selected",function(){var btn=angular.element("#btn-continue");return btn[0].disabled=!1,$timeout(function(){return scrollIntercepter.scrollToElement(btn,500,"time:selected")},1e3),$timeout(function(){return btn[0].focus()},1500)}),scope.today=moment().toDate(),scope.tomorrow=moment().add(1,"days").toDate(),scope.options=scope.$eval(attrs.bbTimeRanges)||{},transclude(scope,function(clone){return clone.length>1||1===clone.length&&(!clone[0].wholeText||/\S/.test(clone[0].wholeText))?element.html(clone).show():$q.when($templateCache.get("_week_calendar.html")).then(function(template){return element.html(template).show(),$compile(element.contents())(scope)})})}}}angular.module("BB.Directives").directive("bbTimeRanges",bbTimeRangesDirective)}(),angular.module("BB.Controllers").controller("TimeSlots",function($scope,$rootScope,$q,$attrs,FormDataStoreService,ValidatorService,LoadingService,halClient,BBModel){var loader=LoadingService.$loader($scope).notLoaded();$rootScope.connection_started.then(function(){if($scope.bb.company)return $scope.init($scope.bb.company)},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.init=function(company){$scope.booking_item||($scope.booking_item=$scope.bb.current_item),$scope.start_date=moment(),$scope.end_date=moment().add(1,"month");var params={item:$scope.booking_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate()};return BBModel.Slot.$query($scope.bb.company,params).then(function(slots){return $scope.slots=slots,loader.setLoaded()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")})};var setItem=function(slot){return $scope.booking_item.setSlot(slot)};return $scope.selectItem=function(slot,route){return $scope.$parent.$has_page_control?(setItem(slot),!1):(setItem(slot),$scope.decideNextPage(route),!0)}}),angular.module("BB.Directives").directive("bbTimeSlots",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"TimeSlots",link:function(scope,element,attrs){attrs.bbItem&&(scope.booking_item=scope.$eval(attrs.bbItem)),attrs.bbShowAll&&(scope.show_all=!0)}}}),angular.module("BB.Controllers").controller("TimeList",TimeListCtrl),angular.module("BB.Directives").directive("bbTimes",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"TimeList"}}),angular.module("BB.Controllers").controller("Total",function($scope,$rootScope,$q,$location,$window,QueryStringService,LoadingService,BBModel){var loader=LoadingService.$loader($scope).notLoaded();return $rootScope.connection_started.then(function(){$scope.bb.payment_status=null;var id=QueryStringService("purchase_id");return id&&!$scope.bb.total?BBModel.PurchaseTotal.$query({url_root:$scope.bb.api_url,purchase_id:id}).then(function(total){if($scope.total=total,loader.setLoaded(),total.paid===total.total_price)return $scope.$emit("checkout:success",total)}):($scope.total=$scope.bb.total,loader.setLoaded(),$scope.total.paid===$scope.total.total_price&&$scope.$emit("checkout:success",$scope.total)),$scope.reset()},function(err){return loader.setLoadedAndShowError(err,"Sorry, something went wrong")}),$scope.print=function(){return $window.open($scope.bb.partial_url+"print_purchase.html?id="+$scope.total.long_id,"_blank","width=700,height=500,toolbar=0,menubar=0,location=0,status=1,scrollbars=1,resizable=1,left=0,top=0"),!0}}),angular.module("BB.Directives").directive("bbTotal",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Total"}});