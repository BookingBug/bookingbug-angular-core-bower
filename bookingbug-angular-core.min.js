function getURIparam(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+name+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(window.location.href);return null==results?"":results[1]}(function(){"use strict";var app;app=angular.module("BB",["BB.Controllers","BB.Filters","BB.Models","BB.Services","BB.Directives","ngStorage","angular-hal","ui.bootstrap","ngSanitize","ui.map","ui.router.util","ngLocalData","ngAnimate","angular-data.DSCacheFactory","angularFileUpload","schemaForm","uiGmapgoogle-maps","angular.filter","ui-rangeSlider","ngCookies","pascalprecht.translate","vcRecaptcha","slickCarousel"]),app.value("AppConfig",{appId:"f6b16c23",appKey:"f0bc4f65f4fbfe7b4b3b7264b655f5eb"}),app.value("AirbrakeConfig",{projectId:"122836",projectKey:"e6d6710b2cf00be965e8452d6a384d37",environment:"localhost"===window.location.hostname?"development":"production"}),window.use_no_conflict?(window.bbjq=$.noConflict(),app.value("$bbug",jQuery.noConflict(!0))):app.value("$bbug",jQuery),app.constant("UriTemplate",window.UriTemplate),app.config(function($locationProvider,$httpProvider,$provide,ie8HttpBackendProvider){var int,lowercase,msie,regexp,result,webkit;return $httpProvider.defaults.headers.common={"App-Id":"f6b16c23","App-Key":"f0bc4f65f4fbfe7b4b3b7264b655f5eb"},int=function(str){return parseInt(str,10)},lowercase=function(string){return angular.isString(string)?string.toLowerCase():string},msie=int((/msie (\d+)/.exec(lowercase(navigator.userAgent))||[])[1]),isNaN(msie)&&(msie=int((/trident\/.*; rv:(\d+)/.exec(lowercase(navigator.userAgent))||[])[1])),regexp=/Safari\/([\d.]+)/,result=regexp.exec(navigator.userAgent),result&&(webkit=parseFloat(result[1])),msie&&9>=msie||webkit&&537>webkit?$provide.provider({$httpBackend:ie8HttpBackendProvider}):void 0}),app.run(function($rootScope,$log,DebugUtilsService,FormDataStoreService,$bbug,$document,$sessionStorage,AppConfig){return $rootScope.$log=$log,$rootScope.$setIfUndefined=FormDataStoreService.setIfUndefined,$rootScope.bb||($rootScope.bb={}),$rootScope.bb.api_url=$sessionStorage.getItem("host"),$bbug.support.opacity===!1?(document.createElement("header"),document.createElement("nav"),document.createElement("section"),document.createElement("footer")):void 0}),angular.module("BB.Services",["ngResource","ngSanitize","ngLocalData"]),angular.module("BB.Controllers",["ngLocalData","ngSanitize"]),angular.module("BB.Directives",[]),angular.module("BB.Filters",[]),angular.module("BB.Models",[]),window.bookingbug={logout:function(options){var logout_opts;return options||(options={}),options.reload!==!1&&(options.reload=!0),logout_opts={app_id:"f6b16c23",app_key:"f0bc4f65f4fbfe7b4b3b7264b655f5eb"},options.root&&(logout_opts.root=options.root),angular.injector(["BB.Services","BB.Models","ng"]).get("LoginService").logout(logout_opts),options.reload?window.location.reload():void 0}},moment.locale("en",{longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"MM/DD/YYYY",l:"M/D/YYYY",LL:"MMMM Do YYYY",ll:"MMM D YYYY",LLL:"MMMM Do YYYY LT",lll:"MMM D YYYY LT",LLLL:"dddd Do MMMM[,] h.mma",llll:"ddd, MMM D YYYY LT"}}),String.prototype.includes||(String.prototype.includes=function(search,start){return"number"!=typeof start&&(start=0),start+search.length>this.length?!1:-1!==this.indexOf(search,start)}),String.prototype.parameterise=function(seperator){return null==seperator&&(seperator="-"),this.trim().replace(/\s/g,seperator).toLowerCase()}}).call(this),angular.module("BB.Services").provider("ie8HttpBackend",function(){function ieCreateHttpBackend($browser,XHR,$browserDefer,callbacks,rawDocument,locationProtocol,sniffer,xhr){function completeRequest(callback,status,response,headersString){var url=url||$browser.url(),URL_MATCH=/^([^:]+):\/\/(\w+:{0,1}\w*@)?(\{?[\w\.-]*\}?)(:([0-9]+))?(\/[^\?#]*)?(\?([^#]*))?(#(.*))?$/,protocol=(url.match(URL_MATCH)||["",locationProtocol])[1];status="file"==protocol?response?200:404:status,status=1223==status?204:status,callback(status,response,headersString),$browser.$$completeOutstandingRequest(angular.noop)}if(!(sniffer.msie&&sniffer.msie<=9||sniffer.webkit&&sniffer.webkit<537))return null;var getHostName=function(path){var a=document.createElement("a");return a.href=path,a.hostname},isLocalCall=function(reqUrl){var reqHost=getHostName(reqUrl),localHost=getHostName($browser.url());return""==reqHost?!0:(patt=new RegExp(localHost+"$","i"),patt.test(reqHost))},pmHandler=function(method,url,post,callback,headers,timeout,withCredentials){var win=$('[name="'+getHostName(url)+'"]')[0].id;pm({target:window.frames[win],type:"xhrRequest",data:{headers:headers,method:method,data:post,url:url},success:function(respObj){headers="Content-Type: "+respObj.contentType,respObj.authToken&&(headers+="\r\nAuth-Token: "+respObj.authToken),completeRequest(callback,respObj.statusCode.status,respObj.responseText,headers)},error:function(data){completeRequest(callback,500,"Error","Content-Type: text/plain")}})};return function(method,url,post,callback,headers,timeout,withCredentials){$browser.$$incOutstandingRequestCount(),url=url||$browser.url(),isLocalCall(url)?xhr(method,url,post,callback,headers,timeout,withCredentials):pmHandler(method,url,post,callback,headers,timeout,withCredentials),timeout>0&&$browserDefer(function(){status=-1,xdr.abort()},timeout)}}function int(str){return parseInt(str,10)}function createXhr(method){if(8>=msie&&(!method.match(/^(get|post|head|put|delete|options)$/i)||!window.XMLHttpRequest))return new window.ActiveXObject("Microsoft.XMLHTTP");if(window.XMLHttpRequest)return new window.XMLHttpRequest;throw minErr("$httpBackend")("noxhr","This browser does not support XMLHttpRequest.")}function isPromiseLike(obj){return obj&&isFunction(obj.then)}function createHttpBackend($browser,createXhr,$browserDefer,callbacks,rawDocument,locationProtocol,msie){function jsonpReq(url,callbackId,done){var script=rawDocument.createElement("script"),callback=null;return script.type="text/javascript",script.src=url,script.async=!0,callback=function(event){removeEventListenerFn(script,"load",callback),removeEventListenerFn(script,"error",callback),rawDocument.body.removeChild(script),script=null;var status=-1,text="unknown";event&&("load"!==event.type||callbacks[callbackId].called||(event={type:"error"}),text=event.type,status="error"===event.type?404:200),done&&done(status,text)},addEventListenerFn(script,"load",callback),addEventListenerFn(script,"error",callback),8>=msie&&(script.onreadystatechange=function(){isString(script.readyState)&&/loaded|complete/.test(script.readyState)&&(script.onreadystatechange=null,callback({type:"load"}))}),rawDocument.body.appendChild(script),callback}var ABORTED=-1;return function(method,url,post,callback,headers,timeout,withCredentials,responseType){function timeoutRequest(){status=ABORTED,jsonpDone&&jsonpDone(),xhr&&xhr.abort()}function completeRequest(callback,status,response,headersString,statusText){timeoutId&&$browserDefer.cancel(timeoutId),jsonpDone=xhr=null,0===status&&(status=response?200:"file"==urlResolve(url).protocol?404:0),status=1223===status?204:status,statusText=statusText||"",callback(status,response,headersString,statusText),$browser.$$completeOutstandingRequest(angular.noop)}var status;if($browser.$$incOutstandingRequestCount(),url=url||$browser.url(),"jsonp"==lowercase(method)){var callbackId="_"+(callbacks.counter++).toString(36);callbacks[callbackId]=function(data){callbacks[callbackId].data=data,callbacks[callbackId].called=!0};var jsonpDone=jsonpReq(url.replace("JSON_CALLBACK","angular.callbacks."+callbackId),callbackId,function(status,text){completeRequest(callback,status,callbacks[callbackId].data,"",text),callbacks[callbackId]=angular.noop})}else{var xhr=createXhr(method);if(xhr.open(method,url,!0),angular.forEach(headers,function(value,key){angular.isDefined(value)&&xhr.setRequestHeader(key,value)}),xhr.onreadystatechange=function(){if(xhr&&4==xhr.readyState){var responseHeaders=null,response=null,statusText="";status!==ABORTED&&(responseHeaders=xhr.getAllResponseHeaders(),response="response"in xhr?xhr.response:xhr.responseText),status===ABORTED&&10>msie||(statusText=xhr.statusText),completeRequest(callback,status||xhr.status,response,responseHeaders,statusText)}},withCredentials&&(xhr.withCredentials=!0),responseType)try{xhr.responseType=responseType}catch(e){if("json"!==responseType)throw e}xhr.send(post||null)}if(timeout>0)var timeoutId=$browserDefer(timeoutRequest,timeout);else isPromiseLike(timeout)&&timeout.then(timeoutRequest)}}this.$get=["$browser","$window","$document","$sniffer",function($browser,$window,$document,$sniffer){var params=[$browser,createXhr,$browser.defer,$window.angular.callbacks,$document[0],$window.location.protocol.replace(":",""),$sniffer],param4ie=params.concat([createHttpBackend.apply(this,params)]);return ieCreateHttpBackend&&ieCreateHttpBackend.apply(this,param4ie)||createHttpBackend.apply(this,params)}];var lowercase=function(string){return angular.isString(string)?string.toLowerCase():string},msie=int((/msie (\d+)/.exec(lowercase(navigator.userAgent))||[])[1]);isNaN(msie)&&(msie=int((/trident\/.*; rv:(\d+)/.exec(lowercase(navigator.userAgent))||[])[1]));var lowercase=function(string){return angular.isString(string)?string.toLowerCase():string}});var NO_JQUERY={};!function(window,$,undefined){if(!("console"in window)){var c=window.console={};c.log=c.warn=c.error=c.debug=function(){}}$===NO_JQUERY&&($={fn:{},extend:function(){for(var a=arguments[0],i=1,len=arguments.length;len>i;i++){var b=arguments[i];for(var prop in b)a[prop]=b[prop]}return a}}),$.fn.pm=function(){return console.log("usage: \nto send:    $.pm(options)\nto receive: $.pm.bind(type, fn, [origin])"),this},$.pm=window.pm=function(options){pm.send(options)},$.pm.bind=window.pm.bind=function(type,fn,origin,hash,async_reply){pm.bind(type,fn,origin,hash,async_reply===!0)},$.pm.unbind=window.pm.unbind=function(type,fn){pm.unbind(type,fn)},$.pm.origin=window.pm.origin=null,$.pm.poll=window.pm.poll=200;var pm={send:function(options){var o=$.extend({},pm.defaults,options),target=o.target;if(!o.target)return void console.warn("postmessage target window required");if(!o.type)return void console.warn("postmessage type required");var msg={data:o.data,type:o.type};o.success&&(msg.callback=pm._callback(o.success)),o.error&&(msg.errback=pm._callback(o.error)),"postMessage"in target&&!o.hash?(pm._bind(),target.postMessage(JSON.stringify(msg),o.origin||"*")):"postMessage"in target.contentWindow&&!o.hash?(pm._bind(),target.contentWindow.postMessage(JSON.stringify(msg),o.origin||"*")):(pm.hash._bind(),pm.hash.send(o,msg))},bind:function(type,fn,origin,hash,async_reply){pm._replyBind(type,fn,origin,hash,async_reply)},_replyBind:function(type,fn,origin,hash,isCallback){"postMessage"in window&&!hash?pm._bind():pm.hash._bind();var l=pm.data("listeners.postmessage");l||(l={},pm.data("listeners.postmessage",l));var fns=l[type];fns||(fns=[],l[type]=fns),fns.push({fn:fn,callback:isCallback,origin:origin||$.pm.origin})},unbind:function(type,fn){var l=pm.data("listeners.postmessage");if(l)if(type)if(fn){var fns=l[type];if(fns){for(var m=[],i=0,len=fns.length;len>i;i++){var o=fns[i];o.fn!==fn&&m.push(o)}l[type]=m}}else delete l[type];else for(var i in l)delete l[i]},data:function(k,v){return v===undefined?pm._data[k]:(pm._data[k]=v,v)},_data:{},_CHARS:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),_random:function(){for(var r=[],i=0;32>i;i++)r[i]=pm._CHARS[0|32*Math.random()];return r.join("")},_callback:function(fn){var cbs=pm.data("callbacks.postmessage");cbs||(cbs={},pm.data("callbacks.postmessage",cbs));var r=pm._random();return cbs[r]=fn,r},_bind:function(){pm.data("listening.postmessage")||(window.addEventListener?window.addEventListener("message",pm._dispatch,!1):window.attachEvent&&window.attachEvent("onmessage",pm._dispatch),pm.data("listening.postmessage",1))},_dispatch:function(e){function sendReply(data){msg.callback&&pm.send({target:e.source,data:data,type:msg.callback})}try{var msg=JSON.parse(e.data)}catch(ex){return void console.warn("postmessage data invalid json: ",ex)}if(!msg.type)return void console.warn("postmessage message type required");var cbs=pm.data("callbacks.postmessage")||{},cb=cbs[msg.type];if(cb)cb(msg.data);else for(var l=pm.data("listeners.postmessage")||{},fns=l[msg.type]||[],i=0,len=fns.length;len>i;i++){var o=fns[i];if(o.origin&&"*"!==o.origin&&e.origin!==o.origin){if(console.warn("postmessage message origin mismatch",e.origin,o.origin),msg.errback){var error={message:"postmessage origin mismatch",origin:[e.origin,o.origin]};pm.send({target:e.source,data:error,type:msg.errback})}}else try{o.callback?o.fn(msg.data,sendReply,e):sendReply(o.fn(msg.data,e))}catch(ex){if(!msg.errback)throw ex;pm.send({target:e.source,data:ex,type:msg.errback})}}}};pm.hash={send:function(options,msg){var target_window=options.target,target_url=options.url;if(!target_url)return void console.warn("postmessage target window url is required");target_url=pm.hash._url(target_url);var source_window,source_url=pm.hash._url(window.location.href);if(window==target_window.parent)source_window="parent";else try{for(var i=0,len=parent.frames.length;len>i;i++){var f=parent.frames[i];if(f==window){source_window=i;break}}}catch(ex){source_window=window.name}if(null==source_window)return void console.warn("postmessage windows must be direct parent/child windows and the child must be available through the parent window.frames list");var hashmessage={"x-requested-with":"postmessage",source:{name:source_window,url:source_url},postmessage:msg},hash_id="#x-postmessage-id="+pm._random();target_window.location=target_url+hash_id+encodeURIComponent(JSON.stringify(hashmessage))},_regex:/^\#x\-postmessage\-id\=(\w{32})/,_regex_len:"#x-postmessage-id=".length+32,_bind:function(){pm.data("polling.postmessage")||(setInterval(function(){var hash=""+window.location.hash,m=pm.hash._regex.exec(hash);if(m){var id=m[1];pm.hash._last!==id&&(pm.hash._last=id,pm.hash._dispatch(hash.substring(pm.hash._regex_len)))}},$.pm.poll||200),pm.data("polling.postmessage",1))},_dispatch:function(hash){function sendReply(data){msg.callback&&pm.send({target:source_window,data:data,type:msg.callback,hash:!0,url:hash.source.url})}if(hash){try{if(hash=JSON.parse(decodeURIComponent(hash)),!("postmessage"===hash["x-requested-with"]&&hash.source&&null!=hash.source.name&&hash.source.url&&hash.postmessage))return}catch(ex){return}var msg=hash.postmessage,cbs=pm.data("callbacks.postmessage")||{},cb=cbs[msg.type];if(cb)cb(msg.data);else{var source_window;source_window="parent"===hash.source.name?window.parent:window.frames[hash.source.name];for(var l=pm.data("listeners.postmessage")||{},fns=l[msg.type]||[],i=0,len=fns.length;len>i;i++){var o=fns[i];if(o.origin){var origin=/https?\:\/\/[^\/]*/.exec(hash.source.url)[0];if("*"!==o.origin&&origin!==o.origin){if(console.warn("postmessage message origin mismatch",origin,o.origin),msg.errback){var error={message:"postmessage origin mismatch",origin:[origin,o.origin]};pm.send({target:source_window,data:error,type:msg.errback,hash:!0,url:hash.source.url})}continue}}try{o.callback?o.fn(msg.data,sendReply):sendReply(o.fn(msg.data))}catch(ex){if(!msg.errback)throw ex;pm.send({target:source_window,data:ex,type:msg.errback,hash:!0,url:hash.source.url})}}}}},_url:function(url){return(""+url).replace(/#.*$/,"")}},$.extend(pm,{defaults:{target:null,url:null,type:null,data:null,success:null,error:null,origin:"*",hash:!1}})}(this,"undefined"==typeof jQuery?NO_JQUERY:jQuery),"JSON"in window&&window.JSON||(JSON={}),function(){function f(n){return 10>n?"0"+n:n}function quote(string){return escapable.lastIndex=0,escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,partial,mind=gap,value=holder[key];switch(value&&"object"==typeof value&&"function"==typeof value.toJSON&&(value=value.toJSON(key)),"function"==typeof rep&&(value=rep.call(holder,key,value)),typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";if(gap+=indent,partial=[],"[object Array]"===Object.prototype.toString.apply(value)){for(length=value.length,i=0;length>i;i+=1)partial[i]=str(i,value)||"null";return v=0===partial.length?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]",gap=mind,v}if(rep&&"object"==typeof rep)for(length=rep.length,i=0;length>i;i+=1)k=rep[i],"string"==typeof k&&(v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));else for(k in value)Object.hasOwnProperty.call(value,k)&&(v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));return v=0===partial.length?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}",gap=mind,v}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(value,replacer,space){var i;if(gap="",indent="","number"==typeof space)for(i=0;space>i;i+=1)indent+=" ";else"string"==typeof space&&(indent=space);if(rep=replacer,replacer&&"function"!=typeof replacer&&("object"!=typeof replacer||"number"!=typeof replacer.length))throw new Error("JSON.stringify");return str("",{"":value})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(holder,key){var k,v,value=holder[key];if(value&&"object"==typeof value)for(k in value)Object.hasOwnProperty.call(value,k)&&(v=walk(value,k),void 0!==v?value[k]=v:delete value[k]);return reviver.call(holder,key,value)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(){angular.module("schemaForm").config(function(schemaFormProvider,schemaFormDecoratorsProvider,sfPathProvider){var datetimepicker,timepicker;return timepicker=function(name,schema,options){var f;return"string"===schema.type&&"time"===schema.format?(f=schemaFormProvider.stdFormObj(name,schema,options),f.key=options.path,f.type="timepicker",options.lookup[sfPathProvider.stringify(options.path)]=f,f):void 0},schemaFormProvider.defaults.string.unshift(timepicker),datetimepicker=function(name,schema,options){var f;return"string"===schema.type&&"datetime"===schema.format?(f=schemaFormProvider.stdFormObj(name,schema,options),f.key=options.path,f.type="datetime",options.lookup[sfPathProvider.stringify(options.path)]=f,f):void 0},schemaFormProvider.defaults.string.unshift(datetimepicker),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","time","bootstrap_ui_time_form.html"),schemaFormDecoratorsProvider.createDirective("time","bootstrap_ui_time_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","datetime","bootstrap_ui_datetime_form.html"),schemaFormDecoratorsProvider.createDirective("datetime","bootstrap_ui_datetime_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","price","price_form.html"),schemaFormDecoratorsProvider.createDirective("price","price_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","date","date_form.html"),schemaFormDecoratorsProvider.createDirective("date","date_form.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","radios","radios.html"),schemaFormDecoratorsProvider.createDirective("radios","radios.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","radios-inline","radios-inline.html"),schemaFormDecoratorsProvider.createDirective("radios-inline","radios-inline.html"),schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","radiobuttons","radio-buttons.html"),schemaFormDecoratorsProvider.createDirective("radiobuttons","radio-buttons.html")})}.call(this),function(){window.Collection=function(){function Collection(){}return Collection}(),window.Collection.Base=function(){function Base(res,items,params){var clean_params,key,m,n,val;this.res=res,this.items=items,this.params=params,this.callbacks=[],clean_params={};for(key in params)val=params[key],null!=val&&(null!=val.id?clean_params[key+"_id"]=val.id:clean_params[key]=val);if(this.jparams=JSON.stringify(clean_params),res)for(n in res)m=res[n],this[n]=m}return Base.prototype.checkItem=function(item){var call,existingItem,i,index,j,k,len1,len2,len3,ref,ref1,ref2,results;if(!this.matchesParams(item))return this.deleteItem(item),!0;for(ref=this.items,index=i=0,len1=ref.length;len1>i;index=++i)if(existingItem=ref[index],item.self===existingItem.self){for(this.items[index]=item,ref1=this.callbacks,j=0,len2=ref1.length;len2>j;j++)call=ref1[j],call[1](item,"update");return!0}for(this.items.push(item),ref2=this.callbacks,results=[],k=0,len3=ref2.length;len3>k;k++)call=ref2[k],results.push(call[1](item,"add"));return results},Base.prototype.deleteItem=function(item){var call,i,len,len1,ref,results;if(len=this.items.length,this.items=this.items.filter(function(x){return x.self!==item.self}),this.items.length!==len){for(ref=this.callbacks,results=[],i=0,len1=ref.length;len1>i;i++)call=ref[i],results.push(call[1](item,"delete"));return results}},Base.prototype.getItems=function(){return this.items},Base.prototype.addCallback=function(obj,fn){var call,i,len1,ref;for(ref=this.callbacks,i=0,len1=ref.length;len1>i;i++)if(call=ref[i],call[0]===obj)return;return this.callbacks.push([obj,fn])},Base.prototype.matchesParams=function(item){return!0},Base}(),window.BaseCollections=function(){function BaseCollections(){this.collections=[]}return BaseCollections.prototype.count=function(){return this.collections.length},BaseCollections.prototype.add=function(col){return this.collections.push(col)},BaseCollections.prototype.checkItems=function(item){var col,i,len1,ref,results;for(ref=this.collections,results=[],i=0,len1=ref.length;len1>i;i++)col=ref[i],results.push(col.checkItem(item));return results},BaseCollections.prototype.deleteItems=function(item){var col,i,len1,ref,results;for(ref=this.collections,results=[],i=0,len1=ref.length;len1>i;i++)col=ref[i],results.push(col.deleteItem(item));return results},BaseCollections.prototype.find=function(prms){var clean_params,col,i,jprms,key,len1,ref,val;clean_params={};for(key in prms)val=prms[key],null!=val&&(null!=val.id?clean_params[key+"_id"]=val.id:clean_params[key]=val);for(jprms=JSON.stringify(clean_params),ref=this.collections,i=0,len1=ref.length;len1>i;i++)if(col=ref[i],jprms===col.jparams)return col},BaseCollections.prototype["delete"]=function(col){return this.collections=_.without(this.collections,col)},BaseCollections}()}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;window.Collection.Day=function(superClass){function Day(){return Day.__super__.constructor.apply(this,arguments)}return extend(Day,superClass),Day.prototype.checkItem=function(item){return Day.__super__.checkItem.apply(this,arguments)},Day}(window.Collection.Base),angular.module("BB.Services").provider("DayCollections",function(){return{$get:function(){return new window.BaseCollections}}})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;window.Collection.Space=function(superClass){function Space(){return Space.__super__.constructor.apply(this,arguments)}return extend(Space,superClass),Space.prototype.checkItem=function(item){return Space.__super__.checkItem.apply(this,arguments)},Space}(window.Collection.Base),angular.module("BB.Services").provider("SpaceCollections",function(){return{$get:function(){return new window.BaseCollections}}})}.call(this),angular.module("angular-hal",[]).provider("data_cache",function(){this.$get=function(){return data=[],{set:function(key,val){return data[key]=val,val},get:function(key){return data[key]},del:function(key){delete data[key]},has:function(key){return key in data},delMatching:function(str){for(var k in data)-1!=k.indexOf(str)&&delete data[k]}}}}).provider("shared_header",function(){this.$get=function(){return data={},{set:function(key,val,store){return store.setItem(key,val),data[key]=val,val},get:function(key){return data[key]},del:function(key){delete data[key]},has:function(key){return key in data}}}}).factory("halClient",["$http","$q","data_cache","shared_header","UriTemplate","$cookies","$sessionStorage","$localStorage",function($http,$q,data_cache,shared_header,UriTemplate,$cookies,$sessionStorage,$localStorage){function BaseResource(href,options,data,extra){function defineHiddenProperty(target,name,value){target[name]=value}function embedResource(resource){if(angular.isArray(resource))return resource.map(function(resource){return embedResource(resource)});var href=resource.$href("self");embedded.set(href,$q.when(resource))}function hrefLink(link,params){var href=link.templated?new UriTemplate(link.href).fillFromObject(params||{}):link.href;return href}function callLink(method,link,params,data){if(null==params&&(params={}),angular.isArray(link))return $q.all(link.map(function(link){if("GET"!==method)throw"method is not supported for arrays";return callLink(method,link,params,data)}));var linkHref=hrefLink(link,params);return"GET"===method?embedded.has(linkHref)&&!params.no_cache?embedded.get(linkHref):embedded.set(linkHref,callService(method,linkHref,options,data)):callService(method,linkHref,options,data)}function flushLink(link,params){if(angular.isArray(link))return link.map(function(link){return flushLink(link,params)});var linkHref=hrefLink(link,params);embedded.has(linkHref)&&embedded.del(linkHref)}options||(options={}),extra||(extra={});var links={},embedded=data_cache;data.hasOwnProperty("auth_token")&&(options.auth_token=data.auth_token),href=getSelfLink(href,data).href,defineHiddenProperty(this,"$href",function(rel,params){return rel in links?hrefLink(links[rel],params):null}),defineHiddenProperty(this,"$has",function(rel){return rel in links}),defineHiddenProperty(this,"$flush",function(rel,params){var link=links[rel];return flushLink(link,params)}),defineHiddenProperty(this,"$get",function(rel,params){var link=links[rel];return callLink("GET",link,params)}),defineHiddenProperty(this,"$post",function(rel,params,data){var link=links[rel];return callLink("POST",link,params,data)}),defineHiddenProperty(this,"$put",function(rel,params,data){var link=links[rel];return callLink("PUT",link,params,data)}),defineHiddenProperty(this,"$patch",function(rel,params,data){var link=links[rel];return callLink("PATCH",link,params,data)}),defineHiddenProperty(this,"$del",function(rel,params){var link=links[rel];return callLink("DELETE",link,params)}),defineHiddenProperty(this,"$links",function(){return links}),defineHiddenProperty(this,"$toStore",function(){return JSON.stringify({data:this,links:links,options:options})}),defineHiddenProperty(this,"setOption",function(key,value){options[key]=value}),defineHiddenProperty(this,"getOption",function(key){return options[key]}),defineHiddenProperty(this,"$link",function(rel){return links[rel]}),Object.keys(data).filter(function(key){return!~["_","$"].indexOf(key[0])}).forEach(function(key){this[key]=data[key]},this),data._links&&Object.keys(data._links).forEach(function(rel){var link=data._links[rel];link=normalizeLink(href,link),links[rel]=link},this),data._embedded&&Object.keys(data._embedded).forEach(function(rel){var embedded=data._embedded[rel],link=getSelfLink(href,embedded);links[rel]=link;var resource=createResource(href,options,embedded);embedResource(resource)},this),extra.is_new&&(this.is_new=!0)}function createResource(href,options,data,extra){if(angular.isArray(data))return data.map(function(data){return createResource(href,options,data,extra)});var resource=new BaseResource(href,options,data,extra);return resource}function normalizeLink(baseHref,link){return angular.isArray(link)?link.map(function(link){return normalizeLink(baseHref,link)}):(link?("string"==typeof link&&(link={href:link}),link.href=resolveUrl(baseHref,link.href)):link={href:baseHref},link)}function getSelfLink(baseHref,resource){return angular.isArray(resource)?resource.map(function(resource){return getSelfLink(baseHref,resource)}):normalizeLink(baseHref,resource&&resource._links&&resource._links.self)}function callService(method,href,options,data){options||(options={});var headers={"Content-Type":"application/json",Accept:"application/hal+json,application/json"};options.authorization&&(headers.Authorization=options.authorization),options.app_id&&shared_header.set("app_id",options.app_id,$sessionStorage),options.app_key&&shared_header.set("app_key",options.app_key,$sessionStorage),options.auth_token&&($sessionStorage.setItem("auth_token",options.auth_token),shared_header.set("auth_token",options.auth_token,$sessionStorage)),shared_header.has("app_id")&&(headers["App-Id"]=shared_header.get("app_id")),shared_header.has("app_key")&&(headers["App-Key"]=shared_header.get("app_key")),shared_header.has("auth_token")&&(headers["Auth-Token"]=shared_header.get("auth_token")),options.bypass_auth&&(headers["Bypass-Auth"]=options.bypass_auth);var resource=$http({method:method,url:options.transformUrl?options.transformUrl(href):href,headers:headers,data:data}).then(function(res){switch(res.headers("auth-token")&&201==res.status&&(options.auth_token=res.headers("Auth-Token"),shared_header.set("auth_token",res.headers("Auth-Token"),$sessionStorage),$localStorage.getItem("auth_token")&&$localStorage.setItem("auth_token",res.headers("Auth-Token"))),res.status){case 200:return res.data&&'"null"'!==res.data?createResource(href,options,res.data):null;case 201:return extra={is_new:!0},res.data?createResource(href,options,res.data,extra):res.headers("Content-Location")?res.headers("Content-Location"):null;case 204:return null;default:return $q.reject(res)}},function(res){return $q.reject(res)});return resource}function parseHal(data){var resource=createResource(data._links.self.href,null,data);return resource}function resolveUrl(baseHref,href){for(var resultHref="",reFullUrl=/^((?:\w+\:)?)((?:\/\/)?)([^\/]*)((?:\/.*)?)$/,baseHrefMatch=reFullUrl.exec(baseHref),hrefMatch=reFullUrl.exec(href),partIndex=1;5>partIndex;partIndex++)resultHref+=hrefMatch[partIndex]?hrefMatch[partIndex]:baseHrefMatch[partIndex];return resultHref}return $sessionStorage.getItem("auth_token")?shared_header.set("auth_token",$sessionStorage.getItem("auth_token"),$sessionStorage):$cookies["Auth-Token"]&&!shared_header.has("auth_token")&&shared_header.set("auth_token",$cookies["Auth-Token"],$sessionStorage),{setCache:function(cache){data_cache=cache},clearCache:function(str){
data_cache.delMatching(str)},createResource:function(store){return"string"==typeof store&&(store=JSON.parse(store)),resource=store.data,resource._links=store.links,key=store.links.self.href,options=store.options,new BaseResource(key,options,resource)},$get:function(href,options){return!data_cache.has(href)||options&&options.no_cache?data_cache.set(href,callService("GET",href,options)):data_cache.get(href)},$post:function(href,options,data){return callService("POST",href,options,data)},$put:function(href,options,data){return callService("PUT",href,options,data)},$patch:function(href,options,data){return callService("PATCH",href,options,data)},$del:function(href,options){return callService("DELETE",href,options)},$parse:function(data){return parseHal(data)}}}]),angular.module("ngStorage",[]).factory("$fakeStorage",["$cookies",function($cookies){function FakeStorage(){}return FakeStorage.prototype.setItem=function(key,value){$cookies[key]=value},FakeStorage.prototype.getItem=function(key){return"undefined"==typeof $cookies[key]?null:$cookies[key]},FakeStorage.prototype.removeItem=function(key){$cookies[key]&&delete $cookies[key]},FakeStorage.prototype.clear=function(){for(var key in $cookies)$cookies.hasOwnProperty(key)&&delete $cookies[key]},FakeStorage.prototype.key=function(index){return Object.keys($cookies)[index]},new FakeStorage}]).factory("$localStorage",["$window","$fakeStorage",function($window,$fakeStorage){function isStorageSupported(storageName){var testKey="test",storage=$window[storageName];try{return storage.setItem(testKey,"1"),storage.removeItem(testKey),!0}catch(error){return!1}}var storage=isStorageSupported("localStorage")?$window.localStorage:$fakeStorage;return{setItem:function(key,value){storage.setItem(key,value)},getItem:function(key,defaultValue){return storage.getItem(key)||defaultValue},setObject:function(key,value){storage.setItem(key,JSON.stringify(value))},getObject:function(key){return JSON.parse(storage.getItem(key)||"{}")},removeItem:function(key){storage.removeItem(key)},clear:function(){storage.clear()},key:function(index){storage.key(index)}}}]).factory("$sessionStorage",["$window","$fakeStorage",function($window,$fakeStorage){function isStorageSupported(storageName){var testKey="test",storage=$window[storageName];try{return storage.setItem(testKey,"1"),storage.removeItem(testKey),!0}catch(error){return!1}}var storage=isStorageSupported("sessionStorage")?$window.sessionStorage:$fakeStorage;return{setItem:function(key,value){storage.setItem(key,value)},getItem:function(key,defaultValue){return storage.getItem(key)||defaultValue},setObject:function(key,value){storage.setItem(key,JSON.stringify(value))},getObject:function(key){return JSON.parse(storage.getItem(key)||"{}")},removeItem:function(key){storage.removeItem(key)},clear:function(){storage.clear()},key:function(index){storage.key(index)}}}]),function(){var angularFileUpload=angular.module("angularFileUpload",[]);angularFileUpload.service("$upload",["$http","$timeout",function($http,$timeout){function sendHttp(config){config.method=config.method||"POST",config.headers=config.headers||{},config.transformRequest=config.transformRequest||function(data,headersGetter){return window.ArrayBuffer&&data instanceof window.ArrayBuffer?data:$http.defaults.transformRequest[0](data,headersGetter)},window.XMLHttpRequest.__isShim&&(config.headers.__setXHR_=function(){return function(xhr){xhr&&(config.__XHR=xhr,config.xhrFn&&config.xhrFn(xhr),xhr.upload.addEventListener("progress",function(e){config.progress&&$timeout(function(){config.progress&&config.progress(e)})},!1),xhr.upload.addEventListener("load",function(e){e.lengthComputable&&config.progress&&config.progress(e)},!1))}});var promise=$http(config);return promise.progress=function(fn){return config.progress=fn,promise},promise.abort=function(){return config.__XHR&&$timeout(function(){config.__XHR.abort()}),promise},promise.xhr=function(fn){return config.xhrFn=fn,promise},promise.then=function(promise,origThen){return function(s,e,p){config.progress=p||config.progress;var result=origThen.apply(promise,[s,e,p]);return result.abort=promise.abort,result.progress=promise.progress,result.xhr=promise.xhr,result.then=promise.then,result}}(promise,promise.then),promise}this.upload=function(config){config.headers=config.headers||{},config.headers["Content-Type"]=void 0,config.transformRequest=config.transformRequest||$http.defaults.transformRequest;var formData=new FormData,origTransformRequest=config.transformRequest,origData=config.data;return config.transformRequest=function(formData,headerGetter){if(origData)if(config.formDataAppender)for(var key in origData){var val=origData[key];config.formDataAppender(formData,key,val)}else for(var key in origData){var val=origData[key];if("function"==typeof origTransformRequest)val=origTransformRequest(val,headerGetter);else for(var i=0;i<origTransformRequest.length;i++){var transformFn=origTransformRequest[i];"function"==typeof transformFn&&(val=transformFn(val,headerGetter))}formData.append(key,val)}if(null!=config.file){var fileFormName=config.fileFormDataName||"file";if("[object Array]"===Object.prototype.toString.call(config.file))for(var isFileFormNameString="[object String]"===Object.prototype.toString.call(fileFormName),i=0;i<config.file.length;i++)formData.append(isFileFormNameString?fileFormName+i:fileFormName[i],config.file[i],config.file[i].name);else formData.append(fileFormName,config.file,config.file.name)}return formData},config.data=formData,sendHttp(config)},this.http=function(config){return sendHttp(config)}}]),angularFileUpload.directive("ngFileSelect",["$parse","$timeout",function($parse,$timeout){return function(scope,elem,attr){var fn=$parse(attr.ngFileSelect);elem.bind("change",function(evt){var fileList,i,files=[];if(fileList=evt.target.files,null!=fileList)for(i=0;i<fileList.length;i++)files.push(fileList.item(i));$timeout(function(){fn(scope,{$files:files,$event:evt})})}),("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&elem.bind("touchend",function(e){e.preventDefault(),e.target.click()})}}]),angularFileUpload.directive("ngFileDropAvailable",["$parse","$timeout",function($parse,$timeout){return function(scope,elem,attr){if("draggable"in document.createElement("span")){var fn=$parse(attr.ngFileDropAvailable);$timeout(function(){fn(scope)})}}}]),angularFileUpload.directive("ngFileDrop",["$parse","$timeout",function($parse,$timeout){return function(scope,elem,attr){function traverseFileTree(files,item){if(item.isDirectory){var dirReader=item.createReader();processing++,dirReader.readEntries(function(entries){for(var i=0;i<entries.length;i++)traverseFileTree(files,entries[i]);processing--})}else processing++,item.file(function(file){processing--,files.push(file)})}if("draggable"in document.createElement("span")){var cancel=null,fn=$parse(attr.ngFileDrop);elem[0].addEventListener("dragover",function(evt){$timeout.cancel(cancel),evt.stopPropagation(),evt.preventDefault(),elem.addClass(attr.ngFileDragOverClass||"dragover")},!1),elem[0].addEventListener("dragleave",function(evt){cancel=$timeout(function(){elem.removeClass(attr.ngFileDragOverClass||"dragover")})},!1);var processing=0;elem[0].addEventListener("drop",function(evt){evt.stopPropagation(),evt.preventDefault(),elem.removeClass(attr.ngFileDragOverClass||"dragover");var files=[],items=evt.dataTransfer.items;if(items&&items.length>0&&items[0].webkitGetAsEntry)for(var i=0;i<items.length;i++)traverseFileTree(files,items[i].webkitGetAsEntry());else{var fileList=evt.dataTransfer.files;if(null!=fileList)for(var i=0;i<fileList.length;i++)files.push(fileList.item(i))}!function callback(delay){$timeout(function(){processing?callback(10):fn(scope,{$files:files,$event:evt})},delay||0)}()},!1)}}}])}(),angular.module("ngLocalData",["angular-hal"]).factory("$localCache",["halClient","$q","$sessionStorage",function(halClient,$q,$sessionStorage){return data={},jsonData=function(data){return data&&JSON.parse(data)},storage=function(){return $sessionStorage},localSave=function(key,item){storage().setItem(key,item.$toStore())},localLoad=function(key){return res=jsonData(storage().getItem(key)),res?(r=halClient.createResource(res),def=$q.defer(),def.resolve(r),def.promise):null},localDelete=function(key){storage().removeItem(key)},{set:function(key,val){return data[key]=val,val.then(function(item){localSave(key,item)}),val},get:function(key){return localLoad(key),data[key]||(data[key]=localLoad(key)),data[key]},del:function(key){localDelete(key),delete data[key]},has:function(key){return data[key]||(res=localLoad(key),res&&(data[key]=res)),key in data}}}]).factory("$localData",["$http","$rootScope","$sessionStorage",function($http,$rootScope,$sessionStorage){function LocalDataFactory(name){function LocalData(value){this.setStore(value)}return LocalData.prototype.jsonData=function(data){return data&&JSON.parse(data)},LocalData.prototype.storage=function(){return $sessionStorage},LocalData.prototype.localSave=function(item){this.storage().setItem(this.store_name+item.id,JSON.stringify(item))},LocalData.prototype.localSaveIndex=function(ids){this.storage().setItem(this.store_name,ids.join(",")),this.ids=ids},LocalData.prototype.localLoadIndex=function(){return store=this.storage().getItem(this.store_name),records=store&&store.split(",")||[],records},LocalData.prototype.localLoad=function(id){return this.jsonData(this.storage().getItem(this.store_name+id))},LocalData.prototype.count=function(){return this.ids.length},LocalData.prototype.setStore=function(name){for(this.store_name=name,this.data_store=[],this.ids=this.localLoadIndex(),a=0;a<this.ids.length;a++)this.data_store.push(this.localLoad(this.ids[a]))},LocalData.prototype.update=function(data){ids=[];for(x in data)data[x].id&&(ids.push(data[x].id),this.localSave(data[x]));this.localSaveIndex(ids)},new LocalData(name)}return LocalDataFactory}]),getControllerScope=function(controller,fn){$(document).ready(function(){var $element=$('div[data-ng-controller="'+controller+'"]'),scope=angular.element($element).scope();fn(scope)})},function(){"use strict";angular.module("BB.Directives").directive("bbAccordianRangeGroup",function(PathSvc){return{restrict:"AE",replace:!1,scope:!0,require:"^?bbTimeRangeStacked",controller:"AccordianRangeGroup",templateUrl:function(element,attrs){return PathSvc.directivePartial("_accordian_range_group")},link:function(scope,element,attrs,ctrl){return scope.options=scope.$eval(attrs.bbAccordianRangeGroup)||{},scope.options.using_stacked_items=null!=ctrl}}}),angular.module("BB.Controllers").controller("AccordianRangeGroup",function($scope,$attrs,$rootScope,$q,FormDataStoreService){var hasAvailability,setData,updateAvailability;return $scope.controller="public.controllers.AccordianRangeGroup",$scope.collaspe_when_time_selected=!0,$rootScope.connection_started.then(function(){return $scope.options&&$scope.options.range?$scope.init($scope.options.range[0],$scope.options.range[1],$scope.options):void 0}),$scope.setFormDataStoreId=function(id){return FormDataStoreService.init("AccordianRangeGroup"+id,$scope,[])},$scope.init=function(start_time,end_time,options){return $scope.setRange(start_time,end_time),$scope.collaspe_when_time_selected=!options||options.collaspe_when_time_selected,$scope.heading=options.heading?options.heading:void 0},$scope.setRange=function(start_time,end_time){return $scope.options||($scope.options=$scope.$eval($attrs.bbAccordianRangeGroup)||{}),$scope.start_time=start_time,$scope.end_time=end_time,setData()},setData=function(){var i,key,len,ref,ref1,slot;if($scope.accordian_slots=[],$scope.is_open=$scope.is_open||!1,$scope.has_availability=$scope.has_availability||!1,$scope.is_selected=$scope.is_selected||!1,$scope.options&&$scope.options.slots?$scope.source_slots=$scope.options.slots:$scope.day&&$scope.day.slots?$scope.source_slots=$scope.day.slots:$scope.source_slots=null,$scope.source_slots){if(angular.isArray($scope.source_slots))for(ref=$scope.source_slots,i=0,len=ref.length;len>i;i++)slot=ref[i],slot.time>=$scope.start_time&&slot.time<$scope.end_time&&1===slot.avail&&$scope.accordian_slots.push(slot);else{ref1=$scope.source_slots;for(key in ref1)slot=ref1[key],slot.time>=$scope.start_time&&slot.time<$scope.end_time&&1===slot.avail&&$scope.accordian_slots.push(slot)}return updateAvailability()}},updateAvailability=function(day,slot){var i,len,ref;if($scope.selected_slot=null,$scope.accordian_slots&&($scope.has_availability=hasAvailability()),day&&slot)day.date.isSame($scope.day.date)&&slot.time>=$scope.start_time&&slot.time<$scope.end_time&&($scope.selected_slot=slot);else for(ref=$scope.accordian_slots,i=0,len=ref.length;len>i;i++)if(slot=ref[i],slot.selected){$scope.selected_slot=slot;break}if($scope.selected_slot){if($scope.hideHeading=!0,$scope.is_selected=!0,$scope.collaspe_when_time_selected)return $scope.is_open=!1}else if($scope.is_selected=!1,$scope.collaspe_when_time_selected)return $scope.is_open=!1},hasAvailability=function(){var i,len,ref,slot;if(!$scope.accordian_slots)return!1;for(ref=$scope.accordian_slots,i=0,len=ref.length;len>i;i++)if(slot=ref[i],slot.availability()>0)return!0;return!1},$scope.$on("slotChanged",function(event,day,slot){return day&&slot?updateAvailability(day,slot):updateAvailability()}),$scope.$on("dataReloaded",function(event,earliest_slot){return setData()})})}.call(this),function(){angular.module("BB.Directives").directive("bbAddresses",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"AddressList"}}),angular.module("BB.Controllers").controller("AddressList",function($scope,$rootScope,$filter,$sniffer,AddressListService,FormDataStoreService){return $scope.controller="public.controllers.AddressList",$scope.manual_postcode_entry=!1,FormDataStoreService.init("AddressList",$scope,["show_complete_address"]),$rootScope.connection_started.then(function(_this){return function(){return $scope.client.postcode&&!$scope.bb.postcode&&($scope.bb.postcode=$scope.client.postcode),$scope.client.postcode&&$scope.bb.postcode&&$scope.client.postcode===$scope.bb.postcode&&!$scope.bb.address1&&($scope.bb.address1=$scope.client.address1,$scope.bb.address2=$scope.client.address2,$scope.bb.address3=$scope.client.address3,$scope.bb.address4=$scope.client.address4,$scope.bb.address5=$scope.client.address5),$scope.manual_postcode_entry=!$scope.bb.postcode,$scope.show_complete_address=!!$scope.bb.address1,$scope.postcode_submitted?void 0:($scope.findByPostcode(),$scope.postcode_submitted=!1)}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.findByPostcode=function(){return $scope.postcode_submitted=!0,$scope.bb.postcode?($scope.notLoaded($scope),AddressListService.query({company:$scope.bb.company,post_code:$scope.bb.postcode}).then(function(response){var addressArr,newaddr;addressArr=angular.isArray(response)?_.map(response,function(item,i){return{address:item.partialAddress,moniker:item.moniker}}):[{address:response.partialAddress,moniker:response.moniker}],1===addressArr.length&&$sniffer.msie&&(newaddr=[],newaddr.push(addressArr[0]),newaddr.push({address:""}),addressArr=newaddr),$scope.addresses=addressArr,$scope.bb.address=addressArr[0],$scope.client.address=addressArr[0],$scope.setLoaded($scope)},function(err){return $scope.show_complete_address=!0,$scope.postcode_submitted=!0,$scope.setLoaded($scope)})):void 0},$scope.showCompleteAddress=function(){return $scope.show_complete_address=!0,$scope.postcode_submitted=!1,$scope.bb.address&&$scope.bb.address.moniker?($scope.notLoaded($scope),AddressListService.getAddress({company:$scope.bb.company,id:$scope.bb.address.moniker}).then(function(response){var address,address2,address3,addressLine2,building_number,house_number,streetName;address=response,house_number="","string"==typeof address.buildingNumber?house_number=address.buildingNumber:null==address.buildingNumber&&(house_number=address.buildingName),"string"==typeof address.streetName?(streetName=address.streetName?address.streetName:"",$scope.bb.address1=house_number+" "+streetName):(addressLine2=address.addressLine2?address.addressLine2:"",$scope.bb.address1=house_number+" "+addressLine2),address.buildingName&&null==address.buildingNumber&&($scope.bb.address1=house_number,$scope.bb.address2=address.streetName,null!=address.county&&($scope.bb.address4=address.county)),"string"==typeof address.buildingNumber&&"string"==typeof address.buildingName&&"string"==typeof address.streetName&&(streetName=address.streetName?address.streetName:"",$scope.bb.address1=address.buildingName,$scope.bb.address2=address.buildingNumber+" "+streetName),null!=address.buildingName&&address.buildingName.match(/(^[^0-9]+$)/)&&(building_number=address.buildingNumber?address.buildingNumber:"",$scope.bb.address1=address.buildingName+" "+building_number,$scope.bb.address2=address.streetName),null==address.buildingNumber&&null==address.streetName&&($scope.bb.address1=address.buildingName,$scope.bb.address2=address.addressLine3,$scope.bb.address4=address.town),null!=address.companyName&&($scope.bb.address1=address.companyName,null==address.buildingNumber&&null==address.streetName?$scope.bb.address2=address.addressLine3:null==address.buildingNumber?(address2=address.buildingName?address.buildingName+", "+address.streetName:address.streetName,$scope.bb.address2=address2):null==address.buildingName&&null==address.addressLine2?$scope.bb.address2=address.buildingNumber+", "+address.streetName:$scope.bb.address2=address.buildingName,$scope.bb.address3=address.buildingName,address3=address.addressLine3&&null!=address.buildingNumber?address.addressLine3:null==address.addressLine2&&null!=address.buildingNumber?address.buildingNumber+" "+address.streetName:null==address.addressLine2&&null==address.buildingNumber&&null!=address.buildingName?address.addressLine3:"",$scope.bb.address3=address3,$scope.bb.address4=address.town,$scope.bb.address5="",$scope.bb.postcode=address.postCode),null==address.buildingName&&null==address.companyName&&null==address.county?(address2=null==address.addressLine2&&null==address.companyName?address.addressLine3:address.addressLine2,$scope.bb.address2=address2):null==address.buildingName&&null==address.companyName&&($scope.bb.address2=address.addressLine3),null!=address.buildingName&&null!=address.streetName&&null==address.companyName&&null!=address.addressLine3?null==address.addressLine3?$scope.bb.address3=address.buildingName:$scope.bb.address3=address.addressLine3:null==address.buildingName&&null==address.companyName&&null!=address.addressLine2?$scope.bb.address3=address.addressLine3:null==address.buildingName&&null!=address.streetName&&null==address.addressLine3&&($scope.bb.address3=address.addressLine3),$scope.bb.address4=address.town,null!=address.county&&($scope.bb.address5=address.county),$scope.setLoaded($scope)},function(err){return $scope.show_complete_address=!0,$scope.postcode_submitted=!1,$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):void 0},$scope.setManualPostcodeEntry=function(value){return $scope.manual_postcode_entry=value},$scope.$on("client_details:reset_search",function(event){return $scope.bb.address1=null,$scope.bb.address2=null,$scope.bb.address3=null,$scope.bb.address4=null,$scope.bb.address5=null,$scope.show_complete_address=!1,$scope.postcode_submitted=!1,$scope.bb.address=$scope.addresses[0]})})}.call(this),function(){angular.module("BB.Directives").directive("bbAttendees",function(){return{restrict:"AE",replace:!0,scope:!0,controller:function($scope,$rootScope,$q,PurchaseService,BBModel,AlertService,ValidatorService,ClientService){var initialise,updateBooking;return $scope.validator=ValidatorService,$rootScope.connection_started.then(function(){return initialise()}),initialise=function(){return $scope.items=$scope.bb.basket.timeItems()},updateBooking=function(){var deferred,params;return deferred=$q.defer(),params={purchase:$scope.bb.moving_purchase,bookings:$scope.bb.basket.items,notify:!0},PurchaseService.update(params).then(function(purchase){return $scope.bb.purchase=purchase,$scope.setLoaded($scope),$scope.bb.current_item.move_done=!0,$rootScope.$broadcast("booking:updated"),deferred.resolve()},function(err){return deferred.reject()}),deferred.promise},$scope.markItemAsChanged=function(item){return item.attendee_changed=!0},$scope.changeAttendees=function(){var client,client_promises,deferred,i,item,len,ref;if(!$scope.bb.current_item.ready||!$scope.bb.moving_purchase)return!1;for(deferred=$q.defer(),$scope.notLoaded($scope),client_promises=[],ref=$scope.items,i=0,len=ref.length;len>i;i++)item=ref[i],item.attendee_changed?(client=new BBModel.Client,client.first_name=item.first_name,client.last_name=item.last_name,client_promises.push(ClientService.create_or_update($scope.bb.company,client))):client_promises.push($q.when([]));return $q.all(client_promises).then(function(result){var index,j,len1,ref1;for(ref1=$scope.items,index=j=0,len1=ref1.length;len1>j;index=++j)item=ref1[index],result[index]&&result[index].id&&(item.client_id=result[index].id);return updateBooking().then(function(){return $scope.$parent.$has_page_control?deferred.resolve():($scope.decideNextPage("purchase"),AlertService.raise("ATTENDEES_CHANGED"),deferred.resolve())},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}),deferred.promise},$scope.setReady=function(){return $scope.changeAttendees()}}}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbWidget",function(PathSvc,$http,$log,$templateCache,$compile,$q,AppConfig,$timeout,$bbug,$rootScope){var appendCustomPartials,getTemplate,renderTemplate,setupPusher,updatePartials;return getTemplate=function(template){var fromTemplateCache,partial,src;return partial=template?template:"main",fromTemplateCache=$templateCache.get(partial),fromTemplateCache?fromTemplateCache:(src=PathSvc.directivePartial(partial).$$unwrapTrustedValue(),$http.get(src,{cache:$templateCache}).then(function(response){return response.data}))},updatePartials=function(scope,element,prms){var i,j,len,ref;for(ref=element.children(),j=0,len=ref.length;len>j;j++)i=ref[j],$bbug(i).hasClass("custom_partial")&&$bbug(i).remove();return appendCustomPartials(scope,element,prms).then(function(){return scope.$broadcast("refreshPage")})},setupPusher=function(scope,element,prms){return $timeout(function(){return scope.pusher=new Pusher("c8d8cea659cc46060608"),scope.pusher_channel=scope.pusher.subscribe("widget_"+prms.design_id),scope.pusher_channel.bind("update",function(data){return updatePartials(scope,element,prms)})})},appendCustomPartials=function(scope,element,prms){var defer;return defer=$q.defer(),$http.get(prms.custom_partial_url).then(function(custom_templates){return $compile(custom_templates.data)(scope,function(custom,scope){var non_style,style,tag;return custom.addClass("custom_partial"),style=function(){var j,len,results;for(results=[],j=0,len=custom.length;len>j;j++)tag=custom[j],"STYLE"===tag.tagName&&results.push(tag);return results}(),non_style=function(){var j,len,results;for(results=[],j=0,len=custom.length;len>j;j++)tag=custom[j],"STYLE"!==tag.tagName&&results.push(tag);return results}(),$bbug("#widget_"+prms.design_id).html(non_style),element.append(style),scope.bb.path_setup=!0,defer.resolve(style)})}),defer.promise},renderTemplate=function(scope,element,design_mode,template){return $q.when(getTemplate(template)).then(function(template){return element.html(template).show(),design_mode&&element.append("<style widget_css scoped></style>"),$compile(element.contents())(scope)})},{restrict:"A",scope:{client:"=?",apiUrl:"@?",useParent:"="},transclude:!0,controller:"BBCtrl",link:function(scope,element,attrs,controller,transclude){var evaluator,init_params;return null!=attrs.member&&(scope.client=attrs.member),evaluator=scope,scope.useParent&&null!=scope.$parent&&(evaluator=scope.$parent),init_params=evaluator.$eval(attrs.bbWidget),scope.initWidget(init_params),$rootScope.widget_started.then(function(_this){return function(){var prms;return prms=scope.bb,prms.custom_partial_url&&(prms.design_id=prms.custom_partial_url.match(/^.*\/(.*?)$/)[1],$bbug("[ng-app='BB']").append("<div id='widget_"+prms.design_id+"'></div>")),scope.bb.partial_url&&(init_params.partial_url?AppConfig.partial_url=init_params.partial_url:AppConfig.partial_url=scope.bb.partial_url),transclude(scope,function(clone){return scope.has_content=clone.length>1||1===clone.length&&(!clone[0].wholeText||/\S/.test(clone[0].wholeText)),scope.has_content?prms.custom_partial_url?(appendCustomPartials(scope,element,prms),prms.update_design&&setupPusher(scope,element,prms),scope.$on("refreshPage",function(){return scope.showPage(scope.bb.current_page)})):(element.html(clone).show(),prms.design_mode&&element.append("<style widget_css scoped></style>"),$compile(element.contents())(scope)):(prms.custom_partial_url?appendCustomPartials(scope,element,prms).then(function(style){return $q.when(getTemplate()).then(function(template){return element.html(template).show(),$compile(element.contents())(scope),element.append(style),prms.update_design?setupPusher(scope,element,prms):void 0})}):prms.template?renderTemplate(scope,element,prms.design_mode,prms.template):renderTemplate(scope,element,prms.design_mode),scope.$on("refreshPage",function(){return renderTemplate(scope,element,prms.design_mode)}))})}}(this))}}}),angular.module("BB.Controllers").controller("bbContentController",function($scope){return $scope.controller="public.controllers.bbContentController",$scope.initPage=function(_this){return function(){return $scope.setPageLoaded(),$scope.setLoadingPage(!1)}}(this)}),angular.module("BB.Controllers").controller("BBCtrl",function($scope,$location,$rootScope,halClient,$window,$http,$localCache,$q,$timeout,BasketService,LoginService,AlertService,$sce,$element,$compile,$sniffer,$modal,$log,BBModel,BBWidget,SSOService,ErrorService,AppConfig,QueryStringService,QuestionService,LocaleService,PurchaseService,$sessionStorage,$bbug,SettingsService,UriTemplate,$anchorScroll,$localStorage){var base,base1,con_started,first_call,restoreBasket,setupDefaults,widget_started;return $scope.cid="BBCtrl",$scope.controller="public.controllers.BBCtrl",$scope.bb=new BBWidget,AppConfig.uid=$scope.bb.uid,$scope.qs=QueryStringService,$scope.company_api_path="/api/v1/company/{company_id}{?embed,category_id}",$scope.company_admin_api_path="/api/v1/admin/{company_id}/company{?embed,category_id}",$scope.apiUrl&&($scope.bb||($scope.bb={}),$scope.bb.api_url=$scope.apiUrl),$rootScope.bb&&$rootScope.bb.api_url&&($scope.bb.api_url=$rootScope.bb.api_url,$rootScope.bb.partial_url?$scope.bb.partial_url=$rootScope.bb.partial_url:$scope.bb.partial_url=""),80!==$location.port()&&443!==$location.port()?(base=$scope.bb).api_url||(base.api_url=$location.protocol()+"://"+$location.host()+":"+$location.port()):(base1=$scope.bb).api_url||(base1.api_url=$location.protocol()+"://"+$location.host()),$scope.bb.stacked_items=[],first_call=!0,con_started=$q.defer(),$rootScope.connection_started=con_started.promise,widget_started=$q.defer(),$rootScope.widget_started=widget_started.promise,moment.locale([LocaleService,"en"]),$rootScope.Route={Company:0,Category:1,Service:2,Person:3,Resource:4,Duration:5,Date:6,Time:7,Client:8,Summary:9,Basket:10,Checkout:11,Slot:12,Event:13,Login:14},$scope.Route=$rootScope.Route,$compile("<span bb-display-mode></span>")($scope,function(_this){return function(cloned,scope){return $bbug($element).append(cloned)}}(this)),$scope.set_company=function(_this){return function(prms){return $scope.initWidget(prms)}}(this),$scope.initWidget=function(_this){return function(prms){var url;if(null==prms&&(prms={}),_this.$init_prms=prms,con_started=$q.defer(),$rootScope.connection_started=con_started.promise,($sniffer.webkit&&$sniffer.webkit<537||$sniffer.msie&&$sniffer.msie<=9)&&first_call){if($scope.bb.api_url&&(url=document.createElement("a"),url.href=$scope.bb.api_url,""===url.host||url.host===$location.host()||url.host===$location.host()+":"+$location.port()))return void $scope.initWidget2();$rootScope.iframe_proxy_ready?$scope.initWidget2():$scope.$on("iframe_proxy_ready",function(event,args){return args.iframe_proxy_ready?$scope.initWidget2():void 0})}else $scope.initWidget2()}}(this),$scope.initWidget2=function(_this){return function(){var aff_promise,comp_category_id,comp_def,comp_promise,comp_url,company_id,embed_params,get_total,k,match,options,params,prms,ref,setup_promises,setup_promises2,sso_admin_login,sso_member_login,total_id,v;if($scope.init_widget_started=!0,prms=_this.$init_prms,prms.query){ref=prms.query;for(k in ref)v=ref[k],prms[k]=QueryStringService(v)}return prms.custom_partial_url?($scope.bb.custom_partial_url=prms.custom_partial_url,$scope.bb.partial_id=prms.custom_partial_url.substring(prms.custom_partial_url.lastIndexOf("/")+1),prms.update_design&&($scope.bb.update_design=prms.update_design)):prms.design_mode&&($scope.bb.design_mode=prms.design_mode),company_id=$scope.bb.company_id,prms.company_id&&(company_id=prms.company_id),prms.affiliate_id&&($scope.bb.affiliate_id=prms.affiliate_id,$rootScope.affiliate_id=prms.affiliate_id),prms.api_url&&($scope.bb.api_url=prms.api_url),prms.partial_url&&($scope.bb.partial_url=prms.partial_url),prms.page_suffix&&($scope.bb.page_suffix=prms.page_suffix),prms.admin&&($scope.bb.isAdmin=prms.admin),prms.auth_token&&$sessionStorage.setItem("auth_token",prms.auth_token),$scope.bb.app_id=1,$scope.bb.app_key=1,$scope.bb.clear_basket=!0,prms.basket&&($scope.bb.clear_basket=!1),prms.clear_basket===!1&&($scope.bb.clear_basket=!1),($window.bb_setup||prms.client)&&(prms.clear_member||(prms.clear_member=!0)),$scope.bb.client_defaults=prms.client||{},prms.client_defaults&&prms.client_defaults.membership_ref&&($scope.bb.client_defaults.membership_ref=prms.client_defaults.membership_ref),$scope.bb.client_defaults&&$scope.bb.client_defaults.name&&(match=$scope.bb.client_defaults.name.match(/^(\S+)(?:\s(\S+))?/),match&&($scope.bb.client_defaults.first_name=match[1],null!=match[2]&&($scope.bb.client_defaults.last_name=match[2]))),prms.clear_member&&($scope.bb.clear_member=prms.clear_member,$sessionStorage.removeItem("login")),prms.app_id&&($scope.bb.app_id=prms.app_id),prms.app_key&&($scope.bb.app_key=prms.app_key),prms.item_defaults?($scope.bb.original_item_defaults=prms.item_defaults,$scope.bb.item_defaults=angular.copy($scope.bb.original_item_defaults)):$scope.bb.original_item_defaults&&($scope.bb.item_defaults=angular.copy($scope.bb.original_item_defaults)),prms.route_format&&($scope.bb.setRouteFormat(prms.route_format),$scope.bb_route_init&&$scope.bb_route_init()),prms.locale&&moment.locale(prms.locale),prms.hide===!0?$scope.hide_page=!0:$scope.hide_page=!1,prms.custom_partial_url||($scope.bb.path_setup=!0),prms.reserve_without_questions&&($scope.bb.reserve_without_questions=prms.reserve_without_questions),prms.extra_setup&&($scope.bb.extra_setup=prms.extra_setup,prms.extra_setup.step&&($scope.bb.starting_step_number=parseInt(prms.extra_setup.step)),prms.extra_setup.return_url&&($scope.bb.return_url=prms.extra_setup.return_url),prms.extra_setup.destination&&($scope.bb.destination=prms.extra_setup.destination)),prms.template&&($scope.bb.template=prms.template),prms.i18n&&SettingsService.enableInternationalizaton(),prms.login_required&&($scope.bb.login_required=!0),prms.private_note&&($scope.bb.private_note=prms.private_note),prms.qudini_booking_id&&($scope.bb.qudini_booking_id=prms.qudini_booking_id),prms.scroll_offset&&SettingsService.setScrollOffset(prms.scroll_offset),_this.waiting_for_conn_started_def=$q.defer(),$scope.waiting_for_conn_started=_this.waiting_for_conn_started_def.promise,company_id||$scope.bb.affiliate_id?$scope.waiting_for_conn_started=$rootScope.connection_started:_this.waiting_for_conn_started_def.resolve(),widget_started.resolve(),setup_promises2=[],setup_promises=[],
$scope.bb.affiliate_id&&(aff_promise=halClient.$get($scope.bb.api_url+"/api/v1/affiliates/"+$scope.bb.affiliate_id),setup_promises.push(aff_promise),aff_promise.then(function(affiliate){var comp_p,comp_promise;return $scope.bb.$wait_for_routing&&setup_promises2.push($scope.bb.$wait_for_routing.promise),$scope.setAffiliate(new BBModel.Affiliate(affiliate)),$scope.bb.item_defaults.affiliate=$scope.affiliate,prms.company_ref?(comp_p=$q.defer(),comp_promise=$scope.affiliate.getCompanyByRef(prms.company_ref),setup_promises2.push(comp_p.promise),comp_promise.then(function(company){return $scope.setCompany(company,prms.keep_basket).then(function(val){return comp_p.resolve(val)},function(err){return comp_p.reject(err)})},function(err){return comp_p.reject(err)})):void 0})),company_id&&(prms.embed&&(embed_params=prms.embed),embed_params||(embed_params=null),comp_category_id=null,null!=$scope.bb.item_defaults.category&&(comp_category_id=null!=$scope.bb.item_defaults.category.id?$scope.bb.item_defaults.category.id:$scope.bb.item_defaults.category),comp_def=$q.defer(),comp_promise=comp_def.promise,options={},$sessionStorage.getItem("auth_token")&&(options.auth_token=$sessionStorage.getItem("auth_token")),$scope.bb.isAdmin?(comp_url=new UriTemplate($scope.bb.api_url+$scope.company_admin_api_path).fillFromObject({company_id:company_id,category_id:comp_category_id,embed:embed_params}),halClient.$get(comp_url,options).then(function(company){return comp_def.resolve(company)},function(err){return comp_url=new UriTemplate($scope.bb.api_url+$scope.company_api_path).fillFromObject({company_id:company_id,category_id:comp_category_id,embed:embed_params}),halClient.$get(comp_url,options).then(function(company){return comp_def.resolve(company)},function(err){return comp_def.reject(err)})})):(comp_url=new UriTemplate($scope.bb.api_url+$scope.company_api_path).fillFromObject({company_id:company_id,category_id:comp_category_id,embed:embed_params}),halClient.$get(comp_url,options).then(function(company){return company?comp_def.resolve(company):comp_def.reject("Invalid company ID "+company_id)},function(err){return comp_def.reject(err)})),setup_promises.push(comp_promise),comp_promise.then(function(company){var child,comp,cprom,parent_company;return $scope.bb.$wait_for_routing&&setup_promises2.push($scope.bb.$wait_for_routing.promise),comp=new BBModel.Company(company),cprom=$q.defer(),setup_promises2.push(cprom.promise),child=null,comp.companies&&$scope.bb.item_defaults.company&&(child=comp.findChildCompany($scope.bb.item_defaults.company)),child?(parent_company=comp,halClient.$get($scope.bb.api_url+"/api/v1/company/"+child.id).then(function(company){return comp=new BBModel.Company(company),setupDefaults(comp.id),$scope.bb.parent_company=parent_company,$scope.setCompany(comp,prms.keep_basket).then(function(){return cprom.resolve()},function(err){return cprom.reject()})},function(err){return cprom.reject()})):(setupDefaults(comp.id),$scope.setCompany(comp,prms.keep_basket).then(function(){return cprom.resolve()},function(err){return cprom.reject()}))}),prms.member_sso&&(params={company_id:company_id,root:$scope.bb.api_url,member_sso:prms.member_sso},sso_member_login=SSOService.memberLogin(params).then(function(client){return $scope.setClient(client)}),setup_promises.push(sso_member_login)),prms.admin_sso&&(params={company_id:prms.parent_company_id?prms.parent_company_id:company_id,root:$scope.bb.api_url,admin_sso:prms.admin_sso},sso_admin_login=SSOService.adminLogin(params).then(function(admin){return $scope.bb.admin=admin}),setup_promises.push(sso_admin_login)),total_id=QueryStringService("total_id"),total_id&&(params={purchase_id:total_id,url_root:$scope.bb.api_url},get_total=PurchaseService.query(params).then(function(total){return $scope.bb.total=total,total.paid>0?$scope.bb.payment_status="complete":void 0}),setup_promises.push(get_total))),$scope.isLoaded=!1,$q.all(setup_promises).then(function(){return $q.all(setup_promises2).then(function(){var base2,clear_prom,def_clear;return $scope.bb.basket||(base2=$scope.bb).basket||(base2.basket=new BBModel.Basket(null,$scope.bb)),$scope.client||$scope.clearClient(),def_clear=$q.defer(),clear_prom=def_clear.promise,$scope.bb.current_item?def_clear.resolve():clear_prom=$scope.clearBasketItem(),clear_prom.then(function(){var page;return $scope.client_details||($scope.client_details=new BBModel.ClientDetails),$scope.bb.stacked_items||($scope.bb.stacked_items=[]),!$scope.bb.company&&!$scope.bb.affiliate||(con_started.resolve(),$scope.done_starting=!0,prms.no_route)?void 0:(page=null,first_call&&$bbug.isEmptyObject($scope.bb.routeSteps)&&(page=$scope.bb.firstStep),prms.first_page&&(page=prms.first_page),first_call=!1,$scope.decideNextPage(page))})},function(err){return con_started.reject("Failed to start widget"),$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},function(err){return con_started.reject("Failed to start widget"),$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),setupDefaults=function(_this){return function(company_id){var category,clinic,def,event,event_chain,event_group,k,person,ref,resource,service,v;if(def=$q.defer(),first_call||$scope.bb.orginal_company_id&&$scope.bb.orginal_company_id!==company_id){if($scope.bb.orginal_company_id=company_id,$scope.bb.default_setup_promises=[],$scope.bb.item_defaults.query){ref=$scope.bb.item_defaults.query;for(k in ref)v=ref[k],$scope.bb.item_defaults[k]=QueryStringService(v)}$scope.bb.item_defaults.resource&&(resource=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/resources/"+$scope.bb.item_defaults.resource):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/resources/"+$scope.bb.item_defaults.resource),$scope.bb.default_setup_promises.push(resource),resource.then(function(res){return $scope.bb.item_defaults.resource=new BBModel.Resource(res)})),$scope.bb.item_defaults.person&&(person=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/people/"+$scope.bb.item_defaults.person):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/people/"+$scope.bb.item_defaults.person),$scope.bb.default_setup_promises.push(person),person.then(function(res){return $scope.bb.item_defaults.person=new BBModel.Person(res)})),$scope.bb.item_defaults.person_ref&&(person=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/people/find_by_ref/"+$scope.bb.item_defaults.person_ref):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/people/find_by_ref/"+$scope.bb.item_defaults.person_ref),$scope.bb.default_setup_promises.push(person),person.then(function(res){return $scope.bb.item_defaults.person=new BBModel.Person(res)})),$scope.bb.item_defaults.service&&(service=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/services/"+$scope.bb.item_defaults.service):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/services/"+$scope.bb.item_defaults.service),$scope.bb.default_setup_promises.push(service),service.then(function(res){return $scope.bb.item_defaults.service=new BBModel.Service(res)})),$scope.bb.item_defaults.service_ref&&(service=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/services?api_ref="+$scope.bb.item_defaults.service_ref):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/services?api_ref="+$scope.bb.item_defaults.service_ref),$scope.bb.default_setup_promises.push(service),service.then(function(res){return $scope.bb.item_defaults.service=new BBModel.Service(res)})),$scope.bb.item_defaults.event_group&&(event_group=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/event_groups/"+$scope.bb.item_defaults.event_group):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/event_groups/"+$scope.bb.item_defaults.event_group),$scope.bb.default_setup_promises.push(event_group),event_group.then(function(res){return $scope.bb.item_defaults.event_group=new BBModel.EventGroup(res)})),$scope.bb.item_defaults.event&&(event=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/event_chains/"+$scope.bb.item_defaults.event_chain+"/events/"+$scope.bb.item_defaults.event):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/events/"+$scope.bb.item_defaults.event),$scope.bb.default_setup_promises.push(event),event.then(function(res){return $scope.bb.item_defaults.event=new BBModel.Event(res)})),$scope.bb.item_defaults.event_chain&&(event_chain=$scope.bb.isAdmin?halClient.$get($scope.bb.api_url+"/api/v1/admin/"+company_id+"/event_chains/"+$scope.bb.item_defaults.event_chain):halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/event_chains/"+$scope.bb.item_defaults.event_chain),$scope.bb.default_setup_promises.push(event_chain),event_chain.then(function(res){return $scope.bb.item_defaults.event_chain=new BBModel.EventChain(res)})),$scope.bb.item_defaults.category&&(category=halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/categories/"+$scope.bb.item_defaults.category),$scope.bb.default_setup_promises.push(category),category.then(function(res){return $scope.bb.item_defaults.category=new BBModel.Category(res)})),$scope.bb.item_defaults.clinic&&(clinic=halClient.$get($scope.bb.api_url+"/api/v1/"+company_id+"/clinics/"+$scope.bb.item_defaults.clinic),$scope.bb.default_setup_promises.push(clinic),clinic.then(function(res){return $scope.bb.item_defaults.clinic=new BBModel.Clinic(res)})),$scope.bb.item_defaults.duration&&($scope.bb.item_defaults.duration=parseInt($scope.bb.item_defaults.duration)),$q.all($scope.bb.default_setup_promises)["finally"](function(){return def.resolve()})}else def.resolve();return def.promise}}(this),$scope.setLoadingPage=function(_this){return function(val){return $scope.loading_page=val}}(this),$scope.isLoadingPage=function(_this){return function(){return $scope.loading_page}}(this),$scope.$on("$locationChangeStart",function(angular_event,new_url,old_url){var step_number;if($scope.bb.routeFormat||!$scope.bb.routing)return $scope.history_at_widget_init=$scope.history_at_widget_init||window.parent.history.length,step_number=$scope.bb.matchURLToStep(),null!=step_number&&step_number>$scope.bb.current_step?$scope.loadStep(step_number):null!=step_number&&step_number<$scope.bb.current_step&&$scope.loadPreviousStep("locationChangeStart"),$scope.bb.routing=!1}),$scope.showPage=function(_this){return function(route,dont_record_page){return $scope.bb.updateRoute(route),$scope.jumped=!1,$scope.isLoadingPage()?void 0:($window._gaq&&$window._gaq.push(["_trackPageview",route]),$scope.setLoadingPage(!0),$scope.bb.current_page===route?($scope.bb_main="",setTimeout(function(){return $scope.bb_main=$sce.trustAsResourceUrl($scope.bb.pageURL(route)),$scope.$apply()},0)):(AlertService.clear(),$scope.bb.current_page=route,dont_record_page||$scope.bb.recordCurrentPage(),$scope.notLoaded($scope),$scope.bb_main=$sce.trustAsResourceUrl($scope.bb.pageURL(route))),$rootScope.$broadcast("page:loaded"))}}(this),$scope.jumpToPage=function(_this){return function(route){return $scope.current_page=route,$scope.jumped=!0,$scope.bb_main=$sce.trustAsResourceUrl($scope.partial_url+route+$scope.page_suffix)}}(this),$scope.clearPage=function(){return $scope.bb_main=""},$scope.getPartial=function(file){return $scope.bb.pageURL(file)},$scope.setPageLoaded=function(){return $scope.setLoaded($scope)},$scope.setPageRoute=function(_this){return function(route){return $scope.bb.current_page_route=route,$scope.bb.routeSteps&&$scope.bb.routeSteps[route]?($scope.showPage($scope.bb.routeSteps[route]),!0):!1}}(this),$scope.decideNextPage=function(route){if(route){if("none"===route)return;if(!$scope.bb.total||"complete"!==$scope.bb.payment_status)return $scope.showPage(route);$scope.showPage("confirmation")}if($scope.bb.nextSteps&&$scope.bb.current_page&&$scope.bb.nextSteps[$scope.bb.current_page]&&!$scope.bb.routeSteps)return $scope.showPage($scope.bb.nextSteps[$scope.bb.current_page]);if(!$scope.client.valid()&&LoginService.isLoggedIn()&&($scope.client=new BBModel.Client(LoginService.member()._data)),$scope.bb.company&&$scope.bb.company.companies||!$scope.bb.company&&$scope.affiliate){if($scope.setPageRoute($rootScope.Route.Company))return;return $scope.showPage("company_list")}if($scope.bb.total&&"complete"===$scope.bb.payment_status)return $scope.showPage("confirmation");if($scope.bb.total&&"pending"===$scope.bb.payment_status)return $scope.showPage("payment");if($scope.bb.company.$has("event_groups")&&!$scope.bb.current_item.event_group&&!$scope.bb.current_item.service&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal||$scope.bb.company.$has("events")&&$scope.bb.current_item.event_group&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if($scope.setPageRoute($rootScope.Route.Event))return;return $scope.showPage("event_list")}if(!(!$scope.bb.company.$has("events")||!$scope.bb.current_item.event||$scope.bb.current_item.num_book||$scope.bb.current_item.tickets&&$scope.bb.current_item.tickets.qty||$scope.bb.current_item.product||$scope.bb.current_item.deal))return $scope.showPage("event");if($scope.bb.company.$has("services")&&!$scope.bb.current_item.service&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if($scope.setPageRoute($rootScope.Route.Service))return;return $scope.showPage("service_list")}if($scope.bb.company.$has("resources")&&!$scope.bb.current_item.resource&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if($scope.setPageRoute($rootScope.Route.Resource))return;return $scope.showPage("resource_list")}if($scope.bb.company.$has("people")&&!$scope.bb.current_item.person&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.product&&!$scope.bb.current_item.deal){if($scope.setPageRoute($rootScope.Route.Person))return;return $scope.showPage("person_list")}if(!($scope.bb.current_item.duration||null!=$scope.bb.current_item.event||$scope.bb.current_item.product||$scope.bb.current_item.deal)){if($scope.setPageRoute($rootScope.Route.Duration))return;return $scope.showPage("duration_list")}if($scope.bb.current_item.days_link&&!$scope.bb.current_item.date&&null==$scope.bb.current_item.event&&!$scope.bb.current_item.deal){if($scope.bb.company.$has("availability_slots")){if($scope.setPageRoute($rootScope.Route.Slot))return;return $scope.showPage("slot_list")}if($scope.setPageRoute($rootScope.Route.Date))return;return $scope.showPage("calendar")}if(!(!$scope.bb.current_item.days_link||$scope.bb.current_item.time||null!=$scope.bb.current_item.event||$scope.bb.current_item.service&&"day"===$scope.bb.current_item.service.duration_unit||$scope.bb.current_item.deal)){if($scope.setPageRoute($rootScope.Route.Time))return;return $scope.showPage("time")}if(!(!$scope.bb.moving_booking||$scope.bb.current_item.ready&&$scope.bb.current_item.move_done))return $scope.showPage("check_move");if(!$scope.client.valid()){if($scope.setPageRoute($rootScope.Route.Client))return;return $scope.showPage("client")}if(!($scope.bb.basket.readyToCheckout()&&$scope.bb.current_item.ready||!$scope.bb.current_item.item_details)&&$scope.bb.current_item.item_details.hasQuestions){if($scope.setPageRoute($rootScope.Route.Summary))return;return $scope.showPage("check_items")}if($scope.bb.usingBasket&&(!$scope.bb.confirmCheckout||$scope.bb.company_settings.has_vouchers||$scope.bb.company.$has("coupon"))){if($scope.setPageRoute($rootScope.Route.Basket))return;return $scope.showPage("basket")}if($scope.bb.moving_booking&&$scope.bb.basket.readyToCheckout())return $scope.showPage("purchase");if($scope.bb.basket.readyToCheckout()&&null===$scope.bb.payment_status&&!$scope.bb.basket.waiting_for_checkout){if($scope.setPageRoute($rootScope.Route.Checkout))return;return $scope.showPage("checkout")}return"complete"===$scope.bb.payment_status?$scope.showPage("confirmation"):void 0},$scope.showCheckout=function(){return $scope.bb.current_item.ready},$scope.addItemToBasket=function(){var add_defer;if(add_defer=$q.defer(),$scope.bb.current_item.submitted||$scope.bb.moving_booking){if($scope.bb.current_item.submitted)return $scope.bb.current_item.submitted;add_defer.resolve()}else $scope.moveToBasket(),$scope.bb.current_item.submitted=$scope.updateBasket(),$scope.bb.current_item.submitted.then(function(basket){return add_defer.resolve(basket)},function(err){return 409===err.status&&($scope.bb.current_item.person=null,$scope.bb.current_item.resource=null,$scope.bb.current_item.setTime(null),$scope.bb.current_item.service&&$scope.bb.current_item.setService($scope.bb.current_item.service)),$scope.bb.current_item.submitted=null,add_defer.reject(err)});return add_defer.promise},$scope.updateBasket=function(){var add_defer,params;return add_defer=$q.defer(),params={member_id:$scope.client.id,member:$scope.client,items:$scope.bb.basket.items,bb:$scope.bb},BasketService.updateBasket($scope.bb.company,params).then(function(basket){var item,j,len,ref;for(ref=basket.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.storeDefaults($scope.bb.item_defaults),item.reserve_without_questions=$scope.bb.reserve_without_questions;return halClient.clearCache("time_data"),halClient.clearCache("events"),basket.setSettings($scope.bb.basket.settings),$scope.setBasket(basket),$scope.setBasketItem(basket.items[0]),$scope.bb.current_item?add_defer.resolve(basket):$scope.clearBasketItem().then(function(){return add_defer.resolve(basket)})},function(err){var error_modal;return add_defer.reject(err),409===err.status?(halClient.clearCache("time_data"),halClient.clearCache("events"),$scope.bb.current_item.person=null,$scope.bb.current_item.selected_person=null,error_modal=$modal.open({templateUrl:$scope.getPartial("_error_modal"),controller:function($scope,$modalInstance){return $scope.message=ErrorService.getError("ITEM_NO_LONGER_AVAILABLE").msg,$scope.ok=function(){return $modalInstance.close()}}}),error_modal.result["finally"](function(){if(!$scope.bb.nextSteps)return $scope.decideNextPage();if($scope.setPageRoute($rootScope.Route.Date));else if(!$scope.setPageRoute($rootScope.Route.Event))return $scope.loadPreviousStep()})):void 0}),add_defer.promise},$scope.emptyBasket=function(){var defer;if($scope.bb.basket.items&&(!$scope.bb.basket.items||0!==$scope.bb.basket.items.length))return defer=$q.defer(),BasketService.empty($scope.bb).then(function(basket){return $scope.bb.current_item.id&&delete $scope.bb.current_item.id,$scope.setBasket(basket),defer.resolve()},function(err){return defer.reject()}),defer.promise},$scope.deleteBasketItem=function(item){return BasketService.deleteItem(item,$scope.bb.company,{bb:$scope.bb}).then(function(basket){return $scope.setBasket(basket)})},$scope.deleteBasketItems=function(items){var item,j,len,results;for(results=[],j=0,len=items.length;len>j;j++)item=items[j],results.push(BasketService.deleteItem(item,$scope.bb.company,{bb:$scope.bb}).then(function(basket){return $scope.setBasket(basket)}));return results},$scope.clearBasketItem=function(){var def;return def=$q.defer(),$scope.setBasketItem(new BBModel.BasketItem(null,$scope.bb)),$scope.bb.current_item.reserve_without_questions=$scope.bb.reserve_without_questions,$scope.bb.default_setup_promises?$q.all($scope.bb.default_setup_promises)["finally"](function(){return $scope.bb.current_item.setDefaults($scope.bb.item_defaults),$q.all($scope.bb.current_item.promises)["finally"](function(){return def.resolve()})}):def.resolve(),def.promise},$scope.setBasketItem=function(item){return $scope.bb.current_item=item,$scope.current_item=$scope.bb.current_item},$scope.setReadyToCheckout=function(ready){return $scope.bb.confirmCheckout=ready},$scope.moveToBasket=function(){return $scope.bb.basket.addItem($scope.bb.current_item)},$scope.quickEmptybasket=function(options){var def,preserve_stacked_items;return preserve_stacked_items=!(!options||!options.preserve_stacked_items),preserve_stacked_items?($scope.bb.basket=new BBModel.Basket(null,$scope.bb),$scope.basket=$scope.bb.basket,$scope.bb.basket.company_id=$scope.bb.company_id,def=$q.defer(),def.resolve(),def.promise):($scope.bb.stacked_items=[],$scope.setBasket(new BBModel.Basket(null,$scope.bb)),$scope.clearBasketItem())},$scope.setBasket=function(basket){return $scope.bb.basket=basket,$scope.basket=basket,$scope.bb.basket.company_id=$scope.bb.company_id,$scope.bb.stacked_items?$scope.bb.setStackedItems(basket.timeItems()):void 0},$scope.logout=function(route){return $scope.client&&$scope.client.valid()?LoginService.logout({root:$scope.bb.api_url}).then(function(){return $scope.client=new BBModel.Client,$scope.decideNextPage(route)}):$scope.member?LoginService.logout({root:$scope.bb.api_url}).then(function(){return $scope.member=new BBModel.Member.Member,$scope.decideNextPage(route)}):void 0},$scope.setAffiliate=function(affiliate){return $scope.bb.affiliate_id=affiliate.id,$scope.bb.affiliate=affiliate,$scope.affiliate=affiliate,$scope.affiliate_id=affiliate.id},restoreBasket=function(){var restore_basket_defer;return restore_basket_defer=$q.defer(),$scope.quickEmptybasket().then(function(){var auth_token,href,params,status,uri;return auth_token=$localStorage.getItem("auth_token")||$sessionStorage.getItem("auth_token"),href=$scope.bb.api_url+"/api/v1/status{?company_id,affiliate_id,clear_baskets,clear_member}",params={company_id:$scope.bb.company_id,affiliate_id:$scope.bb.affiliate_id,clear_baskets:$scope.bb.clear_basket?"1":null,clear_member:$scope.bb.clear_member?"1":null},uri=new UriTemplate(href).fillFromObject(params),status=halClient.$get(uri,{auth_token:auth_token,no_cache:!0}),status.then(function(_this){return function(res){return res.$has("client")&&res.$get("client").then(function(client){return!$scope.client||$scope.client&&!$scope.client.valid()?$scope.client=new BBModel.Client(client):void 0}),res.$has("member")&&res.$get("member").then(function(member){return"Contact"!==member.client_type?(member=LoginService.setLogin(member),$scope.setClient(member)):void 0}),$scope.bb.clear_basket?restore_basket_defer.resolve():res.$has("baskets")?res.$get("baskets").then(function(baskets){var basket;return basket=_.find(baskets,function(b){return parseInt(b.company_id)===$scope.bb.company_id}),basket?(basket=new BBModel.Basket(basket,$scope.bb),basket.$get("items").then(function(items){var i,j,len,promises;for(items=function(){var j,len,results;for(results=[],j=0,len=items.length;len>j;j++)i=items[j],results.push(new BBModel.BasketItem(i));return results}(),j=0,len=items.length;len>j;j++)i=items[j],basket.addItem(i);return $scope.setBasket(basket),promises=[].concat.apply([],function(){var l,len1,results;for(results=[],l=0,len1=items.length;len1>l;l++)i=items[l],results.push(i.promises);return results}()),$q.all(promises).then(function(){return basket.items.length>0&&$scope.setBasketItem(basket.items[0]),restore_basket_defer.resolve()})})):restore_basket_defer.resolve()}):restore_basket_defer.resolve()}}(this),function(err){return restore_basket_defer.resolve()})}),restore_basket_defer.promise},$scope.setCompany=function(company,keep_basket){var defer;return defer=$q.defer(),$scope.bb.company_id=company.id,$scope.bb.company=company,$scope.company=company,$scope.bb.item_defaults.company=$scope.bb.company,SettingsService.setCountryCode($scope.bb.company.country_code),company.$has("settings")?company.getSettings().then(function(_this){return function(settings){return $scope.bb.company_settings=settings,$scope.bb.company_settings.merge_resources&&($scope.bb.item_defaults.merge_resources=!0),$scope.bb.company_settings.merge_people&&($scope.bb.item_defaults.merge_people=!0),$rootScope.bb_currency=$scope.bb.company_settings.currency,$scope.bb.currency=$scope.bb.company_settings.currency,$scope.bb.has_prices=$scope.bb.company_settings.has_prices,!$scope.bb.basket||$scope.bb.basket.company_id!==$scope.bb.company_id&&!keep_basket?restoreBasket().then(function(){return defer.resolve(),$scope.$emit("company:setup")}):(defer.resolve(),$scope.$emit("company:setup"))}}(this)):!$scope.bb.basket||$scope.bb.basket.company_id!==$scope.bb.company_id&&!keep_basket?restoreBasket().then(function(){return defer.resolve(),$scope.$emit("company:setup")}):(defer.resolve(),$scope.$emit("company:setup")),defer.promise},$scope.recordStep=function(step,title){return $scope.bb.recordStep(step,title)},$scope.setStepTitle=function(title){return $scope.bb.steps[$scope.bb.current_step-1].title=title},$scope.getCurrentStepTitle=function(){var steps;return steps=$scope.bb.steps,_.compact(steps).length||(steps=$scope.bb.allSteps),$scope.bb.current_step?steps[$scope.bb.current_step-1].title:void 0},$scope.checkStepTitle=function(title){return $scope.bb.steps[$scope.bb.current_step-1].title?void 0:$scope.setStepTitle(title)},$scope.loadStep=function(step){var j,len,prev_step,ref,st;if(step!==$scope.bb.current_step&&($scope.bb.calculatePercentageComplete(step),st=$scope.bb.steps[step],prev_step=$scope.bb.steps[step-1],st&&!prev_step&&(prev_step=st),st||(st=prev_step),st&&!$scope.bb.last_step_reached&&(st.stacked_length&&0!==st.stacked_length||($scope.bb.stacked_items=[]),$scope.bb.current_item.loadStep(st.current_item),$scope.bb.steps.length>1&&$scope.bb.steps.splice(step,$scope.bb.steps.length-step),$scope.bb.current_step=step,$scope.showPage(prev_step.page,!0)),$scope.bb.allSteps)){for(ref=$scope.bb.allSteps,j=0,len=ref.length;len>j;j++)step=ref[j],step.active=!1,step.passed=step.number<$scope.bb.current_step;if($scope.bb.allSteps[$scope.bb.current_step-1])return $scope.bb.allSteps[$scope.bb.current_step-1].active=!0}},$scope.loadPreviousStep=function(caller){var ignore_browser_history_sync,last_step,pages_to_remove_from_history,past_steps,step_to_load;for(past_steps=_.without($scope.bb.steps,_.last($scope.bb.steps)),step_to_load=0;past_steps[0]&&(last_step=past_steps.pop());)if(!last_step.skipped){step_to_load=last_step.number;break}return pages_to_remove_from_history=0===step_to_load?$scope.bb.current_step+1:$scope.bb.current_step-step_to_load,"locationChangeStart"===caller&&pages_to_remove_from_history--,ignore_browser_history_sync=$scope.history_at_widget_init===window.history.length,null!=pages_to_remove_from_history&&pages_to_remove_from_history>0&&!ignore_browser_history_sync&&window.history.go(-1*pages_to_remove_from_history),$scope.loadStep(step_to_load)},$scope.loadStepByPageName=function(page_name){var j,len,ref,step;for(ref=$scope.bb.allSteps,j=0,len=ref.length;len>j;j++)if(step=ref[j],step.page===page_name)return $scope.loadStep(step.number);return $scope.loadStep(1)},$scope.reset=function(){return $rootScope.$broadcast("clear:formData"),$rootScope.$broadcast("widget:restart"),$scope.setLastSelectedDate(null),$scope.client=new BBModel.Client,$scope.bb.last_step_reached=!1,$scope.bb.steps.splice(1)},$scope.restart=function(){return $scope.reset(),$scope.loadStep(1)},$scope.setRoute=function(rdata){return $scope.bb.setRoute(rdata)},$scope.setBasicRoute=function(routes){return $scope.bb.setBasicRoute(routes)},$scope.skipThisStep=function(){return $scope.bb.steps[$scope.bb.steps.length-1]?$scope.bb.steps[$scope.bb.steps.length-1].skipped=!0:void 0},$scope.setUsingBasket=function(_this){return function(usingBasket){return $scope.bb.usingBasket=usingBasket}}(this),$scope.setClient=function(_this){return function(client){return $scope.client=client,client.postcode&&!$scope.bb.postcode?$scope.bb.postcode=client.postcode:void 0}}(this),$scope.clearClient=function(_this){return function(){return $scope.client=new BBModel.Client,$window.bb_setup&&$scope.client.setDefaults($window.bb_setup),$scope.bb.client_defaults?$scope.client.setDefaults($scope.bb.client_defaults):void 0}}(this),$scope.today=moment().toDate(),$scope.tomorrow=moment().add(1,"days").toDate(),$scope.parseDate=function(_this){return function(d){return moment(d)}}(this),$scope.getUrlParam=function(_this){return function(param){return $window.getURIparam(param)}}(this),$scope.base64encode=function(_this){return function(param){return $window.btoa(param)}}(this),$scope.setLastSelectedDate=function(_this){return function(date){return $scope.last_selected_date=date}}(this),$scope.setLoaded=function(cscope){var loadingFinished;for(cscope.$emit("hide:loader",cscope),cscope.isLoaded=!0,loadingFinished=!0;cscope;)cscope.hasOwnProperty("scopeLoaded")&&($scope.areScopesLoaded(cscope)?cscope.scopeLoaded=!0:loadingFinished=!1),cscope=cscope.$parent;loadingFinished&&$rootScope.$broadcast("loading:finished")},$scope.setLoadedAndShowError=function(scope,err,error_string){return $log.warn(err,error_string),scope.setLoaded(scope),err&&409===err.status?AlertService.danger(ErrorService.getError("ITEM_NO_LONGER_AVAILABLE")):err&&err.data&&"Number of Bookings exceeds the maximum"===err.data.error?AlertService.danger(ErrorService.getError("MAXIMUM_TICKETS")):AlertService.danger(ErrorService.getError("GENERIC"))},$scope.areScopesLoaded=function(cscope){var child;if(cscope.hasOwnProperty("isLoaded")&&!cscope.isLoaded)return!1;for(child=cscope.$$childHead;child;){if(!$scope.areScopesLoaded(child))return!1;child=child.$$nextSibling}return!0},$scope.notLoaded=function(cscope){for($scope.$emit("show:loader",$scope),cscope.isLoaded=!1;cscope;)cscope.hasOwnProperty("scopeLoaded")&&(cscope.scopeLoaded=!1),cscope=cscope.$parent},$scope.broadcastItemUpdate=function(_this){return function(){return $scope.$broadcast("currentItemUpdate",$scope.bb.current_item)}}(this),$scope.hidePage=function(){return $scope.hide_page=!0},$scope.bb.company_set=function(){return null!=$scope.bb.company_id},$scope.isAdmin=function(){return $scope.bb.isAdmin},$scope.isAdminIFrame=function(){var err,error,location;if(!$scope.bb.isAdmin)return!1;try{return location=$window.parent.location.href,!(!location||!$window.parent.reload_dashboard)}catch(error){return err=error,!1}},$scope.reloadDashboard=function(){return $window.parent.reload_dashboard()},$scope.$debounce=function(tim){return $scope._debouncing?!1:(tim||(tim=100),$scope._debouncing=!0,$timeout(function(){return $scope._debouncing=!1},tim))},$scope.supportsTouch=function(){return Modernizr.touch},$rootScope.$on("show:loader",function(){return $scope.loading=!0}),$rootScope.$on("hide:loader",function(){return $scope.loading=!1}),$scope.isMemberLoggedIn=function(){return LoginService.isLoggedIn()},$scope.scrollTo=function(id){return $location.hash(id),$anchorScroll()},$scope.redirectTo=function(url){return $window.location.href=url}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbMiniBasket",function(){return{restrict:"AE",replace:!0,scope:!0,controller:function($scope,$rootScope,BasketService,$q){return $scope.controller="public.controllers.MiniBasket",$scope.setUsingBasket(!0)}}}),angular.module("BB.Directives").directive("bbBasketList",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"BasketList"}}),angular.module("BB.Controllers").controller("BasketList",function($scope,$element,$attrs,$rootScope,BasketService,$q,AlertService,FormDataStoreService,LoginService){return $scope.controller="public.controllers.BasketList",$scope.setUsingBasket(!0),$scope.show_wallet=$scope.bb.company_settings.hasOwnProperty("has_wallets")&&$scope.bb.company_settings.has_wallets&&$scope.client.valid()&&LoginService.isLoggedIn()&&LoginService.member().id===$scope.client.id&&$scope.client.has_active_wallet,$scope.bb.basket.setSettings($scope.$eval($attrs.bbBasketList||{})),$rootScope.connection_started.then(function(){var basket_item,i,len,params,promises,ref;if($scope.client&&$scope.bb.basket.setClient($scope.client),$scope.client.$has("pre_paid_bookings")&&$scope.bb.basket.timeItems().length>0){for($scope.notLoaded($scope),promises=[],ref=$scope.bb.basket.timeItems(),i=0,len=ref.length;len>i;i++)basket_item=ref[i],params={event_id:basket_item.getEventId()},promises.push($scope.client.getPrePaidBookingsPromise(params));
return $q.all(promises).then(function(result){var booking_left,index,j,k,l,len1,len2,len3,len4,m,prepaid_booking,prepaid_bookings,ref1;for(booking_left={},j=0,len1=result.length;len1>j;j++)for(basket_item=result[j],k=0,len2=basket_item.length;len2>k;k++)prepaid_booking=basket_item[k],booking_left[prepaid_booking.id]=prepaid_booking.number_of_bookings_remaining;for(ref1=$scope.bb.basket.timeItems(),index=l=0,len3=ref1.length;len3>l;index=++l)if(basket_item=ref1[index],prepaid_bookings=result[index],$scope.bb.basket.settings&&$scope.bb.basket.settings.auto_use_prepaid_bookings&&prepaid_bookings.length>0&&basket_item.price>0)for(index=m=0,len4=prepaid_bookings.length;len4>m;index=++m)if(prepaid_booking=prepaid_bookings[index],booking_left[prepaid_booking.id]>0){basket_item.setPrepaidBooking(prepaid_booking),booking_left[prepaid_booking.id]-=1;break}return $scope.updateBasket().then(function(){return $scope.setLoaded($scope)})},function(err){return $scope.setLoaded($scope)})}}),$scope.addAnother=function(_this){return function(route){return $scope.clearBasketItem(),$scope.bb.emptyStackedItems(),$scope.bb.current_item.setCompany($scope.bb.company),$scope.restart()}}(this),$scope.checkout=function(_this){return function(route){return $scope.bb.basket.settings&&$scope.bb.basket.settings.requires_deal&&!$scope.bb.basket.hasDeal()?(AlertService.raise("GIFT_CERTIFICATE_REQUIRED"),!1):$scope.bb.basket.items.length>0?($scope.setReadyToCheckout(!0),$scope.$parent.$has_page_control?!0:$scope.decideNextPage(route)):(AlertService.raise("EMPTY_BASKET_FOR_CHECKOUT"),!1)}}(this),$scope.setReady=function(){return $scope.checkout()},$scope.applyCoupon=function(_this){return function(coupon){var params;return AlertService.clear(),$scope.notLoaded($scope),params={bb:$scope.bb,coupon:coupon},BasketService.applyCoupon($scope.bb.company,params).then(function(basket){var i,item,len,ref;for(ref=basket.items,i=0,len=ref.length;len>i;i++)item=ref[i],item.storeDefaults($scope.bb.item_defaults),item.reserve_without_questions=$scope.bb.reserve_without_questions;return basket.setSettings($scope.bb.basket.settings),$scope.setBasket(basket),$scope.setLoaded($scope)},function(err){return err&&err.data&&err.data.error&&(AlertService.clear(),AlertService.add("danger",{msg:err.data.error})),$scope.setLoaded($scope)})}}(this),$scope.applyDeal=function(_this){return function(deal_code){var params;return AlertService.clear(),params=$scope.client?{bb:$scope.bb,deal_code:deal_code,member_id:$scope.client.id}:{bb:$scope.bb,deal_code:deal_code,member_id:null},BasketService.applyDeal($scope.bb.company,params).then(function(basket){var i,item,len,ref;for(ref=basket.items,i=0,len=ref.length;len>i;i++)item=ref[i],item.storeDefaults($scope.bb.item_defaults),item.reserve_without_questions=$scope.bb.reserve_without_questions;return basket.setSettings($scope.bb.basket.settings),$scope.setBasket(basket),$scope.items=$scope.bb.basket.items,$scope.deal_code=null},function(err){return err&&err.data&&err.data.error?(AlertService.clear(),AlertService.add("danger",{msg:err.data.error})):void 0})}}(this),$scope.removeDeal=function(_this){return function(deal_code){var params;return params={bb:$scope.bb,deal_code_id:deal_code.id},BasketService.removeDeal($scope.bb.company,params).then(function(basket){var i,item,len,ref;for(ref=basket.items,i=0,len=ref.length;len>i;i++)item=ref[i],item.storeDefaults($scope.bb.item_defaults),item.reserve_without_questions=$scope.bb.reserve_without_questions;return basket.setSettings($scope.bb.basket.settings),$scope.setBasket(basket),$scope.items=$scope.bb.basket.items},function(err){return err&&err.data&&err.data.error?(AlertService.clear(),AlertService.add("danger",{msg:err.data.error})):void 0})}}(this),$scope.topUpWallet=function(){return $scope.decideNextPage("basket_wallet")}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbBulkPurchases",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"BulkPurchase"}}),angular.module("BB.Controllers").controller("BulkPurchase",function($scope,$rootScope,BulkPurchaseService){return $scope.controller="public.controllers.BulkPurchase",$rootScope.connection_started.then(function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0}),$scope.init=function(company){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),BulkPurchaseService.query(company).then(function(bulk_purchases){return $scope.bulk_purchases=bulk_purchases})},$scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope.bulk_purchase=item,!1):($scope.booking_item.setBulkPurchase(item),$scope.decideNextPage(route),!0)},$scope.setReady=function(_this){return function(){return $scope.bulk_purchase?($scope.booking_item.setBulkPurchase($scope.bulk_purchase),!0):!1}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbCategories",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CategoryList"}}),angular.module("BB.Controllers").controller("CategoryList",function($scope,$rootScope,CategoryService,$q,PageControllerService){return $scope.controller="public.controllers.CategoryList",$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),$rootScope.connection_started.then(function(_this){return function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(_this){return function(comp){return CategoryService.query(comp).then(function(items){return $scope.items=items,1===items.length&&($scope.skipThisStep(),$rootScope.categories=items,$scope.selectItem(items[0],$scope.nextRoute)),$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),$scope.selectItem=function(_this){return function(item,route){return $scope.bb.current_item.setCategory(item),$scope.decideNextPage(route)}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbCheckout",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Checkout"}}),angular.module("BB.Controllers").controller("Checkout",function($scope,$rootScope,$attrs,BasketService,$q,$location,$window,$bbug,FormDataStoreService,$timeout){return $scope.controller="public.controllers.Checkout",$scope.notLoaded($scope),$scope.options=$scope.$eval($attrs.bbCheckout)||{},FormDataStoreService.destroy($scope),$rootScope.connection_started.then(function(_this){return function(){return $scope.bb.basket.setClient($scope.client),$scope.options.no_notifications&&($scope.bb.no_notifications=$scope.options.no_notifications),$scope.loadingTotal=BasketService.checkout($scope.bb.company,$scope.bb.basket,{bb:$scope.bb}),$scope.loadingTotal.then(function(total){return $scope.total=total,total.$has("new_payment")||($scope.$emit("checkout:success",total),$scope.bb.total=$scope.total,$scope.bb.payment_status="complete",$scope.options.disable_confirmation?$scope.reset():($scope.skipThisStep(),$scope.decideNextPage())),$scope.checkoutSuccess=!0,$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong"),$scope.checkoutFailed=!0,$scope.$emit("checkout:fail",err)})}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.print=function(_this){return function(){return $window.open($scope.bb.partial_url+"print_purchase.html?id="+$scope.total.long_id,"_blank","width=700,height=500,toolbar=0,menubar=0,location=0,status=1,scrollbars=1,resizable=1,left=0,top=0"),!0}}(this),$scope.printElement=function(id,stylesheet){var data,mywindow;return data=$bbug("#"+id).html(),mywindow=$window.open("","","height=600,width=800"),$timeout(function(){return mywindow.document.write("<html><head><title>Booking Confirmation</title>"),stylesheet&&mywindow.document.write('<link rel="stylesheet" href="'+stylesheet+'" type="text/css" />'),mywindow.document.write("</head><body>"),mywindow.document.write(data),mywindow.document.write("</body></html>"),$timeout(function(){return mywindow.document.close(),mywindow.focus(),mywindow.print(),mywindow.close()},100)},2e3)}})}.call(this),function(){angular.module("BB.Directives").directive("bbClientDetails",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"ClientDetails"}}),angular.module("BB.Controllers").controller("ClientDetails",function($scope,$attrs,$rootScope,ClientDetailsService,ClientService,LoginService,BBModel,ValidatorService,QuestionService,AlertService){var handleError,options;return $scope.controller="public.controllers.ClientDetails",$scope.notLoaded($scope),$scope.validator=ValidatorService,$scope.existing_member=!1,$scope.login_error=!1,options=$scope.$eval($attrs.bbClientDetails)||{},$scope.suppress_client_create=null!=$attrs.bbSuppressCreate||options.suppress_client_create,$rootScope.connection_started.then(function(_this){return function(){return!$scope.client.valid()&&LoginService.isLoggedIn()&&$scope.setClient(new BBModel.Client(LoginService.member()._data)),LoginService.isLoggedIn()&&LoginService.member().$has("child_clients")&&LoginService.member()&&LoginService.member().getChildClientsPromise().then(function(children){return $scope.bb.parent_client=new BBModel.Client(LoginService.member()._data),$scope.bb.child_clients=children,$scope.bb.basket.parent_client_id=$scope.bb.parent_client.id}),$scope.client.client_details?($scope.client_details=$scope.client.client_details,$scope.client_details.questions&&QuestionService.checkConditionalQuestions($scope.client_details.questions),$scope.setLoaded($scope)):ClientDetailsService.query($scope.bb.company).then(function(details){return $scope.client_details=details,$scope.client&&$scope.client.pre_fill_answers($scope.client_details),$scope.client_details.questions&&QuestionService.checkConditionalQuestions($scope.client_details.questions),$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$rootScope.$watch("member",function(_this){return function(oldmem,newmem){return!$scope.client.valid()&&LoginService.isLoggedIn()?$scope.setClient(new BBModel.Client(LoginService.member()._data)):void 0}}(this)),$scope.validateClient=function(_this){return function(client_form,route){return $scope.notLoaded($scope),$scope.existing_member=!1,$scope.bb&&$scope.bb.parent_client&&($scope.client.parent_client_id=$scope.bb.parent_client.id),$scope.client.setClientDetails($scope.client_details),ClientService.create_or_update($scope.bb.company,$scope.client).then(function(client){return $scope.setLoaded($scope),$scope.setClient(client),$scope.bb.isAdmin&&$scope.client.setValid(!0),$scope.existing_member=!1,$scope.decideNextPage(route)},function(err){return handleError(err)})}}(this),$scope.clientLogin=function(_this){return function(){return $scope.login_error=!1,$scope.login?LoginService.companyLogin($scope.bb.company,{},{email:$scope.login.email,password:$scope.login.password}).then(function(client){return $scope.setClient(new BBModel.Client(client)),$scope.login_error=!1,$scope.decideNextPage()},function(err){return $scope.login_error=!0,$scope.setLoaded($scope),AlertService.raise("LOGIN_FAILED")}):void 0}}(this),$scope.setReady=function(_this){return function(){var prom;return $scope.client.setClientDetails($scope.client_details),$scope.suppress_client_create?!0:(prom=ClientService.create_or_update($scope.bb.company,$scope.client),prom.then(function(client){return $scope.setLoaded($scope),$scope.setClient(client),client.waitingQuestions?client.gotQuestions.then(function(){return $scope.client_details=client.client_details}):void 0},function(err){return handleError(err)}),prom)}}(this),$scope.clientSearch=function(){return null!=$scope.client&&null!=$scope.client.email&&""!==$scope.client.email?($scope.notLoaded($scope),ClientService.query_by_email($scope.bb.company,$scope.client.email).then(function(client){return null!=client&&($scope.setClient(client),$scope.client=client),$scope.setLoaded($scope)},function(err){return $scope.setLoaded($scope)})):($scope.setClient({}),$scope.client={})},$scope.switchNumber=function(to){return $scope.no_mobile=!$scope.no_mobile,"mobile"===to?($scope.bb.basket.setSettings({send_sms_reminder:!0}),$scope.client.phone=null):($scope.bb.basket.setSettings({send_sms_reminder:!1}),$scope.client.mobile=null)},$scope.getQuestion=function(id){var i,len,question,ref;for(ref=$scope.client_details.questions,i=0,len=ref.length;len>i;i++)if(question=ref[i],question.id===id)return question;return null},$scope.useClient=function(client){return $scope.setClient(client)},$scope.recalc_question=function(){return $scope.client_details.questions?QuestionService.checkConditionalQuestions($scope.client_details.questions):void 0},handleError=function(error){return"Please Login"===error.data.error?($scope.existing_member=!0,AlertService.raise("ALREADY_REGISTERED")):"Invalid Password"===error.data.error&&AlertService.raise("PASSWORD_INVALID"),$scope.setLoaded($scope)}})}.call(this),function(){"use strict";var CompanyListBase;CompanyListBase=function($scope,$rootScope,$q,$attrs){var options;return $scope.controller="public.controllers.CompanyList",$scope.notLoaded($scope),options=$scope.$eval($attrs.bbCompanies),$rootScope.connection_started.then(function(_this){return function(){return $scope.bb.company.companies?($scope.init($scope.bb.company),$rootScope.parent_id=$scope.bb.company.id):$rootScope.parent_id?void $scope.initWidget({company_id:$rootScope.parent_id,first_page:$scope.bb.current_page}):$scope.init($scope.bb.company)}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(_this){return function(comp){return $scope.companies=$scope.bb.company.companies,$scope.companies&&0!==$scope.companies.length||($scope.companies=[$scope.bb.company]),1===$scope.companies.length?($scope.skipThisStep(),$scope.selectItem($scope.companies[0])):options&&options.hide_not_live_stores?$scope.items=$scope.companies.filter(function(c){return c.live}):$scope.items=$scope.companies,$scope.setLoaded($scope)}}(this),$scope.selectItem=function(_this){return function(item,route){var company_id,prms;return company_id=angular.isNumber(item)?item:item.id,$scope.notLoaded($scope),prms={company_id:company_id},$scope.initWidget(prms)}}(this),$scope.splitString=function(company){var arr,result;return arr=company.name.split(" "),result=arr[2]?arr[2]:""}},angular.module("BB.Directives").directive("bbCompanies",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CompanyList"}}),angular.module("BB.Controllers").controller("CompanyList",CompanyListBase),angular.module("BB.Directives").directive("bbPostcodeLookup",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PostcodeLookup"}}),angular.module("BB.Controllers").controller("PostcodeLookup",function($scope,$rootScope,$q,ValidatorService,AlertService,$attrs){return $scope.controller="PostcodeLookup",angular.extend(this,new CompanyListBase($scope,$rootScope,$q,$attrs)),$scope.validator=ValidatorService,$scope.searchPostcode=function(_this){return function(form,prms){var promise;return $scope.notLoaded($scope),promise=ValidatorService.validatePostcode(form,prms),promise?promise.then(function(){var loc;return $scope.bb.postcode=ValidatorService.getGeocodeResult().address_components[0].short_name,$scope.postcode=$scope.bb.postcode,loc=ValidatorService.getGeocodeResult().geometry.location,$scope.selectItem($scope.getNearestCompany({center:loc}))},function(err){return $scope.setLoaded($scope)}):$scope.setLoaded($scope)}}(this),$scope.getNearestCompany=function(_this){return function(arg){var R,a,c,center,chLat,chLon,company,d,dLat,dLon,distances,i,lat1,lat2,latlong,len,lon1,lon2,pi,rLat1,rLat2,ref;for(center=arg.center,pi=Math.PI,R=6371,distances=[],lat1=center.lat(),lon1=center.lng(),ref=$scope.items,i=0,len=ref.length;len>i;i++)company=ref[i],company.address.lat&&company.address["long"]&&company.live&&(latlong=new google.maps.LatLng(company.address.lat,company.address["long"]),lat2=latlong.lat(),lon2=latlong.lng(),chLat=lat2-lat1,chLon=lon2-lon1,dLat=chLat*(pi/180),dLon=chLon*(pi/180),rLat1=lat1*(pi/180),rLat2=lat2*(pi/180),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(rLat1)*Math.cos(rLat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c,company.distance=d,distances.push(company)),distances.sort(function(a,b){return a.distance-b.distance});return distances[0]}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbCustomBookingText",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CustomBookingText"}}),angular.module("BB.Controllers").controller("CustomBookingText",function($scope,$rootScope,CustomTextService,$q){return $scope.controller="public.controllers.CustomBookingText",$scope.notLoaded($scope),$rootScope.connection_started.then(function(_this){return function(){return CustomTextService.BookingText($scope.bb.company,$scope.bb.current_item).then(function(msgs){return $scope.messages=msgs,$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}),angular.module("BB.Directives").directive("bbCustomConfirmationText",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"CustomConfirmationText"}}),angular.module("BB.Controllers").controller("CustomConfirmationText",function($scope,$rootScope,CustomTextService,$q,PageControllerService){return $scope.controller="public.controllers.CustomConfirmationText",$scope.notLoaded($scope),$rootScope.connection_started.then(function(){return $scope.loadData()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.loadData=function(_this){return function(){return $scope.total?CustomTextService.confirmationText($scope.bb.company,$scope.total).then(function(msgs){return $scope.messages=msgs,$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}):$scope.loadingTotal?$scope.loadingTotal.then(function(total){return CustomTextService.confirmationText($scope.bb.company,total).then(function(msgs){return $scope.messages=msgs,$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}):$scope.setLoaded($scope)}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbMonthAvailability",function(){return{restrict:"A",replace:!0,scope:!0,controller:"DayList"}}),angular.module("BB.Controllers").controller("DayList",function($scope,$rootScope,$q,DayService,AlertService){return $scope.controller="public.controllers.DayList",$scope.notLoaded($scope),$scope.WeekHeaders=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],$scope.day_data={},$scope.type||($scope.type="month"),$scope.data_source||($scope.data_source=$scope.bb.current_item),$rootScope.connection_started.then(function(_this){return function(){return!$scope.current_date&&$scope.last_selected_date?$scope.current_date=$scope.last_selected_date.startOf($scope.type):$scope.current_date||($scope.current_date=moment().startOf($scope.type)),$scope.loadData()}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.$on("currentItemUpdate",function(event){return $scope.loadData()}),$scope.setCalType=function(_this){return function(type){return $scope.type=type}}(this),$scope.setDataSource=function(_this){return function(source){return $scope.data_source=source}}(this),$scope.format_date=function(_this){return function(fmt){return $scope.current_date?$scope.current_date.format(fmt):void 0}}(this),$scope.format_start_date=function(_this){return function(fmt){return $scope.format_date(fmt)}}(this),$scope.format_end_date=function(_this){return function(fmt){return $scope.end_date?$scope.end_date.format(fmt):void 0}}(this),$scope.selectDay=function(_this){return function(day,route,force){return 0!==day.spaces||force?($scope.setLastSelectedDate(day.date),$scope.bb.current_item.setDate(day),$scope.$parent.$has_page_control?void 0:$scope.decideNextPage(route)):!1}}(this),$scope.setMonth=function(_this){return function(month,year){return $scope.current_date=moment().startOf("month").year(year).month(month-1),$scope.current_date.year(),$scope.type="month"}}(this),$scope.setWeek=function(_this){return function(week,year){return $scope.current_date=moment().year(year).isoWeek(week).startOf("week"),$scope.current_date.year(),$scope.type="week"}}(this),$scope.add=function(_this){return function(type,amount){return $scope.current_date.add(amount,type),$scope.loadData()}}(this),$scope.subtract=function(_this){return function(type,amount){return $scope.add(type,-amount)}}(this),$scope.isPast=function(_this){return function(){return $scope.current_date?moment().isAfter($scope.current_date):!0}}(this),$scope.loadData=function(_this){return function(){return"week"===$scope.type?$scope.loadWeek():$scope.loadMonth()}}(this),$scope.loadMonth=function(_this){return function(){var date,edate;return date=$scope.current_date,$scope.month=date.month(),$scope.notLoaded($scope),edate=moment(date).add(1,"months"),$scope.end_date=moment(edate).add(-1,"days"),$scope.data_source?DayService.query({company:$scope.bb.company,cItem:$scope.data_source,month:date.format("MMYY"),client:$scope.client}).then(function(days){var d,day,i,j,k,len,w,week,weeks;for($scope.days=days,i=0,len=days.length;len>i;i++)day=days[i],$scope.day_data[day.string_date]=day;for(weeks=[],w=j=0;5>=j;w=++j){for(week=[],d=k=0;6>=k;d=++k)week.push(days[7*w+d]);weeks.push(week)}return $scope.weeks=weeks,$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}):$scope.setLoaded($scope)}}(this),$scope.loadWeek=function(_this){return function(){var date,edate;return date=$scope.current_date,$scope.notLoaded($scope),edate=moment(date).add(7,"days"),$scope.end_date=moment(edate).add(-1,"days"),$scope.data_source?DayService.query({company:$scope.bb.company,cItem:$scope.data_source,date:date.toISODate(),edate:edate.toISODate(),client:$scope.client}).then(function(days){var day,i,len;for($scope.days=days,i=0,len=days.length;len>i;i++)day=days[i],$scope.day_data[day.string_date]=day;return $scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}):$scope.setLoaded($scope)}}(this),$scope.setReady=function(_this){return function(){return $scope.bb.current_item.date?!0:(AlertService.clear(),AlertService.add("danger",{msg:"You need to select a date"}),!1)}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbDeals",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"DealList"}}),angular.module("BB.Controllers").controller("DealList",function($scope,$rootScope,DealService,$q,BBModel,AlertService,FormDataStoreService,ValidatorService,$modal){var ModalInstanceCtrl,init;return $scope.controller="public.controllers.DealList",FormDataStoreService.init("TimeRangeList",$scope,["deals"]),$rootScope.connection_started.then(function(){return init()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),init=function(){var deal_promise;return $scope.notLoaded($scope),$scope.deals?void 0:(deal_promise=DealService.query($scope.bb.company),deal_promise.then(function(deals){return $scope.deals=deals,$scope.setLoaded($scope)}))},$scope.selectDeal=function(deal){var iitem,modalInstance;return iitem=new BBModel.BasketItem(null,$scope.bb),iitem.setDefaults($scope.bb.item_defaults),iitem.setDeal(deal),$scope.bb.company_settings.no_recipient?($scope.notLoaded($scope),$scope.setBasketItem(iitem),$scope.addItemToBasket().then(function(){return $scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):(modalInstance=$modal.open({templateUrl:$scope.getPartial("_add_recipient"),scope:$scope,controller:ModalInstanceCtrl,resolve:{item:function(){return iitem}}}),modalInstance.result.then(function(item){return $scope.notLoaded($scope),$scope.setBasketItem(item),$scope.addItemToBasket().then(function(){return $scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}))},ModalInstanceCtrl=function($scope,$modalInstance,item,ValidatorService){return $scope.controller="ModalInstanceCtrl",$scope.item=item,$scope.recipient=!1,$scope.addToBasket=function(form){return ValidatorService.validateForm(form)?$modalInstance.close($scope.item):void 0},$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},$scope.purchaseDeals=function(){return $scope.bb.basket.items&&$scope.bb.basket.items.length>0?$scope.decideNextPage():AlertService.add("danger",{msg:"You need to select at least one Gift Certificate to continue"})},$scope.setReady=function(){return $scope.bb.basket.items&&$scope.bb.basket.items.length>0?!0:AlertService.add("danger",{msg:"You need to select at least one Gift Certificate to continue"})}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbDurations",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"DurationList"}}),angular.module("BB.Controllers").controller("DurationList",function($scope,$attrs,$rootScope,PageControllerService,$q,AlertService,$filter){var options;return $scope.controller="public.controllers.DurationList",$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),options=$scope.$eval($attrs.bbDurations)||{},$rootScope.connection_started.then(function(){return $scope.loadData()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.loadData=function(_this){return function(){var d,duration,i,id,initial_duration,len,ref,service;if(id=$scope.bb.company_id,service=$scope.bb.current_item.service,service&&!$scope.durations){for($scope.durations=function(){var i,len,ref,results;for(ref=_.zip(service.durations,service.prices),results=[],i=0,len=ref.length;len>i;i++)d=ref[i],results.push({value:d[0],price:d[1]});return results}(),initial_duration=$scope.$eval($attrs.bbInitialDuration),ref=$scope.durations,i=0,len=ref.length;len>i;i++)duration=ref[i],$scope.bb.current_item.duration&&duration.value===$scope.bb.current_item.duration?$scope.duration=duration:initial_duration&&initial_duration===duration.value&&($scope.duration=duration,$scope.bb.current_item.setDuration(duration.value)),duration.pretty=$filter("time_period")(duration.value),options.show_prices&&(duration.pretty+=" ("+$filter("currency")(duration.price)+")");1===$scope.durations.length&&($scope.skipThisStep(),$scope.selectDuration($scope.durations[0],$scope.nextRoute))}return $scope.setLoaded($scope)}}(this),$scope.selectDuration=function(_this){return function(dur,route){return $scope.$parent.$has_page_control?void($scope.duration=dur):($scope.bb.current_item.setDuration(dur.value),$scope.decideNextPage(route),!0)}}(this),$scope.durationChanged=function(_this){return function(){return $scope.bb.current_item.setDuration($scope.duration.value),$scope.broadcastItemUpdate()}}(this),$scope.setReady=function(_this){return function(){return $scope.duration?($scope.bb.current_item.setDuration($scope.duration.value),!0):(AlertService.clear(),AlertService.add("danger",{msg:"You need to select a duration"}),!1)}}(this),$scope.$on("currentItemUpdate",function(event){return $scope.loadData()})})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbEvent",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Event"}}),angular.module("BB.Controllers").controller("Event",function($scope,$attrs,$rootScope,EventService,$q,PageControllerService,BBModel,ValidatorService,FormDataStoreService){var init,initImage,initTickets;return $scope.controller="public.controllers.Event",$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),$scope.validator=ValidatorService,$scope.event_options=$scope.$eval($attrs.bbEvent)||{},FormDataStoreService.init("ItemDetails",$scope,["selected_tickets","event_options"]),$rootScope.connection_started.then(function(){return $scope.bb.company?init($scope.bb.company):void 0},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),init=function(comp){var promises;return $scope.bb.stacked_items&&0===$scope.bb.stacked_items.length&&delete $scope.selected_tickets,$scope.event=$scope.bb.current_item.event,$scope.event_options.use_my_details=null==$scope.event_options.use_my_details?!0:$scope.event_options.use_my_details,promises=[$scope.current_item.event_group.getImagesPromise(),$scope.event.prepEvent()],$scope.client&&promises.push($scope.getPrePaidsForEvent($scope.client,$scope.event)),$q.all(promises).then(function(result){var event,images,prepaids;return result[0]&&result[0].length>0&&(images=result[0]),event=result[1],result[2]&&result[2].length>0&&(prepaids=result[2]),$scope.event=event,images&&initImage(images),initTickets(),$scope.$broadcast("bbEvent:initialised"),$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},$scope.selectTickets=function(){var base_item,c,i,item,j,len,ref,ref1,ticket;for($scope.notLoaded($scope),$scope.bb.emptyStackedItems(),base_item=$scope.current_item,ref=$scope.event.tickets,i=0,len=ref.length;len>i;i++)if(ticket=ref[i],ticket.qty)switch($scope.event.chain.ticket_type){case"single_space":for(c=j=1,ref1=ticket.qty;ref1>=1?ref1>=j:j>=ref1;c=ref1>=1?++j:--j)item=new BBModel.BasketItem,angular.extend(item,base_item),delete item.id,item.tickets=angular.copy(ticket),item.tickets.qty=1,$scope.bb.stackItem(item);break;case"multi_space":item=new BBModel.BasketItem,angular.extend(item,base_item),item.tickets=angular.copy(ticket),delete item.id,item.tickets.qty=ticket.qty,$scope.bb.stackItem(item)}return 0===$scope.bb.stacked_items.length?void $scope.setLoaded($scope):($scope.bb.pushStackToBasket(),$scope.updateBasket().then(function(_this){return function(){return $scope.setLoaded($scope),$scope.selected_tickets=!0,$scope.stopTicketWatch(),$scope.tickets=function(){var k,len1,ref2,results;for(ref2=$scope.bb.basket.items,results=[],k=0,len1=ref2.length;len1>k;k++)item=ref2[k],results.push(item.tickets);return results}(),$scope.$watch("bb.basket.items",function(items,olditems){return $scope.bb.basket.total_price=$scope.bb.basket.totalPrice(),item.tickets.price=item.totalPrice()},!0)}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}))},$scope.selectItem=function(_this){return function(item,route){return $scope.$parent.$has_page_control?($scope.event=item,!1):($scope.bb.current_item.setEvent(item),$scope.bb.current_item.ready=!1,$scope.decideNextPage(route),!0)}}(this),$scope.setReady=function(_this){return function(){return $scope.bb.current_item.setEvent($scope.event),$scope.bb.event_details={name:$scope.event.chain.name,image:$scope.event.image,address:$scope.event.chain.address,datetime:$scope.event.date,end_datetime:$scope.event.end_datetime,duration:$scope.event.duration,tickets:$scope.event.tickets},$scope.event_options.suppress_basket_update?!0:$scope.updateBasket()}}(this),$scope.getPrePaidsForEvent=function(client,event){var defer,params;return defer=$q.defer(),params={event_id:event.id},client.getPrePaidBookingsPromise(params).then(function(prepaids){
return $scope.pre_paid_bookings=prepaids,defer.resolve(prepaids)},function(err){return defer.reject(err)}),defer.promise},initImage=function(images){var image;return image=images[0],image?(image.background_css={"background-image":"url("+image.url+")"},$scope.event.image=image):void 0},initTickets=function(){var i,len,ref,ticket;if(!$scope.selected_tickets){if($scope.event.tickets[0].qty=$scope.event_options.default_num_tickets?$scope.event_options.default_num_tickets:0,$scope.event.tickets.length>1)for(ref=$scope.event.tickets.slice(1),i=0,len=ref.length;len>i;i++)ticket=ref[i],ticket.qty=0;return $scope.event_options.default_num_tickets&&$scope.event_options.auto_select_tickets&&1===$scope.event.tickets.length&&1===$scope.event.tickets[0].max_num_bookings&&$scope.selectTickets(),$scope.tickets=$scope.event.tickets,$scope.bb.basket.total_price=$scope.bb.basket.totalPrice(),$scope.stopTicketWatch=$scope.$watch("tickets",function(tickets,oldtickets){return $scope.bb.basket.total_price=$scope.bb.basket.totalPrice(),$scope.event.updatePrice()},!0)}}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbEventGroups",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"EventGroupList",link:function(scope,element,attrs){attrs.bbItem&&(scope.booking_item=scope.$eval(attrs.bbItem)),attrs.bbShowAll&&(scope.show_all=!0)}}}),angular.module("BB.Controllers").controller("EventGroupList",function($scope,$rootScope,$q,$attrs,ItemService,FormDataStoreService,ValidatorService,PageControllerService,halClient){var setEventGroupItem;return $scope.controller="public.controllers.EventGroupList",FormDataStoreService.init("EventGroupList",$scope,["event_group"]),$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),$scope.validator=ValidatorService,$rootScope.connection_started.then(function(_this){return function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(comp){var ppromise;return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),ppromise=comp.getEventGroupsPromise(),ppromise.then(function(items){var filterItems,i,item,j,len,len1;if(filterItems="false"!==$attrs.filterServices,filterItems&&($scope.booking_item.service_ref&&!$scope.show_all?items=items.filter(function(x){return x.api_ref===$scope.booking_item.service_ref}):$scope.booking_item.category&&!$scope.show_all&&(items=items.filter(function(x){return x.$has("category")&&x.$href("category")===$scope.booking_item.category.self}))),1!==items.length||$scope.allowSinglePick?setEventGroupItem(items):$scope.selectItem(items[0],$scope.nextRoute)?$scope.skipThisStep():setEventGroupItem(items),$scope.booking_item.defaultService())for(i=0,len=items.length;len>i;i++)item=items[i],item.self===$scope.booking_item.defaultService().self&&$scope.selectItem(item,$scope.nextRoute);if($scope.booking_item.event_group)for(j=0,len1=items.length;len1>j;j++)item=items[j],item.selected=!1,item.self===$scope.booking_item.event_group.self&&($scope.event_group=item,item.selected=!0,$scope.booking_item.setEventGroup($scope.event_group));return $scope.setLoaded($scope),$scope.booking_item.event_group||!$scope.booking_item.person&&!$scope.booking_item.resource?$scope.bookable_services=$scope.items:void 0},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},setEventGroupItem=function(items){return $scope.items=items,$scope.event_group?_.each(items,function(item){return item.id===$scope.event_group.id?$scope.event_group=item:void 0}):void 0},$scope.selectItem=function(_this){return function(item,route){return $scope.$parent.$has_page_control?($scope.event_group=item,!1):($scope.booking_item.setEventGroup(item),$scope.decideNextPage(route),!0)}}(this),$scope.$watch("event_group",function(_this){return function(newval,oldval){return!$scope.event_group||$scope.booking_item.event_group&&$scope.booking_item.event_group.self===$scope.event_group.self?void 0:($scope.booking_item.setEventGroup($scope.event_group),$scope.broadcastItemUpdate())}}(this)),$scope.setReady=function(_this){return function(){return $scope.event_group?($scope.booking_item.setEventGroup($scope.event_group),!0):!1}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbEvents",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"EventList",link:function(scope,element,attrs){var options;scope.summary=null!=attrs.summary,options=scope.$eval(attrs.bbEvents)||{},scope.mode=options&&options.mode?options.mode:0,scope.summary&&(scope.mode=0)}}}),angular.module("BB.Controllers").controller("EventList",function($scope,$rootScope,EventService,EventChainService,$q,PageControllerService,FormDataStoreService,$filter,PaginationService,$timeout){var buildDynamicFilters,filterEventsWithDynamicFilters,sort;return $scope.controller="public.controllers.EventList",$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),$scope.pick={},$scope.start_date=moment(),$scope.end_date=moment().add(1,"year"),$scope.filters={},$scope.pagination=PaginationService.initialise({page_size:10,max_size:5}),$scope.events={},$scope.fully_booked=!1,FormDataStoreService.init("EventList",$scope,["selected_date","event_group_id","event_group_manually_set"]),$rootScope.connection_started.then(function(){if($scope.bb.company){if(!$scope.bb.item_defaults.event)return $scope.bb.company.$has("parent")&&!$scope.bb.company.$has("company_questions")?$scope.bb.company.getParentPromise().then(function(parent){return $scope.company_parent=parent,$scope.initialise()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}):$scope.initialise();$scope.skipThisStep(),$scope.decideNextPage()}},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.initialise=function(){var event_group,promises;return $scope.notLoaded($scope),0!==$scope.mode&&delete $scope.selected_date,$scope.event_group_manually_set||null!=$scope.current_item.event_group||($scope.event_group_manually_set=null==$scope.event_group_manually_set&&null!=$scope.current_item.event_group),$scope.bb.current_item.event&&(event_group=$scope.current_item.event_group,$scope.clearBasketItem(),$scope.emptyBasket(),$scope.event_group_manually_set&&$scope.current_item.setEventGroup(event_group)),promises=[],$scope.bb.company.$has("company_questions")?promises.push($scope.bb.company.getCompanyQuestionsPromise()):null!=$scope.company_parent&&$scope.company_parent.$has("company_questions")?promises.push($scope.company_parent.getCompanyQuestionsPromise()):(promises.push($q.when([])),$scope.has_company_questions=!1),!$scope.current_item.event_group&&$scope.bb.company.$has("event_groups")?promises.push($scope.bb.company.getEventGroupsPromise()):promises.push($q.when([])),0===$scope.mode||2===$scope.mode?promises.push($scope.loadEventSummary()):promises.push($q.when([])),1===$scope.mode||2===$scope.mode?promises.push($scope.loadEventData()):promises.push($q.when([])),$q.all(promises).then(function(result){var company_questions,event_data,event_groups,event_groups_collection,event_summary,item,j,len,ref;if(company_questions=result[0],event_groups=result[1],event_summary=result[2],event_data=result[3],$scope.has_company_questions=null!=company_questions&&company_questions.length>0,company_questions&&buildDynamicFilters(company_questions),$scope.event_groups=event_groups,event_groups_collection=_.indexBy(event_groups,"id"),$scope.items)for(ref=$scope.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.group=event_groups_collection[item.service_id];return $scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},$scope.loadEventSummary=function(){var comp,current_event,deferred,params;return deferred=$q.defer(),current_event=$scope.current_item.event,$scope.bb.current_item&&($scope.bb.current_item.event_chain_id||$scope.bb.current_item.event_chain)&&(delete $scope.bb.current_item.event_chain,delete $scope.bb.current_item.event_chain_id),comp=$scope.bb.company,params={item:$scope.bb.current_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate()},$scope.bb.item_defaults.event_chain&&(params.event_chain_id=$scope.bb.item_defaults.event_chain),EventService.summary(comp,params).then(function(items){var d,item,item_dates,j,len;if(items&&items.length>0){for(item_dates=[],j=0,len=items.length;len>j;j++)item=items[j],d=moment(item),item_dates.push({date:d,idate:parseInt(d.format("YYYYDDDD")),count:1,spaces:1});$scope.item_dates=item_dates.sort(function(a,b){return a.idate-b.idate}),0===$scope.mode&&($scope.selected_date&&($scope.selected_date.isAfter($scope.item_dates[0].date)||$scope.selected_date.isSame($scope.item_dates[0].date))&&($scope.selected_date.isBefore($scope.item_dates[$scope.item_dates.length-1].date)||$scope.selected_date.isSame($scope.item_dates[$scope.item_dates.length-1].date))?$scope.showDay($scope.selected_date):$scope.showDay($scope.item_dates[0].date))}return deferred.resolve($scope.item_dates)},function(err){return deferred.reject()}),deferred.promise},$scope.loadEventChainData=function(comp){var deferred,params;return deferred=$q.defer(),$scope.bb.item_defaults.event_chain?deferred.resolve([]):($scope.notLoaded($scope),comp||(comp=$scope.bb.company),params={item:$scope.bb.current_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate()},EventChainService.query(comp,params).then(function(event_chains){return $scope.setLoaded($scope),deferred.resolve(event_chains)},function(err){return deferred.reject()})),deferred.promise},$scope.loadEventData=function(comp){var chains,current_event,deferred,params;return 0===$scope.mode&&delete $scope.items,deferred=$q.defer(),current_event=$scope.current_item.event,$scope.notLoaded($scope),comp||(comp=$scope.bb.company),$scope.bb.current_item&&($scope.bb.current_item.event_chain_id||$scope.bb.current_item.event_chain)&&(delete $scope.bb.current_item.event_chain,delete $scope.bb.current_item.event_chain_id),params={item:$scope.bb.current_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate()},$scope.bb.item_defaults.event_chain&&(params.event_chain_id=$scope.bb.item_defaults.event_chain),chains=$scope.loadEventChainData(comp),$scope.events={},EventService.query(comp,params).then(function(events){var item,j,len,ref;for($scope.items=_.flatten(events),ref=$scope.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.spaces_left=item.getSpacesLeft();return $scope.bb.company.getAddressPromise().then(function(address){var k,len1,ref1,results;for(ref1=$scope.items,results=[],k=0,len1=ref1.length;len1>k;k++)item=ref1[k],results.push(item.address=address);return results}),chains.then(function(){var idate,item_dates,k,l,len1,len2,ref1,x,y;for(ref1=$scope.items,k=0,len1=ref1.length;len1>k;k++)item=ref1[k],item.prepEvent(),0===$scope.mode&&current_event&&current_event.self===item.self&&(item.select(),$scope.event=item);if(1===$scope.mode)if(item_dates={},items.length>0){for(l=0,len2=items.length;len2>l;l++)item=items[l],item.getDuration(),idate=parseInt(item.date.format("YYYYDDDD")),item.idate=idate,item_dates[idate]||(item_dates[idate]={date:item.date,idate:idate,count:0,spaces:0}),item_dates[idate].count+=1,item_dates[idate].spaces+=item.num_spaces;$scope.item_dates=[];for(x in item_dates)y=item_dates[x],$scope.item_dates.push(y);$scope.item_dates=$scope.item_dates.sort(function(a,b){return a.idate-b.idate})}else idate=parseInt($scope.start_date.format("YYYYDDDD")),$scope.item_dates=[{date:$scope.start_date,idate:idate,count:0,spaces:0}];return $scope.isFullyBooked(),$scope.filtered_items=$scope.items,$scope.filterChanged(),PaginationService.update($scope.pagination,$scope.filtered_items.length),$scope.setLoaded($scope),deferred.resolve($scope.items)},function(err){return deferred.reject()})},function(err){return deferred.reject()}),deferred.promise},$scope.isFullyBooked=function(){var full_events,item,j,len,ref;for(full_events=[],ref=$scope.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.num_spaces===item.spaces_booked&&full_events.push(item);return full_events.length===$scope.items.length?$scope.fully_booked=!0:void 0},$scope.showDay=function(date){var new_date;if(moment.isMoment(date))return 0===$scope.mode?($scope.event&&!$scope.selected_date.isSame(date,"day")&&delete $scope.event,new_date=date,$scope.start_date=moment(date),$scope.end_date=moment(date),$scope.loadEventData()):$scope.selected_date&&date.isSame($scope.selected_date,"day")||(new_date=date),new_date?($scope.selected_date=new_date,$scope.filters.date=new_date.toDate()):(delete $scope.selected_date,delete $scope.filters.date),$scope.filterChanged()},$scope.$watch("pick.date",function(_this){return function(new_val,old_val){return new_val?($scope.start_date=moment(new_val),$scope.end_date=moment(new_val),$scope.loadEventData()):void 0}}(this)),$scope.selectItem=function(_this){return function(item,route){var i,j,len,ref;if(!(item.getSpacesLeft()<=0&&$scope.bb.company.settings.has_waitlists||item.hasSpace()))return!1;if($scope.notLoaded($scope),$scope.$parent.$has_page_control)return $scope.event&&$scope.event.unselect(),$scope.event=item,$scope.event.select(),$scope.setLoaded($scope),!1;if($scope.bb.moving_purchase)for(ref=$scope.bb.basket.items,j=0,len=ref.length;len>j;j++)i=ref[j],i.setEvent(item);return $scope.bb.current_item.setEvent(item),$scope.bb.current_item.ready=!1,$q.all($scope.bb.current_item.promises).then(function(){return $scope.decideNextPage(route)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),!0}}(this),$scope.setReady=function(){return $scope.event?($scope.bb.current_item.setEvent($scope.event),!0):!1},$scope.filterEvents=function(item){var result;return result=(item.date.isSame(moment($scope.filters.date),"day")||null==$scope.filters.date)&&($scope.filters.event_group&&item.service_id===$scope.filters.event_group.id||null==$scope.filters.event_group)&&(null!=$scope.filters.price&&item.price_range.from<=$scope.filters.price||null==$scope.filters.price)&&($scope.filters.hide_sold_out_events&&0!==item.getSpacesLeft()||!$scope.filters.hide_sold_out_events)&&filterEventsWithDynamicFilters(item)},filterEventsWithDynamicFilters=function(item){var dynamic_filter,filter,i,j,k,l,len,len1,len2,len3,m,name,ref,ref1,ref2,ref3,result,type;if(!$scope.has_company_questions||!$scope.dynamic_filters)return!0;for(result=!0,ref=$scope.dynamic_filters.question_types,j=0,len=ref.length;len>j;j++)if(type=ref[j],"check"===type)for(ref1=$scope.dynamic_filters.check,k=0,len1=ref1.length;len1>k;k++){if(dynamic_filter=ref1[k],name=dynamic_filter.name.parameterise("_"),filter=!1,item.chain&&item.chain.extra[name])for(ref2=item.chain.extra[name],l=0,len2=ref2.length;len2>l&&(i=ref2[l],!(filter=$scope.dynamic_filters.values[dynamic_filter.name]&&i===$scope.dynamic_filters.values[dynamic_filter.name].name||null==$scope.dynamic_filters.values[dynamic_filter.name]));l++);else void 0!==item.chain.extra[name]||!_.isEmpty($scope.dynamic_filters.values)&&null!=$scope.dynamic_filters.values[dynamic_filter.name]||(filter=!0);result=result&&filter}else for(ref3=$scope.dynamic_filters[type],m=0,len3=ref3.length;len3>m;m++)dynamic_filter=ref3[m],name=dynamic_filter.name.parameterise("_"),filter=$scope.dynamic_filters.values[dynamic_filter.name]&&item.chain.extra[name]===$scope.dynamic_filters.values[dynamic_filter.name].name||null==$scope.dynamic_filters.values[dynamic_filter.name],result=result&&filter;return result},$scope.filterDateChanged=function(options){var date;return null==options&&(options={reset:!1}),$scope.filters.date&&(date=moment($scope.filters.date),$scope.$broadcast("event_list_filter_date:changed",date),$scope.showDay(date),options.reset===!0||null==$scope.selected_date)?$timeout(function(){return delete $scope.filters.date},250):void 0},$scope.resetFilters=function(){return $scope.filters={},$scope.has_company_questions&&($scope.dynamic_filters.values={}),$scope.filterChanged()},buildDynamicFilters=function(questions){return $scope.dynamic_filters=_.groupBy(questions,"question_type"),$scope.dynamic_filters.question_types=_.uniq(_.pluck(questions,"question_type")),$scope.dynamic_filters.values={}},sort=function(){},$scope.filterChanged=function(){return $scope.items?($scope.filtered_items=$filter("filter")($scope.items,$scope.filterEvents),$scope.pagination.num_items=$scope.filtered_items.length,$scope.filter_active=$scope.filtered_items.length!==$scope.items.length,PaginationService.update($scope.pagination,$scope.filtered_items.length)):void 0},$scope.pageChanged=function(){return PaginationService.update($scope.pagination,$scope.filtered_items.length),$rootScope.$broadcast("page:changed")}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbGetAvailability",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"GetAvailability",link:function(scope,element,attrs){attrs.bbGetAvailability&&scope.loadAvailability(scope.$eval(attrs.bbGetAvailability))}}}),angular.module("BB.Controllers").controller("GetAvailability",function($scope,$element,$attrs,$rootScope,$q,TimeService,AlertService,BBModel,halClient){return $scope.loadAvailability=function(_this){return function(prms){var service;return service=halClient.$get($scope.bb.api_url+"/api/v1/"+prms.company_id+"/services/"+prms.service),service.then(function(serv){var eday,sday;return $scope.earliest_day=null,sday=moment(),eday=moment().add(30,"days"),serv.$get("days",{date:sday.toISOString(),edate:eday.toISOString()}).then(function(res){var day,i,len,ref,results;for(ref=res.days,results=[],i=0,len=ref.length;len>i;i++)day=ref[i],day.spaces>0&&!$scope.earliest_day?($scope.earliest_day=moment(day.date),day.first?results.push($scope.earliest_day.add(day.first,"minutes")):results.push(void 0)):results.push(void 0);return results})})}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbItemDetails",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"ItemDetails",link:function(scope,element,attrs){var item;attrs.bbItemDetails&&(item=scope.$eval(attrs.bbItemDetails),scope.item_from_param=item,scope.item_details&&delete scope.item_details,scope.loadItem(item))}}}),angular.module("BB.Controllers").controller("ItemDetails",function($scope,$attrs,$rootScope,ItemDetailsService,PurchaseBookingService,AlertService,BBModel,FormDataStoreService,ValidatorService,QuestionService,$modal,$location,$upload,$translate,SettingsService,PurchaseService){var confirming,setItemDetails;return $scope.controller="public.controllers.ItemDetails",$scope.suppress_basket_update=null!=$attrs.bbSuppressBasketUpdate,$scope.item_details_id=$scope.$eval($attrs.bbSuppressBasketUpdate),$scope.suppress_basket_update?FormDataStoreService.init("ItemDetails"+$scope.item_details_id,$scope,["item_details"]):FormDataStoreService.init("ItemDetails",$scope,["item_details"]),QuestionService.addAnswersByName($scope.client,["first_name","last_name","email","mobile"]),$scope.validator=ValidatorService,confirming=!1,$rootScope.connection_started.then(function(){return confirming?void 0:$scope.loadItem($scope.bb.current_item)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.loadItem=function(item){var params;return $scope.notLoaded($scope),confirming=!0,$scope.item=item,$scope.bb.private_note&&($scope.item.private_note=$scope.bb.private_note),$scope.product=item.product,$scope.item.item_details?(setItemDetails($scope.item.item_details),QuestionService.addDynamicAnswersByName($scope.item_details.questions),$scope.bb.item_defaults.answers&&QuestionService.addAnswersFromDefaults($scope.item_details.questions,$scope.bb.item_defaults.answers),$scope.recalc_price(),$scope.setLoaded($scope),$scope.$emit("item_details:loaded",$scope.item_details)):(params={company:$scope.bb.company,cItem:$scope.item},ItemDetailsService.query(params).then(function(details){return details&&(setItemDetails(details),$scope.item.item_details=$scope.item_details,QuestionService.addDynamicAnswersByName($scope.item_details.questions),$scope.bb.item_defaults.answers&&QuestionService.addAnswersFromDefaults($scope.item_details.questions,$scope.bb.item_defaults.answers),$scope.recalc_price(),$scope.$emit("item_details:loaded",$scope.item_details)),$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}))},setItemDetails=function(details){var oldQuestions;return $scope.item&&$scope.item.defaults&&_.each(details.questions,function(item){var n;return n="q_"+item.name,$scope.item.defaults[n]?item.answer=$scope.item.defaults[n]:void 0}),$scope.hasOwnProperty("item_details")&&(oldQuestions=$scope.item_details.questions,_.each(details.questions,function(item){var search;return search=_.findWhere(oldQuestions,{name:item.name}),search?item.answer=search.answer:void 0})),$scope.item_details=details},$scope.$on("currentItemUpdate",function(event){return $scope.item_from_param?$scope.loadItem($scope.item_from_param):$scope.loadItem($scope.bb.current_item)}),$scope.recalc_price=function(){var bprice,qprice;return qprice=$scope.item_details.questionPrice($scope.item.getQty()),bprice=$scope.item.base_price,$scope.item.setPrice(qprice+bprice)},$scope.confirm=function(form,route){return ValidatorService.validateForm(form)?$scope.bb.moving_booking?$scope.confirm_move(form,route):($scope.item.setAskedQuestions(),$scope.$parent.$has_page_control?!0:$scope.item.ready?($scope.notLoaded($scope),$scope.addItemToBasket().then(function(){return $scope.setLoaded($scope),$scope.decideNextPage(route)},function(err){return $scope.setLoaded($scope)})):$scope.decideNextPage(route)):void 0},$scope.setReady=function(_this){return function(){return $scope.item.setAskedQuestions(),$scope.item.ready&&!$scope.suppress_basket_update?$scope.addItemToBasket():!0}}(this),$scope.confirm_move=function(route){var params;return confirming=!0,$scope.item||($scope.item=$scope.bb.current_item),$scope.item.moved_booking=!1,$scope.item.setAskedQuestions(),$scope.item.ready?($scope.notLoaded($scope),$scope.bb.moving_purchase?(params={purchase:$scope.bb.moving_purchase,bookings:$scope.bb.basket.items},PurchaseService.update(params).then(function(purchase){return $scope.bb.purchase=purchase,$scope.bb.purchase.getBookingsPromise().then(function(bookings){return $scope.purchase=purchase,$scope.setLoaded($scope),$scope.item.move_done=!0,$scope.item.moved_booking=!0,$rootScope.$broadcast("booking:moved"),$scope.decideNextPage(route),$scope.showMoveMessage(bookings[0].datetime)})},function(err){return $scope.setLoaded($scope),AlertService.add("danger",{msg:"Failed to move booking. Please try again."})})):PurchaseBookingService.update($scope.item).then(function(booking){var _i,b,i,len,oldb,ref;if(b=new BBModel.Purchase.Booking(booking),$scope.bb.purchase)for(ref=$scope.bb.purchase.bookings,_i=i=0,len=ref.length;len>i;_i=++i)oldb=ref[_i],oldb.id===b.id&&($scope.bb.purchase.bookings[_i]=b);return $scope.setLoaded($scope),$scope.item.move_done=!0,$rootScope.$broadcast("booking:moved"),$scope.decideNextPage(route),$scope.showMoveMessage(b.datetime)},function(_this){return function(err){return $scope.setLoaded($scope),AlertService.add("danger",{msg:"Failed to move booking. Please try again."})}}(this))):$scope.decideNextPage(route)},$scope.showMoveMessage=function(datetime){return SettingsService.isInternationalizatonEnabled()?$translate("MOVE_BOOKINGS_MSG",{datetime:datetime.format("LLLL")}).then(function(translated_text){return AlertService.add("info",{msg:translated_text})}):AlertService.add("info",{msg:"Your booking has been moved to "+datetime.format("LLLL")})},$scope.openTermsAndConditions=function(){var modalInstance;return modalInstance=$modal.open({templateUrl:$scope.getPartial("terms_and_conditions"),scope:$scope})},$scope.getQuestion=function(id){var i,len,question,ref;for(ref=$scope.item_details.questions,i=0,len=ref.length;len>i;i++)if(question=ref[i],question.id===id)return question;return null},$scope.updateItem=function(){return $scope.item.setAskedQuestions(),$scope.item.ready?($scope.notLoaded($scope),PurchaseBookingService.update($scope.item).then(function(booking){var _i,b,i,len,oldb,ref;if(b=new BBModel.Purchase.Booking(booking),$scope.bookings)for(ref=$scope.bookings,_i=i=0,len=ref.length;len>i;_i=++i)oldb=ref[_i],oldb.id===b.id&&($scope.bookings[_i]=b);return $scope.purchase.bookings=$scope.bookings,$scope.item_details_updated=!0,$scope.setLoaded($scope)},function(_this){return function(err){return $scope.setLoaded($scope)}}(this))):void 0},$scope.editItem=function(){return $scope.item_details_updated=!1},$scope.onFileSelect=function(item,$file,existing){var att_id,file,method,url;return $scope.upload_progress=0,file=$file,att_id=null,existing&&(att_id=existing),method="POST",att_id&&(method="PUT"),url=item.$href("add_attachment"),$scope.upload=$upload.upload({url:url,method:method,data:{attachment_id:att_id},file:file}).progress(function(evt){return $scope.upload_progress<100?$scope.upload_progress=parseInt(99*evt.loaded/evt.total):void 0}).success(function(data,status,headers,config){return $scope.upload_progress=100,data&&item?(item.attachment=data,item.attachment_id=data.id):void 0})}})}.call(this),function(){angular.module("BB.Directives").directive("bbLogin",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Login"}}),angular.module("BB.Controllers").controller("Login",function($scope,$rootScope,LoginService,$q,ValidatorService,BBModel,$location,AlertService){return $scope.controller="public.controllers.Login",$scope.validator=ValidatorService,$scope.login_form={},$scope.login_sso=function(token,route){return $rootScope.connection_started.then(function(_this){return function(){return LoginService.ssoLogin({company_id:$scope.bb.company.id,root:$scope.bb.api_url},{token:token}).then(function(member){return route?$scope.showPage(route):void 0},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},$scope.login_with_password=function(email,password){return LoginService.companyLogin($scope.bb.company,{},{email:email,password:password}).then(function(_this){return function(member){return $scope.member=new BBModel.Member.Member(member)}}(this),function(_this){return function(err){return AlertService.raise("LOGIN_FAILED")}}(this))},$scope.showEmailPasswordReset=function(_this){return function(){return $scope.showPage("email_reset_password")}}(this),$scope.isLoggedIn=function(){return LoginService.isLoggedIn()},$scope.sendPasswordReset=function(email){return LoginService.sendPasswordReset($scope.bb.company,{email:email,custom:!0}).then(function(){return AlertService.raise("PASSWORD_RESET_REQ_SUCCESS")},function(_this){return function(err){return AlertService.raise("PASSWORD_RESET_REQ_FAILED")}}(this))},$scope.updatePassword=function(new_password,confirm_new_password){return AlertService.clear(),$rootScope.member&&new_password&&confirm_new_password&&new_password===confirm_new_password?LoginService.updatePassword($rootScope.member,{new_password:new_password,confirm_new_password:confirm_new_password,persist_login:$scope.login_form.persist_login}).then(function(_this){return function(member){return member?($scope.setClient(member),$scope.password_updated=!0,AlertService.raise("PASSWORD_RESET_SUCESS")):void 0}}(this),function(_this){return function(err){return $scope.error=err,AlertService.raise("PASSWORD_RESET_FAILED")}}(this)):AlertService.raise("PASSWORD_MISMATCH")}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbMap",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"MapCtrl"}}),angular.module("BB.Controllers").controller("MapCtrl",function($scope,$element,$attrs,$rootScope,AlertService,FormDataStoreService,$q,$window,$timeout){var checkDataStore,geolocateFail,map_ready_def,options,reverseGeocode,searchFailed,searchPlaces,searchSuccess;return $scope.controller="public.controllers.MapCtrl",FormDataStoreService.init("MapCtrl",$scope,["address","selectedStore","search_prms"]),options=$scope.$eval($attrs.bbMap)||{},map_ready_def=$q.defer(),$scope.mapLoaded=$q.defer(),$scope.mapReady=map_ready_def.promise,$scope.map_init=$scope.mapLoaded.promise,$scope.numSearchResults=options.num_search_results||6,$scope.range_limit=options.range_limit||1/0,$scope.showAllMarkers=!1,$scope.mapMarkers=[],$scope.shownMarkers=$scope.shownMarkers||[],$scope.numberedPin||($scope.numberedPin=null),$scope.defaultPin||($scope.defaultPin=null),$scope.hide_not_live_stores=null!=options.hide_not_live_stores?options.hide_not_live_stores:!1,!$scope.address&&$attrs.bbAddress&&($scope.address=$scope.$eval($attrs.bbAddress)),$scope.error_msg=options.error_msg||"You need to select a store",$scope.notLoaded($scope),webshim.setOptions({waitReady:!1,loadStyles:!1}),webshim.polyfill("geolocation"),$rootScope.connection_started.then(function(){var comp,i,key,latlong,len,ref,ref1,value;if($scope.selectedStore||$scope.setLoaded($scope),!$scope.bb.company.companies)return $rootScope.parent_id?void $scope.initWidget({company_id:$rootScope.parent_id,first_page:$scope.bb.current_page,keep_basket:!0}):void $scope.initWidget({company_id:$scope.bb.company.id,first_page:null});for($rootScope.parent_id=$scope.bb.company.id,$scope.companies=$scope.bb.company.companies,$scope.companies&&0!==$scope.companies.length||($scope.companies=[$scope.bb.company]),$scope.mapBounds=new google.maps.LatLngBounds,ref=$scope.companies,i=0,len=ref.length;len>i;i++)comp=ref[i],comp.address&&comp.address.lat&&comp.address["long"]&&(latlong=new google.maps.LatLng(comp.address.lat,comp.address["long"]),$scope.mapBounds.extend(latlong));if($scope.mapOptions={center:$scope.mapBounds.getCenter(),zoom:6,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,mapTypeControlOptions:{style:window.google.maps.MapTypeControlStyle.DROPDOWN_MENU}},options&&options.map_options){ref1=options.map_options;for(key in ref1)value=ref1[key],$scope.mapOptions[key]=value}return map_ready_def.resolve(!0)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.map_init.then(function(){var comp,i,latlong,len,marker,ref;for(ref=$scope.companies,i=0,len=ref.length;len>i;i++)comp=ref[i],comp.address&&comp.address.lat&&comp.address["long"]&&(latlong=new google.maps.LatLng(comp.address.lat,comp.address["long"]),marker=new google.maps.Marker({map:$scope.myMap,position:latlong,visible:$scope.showAllMarkers,icon:$scope.defaultPin}),marker.company=comp,$scope.hide_not_live_stores&&!comp.live||$scope.mapMarkers.push(marker));return $timeout(function(){return $scope.myMap.fitBounds($scope.mapBounds),$scope.myMap.setZoom(15)}),checkDataStore()}),$scope.init=function(options){return options?$scope.hide_not_live_stores=options.hide_not_live_stores:void 0},checkDataStore=function(){return $scope.selectedStore?($scope.notLoaded($scope),$scope.search_prms?$scope.searchAddress($scope.search_prms):$scope.geolocate(),google.maps.event.addListenerOnce($scope.myMap,"idle",function(){return _.each($scope.mapMarkers,function(marker){return $scope.selectedStore.id===marker.company.id?google.maps.event.trigger(marker,"click"):void 0})})):void 0},$scope.title=function(){var ci,p1;return ci=$scope.bb.current_item,p1=ci.category&&ci.category.description?ci.category.description:$scope.bb.company.extra.department,p1+" - "+$scope.$eval("getCurrentStepTitle()")},$scope.searchAddress=function(prms){return $scope.reverse_geocode_address&&$scope.reverse_geocode_address===$scope.address?!1:(delete $scope.geocoder_result,
prms||(prms={}),$scope.search_prms=prms,$scope.map_init.then(function(){var address,ne,req,sw;return address=$scope.address,prms.address&&(address=prms.address),address?(req={address:address},prms.region&&(req.region=prms.region),prms.componentRestrictions&&(req.componentRestrictions=prms.componentRestrictions),prms.bounds&&(sw=new google.maps.LatLng(prms.bounds.sw.x,prms.bounds.sw.y),ne=new google.maps.LatLng(prms.bounds.ne.x,prms.bounds.ne.y),req.bounds=new google.maps.LatLngBounds(sw,ne)),(new google.maps.Geocoder).geocode(req,function(results,status){return results.length>0&&"OK"===status&&($scope.geocoder_result=results[0]),!$scope.geocoder_result||$scope.geocoder_result&&$scope.geocoder_result.partial_match?void searchPlaces(req):($scope.geocoder_result?searchSuccess($scope.geocoder_result):searchFailed(),$scope.setLoaded($scope))})):void 0}),$scope.setLoaded($scope))},searchPlaces=function(prms){var req,service;return req={query:prms.address,types:["shopping_mall","store","embassy"]},prms.bounds&&(req.bounds=prms.bounds),service=new google.maps.places.PlacesService($scope.myMap),service.textSearch(req,function(results,status){return results.length>0&&"OK"===status?searchSuccess(results[0]):$scope.geocoder_result?searchSuccess($scope.geocoder_result):searchFailed()})},searchSuccess=function(result){return AlertService.clear(),$scope.search_failed=!1,$scope.loc=result.geometry.location,$scope.myMap.setCenter($scope.loc),$scope.myMap.setZoom(15),$scope.showClosestMarkers($scope.loc),$rootScope.$broadcast("map:search_success")},searchFailed=function(){return $scope.search_failed=!0,AlertService.raise("LOCATION_NOT_FOUND"),$rootScope.$apply()},$scope.validateAddress=function(form){return form?form.$error.required?(AlertService.clear(),AlertService.raise("MISSING_LOCATION"),!1):!0:!1},$scope.showClosestMarkers=function(latlong){var R,a,c,chLat,chLon,d,dLat,dLon,distances,distances_kilometres,i,iconPath,index,item,items,j,k,l,lat1,lat2,len,len1,len2,localBounds,lon1,lon2,marker,pi,rLat1,rLat2,ref,ref1;for(pi=Math.PI,R=6371,distances=[],distances_kilometres=[],lat1=latlong.lat(),lon1=latlong.lng(),ref=$scope.mapMarkers,i=0,len=ref.length;len>i;i++)for(marker=ref[i],lat2=marker.position.lat(),lon2=marker.position.lng(),chLat=lat2-lat1,chLon=lon2-lon1,dLat=chLat*(pi/180),dLon=chLon*(pi/180),rLat1=lat1*(pi/180),rLat2=lat2*(pi/180),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(rLat1)*Math.cos(rLat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c,k=d,d=.621371192*d,$scope.showAllMarkers||marker.setVisible(!1),marker.distance=d,marker.distance_kilometres=k,d<$scope.range_limit&&distances.push(marker),k<$scope.range_limit&&distances_kilometres.push(marker),items=[distances,distances_kilometres],j=0,len1=items.length;len1>j;j++)item=items[j],item.sort(function(a,b){return a.distance-b.distance,a.distance_kilometres-b.distance_kilometres});for($scope.shownMarkers=distances.slice(0,$scope.numSearchResults),localBounds=new google.maps.LatLngBounds,localBounds.extend(latlong),index=1,ref1=$scope.shownMarkers,l=0,len2=ref1.length;len2>l;l++)marker=ref1[l],$scope.numberedPin&&(iconPath=$window.sprintf($scope.numberedPin,index),marker.setIcon(iconPath)),marker.setVisible(!0),localBounds.extend(marker.position),index+=1;return $scope.$emit("map:shown_markers_updated",$scope.shownMarkers),google.maps.event.trigger($scope.myMap,"resize"),$scope.myMap.fitBounds(localBounds)},$scope.openMarkerInfo=function(marker){return $scope.currentMarker=marker,$scope.myInfoWindow.open($scope.myMap,marker)},$scope.selectItem=function(item,route){return $scope.$debounce(1e3)?item?($scope.notLoaded($scope),$scope.selectedStore&&$scope.selectedStore.id!==item.id&&$scope.$emit("change:storeLocation"),$scope.selectedStore=item,$scope.initWidget({company_id:item.id,first_page:route})):void AlertService.warning({msg:$scope.error_msg}):void 0},$scope.roundNumberUp=function(num,places){return Math.round(num*Math.pow(10,places))/Math.pow(10,places)},$scope.geolocate=function(){return!navigator.geolocation||$scope.reverse_geocode_address&&$scope.reverse_geocode_address===$scope.address?!1:($scope.notLoaded($scope),webshim.ready("geolocation",function(){return options={timeout:5e3,maximumAge:36e5},navigator.geolocation.getCurrentPosition(reverseGeocode,geolocateFail,options)}))},geolocateFail=function(error){switch(error.code){case 2:case 3:$scope.setLoaded($scope),AlertService.raise("GEOLOCATION_ERROR");break;default:$scope.setLoaded($scope)}return $scope.$apply()},reverseGeocode=function(position){var lat,latlng,long;return lat=parseFloat(position.coords.latitude),long=parseFloat(position.coords.longitude),latlng=new google.maps.LatLng(lat,long),(new google.maps.Geocoder).geocode({latLng:latlng},function(results,status){var ac,i,len,ref;if(results.length>0&&"OK"===status){for($scope.geocoder_result=results[0],ref=$scope.geocoder_result.address_components,i=0,len=ref.length;len>i;i++)ac=ref[i],ac.types.indexOf("route")>=0&&($scope.reverse_geocode_address=ac.long_name),ac.types.indexOf("locality")>=0&&($scope.reverse_geocode_address+=", "+ac.long_name),$scope.address=$scope.reverse_geocode_address;searchSuccess($scope.geocoder_result)}return $scope.setLoaded($scope)})},$scope.increaseRange=function(){return $scope.range_limit=1/0,$scope.searchAddress($scope.search_prms)},$scope.$watch("display.xs",function(_this){return function(new_value,old_value){return new_value!==old_value&&$scope.loc?($scope.myInfoWindow.close(),$scope.myMap.setCenter($scope.loc),$scope.myMap.setZoom(15),$scope.showClosestMarkers($scope.loc)):void 0}}(this)),$rootScope.$on("widget:restart",function(){return $scope.loc=null,$scope.reverse_geocode_address=null,$scope.address=null})})}.call(this),function(){angular.module("BB.Directives").directive("bbMembershipLevels",function($rootScope,MembershipLevelsService){var controller;return controller=function($scope,$element,$attrs){var checkClientDefaults;return $rootScope.connection_started.then(function(){return $scope.initialise()}),$scope.initialise=function(){return $scope.bb.company&&$scope.bb.company.$has("member_levels")?($scope.notLoaded($scope),MembershipLevelsService.getMembershipLevels($scope.bb.company).then(function(member_levels){return $scope.setLoaded($scope),$scope.membership_levels=member_levels},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):void 0},$scope.selectMemberLevel=function(level){return level&&$scope.client&&($scope.client.member_level_id=level.id,!$scope.$parent.$has_page_control)?$scope.decideNextPage():void 0},checkClientDefaults=function(){var i,len,membership_level,ref,results;if($scope.bb.client_defaults.membership_ref){for(ref=$scope.membership_levels,results=[],i=0,len=ref.length;len>i;i++)membership_level=ref[i],membership_level.name===$scope.bb.client_defaults.membership_ref?results.push($scope.selectMemberLevel(membership_level)):results.push(void 0);return results}},$scope.setReady=function(){return!!$scope.client.member_level_id},$scope.getMembershipLevel=function(member_level_id){return _.find($scope.membership_levels,function(level){return level.id===member_level_id})}}})}.call(this),function(){"use strict";var hasProp={}.hasOwnProperty;angular.module("BB.Directives").directive("bbMultiServiceSelect",function(){return{restrict:"AE",scope:!0,controller:"MultiServiceSelect"}}),angular.module("BB.Controllers").controller("MultiServiceSelect",function($scope,$rootScope,$q,$attrs,BBModel,AlertService,CategoryService,FormDataStoreService,$modal){var checkItemDefaults,initialise,initialiseCategories;return FormDataStoreService.init("MultiServiceSelect",$scope,["selected_category_name"]),$scope.options=$scope.$eval($attrs.bbMultiServiceSelect)||{},$scope.options.max_services=$scope.options.max_services||1/0,$scope.options.ordered_categories=$scope.options.ordered_categories||!1,$scope.options.services=$scope.options.services||"items",$rootScope.connection_started.then(function(){return $scope.bb.company.$has("parent")&&!$scope.bb.company.$has("company_questions")?$scope.bb.company.getParentPromise().then(function(parent){return $scope.company=parent,initialise()}):$scope.company=$scope.bb.company,$scope.$watch($scope.options.services,function(newval,oldval){return newval&&angular.isArray(newval)?($scope.items=newval,initialise()):void 0})}),initialise=function(){var promises;if($scope.items&&$scope.company)return $scope.initialised=!0,promises=[],promises.push(CategoryService.query($scope.bb.company)),$scope.company.$has("company_questions")&&promises.push($scope.company.getCompanyQuestionsPromise()),$q.all(promises).then(function(result){var item,j,k,len,len1,ref,ref1,stacked_item;if($scope.company_questions=result[1],initialiseCategories(result[0]),$scope.bb.stacked_items&&$scope.bb.stacked_items.length>0){for(ref=$scope.bb.stacked_items,j=0,len=ref.length;len>j;j++)for(stacked_item=ref[j],ref1=$scope.items,k=0,len1=ref1.length;len1>k;k++)if(item=ref1[k],item.self===stacked_item.service.self){stacked_item.service=item,stacked_item.service.selected=!0;break}}else checkItemDefaults();return $scope.bb.moving_booking&&$scope.nextStep(),$scope.$broadcast("multi_service_select:loaded"),$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},checkItemDefaults=function(){var j,len,ref,service;if($scope.bb.item_defaults.service)for(ref=$scope.items,j=0,len=ref.length;len>j;j++)if(service=ref[j],service.self===$scope.bb.item_defaults.service.self)return void $scope.addItem(service)},initialiseCategories=function(categories){var all_categories,category,category_details,category_id,grouped_sub_categories,grouped_sub_category,j,k,key,len,len1,results,services,sub_categories,sub_category,value;if($scope.options.ordered_categories)for(j=0,len=categories.length;len>j;j++)category=categories[j],category.order=parseInt(category.name.slice(0,2)),category.name=category.name.slice(3);$scope.all_categories=_.indexBy(categories,"id"),all_categories=_.groupBy($scope.items,function(item){return item.category_id}),sub_categories=_.findWhere($scope.company_questions,{name:"Extra Category"}),sub_categories&&(sub_categories=_.map(sub_categories.question_items,function(sub_category){return sub_category.name})),categories={};for(key in all_categories)hasProp.call(all_categories,key)&&(value=all_categories[key],value.length>0&&(categories[key]=value));$scope.categories=[],results=[];for(category_id in categories){if(services=categories[category_id],category={},grouped_sub_categories=[],sub_categories){for(k=0,len1=sub_categories.length;len1>k;k++)sub_category=sub_categories[k],grouped_sub_category={name:sub_category,services:_.filter(services,function(service){return service.extra.extra_category===sub_category})},grouped_sub_category.services.length>0&&grouped_sub_categories.push(grouped_sub_category);category.sub_categories=grouped_sub_categories}else category.services=services;$scope.all_categories[category_id]&&(category_details={name:$scope.all_categories[category_id].name,description:$scope.all_categories[category_id].description}),category.name=category_details.name,category.description=category_details.description,$scope.options.ordered_categories&&$scope.all_categories[category_id]&&(category.order=$scope.all_categories[category_id].order),$scope.categories.push(category),$scope.selected_category_name&&$scope.selected_category_name===category_details.name?results.push($scope.selected_category=$scope.categories[$scope.categories.length-1]):$scope.bb.item_defaults.category&&$scope.bb.item_defaults.category.name===category_details.name&&!$scope.selected_category?($scope.selected_category=$scope.categories[$scope.categories.length-1],results.push($scope.selected_category_name=$scope.selected_category.name)):results.push(void 0)}return results},$scope.changeCategory=function(category_name,services){return category_name&&services?($scope.selected_category={name:category_name,sub_categories:services},$scope.selected_category_name=$scope.selected_category.name,$rootScope.$broadcast("multi_service_select:category_changed")):void 0},$scope.changeCategoryName=function(){return $scope.selected_category_name=$scope.selected_category.name,$rootScope.$broadcast("multi_service_select:category_changed")},$scope.addItem=function(item,duration){var i,iitem,j,len,ref,results;if(!($scope.bb.stacked_items.length<$scope.options.max_services)){for(ref=$scope.items,results=[],j=0,len=ref.length;len>j;j++)i=ref[j],i.popover="Sorry, you can only book a maximum of "+$scope.options.max_services+" treatments",results.push(i.popoverText=i.popover);return results}return $scope.bb.clearStackedItemsDateTime(),item.selected=!0,iitem=new BBModel.BasketItem(null,$scope.bb),iitem.setDefaults($scope.bb.item_defaults),iitem.setService(item),duration&&iitem.setDuration(duration),iitem.setGroup(item.group),$scope.bb.stackItem(iitem),$rootScope.$broadcast("multi_service_select:item_added"),$scope.options.raise_alerts?AlertService.info({msg:item.name+" added to your treatment selection",persist:!1}):void 0},$scope.removeItem=function(item,options){var i,j,len,ref,results;for(item.selected=!1,options&&"BasketItem"===options.type?$scope.bb.deleteStackedItem(item):$scope.bb.deleteStackedItemByService(item),$scope.bb.clearStackedItemsDateTime(),$rootScope.$broadcast("multi_service_select:item_removed"),ref=$scope.items,results=[],j=0,len=ref.length;len>j;j++){if(i=ref[j],i.self===item.self){i.selected=!1;break}results.push(void 0)}return results},$scope.removeStackedItem=function(item){return $scope.removeItem(item,{type:"BasketItem"})},$scope.nextStep=function(){return $scope.bb.stacked_items.length>1?$scope.decideNextPage():1===$scope.bb.stacked_items.length?($scope.bb.basket&&$scope.bb.basket.items.length>0&&$scope.quickEmptybasket({preserve_stacked_items:!0}),$scope.setBasketItem($scope.bb.stacked_items[0]),$scope.decideNextPage()):(AlertService.clear(),AlertService.add("danger",{msg:"You need to select at least one treatment to continue"}))},$scope.addService=function(){return $rootScope.$broadcast("multi_service_select:add_item")},$scope.setReady=function(){return $scope.bb.stacked_items.length>1?!0:1===$scope.bb.stacked_items.length?($scope.bb.basket&&$scope.bb.basket.items.length>0&&$scope.quickEmptybasket({preserve_stacked_items:!0}),$scope.setBasketItem($scope.bb.stacked_items[0]),!0):(AlertService.clear(),AlertService.add("danger",{msg:"You need to select at least one treatment to continue"}),!1)},$scope.selectDuration=function(service){var modalInstance;return 1===service.durations.length?$scope.addItem(service):(modalInstance=$modal.open({templateUrl:$scope.getPartial("_select_duration_modal"),scope:$scope,controller:function($scope,$modalInstance,service){return $scope.durations=service.durations,$scope.duration=$scope.durations[0],$scope.service=service,$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.setDuration=function(){return $modalInstance.close({service:$scope.service,duration:$scope.duration})}},resolve:{service:function(){return service}}}),modalInstance.result.then(function(result){return $scope.addItem(result.service,result.duration)}))}})}.call(this),function(){"use strict";var hasProp={}.hasOwnProperty;angular.module("BB.Directives").directive("bbTimeRangeStacked",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"TimeRangeListStackedController"}}),angular.module("BB.Controllers").controller("TimeRangeListStackedController",function($scope,$element,$attrs,$rootScope,$q,TimeService,AlertService,BBModel,FormDataStoreService,PersonService,PurchaseService,DateTimeUlititiesService){var isSubtractValid,setEnabledSlots,setTimeRange,spliceExistingDateTimes,updateHideStatus;return $scope.controller="public.controllers.TimeRangeListStacked",FormDataStoreService.init("TimeRangeListStacked",$scope,["selected_slot","original_start_date","start_at_week_start"]),$scope.notLoaded($scope),$scope.available_times=0,$rootScope.connection_started.then(function(){var diff,selected_day,start_date;return $scope.options=$scope.$eval($attrs.bbTimeRangeStacked)||{},$scope.time_range_length||(null!=$attrs.bbTimeRangeLength?$scope.time_range_length=$scope.$eval($attrs.bbTimeRangeLength):$scope.options&&$scope.options.time_range_length?$scope.time_range_length=$scope.options.time_range_length:$scope.time_range_length=7),(null!=$attrs.bbDayOfWeek||$scope.options&&$scope.options.day_of_week)&&($scope.day_of_week=null!=$attrs.bbDayOfWeek?$scope.$eval($attrs.bbDayOfWeek):$scope.options.day_of_week),(null!=$attrs.bbSelectedDay||$scope.options&&$scope.options.selected_day)&&(selected_day=null!=$attrs.bbSelectedDay?moment($scope.$eval($attrs.bbSelectedDay)):moment($scope.options.selected_day),moment.isMoment(selected_day)&&($scope.selected_day=selected_day)),!$scope.start_date&&$scope.last_selected_date?$scope.original_start_date?(diff=$scope.last_selected_date.diff($scope.original_start_date,"days"),diff%=$scope.time_range_length,diff=0===diff?diff:diff+1,start_date=$scope.last_selected_date.clone().subtract(diff,"days"),setTimeRange($scope.last_selected_date,start_date)):setTimeRange($scope.last_selected_date):$scope.bb.stacked_items[0].date?setTimeRange($scope.bb.stacked_items[0].date.date):$scope.selected_day?($scope.original_start_date=$scope.original_start_date||moment($scope.selected_day),setTimeRange($scope.selected_day)):($scope.start_at_week_start=!0,setTimeRange(moment())),$scope.loadData()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),setTimeRange=function(selected_date,start_date){return start_date?$scope.start_date=start_date:$scope.day_of_week?$scope.start_date=selected_date.clone().day($scope.day_of_week):$scope.start_at_week_start?$scope.start_date=selected_date.clone().startOf("week"):$scope.start_date=selected_date.clone(),$scope.selected_day=selected_date,$scope.selected_date=$scope.selected_day.toDate(),isSubtractValid()},$scope.add=function(amount,type){switch($scope.selected_day=moment($scope.selected_date),type){case"days":setTimeRange($scope.selected_day.add(amount,"days"));break;case"weeks":$scope.start_date.add(amount,"weeks"),setTimeRange($scope.start_date)}return $scope.loadData()},$scope.subtract=function(amount,type){return $scope.add(-amount,type)},isSubtractValid=function(){var diff;return $scope.is_subtract_valid=!0,diff=Math.ceil($scope.selected_day.diff(moment(),"day",!0)),$scope.subtract_length=diff<$scope.time_range_length?diff:$scope.time_range_length,0>=diff&&($scope.is_subtract_valid=!1),$scope.subtract_length>1?$scope.subtract_string="Prev "+$scope.subtract_length+" days":1===$scope.subtract_length?$scope.subtract_string="Prev day":$scope.subtract_string="Prev"},$scope.selectedDateChanged=function(){return setTimeRange(moment($scope.selected_date)),$scope.selected_slot=null,$scope.loadData()},updateHideStatus=function(){var day,key,ref,results;ref=$scope.days,results=[];for(key in ref)day=ref[key],results.push($scope.days[key].hide=!day.date.isSame($scope.selected_day,"day"));return results},$scope.isPast=function(){return $scope.start_date?moment().isAfter($scope.start_date):!0},$scope.status=function(day,slot){var status;if(slot)return status=slot.status()},$scope.highlightSlot=function(day,slot){var i,item,len,ref;if(day&&slot&&slot.availability()>0){for($scope.bb.clearStackedItemsDateTime(),$scope.selected_slot&&($scope.selected_slot.selected=!1),$scope.setLastSelectedDate(day.date),$scope.selected_slot=angular.copy(slot),$scope.selected_day=day.date,$scope.selected_date=day.date.toDate(),$scope.$broadcast("slotChanged",day,slot);slot;)for(ref=$scope.bb.stacked_items,i=0,len=ref.length;len>i;i++)if(item=ref[i],item.service.self===slot.service.self&&!item.date&&!item.time){item.setDate(day),item.setTime(slot),slot=slot.next;break}return updateHideStatus(),$rootScope.$broadcast("time:selected")}},$scope.loadData=function(){var edate,grouped_items,i,items,len,pslots;if($scope.notLoaded($scope),$scope.request&&$scope.request.start.twix($scope.request.end).contains($scope.selected_day))return updateHideStatus(),void $scope.setLoaded($scope);for($scope.start_date=moment($scope.start_date),edate=moment($scope.start_date).add($scope.time_range_length,"days"),$scope.end_date=moment(edate).add(-1,"days"),$scope.request={start:moment($scope.start_date),end:moment($scope.end_date)},pslots=[],grouped_items=_.groupBy($scope.bb.stacked_items,function(item){return item.service.id}),grouped_items=_.toArray(grouped_items),i=0,len=grouped_items.length;len>i;i++)items=grouped_items[i],pslots.push(TimeService.query({company:$scope.bb.company,cItem:items[0],date:$scope.start_date,end_date:$scope.end_date,client:$scope.client,available:1}));return $q.all(pslots).then(function(res){var _i,day,item,j,k,l,len1,len2,ref,slots,times,v;for($scope.data_valid=!0,$scope.days={},_i=j=0,len1=grouped_items.length;len1>j;_i=++j)for(items=grouped_items[_i],slots=res[_i],slots&&0!==slots.length||($scope.data_valid=!1),l=0,len2=items.length;len2>l;l++){item=items[l],spliceExistingDateTimes(item,slots),item.slots={};for(day in slots)hasProp.call(slots,day)&&(times=slots[day],item.slots[day]=_.indexBy(times,"time"))}if($scope.data_valid){ref=res[0];for(k in ref)v=ref[k],$scope.days[k]={date:moment(k)};setEnabledSlots(),updateHideStatus(),$rootScope.$broadcast("TimeRangeListStacked:loadFinished"),$scope.$broadcast("dataReloaded")}return $scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},spliceExistingDateTimes=function(stacked_item,slots){var datetime,time,time_slot;if(stacked_item.datetime||stacked_item.date)return datetime=stacked_item.datetime||DateTimeUlititiesService.convertTimeSlotToMoment(stacked_item.date,stacked_item.time),$scope.start_date<=datetime&&$scope.end_date>=datetime?(time=DateTimeUlititiesService.convertMomentToTime(datetime),time_slot=_.findWhere(slots[datetime.toISODate()],{time:time}),time_slot||(time_slot=stacked_item.time,slots[datetime.toISODate()].splice(0,0,time_slot)),time_slot.selected=stacked_item.self===$scope.bb.stacked_items[0].self):void 0},setEnabledSlots=function(){var day,day_data,isSlotValid,ref,results,slot,time;ref=$scope.days,results=[];for(day in ref)day_data=ref[day],day_data.slots={},$scope.bb.stacked_items.length>1?results.push(function(){var ref1,results1;ref1=$scope.bb.stacked_items[0].slots[day],results1=[];for(time in ref1)slot=ref1[time],slot=angular.copy(slot),isSlotValid=function(slot){var duration,i,index,next,ref2,valid;for(valid=!1,time=slot.time,duration=$scope.bb.stacked_items[0].service.duration,next=time+duration,index=i=1,ref2=$scope.bb.stacked_items.length-1;ref2>=1?ref2>=i:i>=ref2;index=ref2>=1?++i:--i){if(_.isEmpty($scope.bb.stacked_items[index].slots[day])||!$scope.bb.stacked_items[index].slots[day][next])return!1;slot.next=angular.copy($scope.bb.stacked_items[index].slots[day][next]),slot=slot.next,next+=$scope.bb.stacked_items[index].service.duration}return!0},isSlotValid(slot)?results1.push(day_data.slots[slot.time]=slot):results1.push(void 0);return results1}()):results.push(function(){var ref1,results1;ref1=$scope.bb.stacked_items[0].slots[day],results1=[];for(time in ref1)slot=ref1[time],results1.push(day_data.slots[slot.time]=slot);return results1}());return results},$scope.pretty_month_title=function(month_format,year_format,seperator){var month_year_format,start_date;return null==seperator&&(seperator="-"),$scope.start_date?(month_year_format=month_format+" "+year_format,$scope.start_date&&$scope.end_date&&$scope.end_date.isAfter($scope.start_date,"month")?(start_date=$scope.start_date.format(month_format),11===$scope.start_date.month()&&(start_date=$scope.start_date.format(month_year_format)),start_date+" "+seperator+" "+$scope.end_date.format(month_year_format)):$scope.start_date.format(month_year_format)):void 0},$scope.confirm=function(route,options){var booking,different,found,i,item,j,l,len,len1,len2,prom,ref,ref1,ref2;for(null==options&&(options={}),ref=$scope.bb.stacked_items,i=0,len=ref.length;len>i;i++)if(item=ref[i],!item.time)return AlertService.add("danger",{msg:"Select a time to continue your booking"}),!1;if(null!=$scope.bb.moving_booking&&null!=$scope.bb.moving_booking.bookings){for(different=!1,ref1=$scope.bb.moving_booking.bookings,j=0,len1=ref1.length;len1>j;j++){for(booking=ref1[j],found=!1,ref2=$scope.bb.stacked_items,l=0,len2=ref2.length;len2>l;l++)item=ref2[l],booking.getDateString()===item.date.string_date&&booking.getTimeInMins()===item.time.time&&booking.category_name===item.category_name&&(found=!0);if(!found){different=!0;break}}if(!different)return AlertService.add("danger",{msg:"Your treatments are already booked for this time."}),!1}return $scope.bb.basket.clear(),$scope.bb.pushStackToBasket(),$scope.bb.moving_booking?($scope.notLoaded($scope),prom=PurchaseService.update({purchase:$scope.bb.moving_booking,bookings:$scope.bb.basket.items}),void prom.then(function(purchase){return purchase.getBookingsPromise().then(function(bookings){var _i,len3,m,oldb,results;for(results=[],m=0,len3=bookings.length;len3>m;m++)booking=bookings[m],$scope.bookings?results.push(function(){var len4,n,ref3,results1;for(ref3=$scope.bookings,results1=[],_i=n=0,len4=ref3.length;len4>n;_i=++n)oldb=ref3[_i],oldb.id===booking.id?results1.push($scope.bookings[_i]=booking):results1.push(void 0);return results1}()):results.push(void 0);return results}),$scope.setLoaded($scope),$scope.bb.current_item.move_done=!0,$scope.decideNextPage()},function(err){return $scope.setLoaded($scope),AlertService.add("danger",{msg:"Failed to move booking"})})):($scope.notLoaded($scope),options.do_not_route?$scope.updateBasket():$scope.updateBasket().then(function(){return $scope.setLoaded($scope),$scope.decideNextPage(route)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}))},$scope.setReady=function(){return $scope.confirm("",{do_not_route:!0})}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbPackageItems",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PackageItem"}}),angular.module("BB.Controllers").controller("PackageItem",function($scope,$rootScope,PackageItemService){return $scope.controller="public.controllers.PackageItem",$rootScope.connection_started.then(function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0}),$scope.init=function(company){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),PackageItemService.query(company).then(function(package_items){return $scope.packages=package_items})},$scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope["package"]=item,!1):($scope.booking_item.setPackageItem(item),$scope.decideNextPage(route),!0)},$scope.setReady=function(){return $scope["package"]?($scope.booking_item.setPackageItem($scope["package"]),!0):!1},$scope.getPackageServices=function(item){var promise;return item&&!item.service_list?(item.service_list=[],promise=PackageItemService.getPackageServices(item),promise.then(function(services){return item.service_list=services}),!0):!1}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbPackagePicker",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PackagePicker"}}),angular.module("BB.Controllers").controller("PackagePicker",function($scope,$rootScope,$q,TimeService,BBModel){return $scope.controller="public.controllers.PackagePicker",$scope.sel_date=moment().add(1,"days"),$scope.selected_date=$scope.sel_date.toDate(),$scope.picked_time=!1,$scope.$watch("selected_date",function(_this){return function(newv,oldv){return $scope.sel_date=moment(newv),$scope.loadDay()}}(this)),$scope.loadDay=function(_this){return function(){var i,item,len,pslots,ref;for($scope.timeSlots=[],$scope.notLoaded($scope),pslots=[],ref=$scope.stackedItems,i=0,len=ref.length;len>i;i++)item=ref[i],pslots.push(TimeService.query({company:$scope.bb.company,cItem:item,date:$scope.sel_date,client:$scope.client}));return $q.all(pslots).then(function(res){var _i,earliest,j,k,l,latest,len1,len2,len3,len4,len5,m,n,next_earliest,next_latest,ref1,ref2,ref3,ref4,ref5,results,slot;for($scope.setLoaded($scope),$scope.data_valid=!0,$scope.timeSlots=[],ref1=$scope.stackedItems,_i=j=0,len1=ref1.length;len1>j;_i=++j)item=ref1[_i],item.slots=res[_i],item.slots&&0!==item.slots.length||($scope.data_valid=!1),item.order=_i;if($scope.data_valid){for($scope.timeSlots=res,earliest=null,ref2=$scope.stackedItems,k=0,len2=ref2.length;len2>k;k++){for(item=ref2[k],next_earliest=null,ref3=item.slots,l=0,len3=ref3.length;len3>l;l++)slot=ref3[l],earliest&&slot.time<earliest?slot.disable():next_earliest||(next_earliest=slot.time+item.service.duration);earliest=next_earliest}for(latest=null,ref4=$scope.bb.stacked_items.slice(0).reverse(),results=[],m=0,len4=ref4.length;len4>m;m++){for(item=ref4[m],next_latest=null,ref5=item.slots,n=0,len5=ref5.length;len5>n;n++)slot=ref5[n],latest&&slot.time>latest?slot.disable():next_latest=slot.time-item.service.duration;results.push(latest=next_latest)}return results}},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),$scope.selectSlot=function(_this){return function(sel_item,slot){var count,current,i,item,j,k,latest,len,len1,len2,next,ref,ref1,slots,time;for(ref=$scope.stackedItems,count=i=0,len=ref.length;len>i;count=++i)if(item=ref[count],count===sel_item.order){if(item.setDate(new BBModel.Day({date:$scope.sel_date.format(),spaces:1})),item.setTime(slot),next=slot.time+item.service.duration,time=slot.time,slot=null,count>0)for(current=count-1;current>=0;){if(item=$scope.bb.stacked_items[current],latest=time-item.service.duration,!item.time||item.time.time>latest)for(item.setDate(new BBModel.Day({date:$scope.sel_date.format(),spaces:1})),item.setTime(null),ref1=item.slots,j=0,len1=ref1.length;len1>j;j++)slot=ref1[j],slot.time<latest&&item.setTime(slot);time=item.time.time,current-=1}}else if(count>sel_item.order&&(slots=item.slots,item.setDate(new BBModel.Day({date:$scope.sel_date.format(),spaces:1})),slots))for(item.setTime(null),k=0,len2=slots.length;len2>k;k++)slot=slots[k],slot.time>=next&&!item.time&&(item.setTime(slot),next=slot.time+item.service.duration);return $scope.picked_time=!0}}(this),$scope.hasAvailability=function(_this){return function(slots,start_time,end_time){var i,j,k,l,len,len1,len2,len3,slot;if(!slots)return!1;if(start_time&&end_time){for(i=0,len=slots.length;len>i;i++)if(slot=slots[i],slot.time>=start_time&&slot.time<end_time&&slot.availability()>0)return!0}else if(end_time){for(j=0,len1=slots.length;len1>j;j++)if(slot=slots[j],slot.time<end_time&&slot.availability()>0)return!0}else if(start_time){for(k=0,len2=slots.length;len2>k;k++)if(slot=slots[k],slot.time>=start_time&&slot.availability()>0)return!0}else for(l=0,len3=slots.length;len3>l;l++)if(slot=slots[l],slot.availability()>0)return!0}}(this),$scope.confirm=function(_this){return function(){}}(this)})}.call(this),function(){"use strict";var BBBasicPageCtrl;BBBasicPageCtrl=function($scope,$q,ValidatorService){var isScopeReady;return $scope.controllerClass="public.controllers.PageController",$scope.$has_page_control=!0,$scope.validator=ValidatorService,isScopeReady=function(_this){return function(cscope){var child,children,i,len,ready,ready_list;for(ready_list=[],children=[],child=cscope.$$childHead;child;)children.push(child),child=child.$$nextSibling;for(children.sort(function(a,b){return(a.ready_order||0)>=(b.ready_order||0)?1:-1}),i=0,len=children.length;len>i;i++)child=children[i],ready=isScopeReady(child),angular.isArray(ready)?Array.prototype.push.apply(ready_list,ready):ready_list.push(ready);return cscope.hasOwnProperty("setReady")&&ready_list.push(cscope.setReady()),ready_list}}(this),$scope.checkReady=function(){var checkread,i,len,ready_list,v;
if(ready_list=isScopeReady($scope),checkread=$q.defer(),$scope.$checkingReady=checkread.promise,ready_list=ready_list.filter(function(v){return!("boolean"==typeof v&&v)}),!ready_list||0===ready_list.length)return checkread.resolve(),!0;for(i=0,len=ready_list.length;len>i;i++)if(v=ready_list[i],"boolean"==typeof value||!v)return checkread.reject(),!1;return $scope.notLoaded($scope),$q.all(ready_list).then(function(){return $scope.setLoaded($scope),checkread.resolve()},function(err){return $scope.setLoaded($scope)}),!0},$scope.routeReady=function(route){return $scope.$checkingReady?$scope.$checkingReady.then(function(_this){return function(){return $scope.decideNextPage(route)}}(this)):$scope.decideNextPage(route)}},angular.module("BB.Directives").directive("bbPage",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PageController"}}),angular.module("BB.Controllers").controller("PageController",BBBasicPageCtrl),angular.module("BB.Services").value("PageControllerService",BBBasicPageCtrl)}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbPayment",function($window,$location,$sce,SettingsService,AlertService){var error,getHost,linker,sendLoadEvent;return error=function(scope,message){return scope.error(message)},getHost=function(url){var a;return a=document.createElement("a"),a.href=url,a.protocol+"//"+a.host},sendLoadEvent=function(element,origin,scope){var custom_stylesheet,payload,referrer;return referrer=$location.protocol()+"://"+$location.host(),$location.port()&&(referrer+=":"+$location.port()),scope.payment_options.custom_stylesheet&&(custom_stylesheet=scope.payment_options.custom_stylesheet),payload=JSON.stringify({type:"load",message:referrer,custom_partial_url:scope.bb.custom_partial_url,custom_stylesheet:custom_stylesheet,scroll_offset:SettingsService.getScrollOffset()}),element.find("iframe")[0].contentWindow.postMessage(payload,origin)},linker=function(scope,element,attributes){return scope.payment_options=scope.$eval(attributes.bbPayment)||{},scope.route_to_next_page=null!=scope.payment_options.route_to_next_page?scope.payment_options.route_to_next_page:!0,element.find("iframe").bind("load",function(_this){return function(event){var origin,url;return scope.bb&&scope.bb.total&&scope.bb.total.$href("new_payment")&&(url=scope.bb.total.$href("new_payment")),origin=getHost(url),sendLoadEvent(element,origin,scope),scope.$apply(function(){return scope.callSetLoaded()})}}(this)),$window.addEventListener("message",function(_this){return function(event){var data;return angular.isObject(event.data)?data=event.data:event.data.match(/iFrameSizer/)||(data=JSON.parse(event.data)),scope.$apply(function(){if(data)switch(data.type){case"submitting":return scope.callNotLoaded();case"error":return scope.$emit("payment:failed"),scope.callNotLoaded(),AlertService.raise("PAYMENT_FAILED"),document.getElementsByTagName("iframe")[0].src+="";case"payment_complete":return scope.callSetLoaded(),scope.paymentDone()}})}}(this),!1)},{restrict:"AE",replace:!0,scope:!0,controller:"Payment",link:linker}}),angular.module("BB.Controllers").controller("Payment",function($scope,$rootScope,$q,$location,$window,$sce,$log,$timeout){return $scope.controller="public.controllers.Payment",$scope.notLoaded($scope),$scope.purchase&&($scope.bb.total=$scope.purchase),$rootScope.connection_started.then(function(_this){return function(){return $scope.total&&($scope.bb.total=$scope.total),$scope.bb&&$scope.bb.total&&$scope.bb.total.$href("new_payment")?$scope.url=$sce.trustAsResourceUrl($scope.bb.total.$href("new_payment")):void 0}}(this)),$scope.callNotLoaded=function(_this){return function(){return $scope.notLoaded($scope)}}(this),$scope.callSetLoaded=function(_this){return function(){return $scope.setLoaded($scope)}}(this),$scope.paymentDone=function(){return $scope.bb.payment_status="complete",$scope.$emit("payment:complete"),$scope.route_to_next_page?$scope.decideNextPage():void 0},$scope.error=function(message){return $log.warn("Payment Failure: "+message)}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbPayForm",function($window,$timeout,$sce,$http,$compile,$document,$location,SettingsService){var applyCustomPartials,applyCustomStylesheet,linker;return applyCustomPartials=function(custom_partial_url,scope,element){return null!=custom_partial_url?($document.domain="bookingbug.com",$http.get(custom_partial_url).then(function(custom_templates){return $compile(custom_templates.data)(scope,function(custom,scope){var custom_form,e,i,len;for(i=0,len=custom.length;len>i;i++)e=custom[i],"STYLE"===e.tagName&&element.after(e.outerHTML);return custom_form=function(){var j,len1,results;for(results=[],j=0,len1=custom.length;len1>j;j++)e=custom[j],"payment_form"===e.id&&results.push(e);return results}(),custom_form&&custom_form[0]?$compile(custom_form[0].innerHTML)(scope,function(compiled_form,scope){var action,form;return form=element.find("form")[0],action=form.action,compiled_form.attr("action",action),$(form).replaceWith(compiled_form)}):void 0})})):void 0},applyCustomStylesheet=function(href){var css_id,head,link;return css_id="custom_css",document.getElementById(css_id)?void 0:(head=document.getElementsByTagName("head")[0],link=document.createElement("link"),link.id=css_id,link.rel="stylesheet",link.type="text/css",link.href=href,link.media="all",head.appendChild(link),link.onload=function(){return"parentIFrame"in $window?parentIFrame.size():void 0})},linker=function(scope,element,attributes){return $window.addEventListener("message",function(_this){return function(event){var data;if(angular.isObject(event.data)?data=event.data:angular.isString(event.data)&&!event.data.match(/iFrameSizer/)&&(data=JSON.parse(event.data)),data)switch(data.type){case"load":return scope.$apply(function(){return scope.referrer=data.message,data.custom_partial_url&&applyCustomPartials(event.data.custom_partial_url,scope,element),data.custom_stylesheet&&applyCustomStylesheet(data.custom_stylesheet),data.scroll_offset?SettingsService.setScrollOffset(data.scroll_offset):void 0})}}}(this),!1)},{restrict:"AE",replace:!0,scope:!0,controller:"PayForm",link:linker}}),angular.module("BB.Controllers").controller("PayForm",function($scope,$location){var sendSubmittingEvent,submitPaymentForm;return $scope.controller="public.controllers.PayForm",$scope.setTotal=function(total){return $scope.total=total},$scope.setCard=function(card){return $scope.card=card},sendSubmittingEvent=function(_this){return function(){var payload,referrer,target_origin;return referrer=$location.protocol()+"://"+$location.host(),$location.port()&&(referrer+=":"+$location.port()),target_origin=$scope.referrer,payload=JSON.stringify({type:"submitting",message:referrer}),parent.postMessage(payload,target_origin)}}(this),submitPaymentForm=function(_this){return function(){var payment_form;return payment_form=angular.element.find("form"),payment_form[0].submit()}}(this),$scope.submitAndSendMessage=function(_this){return function(event){var payment_form;return event.preventDefault(),event.stopPropagation(),payment_form=$scope.$eval("payment_form"),payment_form.$invalid?(payment_form.submitted=!0,!1):(sendSubmittingEvent(),submitPaymentForm())}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbPeople",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PersonList",link:function(scope,element,attrs){attrs.bbItem&&(scope.booking_item=scope.$eval(attrs.bbItem))}}}),angular.module("BB.Controllers").controller("PersonList",function($scope,$rootScope,PageControllerService,PersonService,ItemService,$q,BBModel,PersonModel,FormDataStoreService){var getItemFromPerson,loadData,setPerson;return $scope.controller="public.controllers.PersonList",$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),$rootScope.connection_started.then(function(){return loadData()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),loadData=function(){var bi,ppromise;return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),bi=$scope.booking_item,bi.service&&bi.service!==$scope.change_watch_item?($scope.change_watch_item=bi.service,$scope.notLoaded($scope),ppromise=PersonService.query($scope.bb.company),ppromise.then(function(people){return bi.group&&(people=people.filter(function(x){return!x.group_id||x.group_id===bi.group})),$scope.all_people=people}),ItemService.query({company:$scope.bb.company,cItem:bi,wait:ppromise,item:"person"}).then(function(items){var i,j,len,promises;for(bi.group&&(items=items.filter(function(x){return!x.group_id||x.group_id===bi.group})),promises=[],j=0,len=items.length;len>j;j++)i=items[j],promises.push(i.promise);return $q.all(promises).then(function(_this){return function(res){var k,len1,people;for(people=[],k=0,len1=items.length;len1>k;k++)i=items[k],people.push(i.item),bi&&bi.person&&bi.person.self===i.item.self&&($scope.person=i.item,$scope.selected_bookable_items=[i]),bi&&bi.selected_person&&bi.selected_person.item.self===i.item.self&&(bi.selected_person=i);return 1===items.length&&$scope.bb.company.settings&&$scope.bb.company.settings.merge_people?$scope.selectItem(items[0],$scope.nextRoute)?$scope.skipThisStep():(setPerson(people),$scope.bookable_items=items,$scope.selected_bookable_items=items):(setPerson(people),$scope.bookable_items=items,$scope.selected_bookable_items||($scope.selected_bookable_items=items)),$scope.setLoaded($scope)}}(this))},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):void(bi.service||$scope.setLoaded($scope))},setPerson=function(people){return $scope.bookable_people=people,$scope.person?_.each(people,function(person){return person.id===$scope.person.id?$scope.person=person:void 0}):void 0},getItemFromPerson=function(_this){return function(person){var item,j,len,ref;if(person instanceof PersonModel&&$scope.bookable_items)for(ref=$scope.bookable_items,j=0,len=ref.length;len>j;j++)if(item=ref[j],item.item.self===person.self)return item;return person}}(this),$scope.selectItem=function(_this){return function(item,route){return $scope.$parent.$has_page_control?($scope.person=item,!1):($scope.booking_item.setPerson(getItemFromPerson(item)),$scope.decideNextPage(route),!0)}}(this),$scope.selectAndRoute=function(_this){return function(item,route){return $scope.booking_item.setPerson(getItemFromPerson(item)),$scope.decideNextPage(route),!0}}(this),$scope.$watch("person",function(_this){return function(newval,oldval){if($scope.person&&$scope.booking_item){if(!$scope.booking_item.person||$scope.booking_item.person.self!==$scope.person.self)return $scope.booking_item.setPerson(getItemFromPerson($scope.person)),$scope.broadcastItemUpdate()}else if(newval!==oldval)return $scope.booking_item.setPerson(null),$scope.broadcastItemUpdate()}}(this)),$scope.$on("currentItemUpdate",function(event){return loadData()}),$scope.setReady=function(_this){return function(){return $scope.person?($scope.booking_item.setPerson(getItemFromPerson($scope.person)),!0):($scope.booking_item.setPerson(null),!0)}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbProductList",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"ProductList",link:function(scope,element,attrs){attrs.bbItem&&(scope.booking_item=scope.$eval(attrs.bbItem)),attrs.bbShowAll&&(scope.show_all=!0)}}}),angular.module("BB.Controllers").controller("ProductList",function($scope,$rootScope,$q,$attrs,ItemService,FormDataStoreService,ValidatorService,PageControllerService,halClient){return $scope.controller="public.controllers.ProductList",$scope.notLoaded($scope),$scope.validator=ValidatorService,$rootScope.connection_started.then(function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(company){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),company.$get("products").then(function(products){return products.$get("products").then(function(products){return $scope.products=products,$scope.setLoaded($scope)})})},$scope.selectItem=function(item,route){return $scope.$parent.$has_page_control?($scope.product=item,!1):($scope.booking_item.setProduct(item),$scope.decideNextPage(route),!0)}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbPurchaseTotal",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"PurchaseTotal"}}),angular.module("BB.Controllers").controller("PurchaseTotal",function($scope,$rootScope,$window,PurchaseTotalService,$q){return $scope.controller="public.controllers.PurchaseTotal",angular.extend(this,new $window.PageController($scope,$q)),$scope.load=function(_this){return function(total_id){return $rootScope.connection_started.then(function(){return $scope.loadingTotal=PurchaseTotalService.query({company:$scope.bb.company,total_id:total_id}),$scope.loadingTotal.then(function(total){return $scope.total=total})})}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbResources",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"ResourceList"}}),angular.module("BB.Controllers").controller("ResourceList",function($scope,$rootScope,$attrs,PageControllerService,ResourceService,ItemService,$q,BBModel,ResourceModel){var getItemFromResource,loadData;return $scope.controller="public.controllers.ResourceList",$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),$scope.options=$scope.$eval($attrs.bbResources)||{},$rootScope.connection_started.then(function(_this){return function(){return loadData()}}(this)),loadData=function(_this){return function(){var params,rpromise;return $scope.bb.steps&&"resource_list"===$scope.bb.steps[0].page||$scope.options.resource_first||$scope.bb.current_item.service&&$scope.bb.current_item.service!==$scope.change_watch_item?($scope.change_watch_item=$scope.bb.current_item.service,$scope.notLoaded($scope),rpromise=ResourceService.query($scope.bb.company),rpromise.then(function(resources){return $scope.bb.current_item.group&&(resources=resources.filter(function(x){return!x.group_id||x.group_id===$scope.bb.current_item.group})),$scope.all_resources=resources}),params={company:$scope.bb.company,cItem:$scope.bb.current_item,wait:rpromise,item:"resource"},ItemService.query(params).then(function(items){var i,j,len,promises;for(promises=[],$scope.bb.current_item.group&&(items=items.filter(function(x){return!x.group_id||x.group_id===$scope.bb.current_item.group})),j=0,len=items.length;len>j;j++)i=items[j],promises.push(i.promise);return $q.all(promises).then(function(res){var k,len1,resources;for(resources=[],k=0,len1=items.length;len1>k;k++)i=items[k],resources.push(i.item),$scope.bb.current_item&&$scope.bb.current_item.resource&&$scope.bb.current_item.resource.self===i.item.self&&($scope.resource=i.item);return 1!==resources.length||$scope.options.allow_single_pick?($scope.bookable_resources=resources,$scope.bookable_items=items):$scope.selectItem(items[0].item,$scope.nextRoute,{skip_step:!0})||($scope.bookable_resources=resources,$scope.bookable_items=items),$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},function(err){return"No service link found"===err&&($scope.bb.steps&&"resource_list"===$scope.bb.steps[0].page||$scope.options.resource_first)?$scope.setLoaded($scope):$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):void($scope.bb.current_item.service||$scope.setLoaded($scope))}}(this),getItemFromResource=function(_this){return function(resource){var item,j,len,ref;if(resource instanceof ResourceModel&&$scope.bookable_items)for(ref=$scope.bookable_items,j=0,len=ref.length;len>j;j++)if(item=ref[j],item.item.self===resource.self)return item;return resource}}(this),$scope.selectItem=function(_this){return function(item,route,options){return null==options&&(options={}),$scope.$parent.$has_page_control?($scope.resource=item,!1):($scope.bb.current_item.setResource(getItemFromResource(item)),options.skip_step&&$scope.skipThisStep(),$scope.decideNextPage(route),!0)}}(this),$scope.$watch("resource",function(_this){return function(newval,oldval){return $scope.resource?($scope.bb.current_item.setResource(getItemFromResource($scope.resource)),$scope.broadcastItemUpdate()):newval!==oldval?($scope.bb.current_item.setResource(null),$scope.broadcastItemUpdate()):void 0}}(this)),$scope.$on("currentItemUpdate",function(event){return loadData()}),$scope.setReady=function(_this){return function(){return $scope.resource?($scope.bb.current_item.setResource(getItemFromResource($scope.resource)),!0):($scope.bb.current_item.setResource(null),!0)}}(this)})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbServices",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"ServiceList"}}),angular.module("BB.Controllers").controller("ServiceList",function($scope,$rootScope,$q,$attrs,$modal,$sce,ItemService,FormDataStoreService,ValidatorService,PageControllerService,halClient,AlertService,ErrorService,$filter,CategoryService){var setServiceItem;return $scope.controller="public.controllers.ServiceList",FormDataStoreService.init("ServiceList",$scope,["service"]),$scope.notLoaded($scope),angular.extend(this,new PageControllerService($scope,$q)),$scope.validator=ValidatorService,$scope.filters={category_name:null,service_name:null,price:{min:0,max:100},custom_array_value:null},$scope.show_custom_array=!1,$scope.options=$scope.$eval($attrs.bbServices)||{},$attrs.bbItem&&($scope.booking_item=$scope.$eval($attrs.bbItem)),($attrs.bbShowAll||$scope.options.show_all)&&($scope.show_all=!0),$scope.options.allow_single_pick&&($scope.allowSinglePick=!0),$scope.options.hide_disabled&&($scope.hide_disabled=!0),$scope.price_options={min:0,max:100},$rootScope.connection_started.then(function(_this){return function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(comp){var ppromise;return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),$scope.bb.company.$has("named_categories")?CategoryService.query($scope.bb.company).then(function(_this){return function(items){return $scope.all_categories=items}}(this),function(err){return $scope.all_categories=[]}):$scope.all_categories=[],$scope.service&&$scope.service.company_id!==$scope.bb.company.id&&($scope.service=null),ppromise=comp.getServicesPromise(),ppromise.then(function(_this){return function(items){var filterItems,item,j,k,len,len1;if($scope.hide_disabled&&(items=items.filter(function(x){return!x.disabled&&!x.deleted})),filterItems="false"!==$attrs.filterServices,filterItems&&($scope.booking_item.service_ref&&!$scope.show_all?items=items.filter(function(x){return x.api_ref===$scope.booking_item.service_ref}):$scope.booking_item.category&&!$scope.show_all&&(items=items.filter(function(x){return x.$has("category")&&x.$href("category")===$scope.booking_item.category.self}))),$scope.options.show_event_groups||(items=items.filter(function(x){return!x.is_event_group})),1!==items.length||$scope.allowSinglePick?setServiceItem(items):$scope.selectItem(items[0],$scope.nextRoute,{skip_step:!0})||setServiceItem(items),$scope.booking_item.defaultService())for(j=0,len=items.length;len>j;j++)item=items[j],(item.self===$scope.booking_item.defaultService().self||item.name===$scope.booking_item.defaultService().name&&!item.deleted)&&$scope.selectItem(item,$scope.nextRoute,{skip_step:!0});if($scope.booking_item.service)for(k=0,len1=items.length;len1>k;k++)item=items[k],item.selected=!1,item.self===$scope.booking_item.service.self&&($scope.service=item,item.selected=!0,$scope.booking_item.setService($scope.service));return $scope.setLoaded($scope),$scope.booking_item.service||!($scope.booking_item.person&&!$scope.booking_item.anyPerson()||$scope.booking_item.resource&&!$scope.booking_item.anyResource())?$scope.bookable_services=$scope.items:void 0}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.booking_item.person&&!$scope.booking_item.anyPerson()||$scope.booking_item.resource&&!$scope.booking_item.anyResource()?ItemService.query({company:$scope.bb.company,cItem:$scope.booking_item,wait:ppromise,item:"service"}).then(function(_this){return function(items){var i,item,j,len,services;for($scope.booking_item.service_ref&&(items=items.filter(function(x){return x.api_ref===$scope.booking_item.service_ref})),$scope.booking_item.group&&(items=items.filter(function(x){return!x.group_id||x.group_id===$scope.booking_item.group})),$scope.hide_disabled&&(items=items.filter(function(x){return null==x.item||!x.item.disabled&&!x.item.deleted})),services=function(){var j,len,results;for(results=[],j=0,len=items.length;len>j;j++)i=items[j],null!=i.item&&results.push(i.item);return results}(),j=0,len=services.length;len>j;j++)item=services[j],item.listed_durations&&1===item.listed_durations.length?item.display_name=item.name+" - "+$filter("time_period")(item.duration):item.display_name=item.name;return $scope.bookable_services=services,$scope.bookable_items=items,1!==services.length||$scope.allowSinglePick?setServiceItem(services):$scope.selectItem(services[0],$scope.nextRoute,{skip_step:!0})||setServiceItem(services),$scope.setLoaded($scope)}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}):void 0},setServiceItem=function(items){return $scope.items=items,$scope.filtered_items=$scope.items,$scope.service?_.each(items,function(item){return item.id===$scope.service.id?$scope.service=item:void 0}):void 0},$scope.selectItem=function(_this){return function(item,route,options){return null==options&&(options={}),$scope.routed?!0:$scope.$parent.$has_page_control?($scope.service=item,!1):item.is_event_group?($scope.booking_item.setEventGroup(item),options.skip_step&&$scope.skipThisStep(),$scope.decideNextPage(route),$scope.routed=!0):($scope.booking_item.setService(item),options.skip_step&&$scope.skipThisStep(),$scope.decideNextPage(route),$scope.routed=!0,!0)}}(this),$scope.$watch("service",function(_this){return function(newval,oldval){return!$scope.service||!$scope.booking_item||$scope.booking_item.service&&$scope.booking_item.service.self===$scope.service.self?void 0:($scope.booking_item.setService($scope.service),$scope.broadcastItemUpdate())}}(this)),$scope.setReady=function(_this){return function(){return $scope.service?($scope.booking_item.setService($scope.service),!0):!!($scope.bb.stacked_items&&$scope.bb.stacked_items.length>0)}}(this),$scope.errorModal=function(){var error_modal;return error_modal=$modal.open({templateUrl:$scope.getPartial("_error_modal"),controller:function($scope,$modalInstance){return $scope.message=ErrorService.getError("GENERIC").msg,$scope.ok=function(){return $modalInstance.close()}}})},$scope.filterFunction=function(service){return service?($scope.service_array=[],$scope.custom_array=function(match){var item,j,len,ref;if(!match)return!1;if($scope.options.custom_filter){for(match=match.toLowerCase(),ref=service.extra[$scope.options.custom_filter],j=0,len=ref.length;len>j;j++)if(item=ref[j],item=item.toLowerCase(),item===match)return $scope.show_custom_array=!0,!0;return!1}},$scope.service_name_include=function(match){var item;return match?match?(match=match.toLowerCase(),item=service.name.toLowerCase(),!!item.includes(match)):void 0:!1},(!$scope.filters.category_name||service.category_id===$scope.filters.category_name.id)&&(!$scope.filters.service_name||$scope.service_name_include($scope.filters.service_name))&&(!$scope.filters.custom_array_value||$scope.custom_array($scope.filters.custom_array_value))&&(!service.price||service.price>=100*$scope.filters.price.min&&service.price<=100*$scope.filters.price.max)):!1},$scope.resetFilters=function(){return $scope.options.clear_results&&($scope.show_custom_array=!1),$scope.filters.category_name=null,$scope.filters.service_name=null,$scope.filters.price.min=0,$scope.filters.price.max=100,$scope.filters.custom_array_value=null,$scope.filterChanged()},$scope.filterChanged=function(){return $scope.filtered_items=$filter("filter")($scope.items,$scope.filterFunction)}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbTimeSlots",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"TimeSlots",link:function(scope,element,attrs){attrs.bbItem&&(scope.booking_item=scope.$eval(attrs.bbItem)),attrs.bbShowAll&&(scope.show_all=!0)}}}),angular.module("BB.Controllers").controller("TimeSlots",function($scope,$rootScope,$q,$attrs,SlotService,FormDataStoreService,ValidatorService,PageControllerService,halClient,BBModel){var setItem;return $scope.controller="public.controllers.SlotList",$scope.notLoaded($scope),$rootScope.connection_started.then(function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(company){return $scope.booking_item||($scope.booking_item=$scope.bb.current_item),$scope.start_date=moment(),$scope.end_date=moment().add(1,"month"),SlotService.query($scope.bb.company,{item:$scope.booking_item,start_date:$scope.start_date.toISODate(),end_date:$scope.end_date.toISODate()}).then(function(slots){return $scope.slots=slots,$scope.setLoaded($scope)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})},setItem=function(slot){return $scope.booking_item.setSlot(slot)},$scope.selectItem=function(slot,route){return $scope.$parent.$has_page_control?(setItem(slot),!1):(setItem(slot),$scope.decideNextPage(route),!0)}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbSpaces",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"SpaceList"}}),angular.module("BB.Controllers").controller("SpaceList",function($scope,$rootScope,ServiceService,SpaceService,$q){return $scope.controller="public.controllers.SpaceList",$rootScope.connection_started.then(function(_this){return function(){return $scope.bb.company?$scope.init($scope.bb.company):void 0}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.init=function(_this){return function(comp){return SpaceService.query(comp).then(function(items){return $scope.currentItem.category&&(items=items.filter(function(x){return x.$has("category")&&x.$href("category")===$scope.currentItem.category.self})),$scope.items=items,1!==items.length||$scope.allowSinglePick?$scope.listLoaded=!0:($scope.skipThisStep(),$rootScope.services=items,$scope.selectItem(items[0],$scope.nextRoute))},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),$scope.selectItem=function(_this){return function(item,route){return $scope.currentItem.setService(item),$scope.decide_next_page(route)}}(this)})}.call(this),function(){angular.module("BB.Directives").directive("bbSummary",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Summary"}}),angular.module("BB.Controllers").controller("Summary",function($scope,$rootScope,ClientService,$q){return $scope.controller="public.controllers.Summary",$rootScope.connection_started.then(function(_this){return function(){return $scope.item=$scope.bb.current_item,$scope.items=$scope.bb.basket.timeItems()}}(this)),$scope.confirm=function(_this){return function(){var promises;return $scope.notLoaded($scope),promises=[ClientService.create_or_update($scope.bb.company,$scope.client)],$scope.bb.current_item.service&&promises.push($scope.addItemToBasket()),$q.all(promises).then(function(result){var client;return client=result[0],$scope.setClient(client),client.waitingQuestions&&client.gotQuestions.then(function(){return $scope.client_details=client.client_details}),$scope.setLoaded($scope),$scope.decideNextPage()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this)})}.call(this),function(){angular.module("BB.Directives").directive("bbSurveyQuestions",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"SurveyQuestions"}}),angular.module("BB.Controllers").controller("SurveyQuestions",function($scope,$rootScope,CompanyService,PurchaseService,ClientService,$modal,$location,$timeout,BBWidget,BBModel,$q,QueryStringService,SSOService,AlertService,LoginService,$window,$upload,ServiceService,ValidatorService,PurchaseBookingService,$sessionStorage){var getBookingAndSurvey,getBookingRef,getMember,getPurchaseID,init,setPurchaseCompany,showLoginError;return $scope.controller="SurveyQuestions",$scope.completed=!1,$scope.login={email:"",password:""},$scope.login_error=!1,$scope.booking_ref="",$scope.notLoaded($scope),$rootScope.connection_started.then(function(){return init()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),init=function(_this){return function(){if($scope.company){if(!$scope.company.settings.requires_login)return getBookingAndSurvey();if($scope.checkIfLoggedIn(),$rootScope.member)return getBookingAndSurvey()}}}(this),$scope.checkIfLoggedIn=function(_this){return function(){return LoginService.checkLogin()}}(this),$scope.loadSurvey=function(_this){return function(purchase){return $scope.company||$scope.purchase.$get("company").then(function(company){return setPurchaseCompany(company)}),$scope.purchase.$has("client")&&$scope.purchase.$get("client").then(function(client){return $scope.setClient(new BBModel.Client(client))}),$scope.purchase.getBookingsPromise().then(function(bookings){var address,booking,i,len,params,pretty_address,ref,results;for(params={},$scope.bookings=bookings,ref=$scope.bookings,results=[],i=0,len=ref.length;len>i;i++)booking=ref[i],booking.datetime&&(booking.pretty_date=moment(booking.datetime).format("dddd, MMMM Do YYYY")),booking.address&&(address=new BBModel.Address(booking.address),pretty_address=address.addressSingleLine(),booking.pretty_address=pretty_address),$rootScope.user&&(params.admin_only=!0),results.push(booking.$get("survey_questions",params).then(function(details){var item_details;return item_details=new BBModel.ItemDetails(details),booking.survey_questions=item_details.survey_questions,booking.getSurveyAnswersPromise().then(function(answers){var answer,j,k,len1,len2,question,ref1,ref2;for(booking.survey_answers=answers,ref1=booking.survey_questions,j=0,len1=ref1.length;len1>j;j++)if(question=ref1[j],booking.survey_answers)for(ref2=booking.survey_answers,k=0,len2=ref2.length;len2>k;k++)answer=ref2[k],answer.question_text===question.name&&answer.value&&(question.answer=answer.value);return $scope.setLoaded($scope)})}));return results},function(err){return $scope.setLoaded($scope),failMsg()})}}(this),$scope.submitSurveyLogin=function(_this){return function(form){return ValidatorService.validateForm(form)?LoginService.companyLogin($scope.company,{},{email:$scope.login.email,password:$scope.login.password,id:$scope.company.id}).then(function(member){return LoginService.setLogin(member),getBookingAndSurvey()},function(err){return showLoginError(),$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}):void 0}}(this),$scope.loadSurveyFromPurchaseID=function(_this){return function(id){var auth_token,params;return params={purchase_id:id,url_root:$scope.bb.api_url},auth_token=$sessionStorage.getItem("auth_token"),auth_token&&(params.auth_token=auth_token),PurchaseService.query(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.loadSurvey($scope.purchase)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong");
})}}(this),$scope.loadSurveyFromBookingRef=function(_this){return function(id){var auth_token,params;return params={booking_ref:id,url_root:$scope.bb.api_url,raw:!0},auth_token=$sessionStorage.getItem("auth_token"),auth_token&&(params.auth_token=auth_token),PurchaseService.bookingRefQuery(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.loadSurvey($scope.purchase)},function(err){return showLoginError(),$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),$scope.submitSurvey=function(_this){return function(form){var booking,i,len,params,ref,results;if(ValidatorService.validateForm(form)){for(ref=$scope.bookings,results=[],i=0,len=ref.length;len>i;i++)booking=ref[i],booking.checkReady(),booking.ready?($scope.notLoaded($scope),booking.client_id=$scope.client.id,params=booking,results.push(PurchaseBookingService.addSurveyAnswersToBooking(params).then(function(booking){return $scope.setLoaded($scope),$scope.completed=!0},function(err){return $scope.setLoaded($scope)}))):results.push($scope.decideNextPage(route));return results}}}(this),$scope.submitBookingRef=function(_this){return function(form){var auth_token,params;if(ValidatorService.validateForm(form))return $scope.notLoaded($scope),params={booking_ref:$scope.booking_ref,url_root:$scope.bb.api_url,raw:!0},auth_token=$sessionStorage.getItem("auth_token"),auth_token&&(params.auth_token=auth_token),PurchaseService.bookingRefQuery(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.loadSurvey($scope.purchase)},function(err){return showLoginError(),$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),$scope.storeBookingCookie=function(){return document.cookie="bookingrefsc="+$scope.booking_ref},showLoginError=function(_this){return function(){return $scope.login_error=!0}}(this),getMember=function(_this){return function(){var params;return params={member_id:$scope.member_id,company_id:$scope.company_id},LoginService.memberQuery(params).then(function(member){return $scope.member=member})}}(this),setPurchaseCompany=function(company){return $scope.bb.company_id=company.id,$scope.bb.company=new BBModel.Company(company),$scope.company=$scope.bb.company,$scope.bb.item_defaults.company=$scope.bb.company,company.settings&&(company.settings.merge_resources&&($scope.bb.item_defaults.merge_resources=!0),company.settings.merge_people)?$scope.bb.item_defaults.merge_people=!0:void 0},getBookingRef=function(){var booking_ref,matches;return matches=/^.*(?:\?|&)booking_ref=(.*?)(?:&|$)/.exec($location.absUrl()),matches&&(booking_ref=matches[1]),booking_ref},getPurchaseID=function(){var matches,purchase_id;return matches=/^.*(?:\?|&)id=(.*?)(?:&|$)/.exec($location.absUrl()),matches&&(purchase_id=matches[1]),purchase_id},getBookingAndSurvey=function(){var id;return id=getBookingRef(),id?$scope.loadSurveyFromBookingRef(id):(id=getPurchaseID())?$scope.loadSurveyFromPurchaseID(id):$scope.bb.total?$scope.loadSurveyFromPurchaseID($scope.bb.total.long_id):void 0}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbTimes",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"TimeList"}}),angular.module("BB.Controllers").controller("TimeList",function($attrs,$element,$scope,$rootScope,$q,TimeService,AlertService,BBModel){return $scope.controller="public.controllers.TimeList",$scope.notLoaded($scope),$scope.data_source||($scope.data_source=$scope.bb.current_item),$scope.options=$scope.$eval($attrs.bbTimes)||{},$rootScope.connection_started.then(function(_this){return function(){return $scope.bb.current_item.requested_date&&($scope.setDate($scope.bb.current_item.requested_date),$scope.bb.current_item.setDate($scope.selected_day)),$scope.loadDay()}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.setDate=function(_this){return function(date){var day;return day=new BBModel.Day({date:date,spaces:1}),$scope.setDay(day)}}(this),$scope.setDay=function(_this){return function(dayItem){return $scope.selected_day=dayItem,$scope.selected_date=dayItem.date}}(this),$scope.setDataSource=function(_this){return function(source){return $scope.data_source=source}}(this),$scope.setItemLinkSource=function(_this){return function(source){return $scope.item_link_source=source}}(this),$scope.$on("dateChanged",function(_this){return function(event,newdate){return $scope.setDate(newdate),$scope.loadDay()}}(this)),$scope.$on("currentItemUpdate",function(event){return $scope.loadDay()}),$scope.format_date=function(_this){return function(fmt){return $scope.data_source.date?$scope.data_source.date.date.format(fmt):void 0}}(this),$scope.selectSlot=function(_this){return function(slot,route){return slot&&slot.availability()>0&&($scope.item_link_source&&$scope.data_source.setItem($scope.item_link_source),$scope.selected_day&&($scope.setLastSelectedDate($scope.selected_day.date),$scope.data_source.setDate($scope.selected_day)),$scope.data_source.setTime(slot),!$scope.$parent.$has_page_control)?$scope.data_source.ready?$scope.addItemToBasket().then(function(){return $scope.decideNextPage(route)}):$scope.decideNextPage(route):void 0}}(this),$scope.highlightSlot=function(_this){return function(slot){return slot&&slot.availability()>0?($scope.selected_day&&($scope.setLastSelectedDate($scope.selected_day.date),$scope.data_source.setDate($scope.selected_day)),$scope.data_source.setTime(slot),$scope.$broadcast("slotChanged")):void 0}}(this),$scope.status=function(slot){var status;if(slot)return status=slot.status()},$scope.add=function(_this){return function(type,amount){var newdate;return newdate=moment($scope.data_source.date.date).add(amount,type),$scope.data_source.setDate(new BBModel.Day({date:newdate.format(),spaces:0})),$scope.setLastSelectedDate(newdate),$scope.loadDay(),$scope.$broadcast("dateChanged",newdate)}}(this),$scope.subtract=function(_this){return function(type,amount){return $scope.add(type,-amount)}}(this),$scope.loadDay=function(_this){return function(){var pslots;return $scope.data_source&&$scope.data_source.days_link||$scope.item_link_source?(!$scope.selected_date&&$scope.data_source&&$scope.data_source.date&&($scope.selected_date=$scope.data_source.date.date),$scope.selected_date?($scope.notLoaded($scope),pslots=TimeService.query({company:$scope.bb.company,cItem:$scope.data_source,item_link:$scope.item_link_source,date:$scope.selected_date,client:$scope.client,available:1}),pslots["finally"](function(){return $scope.setLoaded($scope)}),pslots.then(function(data){var dtimes,found_time,i,j,k,len,len1,len2,pad,ref,s,t,v;if($scope.slots=data,$scope.$broadcast("slotsUpdated"),$scope.add_padding&&data.length>0){for(dtimes={},i=0,len=data.length;len>i;i++)s=data[i],dtimes[s.time]=1;for(ref=$scope.add_padding,v=j=0,len1=ref.length;len1>j;v=++j)pad=ref[v],dtimes[pad]||data.splice(v,0,new BBModel.TimeSlot({time:pad,avail:0},data[0].service))}if(($scope.data_source.requested_time||$scope.data_source.time)&&$scope.selected_date.isSame($scope.data_source.date.date)){for(found_time=!1,k=0,len2=data.length;len2>k;k++){if(t=data[k],t.time===$scope.data_source.requested_time){$scope.data_source.requestedTimeUnavailable(),$scope.highlightSlot(t),$scope.skipThisStep(),$scope.decideNextPage(),found_time=!0;break}$scope.data_source.time&&t.time===$scope.data_source.time.time&&($scope.data_source.setTime(t),found_time=!0)}if(!found_time)return $scope.options.persist_requested_time||$scope.data_source.requestedTimeUnavailable(),$scope.time_not_found=!0,AlertService.add("danger",{msg:"Sorry, your requested time slot is not available. Please choose a different time."})}},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):void $scope.setLoaded($scope)):$scope.setLoaded($scope)}}(this),$scope.padTimes=function(_this){return function(times){return $scope.add_padding=times}}(this),$scope.setReady=function(_this){return function(){return $scope.data_source.time?$scope.data_source.ready?$scope.addItemToBasket():!0:(AlertService.clear(),AlertService.add("danger",{msg:"You need to select a time slot"}),!1)}}(this)}),angular.module("BB.Directives").directive("bbAccordianGroup",function(){return{restrict:"AE",scope:!0,controller:"AccordianGroup"}}),angular.module("BB.Controllers").controller("AccordianGroup",function($scope,$rootScope,$q){var hasAvailability,updateAvailability;return $scope.accordian_slots=[],$scope.is_open=!1,$scope.has_availability=!1,$scope.is_selected=!1,$scope.collaspe_when_time_selected=!0,$scope.start_time=0,$scope.end_time=0,$scope.init=function(_this){return function(start_time,end_time,options){var i,len,ref,slot;for($scope.start_time=start_time,$scope.end_time=end_time,$scope.collaspe_when_time_selected=!options||options.collaspe_when_time_selected,ref=$scope.slots,i=0,len=ref.length;len>i;i++)slot=ref[i],slot.time>=start_time&&slot.time<end_time&&$scope.accordian_slots.push(slot);return updateAvailability()}}(this),updateAvailability=function(_this){return function(){var item;if($scope.has_availability=!1,$scope.accordian_slots){if($scope.has_availability=hasAvailability(),item=$scope.data_source,!(item.time&&item.time.time>=$scope.start_time&&item.time.time<$scope.end_time&&item.date&&item.date.date.isSame($scope.selected_day.date,"day")))return $scope.is_selected=!1,$scope.is_open=!1;if($scope.is_selected=!0,!$scope.collaspe_when_time_selected)return $scope.is_open=!0}}}(this),hasAvailability=function(_this){return function(){var i,len,ref,slot;if(!$scope.accordian_slots)return!1;for(ref=$scope.accordian_slots,i=0,len=ref.length;len>i;i++)if(slot=ref[i],slot.availability()>0)return!0;return!1}}(this),$scope.$on("slotChanged",function(_this){return function(event){return updateAvailability()}}(this)),$scope.$on("slotsUpdated",function(_this){return function(event){var i,len,ref,slot;for($scope.accordian_slots=[],ref=$scope.slots,i=0,len=ref.length;len>i;i++)slot=ref[i],slot.time>=$scope.start_time&&slot.time<$scope.end_time&&$scope.accordian_slots.push(slot);return updateAvailability()}}(this))})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbTimeRanges",function(){return{restrict:"AE",replace:!0,scope:!0,priority:1,controller:"TimeRangeList"}}),angular.module("BB.Controllers").controller("TimeRangeList",function($scope,$element,$attrs,$rootScope,$q,TimeService,AlertService,BBModel,FormDataStoreService,DateTimeUlititiesService){var currentPostcode,isSubtractValid,setTimeRange;return $scope.controller="public.controllers.TimeRangeList",currentPostcode=$scope.bb.postcode,FormDataStoreService.init("TimeRangeList",$scope,["selected_slot","postcode","original_start_date","start_at_week_start"]),currentPostcode!==$scope.postcode&&($scope.selected_slot=null,$scope.selected_date=null),$scope.postcode=$scope.bb.postcode,$scope.notLoaded($scope),$scope.data_source||($scope.data_source=$scope.bb.current_item),$scope.options=$scope.$eval($attrs.bbTimeRanges)||{},$rootScope.connection_started.then(function(){var date,diff,selected_day,start_date;return null!=$attrs.bbTimeRangeLength?$scope.time_range_length=$scope.$eval($attrs.bbTimeRangeLength):$scope.options&&$scope.options.time_range_length?$scope.time_range_length=$scope.options.time_range_length:$scope.time_range_length=7,(null!=$attrs.bbDayOfWeek||$scope.options&&$scope.options.day_of_week)&&($scope.day_of_week=null!=$attrs.bbDayOfWeek?$scope.$eval($attrs.bbDayOfWeek):$scope.options.day_of_week),(null!=$attrs.bbSelectedDay||$scope.options&&$scope.options.selected_day)&&(selected_day=null!=$attrs.bbSelectedDay?moment($scope.$eval($attrs.bbSelectedDay)):moment($scope.options.selected_day),moment.isMoment(selected_day)&&($scope.selected_day=selected_day)),$scope.options.ignore_min_advance_datetime=!!$scope.options.ignore_min_advance_datetime,!$scope.start_date&&$scope.last_selected_date?$scope.original_start_date?(diff=$scope.last_selected_date.diff($scope.original_start_date,"days"),diff%=$scope.time_range_length,diff=0===diff?diff:diff+1,start_date=$scope.last_selected_date.clone().subtract(diff,"days"),setTimeRange($scope.last_selected_date,start_date)):setTimeRange($scope.last_selected_date):$scope.bb.current_item.date||$scope.bb.current_item.requested_date?(date=$scope.bb.current_item.date?$scope.bb.current_item.date.date:$scope.bb.current_item.requested_date,setTimeRange(date)):$scope.selected_day?($scope.original_start_date=$scope.original_start_date||moment($scope.selected_day),setTimeRange($scope.selected_day)):($scope.start_at_week_start=!0,setTimeRange(moment())),$scope.loadData()},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),setTimeRange=function(selected_date,start_date){start_date?$scope.start_date=start_date:$scope.day_of_week?$scope.start_date=selected_date.clone().day($scope.day_of_week):$scope.start_at_week_start?$scope.start_date=selected_date.clone().startOf("week"):$scope.start_date=selected_date.clone(),$scope.selected_day=selected_date,$scope.selected_date=$scope.selected_day.toDate(),isSubtractValid()},$scope.init=function(options){return null==options&&(options={}),null==options.selected_day||options.selected_day._isAMomementObject?void 0:$scope.selected_day=moment(options.selected_day)},$scope.moment=function(date){return moment(date)},$scope.setDataSource=function(source){return $scope.data_source=source},$scope.$on("currentItemUpdate",function(event){return $scope.loadData()}),$scope.add=function(type,amount){switch(amount>0&&($element.removeClass("subtract"),$element.addClass("add")),$scope.selected_day=moment($scope.selected_date),type){case"days":setTimeRange($scope.selected_day.add(amount,"days"));break;case"weeks":$scope.start_date.add(amount,type),setTimeRange($scope.start_date);break;case"months":$scope.start_date.add(amount,type).startOf("month"),setTimeRange($scope.start_date)}return $scope.loadData()},$scope.subtract=function(type,amount){return $element.removeClass("add"),$element.addClass("subtract"),$scope.add(type,-amount)},$scope.isSubtractValid=function(type,amount){var date;return!$scope.start_date||$scope.isAdmin()?!0:(date=$scope.start_date.clone().subtract(amount,type),!date.isBefore(moment(),"day"))},isSubtractValid=function(){var diff;return $scope.is_subtract_valid=!0,diff=Math.ceil($scope.selected_day.diff(moment(),"day",!0)),$scope.subtract_length=diff<$scope.time_range_length?diff:$scope.time_range_length,0>=diff&&($scope.is_subtract_valid=!1),$scope.subtract_length>1?$scope.subtract_string="Prev "+$scope.subtract_length+" days":1===$scope.subtract_length?$scope.subtract_string="Prev day":$scope.subtract_string="Prev"},$scope.selectedDateChanged=function(){return setTimeRange(moment($scope.selected_date)),$scope.selected_slot=null,$scope.loadData()},$scope.isPast=function(){return $scope.start_date?moment().isAfter($scope.start_date):!0},$scope.status=function(day,slot){var status;if(slot)return status=slot.status()},$scope.selectSlot=function(day,slot,route){return slot&&slot.availability()>0?($scope.bb.current_item.setTime(slot),day&&($scope.setLastSelectedDate(day.date),$scope.bb.current_item.setDate(day)),$scope.bb.current_item.reserve_ready?($scope.notLoaded($scope),$scope.addItemToBasket().then(function(){return $scope.setLoaded($scope),$scope.decideNextPage(route)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):$scope.decideNextPage(route)):void 0},$scope.highlightSlot=function(day,slot){var current_item;return current_item=$scope.bb.current_item,slot&&slot.availability()>0?(day&&($scope.setLastSelectedDate(day.date),current_item.setDate(day)),current_item.setTime(slot),current_item.setDate(day),$scope.selected_slot=slot,$scope.selected_day=day.date,$scope.selected_date=day.date.toDate(),!$scope.bb.current_item.earliest_time_slot||!$scope.bb.current_item.earliest_time_slot.selected||$scope.bb.current_item.earliest_time_slot.date.isSame(day.date,"day")&&$scope.bb.current_item.earliest_time_slot.time===slot.time||($scope.bb.current_item.earliest_time_slot.selected=!1),$rootScope.$broadcast("time:selected"),$scope.$broadcast("slotChanged",day,slot)):void 0},$scope.loadData=function(){var current_item,date,duration,edate,loc,promise;return current_item=$scope.bb.current_item,current_item.service&&!$scope.options.ignore_min_advance_datetime&&($scope.min_date=current_item.service.min_advance_datetime,$scope.max_date=current_item.service.max_advance_datetime,$scope.selected_day&&$scope.selected_day.isBefore(current_item.service.min_advance_datetime,"day")&&!$scope.isAdmin()&&setTimeRange(current_item.service.min_advance_datetime)),date=$scope.start_date,edate=moment(date).add($scope.time_range_length,"days"),$scope.end_date=moment(edate).add(-1,"days"),AlertService.clear(),duration=$scope.bb.current_item.duration,$scope.bb.current_item.min_duration&&(duration=$scope.bb.current_item.min_duration),loc=null,$scope.bb.postcode&&(loc=",,,,"+$scope.bb.postcode+","),$scope.data_source&&$scope.data_source.days_link?($scope.notLoaded($scope),loc=null,$scope.bb.postcode&&(loc=",,,,"+$scope.bb.postcode+","),promise=TimeService.query({company:$scope.bb.company,resource_ids:$scope.bb.item_defaults.resources,cItem:$scope.data_source,date:date,client:$scope.client,end_date:$scope.end_date,duration:duration,location:loc,num_resources:$scope.bb.current_item.num_resources,available:1}),promise["finally"](function(){return $scope.setLoaded($scope)}),promise.then(function(datetime_arr){var d,day,dtimes,i,j,k,len,len1,len2,pad,pair,ref,ref1,results,slot,time_slots,v;for($scope.days=[],ref=_.sortBy(_.pairs(datetime_arr),function(pair){return pair[0]}),results=[],i=0,len=ref.length;len>i;i++){if(pair=ref[i],d=pair[0],time_slots=pair[1],day={date:moment(d),slots:time_slots},$scope.days.push(day),time_slots.length>0&&(current_item.earliest_time&&!current_item.earliest_time.isAfter(d)||(current_item.earliest_time=moment(d).add(time_slots[0].time,"minutes")),current_item.earliest_time_slot&&!current_item.earliest_time_slot.date.isAfter(d)||(current_item.earliest_time_slot={date:moment(d).add(time_slots[0].time,"minutes"),time:time_slots[0].time})),$scope.add_padding&&time_slots.length>0){for(dtimes={},j=0,len1=time_slots.length;len1>j;j++)slot=time_slots[j],dtimes[slot.time]=1,slot.date=day.date.format("DD-MM-YY");for(ref1=$scope.add_padding,v=k=0,len2=ref1.length;len2>k;v=++k)pad=ref1[v],dtimes[pad]||time_slots.splice(v,0,new BBModel.TimeSlot({time:pad,avail:0},time_slots[0].service))}results.push(DateTimeUlititiesService.checkRequestedTime(day,time_slots,current_item))}return results},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})):$scope.setLoaded($scope)},$scope.padTimes=function(times){return $scope.add_padding=times},$scope.setReady=function(){return $scope.bb.current_item.time?$scope.bb.moving_booking&&$scope.bb.current_item.start_datetime().isSame($scope.bb.current_item.original_datetime)&&$scope.current_item.person_name===$scope.current_item.person.name?(AlertService.raise("APPT_AT_SAME_TIME"),!1):$scope.bb.moving_booking?($scope.bb.company.$has("resources")&&!$scope.bb.current_item.resource&&($scope.bb.current_item.resource=!0),$scope.bb.company.$has("people")&&!$scope.bb.current_item.person&&($scope.bb.current_item.person=!0),!0):$scope.bb.current_item.reserve_ready?$scope.addItemToBasket():!0:(AlertService.raise("TIME_SLOT_NOT_SELECTED"),!1)},$scope.format_date=function(fmt){return $scope.start_date?$scope.start_date.format(fmt):void 0},$scope.format_start_date=function(fmt){return $scope.format_date(fmt)},$scope.format_end_date=function(fmt){return $scope.end_date?$scope.end_date.format(fmt):void 0},$scope.pretty_month_title=function(month_format,year_format,seperator){var month_year_format,start_date;return null==seperator&&(seperator="-"),month_year_format=month_format+" "+year_format,$scope.start_date&&$scope.end_date&&$scope.end_date.isAfter($scope.start_date,"month")?(start_date=$scope.format_start_date(month_format),11===$scope.start_date.month()&&(start_date=$scope.format_start_date(month_year_format)),start_date+" "+seperator+" "+$scope.format_end_date(month_year_format)):$scope.format_start_date(month_year_format)},$scope.selectEarliestTimeSlot=function(){var day,slot;return day=_.find($scope.days,function(day){return day.date.isSame($scope.bb.current_item.earliest_time_slot.date,"day")}),slot=_.find(day.slots,function(slot){return slot.time===$scope.bb.current_item.earliest_time_slot.time}),day&&slot?($scope.bb.current_item.earliest_time_slot.selected=!0,$scope.highlightSlot(day,slot)):void 0}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbTotal",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Total"}}),angular.module("BB.Controllers").controller("Total",function($scope,$rootScope,$q,$location,$window,PurchaseService,QueryStringService){return $scope.controller="public.controllers.Total",$scope.notLoaded($scope),$rootScope.connection_started.then(function(_this){return function(){var id;return $scope.bb.payment_status=null,id=QueryStringService("purchase_id"),id&&!$scope.bb.total?PurchaseService.query({url_root:$scope.bb.api_url,purchase_id:id}).then(function(total){return $scope.total=total,$scope.setLoaded($scope),total.paid===total.total_price?$scope.$emit("checkout:success",total):void 0}):($scope.total=$scope.bb.total,$scope.setLoaded($scope),$scope.total.paid===$scope.total.total_price&&$scope.$emit("checkout:success",$scope.total)),$scope.reset()}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.print=function(_this){return function(){return $window.open($scope.bb.partial_url+"print_purchase.html?id="+$scope.total.long_id,"_blank","width=700,height=500,toolbar=0,menubar=0,location=0,status=1,scrollbars=1,resizable=1,left=0,top=0"),!0}}(this)})}.call(this),function(){var app;app=angular.module("BB.Filters"),angular.module("BB.Filters").filter("stripPostcode",function(){return function(address){var match;return match=address.toLowerCase().match(/[a-z]+\d/),match&&(address=address.substr(0,match.index)),address=$.trim(address),/,$/.test(address)&&(address=address.slice(0,-1)),address}}),angular.module("BB.Filters").filter("labelNumber",function(){return function(input,labels){var response;return response=input,labels[input]&&(response=labels[input]),response}}),angular.module("BB.Filters").filter("interpolate",["version",function(version){return function(text){return String(text).replace(/\%VERSION\%/gm,version)}}]),angular.module("BB.Filters").filter("rag",function(){return function(value,v1,v2){return v1>=value?"red":v2>=value?"amber":"green"}}),angular.module("BB.Filters").filter("time",function($window){return function(v){return $window.sprintf("%02d:%02d",Math.floor(v/60),v%60)}}),angular.module("BB.Filters").filter("address_single_line",function(){return function(_this){return function(address){var addr;if(address&&address.address1)return addr="",addr+=address.address1,address.address2&&address.address2.length>0&&(addr+=", ",addr+=address.address2),address.address3&&address.address3.length>0&&(addr+=", ",addr+=address.address3),address.address4&&address.address4.length>0&&(addr+=", ",addr+=address.address4),address.address5&&address.address5.length>0&&(addr+=", ",addr+=address.address5),address.postcode&&address.postcode.length>0&&(addr+=", ",addr+=address.postcode),addr}}(this)}),angular.module("BB.Filters").filter("address_multi_line",function(){return function(_this){return function(address){var str;if(address&&address.address1)return str="",address.address1&&(str+=address.address1),address.address2&&str.length>0&&(str+="<br/>"),address.address2&&(str+=address.address2),address.address3&&str.length>0&&(str+="<br/>"),address.address3&&(str+=address.address3),address.address4&&str.length>0&&(str+="<br/>"),address.address4&&(str+=address.address4),address.address5&&str.length>0&&(str+="<br/>"),address.address5&&(str+=address.address5),address.postcode&&str.length>0&&(str+="<br/>"),address.postcode&&(str+=address.postcode),str}}(this)}),angular.module("BB.Filters").filter("map_lat_long",function(){return function(_this){return function(address){var cord;if(address&&address.map_url)return cord=/([-+]*\d{1,3}[\.]\d*)[, ]([-+]*\d{1,3}[\.]\d*)/.exec(address.map_url),cord[0]}}(this)}),angular.module("BB.Filters").filter("currency",function($filter){return function(_this){return function(number,currencyCode){return $filter("icurrency")(number,currencyCode)}}(this)}),angular.module("BB.Filters").filter("icurrency",function($window,$rootScope){return function(_this){return function(number,currencyCode){var currency,decimal,format,thousand;return currencyCode||(currencyCode=$rootScope.bb_currency),currency={USD:"$",GBP:"£",AUD:"$",EUR:"€",CAD:"$",MIXED:"~"},$.inArray(currencyCode,["USD","AUD","CAD","MIXED","GBP"])>=0?(thousand=",",decimal=".",format="%s%v"):(thousand=".",decimal=",",format="%s%v"),number/=100,$window.accounting.formatMoney(number,currency[currencyCode],2,thousand,decimal,format)}}(this)}),angular.module("BB.Filters").filter("raw_currency",function(){return function(_this){return function(number){return number/100}}(this)}),angular.module("BB.Filters").filter("pretty_price",function($filter){return function(price,symbol){return $filter("ipretty_price")(price,symbol)}}),angular.module("BB.Filters").filter("ipretty_price",function($window,$rootScope){return function(price,symbol){var currency;return symbol||(currency={USD:"$",GBP:"£",AUD:"$",EUR:"€",CAD:"$",MIXED:"~"},symbol=currency[$rootScope.bb_currency]),price/=100,0===parseFloat(price)?"Free":parseFloat(price)%1===0?symbol+parseFloat(price):symbol+$window.sprintf("%.2f",parseFloat(price))}}),angular.module("BB.Filters").filter("time_period",function(){return function(v,options){var hour_string,hours,min_string,mins,separator,str,val;if(angular.isNumber(v))return hour_string=options&&options.abbr_units?"hr":"hour",min_string=options&&options.abbr_units?"min":"minute",separator=options&&angular.isString(options.separator)?options.separator:"and",val=parseInt(v),60>val?(str=val+" "+min_string,val>1&&(str+="s"),str):(hours=parseInt(val/60),mins=val%60,0===mins?1===hours?"1 "+hour_string:hours+" "+hour_string+"s":(str=hours+" "+hour_string,hours>1&&(str+="s"),0===mins?str:(separator.length>0&&(str+=" "+separator),str+=" "+mins+" "+min_string,mins>1&&(str+="s"),str)))}}),angular.module("BB.Filters").filter("twelve_hour_time",function($window){return function(time,options){var h,m,omit_mins_on_hour,separator,suffix,t;if(angular.isNumber(time))return omit_mins_on_hour=options&&options.omit_mins_on_hour||!1,separator=options&&options.separator?options.separator:":",t=time,h=Math.floor(t/60),m=t%60,suffix="am",h>=12&&(suffix="pm"),h>12&&(h-=12),time=0===m&&omit_mins_on_hour?""+h:""+h+separator+$window.sprintf("%02d",m),time+=suffix}}),angular.module("BB.Filters").filter("time_period_from_seconds",function(){return function(v){var hours,mins,secs,str,val;if(val=parseInt(v),60>val)return""+val+" seconds";if(hours=Math.floor(val/3600),mins=Math.floor(val%3600/60),secs=Math.floor(val%60),str="",hours>0){if(str+=hours+" hour",hours>1&&(str+="s"),0===mins&&0===secs)return str;str+=" and "}if(mins>0){if(str+=mins+" minute",mins>1&&(str+="s"),0===secs)return str;str+=" and "}return str+=secs+" second",secs>0&&(str+="s"),str}}),angular.module("BB.Filters").filter("round_up",function(){return function(number,interval){var result;return result=number/interval,result=parseInt(result),result*=interval,number%interval>0&&(result+=interval),result}}),angular.module("BB.Filters").filter("exclude_days",function(){return function(days,excluded){return _.filter(days,function(day){return-1===excluded.indexOf(day.date.format("dddd"))})}}),angular.module("BB.Filters").filter("local_phone_number",function(SettingsService,ValidatorService){return function(phone_number){var cc;if(phone_number)switch(cc=SettingsService.getCountryCode()){case"uk":return"0"+phone_number;case"us":return phone_number.replace(ValidatorService.us_phone_number,"($1) $2 $3");default:return phone_number}}}),angular.module("BB.Filters").filter("datetime",function(SettingsService){return function(date,format){var cc,datestrings;return date&&moment.isMoment(date)?(datestrings={datetime_us:"MM/DD/YYYY, h:mm a",datetime_uk:"DD/MM/YYYY, HH:mm",date_us:"MM/DD/YYYY",date_uk:"DD/MM/YYYY",time_us:"h:mm a",time_uk:"HH:mm"},cc=SettingsService.getCountryCode(),"us"!==cc&&(cc="uk"),format&&format.match(/(date(time_uk|time_us|_us|_uk)*|(time(_uk|_us)*))/)?date.format(datestrings[format+"_"+cc]):format?date.format(format):date.format(datestrings["date_"+cc])):void 0}}),angular.module("BB.Filters").filter("range",function(){return function(input,min,max){var i,j,ref,ref1;for(i=j=ref=parseInt(min),ref1=parseInt(max);ref1>=ref?ref1>=j:j>=ref1;i=ref1>=ref?++j:--j)input.push(i);return input}}),angular.module("BB.Filters").filter("international_number",function(){return function(_this){return function(number,prefix){return number&&prefix?prefix+" "+number:number?""+number:""}}(this)}),angular.module("BB.Filters").filter("startFrom",function(){return function(input,start){return void 0===input?input:input.slice(+start)}}),angular.module("BB.Filters").filter("add",function(){return function(_this){return function(item,value){return item&&value?(item=parseInt(item),item+value):void 0}}(this)}),angular.module("BB.Filters").filter("spaces_remaining",function(){return function(spaces){return 1>spaces?0:spaces}}),angular.module("BB.Filters").filter("key_translate",function(){return function(input){var add_underscore,remove_punctuations,upper_case;return upper_case=angular.uppercase(input),remove_punctuations=upper_case.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,""),add_underscore=remove_punctuations.replace(/\ /g,"_")}}),app.filter("clearTimezone",function(){return function(val,offset){return null!==val&&val.length>19?val.substring(0,19):val}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbBasket",function(PathSvc){return{restrict:"A",replace:!0,scope:!0,templateUrl:function(element,attrs){return _.has(attrs,"mini")?PathSvc.directivePartial("_basket_mini"):PathSvc.directivePartial("basket")},controllerAs:"BasketCtrl",controller:function($scope,$modal,BasketService){var BasketInstanceCtrl;$scope.setUsingBasket(!0),this.empty=function(){return $scope.$eval("emptyBasket()")},this.view=function(){return $scope.$eval("viewBasket()")},$scope.showBasketDetails=function(){var modalInstance;return"basket"===$scope.bb.current_page||"checkout"===$scope.bb.current_page?!1:modalInstance=$modal.open({templateUrl:$scope.getPartial("_basket_details"),scope:$scope,controller:BasketInstanceCtrl,resolve:{basket:function(){return $scope.bb.basket}}})},BasketInstanceCtrl=function($scope,$rootScope,$modalInstance,basket){return $scope.basket=basket,$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},$scope.$watch(function(){var len;$scope.basketItemCount=len=$scope.bb.basket?$scope.bb.basket.length():0,len?1===len?$scope.basketStatus="1 item in your basket":$scope.basketStatus=len+" items in your basket":$scope.basketStatus="empty"})},link:function(scope,element,attrs){return element.bind("click",function(e){return e.preventDefault()})}}}),angular.module("BB.Directives").directive("bbMinSpend",function(){return{restrict:"A",scope:!0,controller:function($scope,$element,$attrs,AlertService,$filter){var checkMinSpend,options;return options=$scope.$eval($attrs.bbMinSpend||{}),$scope.min_spend=options.min_spend||0,$scope.setReady=function(){return checkMinSpend()},checkMinSpend=function(){var i,item,len1,price,ref;for(price=0,ref=$scope.bb.stacked_items,i=0,len1=ref.length;len1>i;i++)item=ref[i],price+=item.service.price;
return price>=$scope.min_spend?(AlertService.clear(),!0):(AlertService.clear(),price=$filter("ipretty_price")($scope.min_spend),AlertService.add("warning",{msg:"You need to spend at least "+price+" to make a booking."}),!1)}}}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbBreadcrumb",function(PathSvc){return{restrict:"A",replace:!0,scope:!0,controller:"Breadcrumbs",templateUrl:function(element,attrs){return _.has(attrs,"complex")?PathSvc.directivePartial("_breadcrumb_complex"):PathSvc.directivePartial("_breadcrumb")},link:function(scope){}}}),angular.module("BB.Controllers").controller("Breadcrumbs",function($scope){var atDisablePoint,currentStep,lastStep,loadStep;return loadStep=$scope.loadStep,$scope.steps=$scope.bb.steps,$scope.allSteps=$scope.bb.allSteps,$scope.loadStep=function(number){return lastStep()||currentStep(number)||atDisablePoint()?void 0:loadStep(number)},lastStep=function(){return $scope.bb.current_step===$scope.bb.allSteps.length},currentStep=function(step){return step===$scope.bb.current_step},atDisablePoint=function(){return angular.isDefined($scope.bb.disableGoingBackAtStep)?$scope.bb.current_step>=$scope.bb.disableGoingBackAtStep:!1},$scope.isDisabledStep=function(step){return!(!lastStep()&&!currentStep(step.number)&&step.passed&&!atDisablePoint())}})}.call(this),function(){"use strict";var app;app=angular.module("BB.Directives"),app.directive("bbContentNew",function(PathSvc){return{restrict:"A",replace:!0,scope:!0,templateUrl:PathSvc.directivePartial("content_main"),controller:function($scope){$scope.initPage=function(){return $scope.$eval("setPageLoaded()")}}}})}.call(this),function(){angular.module("BB.Directives").directive("bbDatepickerPopup",function($parse,$document,$timeout,$bbug){var e,error,ie8orLess;ie8orLess=!1;try{ie8orLess=window.parseInt(/MSIE\s*(\d)/.exec(window.navigator.userAgent)[1])}catch(error){e=error,ie8orLess=!1}return{restrict:"A",priority:-1,require:"ngModel",link:function(scope,element,attrs,ngModel){var callDateHandler,data,dateFormat,f,format,getTimeRangeScope,getter,origDateParser,replacementDateParser,timeRangeScope,yearNow;return origDateParser=null,data=element.controller("ngModel"),null!=attrs.datepickerPopup&&(format={date_us:"MM/dd/yyyy",date_uk:"dd/MM/yyyy"},"us"===scope.bb.company.country_code?attrs.datepickerPopup=format.date_us:attrs.datepickerPopup=format.date_uk),dateFormat=attrs.bbDatepickerPopup?attrs.bbDatepickerPopup:"DD/MM/YYYY",yearNow=moment(new Date).year(),getter=$parse(attrs.ngModel),timeRangeScope=scope,getTimeRangeScope=function(scope){return scope?scope.controller&&scope.controller.indexOf("TimeRangeList")>0?timeRangeScope=scope:getTimeRangeScope(scope.$parent):void 0},getTimeRangeScope(scope),ie8orLess&&$bbug(element).on("keydown keyup keypress",function(ev){return ev.preventDefault(),ev.stopPropagation()}),(ie8orLess||scope.display.xs)&&$bbug(element).attr("readonly","true"),$bbug(element).on("keydown",function(e){return 13===e.keyCode?(replacementDateParser($bbug(e.target).val(),!0),$document.trigger("click"),$bbug(element).blur()):void 0}),$bbug(element).on("click",function(e){return e.preventDefault(),e.stopPropagation(),$timeout(function(){return scope.opened=!0})}),$bbug(element).on("focus",function(){return $(this).attr("readonly")?this.blur():void 0}),callDateHandler=function(date){var isDate,watch;return watch=scope.$watch(getter,function(newVal,oldVal){return newVal?void 0:getter.assign(timeRangeScope,date)}),$timeout(watch,0),isDate=_.isDate(date),isDate&&(getter.assign(timeRangeScope,date),ngModel.$setValidity("date",!0),scope.$eval(attrs.onDateChange)),isDate},replacementDateParser=function(viewValue,returnKey){var mDate;return callDateHandler(viewValue)?viewValue:ie8orLess?viewValue:(mDate=moment(viewValue,dateFormat),mDate.isValid()||(mDate=moment(new Date)),/\/YY$/.test(dateFormat)&&(dateFormat+="YY"),0===mDate.year()&&mDate.year(yearNow),viewValue=mDate.format("MM/DD/YYYY"),viewValue=viewValue.replace(/\/00/,"/20"),/\/02\d{2}$/.test(viewValue)?void 0:returnKey?(2===mDate.year().toString().length&&mDate.year(mDate.year()+2e3),callDateHandler(mDate._d)):origDateParser.call(this,viewValue))},(f=function(){return _.isFunction(data.$parsers[0])?(origDateParser=data.$parsers[0],void(data.$parsers[0]=replacementDateParser)):setTimeout(f,10)})()}}})}.call(this),function(){angular.module("BB.Directives").directive("datetimepicker",function(){var controller,link;return controller=function($scope){return $scope.open=function($event){return $event.preventDefault(),$event.stopPropagation(),$scope.opened=!0},$scope.$watch("$$value$$",function(value){return null!=value?$scope.updateModel(value):void 0})},link=function(scope,element,attrs,ngModel){return ngModel.$render=function(){return ngModel.$viewValue?moment.isMoment(ngModel.$viewValue)?scope.$$value$$=ngModel.$viewValue.format():scope.$$value$$=ngModel.$viewValue:scope.$$value$$=scope.schemaValidate.schema["default"]},scope.updateModel=function(value){return ngModel.$setViewValue(moment(value).format())}},{require:"ngModel",link:link,controller:controller,scope:{schemaValidate:"="},templateUrl:"datetimepicker.html"}})}.call(this),function(){angular.module("BB.Directives").directive("bbFbLogin",function(LoginService,$rootScope,AlertService,$window){return{restrict:"A",scope:!0,link:function(scope,element,attrs){var checkLoginState,loginToBBWithFBUser,options,statusChangeCallback;return options=scope.$eval(attrs.bbFbLogin)||{},$rootScope.connection_started.then(function(){return checkLoginState()}),statusChangeCallback=function(response){var params;"connected"===response.status?(params={},params.access_token=response.authResponse.accessToken,options.login_only&&(params.login_only=options.login_only),loginToBBWithFBUser(params)):"not_authorized"===response.status?scope.loginFB():scope.loginFB()},checkLoginState=function(){FB.getLoginStatus(function(response){statusChangeCallback(response)})},loginToBBWithFBUser=function(params){return LoginService.FBLogin(scope.bb.company,params).then(function(member){return $rootScope.member=member,scope.setClient($rootScope.member),scope.bb.destination?scope.redirectTo(scope.bb.destination):(scope.setLoaded(scope),scope.decideNextPage())},function(err){return"FACEBOOK-LOGIN-MEMBER-NOT-FOUND"===err.data.error?AlertService.raise("FB_LOGIN_NOT_A_MEMBER"):AlertService.raise("LOGIN_FAILED")})},scope.loginFB=function(){return FB.login(function(response){var params;"connected"===response.status?(params={},params.access_token=response.authResponse.accessToken,options.login_only&&(params.login_only=options.login_only),loginToBBWithFBUser(params)):"not_authorized"===response.status?AlertService.raise("LOGIN_FAILED"):AlertService.raise("LOGIN_FAILED")},{scope:"public_profile,email"})}}}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbFormDataStore",function(FormDataStoreService){return{require:"?bbWidget",link:function(scope){return FormDataStoreService.register(scope)}}})}.call(this),function(){var app;app=angular.module("BB.Directives"),app.directive("ngConfirmClick",function(){return{link:function(scope,element,attr){var clickAction,msg;return msg=attr.ngConfirmClick||"Are you sure?",clickAction=attr.ngConfirmedClick,element.bind("click",function(_this){return function(event){return window.confirm(msg)?scope.$eval(clickAction):void 0}}(this))}}}),app.directive("ngValidInclude",function($compile){return{link:function(scope,element,attr){return scope[attr.watchValue].then(function(_this){return function(logged){return element.attr("ng-include",attr.ngValidInclude),element.attr("ng-valid-include",null),$compile(element)(scope)}}(this))}}}),app.directive("ngDelayed",function($compile){return{link:function(scope,element,attr){return scope[attr.ngDelayedWatch].then(function(_this){return function(logged){return element.attr(attr.ngDelayed,attr.ngDelayedValue),element.attr("ng-delayed-value",null),element.attr("ng-delayed-watch",null),element.attr("ng-delayed",null),$compile(element)(scope),attr.ngDelayedReady?scope[attr.ngDelayedReady].resolve(!0):void 0}}(this))}}}),app.directive("ngInitial",function(){return{restrict:"A",controller:["$scope","$element","$attrs","$parse",function($scope,$element,$attrs,$parse){var getter,setter,val;return val=$attrs.ngInitial||$attrs.value,getter=$parse($attrs.ngModel),setter=getter.assign,"true"===val?val=!0:"false"===val&&(val=!1),setter($scope,val)}]}}),app.directive("bbPrintPage",function($window,$timeout){return{restrict:"A",link:function(scope,element,attr){return attr.bbPrintPage?scope.$watch(attr.bbPrintPage,function(_this){return function(newVal,oldVal){return $timeout(function(){return $window.print()},3e3)}}(this)):void 0}}}),app.directive("bbInclude",function($compile,$rootScope){return{link:function(scope,element,attr){var track_page;return track_page=null!=attr.bbTrackPage,scope.$watch("bb.path_setup",function(_this){return function(newval,oldval){return newval&&(element.attr("ng-include","'"+scope.getPartial(attr.bbInclude)+"'"),element.attr("bb-include",null),$compile(element)(scope),track_page)?$rootScope.$broadcast("page:loaded",attr.bbInclude):void 0}}(this))}}}),app.directive("bbRaiseAlertWhenInvalid",function($compile){return{require:"^form",link:function(scope,element,attr,ctrl){var options;return ctrl.raise_alerts=!0,options=scope.$eval(attr.bbRaiseAlertWhenInvalid),options&&options.alert?ctrl.alert=options.alert:void 0}}}),app.directive("bbHeader",function($compile){return{link:function(scope,element,attr){return scope.bb.waitForRoutes(),scope.$watch("bb.path_setup",function(_this){return function(newval,oldval){return newval?(element.attr("ng-include","'"+scope.getPartial(attr.bbHeader)+"'"),element.attr("bb-header",null),$compile(element)(scope)):void 0}}(this))}}}),app.directive("bbDate",function(){return{restrict:"AE",scope:!0,link:function(scope,element,attrs){var date,track_service;return track_service=null!=attrs.bbTrackService,date=attrs.bbDate?moment(scope.$eval(attrs.bbDate)):scope.bb&&scope.bb.current_item&&scope.bb.current_item.date?scope.bb.current_item.date.date:moment(),track_service&&scope.bb.current_item&&scope.bb.current_item.service&&(scope.min_date=scope.bb.current_item.service.min_advance_datetime,scope.max_date=scope.bb.current_item.service.max_advance_datetime),scope.$broadcast("dateChanged",moment(date)),scope.bb_date={date:date,js_date:date.toDate(),addDays:function(type,amount){return this.date=moment(this.date).add(amount,type),this.js_date=this.date.toDate(),scope.$broadcast("dateChanged",moment(this.date))},subtractDays:function(type,amount){return this.addDays(type,-amount)},setDate:function(date){return this.date=date,this.js_date=date.toDate(),scope.$broadcast("dateChanged",moment(this.date))}},scope.$on("currentItemUpdate",function(event){return scope.bb.current_item.service&&track_service&&(scope.min_date=scope.bb.current_item.service.min_advance_datetime,scope.max_date=scope.bb.current_item.service.max_advance_datetime,scope.bb_date.date.isBefore(scope.min_date,"day")&&scope.bb_date.setDate(scope.min_date.clone()),scope.bb_date.date.isAfter(scope.max_date,"day"))?scope.bb_date.setDate(scope.max_date.clone()):void 0}),scope.$watch("bb_date.js_date",function(newval,oldval){var ndate;return ndate=moment(newval),!scope.bb_date.date.isSame(ndate)&&(scope.bb_date.date=ndate,moment(ndate).isValid())?scope.$broadcast("dateChanged",moment(ndate)):void 0})}}}),app.directive("bbDebounce",function($timeout){return{restrict:"A",link:function(scope,element,attrs){var delay;return delay=400,attrs.bbDebounce&&(delay=attrs.bbDebounce),element.bind("click",function(_this){return function(){return $timeout(function(){return element.attr("disabled",!0)},0),$timeout(function(){return element.attr("disabled",!1)},delay)}}(this))}}}),app.directive("bbLocalNumber",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var prettyifyNumber;return prettyifyNumber=function(value){return value&&"0"!==value[0]&&(value="0"+value),value},ctrl.$formatters.push(prettyifyNumber)}}}),app.directive("bbPadWithZeros",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var how_many,options,padNumber;return options=scope.$eval(attrs.bbPadWithZeros)||{},how_many=options.how_many||2,padNumber=function(value){var i,index,padding,ref;if(value=String(value),value&&value.length<how_many){for(padding="",index=i=1,ref=how_many-value.length;ref>=1?ref>=i:i>=ref;index=ref>=1?++i:--i)padding+="0";value=padding.concat(value)}return value},ctrl.$formatters.push(padNumber)}}}),app.directive("bbFormResettable",function($parse){return{restrict:"A",controller:function($scope,$element,$attrs){return $scope.inputs=[],$scope.resetForm=function(options){var i,input,len,ref,results;for(options&&options.clear_submitted&&($scope[$attrs.name].submitted=!1),ref=$scope.inputs,results=[],i=0,len=ref.length;len>i;i++)input=ref[i],input.getter.assign($scope,null),results.push(input.controller.$setPristine());return results},{registerInput:function(input,ctrl){var getter;return getter=$parse(input),$scope.inputs.push({getter:getter,controller:ctrl})}}}}}),app.directive("bbResettable",function(){return{restrict:"A",require:["ngModel","^bbFormResettable"],link:function(scope,element,attrs,ctrls){var formResettableCtrl,ngModelCtrl;return ngModelCtrl=ctrls[0],formResettableCtrl=ctrls[1],formResettableCtrl.registerInput(attrs.ngModel,ngModelCtrl)}}}),app.directive("bbDateSplit",function($parse){return{restrict:"A",require:["ngModel"],link:function(scope,element,attrs,ctrls){var ngModel,question;return ngModel=ctrls[0],question=scope.$eval(attrs.bbDateSplit),question.date={day:null,month:null,year:null,date:null,joinDate:function(){var date_string;return this.day&&this.month&&this.year?(date_string=this.day+"/"+this.month+"/"+this.year,this.date=moment(date_string,"DD/MM/YYYY"),date_string=this.date.toISODate(),ngModel.$setViewValue(date_string),ngModel.$render()):void 0},splitDate:function(date){return date&&date.isValid()?(this.day=date.date(),this.month=date.month()+1,this.year=date.year(),this.date=date):void 0}},question.answer&&question.date.splitDate(moment(question.answer)),ngModel.$viewValue?question.date.splitDate(moment(ngModel.$viewValue)):void 0}}}),app.directive("bbCommPref",function(){return{restrict:"A",require:["ngModel"],link:function(scope,element,attrs,ctrls){var comm_pref,ng_model_ctrl,parser;return ng_model_ctrl=ctrls[0],comm_pref=scope.$eval(attrs.bbCommPref)||!1,null!=scope.bb.current_item.settings.send_email_followup&&null!=scope.bb.current_item.settings.send_sms_followup?comm_pref=scope.bb.current_item.settings.send_email_followup:(scope.bb.current_item.settings.send_email_followup=comm_pref,scope.bb.current_item.settings.send_sms_followup=comm_pref),ng_model_ctrl.$setViewValue(comm_pref),parser=function(value){return scope.bb.current_item.settings.send_email_followup=value,scope.bb.current_item.settings.send_sms_followup=value,value},ng_model_ctrl.$parsers.push(parser)}}}),app.directive("bbCountTicketTypes",function($rootScope){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var countTicketTypes;return $rootScope.connection_started.then(function(){return countTicketTypes()}),scope.$on("basket:updated",function(event,basket){return countTicketTypes()}),countTicketTypes=function(items){var counts,i,item,len;for(items=scope.bb.basket.timeItems(),counts=[],i=0,len=items.length;len>i;i++)item=items[i],item.tickets&&(counts[item.tickets.name]?counts[item.tickets.name]+=item.tickets.qty:counts[item.tickets.name]=item.tickets.qty,item.number=counts[item.tickets.name]);return scope.counts=counts}}}}),app.directive("bbCapitaliseFirstLetter",function(){return{restrict:"A",require:["ngModel"],link:function(scope,element,attrs,ctrls){var ngModel;return ngModel=ctrls[0],scope.$watch(attrs.ngModel,function(newval,oldval){var string;newval&&(string=scope.$eval(attrs.ngModel),string=string.charAt(0).toUpperCase()+string.slice(1),ngModel.$setViewValue(string),ngModel.$render())})}}}),app.directive("bbApiUrl",function($rootScope,$compile,$sniffer,$timeout,$window,$location){return{restrict:"A",scope:{apiUrl:"@bbApiUrl"},compile:function(tElem,tAttrs){return{pre:function(scope,element,attrs){var src,url;return $rootScope.bb||($rootScope.bb={}),$rootScope.bb.api_url=scope.apiUrl,url=document.createElement("a"),url.href=scope.apiUrl,($sniffer.msie&&$sniffer.msie<=9||$sniffer.webkit&&$sniffer.webkit<537)&&""!==url.host&&url.host!==$location.host()&&url.host!==$location.host()+":"+$location.port()?(src=":"===url.protocol[url.protocol.length-1]?url.protocol+"//"+url.host+"/ClientProxy.html":url.protocol+"://"+url.host+"/ClientProxy.html",$rootScope.iframe_proxy_ready=!1,$compile("<iframe id='ieapiframefix' name='"+url.hostname+("' src='"+src+"' style='visibility:false;display:none;'></iframe>"))(scope,function(_this){return function(cloned,scope){return cloned.bind("load",function(){return $rootScope.iframe_proxy_ready=!0,$rootScope.$broadcast("iframe_proxy_ready",{iframe_proxy_ready:!0})}),element.append(cloned)}}(this))):void 0}}}}}),app.directive("bbPriceFilter",function(PathSvc){return{restrict:"AE",replace:!0,scope:!1,require:"^?bbServices",templateUrl:function(element,attrs){return PathSvc.directivePartial("_price_filter")},controller:function($scope,$attrs){var setPricefilter,suitable_max;return $scope.$watch("items",function(new_val,old_val){return new_val?setPricefilter(new_val):void 0}),setPricefilter=function(items){return $scope.price_array=_.uniq(_.map(items,function(item){return item.price/100||0})),$scope.price_array.sort(function(a,b){return a-b}),suitable_max()},suitable_max=function(){var max_number,min_number,top_number;return top_number=_.last($scope.price_array),max_number=function(){switch(!1){case!(1>top_number):return 0;case!(11>top_number):return 10;case!(51>top_number):return 50;case!(101>top_number):return 100;case!(1e3>top_number):return 100*Math.ceil(top_number/100)}}(),min_number=0,$scope.price_options={min:min_number,max:max_number},$scope.filters.price={min:min_number,max:max_number}},$scope.$watch("filters.price.min",function(new_val,old_val){return new_val!==old_val?$scope.filterChanged():void 0}),$scope.$watch("filters.price.max",function(new_val,old_val){return new_val!==old_val?$scope.filterChanged():void 0})}}}),angular.module("BB.Directives").directive("bbBookingExport",function(){return{restrict:"AE",scope:!0,template:'<div bb-include="_popout_export_booking" style="display: inline-block"></div>',link:function(scope,el,attrs){var setHTML;return scope.$watch("total",function(new_val,old_val){return new_val?setHTML(new_val):void 0}),scope.$watch("purchase",function(new_val,old_val){return new_val?setHTML(new_val):void 0}),setHTML=function(purchase_total){return scope.html="<div class='text-center'><a href='"+purchase_total.webcalLink()+"'><img src='images/outlook.png' alt='outlook calendar icon' height='30' width='30' /><div class='clearfix'></div><span>Outlook</span></a></div><p></p>"+("<div class='text-center'><a href='"+purchase_total.gcalLink()+"'><img src='images/google.png' alt='google calendar icon' height='30' width='30' /><div class='clearfix'></div><span>Google</span></a></div><p></p>")+("<div class='text-center'><a href='"+purchase_total.icalLink()+"'><img src='images/ical.png' alt='ical calendar icon' height='30' width='30' /><div class='clearfix'></div><span>iCal</span></a></div>")}}}}),angular.module("BB.Directives").directive("bbBlurOnReturn",function($timeout){return{restrict:"A",require:"ngModel",link:function(scope,el,attrs){return el.keydown(function(e){var key;return key=e.which||e.keyCode,13===key||"13"===key?$timeout(function(){return e.target?e.target.blur():void 0},10):void 0})}}})}.call(this),function(){"use strict";var app,isEmpty;app=angular.module("BB.Directives"),app.directive("bbQuestionLine",function($compile){return{transclude:!1,restrict:"A",link:function(scope,element,attrs){var e,elm,html,index;return"heading"===scope.question.detail_type&&(elm="",scope.question.name.length>0&&(elm+="<div class='bb-question-heading'>"+scope.question.name+"</div>"),scope.question.help_text&&scope.question.help_text.length>0&&(elm+="<div class='bb-question-help-text'>"+scope.question.help_text+"</div>"),element.html(elm)),scope.idmaps&&(scope.idmaps[scope.question.detail_type]&&scope.idmaps[scope.question.detail_type].block||scope.idmaps[scope.question.id]&&scope.idmaps[scope.question.id].block)?(index=scope.idmaps[scope.question.id]?scope.question.id:scope.question.detail_type,html=scope.$parent.idmaps[index].html,e=$compile(html)(scope,function(_this){return function(cloned,scope){return element.replaceWith(cloned)}}(this))):void 0}}}),app.directive("bbQuestion",function($compile,$timeout){return{priority:0,replace:!0,transclude:!1,restrict:"A",compile:function(el,attr,trans){return{pre:function(scope,element,attrs){var adminRequired,date_format,date_format_2;return adminRequired=null!=attrs.bbAdminRequired,date_format="DD/MM/YYYY",date_format_2="dd/MM/yyyy",null!=attrs.bbDateFormat&&"US"===attrs.bbDateFormat&&(date_format="MM/DD/YYYY",date_format_2="MM/dd/yyyy"),scope.$watch(attrs.bbQuestion,function(question){var e,html,i,index,itemx,j,k,lastName,len1,len2,len3,name,placeholder,ref,ref1,ref2;if(question){if(html="",lastName="",placeholder="",null!=attrs.defaultPlaceholder&&"text_area"===question.detail_type|"text_field"===question.detail_type&&(question["default"]&&(placeholder=question["default"]),question.answer===question["default"]&&(question.answer="")),scope.recalc=function(_this){return function(){return angular.isDefined(scope.recalc_price)&&(question.outcome||scope.recalc_price()),angular.isDefined(scope.recalc_question)?scope.recalc_question():void 0}}(this),scope.idmaps&&(scope.idmaps[question.detail_type]||scope.idmaps[question.id]))index=scope.idmaps[scope.question.id]?scope.question.id:scope.question.detail_type,html=scope.idmaps[index].html;else if("select"===question.detail_type||"select-price"===question.detail_type){for(html="<select ng-model='question.answer' name='q"+question.id+"' id='"+question.id+"' ng-change='recalc()' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' class='form-question form-control'>",ref=question.options,i=0,len1=ref.length;len1>i;i++)itemx=ref[i],html+="<option data_id='"+itemx.id+"' value='"+itemx.name.replace(/'/g,"&apos;")+"'>"+itemx.display_name+"</option>";html+="</select>"}else if("text_area"===question.detail_type)html="<textarea placeholder='"+placeholder+"' ng-model='question.answer' name='q"+question.id+"' id='"+question.id+"' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' rows=3 class='form-question form-control'>"+question.answer+"</textarea>";else if("radio"===question.detail_type){for(html='<div class="radio-group">',ref1=question.options,j=0,len2=ref1.length;len2>j;j++)itemx=ref1[j],html+="<div class='radio'><label class='radio-label'><input ng-model='question.answer' name='q"+question.id+"' id='"+question.id+"' ng-change='recalc()' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' type='radio' value=\""+itemx.name+'"/>'+itemx.name+"</label></div>";html+="</div>"}else if("check"===question.detail_type)name=question.name,name===lastName&&(name=""),lastName=question.name,html="<div class='checkbox' ng-class='{\"selected\": question.answer}'><label><input name='q"+question.id+"' id='"+question.id+"' ng-model='question.answer' ng-checked='question.answer == \"1\"' ng-change='recalc()' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' type='checkbox' value=1>"+name+"</label></div>";else if("check-price"===question.detail_type)html="<div class='checkbox'><label><input name='q"+question.id+"' id='"+question.id+"' ng-model='question.answer' ng-checked='question.answer == \"1\"' ng-change='recalc()' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' type='checkbox' value=1> ({{question.price | currency:'GBP'}})</label></div>";else if("radio-price"===question.detail_type){for(html='<div class="radio-group">',ref2=question.options,k=0,len3=ref2.length;len3>k;k++)itemx=ref2[k],html+="<div class='radio'><label class='radio-label'><input ng-model='question.answer' name='q"+question.id+"' id='"+question.id+"' ng-change='recalc()' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' type='radio' value=\""+itemx.name+'"/>'+itemx.display_name+"</label></div>";html+="</div>"}else html="date"===question.detail_type?"<div class='input-group date-picker'> <input type='text' class='form-question form-control' name='q"+question.id+"' id='"+question.id+"' bb-datepicker-popup='"+date_format+"' datepicker-popup='"+date_format_2+"' ng-model='question.answer' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' datepicker-options='{\"starting-day\": 1}' show-weeks='false' show-button-bar='false' is-open='opened' /> <span class='input-group-btn' ng-click='$event.preventDefault();$event.stopPropagation();opened=true'> <button class='btn btn-default' type='submit'><span class='glyphicon glyphicon-calendar'></span></button> </span> </div>":"<input type='text' placeholder='"+placeholder+"'  ng-model='question.answer' name='q"+question.id+"' id='"+question.id+"' ng-required='question.currentlyShown && (("+adminRequired+" && question.required) || (question.required && !bb.isAdmin))' class='form-question form-control'/>";if(html)return e=$compile(html)(scope,function(_this){return function(cloned,scope){return element.replaceWith(cloned)}}(this))}})},post:function(scope,$e,$a,parentControl){}}}}}),app.directive("bbQuestionSetup",function(){return{restrict:"A",terminal:!0,priority:1e3,link:function(scope,element,attrs){var block,child,def,i,id,idmaps,index,len1,ref;for(idmaps={},def=null,ref=element.children(),index=i=0,len1=ref.length;len1>i;index=++i)child=ref[index],id=$(child).attr("bb-question-id"),block=!1,$(child).attr("bb-replace-block")&&(block=!0),child.innerHTML=child.innerHTML.replace(/question_form/g,"question_form_"+index),idmaps[id]={id:id,html:child.innerHTML,block:block};return scope.idmaps=idmaps,element.replaceWith("")}}}),app.directive("bbFocus",[function(){var FOCUS_CLASS;return FOCUS_CLASS="bb-focused",{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){return ctrl.$focused=!1,element.bind("focus",function(evt){return element.addClass(FOCUS_CLASS),scope.$apply(function(){return ctrl.$focused=!0})}).bind("blur",function(evt){return element.removeClass(FOCUS_CLASS),scope.$apply(function(){return ctrl.$focused=!1})})}}}]),app.directive("bbCurrencyField",function($filter){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var convertToCurrency,convertToInteger;return convertToCurrency=function(value){return value/100},convertToInteger=function(value){return 100*value},ctrl.$formatters.push(convertToCurrency),ctrl.$parsers.push(convertToInteger)}}}),isEmpty=function(value){return angular.isUndefined(value)||""===value||null===value||value!==value},app.directive("ngMin",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){var minValidator;minValidator=function(value){var min;return min=scope.$eval(attr.ngMin)||0,ctrl.$setValidity("ngMin",isEmpty(value)||value>=min),value},ctrl.$parsers.push(minValidator),ctrl.$formatters.push(minValidator)}}}),app.directive("ngMax",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){var maxValidator;maxValidator=function(value){var max;return max=scope.$eval(attr.ngMax),ctrl.$setValidity("ngMax",isEmpty(value)||max>=value),value},ctrl.$parsers.push(maxValidator),ctrl.$formatters.push(maxValidator)}}}),app.directive("creditCardNumber",function(){var getCardType,isValid,linker;return getCardType=function(ccnumber){return ccnumber?(ccnumber=ccnumber.toString().replace(/\s+/g,""),/^(34)|^(37)/.test(ccnumber)?"american_express":/^(62)|^(88)/.test(ccnumber)?"china_unionpay":/^30[0-5]/.test(ccnumber)?"diners_club_carte_blanche":/^(2014)|^(2149)/.test(ccnumber)?"diners_club_enroute":/^36/.test(ccnumber)?"diners_club_international":/^(6011)|^(622(1(2[6-9]|[3-9][0-9])|[2-8][0-9]{2}|9([01][0-9]|2[0-5])))|^(64[4-9])|^65/.test(ccnumber)?"discover":/^35(2[89]|[3-8][0-9])/.test(ccnumber)?"jcb":/^(6304)|^(6706)|^(6771)|^(6709)/.test(ccnumber)?"laser":/^(5018)|^(5020)|^(5038)|^(5893)|^(6304)|^(6759)|^(6761)|^(6762)|^(6763)|^(0604)/.test(ccnumber)?"maestro":/^5[1-5]/.test(ccnumber)?"master":/^4/.test(ccnumber)?"visa":/^(4026)|^(417500)|^(4405)|^(4508)|^(4844)|^(4913)|^(4917)/.test(ccnumber)?"visa_electron":void 0):""},isValid=function(ccnumber){var len,mul,prodArr,sum;if(!ccnumber)return!1;for(ccnumber=ccnumber.toString().replace(/\s+/g,""),len=ccnumber.length,mul=0,prodArr=[[0,1,2,3,4,5,6,7,8,9],[0,2,4,6,8,1,3,5,7,9]],sum=0;len--;)sum+=prodArr[mul][parseInt(ccnumber.charAt(len),10)],mul^=1;return sum%10===0&&sum>0},linker=function(scope,element,attributes,ngModel){return scope.$watch(function(){return ngModel.$modelValue},function(newValue){return ngModel.$setValidity("card_number",isValid(newValue)),scope.cardType=getCardType(newValue),null!=newValue&&16===newValue.length?ngModel.$invalid?(element.parent().addClass("has-error"),element.parent().removeClass("has-success")):(element.parent().removeClass("has-error"),element.parent().addClass("has-success")):element.parent().removeClass("has-success")})},{restrict:"C",require:"ngModel",link:linker,scope:{cardType:"="}}}),app.directive("cardSecurityCode",function(){var linker;return linker=function(scope,element,attributes){return scope.$watch("cardType",function(newValue){return"american_express"===newValue?(element.attr("maxlength",4),element.attr("placeholder","••••")):(element.attr("maxlength",3),element.attr("placeholder","•••"))})},{restrict:"AC",link:linker,scope:{cardType:"="}}}),app.directive("bbInputGroupManager",function(ValidatorService){return{restrict:"A",controller:function($scope,$element,$attrs){return $scope.input_manger={input_groups:{},inputs:[],registerInput:function(input,name){return this.inputs.indexOf(input.$name)>=0?void 0:(this.inputs.push(input.$name),this.input_groups[name]||(this.input_groups[name]={inputs:[],valid:!1}),this.input_groups[name].inputs.push(input))},validateInputGroup:function(name){var i,input,is_valid,j,len1,len2,ref,ref1;for(is_valid=!1,ref=this.input_groups[name].inputs,i=0,len1=ref.length;len1>i&&(input=ref[i],!(is_valid=input.$modelValue));i++);if(is_valid===!this.input_groups[name].valid){for(ref1=this.input_groups[name].inputs,j=0,len2=ref1.length;len2>j;j++)input=ref1[j],input.$setValidity(input.$name,is_valid);return this.input_groups[name].valid=is_valid}}},$element.on("submit",function(){var input_group,results;results=[];for(input_group in $scope.input_manger.input_groups)results.push($scope.input_manger.validateInputGroup(input_group));return results})}}}),app.directive("bbInputGroup",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ngModel){return scope.input_manger.inputs.indexOf(ngModel.$name)>=0?void 0:(scope.input_manger.registerInput(ngModel,attrs.bbInputGroup),scope.$watch(attrs.ngModel,function(newval,oldval){return newval===!oldval?scope.input_manger.validateInputGroup(attrs.bbInputGroup):void 0}))}}}),app.directive("bbQuestionLabel",function($compile){return{transclude:!1,restrict:"A",scope:!1,link:function(scope,element,attrs){return scope.$watch(attrs.bbQuestionLabel,function(question){return!question||"check"!==question.detail_type&&"check-price"!==question.detail_type?void 0:element.html("");
})}}}),app.directive("bbQuestionLink",function($compile){return{transclude:!1,restrict:"A",scope:!0,link:function(scope,element,attrs){var id;return id=parseInt(attrs.bbQuestionLink),scope.$watch("question_set",function(newval,oldval){var i,len1,q,ref,results;if(newval){for(ref=scope.question_set,results=[],i=0,len1=ref.length;len1>i;i++)q=ref[i],q.id===id?(scope.question=q,element.attr("ng-model","question.answer"),element.attr("bb-question-link",null),results.push($compile(element)(scope))):results.push(void 0);return results}})}}}),app.directive("bbQuestionSet",function($compile){return{transclude:!1,restrict:"A",scope:!0,link:function(scope,element,attrs){var set;return set=attrs.bbQuestionSet,element.addClass("ng-hide"),scope.$watch(set,function(newval,oldval){return newval?(scope.question_set=newval,element.removeClass("ng-hide")):void 0})}}}),app.directive("bbMatchInput",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl,ngModel){var compare;return scope.$watch(attrs.bbMatchInput,function(){return scope.val_1=scope.$eval(attrs.bbMatchInput),compare(ctrl.$viewValue)}),compare=function(value){return ctrl.$setValidity("match",scope.val_1===value),value},ctrl.$parsers.push(compare)}}})}.call(this),function(){var app;app=angular.module("BB.Directives"),app.directive("bbIntTelNumber",function($parse){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var format,isValid,options,parse;return options=scope.$eval(attrs.bbIntTelNumber),element.intlTelInput(options),isValid=function(value){return value?element.intlTelInput("isValidNumber"):!0},format=function(value){var str;return str="",null!=scope.$eval(attrs.ngModel+"_prefix")&&(str+="+"+scope.$eval(attrs.ngModel+"_prefix")+" "),null!=scope.$eval(attrs.ngModel)&&(str+=scope.$eval(attrs.ngModel)),"+"===str[0]&&(element.intlTelInput("setNumber","+"+scope.$eval(attrs.ngModel+"_prefix")+" "+scope.$eval(attrs.ngModel)),ctrl.$setValidity("phone",isValid(value))),str},parse=function(value){var getter,prefix;return prefix=element.intlTelInput("getSelectedCountryData").dialCode,getter=$parse(attrs.ngModel+"_prefix"),getter.assign(scope,prefix),ctrl.$setValidity("phone",isValid(value)),value},ctrl.$formatters.push(format),ctrl.$parsers.push(parse)}}})}.call(this),function(){"use strict";var app;app=angular.module("BB.Directives"),app.directive("bbLoader",function($rootScope,$compile,PathSvc,TemplateSvc){return{restrict:"A",replace:!1,scope:{},controllerAs:"LoaderCtrl",controller:function($scope){var addScopeId,hideLoader,parentScopeId,removeScopeId,scopeIdArr,showLoader;parentScopeId=$scope.$parent.$id,scopeIdArr=[],addScopeId=function(id){scopeIdArr.push(id),scopeIdArr=_.uniq(scopeIdArr)},removeScopeId=function(id){return scopeIdArr=_.without(scopeIdArr,id),scopeIdArr.length},showLoader=function(e,cscope){var sid;for(sid=cscope.$id;cscope;){if(cscope.$id===parentScopeId){addScopeId(sid),$scope.scopeLoaded=!1;break}cscope=cscope.$parent}},hideLoader=function(e,cscope){removeScopeId(cscope.$id)||($scope.scopeLoaded=!0)},$rootScope.$on("show:loader",showLoader),$rootScope.$on("hide:loader",hideLoader),$scope.scopeLoaded=!1},link:function(scope,element,attrs){TemplateSvc.get(PathSvc.directivePartial("loader")).then(function(html){var str;_.isString(attrs.bbLoader)&&(str=attrs.bbLoader.slice(1),/^#/.test(attrs.bbLoader)?html.attr("id",str):/^\./.test(attrs.bbLoader)&&html.addClass(str)),element.prepend(html),$compile(html)(scope)})}}}),app.directive("bbLoadingSpinner",function($compile){return{transclude:!0,link:function(scope,element,attrs,controller,transclude){var loadingScopes;return loadingScopes={},scope.isLoading=!1,scope.$on("isLoading",function(event,isLoading){return event.stopPropagation(),loadingScopes[event.targetScope.$id]=isLoading,scope.isLoading=_.every(_.values(loadingScopes))})},template:'<div ng-show="isLoading" class="loader-wrapper">\n  <div class="loader"></div>\n</div>\n<div ng-transclude></div>'}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbContent",function($compile){return{transclude:!1,restrict:"A",link:function(scope,element,attrs){return element.attr("ng-include","bb_main"),element.attr("onLoad","initPage()"),element.attr("bb-content",null),element.attr("ng-hide","hide_page"),scope.initPage=function(_this){return function(){return scope.setPageLoaded(),scope.setLoadingPage(!1)}}(this),$compile(element)(scope)}}}),angular.module("BB.Directives").directive("bbLoading",function($compile){return{transclude:!1,restrict:"A",link:function(scope,element,attrs){scope.scopeLoaded=scope.areScopesLoaded(scope),element.attr("ng-hide","scopeLoaded"),element.attr("bb-loading",null),$compile(element)(scope)}}}),angular.module("BB.Directives").directive("bbWaitFor",function($compile){return{transclude:!1,restrict:"A",priority:800,link:function(scope,element,attrs){var name,prom;name=attrs.bbWaitVar,name||(name="allDone"),scope[name]=!1,prom=scope.$eval(attrs.bbWaitFor),prom.then(function(){return scope[name]=!0})}}}),angular.module("BB.Directives").directive("bbScrollTo",function($rootScope,AppConfig,BreadcrumbService,$bbug,$window,SettingsService){return{transclude:!1,restrict:"A",link:function(scope,element,attrs){var always_scroll,bb_transition_time,evnts,scrollToCallback;return evnts=attrs.bbScrollTo.split(","),always_scroll=null!=attrs.bbAlwaysScroll||!1,bb_transition_time=null!=attrs.bbTransitionTime?parseInt(attrs.bbTransitionTime,10):500,angular.isArray(evnts)?angular.forEach(evnts,function(evnt){return scope.$on(evnt,function(e){return scrollToCallback(evnt)})}):scope.$on(evnts,function(e){return scrollToCallback(evnts)}),scrollToCallback=function(evnt){var current_step,scroll_to_element;return scroll_to_element=$bbug("page:loaded"===evnt&&scope.display&&scope.display.xs&&$bbug('[data-scroll-id="'+AppConfig.uid+'"]').length?'[data-scroll-id="'+AppConfig.uid+'"]':element),current_step=BreadcrumbService.getCurrentStep(),scroll_to_element&&("page:loaded"===evnt&&current_step>1||always_scroll||"widget:restart"===evnt||!scroll_to_element.is(":visible")&&0!==scroll_to_element.offset().top)?"parentIFrame"in $window?parentIFrame.scrollToOffset(0,scroll_to_element.offset().top-SettingsService.getScrollOffset()):$bbug("html, body").animate({scrollTop:scroll_to_element.offset().top-SettingsService.getScrollOffset()},bb_transition_time):void 0}}}}),angular.module("BB.Directives").directive("bbSlotGrouper",function(){return{restrict:"A",scope:!0,link:function(scope,element,attrs){var i,len,slot,slots;if(slots=scope.$eval(attrs.slots)){for(scope.grouped_slots=[],i=0,len=slots.length;len>i;i++)slot=slots[i],slot.time>=scope.$eval(attrs.startTime)&&slot.time<scope.$eval(attrs.endTime)&&scope.grouped_slots.push(slot);return scope.has_slots=scope.grouped_slots.length>0}}}}),angular.module("BB.Directives").directive("bbForm",function($bbug,$window,SettingsService){return{restrict:"A",require:"^form",link:function(scope,elem,attrs,ctrls){var form_controller;return form_controller=ctrls,elem.on("submit",function(){var invalid_form_group,invalid_input,property;form_controller.submitted=!0;for(property in form_controller)angular.isObject(form_controller[property])&&form_controller[property].hasOwnProperty("$valid")&&(form_controller[property].submitted=!0);return scope.$apply(),invalid_form_group=elem.find(".has-error:first"),invalid_form_group&&invalid_form_group.length>0?("parentIFrame"in $window?parentIFrame.scrollToOffset(0,invalid_form_group.offset().top-SettingsService.getScrollOffset()):$bbug("html, body").animate({scrollTop:invalid_form_group.offset().top-SettingsService.getScrollOffset()},1e3),invalid_input=invalid_form_group.find(".ng-invalid"),invalid_input.focus(),!1):!0})}}}),angular.module("BB.Directives").directive("bbAddressMap",function($document){return{restrict:"A",scope:!0,replace:!0,controller:function($scope,$element,$attrs){return $scope.isDraggable=$document.width()>480,$scope.$watch($attrs.bbAddressMap,function(new_val,old_val){var map_item;if(new_val)return map_item=new_val,$scope.map={center:{latitude:map_item.lat,longitude:map_item["long"]},zoom:15},$scope.options={scrollwheel:!1,draggable:$scope.isDraggable},$scope.marker={id:0,coords:{latitude:map_item.lat,longitude:map_item["long"]}}})}}}),angular.module("BB.Directives").directive("bbMergeDuplicateQuestions",function(){return{restrict:"A",scope:!0,controller:function($scope,$rootScope){return $scope.questions={},$rootScope.$on("item_details:loaded",function(){var i,item,j,len,len1,question,ref,ref1;for(ref=$scope.bb.stacked_items,i=0,len=ref.length;len>i;i++)if(item=ref[i],item.item_details&&item.item_details.questions)for(item.item_details.hide_questions=!1,ref1=item.item_details.questions,j=0,len1=ref1.length;len1>j;j++){if(question=ref1[j],$scope.questions[question.id]){item.setCloneAnswers($scope.questions[question.id].item),item.item_details.hide_questions=!0;break}$scope.questions[question.id]={question:question,item:item}}return $scope.has_questions=_.pluck($scope.questions,"question").length>0})}}}),angular.module("BB.Directives").directive("bbModal",function($window,$bbug,$timeout){return{restrict:"A",scope:!0,link:function(scope,elem,attrs){var deregisterWatcher;return $timeout(function(){return elem.parent().parent().parent().css("z-index",999999)},deregisterWatcher=scope.$watch(function(){var height,modal_padding,new_height;return height=elem.height(),modal_padding=$bbug(window).width()>=769?200:20,height>$bbug(window).height()?(new_height=$bbug(window).height()-modal_padding,elem.css({height:new_height+"px","overflow-y":"scroll"}),deregisterWatcher()):void 0}))}}}),angular.module("BB.Directives").directive("bbBackgroundImage",function(){return{restrict:"A",scope:!0,link:function(scope,el,attrs){var killWatch;if(attrs.bbBackgroundImage&&""!==attrs.bbBackgroundImage)return killWatch=scope.$watch(attrs.bbBackgroundImage,function(new_val,old_val){return new_val?(killWatch(),el.css("background-image",'url("'+new_val+'")')):void 0})}}}),angular.module("BB.Directives").directive("bbCapacityView",function(){return{restrict:"A",template:"{{capacity_view_description}}",link:function(scope,el,attrs){var killWatch,ticket_type;return ticket_type=attrs.ticketTypeSingular||"ticket",killWatch=scope.$watch(attrs.bbCapacityView,function(item){var num_spaces_plural,spaces_left_plural;if(item)switch(killWatch(),num_spaces_plural=item.num_spaces>1?"s":"",spaces_left_plural=item.spaces_left>1?"s":"",item.chain.capacity_view){case"NUM_SPACES":return scope.capacity_view_description=scope.ticket_spaces=item.num_spaces+" "+ticket_type+num_spaces_plural;case"NUM_SPACES_LEFT":return scope.capacity_view_description=scope.ticket_spaces=item.spaces_left+" "+ticket_type+spaces_left_plural+" available";case"NUM_SPACES_AND_SPACES_LEFT":return scope.capacity_view_description=scope.ticket_spaces=item.spaces_left+" of "+item.num_spaces+" "+ticket_type+num_spaces_plural+" available"}})}}})}.call(this),function(){angular.module("BB").directive("bbMemberLogin",function(PathSvc){return{restrict:"A",controller:"MemberLogin",templateUrl:function(elem,attrs){return null!=attrs.bbCustomLoginForm?PathSvc.directivePartial("_member_login_form"):PathSvc.directivePartial("_member_login_schema_form")}}}),angular.module("BB.Controllers").controller("MemberLogin",function($scope,$log,$rootScope,$templateCache,$q,halClient,BBModel,$sessionStorage,$window,AlertService,LoginService,ValidatorService){return $scope.login_form={},$scope.validator=ValidatorService,$rootScope.connection_started.then(function(){return LoginService.checkLogin()?($scope.setClient($rootScope.member),$scope.bb.destination?$scope.redirectTo($scope.bb.destination):($scope.setLoaded($scope),$scope.decideNextPage())):halClient.$get($scope.bb.api_url+"/api/v1").then(function(root){return root.$get("new_login").then(function(new_login){return $scope.form=new_login.form,$scope.schema=new_login.schema},function(err){return console.log("err ",err)})},function(err){return console.log("err ",err)})}),$scope.submit=function(form){return form.role="member",$scope.company.$post("login",{},form).then(function(login){return login.$has("members")?login.$get("members").then(function(members){return $scope.handleLogin(members[0])}):login.$has("member")?login.$get("member").then(function(member){return $scope.handleLogin(member)}):void 0},function(err){return"Account has been disabled"===err.data.error?AlertService.raise("ACCOUNT_DISABLED"):AlertService.raise("LOGIN_FAILED")})},$scope.handleLogin=function(member){return member=LoginService.setLogin(member,$scope.login_form.persist_login),$scope.setClient(member),$scope.bb.destination?$scope.redirectTo($scope.bb.destination):($scope.skipThisStep(),$scope.decideNextPage())}})}.call(this),function(){angular.module("BB.Directives").directive("bbMonthPicker",function(PathSvc,$timeout){return{restrict:"AE",replace:!0,scope:!0,require:["^?bbEvents","^?bbMultiCompanyEvents"],templateUrl:function(element,attrs){return PathSvc.directivePartial("_month_picker")},link:function(scope,el,attrs){var stopWatch;return scope.picker_settings=scope.$eval(attrs.bbMonthPicker)||{},scope.picker_settings.months_to_show=scope.picker_settings.months_to_show||3,stopWatch=scope.$watch(attrs.dayData,function(dates){return dates?(scope.processDates(dates),stopWatch()):void 0})},controller:function($scope){return $scope.processDates=function(dates){var cur_month,d,date,datehash,day,day_data,diff,i,j,k,l,last_date,len,m,month,months,ref,w,week;for(datehash={},i=0,len=dates.length;len>i;i++)date=dates[i],datehash[date.date.format("DDMMYY")]=date,!$scope.first_available_day&&date.spaces>0&&($scope.first_available_day=date.date);for(cur_month=$scope.picker_settings.start_at_first_available_day?$scope.first_available_day.clone().startOf("month"):moment().startOf("month"),last_date=_.last(dates),diff=last_date.date.diff(cur_month,"months"),diff=diff>0?diff+1:1,$scope.num_months=$scope.picker_settings&&$scope.picker_settings.months?$scope.picker_settings.months:diff,months=[],m=j=1,ref=$scope.num_months;ref>=1?ref>=j:j>=ref;m=ref>=1?++j:--j){for(date=cur_month.clone().startOf("week"),month={weeks:[]},month.index=m-1,w=k=1;6>=k;w=++k){for(week={days:[]},d=l=1;7>=l;d=++l)date.isSame(date.clone().startOf("month"),"day")&&!month.start_date&&(month.start_date=date.clone()),day_data=datehash[date.format("DDMMYY")],day={date:date.clone(),data:day_data,available:day_data&&day_data.spaces&&day_data.spaces>0,today:moment().isSame(date,"day"),past:date.isBefore(moment(),"day"),disabled:!month.start_date||!date.isSame(month.start_date,"month")},week.days.push(day),$scope.selected_date&&day.date.isSame($scope.selected_date,"day")&&(day.selected=!0,$scope.selected_day=day),date.add(1,"day");month.weeks.push(week)}months.push(month),cur_month.add(1,"month")}return $scope.months=months,$scope.slick_config={nextArrow:".month-next",prevArrow:".month-prev",slidesToShow:$scope.months.length>=$scope.picker_settings.months_to_show?$scope.picker_settings.months_to_show:$scope.months.length,infinite:!1,responsive:[{breakpoint:1200,settings:{slidesToShow:$scope.months.length>=2?2:$scope.months.length}},{breakpoint:992,settings:{slidesToShow:1}}],method:{},event:{init:function(event,slick){return $timeout(function(){var len1,n,ref1,results;if(null!=$scope.selected_day){for(ref1=$scope.months,results=[],n=0,len1=ref1.length;len1>n;n++)m=ref1[n],m.start_date.month()===$scope.selected_day.date.month()?results.push(slick.slickGoTo(m.index)):results.push(void 0);return results}})}}}},$scope.$on("event_list_filter_date:changed",function(event,date){return $scope.selected_day?$scope.selected_day.selected=!1:void 0}),$scope.toggleDay=function(day){return day&&(!day.data||0!==day.data.spaces&&!day.disabled&&day.available)&&(day.data||day._d)?($scope.selected_day&&($scope.selected_day.selected=!1),(!$scope.selected_day||$scope.selected_day&&!day.date.isSame($scope.selected_day.date,"day"))&&(day.selected=!0,$scope.selected_day=day),$scope.showDay(day.date)):void 0}}}})}.call(this),function(){angular.module("BB.Directives").directive("ngOptions",function($sniffer,$rootScope){return{restrict:"A",link:function(scope,el,attrs){var size;return size=parseInt(attrs.size,10),!isNaN(size)&&size>1&&$sniffer.msie?$rootScope.$on("loading:finished",function(){return el.focus(),$("body").focus()}):void 0}}})}.call(this),function(){"use strict";var app;app=angular.module("BB.Directives"),app.directive("script",function($compile,halClient){return{transclude:!1,restrict:"E",link:function(scope,element,attrs){var body,json,res;return"text/hal-object"===attrs.type?(body=element[0].innerText,json=$bbug.parseJSON(body),res=halClient.$parse(json)):void 0}}})}.call(this),function(){angular.module("BB.Directives").directive("bbPaymentButton",function($compile,$sce,$http,$templateCache,$q,$log,TemplateSvc){var getButtonFormTemplate,getTemplate,linker,setClassAndValue;return getTemplate=function(type,scope){switch(type){case"button_form":return getButtonFormTemplate(scope);case"page":return TemplateSvc.get("payment.html");case"location":return"<a href='{{payment_link}}'>{{label}}</a>";default:return""}},getButtonFormTemplate=function(scope){var src;return src=$sce.parseAsResourceUrl("'"+scope.payment_link+"'")(),$http.get(src,{}).then(function(response){return response.data})},setClassAndValue=function(scope,element,attributes){var c,i,inputs,j,len,main_tag,ref,results;switch(scope.link_type){case"button_form":inputs=element.find("input"),main_tag=function(){var j,len,results;for(results=[],j=0,len=inputs.length;len>j;j++)i=inputs[j],"submit"===$(i).attr("type")&&results.push(i);return results}()[0],attributes.value&&$(main_tag).attr("value",attributes.value);break;case"page":case"location":main_tag=element.find("a")[0]}if(attributes["class"]){for(ref=attributes["class"].split(" "),results=[],j=0,len=ref.length;len>j;j++)c=ref[j],$(main_tag).addClass(c),results.push($(element).removeClass(c));return results}},linker=function(scope,element,attributes){return scope.$watch("total",function(){var url;return scope.bb.payment_status="pending",scope.bb.total=scope.total,scope.link_type=scope.total.$link("new_payment").type,scope.label=attributes.value||"Make Payment",scope.payment_link=scope.total.$href("new_payment"),url=scope.total.$href("new_payment"),$q.when(getTemplate(scope.link_type,scope)).then(function(template){return element.html(template).show(),$compile(element.contents())(scope),setClassAndValue(scope,element,attributes)},function(err){return $log.warn(err.data),element.remove()})})},{restrict:"EA",replace:!0,scope:{total:"=",bb:"=",decideNextPage:"="},link:linker}}),angular.module("BB.Directives").directive("bbPaypalExpressButton",function($compile,$sce,$http,$templateCache,$q,$log,$window,UriTemplate){var linker;return linker=function(scope,element,attributes){var paypalOptions,total;return total=scope.total,paypalOptions=scope.paypalOptions,scope.href=new UriTemplate(total.$link("paypal_express").href).fillFromObject(paypalOptions),scope.showLoader=function(){return scope.notLoaded?scope.notLoaded(scope):void 0}},{restrict:"EA",replace:!0,template:'<a ng-href="{{href}}" ng-click="showLoader()">Pay</a>',scope:{total:"=",bb:"=",decideNextPage:"=",paypalOptions:"=bbPaypalExpressButton",notLoaded:"="},link:linker}})}.call(this),function(){"use strict";var app;app=angular.module("BB.Directives"),app.directive("bbPaypal",function(PathSvc){return{restrict:"A",replace:!0,scope:{ppDetails:"=bbPaypal"},templateUrl:PathSvc.directivePartial("paypal_button"),link:function(scope,element,attrs){var keys;return scope.inputs=[],scope.ppDetails?(keys=_.keys(scope.ppDetails),_.each(keys,function(keyName){var obj;return obj={name:keyName,value:scope.ppDetails[keyName]},scope.inputs.push(obj)})):void 0}}})}.call(this),function(){angular.module("BB.Directives").directive("pricepicker",function(){var controller,link;return controller=function($scope){return $scope.$watch("price",function(price){return null!=price?$scope.updateModel(price):void 0})},link=function(scope,element,attrs,ngModel){return ngModel.$render=function(){return ngModel.$viewValue?scope.price=ngModel.$viewValue:void 0},scope.updateModel=function(value){return ngModel.$setViewValue(value)}},{require:"ngModel",link:link,controller:controller,scope:{currency:"@"},template:'<span>{{0 | currency: currency | limitTo: 1}}</span>\n<input type="number" ng-model="price" class="form-control" step="0.01">'}})}.call(this),function(){angular.module("BB.Directives").directive("scoped",function($document,$timeout){var scopeIt;return this.compat=function(){var DOMRules,DOMStyle,changeSelectorTextAllowed,check,e,error,scopeSupported,testSheet,testStyle;check=document.createElement("style"),DOMStyle="undefined"!=typeof check.sheet?"sheet":"undefined"!=typeof check.getSheet?"getSheet":"styleSheet",scopeSupported=void 0!==check.scoped,document.body.appendChild(check),testSheet=check[DOMStyle],testSheet.addRule?testSheet.addRule("c","blink"):testSheet.insertRule("c{}",0),DOMRules=testSheet.rules?"rules":"cssRules",testStyle=testSheet[DOMRules][0];try{testStyle.selectorText="d"}catch(error){e=error}return changeSelectorTextAllowed="d"===testStyle.selectorText.toLowerCase(),check.parentNode.removeChild(check),{scopeSupported:scopeSupported,rules:DOMRules,sheet:DOMStyle,changeSelectorTextAllowed:changeSelectorTextAllowed}}(),scopeIt=function(_this){return function(element){var allRules,glue,id,idCounter,index,par,results,rule,selector,sheet,styleNode,styleRule;if(styleNode=element[0],idCounter=0,sheet=styleNode[_this.compat.sheet]){for(allRules=sheet[_this.compat.rules],par=styleNode.parentNode,id=par.id||(par.id="scopedByScopedPolyfill_"+ ++idCounter),glue="",index=allRules.length||0;par;)par.id&&(glue="#"+par.id+" "+glue),par=par.parentNode;for(results=[];index--;)rule=allRules[index],rule.selectorText?rule.selectorText.match(new RegExp(glue))?results.push(void 0):(selector=glue+" "+rule.selectorText.split(",").join(", "+glue),selector=selector.replace(/[\ ]+:root/gi,""),_this.compat.changeSelectorTextAllowed?results.push(rule.selectorText=selector):rule.type&&1!==rule.type?results.push(void 0):(styleRule=rule.style.cssText,styleRule?(sheet.removeRule?sheet.removeRule(index):sheet.deleteRule(index),sheet.addRule?results.push(sheet.addRule(selector,styleRule)):results.push(sheet.insertRule(selector+"{"+styleRule+"}",index))):results.push(void 0))):results.push(void 0);return results}}}(this),{restrict:"A",link:function(scope,element,attrs){return scope.scopeSupported=this.compat.scopeSupported,this.compat.scopeSupported?void 0:$timeout(function(){return scopeIt(element)})},controller:function($scope,$element,$timeout){$scope.scopeSupported||(this.updateCss=function(){return $timeout(function(){return scopeIt($element)})})}}})}.call(this),function(){var app;app=angular.module("BB.Directives"),app.directive("bbDisplayMode",function($compile,$window,$bbug){return{transclude:!1,restrict:"A",template:'<span class="visible-xs"></span><span class="visible-sm"></span><span class="visible-md"></span><span class="visible-lg"></span>',link:function(scope,elem,attrs){var getCurrentSize,isVisible,markers,t,update;return markers=elem.find("span"),$bbug(elem).addClass("bb-display-mode"),scope.display={},isVisible=function(element){return element&&"none"!==element.style.display&&element.offsetWidth&&element.offsetHeight},getCurrentSize=function(){var element,i,len;for(i=0,len=markers.length;len>i;i++)return element=markers[i],isVisible(element)?element.className.slice(8,11):(scope.display={},scope.display[element.className.slice(8,11)]=!0,!1)},update=function(_this){return function(){var nsize;return nsize=getCurrentSize(),nsize!==_this.currentSize?(_this.currentSize=nsize,scope.display.xs=!1,scope.display.sm=!1,scope.display.md=!1,scope.display.lg=!1,scope.display.not_xs=!0,scope.display.not_sm=!0,scope.display.not_md=!0,scope.display.not_lg=!0,scope.display[nsize]=!0,scope.display["not_"+nsize]=!1,!0):!1}}(this),t=null,angular.element($window).bind("resize",function(_this){return function(){return window.clearTimeout(t),t=setTimeout(function(){return update()?scope.$apply():void 0},50)}}(this)),angular.element($window).bind("load",function(_this){return function(){return update()?scope.$apply():void 0}}(this))}}})}.call(this),function(){angular.module("BB.Directives").directive("bbToggleEdit",function($compile,$window,$document){return{restrict:"AE",link:function(scope,element,attr){return scope.editing=!1,element.on("dblclick",function(_this){return function(event){return scope.$apply(function(){return scope.editing=!0})}}(this)),$document.on("click",function(_this){return function(){return element.is(":hover")?void 0:scope.$apply(function(){return scope.editing=!1})}}(this)),!0}}})}.call(this),function(){angular.module("BB.Directives").directive("popover",function(){var openElement,openScope;return openElement=null,openScope=null,$('div[ng-controller="BBCtrl"]').off(".bbtooltip").on("click.bbtooltip",function(e){var target;return target=$(e.target).closest("[popover]")[0],!target&&openElement&&openScope&&($(openElement).next(".popover").remove(),openScope.tt_isOpen=!1),!0}),{restrict:"EA",priority:-1e3,link:function(scope,element){return element.on("click.bbtooltip",function(e){return openElement===$(e.target).closest("[popover]")[0]?void e.preventDefault():(openElement&&openScope&&($(openElement).next(".popover").remove(),openScope.tt_isOpen=!1),openElement=element[0],openScope=scope)}),scope.$on("$destroy",function(){return $(element).off(".bbtooltip")})}}})}.call(this),function(angular){"use strict";var app=angular.module("BB.Directives");app.directive("appVersion",function(version){return function(scope,elm,attrs){elm.text(version)}})}(window.angular),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("AddressModel",function($q,BBModel,BaseModel){var Address;return Address=function(superClass){function Address(data){Address.__super__.constructor.call(this,data),this.map_url&&""!==this.map_url||this.lat&&this["long"]&&(this.map_url="https://www.google.com/maps/@"+this.lat+","+this["long"]+",17z")}return extend(Address,superClass),Address.prototype.addressSingleLine=function(){var str;return str="",this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+=", "),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+=", "),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+=", "),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+=", "),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+=", "),this.postcode&&(str+=this.postcode),str},Address.prototype.hasAddress=function(){return this.address1||this.address2||this.postcode},Address.prototype.addressCsvLine=function(){var str;return str="",this.address1&&(str+=this.address1),str+=", ",this.address2&&(str+=this.address2),str+=", ",this.address3&&(str+=this.address3),str+=", ",this.address4&&(str+=this.address4),str+=", ",this.address5&&(str+=this.address5),str+=", ",this.postcode&&(str+=this.postcode),str+=", ",this.country&&(str+=this.country),str},Address.prototype.addressMultiLine=function(){var str;return str="",this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+="<br/>"),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+="<br/>"),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+="<br/>"),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+="<br/>"),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+="<br/>"),this.postcode&&(str+=this.postcode),str},Address}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("AffiliateModel",function($q,BBModel,BaseModel,halClient,$rootScope){var Affiliate;return Affiliate=function(superClass){function Affiliate(data){Affiliate.__super__.constructor.call(this,data),this.test=1}return extend(Affiliate,superClass),Affiliate.prototype.getCompanyByRef=function(ref){var defer,href,prms,uri;return prms={id:this.cookie,reference:ref},href=$rootScope.bb.api_url+"/api/v1/affiliates/{id}/companies/{reference}",uri=new UriTemplate(href).fillFromObject(prms||{}),defer=$q.defer(),halClient.$get(uri,{}).then(function(company){return company?defer.resolve(new BBModel.Company(company)):defer.reject("No company for ref "+ref)},function(err){return console.log("err ",err),defer.reject(err)}),defer.promise},Affiliate}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("AnswerModel",function($q,BBModel,BaseModel,$bbug){var Answer;return Answer=function(superClass){function Answer(data){Answer.__super__.constructor.call(this,data)}return extend(Answer,superClass),Answer.prototype.getQuestion=function(){var defer;return defer=$q.defer(),this.question&&defer.resolve(this.question),this._data.$has("question")?this._data.$get("question").then(function(_this){return function(question){return _this.question=question,defer.resolve(_this.question)}}(this)):defer.resolve([]),defer.promise},Answer}(BaseModel)})}.call(this),function(){angular.module("BB.Models").service("BBModel",function($q,$injector){var admin_models,afuncs,fn,fn1,fn2,fn3,funcs,i,j,k,l,len,len1,len2,len3,member_models,mfuncs,model,models,pfuncs,purchase_models;for(models=["Address","Answer","Affiliate","Basket","BasketItem","BookableItem","Category","Client","ClientDetails","Company","CompanySettings","Day","Event","EventChain","EventGroup","EventTicket","EventSequence","ItemDetails","Person","PurchaseItem","PurchaseTotal","Question","Resource","Service","Slot","Space","Clinic","SurveyQuestion","TimeSlot","BusinessQuestion","Image","Deal","PrePaidBooking","MembershipLevel","Product","BBCollection","ExternalPurchase","PackageItem","BulkPurchase"],funcs={},fn=function(_this){return function(model){return funcs[model]=function(p1,p2){return new($injector.get(model+"Model"))(p1,p2)}}}(this),i=0,len=models.length;len>i;i++)model=models[i],fn(model);for(purchase_models=["Booking","Total","CourseBooking"],pfuncs={},fn1=function(_this){return function(model){return pfuncs[model]=function(init){return new($injector.get("Purchase."+model+"Model"))(init)}}}(this),j=0,len1=purchase_models.length;len1>j;j++)model=purchase_models[j],fn1(model);for(funcs.Purchase=pfuncs,member_models=["Member","Booking","PrePaidBooking","Wallet","WalletLog","Purchase","PurchaseItem","WalletPurchaseBand"],mfuncs={},fn2=function(_this){return function(model){return mfuncs[model]=function(init){return new($injector.get("Member."+model+"Model"))(init)}}}(this),k=0,len2=member_models.length;len2>k;k++)model=member_models[k],fn2(model);for(funcs.Member=mfuncs,admin_models=["Booking","Slot","User","Administrator","Schedule","Address","Resource","Person","Service","Login","EventChain","EventGroup","Event","Queuer","ClientQueue","Clinic"],afuncs={},fn3=function(_this){return function(model){return afuncs[model]=function(init){return new($injector.get("Admin."+model+"Model"))(init)}}}(this),l=0,len3=admin_models.length;len3>l;l++)model=admin_models[l],
fn3(model);return funcs.Admin=afuncs,funcs}),angular.module("BB.Models").service("BaseModel",function($q,$injector,$rootScope,$timeout){var Base;return Base=function(){function Base(data){this.deleted=!1,this.updateModel(data)}return Base.prototype.updateModel=function(data){var link,links,m,n,name,obj,results;if(data&&(this._data=data),data)for(n in data)m=data[n],this[n]=m;if(this._data&&this._data.$href){this.self=this._data.$href("self"),links=this.$links(),this.__linkedData={},this.__linkedPromises={},results=[];for(link in links)obj=links[link],name=this._snakeToCamel("get_"+link),results.push(function(_this){return function(link,obj,name){return _this[name]||(_this[name]=function(){return this.$buildOject(link)}),_this[name+"Promise"]?void 0:_this[name+"Promise"]=function(){return this.$buildOjectPromise(link)}}}(this)(link,obj,name));return results}},Base.prototype._snakeToCamel=function(s){return s.replace(/(\_\w)/g,function(m){return m[1].toUpperCase()})},Base.prototype.$buildOject=function(link){return this.__linkedData[link]?this.__linkedData[link]:(this.$buildOjectPromise(link).then(function(_this){return function(ans){return _this.__linkedData[link]=ans,$timeout(function(){return _this.__linkedData[link]=ans})}}(this)),null)},Base.prototype.$buildOjectPromise=function(link){var prom;return this.__linkedPromises[link]?this.__linkedPromises[link]:(prom=$q.defer(),this.__linkedPromises[link]=prom.promise,this.$get(link).then(function(_this){return function(res){var inj;return inj=$injector.get("BB.Service."+link),inj?inj.promise?inj.unwrap(res).then(function(ans){return prom.resolve(ans)},function(err){return prom.reject(err)}):prom.resolve(inj.unwrap(res)):prom.resolve(res)}}(this),function(err){return prom.reject(err)}),this.__linkedPromises[link])},Base.prototype.get=function(ikey){return this._data?this._data[ikey]:null},Base.prototype.set=function(ikey,value){return this._data?this._data[ikey]=value:null},Base.prototype.$href=function(rel,params){return this._data?this._data.$href(rel,params):void 0},Base.prototype.$has=function(rel){return this._data?this._data.$has(rel):void 0},Base.prototype.$flush=function(rel,params){return this._data?this._data.$href(rel,params):void 0},Base.prototype.$get=function(rel,params){return this._data?this._data.$get(rel,params):void 0},Base.prototype.$post=function(rel,params,dat){return this._data?this._data.$post(rel,params,dat):void 0},Base.prototype.$put=function(rel,params,dat){return this._data?this._data.$put(rel,params,dat):void 0},Base.prototype.$patch=function(rel,params,dat){return this._data?this._data.$patch(rel,params,dat):void 0},Base.prototype.$del=function(rel,params){return this._data?this._data.$del(rel,params):void 0},Base.prototype.$links=function(){return this._data?this._data.$links():void 0},Base.prototype.$toStore=function(){return this._data?this._data.$toStore():void 0},Base}()})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("BasketModel",function($q,BBModel,BaseModel){var Basket;return Basket=function(superClass){function Basket(data,scope){scope&&scope.isAdmin?this.is_admin=scope.isAdmin:this.is_admin=!1,null!=scope&&scope.parent_client&&(this.parent_client_id=scope.parent_client.id),this.items=[],Basket.__super__.constructor.call(this,data)}return extend(Basket,superClass),Basket.prototype.addItem=function(item){var i,j,len,ref;for(ref=this.items,j=0,len=ref.length;len>j;j++){if(i=ref[j],i===item)return;if(i.id&&item.id&&i.id===item.id)return}return this.items.push(item)},Basket.prototype.clear=function(){return this.items=[]},Basket.prototype.clearItem=function(item){return this.items=this.items.filter(function(i){return i!==item})},Basket.prototype.readyToCheckout=function(){return this.items.length>0},Basket.prototype.timeItems=function(){var i,j,len,ref,titems;for(titems=[],ref=this.items,j=0,len=ref.length;len>j;j++)i=ref[j],i.isTimeItem()&&titems.push(i);return titems},Basket.prototype.hasTimeItems=function(){var i,j,len,ref;for(ref=this.items,j=0,len=ref.length;len>j;j++)if(i=ref[j],i.isTimeItem())return!0;return!1},Basket.prototype.basketItems=function(){var bitems,i,j,len,ref;for(bitems=[],ref=this.items,j=0,len=ref.length;len>j;j++)i=ref[j],i.is_coupon||bitems.push(i);return bitems},Basket.prototype.externalPurchaseItems=function(){var eitems,i,j,len,ref;for(eitems=[],ref=this.items,j=0,len=ref.length;len>j;j++)i=ref[j],i.isExternalPurchase()&&eitems.push(i);return eitems},Basket.prototype.couponItems=function(){var citems,i,j,len,ref;for(citems=[],ref=this.items,j=0,len=ref.length;len>j;j++)i=ref[j],i.is_coupon&&citems.push(i);return citems},Basket.prototype.removeCoupons=function(){return this.items=_.reject(this.items,function(x){return x.is_coupon})},Basket.prototype.setSettings=function(set){return set?(this.settings||(this.settings={}),$.extend(this.settings,set)):void 0},Basket.prototype.setClient=function(client){return this.client=client},Basket.prototype.setClientDetails=function(client_details){return this.client_details=new BBModel.PurchaseItem(client_details)},Basket.prototype.getPostData=function(){var item,j,len,post,ref;for(post={client:this.client.getPostData(),settings:this.settings,reference:this.reference},post.is_admin=this.is_admin,post.parent_client_id=this.parent_client_id,post.take_from_wallet=this.take_from_wallet,post.items=[],ref=this.items,j=0,len=ref.length;len>j;j++)item=ref[j],post.items.push(item.getPostData());return post},Basket.prototype.dueTotal=function(){var item,j,len,ref,total;for(total=this.totalPrice(),ref=this.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.isWaitlist()&&(total-=item.price);return 0>total&&(total=0),total},Basket.prototype.length=function(){return this.items.length},Basket.prototype.questionPrice=function(options){var item,j,len,price,ref,unready;for(unready=options&&options.unready,price=0,ref=this.items,j=0,len=ref.length;len>j;j++)item=ref[j],(!item.ready&&unready||!unready)&&(price+=item.questionPrice());return price},Basket.prototype.totalPrice=function(options){var item,j,len,price,ref,unready;for(unready=options&&options.unready,price=0,ref=this.items,j=0,len=ref.length;len>j;j++)item=ref[j],(!item.ready&&unready||!unready)&&(price+=item.totalPrice());return price},Basket.prototype.updateTotalPrice=function(options){return this.total_price=this.totalPrice(options)},Basket.prototype.fullPrice=function(){var item,j,len,price,ref;for(price=0,ref=this.items,j=0,len=ref.length;len>j;j++)item=ref[j],price+=item.fullPrice();return price},Basket.prototype.hasCoupon=function(){var item,j,len,ref;for(ref=this.items,j=0,len=ref.length;len>j;j++)if(item=ref[j],item.is_coupon)return!0;return!1},Basket.prototype.totalCoupons=function(){return this.fullPrice()-this.totalPrice()-this.totalDealPaid()},Basket.prototype.totalDuration=function(){var duration,item,j,len,ref;for(duration=0,ref=this.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.service&&item.service.listed_duration&&(duration+=item.service.listed_duration);return duration},Basket.prototype.containsDeal=function(){var item,j,len,ref;for(ref=this.items,j=0,len=ref.length;len>j;j++)if(item=ref[j],item.deal_id)return!0;return!1},Basket.prototype.hasDeal=function(){var item,j,len,ref;for(ref=this.items,j=0,len=ref.length;len>j;j++)if(item=ref[j],item.deal_codes&&item.deal_codes.length>0)return!0;return!1},Basket.prototype.getDealCodes=function(){return this.deals=this.items[0]&&this.items[0].deal_codes?this.items[0].deal_codes:[],this.deals},Basket.prototype.totalDeals=function(){var deal,j,len,ref,value;for(value=0,ref=this.getDealCodes(),j=0,len=ref.length;len>j;j++)deal=ref[j],value+=deal.value;return value},Basket.prototype.totalDealPaid=function(){var item,j,len,ref,total_cert_paid;for(total_cert_paid=0,ref=this.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.certificate_paid&&(total_cert_paid+=item.certificate_paid);return total_cert_paid},Basket.prototype.remainingDealBalance=function(){return this.totalDeals()-this.totalDealPaid()},Basket.prototype.hasWaitlistItem=function(){var item,j,len,ref;for(ref=this.items,j=0,len=ref.length;len>j;j++)if(item=ref[j],item.isWaitlist())return!0;return!1},Basket.prototype.hasExternalPurchase=function(){var item,j,len,ref;for(ref=this.items,j=0,len=ref.length;len>j;j++)if(item=ref[j],item.isExternalPurchase())return!0;return!1},Basket.prototype.useWallet=function(value,client){return client&&client.$has("wallet")&&value?(this.take_from_wallet=!0,!0):(this.take_from_wallet=!1,!1)},Basket}(BaseModel)})}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("BasketItemModel",function($q,$window,BBModel,BookableItemModel,BaseModel,$bbug){var BasketItem;return BasketItem=function(superClass){function BasketItem(data,bb){this.fullPrice=bind(this.fullPrice,this),this.totalPrice=bind(this.totalPrice,this),this.getQty=bind(this.getQty,this),this.questionPrice=bind(this.questionPrice,this);var chain,comp,per,res,serv,t;BasketItem.__super__.constructor.call(this,data),this.ready=!1,this.days_link=null,this.book_link=null,this.parts_links={},this.settings||(this.settings={}),this.has_questions=!1,bb&&(this.reserve_without_questions=bb.reserve_without_questions),this.time&&(this.time=new BBModel.TimeSlot({time:this.time,event_id:this.event_id,selected:!0,avail:1,price:this.price})),this.date&&(this.date=new BBModel.Day({date:this.date,spaces:1})),this.datetime&&(this.date=new BBModel.Day({date:this.datetime.toISODate(),spaces:1}),t=60*this.datetime.hour()+this.datetime.minute(),this.time=new BBModel.TimeSlot({time:t,event_id:this.event_id,selected:!0,avail:1,price:this.price})),this.id&&(this.reserve_ready=!0,this.held={time:this.time,date:this.date,event_id:this.event_id}),this.promises=[],data&&(data.$has("answers")&&data.$get("answers").then(function(_this){return function(answers){var a,i,len,results;for(data.questions=[],results=[],i=0,len=answers.length;len>i;i++)a=answers[i],results.push(data.questions.push({id:a.question_id,answer:a.value}));return results}}(this)),data.$has("company")&&(comp=data.$get("company"),this.promises.push(comp),comp.then(function(_this){return function(comp){var c;return c=new BBModel.Company(comp),_this.promises.push(c.getSettings()),_this.setCompany(c)}}(this))),data.$has("service")&&(serv=data.$get("service"),this.promises.push(serv),serv.then(function(_this){return function(serv){var prom;return serv.$has("category")&&(prom=serv.$get("category"),_this.promises.push(prom),prom.then(function(cat){return _this.setCategory(new BBModel.Category(cat))})),_this.setService(new BBModel.Service(serv),data.questions),_this.duration&&_this.setDuration(_this.duration),_this.checkReady(),_this.time?_this.time.service=_this.service:void 0}}(this))),data.$has("event_group")&&(serv=data.$get("event_group"),this.promises.push(serv),serv.then(function(_this){return function(serv){var prom;return serv.$has("category")&&(prom=serv.$get("category"),_this.promises.push(prom),prom.then(function(cat){return _this.setCategory(new BBModel.Category(cat))})),_this.setEventGroup(new BBModel.EventGroup(serv)),_this.time?_this.time.service=_this.event_group:void 0}}(this))),data.$has("event_chain")&&(chain=data.$get("event_chain"),this.promises.push(chain),data.$has("event")||chain.then(function(_this){return function(serv){return _this.setEventChain(new BBModel.EventChain(serv),data.questions)}}(this))),data.$has("resource")&&(res=data.$get("resource"),this.promises.push(res),res.then(function(_this){return function(res){return _this.setResource(new BBModel.Resource(res),!1)}}(this))),data.$has("person")&&(per=data.$get("person"),this.promises.push(per),per.then(function(_this){return function(per){return _this.setPerson(new BBModel.Person(per),!1)}}(this))),data.$has("event")&&data.$get("event").then(function(_this){return function(event){return _this.setEvent(new BBModel.Event(event))}}(this)),data.settings&&(this.settings=$bbug.extend(!0,{},data.settings)),data.attachment_id&&(this.attachment_id=data.attachment_id),data.$has("product")&&data.$get("product").then(function(_this){return function(product){return _this.setProduct(new BBModel.Product(product))}}(this)),data.$has("package_item")&&data.$get("package_item").then(function(_this){return function(package_item){return _this.setPackageItem(new BBModel.PackageItem(package_item))}}(this)),data.$has("bulk_purchase")&&data.$get("bulk_purchase").then(function(_this){return function(bulk_purchase){return _this.setBulkPurchase(new BBModel.BulkPurchase(bulk_purchase))}}(this)),data.$has("deal")&&data.$get("deal").then(function(_this){return function(deal){return _this.setDeal(new BBModel.Deal(deal))}}(this)),data.$has("pre_paid_booking")&&data.$get("pre_paid_booking").then(function(_this){return function(pre_paid_booking){return _this.setPrepaidBooking(new BBModel.PrePaidBooking(pre_paid_booking))}}(this)),data.clinic_id&&(this.clinic_id=data.clinic_id))}return extend(BasketItem,superClass),BasketItem.prototype.setDefaults=function(defaults){return defaults.settings&&(this.settings=defaults.settings),defaults.company&&this.setCompany(defaults.company),defaults.merge_resources&&this.setResource(null),defaults.merge_people&&this.setPerson(null),defaults.resource&&this.setResource(defaults.resource),defaults.person&&this.setPerson(defaults.person),defaults.service&&this.setService(defaults.service),defaults.category&&this.setCategory(defaults.category),defaults.time&&(this.requested_time=parseInt(defaults.time)),defaults.date&&(this.requested_date=moment(defaults.date)),defaults.service_ref&&(this.service_ref=defaults.service_ref),defaults.group&&(this.group=defaults.group),defaults.clinic&&(this.clinic=defaults.clinic,this.clinic_id=defaults.clinic.id),defaults.private_note&&(this.private_note=defaults.private_note),defaults.event_group&&this.setEventGroup(defaults.event_group),defaults.event&&this.setEvent(defaults.event),this.defaults=defaults},BasketItem.prototype.storeDefaults=function(defaults){return this.defaults=defaults},BasketItem.prototype.defaultService=function(){return this.defaults?this.defaults.service:null},BasketItem.prototype.requestedTimeUnavailable=function(){return delete this.requested_time,delete this.requested_date},BasketItem.prototype.setSlot=function(slot){var t;return this.date=new BBModel.Day({date:slot.datetime.toISODate(),spaces:1}),t=60*slot.datetime.hour()+slot.datetime.minute(),this.time=new BBModel.TimeSlot({time:t,avail:1,price:this.price}),this.available_slot=slot.id},BasketItem.prototype.setCompany=function(company){return this.company=company,this.parts_links.company=this.company.$href("self"),this.item_details?this.item_details.currency_code=this.company.currency_code:void 0},BasketItem.prototype.clearExistingItem=function(){var prom;return this.$has("self")&&this.event_id&&(prom=this.$del("self"),this.promises.push(prom),prom.then(function(){})),delete this.earliest_time,delete this.event_id},BasketItem.prototype.setItem=function(item){return item?"person"===item.type?this.setPerson(item):"service"===item.type?this.setService(item):"resource"===item.type?this.setResource(item):void 0:void 0},BasketItem.prototype.setService=function(serv,default_questions){var prom;if(null==default_questions&&(default_questions=null),this.service){if(this.service.self&&serv.self&&this.service.self===serv.self)return this.service.$has("book")&&(this.book_link=this.service),serv.$has("days")&&(this.days_link=serv),void(serv.$has("book")&&(this.book_link=serv));this.item_details=null,this.clearExistingItem()}return this.service&&serv&&this.service.self&&serv.self&&this.service.self!==serv.self&&serv.durations&&serv.durations.length>1&&(this.duration=null,this.listed_duration=null),this.service=serv,serv&&serv instanceof BookableItemModel&&(this.service=serv.item),this.parts_links.service=this.service.$href("self"),this.service.$has("book")&&(this.book_link=this.service),serv.$has("days")&&(this.days_link=serv),serv.$has("book")&&(this.book_link=serv),this.service.$has("questions")?(this.has_questions=!0,prom=this.service.$get("questions"),this.promises.push(prom),prom.then(function(_this){return function(details){return _this.company&&(details.currency_code=_this.company.currency_code),_this.item_details=new BBModel.ItemDetails(details),_this.has_questions=_this.item_details.hasQuestions,default_questions?(_this.item_details.setAnswers(default_questions),_this.setAskedQuestions()):void 0}}(this),function(_this){return function(err){return _this.has_questions=!1}}(this))):this.has_questions=!1,this.service&&this.service.durations&&1===this.service.durations.length&&(this.setDuration(this.service.durations[0]),this.listed_duration=this.service.durations[0]),this.service&&this.service.listed_durations&&1===this.service.listed_durations.length&&(this.listed_duration=this.service.listed_durations[0]),this.service.$has("category")&&(prom=this.service.getCategoryPromise())?this.promises.push(prom):void 0},BasketItem.prototype.setEventGroup=function(event_group){var prom;if(!(this.event_group&&this.event_group.self&&event_group.self&&this.event_group.self===event_group.self))return this.event_group=event_group,this.parts_links.event_group=this.event_group.$href("self").replace("event_group","service"),this.event_group.$has("category")&&(prom=this.event_group.getCategoryPromise())?this.promises.push(prom):void 0},BasketItem.prototype.setEventChain=function(event_chain,default_questions){var prom;return null==default_questions&&(default_questions=null),this.event_chain&&this.event_chain.self&&event_chain.self&&this.event_chain.self===event_chain.self?void 0:(this.event_chain=event_chain,this.base_price=parseFloat(event_chain.price),null!=this.price&&this.price!==this.base_price?this.setPrice(this.price):this.setPrice(this.base_price),this.event_chain.isSingleBooking()&&(this.tickets={name:"Admittance",max:1,type:"normal",price:this.base_price},this.tickets.pre_paid_booking_id=this.pre_paid_booking_id,this.num_book&&(this.tickets.qty=this.num_book)),this.event_chain.$has("questions")?(this.has_questions=!0,prom=this.event_chain.$get("questions"),this.promises.push(prom),prom.then(function(_this){return function(details){var a,i,len,q,ref;if(_this.item_details=new BBModel.ItemDetails(details),_this.has_questions=_this.item_details.hasQuestions,_this.questions){for(ref=_this.item_details.questions,i=0,len=ref.length;len>i;i++)q=ref[i],a=_.find(_this.questions,function(c){return c.id===q.id}),(a&&void 0===q.answer||a!==q.answer)&&(q.answer=a.answer);_this.setAskedQuestions()}return default_questions?(_this.item_details.setAnswers(default_questions),_this.setAskedQuestions()):void 0}}(this),function(_this){return function(err){return _this.has_questions=!1}}(this))):this.has_questions=!1)},BasketItem.prototype.setEvent=function(event,default_questions){var prom;if(null==default_questions&&(default_questions=null),this.event&&this.event.unselect(),this.event=event,this.event.select(),this.event_chain_id=event.event_chain_id,this.setDate({date:event.date}),this.setTime(event.time),this.setDuration(event.duration),event.$has("book")&&(this.book_link=event),event.qty&&(this.num_book=event.qty),prom=this.event.getChain(),this.promises.push(prom),prom.then(function(_this){return function(chain){return _this.setEventChain(chain,default_questions)}}(this)),prom=this.event.getGroup(),this.promises.push(prom),prom.then(function(_this){return function(group){return _this.setEventGroup(group)}}(this)),this.event.getSpacesLeft()<=0&&!this.company.settings){if(this.company.getSettings().has_waitlists)return this.status=8}else if(this.event.getSpacesLeft()<=0&&this.company.settings&&this.company.settings.has_waitlists)return this.status=8},BasketItem.prototype.setCategory=function(cat){return this.category=cat},BasketItem.prototype.setPerson=function(per,set_selected){if(null==set_selected&&(set_selected=!0),set_selected&&this.earliest_time&&delete this.earliest_time,per){if(this.person=per,set_selected&&(this.settings.person=this.person.id),this.parts_links.person=this.person.$href("self"),per.$has("days")&&(this.days_link=per),per.$has("book")&&(this.book_link=per),this.event_id&&this.$has("person")&&this.$href("person")!==this.person.self&&(delete this.event_id,this.resource&&this.defaults&&this.defaults.merge_resources))return this.setResource(null)}else if(this.person=!0,set_selected&&(this.settings.person=-1),this.parts_links.person=null,this.service&&this.setService(this.service),this.resource&&!this.anyResource()&&this.setResource(this.resource,!1),this.event_id&&(delete this.event_id,this.resource&&this.defaults&&this.defaults.merge_resources))return this.setResource(null)},BasketItem.prototype.setResource=function(res,set_selected){if(null==set_selected&&(set_selected=!0),set_selected&&this.earliest_time&&delete this.earliest_time,res){if(this.resource=res,set_selected&&(this.settings.resource=this.resource.id),this.parts_links.resource=this.resource.$href("self"),res.$has("days")&&(this.days_link=res),res.$has("book")&&(this.book_link=res),this.event_id&&this.$has("resource")&&this.$href("resource")!==this.resource.self&&(delete this.event_id,this.person&&this.defaults&&this.defaults.merge_people))return this.setPerson(null)}else if(this.resource=!0,set_selected&&(this.settings.resource=-1),this.parts_links.resource=null,this.service&&this.setService(this.service),this.person&&!this.anyPerson()&&this.setPerson(this.person,!1),this.event_id&&(delete this.event_id,this.person&&this.defaults&&this.defaults.merge_people))return this.setPerson(null)},BasketItem.prototype.setDuration=function(dur){return this.duration=dur,this.service?this.base_price=this.service.getPriceByDuration(dur):this.time&&this.time.price?this.base_price=this.time.price:this.price&&(this.base_price=this.price),this.setPrice(this.base_price)},BasketItem.prototype.print_time=function(){return this.time?this.time.print_time():void 0},BasketItem.prototype.print_end_time=function(){return this.time?this.time.print_end_time(this.duration):void 0},BasketItem.prototype.print_time12=function(show_suffix){return null==show_suffix&&(show_suffix=!0),this.time?this.time.print_time12(show_suffix):void 0},BasketItem.prototype.print_end_time12=function(show_suffix){return null==show_suffix&&(show_suffix=!0),this.time?this.time.print_end_time12(show_suffix,this.duration):void 0},BasketItem.prototype.setTime=function(time){var hours,mins,val;return this.time&&this.time.unselect(),this.time=time,this.time&&(this.time.select(),this.datetime&&(val=parseInt(time.time),hours=parseInt(val/60),mins=val%60,this.datetime.hour(hours),this.datetime.minutes(mins)),this.price&&this.time.price&&this.price!==this.time.price?this.setPrice(this.price):this.price&&!this.time.price?this.setPrice(this.price):this.time.price&&!this.price?this.setPrice(this.time.price):this.price&&this.time.price?this.setPrice(this.price):this.setPrice(null)),this.checkReady()},BasketItem.prototype.setDate=function(date){return this.date=date,this.date&&(this.date.date=moment(this.date.date),this.datetime&&(this.datetime.date(this.date.date.date()),this.datetime.month(this.date.date.month()),this.datetime.year(this.date.date.year()))),this.checkReady()},BasketItem.prototype.clearDateTime=function(){return delete this.date,delete this.time,delete this.datetime,this.ready=!1,this.reserve_ready=!1},BasketItem.prototype.clearTime=function(){return delete this.time,this.ready=!1,this.reserve_ready=!1},BasketItem.prototype.setGroup=function(group){return this.group=group},BasketItem.prototype.setAskedQuestions=function(){return this.asked_questions=!0,this.checkReady()},BasketItem.prototype.checkReady=function(){return!(this.date&&this.time&&this.service||this.event||this.product||this.package_item||this.bulk_purchase||this.external_purchase||this.deal||this.date&&this.service&&"day"===this.service.duration_unit)||!this.asked_questions&&this.has_questions||(this.ready=!0),(this.date&&this.time&&this.service||this.event||this.product||this.package_item||this.bulk_purchase||this.external_purchase||this.deal||this.date&&this.service&&"day"===this.service.duration_unit)&&(this.asked_questions||!this.has_questions||this.reserve_without_questions)?this.reserve_ready=!0:void 0},BasketItem.prototype.getPostData=function(){var data,i,j,len,len1,m_question,o_question,ref,ref1;if(this.cloneAnswersItem)for(ref=this.cloneAnswersItem.item_details.questions,i=0,len=ref.length;len>i;i++)for(o_question=ref[i],ref1=this.item_details.questions,j=0,len1=ref1.length;len1>j;j++)m_question=ref1[j],m_question.id===o_question.id&&(m_question.answer=o_question.answer,this.setAskedQuestions());return data={},this.date&&(data.date=this.date.date.toISODate()),this.time?(data.time=this.time.time,this.time.event_id?data.event_id=this.time.event_id:this.time.event_ids&&(data.event_ids=this.time.event_ids)):this.date&&this.date.event_id&&(data.event_id=this.date.event_id),data.price=this.price,data.paid=this.paid,this.book_link&&(data.book=this.book_link.$href("book")),data.id=this.id,data.duration=this.duration,data.settings=this.settings,data.settings||(data.settings={}),this.earliest_time&&(data.settings.earliest_time=this.earliest_time),this.item_details&&this.asked_questions&&(data.questions=this.item_details.getPostData()),this.move_item_id&&(data.move_item_id=this.move_item_id),this.srcBooking&&(data.move_item_id=this.srcBooking.id),this.service&&(data.service_id=this.service.id),this.resource&&(data.resource_id=this.resource.id),this.person&&(data.person_id=this.person.id),data.length=this.length,this.event&&(data.event_id=this.event.id,null!=this.event.pre_paid_booking_id?data.pre_paid_booking_id=this.event.pre_paid_booking_id:this.tickets&&null!=this.tickets.pre_paid_booking_id&&(data.pre_paid_booking_id=this.tickets.pre_paid_booking_id),data.tickets=this.tickets),null!=this.pre_paid_booking_id&&(data.pre_paid_booking_id=this.pre_paid_booking_id),data.event_chain_id=this.event_chain_id,data.event_group_id=this.event_group_id,data.qty=this.qty,this.status&&(data.status=this.status),null!=this.num_resources&&(data.num_resources=parseInt(this.num_resources)),this.package_item&&(data.package_id=this.package_item.id),this.bulk_purchase&&(data.bulk_purchase_id=this.bulk_purchase.id),data.external_purchase=this.external_purchase,this.deal&&(data.deal=this.deal),this.deal&&this.recipient&&(data.recipient=this.recipient),this.deal&&this.recipient&&this.recipient_mail&&(data.recipient_mail=this.recipient_mail),data.coupon_id=this.coupon_id,data.is_coupon=this.is_coupon,this.attachment_id&&(data.attachment_id=this.attachment_id),this.deal_codes&&(data.vouchers=this.deal_codes),this.product&&(data.product_id=this.product.id),this.email&&(data.email=this.email),this.first_name&&(data.first_name=this.first_name),this.last_name&&(data.last_name=this.last_name),null!=this.email&&(data.email=this.email),null!=this.email_admin&&(data.email_admin=this.email_admin),this.private_note&&(data.private_note=this.private_note),this.available_slot&&(data.available_slot=this.available_slot),this.clinic_id&&(data.clinic_id=this.clinic_id),data},BasketItem.prototype.setPrice=function(nprice){var printed_price;return null==nprice?(this.price=null,this.printed_price=null,this.printed_vat_cal=null,this.printed_vat=null,this.printed_vat_inc=null):(this.price=parseFloat(nprice),printed_price=this.price/100,this.printed_price=printed_price%1===0?"£"+parseInt(printed_price):$window.sprintf("£%.2f",printed_price),this.company&&this.company.settings&&(this.printed_vat_cal=this.company.settings.payment_tax),this.printed_vat_cal&&(this.printed_vat=this.printed_vat_cal/100*printed_price),this.printed_vat_cal?this.printed_vat_inc=this.printed_vat_cal/100*printed_price+printed_price:void 0)},BasketItem.prototype.getStep=function(){var temp;return temp={},temp.service=this.service,temp.category=this.category,temp.person=this.person,temp.resource=this.resource,temp.duration=this.duration,temp.event=this.event,temp.event_group=this.event_group,temp.event_chain=this.event_chain,temp.time=this.time,temp.date=this.date,temp.days_link=this.days_link,temp.book_link=this.book_link,temp.ready=this.ready,temp},BasketItem.prototype.loadStep=function(step){return this.id?void 0:(this.service=step.service,this.category=step.category,this.person=step.person,this.resource=step.resource,this.duration=step.duration,this.event=step.event,this.event_chain=step.event_chain,this.event_group=step.event_group,this.time=step.time,this.date=step.date,this.days_link=step.days_link,this.book_link=step.book_link,this.ready=step.ready)},BasketItem.prototype.describe=function(){var title;return title="-",this.service&&(title=this.service.name),this.event_group&&this.event&&"-"===title&&(title=this.event_group.name+" - "+this.event.description),this.product&&(title=this.product.name),this.external_purchase&&(title=this.external_purchase.name),this.deal&&(title=this.deal.name),this.package_item&&(title=this.package_item.name),this.bulk_purchase&&(title=this.bulk_purchase.name),title},BasketItem.prototype.booking_date=function(format){return this.date&&this.date.date?this.date.date.format(format):null},BasketItem.prototype.booking_time=function(seperator){var duration;return null==seperator&&(seperator="-"),this.time?(duration=this.listed_duration?this.listed_duration:this.duration,this.time.print_time()+" "+seperator+" "+this.time.print_end_time(duration)):null},BasketItem.prototype.duePrice=function(){return this.isWaitlist()?0:this.price},BasketItem.prototype.isWaitlist=function(){return this.status&&8===this.status},BasketItem.prototype.start_datetime=function(){var start_datetime;return this.date&&this.time?(start_datetime=moment(this.date.date.toISODate()),start_datetime.minutes(this.time.time),start_datetime):null},BasketItem.prototype.startDatetime=function(){return this.start_datetime()},BasketItem.prototype.end_datetime=function(){var duration,end_datetime;return this.date&&this.time&&(this.listed_duration||this.duration)?(duration=this.listed_duration?this.listed_duration:this.duration,end_datetime=moment(this.date.date.toISODate()),end_datetime.minutes(this.time.time+duration),end_datetime):null},BasketItem.prototype.endDatetime=function(){return this.end_datetime()},BasketItem.prototype.setSrcBooking=function(booking){return this.srcBooking=booking,this.duration=booking.duration},BasketItem.prototype.anyPerson=function(){return this.person&&"boolean"==typeof this.person},BasketItem.prototype.anyResource=function(){return this.resource&&"boolean"==typeof this.resource},BasketItem.prototype.isMovingBooking=function(){return this.srcBooking||this.move_item_id},BasketItem.prototype.setCloneAnswers=function(otherItem){return this.cloneAnswersItem=otherItem},BasketItem.prototype.questionPrice=function(){return this.item_details?this.item_details.questionPrice(this.getQty()):0},BasketItem.prototype.getQty=function(){return this.qty?this.qty:this.tickets?this.tickets.qty:1},BasketItem.prototype.totalPrice=function(){var pr;return this.tickets&&this.tickets.pre_paid_booking_id?0:this.pre_paid_booking_id?0:null!=this.discount_price?this.discount_price+this.questionPrice():(pr=this.total_price,angular.isNumber(pr)||(pr=this.price),angular.isNumber(pr)||(pr=0),pr+this.questionPrice())},BasketItem.prototype.fullPrice=function(){
var pr;return pr=this.base_price,pr||(pr=this.total_price),pr||(pr=this.price),pr||(pr=0),pr+this.questionPrice()},BasketItem.prototype.setProduct=function(product){return this.product=product,this.product.$has("book")&&(this.book_link=this.product),product.price?this.setPrice(product.price):void 0},BasketItem.prototype.setPackageItem=function(package_item){return this.package_item=package_item,this.package_item.$has("book")&&(this.book_link=this.package_item),package_item.price?this.setPrice(package_item.price):void 0},BasketItem.prototype.setBulkPurchase=function(bulk_purchase){return this.bulk_purchase=bulk_purchase,this.bulk_purchase.$has("book")&&(this.book_link=this.bulk_purchase),bulk_purchase.price?this.setPrice(bulk_purchase.price):void 0},BasketItem.prototype.setExternalPurchase=function(external_purchase){return this.external_purchase=external_purchase,this.book_link=this.company,external_purchase.price?this.setPrice(external_purchase.price):void 0},BasketItem.prototype.setDeal=function(deal){return this.deal=deal,this.deal.$has("book")&&(this.book_link=this.deal),deal.price?this.setPrice(deal.price):void 0},BasketItem.prototype.hasPrice=function(){return null!=this.price},BasketItem.prototype.getAttachment=function(){return this.attachment?this.attachment:this.$has("attachment")&&this.attachment_id?this._data.$get("attachment").then(function(_this){return function(att){return _this.attachment=att,_this.attachment}}(this)):void 0},BasketItem.prototype.setPrepaidBooking=function(pre_paid_booking){return this.pre_paid_booking=pre_paid_booking,this.pre_paid_booking_id=pre_paid_booking.id},BasketItem.prototype.hasPrepaidBooking=function(){return null!=this.pre_paid_booking_id},BasketItem.prototype.getEventId=function(){return this.time&&this.time.event_id?this.time.event_id:this.date&&this.date.event_id?this.date.event_id:this.event?this.event.id:void 0},BasketItem.prototype.isExternalPurchase=function(){return null!=this.external_purchase},BasketItem.prototype.getName=function(client){return this.first_name?this.first_name+" "+this.last_name:client?client.getName():void 0},BasketItem.prototype.isTimeItem=function(){return this.service||this.event},BasketItem}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("BookableItemModel",function($q,BBModel,BaseModel){var BookableItem;return BookableItem=function(superClass){function BookableItem(data){BookableItem.__super__.constructor.apply(this,arguments),this.name="-Waiting-",this.ready=$q.defer(),this.promise=this._data.$get("item"),this.promise.then(function(_this){return function(val){var m,n,ref,ref1,ref2;if("person"===val.type){if(_this.item=new BBModel.Person(val),_this.item){ref=_this.item._data;for(n in ref)m=ref[n],_this.item._data.hasOwnProperty(n)&&"function"!=typeof m&&(_this[n]=m);return _this.ready.resolve()}return _this.ready.resolve()}if("resource"===val.type){if(_this.item=new BBModel.Resource(val),_this.item){ref1=_this.item._data;for(n in ref1)m=ref1[n],_this.item._data.hasOwnProperty(n)&&"function"!=typeof m&&(_this[n]=m);return _this.ready.resolve()}return _this.ready.resolve()}if("service"===val.type){if(_this.item=new BBModel.Service(val),_this.item){ref2=_this.item._data;for(n in ref2)m=ref2[n],_this.item._data.hasOwnProperty(n)&&"function"!=typeof m&&(_this[n]=m);return _this.ready.resolve()}return _this.ready.resolve()}}}(this))}return extend(BookableItem,superClass),BookableItem.prototype.item=null,BookableItem.prototype.promise=null,BookableItem}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("BulkPurchaseModel",function($q,BBModel,BaseModel){var BulkPurchase;return BulkPurchase=function(superClass){function BulkPurchase(){return BulkPurchase.__super__.constructor.apply(this,arguments)}return extend(BulkPurchase,superClass),BulkPurchase}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("BusinessQuestionModel",function($q,$filter,BBModel,BaseModel){var BusinessQuestion;return BusinessQuestion=function(superClass){function BusinessQuestion(data){BusinessQuestion.__super__.constructor.call(this,data)}return extend(BusinessQuestion,superClass),BusinessQuestion}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("CategoryModel",function($q,BBModel,BaseModel){var Category;return Category=function(superClass){function Category(){return Category.__super__.constructor.apply(this,arguments)}return extend(Category,superClass),Category}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ClientModel",function($q,BBModel,BaseModel,LocaleService){var Client;return Client=function(superClass){function Client(data){Client.__super__.constructor.apply(this,arguments),this.name=this.getName(),data&&data.answers&&data.$has("questions")&&(this.waitingQuestions=$q.defer(),this.gotQuestions=this.waitingQuestions.promise,data.$get("questions").then(function(_this){return function(details){return _this.client_details=new BBModel.ClientDetails(details),_this.client_details.setAnswers(data.answers),_this.questions=_this.client_details.questions,_this.setAskedQuestions(),_this.waitingQuestions.resolve()}}(this)))}return extend(Client,superClass),Client.prototype.setClientDetails=function(details){return this.client_details=details,this.questions=this.client_details.questions},Client.prototype.setDefaults=function(values){return values.name&&(this.name=values.name),values.first_name&&(this.first_name=values.first_name),values.last_name&&(this.last_name=values.last_name),values.phone&&(this.phone=values.phone),values.mobile&&(this.mobile=values.mobile),values.email&&(this.email=values.email),values.id&&(this.id=values.id),values.ref&&(this.comp_ref=values.ref),values.comp_ref&&(this.comp_ref=values.comp_ref),values.address1&&(this.address1=values.address1),values.address2&&(this.address2=values.address2),values.address3&&(this.address3=values.address3),values.address4&&(this.address4=values.address4),values.address5&&(this.address5=values.address5),values.postcode&&(this.postcode=values.postcode),values.country&&(this.country=values.country),values.answers?this.default_answers=values.answers:void 0},Client.prototype.pre_fill_answers=function(details){var i,len,q,ref,results;if(this.default_answers){for(ref=details.questions,results=[],i=0,len=ref.length;len>i;i++)q=ref[i],this.default_answers[q.name]?results.push(q.answer=this.default_answers[q.name]):results.push(void 0);return results}},Client.prototype.getName=function(){var str;return str="",this.first_name&&(str+=this.first_name),str.length>0&&this.last_name&&(str+=" "),this.last_name&&(str+=this.last_name),str},Client.prototype.addressSingleLine=function(){var str;return str="",this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+=", "),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+=", "),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+=", "),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+=", "),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+=", "),this.postcode&&(str+=this.postcode),str},Client.prototype.hasAddress=function(){return this.address1||this.address2||this.postcode},Client.prototype.addressCsvLine=function(){var str;return str="",this.address1&&(str+=this.address1),str+=", ",this.address2&&(str+=this.address2),str+=", ",this.address3&&(str+=this.address3),str+=", ",this.address4&&(str+=this.address4),str+=", ",this.address5&&(str+=this.address5),str+=", ",this.postcode&&(str+=this.postcode),str+=", ",this.country&&(str+=this.country),str},Client.prototype.addressMultiLine=function(){var str;return str="",this.address1&&(str+=this.address1),this.address2&&str.length>0&&(str+="<br/>"),this.address2&&(str+=this.address2),this.address3&&str.length>0&&(str+="<br/>"),this.address3&&(str+=this.address3),this.address4&&str.length>0&&(str+="<br/>"),this.address4&&(str+=this.address4),this.address5&&str.length>0&&(str+="<br/>"),this.address5&&(str+=this.address5),this.postcode&&str.length>0&&(str+="<br/>"),this.postcode&&(str+=this.postcode),str},Client.prototype.getPostData=function(){var i,len,q,ref,x;if(x={},x.first_name=this.first_name,x.last_name=this.last_name,this.house_number?x.address1=this.house_number+" "+this.address1:x.address1=this.address1,x.address2=this.address2,x.address3=this.address3,x.address4=this.address4,x.address5=this.address5,x.postcode=this.postcode,x.country=this.country,x.email=this.email,x.id=this.id,x.comp_ref=this.comp_ref,x.parent_client_id=this.parent_client_id,x.password=this.password,x.notifications=this.notifications,this.member_level_id&&(x.member_level_id=this.member_level_id),this.send_welcome_email&&(x.send_welcome_email=this.send_welcome_email),this.default_company_id&&(x.default_company_id=this.default_company_id),this.phone&&(x.phone=this.phone,this.phone_prefix&&(x.phone_prefix=this.phone_prefix)),this.mobile&&(this.remove_prefix(),x.mobile=this.mobile,x.mobile_prefix=this.mobile_prefix),this.questions)for(x.questions=[],ref=this.questions,i=0,len=ref.length;len>i;i++)q=ref[i],x.questions.push(q.getPostData());return x},Client.prototype.valid=function(){return this.isValid?this.isValid:!(!this.email&&!this.hasServerId())},Client.prototype.setValid=function(val){return this.isValid=val},Client.prototype.hasServerId=function(){return this.id},Client.prototype.setAskedQuestions=function(){return this.asked_questions=!0},Client.prototype.fullMobile=function(){return this.mobile?this.mobile_prefix?"+"+this.mobile_prefix+this.mobile:this.mobile:void 0},Client.prototype.remove_prefix=function(){var pref_arr;return pref_arr=this.mobile.match(/^(\+|00)(999|998|997|996|995|994|993|992|991|990|979|978|977|976|975|974|973|972|971|970|969|968|967|966|965|964|963|962|961|960|899|898|897|896|895|894|893|892|891|890|889|888|887|886|885|884|883|882|881|880|879|878|877|876|875|874|873|872|871|870|859|858|857|856|855|854|853|852|851|850|839|838|837|836|835|834|833|832|831|830|809|808|807|806|805|804|803|802|801|800|699|698|697|696|695|694|693|692|691|690|689|688|687|686|685|684|683|682|681|680|679|678|677|676|675|674|673|672|671|670|599|598|597|596|595|594|593|592|591|590|509|508|507|506|505|504|503|502|501|500|429|428|427|426|425|424|423|422|421|420|389|388|387|386|385|384|383|382|381|380|379|378|377|376|375|374|373|372|371|370|359|358|357|356|355|354|353|352|351|350|299|298|297|296|295|294|293|292|291|290|289|288|287|286|285|284|283|282|281|280|269|268|267|266|265|264|263|262|261|260|259|258|257|256|255|254|253|252|251|250|249|248|247|246|245|244|243|242|241|240|239|238|237|236|235|234|233|232|231|230|229|228|227|226|225|224|223|222|221|220|219|218|217|216|215|214|213|212|211|210|98|95|94|93|92|91|90|86|84|82|81|66|65|64|63|62|61|60|58|57|56|55|54|53|52|51|49|48|47|46|45|44|43|41|40|39|36|34|33|32|31|30|27|20|7|1)/),pref_arr?(this.mobile.replace(pref_arr[0],""),this.mobile_prefix=pref_arr[0]):void 0},Client.prototype.getPrePaidBookingsPromise=function(params){var defer;return defer=$q.defer(),this.$has("pre_paid_bookings")?this.$get("pre_paid_bookings",params).then(function(collection){return collection.$get("pre_paid_bookings").then(function(prepaids){var prepaid;return defer.resolve(function(){var i,len,results;for(results=[],i=0,len=prepaids.length;len>i;i++)prepaid=prepaids[i],results.push(new BBModel.PrePaidBooking(prepaid));return results}())},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}):defer.resolve([]),defer.promise},Client}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ClientDetailsModel",function($q,BBModel,BaseModel){var ClientDetails;return ClientDetails=function(superClass){function ClientDetails(data){var i,len,q,ref;if(ClientDetails.__super__.constructor.apply(this,arguments),this.questions=[],this._data)for(ref=data.questions,i=0,len=ref.length;len>i;i++)q=ref[i],this.questions.push(new BBModel.Question(q));this.hasQuestions=this.questions.length>0}return extend(ClientDetails,superClass),ClientDetails.prototype.getPostData=function(questions){var data,i,len,q;for(data=[],i=0,len=questions.length;len>i;i++)q=questions[i],data.push({answer:q.answer,id:q.id,price:q.price});return data},ClientDetails.prototype.setAnswers=function(answers){var a,ahash,i,j,len,len1,q,ref,results;for(ahash={},i=0,len=answers.length;len>i;i++)a=answers[i],ahash[a.question_id]=a;for(ref=this.questions,results=[],j=0,len1=ref.length;len1>j;j++)q=ref[j],ahash[q.id]?results.push(q.answer=ahash[q.id].answer):results.push(void 0);return results},ClientDetails}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ClinicModel",function($q,BBModel,BaseModel){var Clinic;return Clinic=function(superClass){function Clinic(data){Clinic.__super__.constructor.call(this,data),this.setTimes(),this.setResourcesAndPeople(),this.settings||(this.settings={})}return extend(Clinic,superClass),Clinic.prototype.setResourcesAndPeople=function(){return this.resources=_.reduce(this.resource_ids,function(h,id){return h[id]=!0,h},{}),this.people=_.reduce(this.person_ids,function(h,id){return h[id]=!0,h},{}),this.services=_.reduce(this.service_ids,function(h,id){return h[id]=!0,h},{}),this.uncovered=!this.person_ids||0===this.person_ids.length,this.uncovered?this.className="clinic_uncovered":this.className="clinic_covered"},Clinic.prototype.setTimes=function(){return this.start_time&&(this.start_time=moment(this.start_time),this.start=this.start_time),this.end_time&&(this.end_time=moment(this.end_time),this.end=this.end_time),this.title=this.name},Clinic}(BaseModel)})}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("BBCollectionModel",function($q,BBModel,BaseModel){var BBCollection;return BBCollection=function(superClass){function BBCollection(){return this.getNextPage=bind(this.getNextPage,this),BBCollection.__super__.constructor.apply(this,arguments)}return extend(BBCollection,superClass),BBCollection.prototype.getNextPage=function(params){var deferred;return deferred=$q.defer(),this.$get("next",params).then(function(collection){return deferred.resolve(new BBModel.BBCollection(collection))},function(){return deferred.reject()}),deferred.promise},BBCollection}(BaseModel)})}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("CompanyModel",function($q,BBModel,BaseModel,halClient,AppConfig,$sessionStorage){var Company;return Company=function(superClass){function Company(data){this.getPusherChannel=bind(this.getPusherChannel,this),this.pusherSubscribe=bind(this.pusherSubscribe,this);var all_companies,c,child,comp,i,j,len,len1,ref1,ref2;if(Company.__super__.constructor.call(this,data),this.companies){for(all_companies=[],this.child_companies=[],ref1=this.companies,i=0,len=ref1.length;len>i;i++)if(comp=ref1[i],c=new BBModel.Company(halClient.$parse(comp)),this.child_companies.push(c),c.companies)for(ref2=c.companies,j=0,len1=ref2.length;len1>j;j++)child=ref2[j],all_companies.push(child);else all_companies.push(c);this.companies=all_companies}}return extend(Company,superClass),Company.prototype.getCompanyByRef=function(ref){var defer;return defer=$q.defer(),this.$get("companies").then(function(companies){var company;return company=_.find(companies,function(c){return c.reference===ref}),company?defer.resolve(company):defer.reject("No company for ref "+ref)},function(err){return console.log("err ",err),defer.reject(err)}),defer.promise},Company.prototype.findChildCompany=function(id){var c,cname,i,j,len,len1,name,ref1,ref2;if(!this.companies)return null;for(ref1=this.companies,i=0,len=ref1.length;len>i;i++){if(c=ref1[i],c.id===parseInt(id))return c;if(c.ref&&c.ref===String(id))return c}if("string"==typeof id)for(name=id.replace(/[\s\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,"").toLowerCase(),ref2=this.companies,j=0,len1=ref2.length;len1>j;j++)if(c=ref2[j],cname=c.name.replace(/[\s\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,"").toLowerCase(),name===cname)return c;return null},Company.prototype.getSettings=function(){var def;return def=$q.defer(),this.settings?def.resolve(this.settings):this.$has("settings")?this.$get("settings").then(function(_this){return function(set){return _this.settings=new BBModel.CompanySettings(set),def.resolve(_this.settings)}}(this)):def.reject("Company has no settings"),def.promise},Company.prototype.pusherSubscribe=function(callback,options){var channelName;return null==options&&(options={}),"undefined"!=typeof Pusher&&null!==Pusher&&null==this.pusher&&(this.pusher=new Pusher("c8d8cea659cc46060608",{encrypted:options.hasOwnProperty("encrypted")?options.encrypted:!0,authEndpoint:this.$link("pusher").href,auth:{headers:{"App-Id":AppConfig.appId,"App-Key":AppConfig.appKey,"Auth-Token":$sessionStorage.getItem("auth_token")}}}),channelName="private-c"+this.id+"-w"+this.numeric_widget_id,null==this.pusher.channel(channelName))?(this.pusher_channel=this.pusher.subscribe(channelName),this.pusher_channel.bind("booking",callback),this.pusher_channel.bind("cancellation",callback),this.pusher_channel.bind("updating",callback)):void 0},Company.prototype.getPusherChannel=function(model,options){var channelName;return null==options&&(options={}),this.pusher||(this.pusher=new Pusher("c8d8cea659cc46060608",{encrypted:options.hasOwnProperty("encrypted")?options.encrypted:!0,authEndpoint:this.$link("pusher").href,auth:{headers:{"App-Id":AppConfig.appId,"App-Key":AppConfig.appKey,"Auth-Token":$sessionStorage.getItem("auth_token")}}})),this.$has(model)?(channelName=this.$href(model),channelName=channelName.replace(/https?:\/\//,"").replace(/\//g,"-").replace(/:/g,"_"),this.pusher.channel(channelName)?this.pusher.channel(channelName):(this.pusher.subscribe(channelName),this.pusher.channel(channelName))):void 0},Company}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("CompanySettingsModel",function($q,BBModel,BaseModel){var CompanySettings;return CompanySettings=function(superClass){function CompanySettings(){return CompanySettings.__super__.constructor.apply(this,arguments)}return extend(CompanySettings,superClass),CompanySettings}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("DayModel",function($q,BBModel,BaseModel){var Day;return Day=function(superClass){function Day(data){Day.__super__.constructor.apply(this,arguments),this.string_date=this.date,this.date=moment(this.date)}return extend(Day,superClass),Day.prototype.day=function(){return this.date.date()},Day.prototype.off=function(month){return this.date.month()!==month},Day.prototype["class"]=function(month){var str;return str="",this.date.month()<month&&(str+="off off-prev"),this.date.month()>month&&(str+="off off-next"),0===this.spaces&&(str+=" not-avail"),str},Day}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("DealModel",function($q,BBModel,BaseModel){var Deal;return Deal=function(superClass){function Deal(){return Deal.__super__.constructor.apply(this,arguments)}return extend(Deal,superClass),Deal}(BaseModel)})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("EventModel",function($q,BBModel,BaseModel,DateTimeUlititiesService){var Event;return Event=function(superClass){function Event(data){Event.__super__.constructor.call(this,data),this.date=moment.parseZone(this.datetime),this.time=new BBModel.TimeSlot({time:DateTimeUlititiesService.convertMomentToTime(this.date)}),this.duration&&(this.end_datetime=this.date.clone().add(this.duration,"minutes")),this.date_unix=this.date.unix()}return extend(Event,superClass),Event.prototype.getGroup=function(){var defer,event_group;return defer=$q.defer(),this.group?defer.resolve(this.group):this.$has("event_groups")||this.$has("event_group")?(event_group="event_group",this.$has("event_groups")&&(event_group="event_groups"),this.$get(event_group).then(function(_this){return function(group){return _this.group=new BBModel.EventGroup(group),defer.resolve(_this.group)}}(this),function(err){return defer.reject(err)})):defer.reject("No event group"),defer.promise},Event.prototype.getChain=function(){var defer,event_chain;return defer=$q.defer(),this.chain?defer.resolve(this.chain):this.$has("event_chains")||this.$has("event_chain")?(event_chain="event_chain",this.$has("event_chains")&&(event_chain="event_chains"),this.$get(event_chain).then(function(_this){return function(chain){return _this.chain=new BBModel.EventChain(chain),defer.resolve(_this.chain)}}(this))):defer.reject("No event chain"),defer.promise},Event.prototype.getDuration=function(){var defer;return defer=new $q.defer,this.duration?defer.resolve(this.duration):this.getChain().then(function(_this){return function(chain){return _this.duration=chain.duration,defer.resolve(_this.duration)}}(this)),defer.promise},Event.prototype.getNumBooked=function(){return this.spaces_blocked+this.spaces_booked+this.spaces_reserved+this.spaces_held},Event.prototype.getSpacesLeft=function(pool){return null==pool&&(pool=null),pool&&this.ticket_spaces&&this.ticket_spaces[pool]?this.ticket_spaces[pool].left:this.num_spaces-this.getNumBooked()},Event.prototype.hasSpace=function(){return this.getSpacesLeft()>0},Event.prototype.hasWaitlistSpace=function(){return this.getSpacesLeft()<=0&&this.getChain().waitlength>this.spaces_wait},Event.prototype.getRemainingDescription=function(){var left;return left=this.getSpacesLeft(),left>0&&3>left?"Only "+left+" "+(left>1?"spaces":"space")+" left":this.hasWaitlistSpace()?"Join Waitlist":""},Event.prototype.select=function(){return this.selected=!0},Event.prototype.unselect=function(){return this.selected?delete this.selected:void 0},Event.prototype.prepEvent=function(){var def;return def=$q.defer(),this.getChain().then(function(_this){return function(){return _this.chain.$has("address")&&_this.chain.getAddressPromise().then(function(address){return _this.chain.address=address}),_this.chain.getTickets().then(function(tickets){var i,len,ref,ticket;if(_this.tickets=tickets,_this.price_range={},tickets&&tickets.length>0)for(ref=_this.tickets,i=0,len=ref.length;len>i;i++)ticket=ref[i],(!_this.price_range.from||_this.price_range.from&&ticket.price<_this.price_range.from)&&(_this.price_range.from=ticket.price),(!_this.price_range.to||_this.price_range.to&&ticket.price>_this.price_range.to)&&(_this.price_range.to=ticket.price),ticket.old_price=ticket.price;else _this.price_range.from=_this.price,_this.price_range.to=_this.price;return _this.ticket_prices=_.indexBy(tickets,"name"),def.resolve(_this)})}}(this)),def.promise},Event.prototype.updatePrice=function(){var i,len,ref,results,ticket;for(ref=this.tickets,results=[],i=0,len=ref.length;len>i;i++)ticket=ref[i],ticket.pre_paid_booking_id?results.push(ticket.price=0):results.push(ticket.price=ticket.old_price);return results},Event}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("EventChainModel",function($q,BBModel,BaseModel){var EventChain;return EventChain=function(superClass){function EventChain(data){EventChain.__super__.constructor.apply(this,arguments),this.capacity_view=setCapacityView(this.capacity_view)}var setCapacityView;return extend(EventChain,superClass),EventChain.prototype.name=function(){return this._data.name},EventChain.prototype.isSingleBooking=function(){return 1===this.max_num_bookings&&!this.$has("ticket_sets")},EventChain.prototype.hasTickets=function(){return this.$has("ticket_sets")},EventChain.prototype.getTickets=function(){var def;return def=$q.defer(),this.tickets?def.resolve(this.tickets):this.$has("ticket_sets")?this.$get("ticket_sets").then(function(_this){return function(tickets){var i,len,ticket;for(_this.tickets=[],i=0,len=tickets.length;len>i;i++)ticket=tickets[i],_this.tickets.push(new BBModel.EventTicket(ticket));return _this.adjustTicketsForRemaining(),def.resolve(_this.tickets)}}(this)):(this.tickets=[new BBModel.EventTicket({name:"Admittance",min_num_bookings:1,max_num_bookings:this.max_num_bookings,type:"normal",price:this.price})],this.adjustTicketsForRemaining(),def.resolve(this.tickets)),def.promise},EventChain.prototype.adjustTicketsForRemaining=function(){var i,len,ref,results;if(this.tickets){for(ref=this.tickets,results=[],i=0,len=ref.length;len>i;i++)this.ticket=ref[i],results.push(this.ticket.max_spaces=this.spaces);return results}},setCapacityView=function(capacity_view){var capacity_view_str;switch(capacity_view){case 0:capacity_view_str="DO_NOT_DISPLAY";break;case 1:capacity_view_str="NUM_SPACES";break;case 2:capacity_view_str="NUM_SPACES_LEFT";break;case 3:capacity_view_str="NUM_SPACES_AND_SPACES_LEFT";break;default:capacity_view_str="NUM_SPACES_AND_SPACES_LEFT"}return capacity_view_str},EventChain}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("EventGroupModel",function($q,BBModel,BaseModel){var EventGroup;return EventGroup=function(superClass){function EventGroup(){return EventGroup.__super__.constructor.apply(this,arguments)}return extend(EventGroup,superClass),EventGroup.prototype.name=function(){return this._data.name},EventGroup.prototype.colour=function(){return this._data.colour},EventGroup}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("EventSequenceModel",function($q,BBModel,BaseModel){var EventSequence;return EventSequence=function(superClass){function EventSequence(){return EventSequence.__super__.constructor.apply(this,arguments)}return extend(EventSequence,superClass),EventSequence.prototype.name=function(){return this._data.name},EventSequence}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("EventTicketModel",function($q,BBModel,BaseModel){var EventTicket;return EventTicket=function(superClass){function EventTicket(data){var ms;EventTicket.__super__.constructor.call(this,data),this.max=this.max_num_bookings,this.max_spaces&&(ms=this.max_spaces,this.counts_as&&(ms=this.max_spaces/this.counts_as),ms<max&&(this.max=ms))}return extend(EventTicket,superClass),EventTicket.prototype.fullName=function(){return this.pool_name?this.pool_name+" - "+this.name:this.name},EventTicket.prototype.getRange=function(cap){var c,ref,results;return cap&&(c=cap,this.counts_as&&(c=cap/this.counts_as),c+this.min_num_bookings<this.max&&(this.max=c+this.min_num_bookings)),[0].concat(function(){results=[];for(var i=ref=this.min_num_bookings,ref1=this.max;ref1>=ref?ref1>=i:i>=ref1;ref1>=ref?i++:i--)results.push(i);return results}.apply(this))},EventTicket.prototype.totalQty=function(){return this.qty?this.counts_as?this.qty*this.counts_as:this.qty:0},EventTicket.prototype.getMax=function(cap,ev){var c,i,len,live_max,ref,ticket,used;if(null==ev&&(ev=null),live_max=this.max,ev){for(used=0,ref=ev.tickets,i=0,len=ref.length;len>i;i++)ticket=ref[i],used+=ticket.totalQty();this.qty&&(used-=this.totalQty()),this.counts_as&&(used=Math.ceil(used/this.counts_as)),live_max-=used,0>live_max&&(live_max=0)}return cap&&(c=cap,this.counts_as&&(c=cap/this.counts_as),c+this.min_num_bookings<live_max)?c+this.min_num_bookings:live_max;
},EventTicket.prototype.add=function(value){return this.qty||(this.qty=0),this.qty=parseInt(this.qty),angular.isNumber(this.qty)&&this.qty>=this.max&&value>0||0===this.qty&&0>value?void 0:this.qty+=value},EventTicket.prototype.subtract=function(value){return this.add(-value)},EventTicket}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ExternalPurchaseModel",function($q,BBModel,BaseModel){var ExternalPurchase;return ExternalPurchase=function(superClass){function ExternalPurchase(){return ExternalPurchase.__super__.constructor.apply(this,arguments)}return extend(ExternalPurchase,superClass),ExternalPurchase}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ImageModel",function($q,$filter,BBModel,BaseModel){var Image;return Image=function(superClass){function Image(data){Image.__super__.constructor.call(this,data)}return extend(Image,superClass),Image}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ItemDetailsModel",function($q,BBModel,BaseModel,$bbug,QuestionService){var ItemDetails;return ItemDetails=function(superClass){function ItemDetails(data){var i,len,q,ref;if(this._data=data,this._data&&(this.self=this._data.$href("self")),this.questions=[],this.survey_questions=[],data)for(ref=data.questions,i=0,len=ref.length;len>i;i++)q=ref[i],q.outcome===!1?(data.currency_code&&(q.currency_code=data.currency_code),this.questions.push(new BBModel.Question(q))):this.survey_questions.push(new BBModel.SurveyQuestion(q));this.hasQuestions=this.questions.length>0,this.hasSurveyQuestions=this.survey_questions.length>0}return extend(ItemDetails,superClass),ItemDetails.prototype.questionPrice=function(qty){var i,len,price,q,ref;for(qty||(qty=1),this.checkConditionalQuestions(),price=0,ref=this.questions,i=0,len=ref.length;len>i;i++)q=ref[i],price+=q.selectedPriceQty(qty);return price},ItemDetails.prototype.checkConditionalQuestions=function(){return QuestionService.checkConditionalQuestions(this.questions)},ItemDetails.prototype.getPostData=function(){var data,i,len,q,ref;for(data=[],ref=this.questions,i=0,len=ref.length;len>i;i++)q=ref[i],q.currentlyShown&&data.push(q.getPostData());return data},ItemDetails.prototype.setAnswers=function(answers){var a,ahash,i,j,len,len1,q,ref;for(ahash={},i=0,len=answers.length;len>i;i++)a=answers[i],ahash[a.id]=a;for(ref=this.questions,j=0,len1=ref.length;len1>j;j++)q=ref[j],ahash[q.id]&&(q.answer=ahash[q.id].answer);return this.checkConditionalQuestions()},ItemDetails.prototype.getQuestion=function(id){return _.findWhere(this.questions,{id:id})},ItemDetails}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("MembershipLevelModel",function($q,BBModel,BaseModel){var MembershipLevel;return MembershipLevel=function(superClass){function MembershipLevel(){return MembershipLevel.__super__.constructor.apply(this,arguments)}return extend(MembershipLevel,superClass),MembershipLevel}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("PackageItemModel",function($q,BBModel,BaseModel){var PackageItem;return PackageItem=function(superClass){function PackageItem(){return PackageItem.__super__.constructor.apply(this,arguments)}return extend(PackageItem,superClass),PackageItem}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("PersonModel",function($q,BBModel,BaseModel){var Person;return Person=function(superClass){function Person(){return Person.__super__.constructor.apply(this,arguments)}return extend(Person,superClass),Person}(BaseModel)})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("PrePaidBookingModel",function($q,BBModel,BaseModel){var PrePaidBooking;return PrePaidBooking=function(superClass){function PrePaidBooking(data){PrePaidBooking.__super__.constructor.call(this,data),this.book_by&&(this.book_by=moment(this.book_by)),this.use_by&&(this.use_by=moment(this.use_by)),this.use_from&&(this.use_from=moment(this.use_from)),this.expired=this.book_by&&moment().isAfter(this.book_by,"day")||this.use_by&&moment().isAfter(this.use_by,"day")||!1}return extend(PrePaidBooking,superClass),PrePaidBooking.prototype.checkValidity=function(item){return this.service_id&&item.service_id&&this.service_id!==item.service_id?!1:this.resource_id&&item.resource_id&&this.resource_id!==item.resource_id?!1:!this.person_id||!item.person_id||this.person_id===item.person_id},PrePaidBooking}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ProductModel",function($q,BBModel,BaseModel){var Product;return Product=function(superClass){function Product(){return Product.__super__.constructor.apply(this,arguments)}return extend(Product,superClass),Product}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("PurchaseItemModel",function($q,BBModel,BaseModel){var PurchaseItem;return PurchaseItem=function(superClass){function PurchaseItem(data){PurchaseItem.__super__.constructor.call(this,data),this.parts_links={},data&&(data.$has("service")&&(this.parts_links.service=data.$href("service")),data.$has("resource")&&(this.parts_links.resource=data.$href("resource")),data.$has("person")&&(this.parts_links.person=data.$href("person")),data.$has("company")&&(this.parts_links.company=data.$href("company")))}return extend(PurchaseItem,superClass),PurchaseItem.prototype.describe=function(){return this.get("describe")},PurchaseItem.prototype.full_describe=function(){return this.get("full_describe")},PurchaseItem.prototype.hasPrice=function(){return this.price&&this.price>0},PurchaseItem}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("PurchaseTotalModel",function($q,BBModel,BaseModel){var PurchaseTotal;return PurchaseTotal=function(superClass){function PurchaseTotal(data){var cprom;PurchaseTotal.__super__.constructor.call(this,data),this.promise=this._data.$get("purchase_items"),this.purchase_items=[],this.promise.then(function(_this){return function(items){var i,item,len,results;for(results=[],i=0,len=items.length;len>i;i++)item=items[i],results.push(_this.purchase_items.push(new BBModel.PurchaseItem(item)));return results}}(this)),this._data.$has("client")&&(cprom=data.$get("client"),cprom.then(function(_this){return function(client){return _this.client=new BBModel.Client(client)}}(this))),this.created_at=moment.parseZone(this.created_at),this.time_zone&&this.created_at.tz(this.time_zone)}return extend(PurchaseTotal,superClass),PurchaseTotal.prototype.icalLink=function(){return this._data.$href("ical")},PurchaseTotal.prototype.webcalLink=function(){return this._data.$href("ical")},PurchaseTotal.prototype.gcalLink=function(){return this._data.$href("gcal")},PurchaseTotal.prototype.id=function(){return this.get("id")},PurchaseTotal}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("QuestionModel",function($q,$filter,BBModel,BaseModel){var Question;return Question=function(superClass){function Question(data){var currency,i,len,option,ref;if(Question.__super__.constructor.call(this,data),this.price&&(this.price=parseFloat(this.price)),this._data["default"]&&(this.answer=this._data["default"]),this._data.options)for(ref=this._data.options,i=0,len=ref.length;len>i;i++)option=ref[i],option.is_default&&(this.answer=option.name),this.hasPrice()?(option.price=parseFloat(option.price),currency=data.currency_code?data.currency_code:"GBP",option.display_name=option.name+" ("+$filter("currency")(option.price,currency)+")"):option.display_name=option.name;"check"!==this._data.detail_type&&"check-price"!==this._data.detail_type||(this.answer=this._data["default"]&&"1"===this._data["default"]),this.currentlyShown=!0}return extend(Question,superClass),Question.prototype.hasPrice=function(){return"check-price"===this.detail_type||"select-price"===this.detail_type||"radio-price"===this.detail_type},Question.prototype.selectedPrice=function(){var i,len,option,ref;if(!this.hasPrice())return 0;if("check-price"===this.detail_type)return this.answer?this.price:0;for(ref=this._data.options,i=0,len=ref.length;len>i;i++)if(option=ref[i],this.answer===option.name)return option.price;return 0},Question.prototype.selectedPriceQty=function(qty){var p;return qty||(qty=1),p=this.selectedPrice(),this.price_per_booking&&(p*=qty),p},Question.prototype.getAnswerId=function(){var i,len,o,ref;if(!this.answer||!this.options||0===this.options.length)return null;for(ref=this.options,i=0,len=ref.length;len>i;i++)if(o=ref[i],this.answer===o.name)return o.id;return null},Question.prototype.showElement=function(){return this.currentlyShown=!0},Question.prototype.hideElement=function(){return this.currentlyShown=!1},Question.prototype.getPostData=function(){var p,x;return x={},x.id=this.id,x.answer=this.answer,"date"===this.detail_type&&this.answer&&(x.answer=moment(this.answer).toISODate()),p=this.selectedPrice(),p&&(x.price=p),x},Question}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ResourceModel",function($q,BBModel,BaseModel){var Resource;return Resource=function(superClass){function Resource(){return Resource.__super__.constructor.apply(this,arguments)}return extend(Resource,superClass),Resource}(BaseModel)})}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("ServiceModel",function($q,BBModel,BaseModel){var Service;return Service=function(superClass){function Service(data){this.days_array=bind(this.days_array,this),this.getCategoryPromise=bind(this.getCategoryPromise,this),Service.__super__.constructor.apply(this,arguments),this.prices&&this.prices.length>0&&(this.price=this.prices[0]),this.durations&&this.durations.length>0&&(this.duration=this.durations[0]),this.listed_durations||(this.listed_durations=this.durations),this.listed_durations&&this.listed_durations.length>0&&(this.listed_duration=this.listed_durations[0]),this.min_advance_datetime=moment().add(this.min_advance_period,"seconds"),this.max_advance_datetime=moment().add(this.max_advance_period,"seconds")}return extend(Service,superClass),Service.prototype.getPriceByDuration=function(dur){var d,i,j,len,ref;for(ref=this.durations,i=j=0,len=ref.length;len>j;i=++j)if(d=ref[i],d===dur)return this.prices[i]},Service.prototype.getCategoryPromise=function(){var prom;return this.$has("category")?(prom=this.$get("category"),prom.then(function(_this){return function(cat){return _this.category=new BBModel.Category(cat)}}(this)),prom):null},Service.prototype.days_array=function(){var arr,j,ref,ref1,str,x;for(arr=[],x=j=ref=this.min_bookings,ref1=this.max_bookings;ref1>=ref?ref1>=j:j>=ref1;x=ref1>=ref?++j:--j)str=""+x+" day",x>1&&(str+="s"),arr.push({name:str,val:x});return arr},Service}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("SlotModel",function($q,BBModel,BaseModel){var Slot;return Slot=function(superClass){function Slot(data){Slot.__super__.constructor.call(this,data),this.datetime=moment(data.datetime)}return extend(Slot,superClass),Slot}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("SpaceModel",function($q,BBModel,BaseModel){var Space;return Space=function(superClass){function Space(){return Space.__super__.constructor.apply(this,arguments)}return extend(Space,superClass),Space}(BaseModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("SurveyQuestionModel",function($q,$window,BBModel,BaseModel,QuestionModel){var SurveyQuestion;return SurveyQuestion=function(superClass){function SurveyQuestion(){return SurveyQuestion.__super__.constructor.apply(this,arguments)}return extend(SurveyQuestion,superClass),SurveyQuestion}(QuestionModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("TimeSlotModel",function($q,$window,BBModel,BaseModel,DateTimeUlititiesService){var TimeSlot;return TimeSlot=function(superClass){function TimeSlot(data,service){TimeSlot.__super__.constructor.call(this,data),this.service=service,this.time_12=this.print_time12(),this.time_24=this.print_time(),this.time_moment=DateTimeUlititiesService.convertTimeSlotToMoment({date:moment()},this)}return extend(TimeSlot,superClass),TimeSlot.prototype.print_time=function(){var min,t;return this.start?this.start.format("h:mm"):(t=this.get("time"),min=10>t%60?"0"+t%60:t%60,""+Math.floor(t/60)+":"+min)},TimeSlot.prototype.print_end_time=function(dur){var min,t;return this.end?this.end.format("h:mm"):(dur||(dur=this.service.listed_durations[0]),t=this.get("time")+dur,min=10>t%60?"0"+t%60:t%60,""+Math.floor(t/60)+":"+min)},TimeSlot.prototype.print_time12=function(show_suffix){var h,m,suffix,t,time;return null==show_suffix&&(show_suffix=!0),t=this.get("time"),h=Math.floor(t/60),m=t%60,suffix="am",h>=12&&(suffix="pm"),h>12&&(h-=12),time=$window.sprintf("%d.%02d",h,m),show_suffix&&(time+=suffix),time},TimeSlot.prototype.print_end_time12=function(show_suffix,dur){var end_time,h,m,suffix,t;return null==show_suffix&&(show_suffix=!0),dur=null,dur||(dur=null!=this.service.listed_duration?this.service.listed_duration:this.service.listed_durations[0]),t=this.get("time")+dur,h=Math.floor(t/60),m=t%60,suffix="am",h>=12&&(suffix="pm"),h>12&&(h-=12),end_time=$window.sprintf("%d.%02d",h,m),show_suffix&&(end_time+=suffix),end_time},TimeSlot.prototype.availability=function(){return this.avail},TimeSlot.prototype.select=function(){return this.selected=!0},TimeSlot.prototype.unselect=function(){return this.selected?delete this.selected:void 0},TimeSlot.prototype.disable=function(reason){return this.disabled=!0,this.disabled_reason=reason},TimeSlot.prototype.enable=function(){return this.disabled&&delete this.disabled,this.disabled_reason?delete this.disabled_reason:void 0},TimeSlot.prototype.status=function(){return this.selected?"selected":this.disabled?"disabled":this.availability()>0?"enabled":"disabled"},TimeSlot}(BaseModel)})}.call(this),function(){angular.module("BB.Services").factory("AddressListService",function($q,$window,halClient,UriTemplate){return{query:function(prms){var deferred,href,uri;return deferred=$q.defer(),href="/api/v1/company/{company_id}/addresses/{post_code}",uri=new UriTemplate(href).fillFromObject({company_id:prms.company.id,post_code:prms.post_code}),halClient.$get(uri,{}).then(function(addressList){return deferred.resolve(addressList)},function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},getAddress:function(prms){var deferred,href,uri;return deferred=$q.defer(),href="/api/v1/company/{company_id}/addresses/address/{id}",uri=new UriTemplate(href).fillFromObject({company_id:prms.company.id,id:prms.id}),halClient.$get(uri,{}).then(function(customerAddress){return deferred.resolve(customerAddress)},function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("$exceptionHandler",function($log,AirbrakeConfig){var airbrake;return airbrake=new airbrakeJs.Client({projectId:AirbrakeConfig.projectId,projectKey:AirbrakeConfig.projectKey}),airbrake.addFilter(function(notice){return"development"!==AirbrakeConfig.environment?(notice.context.environment="production",notice):void 0}),function(exception,cause){$log.error(exception),airbrake.notify({error:exception,params:{angular_cause:cause}})}})}.call(this),function(){angular.module("BB.Services").factory("AlertService",function($rootScope,ErrorService,$timeout){var alertService,titleLookup;return $rootScope.alerts=[],titleLookup=function(type,title){if(title)return title;switch(type){case"error":case"danger":title="Error";break;default:title=null}return title},alertService={add:function(type,arg){var alert,msg,persist,title;return title=arg.title,msg=arg.msg,persist=arg.persist,null==persist&&(persist=!0),$rootScope.alerts=[],alert={type:type,title:titleLookup(type,title),msg:msg,close:function(){return alertService.closeAlert(this)}},$rootScope.alerts.push(alert),persist||$timeout(function(){return $rootScope.alerts.splice($rootScope.alerts.indexOf(alert),1)},3e3),$rootScope.$broadcast("alert:raised")},closeAlert:function(alert){return this.closeAlertIdx($rootScope.alerts.indexOf(alert))},closeAlertIdx:function(index){return $rootScope.alerts.splice(index,1)},clear:function(){return $rootScope.alerts=[]},error:function(alert){return alert?this.add("error",{title:alert.title,msg:alert.msg,persist:alert.persist}):void 0},danger:function(alert){return alert?this.add("danger",{title:alert.title,msg:alert.msg,persist:alert.persist}):void 0},info:function(alert){return alert?this.add("info",{title:alert.title,msg:alert.msg,persist:alert.persist}):void 0},warning:function(alert){return alert?this.add("warning",{title:alert.title,msg:alert.msg,persist:alert.persist}):void 0},success:function(alert){return alert?this.add("success",{title:alert.title,msg:alert.msg,persist:alert.persist}):void 0},raise:function(key){var alert;if(key)return alert=ErrorService.getAlert(key),alert?this.add(alert.type,{title:alert.title,msg:alert.msg,persist:alert.persist}):void 0}}})}.call(this),function(){angular.module("BB.Services").factory("BasketService",function($q,$rootScope,BBModel,MutexService){return{addItem:function(company,params){var data,deferred,lnk;return deferred=$q.defer(),lnk=params.item.book_link,data=params.item.getPostData(),lnk?MutexService.getLock().then(function(mutex){return lnk.$post("book",params,data).then(function(basket){var mbasket;return MutexService.unlock(mutex),company.$flush("basket"),mbasket=new BBModel.Basket(basket,params.bb),basket.$get("items").then(function(items){var i,item,j,len,promises;for(promises=[],j=0,len=items.length;len>j;j++)i=items[j],item=new BBModel.BasketItem(i,params.bb),mbasket.addItem(item),promises=promises.concat(item.promises);return promises.length>0?$q.all(promises).then(function(){return deferred.resolve(mbasket)}):deferred.resolve(mbasket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}):deferred.reject("rel book not found for event"),deferred.promise},applyCoupon:function(company,params){var deferred;return deferred=$q.defer(),MutexService.getLock().then(function(mutex){return company.$post("coupon",{},{coupon:params.coupon}).then(function(basket){var mbasket;return MutexService.unlock(mutex),company.$flush("basket"),mbasket=new BBModel.Basket(basket,params.bb),basket.$get("items").then(function(items){var i,item,j,len,promises;for(promises=[],j=0,len=items.length;len>j;j++)i=items[j],item=new BBModel.BasketItem(i,params.bb),mbasket.addItem(item),promises=promises.concat(item.promises);return promises.length>0?$q.all(promises).then(function(){return deferred.resolve(mbasket)}):deferred.resolve(mbasket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise},updateBasket:function(company,params){var data,deferred,item,j,len,lnk,ref,xdata;for(deferred=$q.defer(),data={entire_basket:!0,items:[]},ref=params.items,j=0,len=ref.length;len>j;j++)item=ref[j],item.book_link&&(lnk=item.book_link),xdata=item.getPostData(),data.items.push(xdata);return lnk?(MutexService.getLock().then(function(mutex){return lnk.$post("book",params,data).then(function(basket){var mbasket;return MutexService.unlock(mutex),company.$flush("basket"),mbasket=new BBModel.Basket(basket,params.bb),basket.$get("items").then(function(items){var i,k,len1,promises;for(promises=[],k=0,len1=items.length;len1>k;k++)i=items[k],item=new BBModel.BasketItem(i,params.bb),mbasket.addItem(item),promises=promises.concat(item.promises);return promises.length>0?$q.all(promises).then(function(){return $rootScope.$broadcast("basket:updated",mbasket),deferred.resolve(mbasket)}):($rootScope.$broadcast("basket:updated",mbasket),deferred.resolve(mbasket))},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise):(deferred.reject("rel book not found for event"),deferred.promise)},checkPrePaid:function(item,pre_paid_bookings){var booking,j,len,valid_pre_paid;for(valid_pre_paid=null,j=0,len=pre_paid_bookings.length;len>j;j++)if(booking=pre_paid_bookings[j],booking.checkValidity(item)){valid_pre_paid=booking;break}return valid_pre_paid},query:function(company,params){var deferred;return deferred=$q.defer(),company.$has("basket")?company.$get("basket").then(function(basket){return basket=new BBModel.Basket(basket,params.bb),basket.$has("items")&&basket.$get("items").then(function(items){var item,j,len,results;for(results=[],j=0,len=items.length;len>j;j++)item=items[j],results.push(basket.addItem(new BBModel.BasketItem(item,params.bb)));return results}),deferred.resolve(basket)},function(err){return deferred.reject(err)}):deferred.reject("rel basket not found for company"),deferred.promise},deleteItem:function(item,company,params){var deferred;return params||(params={}),deferred=$q.defer(),item.$has("self")?MutexService.getLock().then(function(mutex){return item.$del("self",params).then(function(basket){return MutexService.unlock(mutex),company.$flush("basket"),basket=new BBModel.Basket(basket,params.bb),basket.$has("items")&&basket.$get("items").then(function(items){var j,len,results;for(results=[],j=0,len=items.length;len>j;j++)item=items[j],results.push(basket.addItem(new BBModel.BasketItem(item,params.bb)));return results}),deferred.resolve(basket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)}):deferred.reject("rel self not found for item"),deferred.promise},checkout:function(company,basket,params){var data,deferred;return deferred=$q.defer(),basket.$has("checkout")?(data=basket.getPostData(),params.bb.qudini_booking_id&&(data.qudini_booking_id=params.bb.qudini_booking_id),params.bb.no_notifications&&(data.no_notifications=params.bb.no_notifications),data.affiliate_id=$rootScope.affiliate_id,basket.waiting_for_checkout=!0,MutexService.getLock().then(function(mutex){return basket.$post("checkout",params,data).then(function(total){var tot;return MutexService.unlock(mutex),$rootScope.$broadcast("updateBookings"),tot=new BBModel.Purchase.Total(total),$rootScope.$broadcast("newCheckout",tot),basket.clear(),basket.waiting_for_checkout=!1,deferred.resolve(tot)},function(err){return basket.waiting_for_checkout=!1,deferred.reject(err)})},function(err){return basket.waiting_for_checkout=!1,MutexService.unlock(mutex),deferred.reject(err)})):deferred.reject("rel checkout not found for basket"),deferred.promise},empty:function(bb){var deferred;return deferred=$q.defer(),MutexService.getLock().then(function(mutex){return bb.company.$del("basket").then(function(basket){return MutexService.unlock(mutex),bb.company.$flush("basket"),deferred.resolve(new BBModel.Basket(basket,bb))},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)}),deferred.promise},memberCheckout:function(basket,params){var data,deferred,item;return deferred=$q.defer(),basket.$has("checkout")?null===$rootScope.member?deferred.reject("member not set"):(basket._data.setOption("auth_token",$rootScope.member._data.getOption("auth_token")),data={items:function(){var j,len,ref,results;for(ref=basket.items,results=[],j=0,len=ref.length;len>j;j++)item=ref[j],results.push(item._data);return results}()},basket.$post("checkout",params,data).then(function(total){return total.$has("member")&&total.$get("member").then(function(member){return $rootScope.member.flushBookings(),$rootScope.member=new BBModel.Member.Member(member)}),deferred.resolve(total)},function(err){return deferred.reject(err)})):deferred.reject("rel checkout not found for basket"),deferred.promise},applyDeal:function(company,params){var deferred;return deferred=$q.defer(),MutexService.getLock().then(function(mutex){return params.bb.basket.$post("deal",{},{deal_code:params.deal_code}).then(function(basket){var mbasket;return MutexService.unlock(mutex),company.$flush("basket"),mbasket=new BBModel.Basket(basket,params.bb),basket.$get("items").then(function(items){var i,item,j,len,promises;for(promises=[],j=0,len=items.length;len>j;j++)i=items[j],item=new BBModel.BasketItem(i,params.bb),mbasket.addItem(item),promises=promises.concat(item.promises);return promises.length>0?$q.all(promises).then(function(){return deferred.resolve(mbasket)}):deferred.resolve(mbasket)},function(err){return deferred.reject(err)})},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise},removeDeal:function(company,params){var deferred;return params||(params={}),deferred=$q.defer(),params.bb.basket.$has("deal")?(MutexService.getLock().then(function(mutex){return params.bb.basket.$put("deal",{},{deal_code_id:params.deal_code_id.toString()}).then(function(basket){return MutexService.unlock(mutex),company.$flush("basket"),basket=new BBModel.Basket(basket,params.bb),basket.$has("items")?basket.$get("items").then(function(items){var item,j,len;for(j=0,len=items.length;len>j;j++)item=items[j],basket.addItem(new BBModel.BasketItem(item,params.bb));return deferred.resolve(basket)},function(err){return deferred.reject(err)}):void 0},function(err){return MutexService.unlock(mutex),deferred.reject(err)})}),deferred.promise):deferred.reject("No Remove Deal link found")}}})}.call(this),function(){angular.module("BB.Services").factory("BreadcrumbService",function(){var current_step;return current_step=1,{setCurrentStep:function(step){return current_step=step},getCurrentStep:function(){return current_step}}})}.call(this),function(){angular.module("BB.Services").factory("BulkPurchaseService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("bulk_purchases")?company.$get("bulk_purchases").then(function(resource){return resource.$get("bulk_purchases").then(function(bulk_purchases){var i;return deferred.resolve(function(){var j,len,results;for(results=[],j=0,len=bulk_purchases.length;len>j;j++)i=bulk_purchases[j],results.push(new BBModel.BulkPurchase(i));return results}())})},function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No bulk purchases found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("CategoryService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("categories")?company.$get("named_categories").then(function(_this){return function(resource){return resource.$get("categories").then(function(items){var _i,cat,categories,i,j,len;for(categories=[],_i=j=0,len=items.length;len>j;_i=++j)i=items[_i],cat=new BBModel.Category(i),cat.order||(cat.order=_i),categories.push(cat);return deferred.resolve(categories)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No categories found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ClientService",function($q,BBModel,MutexService){return{create:function(company,client){var deferred;return deferred=$q.defer(),
company.$has("client")?MutexService.getLock().then(function(mutex){return company.$post("client",{},client.getPostData()).then(function(_this){return function(cl){return deferred.resolve(new BBModel.Client(cl)),MutexService.unlock(mutex)}}(this),function(_this){return function(err){return deferred.reject(err),MutexService.unlock(mutex)}}(this))}):deferred.reject("Cannot create new people for this company"),deferred.promise},update:function(company,client){var deferred;return deferred=$q.defer(),MutexService.getLock().then(function(mutex){return client.$put("self",{},client.getPostData()).then(function(_this){return function(cl){return deferred.resolve(new BBModel.Client(cl)),MutexService.unlock(mutex)}}(this),function(_this){return function(err){return deferred.reject(err),MutexService.unlock(mutex)}}(this))}),deferred.promise},create_or_update:function(company,client){return client.$has("self")?this.update(company,client):this.create(company,client)},query_by_email:function(company,email){var deferred;return deferred=$q.defer(),null!=company&&null!=email?company.$get("client_by_email",{email:email}).then(function(_this){return function(client){return null!=client?deferred.resolve(new BBModel.Client(client)):deferred.resolve({})}}(this),function(err){return deferred.reject(err)}):deferred.reject("No company or email defined"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ClientDetailsService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("client_details")?company.$get("client_details").then(function(_this){return function(details){return deferred.resolve(new BBModel.ClientDetails(details))}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No client_details found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ClinicService",function($q,BBModel,$window){return{query:function(params){var company,defer;return company=params.company,defer=$q.defer(),params.id?company.$get("clinics",params).then(function(clinic){return clinic=new BBModel.Clinic(clinic),defer.resolve(clinic)},function(err){return defer.reject(err)}):company.$get("clinics",params).then(function(collection){return collection.$get("clinics").then(function(clinics){var s;return clinics=function(){var i,len,results;for(results=[],i=0,len=clinics.length;len>i;i++)s=clinics[i],results.push(new BBModel.Clinic(s));return results}(),defer.resolve(clinics)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise}}})}.call(this),function(){angular.module("BB.Services").factory("CompanyService",function($q,halClient,BBModel){return{query:function(company_id,options){var deferred,url;return options.root||(options.root=""),url=options.root+"/api/v1/company/"+company_id,deferred=$q.defer(),halClient.$get(url,options).then(function(_this){return function(company){return deferred.resolve(company)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},queryChildren:function(company){var deferred;return deferred=$q.defer(),company.$has("companies")?company.$get("companies").then(function(_this){return function(resource){return resource.$get("companies").then(function(items){var companies,i,j,len;for(companies=[],j=0,len=items.length;len>j;j++)i=items[j],companies.push(new BBModel.Company(i));return deferred.resolve(companies)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No child companies found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("CustomTextService",function($q,BBModel){return{BookingText:function(company,basketItem){var deferred;return deferred=$q.defer(),company.$get("booking_text").then(function(_this){return function(emb){return emb.$get("booking_text").then(function(details){var detail,i,len,link,msgs,name,ref;for(msgs=[],i=0,len=details.length;len>i;i++)if(detail=details[i],"Booking"===detail.message_type){ref=basketItem.parts_links;for(name in ref)link=ref[name],detail.$href("item")===link&&-1===msgs.indexOf(detail.message)&&msgs.push(detail.message)}return deferred.resolve(msgs)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},confirmationText:function(company,total){var deferred;return deferred=$q.defer(),company.$get("booking_text").then(function(emb){return emb.$get("booking_text").then(function(details){return total.getMessages(details,"Confirm").then(function(msgs){return deferred.resolve(msgs)})})},function(err){return deferred.reject(err)}),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("DateTimeUlititiesService",function(AlertService){return{convertTimeSlotToMoment:function(day,time_slot){var datetime,hours,mins,val;if(day||time_slot)return datetime=moment(),val=parseInt(time_slot.time),hours=parseInt(val/60),mins=val%60,datetime.hour(hours),datetime.minutes(mins),datetime.seconds(0),datetime.date(day.date.date()),datetime.month(day.date.month()),datetime.year(day.date.year()),datetime},convertMomentToTime:function(datetime){return datetime.minutes()+60*datetime.hours()},checkRequestedTime:function(day,time_slots,current_item){var found_time,i,len,slot;if((current_item.requested_time||current_item.time)&&current_item.requested_date&&day.date.isSame(current_item.requested_date)){for(found_time=!1,i=0,len=time_slots.length;len>i;i++){if(slot=time_slots[i],slot.time===current_item.requested_time)return current_item.requestedTimeUnavailable(),$scope.selectSlot(day,slot),found_time=!0,void($scope.days=[]);current_item.time&&current_item.time.time===slot.time&&1===slot.avail&&($scope.selected_slot&&$scope.selected_slot.time!==current_item.time.time&&($scope.selected_slot=current_item.time),current_item.setTime(slot),found_time=!0)}if(!found_time)return current_item.requestedTimeUnavailable()}}}})}.call(this),function(){angular.module("BB.Services").factory("DayService",function($q,BBModel){return{query:function(prms){var deferred,extra;return deferred=$q.defer(),prms.cItem.days_link?(extra={},extra.month=prms.month,extra.date=prms.date,extra.edate=prms.edate,prms.client&&(extra.location=prms.client.addressCsvLine()),prms.cItem.person&&!prms.cItem.anyPerson()&&(extra.person_id=prms.cItem.person.id),prms.cItem.resource&&!prms.cItem.anyResource()&&(extra.resource_id=prms.cItem.resource.id),prms.cItem.days_link.$get("days",extra).then(function(_this){return function(found){var afound,days,i,j,len;for(afound=found.days,days=[],j=0,len=afound.length;len>j;j++)i=afound[j],i.type===prms.item&&days.push(new BBModel.Day(i));return deferred.resolve(days)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this))):deferred.reject("No Days Link found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("DealService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("deals")?company.$get("deals").then(function(_this){return function(resource){return resource.$get("deals").then(function(deals){var deal;return deals=function(){var i,len,results;for(results=[],i=0,len=deals.length;len>i;i++)deal=deals[i],results.push(new BBModel.Deal(deal));return results}(),deferred.resolve(deals)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No Deals found"),deferred.promise}}})}.call(this),function(){angular.module("BB").config(function($logProvider,$injector){return $logProvider.debugEnabled(!0)}),angular.module("BB.Services").factory("DebugUtilsService",function($rootScope,$location,$window,$log,BBModel,$bbug){var logObjectKeys,showScopeChain;return logObjectKeys=function(obj,showValue){var key,value;for(key in obj)value=obj[key],!obj.hasOwnProperty(key)||_.isFunction(value)||/^\$\$/.test(key)||(console.log(key),showValue&&console.log("	",value,"\n"))},showScopeChain=function(){var $root,data,f;$root=$("[ng-app]"),data=$root.data(),data&&data.$scope&&(f=function(scope){return console.log(scope.$id),console.log(scope),scope.$$nextSibling?f(scope.$$nextSibling):scope.$$childHead?f(scope.$$childHead):void 0})(data.$scope)},function(){return"localhost"!==$location.host()&&"127.0.0.1"!==$location.host()||3e3!==$location.port()?void 0:window.setTimeout(function(){var scope;for(scope=$rootScope;scope&&"public.controllers.BBCtrl"!==scope.controller;)scope=scope.$$childHead;return $bbug($window).on("dblclick",function(e){var controller,controllerName,pscope;for(scope=angular.element(e.target).scope(),controller=scope.hasOwnProperty("controller"),pscope=scope,controller&&(controllerName=scope.controller);!controller;)pscope=pscope.$parent,controllerName=pscope.controller,controller=pscope.hasOwnProperty("controller");return $window.bbScope=scope,$log.log(e.target),$log.log($window.bbScope),$log.log("Controller ->",controllerName)}),$window.bbBBCtrlScopeKeyNames=function(prop){return logObjectKeys(scope,prop)},$window.bbBBCtrlScope=function(){return scope},$window.bbCurrentItem=function(){return scope.current_item},$window.bbShowScopeChain=showScopeChain},10)}(),{logObjectKeys:logObjectKeys}})}.call(this),function(){angular.module("BB.Services").factory("Dialog",function($modal,$log){var controller;return controller=function($scope,$modalInstance,model,title,success,fail,body){return $scope.body=body,$scope.ok=function(){return $modalInstance.close(model)},$scope.cancel=function(){return event.preventDefault(),event.stopPropagation(),$modalInstance.dismiss("cancel")},$modalInstance.result.then(function(){return success?success(model):void 0},function(){return fail?fail():void 0})},{confirm:function(config){var templateUrl;return config.templateUrl&&(templateUrl=config.templateUrl),templateUrl||(templateUrl="dialog.html"),$modal.open({templateUrl:templateUrl,controller:controller,size:config.size||"sm",resolve:{model:function(){return config.model},title:function(){return config.title},success:function(){return config.success},fail:function(){return config.fail},body:function(){return config.body}}})}}})}.call(this),function(){angular.module("BB.Services").factory("ErrorService",function(SettingsService){var alerts;return alerts=[{key:"GENERIC",type:"error",title:"",persist:!0,msg:"Sorry, it appears that something went wrong. Please try again or call the business you're booking with if the problem persists."},{key:"LOCATION_NOT_FOUND",type:"warning",title:"",persist:!0,msg:"Sorry, we don't recognise that location"},{key:"MISSING_LOCATION",type:"warning",title:"",persist:!0,msg:"Please enter your location"},{key:"MISSING_POSTCODE",type:"warning",title:"",persist:!0,msg:"Please enter a postcode"},{key:"INVALID_POSTCODE",type:"warning",title:"",persist:!0,msg:"Please enter a valid postcode"},{key:"ITEM_NO_LONGER_AVAILABLE",type:"error",title:"",persist:!0,msg:"Sorry. The item you were trying to book is no longer available. Please try again."},{key:"FORM_INVALID",type:"warning",title:"",persist:!0,msg:"Please complete all required fields"},{key:"GEOLOCATION_ERROR",type:"error",title:"",persist:!0,msg:"Sorry, we could not determine your location. Please try searching instead."},{key:"EMPTY_BASKET_FOR_CHECKOUT",type:"warning",title:"",persist:!0,msg:"You need to add some items to the basket before you can checkout."},{key:"MAXIMUM_TICKETS",type:"warning",title:"",persist:!0,msg:"Sorry, the maximum number of tickets per person has been reached."},{key:"GIFT_CERTIFICATE_REQUIRED",type:"warning",title:"",persist:!0,msg:"A valid Gift Certificate is required to proceed with this booking"},{key:"TIME_SLOT_NOT_SELECTED",type:"warning",title:"",persist:!0,msg:"You need to select a time slot"},{key:"APPT_AT_SAME_TIME",type:"warning",title:"",persist:!0,msg:"Your appointment is already booked for this time"},{key:"REQ_TIME_NOT_AVAIL",type:"warning",title:"",persist:!0,msg:"The requested time slot is not available. Please choose a different time."},{key:"TOPUP_SUCCESS",type:"success",title:"",persist:!0,msg:"Your wallet has been topped up"},{key:"TOPUP_FAILED",type:"warning",title:"",persist:!0,msg:"Sorry, your topup failed. Please try again."},{key:"UPDATE_SUCCESS",type:"success",title:"",persist:!0,msg:"Updated"},{key:"UPDATE_FAILED",type:"warning",title:"",persist:!0,msg:"Update failed. Please try again"},{key:"ALREADY_REGISTERED",type:"warning",title:"",persist:!0,msg:"You have already registered with this email address. Please login or reset your password."},{key:"LOGIN_FAILED",type:"warning",title:"",persist:!0,msg:"Sorry, your email or password was not recognised. Please try again or reset your password."},{key:"PASSWORD_INVALID",type:"warning",title:"",persist:!0,msg:"Sorry, your chosen password is invalid"},{key:"PASSWORD_RESET_REQ_SUCCESS",type:"success",title:"",persist:!0,msg:"We have sent you an email with instructions on how to reset your password."},{key:"PASSWORD_RESET_REQ_FAILED",type:"warning",title:"",persist:!0,msg:"Sorry, we didn't find an account registered with that email."},{key:"PASSWORD_RESET_SUCESS",type:"success",title:"",persist:!0,msg:"Your password has been updated."},{key:"PASSWORD_RESET_FAILED",type:"warning",title:"",persist:!0,msg:"Sorry, we couldn't update your password. Please try again."},{key:"PASSWORD_MISMATCH",type:"warning",title:"",persist:!0,msg:"Your passwords don't match"},{key:"ATTENDEES_CHANGED",type:"info",title:"",persist:!0,msg:"Your booking has been successfully updated"},{key:"PAYMENT_FAILED",type:"danger",title:"",persist:!0,msg:"We were unable to take payment. Please contact your card issuer or try again using a different card"},{key:"ACCOUNT_DISABLED",type:"warning",title:"",persist:!0,msg:"Your account appears to be disabled. Please contact the business you're booking with if the problem persists."},{key:"FB_LOGIN_NOT_A_MEMBER",type:"warning",title:"",persist:!0,msg:"Sorry, we couldn't find a login linked with your Facebook account. You will need to sign up using Facebook first."}],{getError:function(key){var error,translate;return error=_.findWhere(alerts,{key:key}),error.persist=!0,translate=SettingsService.isInternationalizatonEnabled(),error&&translate?{msg:"ERROR."+key}:error&&!translate?error:translate?{msg:"GENERIC"}:alerts[0]},getAlert:function(key){var alert,translate;return alert=_.findWhere(alerts,{key:key}),translate=SettingsService.isInternationalizatonEnabled(),alert&&translate?{msg:"ALERT."+key}:alert&&!translate?alert:null}}})}.call(this),function(){angular.module("BB.Services").factory("EventService",function($q,BBModel){return{query:function(company,params){var deferred;return deferred=$q.defer(),company.$has("events")?(params.item&&(params.item.event_group&&(params.event_group_id=params.item.event_group.id),params.item.event_chain&&(params.event_chain_id=params.item.event_chain.id),params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),company.$get("events",params).then(function(_this){return function(resource){return resource.$get("events",params).then(function(events){var event;return events=function(){var i,len,results;for(results=[],i=0,len=events.length;len>i;i++)event=events[i],results.push(new BBModel.Event(event));return results}(),deferred.resolve(events)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this))):deferred.resolve([]),deferred.promise},summary:function(company,params){var deferred;return deferred=$q.defer(),company.$has("events")?(params.item&&(params.item.event_group&&(params.event_group_id=params.item.event_group.id),params.item.event_chain&&(params.event_chain_id=params.item.event_chain.id),params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),params.summary=!0,company.$get("events",params).then(function(_this){return function(resource){return deferred.resolve(resource.events)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this))):deferred.resolve([]),deferred.promise},queryEventCollection:function(company,params){var deferred;return deferred=$q.defer(),company.$has("events")?(params.item&&(params.item.event_group&&(params.event_group_id=params.item.event_group.id),params.item.event_chain&&(params.event_chain_id=params.item.event_chain.id),params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),company.$get("events",params).then(function(_this){return function(resource){var collection;return collection=new BBModel.BBCollection(resource),deferred.resolve(collection)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this))):deferred.resolve([]),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("EventChainService",function($q,BBModel){return{query:function(company,params){var deferred;return deferred=$q.defer(),company.$has("event_chains")?company.$get("event_chains",params).then(function(_this){return function(resource){return resource.$get("event_chains",params).then(function(event_chains){var event_chain;return event_chains=function(){var i,len,results;for(results=[],i=0,len=event_chains.length;len>i;i++)event_chain=event_chains[i],results.push(new BBModel.EventChain(event_chain));return results}(),deferred.resolve(event_chains)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("company does not have event_chains"),deferred.promise},queryEventChainCollection:function(company,params){var deferred;return deferred=$q.defer(),company.$has("event_chains")?company.$get("event_chains",params).then(function(_this){return function(resource){var collection;return collection=new BBModel.BBCollection(resource),deferred.resolve(collection)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.resolve([]),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("EventGroupService",function($q,BBModel){return{query:function(company,params){var deferred;return deferred=$q.defer(),company.$has("event_groups")?company.$get("event_groups",params).then(function(_this){return function(resource){return resource.$get("event_groups",params).then(function(event_groups){var event_group;return event_groups=function(){var i,len,results;for(results=[],i=0,len=event_groups.length;len>i;i++)event_group=event_groups[i],results.push(new BBModel.EventGroup(event_group));return results}(),deferred.resolve(event_groups)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("company does not have event_groups"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("EventSequenceService",function($q,BBModel){return{query:function(company,params){var deferred;return deferred=$q.defer(),company.$has("event_sequences")?company.$get("event_sequences",params).then(function(_this){return function(resource){return resource.$get("event_sequences",params).then(function(event_sequences){var event_sequence;return event_sequences=function(){var i,len,results;for(results=[],i=0,len=event_sequences.length;len>i;i++)event_sequence=event_sequences[i],results.push(new BBModel.EventSequence(event_sequence));return results}(),deferred.resolve(event_sequences)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("company does not have event_sequences"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("PathSvc",function($sce,AppConfig){return{directivePartial:function(fileName){var partial_url;return AppConfig.partial_url?(partial_url=AppConfig.partial_url,$sce.trustAsResourceUrl(partial_url+"/"+fileName+".html")):$sce.trustAsResourceUrl(fileName+".html")}}})}.call(this),function(){"use strict";angular.module("BB.Services").factory("FormDataStoreService",function($rootScope,$window,$log,$parse){var checkForListeners,checkRegisteredWidgets,clear,dataStore,div,getParentScope,init,log,register,registeredWidgetArr,removeWidget,resetValuesOnScope,setIfUndefined,setListeners,setValuesOnScope,showInfo,storeFormData,toId;return registeredWidgetArr=[],dataStore={},toId=0,div="___",log=function(){},showInfo=function(){return log(dataStore)},setIfUndefined=function(keyName,val){var getter,scope;return scope=this,getter=$parse(keyName),"undefined"==typeof getter(scope)?getter.assign(scope,val):void 0},resetValuesOnScope=function(scope,props){var i,len,prop,setter;for(i=0,len=props.length;len>i;i++)prop=props[i],prop=$parse(prop),(setter=prop.assign)(scope,null)},clear=function(scope,keepScopeValues){var data,key,widgetId;if(!scope)throw new Error("Missing scope object. Cannot clear form data without scope");if(_.isString(scope))return data=dataStore[scope],keepScopeValues||resetValuesOnScope(data[0],data[1]),void delete dataStore[scope];if(scope=getParentScope(scope),scope&&scope.bb){widgetId=scope.bb.uid,removeWidget(scope);for(key in dataStore)data=dataStore[key],-1!==key.indexOf(widgetId)&&(data[3]&&_.each(data[3],function(func){return _.isFunction(func)?func():void 0}),keepScopeValues||resetValuesOnScope(data[0],data[1]),delete dataStore[key])}},storeFormData=function(){var i,key,len,ndata,prop,props,scope,step,val;log("formDataStore ->",dataStore);for(key in dataStore){for(step=dataStore[key],log("	",key),scope=step[0],props=step[1],ndata=step[2],ndata||(ndata=step[2]={}),i=0,len=props.length;len>i;i++)prop=props[i],val=ndata[prop],"data:destroyed"===val?ndata[prop]=null:(val=angular.copy(scope.$eval(prop)),ndata[prop]=val),log("		",prop,val);log("\n")}},setValuesOnScope=function(currentPage,scope){var cpage,storedValues;cpage=dataStore[currentPage],storedValues=cpage[2],log("Decorating scope ->",currentPage,storedValues),_.isObject(storedValues)&&_.each(_.keys(storedValues),function(keyName){var getter;return"undefined"!=typeof storedValues[keyName]&&"data:destroyed"!==storedValues[keyName]?(getter=$parse(keyName),getter.assign(scope,storedValues[keyName])):void 0}),cpage[0]=scope,log(scope),log("\n")},getParentScope=function(scope){for(;scope;){if(scope.hasOwnProperty("cid")&&"BBCtrl"===scope.cid)return scope;scope=scope.$parent}},checkRegisteredWidgets=function(scope){var i,isRegistered,len,rscope;for(isRegistered=!1,scope=getParentScope(scope),i=0,len=registeredWidgetArr.length;len>i;i++)rscope=registeredWidgetArr[i],rscope===scope&&(isRegistered=!0);return isRegistered},checkForListeners=function(propsArr){var watchArr;return watchArr=[],_.each(propsArr,function(propName,index){var split;return split=propName.split("->"),2===split.length?(watchArr.push(split),propsArr[index]=split[0]):void 0}),watchArr},setListeners=function(scope,listenerArr,currentPage){var cpage,listenersArr;return listenerArr.length?(cpage=dataStore[currentPage],listenersArr=cpage[3]||[],_.each(listenerArr,function(item,index){var func;return func=$rootScope.$on(item[1],function(){var e,error;try{return cpage[2][item[0]]="data:destroyed"}catch(error){return e=error,log(e)}}),listenersArr.push(func)}),cpage[3]=listenersArr):void 0},init=function(uid,scope,propsArr){var currentPage,watchArr;if(checkRegisteredWidgets(scope)){if(currentPage=scope.bb.uid+div+scope.bb.current_page+div+uid,currentPage=currentPage.toLowerCase(),watchArr=checkForListeners(propsArr),scope.clearStoredData=function(currentPage){return function(){clear(currentPage)}}(currentPage),!currentPage)throw new Error("Missing current step");if(dataStore[currentPage])return void setValuesOnScope(currentPage,scope);log("Controller registered ->",currentPage,scope,"\n\n"),dataStore[currentPage]=[scope,propsArr],setListeners(scope,watchArr,currentPage)}},removeWidget=function(scope){registeredWidgetArr=_.without(registeredWidgetArr,scope)},register=function(scope){var registered;for(registered=!1,scope&&scope.$$childHead&&(scope=scope.$$childHead);!_.has(scope,"cid");)scope=scope.$parent;if(scope){if("BBCtrl"!==scope.cid)throw new Error("This directive can only be used with the BBCtrl");return _.each(registeredWidgetArr,function(stored){return scope===stored?registered=!0:void 0}),registered?void 0:(log("Scope registered ->",scope),scope.$on("destroy",removeWidget),registeredWidgetArr.push(scope))}},$rootScope.$watch(function(){$window.clearTimeout(toId),toId=setTimeout(storeFormData,300)}),$rootScope.$on("save:formData",storeFormData),$rootScope.$on("clear:formData",clear),{init:init,destroy:function(scope){return clear(scope,!0)},showInfo:showInfo,register:register,setIfUndefined:setIfUndefined}})}.call(this),function(){angular.module("BB.Services").factory("GeolocationService",function($q){return{haversine:function(position1,position2){var R,a,c,chLat,chLon,d,dLat,dLon,distance,distances,lat1,lat2,lon1,lon2,pi,rLat1,rLat2;return pi=Math.PI,R=6371,distances=[],lat1=position1.lat,lon1=position1["long"],lat2=position2.lat,lon2=position2["long"],chLat=lat2-lat1,chLon=lon2-lon1,dLat=chLat*(pi/180),dLon=chLon*(pi/180),rLat1=lat1*(pi/180),rLat2=lat2*(pi/180),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(rLat1)*Math.cos(rLat2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c,d=.621371192*d,distance=Math.round(d)},geocode:function(address,prms){var deferred,ne,request,sw;return null==prms&&(prms={}),deferred=$q.defer(),request={address:address},prms.region&&(request.region=prms.region),prms.componentRestrictions&&(request.componentRestrictions=prms.componentRestrictions),prms.bounds&&(sw=new google.maps.LatLng(prms.bounds.sw.x,prms.bounds.sw.y),ne=new google.maps.LatLng(prms.bounds.ne.x,prms.bounds.ne.y),request.bounds=new google.maps.LatLngBounds(sw,ne)),(new google.maps.Geocoder).geocode(request,function(results,status){return results&&"OK"===status?deferred.resolve({results:results,status:status}):deferred.reject(status)}),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ItemService",function($q,BBModel){return{query:function(prms){var deferred;return deferred=$q.defer(),prms.cItem.service&&"service"!==prms.item?prms.cItem.service.$has("items")?this.build_items(prms.cItem.service.$get("items"),prms,deferred):prms.cItem.service.$get("item").then(function(_this){return function(base_item){return _this.build_items(base_item.$get("items"),prms,deferred)}}(this)):prms.cItem.resource&&!prms.cItem.anyResource()&&"resource"!==prms.item?prms.cItem.resource.$has("items")?this.build_items(prms.cItem.resource.$get("items"),prms,deferred):prms.cItem.resource.$get("item").then(function(_this){return function(base_item){return _this.build_items(base_item.$get("items"),prms,deferred)}}(this)):prms.cItem.person&&!prms.cItem.anyPerson()&&"person"!==prms.item?prms.cItem.person.$has("items")?this.build_items(prms.cItem.person.$get("items"),prms,deferred):prms.cItem.person.$get("item").then(function(_this){return function(base_item){return _this.build_items(base_item.$get("items"),prms,deferred)}}(this)):deferred.reject("No service link found"),deferred.promise},build_items:function(base_items,prms,deferred){var wait_items;return wait_items=[base_items],prms.wait&&wait_items.push(prms.wait),$q.all(wait_items).then(function(_this){return function(resources){var resource;return resource=resources[0],resource.$get("items").then(function(found){var i,len,m,matching,v,wlist;for(matching=[],wlist=[],i=0,len=found.length;len>i;i++)v=found[i],v.type===prms.item&&matching.push(new BBModel.BookableItem(v));return $q.all(function(){var j,len1,results;for(results=[],j=0,len1=matching.length;len1>j;j++)m=matching[j],results.push(m.ready.promise);return results}()).then(function(){return deferred.resolve(matching)})})}}(this))}}})}.call(this),function(){angular.module("BB.Services").factory("ItemDetailsService",function($q,BBModel){return{query:function(prms){var deferred;return deferred=$q.defer(),prms.cItem.service?prms.cItem.service.$has("questions")?prms.cItem.service.$get("questions").then(function(_this){return function(details){return deferred.resolve(new BBModel.ItemDetails(details))}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.resolve(new BBModel.ItemDetails):prms.cItem.event_chain?prms.cItem.event_chain.$has("questions")?prms.cItem.event_chain.$get("questions").then(function(_this){return function(details){return deferred.resolve(new BBModel.ItemDetails(details))}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.resolve(new BBModel.ItemDetails):prms.cItem.deal?prms.cItem.deal.$has("questions")?prms.cItem.deal.$get("questions").then(function(_this){return function(details){return deferred.resolve(new BBModel.ItemDetails(details))}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.resolve(new BBModel.ItemDetails):deferred.resolve(),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("LoadingService",function($q,$window,$log,$rootScope,AlertService){return{$loader:function(scope){var item,lservice;return lservice=this,item={scope:scope,setLoaded:function(){return lservice.setLoaded(scope)},setLoadedAndShowError:function(err,error_string){return lservice.setLoadedAndShowError(scope,err,error_string)},notLoaded:function(){return lservice.notLoaded(scope),this}}},setLoaded:function(cscope){var loadingFinished;for(cscope.$emit("hide:loader",cscope),cscope.isLoaded=!0,loadingFinished=!0;cscope;)cscope.hasOwnProperty("scopeLoaded")&&(this.areScopesLoaded(cscope)?cscope.scopeLoaded=!0:loadingFinished=!1),cscope=cscope.$parent;loadingFinished&&$rootScope.$broadcast("loading:finished")},setLoadedAndShowError:function(scope,err,error_string){return $log.warn(err,error_string),scope.setLoaded(scope),err&&409===err.status?AlertService.danger(ErrorService.getError("ITEM_NO_LONGER_AVAILABLE")):err.data&&"Number of Bookings exceeds the maximum"===err.data.error?AlertService.danger(ErrorService.getError("MAXIMUM_TICKETS")):AlertService.danger(ErrorService.getError("GENERIC"))},areScopesLoaded:function(cscope){var child;if(cscope.hasOwnProperty("isLoaded")&&!cscope.isLoaded)return!1;for(child=cscope.$$childHead;child;){if(!this.areScopesLoaded(child))return!1;child=child.$$nextSibling}return!0},notLoaded:function(cscope){for(cscope.$emit("show:loader",cscope),cscope.isLoaded=!1;cscope;)cscope.hasOwnProperty("scopeLoaded")&&(cscope.scopeLoaded=!1),cscope=cscope.$parent}}})}.call(this),function(){angular.module("BB.Services").factory("LocaleService",function($window){var locale;return locale=$window.getURIparam("locale"),locale?locale:$window.navigator.language?$window.navigator.language:"en"})}.call(this),function(){angular.module("BB.Services").factory("LoginService",function($q,halClient,$rootScope,BBModel,$sessionStorage,$localStorage){return{companyLogin:function(company,params,form){var deferred;return deferred=$q.defer(),company.$post("login",params,form).then(function(_this){return function(login){return login.$get("member").then(function(member){return _this.setLogin(member),deferred.resolve(member)},function(err){return deferred.reject(err)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},login:function(form,options){var deferred,url;return deferred=$q.defer(),options.root||(options.root=""),url=options.root+"/api/v1/login",halClient.$post(url,options,form).then(function(_this){return function(login){var params;return params={auth_token:login.auth_token},login.$get("member").then(function(member){return _this.setLogin(member),deferred.resolve(member)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},FBLogin:function(company,prms){var deferred;return deferred=$q.defer(),company.$post("facebook_login",{},prms).then(function(_this){return function(login){
return login.$get("member").then(function(member){return member=new BBModel.Member.Member(member),$sessionStorage.setItem("fb_user",!0),_this.setLogin(member),deferred.resolve(member)},function(err){return deferred.reject(err)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},companyQuery:function(_this){return function(id){var comp_promise;return id?(comp_promise=halClient.$get(location.protocol+"//"+location.host+"/api/v1/company/"+id),comp_promise.then(function(company){return company=new BBModel.Company(company)})):void 0}}(this),memberQuery:function(_this){return function(params){var member_promise;return params.member_id&&params.company_id?(member_promise=halClient.$get(location.protocol+"//"+location.host+("/api/v1/"+params.company_id+"/")+"members/"+params.member_id),member_promise.then(function(member){return member=new BBModel.Member.Member(member)})):void 0}}(this),ssoLogin:function(options,data){var deferred,url;return deferred=$q.defer(),options.root||(options.root=""),url=options.root+"/api/v1/login/sso/"+options.company_id,halClient.$post(url,{},data).then(function(_this){return function(login){var params;return params={auth_token:login.auth_token},login.$get("member").then(function(member){return member=new BBModel.Member.Member(member),_this.setLogin(member),deferred.resolve(member)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},isLoggedIn:function(){return this.checkLogin(),$rootScope.member&&(!$rootScope.user||void 0===$rootScope.user)},setLogin:function(member,persist){var auth_token;return auth_token=member.getOption("auth_token"),member=new BBModel.Member.Member(member),$sessionStorage.setItem("login",member.$toStore()),$sessionStorage.setItem("auth_token",auth_token),$rootScope.member=member,persist&&$localStorage.setItem("auth_token",auth_token),member},member:function(){return this.checkLogin(),$rootScope.member},checkLogin:function(){var member;return $rootScope.member?!0:(member=$sessionStorage.getItem("login"),member?(member=halClient.createResource(member),$rootScope.member=new BBModel.Member.Member(member),!0):!1)},logout:function(options){var deferred,url;return $rootScope.member=null,deferred=$q.defer(),options||(options={}),options.root||(options.root=""),url=options.root+"/api/v1/logout",$sessionStorage.clear(),$localStorage.clear(),halClient.$del(url,options,{}).then(function(_this){return function(logout){return $sessionStorage.clear(),$localStorage.clear(),deferred.resolve(!0)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},FBLogout:function(options){return $sessionStorage.removeItem("fb_user"),this.logout(options)},sendPasswordReset:function(company,params){var deferred;return deferred=$q.defer(),company.$post("email_password_reset",{},params).then(function(_this){return function(){return deferred.resolve(!0)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},updatePassword:function(member,params){var deferred;return params.auth_token=member.getOption("auth_token"),member&&params.new_password&&params.confirm_new_password?(deferred=$q.defer(),member.$post("update_password",{},params).then(function(_this){return function(login){return login.$get("member").then(function(member){return _this.setLogin(member,params.persist_login),deferred.resolve(member)},function(err){return deferred.reject(err)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise):void 0}}})}.call(this),function(){angular.module("BB.Services").factory("MembershipLevelsService",function($q,BBModel){return{getMembershipLevels:function(company){var deferred;return deferred=$q.defer(),company.$get("member_levels").then(function(resource){return resource.$get("membership_levels").then(function(_this){return function(membership_levels){var level,levels;return levels=function(){var i,len,results;for(results=[],i=0,len=membership_levels.length;len>i;i++)level=membership_levels[i],results.push(new BBModel.MembershipLevel(level));return results}(),deferred.resolve(levels)}}(this))},function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ModalForm",function($modal,$log,Dialog){var editForm,newForm;return newForm=function($scope,$modalInstance,company,title,new_rel,post_rel,success,fail){return $scope.loading=!0,$scope.title=title,$scope.company=company,$scope.company.$has(new_rel)?$scope.company.$get(new_rel).then(function(schema){return $scope.form=_.reject(schema.form,function(x){return"submit"===x.type}),$scope.schema=schema.schema,$scope.form_model={},$scope.loading=!1}):$log.warn("company does not have '"+new_rel+"' rel"),$scope.submit=function(form){return $scope.$broadcast("schemaFormValidate"),$scope.loading=!0,$scope.company.$post(post_rel,{},$scope.form_model).then(function(model){return $scope.loading=!1,$modalInstance.close(model),success?success(model):void 0},function(err){return $scope.loading=!1,$modalInstance.close(err),$log.error("Failed to create"),fail?fail(err):void 0})},$scope.cancel=function(event){return event.preventDefault(),event.stopPropagation(),$modalInstance.dismiss("cancel")}},editForm=function($scope,$modalInstance,model,title,success,fail){return $scope.loading=!0,$scope.title=title,$scope.model=model,$scope.model.$has("edit")?$scope.model.$get("edit").then(function(schema){return $scope.form=_.reject(schema.form,function(x){return"submit"===x.type}),$scope.schema=schema.schema,$scope.form_model=$scope.model,$scope.loading=!1}):$log.warn("model does not have 'edit' rel"),$scope.submit=function(form){return $scope.$broadcast("schemaFormValidate"),$scope.loading=!0,$scope.model.$update?$scope.model.$update($scope.form_model).then(function(){return $scope.loading=!1,$modalInstance.close($scope.model),success?success($scope.model):void 0},function(err){return $scope.loading=!1,$modalInstance.close(err),$log.error("Failed to create"),fail?fail():void 0}):$scope.model.$put("self",{},$scope.form_model).then(function(model){return $scope.loading=!1,$modalInstance.close(model),success?success(model):void 0},function(err){return $scope.loading=!1,$modalInstance.close(err),$log.error("Failed to create"),fail?fail():void 0})},$scope.cancel=function(event){return event.preventDefault(),event.stopPropagation(),$modalInstance.dismiss("cancel")},$scope.cancelBooking=function(event){return event.preventDefault(),event.stopPropagation(),$modalInstance.close(),Dialog.confirm({model:model,body:"Are you sure you want to cancel this booking?",success:function(model){return model.$del("self").then(function(response){return success?success(response):void 0})}})}},{"new":function(config){var templateUrl;return config.templateUrl&&(templateUrl=config.templateUrl),templateUrl||(templateUrl="modal_form.html"),$modal.open({templateUrl:templateUrl,controller:newForm,size:config.size,resolve:{company:function(){return config.company},title:function(){return config.title},new_rel:function(){return config.new_rel},post_rel:function(){return config.post_rel},success:function(){return config.success},fail:function(){return config.fail}}})},edit:function(config){var templateUrl;return config.templateUrl&&(templateUrl=config.templateUrl),templateUrl||(templateUrl="modal_form.html"),$modal.open({templateUrl:templateUrl,controller:editForm,size:config.size,resolve:{model:function(){return config.model},title:function(){return config.title},success:function(){return config.success},fail:function(){return config.fail}}})}}})}.call(this),function(){angular.module("BB.Services").factory("MutexService",function($q,$window,$rootScope){return{getLock:function(prms){var iprom,mprom;return mprom=$q.defer(),iprom=$q.defer(),mprom.promise.then(function(){var next_mux;return $rootScope.mutexes.shift(),$rootScope.mutexes.length>0?(next_mux=$rootScope.mutexes[0],next_mux.iprom.resolve(next_mux.mprom)):void 0}),$rootScope.mutexes&&0!==$rootScope.mutexes.length?($rootScope.mutexes.push({mprom:mprom,iprom:iprom}),iprom.promise):($rootScope.mutexes=[{mprom:mprom,iprom:iprom}],iprom.resolve(mprom),iprom.promise)},unlock:function(mutex){return mutex.resolve()}}})}.call(this),function(){angular.module("BB.Services").factory("PackageItemService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("packages")?company.$get("packages").then(function(resource){return resource.$get("packages").then(function(package_items){var i;return deferred.resolve(function(){var j,len,results;for(results=[],j=0,len=package_items.length;len>j;j++)i=package_items[j],results.push(new BBModel.PackageItem(i));return results}())})},function(err){return deferred.reject(err)}):deferred.reject("No packages found"),deferred.promise},getPackageServices:function(package_item){var deferred;return deferred=$q.defer(),package_item.$has("services")?package_item.$get("services").then(function(services){var s;return deferred.resolve(function(){var j,len,results;for(results=[],j=0,len=services.length;len>j;j++)s=services[j],results.push(new BBModel.Service(s));return results}())},function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No services found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("PaginationService",function(){return{initialise:function(options){var paginator;if(options)return paginator={current_page:1,page_size:options.page_size,num_pages:null,max_size:options.max_size,num_items:null}},update:function(paginator,length){var end,start,total;if(paginator&&length)return paginator.num_items=length,start=(paginator.page_size-1)*paginator.current_page-(paginator.page_size-1-paginator.current_page),end=paginator.current_page*paginator.page_size,total=end<paginator.page_size?end:length,end=end>total?total:end,total=total>=100?"100+":total,paginator.summary=start+" - "+end+" of "+total}}})}.call(this),function(){angular.module("BB.Services").factory("PersonService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("people")?company.$get("people").then(function(_this){return function(resource){return resource.$get("people").then(function(items){var i,j,len,people;for(people=[],j=0,len=items.length;len>j;j++)i=items[j],people.push(new BBModel.Person(i));return deferred.resolve(people)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No people found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ProductService",function($q,$window,halClient,UriTemplate,BBModel,$log,$rootScope){return{getProduct:function(prms){var deferred,href,uri;return deferred=$q.defer(),prms.id?(href=$rootScope.bb.api_url+"/api/v1/{company_id}/products/{id}",uri=new UriTemplate(href).fillFromObject({company_id:prms.company_id,id:prms.product_id})):prms.sku?(href=$rootScope.bb.api_url+"/api/v1/{company_id}/products/find_by_sku/{sku}",uri=new UriTemplate(href).fillFromObject({company_id:prms.company_id,sku:prms.sku})):($log.warn("id or sku is required"),deferred.reject()),halClient.$get(uri,{}).then(function(product){return deferred.resolve(new BBModel.Product(product))},function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},query:function(company){var deferred;return deferred=$q.defer(),company.$has("products")?company.$get("products").then(function(_this){return function(resource){return resource.$get("products").then(function(items){var i,j,len,resources;for(resources=[],j=0,len=items.length;len>j;j++)i=items[j],resources.push(new BBModel.Product(i));return deferred.resolve(resources)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No products found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("PurchaseTotalService",function($q,BBModel){return{query:function(prms){var deferred;return deferred=$q.defer(),prms.company.$has("total")?prms.company.$get("total",{total_id:prms.total_id}).then(function(_this){return function(total){return deferred.resolve(new BBModel.PurchaseTotal(total))}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No Total link found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("QueryStringService",function($window){return function(keyName){var hash,hashes,href,i,isNum,len,val,varObj;if(varObj={},href=$window.location.href,!(href.indexOf("?")<0)){for(hashes=href.slice(href.indexOf("?")+1).split(/[#&]/),isNum=function(num){return null==num||"0"===num.substr(0,1)||/[a-zA-Z\-\_\+\.\#\%\*\,]/.test(num)||window.isNaN(window.parseInt(num,10))?void 0:!0},i=0,len=hashes.length;len>i;i++)hash=hashes[i],hash=hash.split("="),val=hash[1],val=isNum(val)?window.parseInt(val,10):"true"===val?!0:"false"===val?!1:window.decodeURIComponent(val),varObj[hash[0]]=val;return keyName?varObj[keyName]:varObj}}})}.call(this),function(){"use strict";angular.module("BB.Services").factory("QuestionService",function($window,QueryStringService,$bbug){var addAnswersById,addAnswersByName,addAnswersFromDefaults,addDynamicAnswersByName,checkConditionalQuestions,convertDates,convertToSnakeCase,defaults,findByQuestionId,storeDefaults;return defaults=QueryStringService()||{},convertDates=function(obj){return _.each(obj,function(val,key){var date;return date=$window.moment(obj[key]),_.isString(obj[key])&&date.isValid()?obj[key]=date:void 0})},$window.bb_setup&&(convertDates($window.bb_setup),angular.extend(defaults,$window.bb_setup)),addAnswersById=function(questions){return questions?angular.isArray(questions)?_.each(questions,function(question){var id;return id=question.id+"",!question.answer&&defaults[id]?question.answer=defaults[id]:void 0}):defaults[questions.id+""]?questions.answer=defaults[questions.id+""]:void 0:void 0},convertToSnakeCase=function(str){return str=str.toLowerCase(),str=$.trim(str),str=str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,""),str=str.replace(/\s{2,}/g," "),str=str.replace(/\s/g,"_")},addDynamicAnswersByName=function(questions){var keys;return angular.isArray(questions)?(keys=_.keys(defaults),_.each(questions,function(question){var name;return name=convertToSnakeCase(question.name),_.each(keys,function(key){(name.indexOf("_"+key)>=0||name.indexOf("_"+key+"_")>=0||name.indexOf(key+"_")>=0)&&defaults[key]&&!question.answer&&(question.answer=defaults[key],delete defaults[key])})})):void 0},addAnswersByName=function(obj,keys){var i,key,len,type;if(type=Object.prototype.toString.call(obj).slice(8,-1),"Object"===type&&angular.isArray(keys))for(i=0,len=keys.length;len>i;i++)key=keys[i],defaults[key]&&!obj[key]&&(obj[key]=defaults[key],delete defaults[key])},addAnswersFromDefaults=function(questions,answers){var i,len,name,question,results;for(results=[],i=0,len=questions.length;len>i;i++)question=questions[i],name=question.help_text,answers[name]&&(question.answer=answers[name]),answers[question.id+""]?results.push(question.answer=answers[question.id+""]):results.push(void 0);return results},storeDefaults=function(obj){return angular.extend(defaults,obj.bb_setup||{})},checkConditionalQuestions=function(questions){var a,ans,cond,found,i,len,q,ref,results,v;for(results=[],i=0,len=questions.length;len>i;i++)if(q=questions[i],q.settings&&q.settings.conditional_question)if(cond=findByQuestionId(questions,parseInt(q.settings.conditional_question))){ans=cond.getAnswerId(),found=!1,$bbug.isEmptyObject(q.settings.conditional_answers)&&"check"===cond.detail_type&&!cond.answer&&(found=!0),ref=q.settings.conditional_answers;for(a in ref)v=ref[a],"c"===a[0]&&1===parseInt(v)&&cond.answer?found=!0:parseInt(a)===ans&&1===parseInt(v)&&(found=!0);found?results.push(q.showElement()):results.push(q.hideElement())}else results.push(void 0);else results.push(void 0);return results},findByQuestionId=function(questions,qid){var i,len,q;for(i=0,len=questions.length;len>i;i++)if(q=questions[i],q.id===qid)return q;return null},{getStoredData:function(){return defaults},storeDefaults:storeDefaults,addAnswersById:addAnswersById,addAnswersByName:addAnswersByName,addDynamicAnswersByName:addDynamicAnswersByName,addAnswersFromDefaults:addAnswersFromDefaults,convertToSnakeCase:convertToSnakeCase,checkConditionalQuestions:checkConditionalQuestions}})}.call(this),function(){angular.module("BB.Services").factory("RecaptchaService",function($q,halClient,UriTemplate){return{validateResponse:function(params){var deferred,href,prms,uri;return deferred=$q.defer(),href=params.api_url+"/api/v1/recaptcha",uri=new UriTemplate(href),prms={},prms.response=params.response,halClient.$post(uri,{},prms).then(function(response){return deferred.resolve(response)},function(err){return deferred.reject(err)}),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ResourceService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("resources")?company.$get("resources").then(function(_this){return function(resource){return resource.$get("resources").then(function(items){var i,j,len,resources;for(resources=[],j=0,len=items.length;len>j;j++)i=items[j],resources.push(new BBModel.Resource(i));return deferred.resolve(resources)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No resource found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ServiceService",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("services")?company.$get("services").then(function(_this){return function(resource){return resource.$get("services").then(function(items){var i,j,len,services;for(services=[],j=0,len=items.length;len>j;j++)i=items[j],services.push(new BBModel.Service(i));return deferred.resolve(services)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No services found"),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("SettingsService",function(){var country_code,i18n,scroll_offset;return i18n=!1,scroll_offset=0,country_code="",{enableInternationalizaton:function(){return i18n=!0},isInternationalizatonEnabled:function(){return i18n},setScrollOffset:function(value){return scroll_offset=parseInt(value)},getScrollOffset:function(){return scroll_offset},setCountryCode:function(value){return country_code=value},getCountryCode:function(){return country_code}}})}.call(this),function(){angular.module("BB.Services").factory("SlotService",function($q,BBModel){return{query:function(company,params){var deferred;return deferred=$q.defer(),company.$has("slots")?(params.item&&(params.item.resource&&(params.resource_id=params.item.resource.id),params.item.person&&(params.person_id=params.item.person.id)),company.$get("slots",params).then(function(_this){return function(resource){return resource.$get("slots",params).then(function(slots){var slot;return slots=function(){var i,len,results;for(results=[],i=0,len=slots.length;len>i;i++)slot=slots[i],results.push(new BBModel.Slot(slot));return results}(),deferred.resolve(slots)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this))):deferred.resolve([]),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").config(function($provide){return $provide.decorator("$sniffer",function($delegate){var regexp,result,webkit_version;return regexp=/Safari\/([\d.]+)/,result=regexp.exec(navigator.userAgent),webkit_version=result?parseFloat(result[1]):null,_.extend($delegate,{webkit:webkit_version}),$delegate})})}.call(this),function(){angular.module("BB.Services").factory("SpaceService",["$q",function($q,BBModel){return{query:function(company){var deferred;return deferred=$q.defer(),company.$has("spaces")?company.$get("spaces").then(function(_this){return function(resource){return resource.$get("spaces").then(function(items){var i,j,len,spaces;for(spaces=[],j=0,len=items.length;len>j;j++)i=items[j],spaces.push(new BBModel.Space(i));return deferred.resolve(spaces)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("No spaces found"),deferred.promise}}}])}.call(this),function(){angular.module("BB.Services").factory("SSOService",function($q,$rootScope,halClient,LoginService){return{memberLogin:function(options){var data,deferred,url;return deferred=$q.defer(),options.root||(options.root=""),url=options.root+"/api/v1/login/sso/"+options.company_id,data={token:options.member_sso},halClient.$post(url,{},data).then(function(_this){return function(login){var params;return params={auth_token:login.auth_token},login.$get("member").then(function(member){return member=LoginService.setLogin(member),deferred.resolve(member)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},adminLogin:function(options){var data,deferred,url;return deferred=$q.defer(),options.root||(options.root=""),url=options.root+"/api/v1/login/admin_sso/"+options.company_id,data={token:options.admin_sso},halClient.$post(url,{},data).then(function(_this){return function(login){var params;return params={auth_token:login.auth_token},login.$get("administrator").then(function(admin){return deferred.resolve(admin)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("TemplateSvc",function($q,$http,$templateCache,BBModel){return{get:function(path){var cacheTmpl,deferred;return deferred=$q.defer(),cacheTmpl=$templateCache.get(path),cacheTmpl?deferred.resolve(angular.element(cacheTmpl)):$http({method:"GET",url:path}).success(function(tmpl,status){return $templateCache.put(path,tmpl),deferred.resolve(angular.element(tmpl))}).error(function(data,status){return deferred.reject(data)}),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("TimeService",function($q,BBModel,halClient){return{query:function(prms){var date,deferred,extra,item_link;if(deferred=$q.defer(),prms.date)date=prms.date.toISODate();else{if(!prms.cItem.date)return deferred.reject("No date set"),deferred.promise;date=prms.cItem.date.date.toISODate()}return null==prms.duration&&prms.cItem&&prms.cItem.duration&&(prms.duration=prms.cItem.duration),item_link=prms.item_link,prms.cItem&&prms.cItem.days_link&&!item_link&&(item_link=prms.cItem.days_link),item_link?(extra={date:date},prms.location&&(extra.location=prms.location),prms.cItem.event_id&&(extra.event_id=prms.cItem.event_id),!prms.cItem.person||prms.cItem.anyPerson()||item_link.event_id||extra.event_id||(extra.person_id=prms.cItem.person.id),!prms.cItem.resource||prms.cItem.anyResource()||item_link.event_id||extra.event_id||(extra.resource_id=prms.cItem.resource.id),prms.end_date&&(extra.end_date=prms.end_date.toISODate()),extra.duration=prms.duration,extra.resource_ids=prms.resource_ids,extra.num_resources=prms.num_resources,extra.event_id&&(item_link=prms.company),item_link.$get("times",extra).then(function(_this){return function(results){var times;return results.$has("date_links")?results.$get("date_links").then(function(all_days){var all_days_def,date_times,day,fn,j,len;for(date_times={},all_days_def=[],fn=function(day){var times;return day.elink=$q.defer(),all_days_def.push(day.elink.promise),day.$has("event_links")?day.$get("event_links").then(function(all_events){var times;return times=_this.merge_times(all_events,prms.cItem.service,prms.cItem),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),date_times[day.date]=times,day.elink.resolve()}):day.times?(times=_this.merge_times([day],prms.cItem.service,prms.cItem),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),date_times[day.date]=times,day.elink.resolve()):void 0},j=0,len=all_days.length;len>j;j++)day=all_days[j],fn(day);return $q.all(all_days_def).then(function(){return deferred.resolve(date_times)})}):results.$has("event_links")?results.$get("event_links").then(function(all_events){var times;return times=_this.merge_times(all_events,prms.cItem.service,prms.cItem),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),deferred.resolve(times)}):results.times?(times=_this.merge_times([results],prms.cItem.service,prms.cItem),prms.available&&(times=_.filter(times,function(t){return t.avail>=prms.available})),deferred.resolve(times)):void 0}}(this),function(err){return deferred.reject(err)})):deferred.reject("No day data"),deferred.promise},merge_times:function(all_events,service,item){var date_times,ev,i,j,k,l,len,len1,len2,ref,sorted_times,times;if(!all_events||0===all_events.length)return[];for(all_events=_.shuffle(all_events),sorted_times=[],j=0,len=all_events.length;len>j;j++)if(ev=all_events[j],ev.times){for(ref=ev.times,k=0,len1=ref.length;len1>k;k++)i=ref[k],(!sorted_times[i.time]||0===sorted_times[i.time].avail||0===Math.floor(Math.random()*all_events.length)&&i.avail>0)&&(i.event_id=ev.event_id,sorted_times[i.time]=i);item.held&&this.checkCurrentItem(item.held,sorted_times,ev),this.checkCurrentItem(item,sorted_times,ev)}for(times=[],date_times={},l=0,len2=sorted_times.length;len2>l;l++)i=sorted_times[l],i&&times.push(new BBModel.TimeSlot(i,service));return times},checkCurrentItem:function(item,sorted_times,ev){return item&&item.id&&item.event_id===ev.event_id&&item.time&&!sorted_times[item.time.time]&&item.date&&item.date.date.toISODate()===ev.date?(sorted_times[item.time.time]=item.time,halClient.clearCache(ev.$href("self"))):item&&item.id&&item.event_id===ev.event_id&&item.time&&sorted_times[item.time.time]&&item.date&&item.date.date.toISODate()===ev.date?sorted_times[item.time.time].avail=1:void 0}}})}.call(this),function(){angular.module("BB.Services").factory("TimeSlotService",function($q,BBModel){return{query:function(params){var company,defer;return defer=$q.defer(),company=params.company,company.$get("slots",params).then(function(collection){return collection.$get("slots").then(function(slots){var s;return slots=function(){var i,len,results;for(results=[],i=0,len=slots.length;len>i;i++)s=slots[i],results.push(new BBModel.TimeSlot(s));return results}(),defer.resolve(slots)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise}}})}.call(this),function(){angular.module("BB.Services").factory("BB.Service.address",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Address(resource)}}}),angular.module("BB.Services").factory("BB.Service.person",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Person(resource)}}}),angular.module("BB.Services").factory("BB.Service.people",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("people").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Person(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.resource",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Resource(resource)}}}),angular.module("BB.Services").factory("BB.Service.resources",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("resources").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Resource(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.service",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Service(resource)}}}),angular.module("BB.Services").factory("BB.Service.services",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred,models,service;return deferred=$q.defer(),angular.isArray(resource)?(models=function(){var j,len,results;for(results=[],j=0,len=resource.length;len>j;j++)service=resource[j],results.push(new BBModel.Service(service));return results}(),deferred.resolve(models)):resource.$get("services").then(function(_this){return function(items){var i,j,len;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Service(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.package_item",function($q,BBModel){return{unwrap:function(resource){return new BBModel.PackageItem(resource)}}}),angular.module("BB.Services").factory("BB.Service.package_items",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("package_items").then(function(_this){return function(package_items){var i,j,len,models;for(models=[],j=0,len=package_items.length;len>j;j++)i=package_items[j],models.push(new BBModel.PackageItem(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.bulk_purchase",function($q,BBModel){return{unwrap:function(resource){return new BBModel.BulkPurchase(resource)}}}),angular.module("BB.Services").factory("BB.Service.bulk_purchases",function($q,BBModel){return{promise:!0,unwrap:function(resource){var bulk_purchase,deferred,models;return deferred=$q.defer(),angular.isArray(resource)?(models=function(){var j,len,results;for(results=[],j=0,len=resource.length;len>j;j++)bulk_purchase=resource[j],results.push(new BBModel.BulkPurchase(bulk_purchase));return results}(),deferred.resolve(models)):resource.$get("bulk_purchases").then(function(_this){return function(bulk_purchases){var i,j,len;for(models=[],j=0,len=bulk_purchases.length;len>j;j++)i=bulk_purchases[j],models.push(new BBModel.BulkPurchase(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.event_group",function($q,BBModel){return{unwrap:function(resource){return new BBModel.EventGroup(resource)}}}),angular.module("BB.Services").factory("BB.Service.event_groups",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("event_groups").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.EventGroup(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.event_chain",function($q,BBModel){return{unwrap:function(resource){return new BBModel.EventChain(resource)}}}),angular.module("BB.Services").factory("BB.Service.event_chains",function($q,BBModel){return{unwrap:function(resource){return new BBModel.EventChain(resource)}}}),angular.module("BB.Services").factory("BB.Service.category",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Category(resource)}}}),angular.module("BB.Services").factory("BB.Service.categories",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("categories").then(function(_this){return function(items){
var cat,i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],cat=new BBModel.Category(i),cat.order||(cat.order=_i),models.push(cat);return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.client",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Client(resource)}}}),angular.module("BB.Services").factory("BB.Service.child_clients",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("clients").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Client(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.clients",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("clients").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Client(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.questions",function($q,BBModel){return{unwrap:function(resource){var defer,i,j,k,len,len1,ref,results,results1;if(resource.questions){for(ref=resource.questions,results=[],j=0,len=ref.length;len>j;j++)i=ref[j],results.push(new BBModel.Question(i));return results}if(resource.$has("questions"))return defer=$q.defer(),resource.$get("questions").then(function(items){return defer.resolve(function(){var k,len1,results1;for(results1=[],k=0,len1=items.length;len1>k;k++)i=items[k],results1.push(new BBModel.Question(i));return results1}())},function(err){return defer.reject(err)}),defer.promise;for(results1=[],k=0,len1=resource.length;len1>k;k++)i=resource[k],results1.push(new BBModel.Question(i));return results1}}}),angular.module("BB.Services").factory("BB.Service.question",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Question(resource)}}}),angular.module("BB.Services").factory("BB.Service.answers",function($q,BBModel){return{promise:!1,unwrap:function(items){var answers,i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Answer(i));return answers={answers:models,getAnswer:function(question){var a,k,len1,ref;for(ref=this.answers,k=0,len1=ref.length;len1>k;k++)if(a=ref[k],a.question_text===question||a.question_id===question)return a.value}}}}}),angular.module("BB.Services").factory("BB.Service.administrators",function($q,BBModel){return{unwrap:function(items){var i,j,len,results;for(results=[],j=0,len=items.length;len>j;j++)i=items[j],results.push(new BBModel.Admin.User(i));return results}}}),angular.module("BB.Services").factory("BB.Service.company",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Company(resource)}}}),angular.module("BB.Services").factory("BB.Service.parent",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Company(resource)}}}),angular.module("BB.Services").factory("BB.Service.company_questions",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("company_questions").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.BusinessQuestion(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.company_question",function($q,BBModel){return{unwrap:function(resource){return new BBModel.BusinessQuestion(resource)}}}),angular.module("BB.Services").factory("BB.Service.images",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("images").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Image(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.bookings",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("bookings").then(function(_this){return function(items){var i,j,len,models;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.Member.Booking(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.wallet",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Member.Wallet(resource)}}}),angular.module("BB.Services").factory("BB.Service.product",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Product(resource)}}}),angular.module("BB.Services").factory("BB.Service.products",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred;return deferred=$q.defer(),resource.$get("products").then(function(_this){return function(items){var cat,i,index,j,len,models;for(models=[],index=j=0,len=items.length;len>j;index=++j)i=items[index],cat=new BBModel.Product(i),cat.order||(cat.order=index),models.push(cat);return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.pre_paid_booking",function($q,BBModel){return{unwrap:function(resource){return new BBModel.PrePaidBooking(resource)}}}),angular.module("BB.Services").factory("BB.Service.pre_paid_bookings",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred,models,pre_paid_booking;return deferred=$q.defer(),angular.isArray(resource)?(models=function(){var j,len,results;for(results=[],j=0,len=resource.length;len>j;j++)pre_paid_booking=resource[j],results.push(new BBModel.PrePaidBooking(pre_paid_booking));return results}(),deferred.resolve(models)):resource.$get("pre_paid_bookings").then(function(_this){return function(items){var i,j,len;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.PrePaidBooking(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.external_purchase",function($q,BBModel){return{unwrap:function(resource){return new BBModel.ExternalPurchase(resource)}}}),angular.module("BB.Services").factory("BB.Service.external_purchases",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred,external_purchase,models;return deferred=$q.defer(),angular.isArray(resource)?(models=function(){var j,len,results;for(results=[],j=0,len=resource.length;len>j;j++)external_purchase=resource[j],results.push(new BBModel.ExternalPurchase(external_purchase));return results}(),deferred.resolve(models)):resource.$get("external_purchases").then(function(_this){return function(items){var i,j,len;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.ExternalPurchase(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}}),angular.module("BB.Services").factory("BB.Service.purchase_item",function($q,BBModel){return{unwrap:function(resource){return new BBModel.PurchaseItem(resource)}}}),angular.module("BB.Services").factory("BB.Service.purchase_items",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred,models,purchase_item;return deferred=$q.defer(),angular.isArray(resource)?(models=function(){var j,len,results;for(results=[],j=0,len=resource.length;len>j;j++)purchase_item=resource[j],results.push(new BBModel.PurchaseItem(purchase_item));return results}(),deferred.resolve(models)):resource.$get("purchase_items").then(function(_this){return function(items){var i,j,len;for(models=[],j=0,len=items.length;len>j;j++)i=items[j],models.push(new BBModel.PurchaseItem(i));return deferred.resolve(models)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("ValidatorService",function($rootScope,AlertService,SettingsService,BBModel,$q,$bbug){var alphanumeric,email_regex,geocode_result,international_number,mobile_regex_lenient,number_only_regex,standard_password,uk_landline_regex_lenient,uk_landline_regex_strict,uk_mobile_regex_strict,uk_postcode_regex,uk_postcode_regex_lenient,us_postcode_regex;return uk_postcode_regex=/^(((([A-PR-UWYZ][0-9][0-9A-HJKS-UW]?)|([A-PR-UWYZ][A-HK-Y][0-9][0-9ABEHMNPRV-Y]?))\s{0,1}[0-9]([ABD-HJLNP-UW-Z]{2}))|(GIR\s{0,2}0AA))$/i,us_postcode_regex=/^\d{5}(?:[-\s]\d{4})?$/,uk_postcode_regex_lenient=/^[A-Z]{1,2}[0-9][0-9A-Z]?\s*[0-9][A-Z]{2}$/i,number_only_regex=/^\d+$/,uk_mobile_regex_strict=/^((\+44\s?|0)7([45789]\d{2}|624)\s?\d{3}\s?\d{3})$/,mobile_regex_lenient=/^(0|\+)([\d \(\)]{9,19})$/,uk_landline_regex_strict=/^(\(?(0|\+44)[1-9]{1}\d{1,4}?\)?\s?\d{3,4}\s?\d{3,4})$/,uk_landline_regex_lenient=/^(0|\+)([\d \(\)]{9,19})$/,international_number=/^(\+)([\d \(\)]{9,19})$/,email_regex=/^$|^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/i,standard_password=/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/,alphanumeric=/^[a-zA-Z0-9]*$/,geocode_result=null,{alpha:/^[a-zA-Z\s]*$/,us_phone_number:/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/,getEmailPattern:function(){return email_regex},getStandardPassword:function(){return standard_password},getUKPostcodePattern:function(){return uk_postcode_regex_lenient},getMailingPattern:function(){var cc;return cc=SettingsService.getCountryCode(),(cc="us")?us_postcode_regex:uk_postcode_regex_lenient},getNumberOnlyPattern:function(){return number_only_regex},getAlphaNumbericPattern:function(){return alphanumeric},getUKMobilePattern:function(strict){return null==strict&&(strict=!1),strict?uk_mobile_regex_strict:mobile_regex_lenient},getMobilePattern:function(){return mobile_regex_lenient},getUKLandlinePattern:function(strict){return null==strict&&(strict=!1),strict?uk_landline_regex_strict:uk_landline_regex_lenient},getIntPhonePattern:function(){return international_number},getGeocodeResult:function(){return geocode_result?geocode_result:void 0},validatePostcode:function(form,prms){var deferred,geocoder,ne,postcode,req,sw;return AlertService.clear(),form&&form.postcode?form.$error.required?(AlertService.raise("MISSING_POSTCODE"),!1):form.$error.pattern?(AlertService.raise("INVALID_POSTCODE"),!1):(deferred=$q.defer(),postcode=form.postcode.$viewValue,req={address:postcode},prms.region&&(req.region=prms.region),req.componentRestrictions={postalCode:req.address},prms.bounds&&(sw=new google.maps.LatLng(prms.bounds.sw.x,prms.bounds.sw.y),ne=new google.maps.LatLng(prms.bounds.ne.x,prms.bounds.ne.y),req.bounds=new google.maps.LatLngBounds(sw,ne)),geocoder=new google.maps.Geocoder,geocoder.geocode(req,function(results,status){return 1===results.length&&"OK"===status?(geocode_result=results[0],deferred.resolve(!0)):(AlertService.raise("INVALID_POSTCODE"),$rootScope.$apply(),deferred.reject(!1))}),deferred.promise):!1},validateForm:function(form){return form?(form.submitted=!0,$rootScope.$broadcast("form:validated",form),form.$invalid&&form.raise_alerts&&form.alert?(AlertService.danger(form.alert),!1):form.$invalid&&form.raise_alerts?(AlertService.danger(ErrorService.getError("FORM_INVALID")),!1):!form.$invalid):!1}}})}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};angular.module("BB.Models").factory("BBWidget",function($q,BBModel,BasketService,$urlMatcherFactory,$location,BreadcrumbService,$window,$rootScope){var Widget;return Widget=function(){function Widget(){this.clearAddress=bind(this.clearAddress,this),this.emptyStackedItems=bind(this.emptyStackedItems,this),this.deleteStackedItemByService=bind(this.deleteStackedItemByService,this),this.removeItemFromStack=bind(this.removeItemFromStack,this),this.deleteStackedItem=bind(this.deleteStackedItem,this),this.sortStackedItems=bind(this.sortStackedItems,this),this.setStackedItems=bind(this.setStackedItems,this),this.stackItem=bind(this.stackItem,this),this.waitForRoutes=bind(this.waitForRoutes,this),this.setBasicRoute=bind(this.setBasicRoute,this),this.setRoute=bind(this.setRoute,this),this.calculatePercentageComplete=bind(this.calculatePercentageComplete,this),this.recordStep=bind(this.recordStep,this),this.recordCurrentPage=bind(this.recordCurrentPage,this),this.uid=_.uniqueId("bbwidget_"),this.page_suffix="",this.steps=[],this.allSteps=[],this.item_defaults={},this.usingBasket=!1,this.confirmCheckout=!1,this.isAdmin=!1,this.payment_status=null}return Widget.prototype.pageURL=function(route){return route+".html"},Widget.prototype.updateRoute=function(page){var company,date,event_group,pattern,prms,service_name,time,url;if(this.routeFormat)return page||(page=this.current_page),pattern=$urlMatcherFactory.compile(this.routeFormat),service_name="-",event_group="-",this.current_item&&(this.current_item.service&&(service_name=this.convertToDashSnakeCase(this.current_item.service.name)),this.current_item.event_group&&(event_group=this.convertToDashSnakeCase(this.current_item.event_group.name)),this.current_item.date&&(date=this.current_item.date.date.toISODate()),this.current_item.time&&(time=this.current_item.time.time),this.current_item.company&&(company=this.convertToDashSnakeCase(this.current_item.company.name))),this.route_values&&(prms=angular.copy(this.route_values)),prms||(prms={}),angular.extend(prms,{page:page,company:company,service:service_name,event_group:event_group,date:date,time:time}),url=pattern.format(prms),url=url.replace(/\/+$/,""),$location.path(url),this.routing=!0,url},Widget.prototype.setRouteFormat=function(route){var match,match_test,parts,path,pattern;if(this.routeFormat=route,this.routeFormat&&(this.routing=!0,path=$location.path())){for(parts=this.routeFormat.split("/");parts.length>0&&!match;)match_test=parts.join("/"),pattern=$urlMatcherFactory.compile(match_test),match=pattern.exec(path),parts.pop();if(match)return match.company&&(this.item_defaults.company=decodeURIComponent(match.company)),match.service&&"-"!==match.service&&(this.item_defaults.service=decodeURIComponent(match.service)),match.event_group&&"-"!==match.event_group&&(this.item_defaults.event_group=match.event_group),match.person&&(this.item_defaults.person=decodeURIComponent(match.person)),match.resource&&(this.item_defaults.resource=decodeURIComponent(match.resource)),match.resources&&(this.item_defaults.resources=decodeURIComponent(match.resoures)),match.date&&(this.item_defaults.date=match.date),match.time&&(this.item_defaults.time=match.time),this.route_matches=match}},Widget.prototype.matchURLToStep=function(){var path,step;return this.routeFormat?(path=$location.path(),step=_.findWhere(this.allSteps,{page:path.replace(/\//g,"")}),step?step.number:null):null},Widget.prototype.convertToDashSnakeCase=function(str){return str=str.toLowerCase(),str=$.trim(str),str=str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|'’!<>;:,.~`=+-@£&%"]/g,""),str=str.replace(/\s{2,}/g," "),str=str.replace(/\s/g,"-")},Widget.prototype.recordCurrentPage=function(){var j,k,l,len,len1,len2,match,ref,ref1,ref2,step,title;if(this.current_step||(this.current_step=0),match=!1,this.allSteps)for(ref=this.allSteps,j=0,len=ref.length;len>j;j++)step=ref[j],step.page===this.current_page&&(this.current_step=step.number,match=!0);if(!match)for(ref1=this.steps,k=0,len1=ref1.length;len1>k;k++)step=ref1[k],step&&step.page===this.current_page&&(this.current_step=step.number,match=!0);if(match||(this.current_step+=1),title="",this.allSteps){for(ref2=this.allSteps,l=0,len2=ref2.length;len2>l;l++)step=ref2[l],step.active=!1,step.passed=step.number<this.current_step;this.allSteps[this.current_step-1]&&(this.allSteps[this.current_step-1].active=!0,title=this.allSteps[this.current_step-1].title)}return this.recordStep(this.current_step,title)},Widget.prototype.recordStep=function(step,title){var j,len,ref;for(this.steps[step-1]={url:this.updateRoute(this.current_page),current_item:this.current_item.getStep(),page:this.current_page,number:step,title:title,stacked_length:this.stacked_items.length},BreadcrumbService.setCurrentStep(step),ref=this.steps,j=0,len=ref.length;len>j;j++)step=ref[j],step&&(step.passed=step.number<this.current_step,step.active=step.number===this.current_step);return this.calculatePercentageComplete(step.number),this.allSteps&&this.allSteps.length===step||"checkout"===this.current_page?this.last_step_reached=!0:this.last_step_reached=!1},Widget.prototype.calculatePercentageComplete=function(step_number){return this.percentage_complete=step_number&&this.allSteps?step_number/this.allSteps.length*100:0},Widget.prototype.setRoute=function(rdata){var i,j,k,len,len1,ref,route,step;for(this.allSteps.length=0,this.nextSteps={},void 0!==rdata&&null!==rdata&&void 0!==rdata[0]&&(this.firstStep=rdata[0].page),i=j=0,len=rdata.length;len>j;i=++j)if(step=rdata[i],step.disable_breadcrumbs&&(this.disableGoingBackAtStep=i+1),rdata[i+1]&&(this.nextSteps[step.page]=rdata[i+1].page),this.allSteps.push({number:i+1,title:step.title,page:step.page}),step.when)for(this.routeSteps||(this.routeSteps={}),ref=step.when,k=0,len1=ref.length;len1>k;k++)route=ref[k],this.routeSteps[route]=step.page;return this.$wait_for_routing?this.$wait_for_routing.resolve():void 0},Widget.prototype.setBasicRoute=function(routes){var i,j,len,step;for(this.nextSteps={},this.firstStep=routes[0],i=j=0,len=routes.length;len>j;i=++j)step=routes[i],this.nextSteps[step]=routes[i+1];return this.$wait_for_routing?this.$wait_for_routing.resolve():void 0},Widget.prototype.waitForRoutes=function(){return this.$wait_for_routing?void 0:this.$wait_for_routing=$q.defer()},Widget.prototype.stackItem=function(item){return this.stacked_items.push(item),this.sortStackedItems()},Widget.prototype.setStackedItems=function(items){return this.stacked_items=items,this.sortStackedItems()},Widget.prototype.sortStackedItems=function(){var arr,item,j,len,ref;for(arr=[],ref=this.stacked_items,j=0,len=ref.length;len>j;j++)item=ref[j],arr=arr.concat(item.promises);return $q.all(arr)["finally"](function(_this){return function(){return _this.stacked_items=_this.stacked_items.sort(function(a,b){var ref1,ref2;return a.time&&b.time?null!=(ref1=a.time.time>b.time.time)?ref1:{1:-1}:a.service.category&&!b.service.category?1:b.service.category&&!a.service.category?-1:b.service.category||a.service.category?null!=(ref2=a.service.category.order>b.service.category.order)?ref2:{1:-1}:1})}}(this))},Widget.prototype.deleteStackedItem=function(item){return item&&item.id&&BasketService.deleteItem(item,this.company,{bb:this}),this.stacked_items=this.stacked_items.filter(function(i){return i!==item})},Widget.prototype.removeItemFromStack=function(item){return this.stacked_items=this.stacked_items.filter(function(i){return i!==item})},Widget.prototype.deleteStackedItemByService=function(item){var i,j,len,ref;for(ref=this.stacked_items,j=0,len=ref.length;len>j;j++)i=ref[j],i&&i.service&&i.service.self===item.self&&i.id&&BasketService.deleteItem(i,this.company,{bb:this});return this.stacked_items=this.stacked_items.filter(function(i){return i&&i.service&&i.service.self!==item.self})},Widget.prototype.emptyStackedItems=function(){return this.stacked_items=[]},Widget.prototype.pushStackToBasket=function(){var i,j,len,ref;for(this.basket||(this.basket=new new BBModel.Basket(null,this)),ref=this.stacked_items,j=0,len=ref.length;len>j;j++)i=ref[j],this.basket.addItem(i);return this.emptyStackedItems()},Widget.prototype.totalStackedItemsDuration=function(){var duration,item,j,len,ref;for(duration=0,ref=this.stacked_items,j=0,len=ref.length;len>j;j++)item=ref[j],item.service&&item.service.listed_duration&&(duration+=item.service.listed_duration);return duration},Widget.prototype.clearStackedItemsDateTime=function(){var item,j,len,ref,results;for(ref=this.stacked_items,results=[],j=0,len=ref.length;len>j;j++)item=ref[j],results.push(item.clearDateTime());return results},Widget.prototype.clearAddress=function(){return delete this.address1,delete this.address2,delete this.address3,delete this.address4,delete this.address5},Widget}()})}.call(this),function(){var ModalDelete,ModalDeleteAll;angular.module("BB.Directives").directive("bbPurchase",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"Purchase",link:function(scope,element,attrs){scope.init(scope.$eval(attrs.bbPurchase))}}}),angular.module("BB.Controllers").controller("Purchase",function($scope,$rootScope,CompanyService,PurchaseService,ClientService,$modal,$location,$timeout,BBWidget,BBModel,$q,QueryStringService,SSOService,AlertService,LoginService,$window,$upload,ServiceService,$sessionStorage,SettingsService,$translate){var checkIfMoveBooking,checkIfWaitlistBookings,failMsg,getCompanyID,getPurchaseID,loginRequired,setPurchaseCompany;return $scope.controller="Purchase",$scope.is_waitlist=!1,$scope.make_payment=!1,setPurchaseCompany=function(company){return $scope.bb.company_id=company.id,$scope.bb.company=new BBModel.Company(company),$scope.company=$scope.bb.company,$scope.bb.item_defaults.company=$scope.bb.company,company.settings&&(company.settings.merge_resources&&($scope.bb.item_defaults.merge_resources=!0),company.settings.merge_people)?$scope.bb.item_defaults.merge_people=!0:void 0},failMsg=function(){return $scope.fail_msg?AlertService.danger({msg:$scope.fail_msg}):SettingsService.isInternationalizatonEnabled()?$translate("ERROR.GENERIC",{}).then(function(translated_text){return AlertService.add("danger",{msg:translated_text})}):AlertService.raise("GENERIC")},$scope.init=function(options){return options||(options={}),$scope.notLoaded($scope),options.move_route&&($scope.move_route=options.move_route),options.move_all&&($scope.move_all=options.move_all),options.fail_msg&&($scope.fail_msg=options.fail_msg),$scope.bb.total?$scope.load($scope.bb.total.long_id):$scope.bb.purchase?($scope.purchase=$scope.bb.purchase,$scope.bookings=$scope.bb.purchase.bookings,$scope.purchase.confirm_messages&&($scope.messages=$scope.purchase.confirm_messages),$scope.setLoaded($scope)):options.member_sso?SSOService.memberLogin(options).then(function(login){return $scope.load()},function(err){return $scope.setLoaded($scope),failMsg()}):$scope.load()},$scope.load=function(id){return $scope.notLoaded($scope),id=getPurchaseID(),!$scope.loaded&&id&&$rootScope.widget_started.then(function(_this){return function(){return $scope.waiting_for_conn_started.then(function(){var auth_token,company_id,params;return company_id=getCompanyID(),company_id&&CompanyService.query(company_id,{}).then(function(company){return setPurchaseCompany(company)}),params={purchase_id:id,url_root:$scope.bb.api_url},auth_token=$sessionStorage.getItem("auth_token"),auth_token&&(params.auth_token=auth_token),PurchaseService.query(params).then(function(purchase){return null==$scope.bb.company&&purchase.$get("company").then(function(_this){return function(company){return setPurchaseCompany(company)}}(this)),$scope.purchase=purchase,$scope.bb.purchase=purchase,$scope.price=!(0===$scope.purchase.price),$scope.purchase.getBookingsPromise().then(function(bookings){var booking,i,len,ref,results;for($scope.bookings=bookings,bookings[0]&&bookings[0].getCompanyPromise().then(function(company){return $scope.purchase.bookings[0].company=company,company.getAddressPromise().then(function(address){return $scope.purchase.bookings[0].company.address=address})}),$scope.setLoaded($scope),checkIfMoveBooking(bookings),checkIfWaitlistBookings(bookings),ref=$scope.bookings,results=[],i=0,len=ref.length;len>i;i++)booking=ref[i],results.push(booking.getAnswersPromise().then(function(answers){return booking.answers=answers}));return results},function(err){return $scope.setLoaded($scope),failMsg()}),purchase.$has("client")&&purchase.$get("client").then(function(_this){return function(client){return $scope.setClient(new BBModel.Client(client))}}(this)),$scope.purchase.getConfirmMessages().then(function(messages){return $scope.purchase.confirm_messages=messages,$scope.messages=messages})},function(err){return $scope.setLoaded($scope),err&&401===err.status?LoginService.isLoggedIn()?failMsg():loginRequired():failMsg()})},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}),$scope.loaded=!0},checkIfMoveBooking=function(bookings){var b,id,matches,move_booking;return matches=/^.*(?:\?|&)move_booking=(.*?)(?:&|$)/.exec($location.absUrl()),matches&&(id=parseInt(matches[1])),id&&(move_booking=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)b=bookings[i],b.id===id&&results.push(b);return results}(),move_booking.length>0&&$scope.isMovable(bookings[0]))?$scope.move(move_booking[0]):void 0},checkIfWaitlistBookings=function(bookings){var booking;return $scope.waitlist_bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)booking=bookings[i],booking.on_waitlist&&1===booking.settings.sent_waitlist&&results.push(booking);return results}()},loginRequired=function(_this){return function(){return $scope.bb.login_required?void 0:window.location=window.location.href+"&login=true"}}(this),getCompanyID=function(){var company_id,matches;return matches=/^.*(?:\?|&)company_id=(.*?)(?:&|$)/.exec($location.absUrl()),matches&&(company_id=matches[1]),company_id},getPurchaseID=function(){var id,matches;return matches=/^.*(?:\?|&)id=(.*?)(?:&|$)/.exec($location.absUrl()),matches||(matches=/^.*print_purchase\/(.*?)(?:\?|$)/.exec($location.absUrl())),matches||(matches=/^.*print_purchase_jl\/(.*?)(?:\?|$)/.exec($location.absUrl())),matches?id=matches[1]:QueryStringService("ref")&&(id=QueryStringService("ref")),QueryStringService("booking_id")&&(id=QueryStringService("booking_id")),id},$scope.move=function(booking,route,options){return null==options&&(options={}),route||(route=$scope.move_route),$scope.move_all?$scope.moveAll(route,options):($scope.notLoaded($scope),$scope.initWidget({company_id:booking.company_id,no_route:!0}),$timeout(function(_this){return function(){return $rootScope.connection_started.then(function(){var new_item,proms;return proms=[],$scope.bb.moving_booking=booking,$scope.quickEmptybasket(),new_item=new BBModel.BasketItem(booking,$scope.bb),new_item.setSrcBooking(booking,$scope.bb),new_item.ready=!1,Array.prototype.push.apply(proms,new_item.promises),$scope.bb.basket.addItem(new_item),$scope.setBasketItem(new_item),$q.all(proms).then(function(){return $scope.setLoaded($scope),$rootScope.$broadcast("booking:move"),$scope.decideNextPage(route)},function(err){return $scope.setLoaded($scope),failMsg()})},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this)))},$scope.moveAll=function(route,options){return null==options&&(options={}),route||(route=$scope.move_route),$scope.notLoaded($scope),$scope.initWidget({company_id:$scope.bookings[0].company_id,no_route:!0}),$timeout(function(_this){return function(){return $rootScope.connection_started.then(function(){var booking,i,len,new_item,proms,ref;for(proms=[],1===$scope.bookings.length?$scope.bb.moving_booking=$scope.bookings[0]:$scope.bb.moving_booking=$scope.purchase,_.every(_.map($scope.bookings,function(b){return b.event_id}),function(event_id){return event_id===$scope.bookings[0].event_id})&&($scope.bb.moving_purchase=$scope.purchase),$scope.quickEmptybasket(),ref=$scope.bookings,i=0,len=ref.length;len>i;i++)booking=ref[i],new_item=new BBModel.BasketItem(booking,$scope.bb),new_item.setSrcBooking(booking),new_item.ready=!1,new_item.move_done=!1,Array.prototype.push.apply(proms,new_item.promises),$scope.bb.basket.addItem(new_item);return $scope.bb.sortStackedItems(),$scope.setBasketItem($scope.bb.basket.items[0]),$q.all(proms).then(function(){return $scope.setLoaded($scope),$scope.decideNextPage(route)},function(err){return $scope.setLoaded($scope),failMsg()})},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this))},$scope.bookWaitlistItem=function(booking){var params;return $scope.notLoaded($scope),params={purchase:$scope.purchase,booking:booking},PurchaseService.bookWaitlistItem(params).then(function(purchase){return $scope.purchase=purchase,$scope.total=$scope.purchase,$scope.bb.purchase=purchase,$scope.purchase.getBookingsPromise().then(function(bookings){return $scope.bookings=bookings,$scope.waitlist_bookings=function(){var i,len,ref,results;for(ref=$scope.bookings,results=[],i=0,len=ref.length;len>i;i++)booking=ref[i],booking.on_waitlist&&1===booking.settings.sent_waitlist&&results.push(booking);return results}(),$scope.purchase.$has("new_payment")&&$scope.purchase.due_now>0&&($scope.make_payment=!0),$scope.setLoaded($scope)},function(err){return $scope.setLoaded($scope),failMsg()})},function(_this){return function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")}}(this))},$scope["delete"]=function(booking){var modalInstance;return modalInstance=$modal.open({templateUrl:$scope.getPartial("_cancel_modal"),controller:ModalDelete,resolve:{booking:function(){return booking}}}),modalInstance.result.then(function(booking){return booking.$del("self").then(function(_this){return function(service){return $scope.bookings=_.without($scope.bookings,booking),$rootScope.$broadcast("booking:cancelled")}}(this))})},$scope.deleteAll=function(){var modalInstance;return modalInstance=$modal.open({templateUrl:$scope.getPartial("_cancel_modal"),controller:ModalDeleteAll,resolve:{purchase:function(){return $scope.purchase}}}),modalInstance.result.then(function(purchase){return PurchaseService.deleteAll(purchase).then(function(purchase){return $scope.purchase=purchase,$scope.bookings=[],$rootScope.$broadcast("booking:cancelled")})})},$scope.isMovable=function(booking){return booking.min_cancellation_time?moment().isBefore(booking.min_cancellation_time):booking.datetime.isAfter(moment())},$scope.onFileSelect=function(booking,$file,existing){var att_id,file,method;return $scope.upload_progress=0,file=$file,att_id=null,existing&&(att_id=existing.id),method="POST",att_id&&(method="PUT"),$scope.upload=$upload.upload({url:booking.$href("attachments"),method:method,data:{att_id:att_id},file:file}).progress(function(evt){return $scope.upload_progress<100?$scope.upload_progress=parseInt(99*evt.loaded/evt.total):void 0}).success(function(data,status,headers,config){return $scope.upload_progress=100,data&&data.attachments&&booking?booking.attachments=data.attachments:void 0})},$scope.createBasketItem=function(booking){var item;return item=new BBModel.BasketItem(booking,$scope.bb),item.setSrcBooking(booking),item},$scope.checkAnswer=function(answer){return"boolean"==typeof answer.value||"string"==typeof answer.value||"number"==typeof answer.value},$scope.changeAttendees=function(route){return $scope.moveAll(route)}}),ModalDelete=function($scope,$rootScope,$modalInstance,booking,AlertService){return $scope.controller="ModalDelete",$scope.booking=booking,$scope.confirmDelete=function(){return AlertService.clear(),$modalInstance.close(booking)},$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},ModalDeleteAll=function($scope,$rootScope,$modalInstance,purchase){return $scope.controller="ModalDeleteAll",
$scope.purchase=purchase,$scope.confirmDelete=function(){return $modalInstance.close(purchase)},$scope.cancel=function(){return $modalInstance.dismiss("cancel")}}}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("Purchase.BookingModel",function($q,$window,BBModel,BaseModel,$bbug){var Purchase_Booking;return Purchase_Booking=function(superClass){function Purchase_Booking(data){this.getSurveyAnswersPromise=bind(this.getSurveyAnswersPromise,this),this.getAnswersPromise=bind(this.getAnswersPromise,this),Purchase_Booking.__super__.constructor.call(this,data),this.ready=!1,this.datetime=moment.parseZone(this.datetime),this.time_zone&&this.datetime.tz(this.time_zone),this.original_datetime=moment(this.datetime),this.end_datetime=moment.parseZone(this.end_datetime),this.time_zone&&this.end_datetime.tz(this.time_zone),this.min_cancellation_time=moment(this.min_cancellation_time),this.min_cancellation_hours=this.datetime.diff(this.min_cancellation_time,"hours")}return extend(Purchase_Booking,superClass),Purchase_Booking.prototype.getGroup=function(){return this.group?this.group:this._data.$has("event_groups")?this._data.$get("event_groups").then(function(_this){return function(group){return _this.group=group,_this.group}}(this)):void 0},Purchase_Booking.prototype.getColour=function(){return this.getGroup()?this.getGroup().colour:"#FFFFFF"},Purchase_Booking.prototype.getCompany=function(){return this.company?this.company:this.$has("company")?this._data.$get("company").then(function(_this){return function(company){return _this.company=new BBModel.Company(company),_this.company}}(this)):void 0},Purchase_Booking.prototype.getAnswersPromise=function(){var defer;return defer=$q.defer(),null!=this.answers?defer.resolve(this.answers):(this.answers=[],this._data.$has("answers")?this._data.$get("answers").then(function(_this){return function(answers){var a;return _this.answers=function(){var i,len,results;for(results=[],i=0,len=answers.length;len>i;i++)a=answers[i],results.push(new BBModel.Answer(a));return results}(),defer.resolve(_this.answers)}}(this)):defer.resolve([])),defer.promise},Purchase_Booking.prototype.getSurveyAnswersPromise=function(){var defer;return defer=$q.defer(),this.survey_answers&&defer.resolve(this.survey_answers),this._data.$has("survey_answers")?this._data.$get("survey_answers").then(function(_this){return function(survey_answers){var a;return _this.survey_answers=function(){var i,len,results;for(results=[],i=0,len=survey_answers.length;len>i;i++)a=survey_answers[i],results.push(new BBModel.Answer(a));return results}(),defer.resolve(_this.survey_answers)}}(this)):defer.resolve([]),defer.promise},Purchase_Booking.prototype.answer=function(q){var a,i,len,ref;if(null!=this.answers)for(ref=this.answers,i=0,len=ref.length;len>i;i++){if(a=ref[i],a.name&&a.name===q)return a.answer;if(a.question_text&&a.question_text===q)return a.value}else this.getAnswersPromise();return null},Purchase_Booking.prototype.getPostData=function(){var data,formatted_survey_answers,i,len,q,ref;if(data={},data.attended=this.attended,data.client_id=this.client_id,data.company_id=this.company_id,data.time=60*this.datetime.hour()+this.datetime.minute(),data.date=this.datetime.toISODate(),data.deleted=this.deleted,data.describe=this.describe,data.duration=this.duration,data.end_datetime=this.end_datetime,this.time&&this.time.event_id&&!this.isEvent()?data.event_id=this.time.event_id:this.event?data.event_id=this.event.id:data.event_id=this.slot_id,data.full_describe=this.full_describe,data.id=this.id,data.min_cancellation_time=this.min_cancellation_time,data.on_waitlist=this.on_waitlist,data.paid=this.paid,data.person_name=this.person_name,data.price=this.price,data.purchase_id=this.purchase_id,data.purchase_ref=this.purchase_ref,data.quantity=this.quantity,data.self=this.self,this.move_item_id&&(data.move_item_id=this.move_item_id),this.srcBooking&&(data.move_item_id=this.srcBooking.id),this.person&&(data.person_id=this.person.id),this.service&&(data.service_id=this.service.id),this.resource&&(data.resource_id=this.resource.id),this.item_details&&(data.questions=this.item_details.getPostData()),data.service_name=this.service_name,data.settings=this.settings,this.status&&(data.status=this.status),null!=this.email&&(data.email=this.email),null!=this.email_admin&&(data.email_admin=this.email_admin),this.first_name&&(data.first_name=this.first_name),this.last_name&&(data.last_name=this.last_name),formatted_survey_answers=[],this.survey_questions){for(data.survey_questions=this.survey_questions,ref=this.survey_questions,i=0,len=ref.length;len>i;i++)q=ref[i],formatted_survey_answers.push({value:q.answer,outcome:q.outcome,detail_type_id:q.id,price:q.price});data.survey_answers=formatted_survey_answers}return data},Purchase_Booking.prototype.checkReady=function(){return this.datetime&&this.id&&this.purchase_ref?this.ready=!0:void 0},Purchase_Booking.prototype.printed_price=function(){return parseFloat(this.price)%1===0?"£"+parseInt(this.price):$window.sprintf("£%.2f",parseFloat(this.price))},Purchase_Booking.prototype.getDateString=function(){return this.datetime.toISODate()},Purchase_Booking.prototype.getTimeInMins=function(){return 60*this.datetime.hour()+this.datetime.minute()},Purchase_Booking.prototype.getAttachments=function(){return this.attachments?this.attachments:this.$has("attachments")?this._data.$get("attachments").then(function(_this){return function(atts){return _this.attachments=atts.attachments,_this.attachments}}(this)):void 0},Purchase_Booking.prototype.canCancel=function(){return moment(this.min_cancellation_time).isAfter(moment())},Purchase_Booking.prototype.canMove=function(){return this.canCancel()},Purchase_Booking.prototype.getAttendeeName=function(){return this.first_name+" "+this.last_name},Purchase_Booking.prototype.isEvent=function(){return null!=this.event_chain},Purchase_Booking}(BaseModel)})}.call(this),function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("Purchase.CourseBookingModel",function($q,BBModel,BaseModel){var Purchase_Course_Booking;return Purchase_Course_Booking=function(superClass){function Purchase_Course_Booking(data){this.getBookings=bind(this.getBookings,this),Purchase_Course_Booking.__super__.constructor.call(this,data)}return extend(Purchase_Course_Booking,superClass),Purchase_Course_Booking.prototype.getBookings=function(){var defer;return defer=$q.defer(),this.bookings&&defer.resolve(this.bookings),this._data.$has("bookings")?this._data.$get("bookings").then(function(_this){return function(bookings){var b;return _this.bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)b=bookings[i],results.push(new BBModel.Purchase.Booking(b));return results}(),_this.bookings.sort(function(a,b){return a.datetime.unix()-b.datetime.unix()}),defer.resolve(_this.bookings)}}(this)):(this.bookings=[],defer.resolve(this.bookings)),defer.promise},Purchase_Course_Booking}(BaseModel)})}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("Purchase.TotalModel",function($q,$window,BBModel,BaseModel,$sce){var Purchase_Total;return Purchase_Total=function(superClass){function Purchase_Total(data){this.getConfirmMessages=bind(this.getConfirmMessages,this),this.getMember=bind(this.getMember,this),this.getClient=bind(this.getClient,this),this.getMessages=bind(this.getMessages,this),this.getDeals=bind(this.getDeals,this),this.getProducts=bind(this.getProducts,this),this.getPackages=bind(this.getPackages,this),this.getCourseBookingsPromise=bind(this.getCourseBookingsPromise,this),this.getBookingsPromise=bind(this.getBookingsPromise,this),this.getItems=bind(this.getItems,this),Purchase_Total.__super__.constructor.call(this,data),this.getItems().then(function(_this){return function(items){return _this.items=items}}(this)),this.getClient().then(function(_this){return function(client){return _this.client=client}}(this)),this.getMember().then(function(_this){return function(member){return _this.member=member}}(this))}return extend(Purchase_Total,superClass),Purchase_Total.prototype.id=function(){return this.get("id")},Purchase_Total.prototype.icalLink=function(){return this._data.$href("ical")},Purchase_Total.prototype.webcalLink=function(){return this._data.$href("ical")},Purchase_Total.prototype.gcalLink=function(){return this._data.$href("gcal")},Purchase_Total.prototype.getItems=function(){var defer;return defer=$q.defer(),this.items&&defer.resolve(this.items),$q.all([this.getBookingsPromise(),this.getCourseBookingsPromise(),this.getPackages(),this.getProducts(),this.getDeals()]).then(function(result){var items;return items=_.flatten(result),defer.resolve(items)}),defer.promise},Purchase_Total.prototype.getBookingsPromise=function(){var defer;return defer=$q.defer(),this.bookings&&defer.resolve(this.bookings),this._data.$has("bookings")?this._data.$get("bookings").then(function(_this){return function(bookings){var b;return _this.bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)b=bookings[i],results.push(new BBModel.Purchase.Booking(b));return results}(),_this.bookings.sort(function(a,b){return a.datetime.unix()-b.datetime.unix()}),defer.resolve(_this.bookings)}}(this)):defer.resolve([]),defer.promise},Purchase_Total.prototype.getCourseBookingsPromise=function(){var defer;return defer=$q.defer(),this.course_bookings&&defer.resolve(this.course_bookings),this._data.$has("course_bookings")?this._data.$get("course_bookings").then(function(_this){return function(bookings){var b;return _this.course_bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)b=bookings[i],results.push(new BBModel.Purchase.CourseBooking(b));return results}(),$q.all(_.map(_this.course_bookings,function(b){return b.getBookings()})).then(function(){return defer.resolve(_this.course_bookings)})}}(this)):defer.resolve([]),defer.promise},Purchase_Total.prototype.getPackages=function(){var defer;return defer=$q.defer(),this.packages&&defer.resolve(this.packages),this._data.$has("packages")?this._data.$get("packages").then(function(_this){return function(packages){return _this.packages=packages,defer.resolve(_this.packages)}}(this)):defer.resolve([]),defer.promise},Purchase_Total.prototype.getProducts=function(){var defer;return defer=$q.defer(),this.products&&defer.resolve(this.products),this._data.$has("products")?this._data.$get("products").then(function(_this){return function(products){return _this.products=products,defer.resolve(_this.products)}}(this)):defer.resolve([]),defer.promise},Purchase_Total.prototype.getDeals=function(){var defer;return defer=$q.defer(),this.deals&&defer.resolve(this.deals),this._data.$has("deals")?this._data.$get("deals").then(function(_this){return function(deals){return _this.deals=deals,defer.resolve(_this.deals)}}(this)):defer.resolve([]),defer.promise},Purchase_Total.prototype.getMessages=function(booking_texts,msg_type){var bt,defer;return defer=$q.defer(),booking_texts=function(){var i,len,results;for(results=[],i=0,len=booking_texts.length;len>i;i++)bt=booking_texts[i],bt.message_type===msg_type&&results.push(bt);return results}(),0===booking_texts.length?defer.resolve([]):this.getItems().then(function(items){var booking_text,i,item,j,k,len,len1,len2,msgs,ref,type;for(msgs=[],i=0,len=booking_texts.length;len>i;i++)for(booking_text=booking_texts[i],j=0,len1=items.length;len1>j;j++)for(item=items[j],ref=["company","person","resource","service"],k=0,len2=ref.length;len2>k;k++)type=ref[k],item.$has(type)&&item.$href(type)===booking_text.$href("item")&&-1===msgs.indexOf(booking_text.message)&&msgs.push(booking_text.message);return defer.resolve(msgs)}),defer.promise},Purchase_Total.prototype.getClient=function(){var defer;return defer=$q.defer(),this._data.$has("client")?this._data.$get("client").then(function(_this){return function(client){return _this.client=new BBModel.Client(client),defer.resolve(_this.client)}}(this)):defer.reject("No client"),defer.promise},Purchase_Total.prototype.getMember=function(){var defer;return defer=$q.defer(),this._data.$has("member")?this._data.$get("member").then(function(_this){return function(member){return _this.member=new BBModel.Member.Member(member),defer.resolve(_this.member)}}(this)):defer.reject("No member"),defer.promise},Purchase_Total.prototype.getConfirmMessages=function(){var defer;return defer=$q.defer(),this._data.$has("confirm_messages")?this._data.$get("confirm_messages").then(function(_this){return function(msgs){return _this.getMessages(msgs,"Confirm").then(function(filtered_msgs){return defer.resolve(filtered_msgs)})}}(this)):defer.reject("no messages"),defer.promise},Purchase_Total.prototype.printed_total_price=function(){return parseFloat(this.total_price)%1===0?"£"+parseInt(this.total_price):$window.sprintf("£%.2f",parseFloat(this.total_price))},Purchase_Total.prototype.newPaymentUrl=function(){return this._data.$has("new_payment")?$sce.trustAsResourceUrl(this._data.$href("new_payment")):void 0},Purchase_Total.prototype.totalDuration=function(){var duration,i,item,len,ref;for(duration=0,ref=this.items,i=0,len=ref.length;len>i;i++)item=ref[i],item.duration&&(duration+=item.duration);return duration},Purchase_Total.prototype.containsWaitlistItems=function(){var i,item,len,ref,waitlist;for(waitlist=[],ref=this.items,i=0,len=ref.length;len>i;i++)item=ref[i],item.on_waitlist===!0&&waitlist.push(item);return waitlist.length>0},Purchase_Total}(BaseModel)})}.call(this),function(){"use strict";angular.module("BB.Services").factory("PurchaseBookingService",function($q,halClient,BBModel){return{update:function(booking){var data,deferred;return deferred=$q.defer(),data=booking.getPostData(),booking.srcBooking.$put("self",{},data).then(function(_this){return function(booking){return deferred.resolve(new BBModel.Purchase.Booking(booking))}}(this),function(_this){return function(err){return deferred.reject(err,new BBModel.Purchase.Booking(booking))}}(this)),deferred.promise},addSurveyAnswersToBooking:function(booking){var data,deferred;return deferred=$q.defer(),data=booking.getPostData(),data.notify=!1,data.notify_admin=!1,booking.$put("self",{},data).then(function(_this){return function(booking){return deferred.resolve(new BBModel.Purchase.Booking(booking))}}(this),function(_this){return function(err){return deferred.reject(err,new BBModel.Purchase.Booking(booking))}}(this)),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("PurchaseService",function($q,halClient,BBModel,$window,UriTemplate){return{query:function(params){var defer,uri;return defer=$q.defer(),uri=params.url_root+"/api/v1/purchases/"+params.purchase_id,halClient.$get(uri,params).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise},bookingRefQuery:function(params){var defer,uri;return defer=$q.defer(),uri=new UriTemplate(params.url_root+"/api/v1/purchases/booking_ref/{booking_ref}{?raw}").fillFromObject(params),halClient.$get(uri,params).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise},update:function(params){var bdata,booking,data,defer,i,len,ref;if(defer=$q.defer(),!params.purchase)return defer.reject("No purchase present"),defer.promise;if(data={},params.bookings){for(bdata=[],ref=params.bookings,i=0,len=ref.length;len>i;i++)booking=ref[i],bdata.push(booking.getPostData());data.bookings=bdata}return params.purchase.$put("self",{},data).then(function(_this){return function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)}}(this),function(_this){return function(err){return defer.reject(err)}}(this)),defer.promise},bookWaitlistItem:function(params){var data,defer;return defer=$q.defer(),params.purchase?(data={},params.booking&&(data.booking=params.booking.getPostData()),data.booking_id=data.booking.id,params.purchase.$put("book_waitlist_item",{},data).then(function(_this){return function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)}}(this),function(_this){return function(err){return defer.reject(err)}}(this)),defer.promise):(defer.reject("No purchase present"),defer.promise)},deleteAll:function(purchase){var defer;return defer=$q.defer(),purchase?(purchase.$del("self").then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(_this){return function(err){return defer.reject(err)}}(this)),defer.promise):(defer.reject("No purchase present"),defer.promise)},delete_item:function(params){var defer,uri;return defer=$q.defer(),uri=params.api_url+"/api/v1/purchases/"+params.long_id+"/purchase_item/"+params.purchase_item_id,halClient.$del(uri,{}).then(function(purchase){return purchase=new BBModel.Purchase.Total(purchase),defer.resolve(purchase)},function(err){return defer.reject(err)}),defer.promise}}})}.call(this);